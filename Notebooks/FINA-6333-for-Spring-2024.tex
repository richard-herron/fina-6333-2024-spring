% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
\PassOptionsToPackage{dvipsnames,svgnames,x11names}{xcolor}
%
\documentclass[
  letterpaper,
  DIV=11,
  numbers=noendperiod]{scrreprt}

\usepackage{amsmath,amssymb}
\usepackage{iftex}
\ifPDFTeX
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
\usepackage{lmodern}
\ifPDFTeX\else  
    % xetex/luatex font selection
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\ifLuaTeX
  \usepackage{luacolor}
  \usepackage[soul]{lua-ul}
\else
  \usepackage{soul}
  
\fi
\setlength{\emergencystretch}{3em} % prevent overfull lines
\setcounter{secnumdepth}{5}
% Make \paragraph and \subparagraph free-standing
\ifx\paragraph\undefined\else
  \let\oldparagraph\paragraph
  \renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
  \let\oldsubparagraph\subparagraph
  \renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{241,243,245}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.40,0.45,0.13}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\BuiltInTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{\textit{#1}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{\textit{#1}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\ExtensionTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.28,0.35,0.67}{#1}}
\newcommand{\ImportTok}[1]{\textcolor[rgb]{0.00,0.46,0.62}{#1}}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\NormalTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.68,0.00,0.00}{#1}}
\newcommand{\RegionMarkerTok}[1]{\textcolor[rgb]{0.00,0.23,0.31}{#1}}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.07,0.07,0.07}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.13,0.47,0.30}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.37,0.37,0.37}{\textit{#1}}}

\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}\usepackage{longtable,booktabs,array}
\usepackage{multirow}
\usepackage{calc} % for calculating minipage widths
% Correct order of tables after \paragraph or \subparagraph
\usepackage{etoolbox}
\makeatletter
\patchcmd\longtable{\par}{\if@noskipsec\mbox{}\fi\par}{}{}
\makeatother
% Allow footnotes in longtable head/foot
\IfFileExists{footnotehyper.sty}{\usepackage{footnotehyper}}{\usepackage{footnote}}
\makesavenoteenv{longtable}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother

\KOMAoption{captions}{tableheading}
\makeatletter
\@ifpackageloaded{bookmark}{}{\usepackage{bookmark}}
\makeatother
\makeatletter
\@ifpackageloaded{caption}{}{\usepackage{caption}}
\AtBeginDocument{%
\ifdefined\contentsname
  \renewcommand*\contentsname{Table of contents}
\else
  \newcommand\contentsname{Table of contents}
\fi
\ifdefined\listfigurename
  \renewcommand*\listfigurename{List of Figures}
\else
  \newcommand\listfigurename{List of Figures}
\fi
\ifdefined\listtablename
  \renewcommand*\listtablename{List of Tables}
\else
  \newcommand\listtablename{List of Tables}
\fi
\ifdefined\figurename
  \renewcommand*\figurename{Figure}
\else
  \newcommand\figurename{Figure}
\fi
\ifdefined\tablename
  \renewcommand*\tablename{Table}
\else
  \newcommand\tablename{Table}
\fi
}
\@ifpackageloaded{float}{}{\usepackage{float}}
\floatstyle{ruled}
\@ifundefined{c@chapter}{\newfloat{codelisting}{h}{lop}}{\newfloat{codelisting}{h}{lop}[chapter]}
\floatname{codelisting}{Listing}
\newcommand*\listoflistings{\listof{codelisting}{List of Listings}}
\makeatother
\makeatletter
\makeatother
\makeatletter
\@ifpackageloaded{caption}{}{\usepackage{caption}}
\@ifpackageloaded{subcaption}{}{\usepackage{subcaption}}
\makeatother
\ifLuaTeX
  \usepackage{selnolig}  % disable illegal ligatures
\fi
\usepackage{bookmark}

\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\urlstyle{same} % disable monospaced font for URLs
\hypersetup{
  pdftitle={Data Analytics in Finance},
  pdfauthor={Richard Herron},
  colorlinks=true,
  linkcolor={blue},
  filecolor={Maroon},
  citecolor={Blue},
  urlcolor={Blue},
  pdfcreator={LaTeX via pandoc}}

\title{Data Analytics in Finance}
\usepackage{etoolbox}
\makeatletter
\providecommand{\subtitle}[1]{% add subtitle to \maketitle
  \apptocmd{\@title}{\par {\large #1 \par}}{}{}
}
\makeatother
\subtitle{FINA 6333 for Spring 2024}
\author{Richard Herron}
\date{}

\begin{document}
\maketitle

\renewcommand*\contentsname{Table of contents}
{
\hypersetup{linkcolor=}
\setcounter{tocdepth}{1}
\tableofcontents
}
\bookmarksetup{startatroot}

\chapter*{Welcome!}\label{welcome}
\addcontentsline{toc}{chapter}{Welcome!}

\markboth{Welcome!}{Welcome!}

Welcome to FINA 6333 for Spring 2024 at the D'Amore-McKim School of
Business at Northeastern University!

For each course topic, we will have one notebook for its lecture and one
for its in-class practice exercises. I will maintain these notebooks
here because Canvas does not render notebooks. I will maintain
everything else on Canvas (e.g., announcements, discussions, grades,
etc.).

You have three choices to download or run these notebooks:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Download them from our shared folder on
  \href{https://northeastern-my.sharepoint.com/:f:/g/personal/r_herron_northeastern_edu/Ekn1N5nzwXFDpezlTLQqLd8BBQcfvgDCkE9OgdIffHR8Cw?e=t8Dqa3}{OneDrive}
  (or click the cloud icon in the left sidebar)
\item
  Download them from our Notebooks folder on
  \href{https://github.com/richard-herron/fina-6333-2024-spring}{GitHub}
  (or click the octo-cat icon in the left sidebar)
\item
  Open them on
  \href{http://colab.research.google.com/github/richard-herron/fina-6333-2024-spring/}{Google
  Colab} (or click the Google icon in the left sidebar)
\end{enumerate}

\part{Week 1}

\chapter{McKinney Chapter 2 - Python Language Basics, IPython, and
Jupyter
Notebooks}\label{mckinney-chapter-2---python-language-basics-ipython-and-jupyter-notebooks}

\section{Introduction}\label{introduction}

We must understand the basics of Python before we can use it to analyze
financial data. Chapter 2 of Wes McKinney's
\href{https://wesmckinney.com/book/}{\emph{Python for Data Analysis}}
provides a crash course in Python's syntax, and chapter 3 provides a
crash course in Python's built-in data structures. This notebook focuses
on the ``Python Language Basics'' in section 2.3, which covers language
semantics, scalar types, and control flow.

\textbf{\emph{Note:}} Indented block quotes are from McKinney unless
otherwise indicated. The section numbers here differ from McKinney
because we will only discuss some topics.

\section{Language Semantics}\label{language-semantics}

\subsection{Indentation, not braces}\label{indentation-not-braces}

\begin{quote}
Python uses whitespace (tabs or spaces) to structure code instead of
using braces as in many other languages like R, C++, Java, and Perl.
\end{quote}

\textbf{\emph{So, spaces are more than cosmetic in Python.}} For
non-Python programmers, white space is often Python's defining feature.
Here is a for loop with an if block that shows how Python uses white
space.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{array }\OperatorTok{=}\NormalTok{ [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{]}
\NormalTok{pivot }\OperatorTok{=} \DecValTok{2}
\NormalTok{less }\OperatorTok{=}\NormalTok{ []}
\NormalTok{greater }\OperatorTok{=}\NormalTok{ []}

\ControlFlowTok{for}\NormalTok{ x }\KeywordTok{in}\NormalTok{ array:}
    \ControlFlowTok{if}\NormalTok{ x }\OperatorTok{\textless{}}\NormalTok{ pivot:}
        \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{\}}\SpecialStringTok{ is less than }\SpecialCharTok{\{}\NormalTok{pivot}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{        less.append(x)        }
    \ControlFlowTok{else}\NormalTok{:}
        \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{\}}\SpecialStringTok{ is NOT less than }\SpecialCharTok{\{}\NormalTok{pivot}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{        greater.append(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1 is less than 2
2 is NOT less than 2
3 is NOT less than 2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{less}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{greater}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[2, 3]
\end{verbatim}

\textbf{\emph{Note:}} We will use f-string print statements wherever we
can. These f-string print statements are easy to use, and I do not want
to teach old approaches when the new ones are better.

\subsection{Comments}\label{comments}

\begin{quote}
Any text preceded by the hash mark (pound sign) \# is ignored by the
Python interpreter. This is often used to add comments to code. At times
you may also want to exclude certain blocks of code without deleting
them.
\end{quote}

The Python interpreter ignores any code after a hash mark \texttt{\#} on
a given line. We can quickly comment/un-comment lines of code with the
\texttt{\textless{}Ctrl\textgreater{}-/} shortcut.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# We often use comments to leave notes for future us (or co{-}workers)}
\CommentTok{\# 5 + 5}
\end{Highlighting}
\end{Shaded}

\subsection{Function and object method
calls}\label{function-and-object-method-calls}

\begin{quote}
You call functions using parentheses and passing zero or more arguments,
optionally assigning the returned value to a variable:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{    result }\OperatorTok{=}\NormalTok{ f(x, y, z)}
\NormalTok{    g()}
\end{Highlighting}
\end{Shaded}

Almost every object in Python has attached functions, known as methods,
that have access to the object's internal contents. You can call them
using the following \textgreater{} syntax:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{    obj.some\_method(x, y, z)}
\end{Highlighting}
\end{Shaded}

Functions can take both positional and keyword arguments:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{    result }\OperatorTok{=}\NormalTok{ f(a, b, c, d}\OperatorTok{=}\DecValTok{5}\NormalTok{, e}\OperatorTok{=}\StringTok{\textquotesingle{}foo\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

More on this later.
\end{quote}

We can write a function that adds two numbers.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ add\_numbers(a, b):}
    \ControlFlowTok{return}\NormalTok{ a }\OperatorTok{+}\NormalTok{ b}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{who}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
add_numbers  array   greater     less    pivot   x   
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{add\_numbers(}\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
10
\end{verbatim}

We can write a function that adds two strings separated by a space.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ add\_strings(a, b):}
    \ControlFlowTok{return}\NormalTok{ a }\OperatorTok{+} \StringTok{\textquotesingle{} \textquotesingle{}} \OperatorTok{+}\NormalTok{ b}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{who}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
add_numbers  add_strings     array   greater     less    pivot   x   
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{add\_strings(}\StringTok{\textquotesingle{}5\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}5\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'5 5'
\end{verbatim}

\textbf{\emph{What is the difference between \texttt{print()} and
\texttt{return}?}} \texttt{print()} returns its arguments to the console
or ``standard output'', whereas \texttt{return} returns its argument as
an output we can assign to variables. In the example below, we use the
\texttt{return} line to assign the output of \texttt{add\_string\_2()}
to the variable \texttt{return\_from\_add\_strings\_2}. The
\texttt{print()} line prints to the console or ``standard output'', but
its output is not assigned or captured.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ add\_strings\_2(a, b):}
\NormalTok{    string\_to\_print }\OperatorTok{=}\NormalTok{ a }\OperatorTok{+} \StringTok{\textquotesingle{} \textquotesingle{}} \OperatorTok{+}\NormalTok{ b }\OperatorTok{+} \StringTok{\textquotesingle{} (this is from the print statement)\textquotesingle{}}
\NormalTok{    string\_to\_return }\OperatorTok{=}\NormalTok{ a }\OperatorTok{+} \StringTok{\textquotesingle{} \textquotesingle{}} \OperatorTok{+}\NormalTok{ b }\OperatorTok{+} \StringTok{\textquotesingle{} (this is from the return statement)\textquotesingle{}}
    \BuiltInTok{print}\NormalTok{(string\_to\_print)}
    \ControlFlowTok{return}\NormalTok{ string\_to\_return}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returned }\OperatorTok{=}\NormalTok{ add\_strings\_2(}\StringTok{\textquotesingle{}5\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}5\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
5 5 (this is from the print statement)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returned}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'5 5 (this is from the return statement)'
\end{verbatim}

\subsection{Variables and argument
passing}\label{variables-and-argument-passing}

\begin{quote}
When assigning a variable (or name) in Python, you are creating a
reference to the object on the righthand side of the equals sign.
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=}\NormalTok{ [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3]
\end{verbatim}

If we assign \texttt{a} to a new variable \texttt{b}, both \texttt{a}
and \texttt{b} refer to the \emph{same} object. This same object is the
list \texttt{{[}1,\ 2,\ 3{]}}. If we change \texttt{a}, we also change
\texttt{b}, because these variables or names refer to the \emph{same}
object.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=}\NormalTok{ a}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3]
\end{verbatim}

\textbf{\emph{Variables \texttt{a} and \texttt{b} refer to the same
object, a list \texttt{{[}1,\ 2,\ 3{]}}.}} We will learn more about
lists (and tuples and dictionaries) in chapter 3 of McKinney.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\KeywordTok{is}\NormalTok{ b}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\textbf{\emph{If we modify \texttt{a} by appending a 4, we change
\texttt{b} because \texttt{a} and \texttt{b} refer to the same list.}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a.append(}\DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3, 4]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3, 4]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\KeywordTok{is}\NormalTok{ b}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\textbf{\emph{Likewise, if we modify \texttt{b} by appending a 5, we
change \texttt{a}, too!}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b.append(}\DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3, 4, 5]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3, 4, 5]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\KeywordTok{is}\NormalTok{ b}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

The behavior is useful but a double-edged sword!
\href{https://nedbatchelder.com/text/names.html}{Here} is a deeper
discussion of this behavior.

\subsection{Dynamic references, strong
types}\label{dynamic-references-strong-types}

\begin{quote}
In contrast with many compiled languages, such as Java and C++, object
references in Python have no type associated with them.
\end{quote}

In Python,

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  We do not declare variables and their types
\item
  We can change variables' types because variables are only names that
  refer to objects
\end{enumerate}

\emph{Dynamic references} mean we can reassign a variable to a new
object in Python. For example, we can reassign \texttt{a} from a list to
an integer to a string.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3, 4, 5]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{type}\NormalTok{(a)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
list
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=} \DecValTok{5}
\BuiltInTok{type}\NormalTok{(a)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
int
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=} \StringTok{\textquotesingle{}foo\textquotesingle{}}
\BuiltInTok{type}\NormalTok{(a)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
str
\end{verbatim}

\emph{Strong types} mean Python typically will not convert object types.
For example, the code returns either
\texttt{\textquotesingle{}55\textquotesingle{}} as a string or
\texttt{10} as an integer in many programming languages. However,
\texttt{\textquotesingle{}5\textquotesingle{}\ +\ 5} returns an error in
Python.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# \textquotesingle{}5\textquotesingle{} + 5}
\end{Highlighting}
\end{Shaded}

However, Python implicitly converts integers to floats.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=} \FloatTok{4.5}
\NormalTok{b }\OperatorTok{=} \DecValTok{2}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}a is }\SpecialCharTok{\{}\BuiltInTok{type}\NormalTok{(a)}\SpecialCharTok{\}}\SpecialStringTok{, b is }\SpecialCharTok{\{}\BuiltInTok{type}\NormalTok{(b)}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{a }\OperatorTok{/}\NormalTok{ b}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
a is <class 'float'>, b is <class 'int'>
\end{verbatim}

\begin{verbatim}
2.25
\end{verbatim}

In the previous code cell:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The `a is \ldots{}' output prints because of the explicit
  \texttt{print()} function call
\item
  The output of \texttt{a\ /\ b} prints (or displays) because it is the
  last line in the code cell
\end{enumerate}

If we want integer division (or floor division), we have to use
\texttt{//}.

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{5} \OperatorTok{//} \DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{5} \OperatorTok{/} \DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2.5
\end{verbatim}

\subsection{Attributes and methods}\label{attributes-and-methods}

We can use tab completion to list attributes (characteristics stored
inside objects) and methods (functions associated with objects).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=} \StringTok{\textquotesingle{}foo\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a.capitalize()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'Foo'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a.upper().lower()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'foo'
\end{verbatim}

\subsection{Imports}\label{imports}

\begin{quote}
In Python a module is simply a file with the .py extension containing
Python code.
\end{quote}

We can import with \texttt{import} statements, which have several
syntaxes. The basic syntax uses the module name as the prefix to
separate module items from our current namespace.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ pandas}
\end{Highlighting}
\end{Shaded}

The \texttt{import\ as} syntax lets us define an abbreviated prefix.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\end{Highlighting}
\end{Shaded}

We can also import one or more items from a package into our namespace
with the following syntaxes.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{from}\NormalTok{ pandas }\ImportTok{import}\NormalTok{ DataFrame}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{from}\NormalTok{ pandas }\ImportTok{import}\NormalTok{ DataFrame }\ImportTok{as}\NormalTok{ df}
\end{Highlighting}
\end{Shaded}

\subsection{Binary operators and
comparisons}\label{binary-operators-and-comparisons}

Binary operators work like Excel.

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{5} \OperatorTok{{-}} \DecValTok{7}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{12} \OperatorTok{+} \FloatTok{21.5}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
33.5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{5} \OperatorTok{\textless{}=} \DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
False
\end{verbatim}

We can operate during an assignment to avoid two names referring to the
same object.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=}\NormalTok{ [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{]}
\NormalTok{b }\OperatorTok{=}\NormalTok{ a}
\NormalTok{c }\OperatorTok{=} \BuiltInTok{list}\NormalTok{(a)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\KeywordTok{is}\NormalTok{ b}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\KeywordTok{is}\NormalTok{ c}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
False
\end{verbatim}

Here \texttt{a} and \texttt{c} have the same \emph{values} but are not
the same object!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{==}\NormalTok{ c}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\KeywordTok{is} \KeywordTok{not}\NormalTok{ c}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

In Python, \texttt{=} is the assignment operator, \texttt{==} tests
equality, and \texttt{!=} tests inequality (\texttt{!=} in Python is
like \texttt{\textless{}\textgreater{}} in Excel).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{==}\NormalTok{ c}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{!=}\NormalTok{ c}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
False
\end{verbatim}

\texttt{a} and \texttt{c} have the same values but reference different
objects in memory.

\textbf{\emph{Table 2-1}} from McKinney summarizes the binary operators.

\begin{itemize}
\tightlist
\item
  \texttt{a\ +\ b} : Add a and b
\item
  \texttt{a\ -\ b} : Subtract b from a
\item
  \texttt{a\ *\ b} : Multiply a by b
\item
  \texttt{a\ /\ b} : Divide a by b
\item
  \texttt{a\ //\ b} : Floor-divide a by b, dropping any fractional
  remainder
\item
  \texttt{a\ **\ b} : Raise a to the b power
\item
  \texttt{a\ \&\ b} : True if both a and b are True; for integers, take
  the bitwise AND
\item
  \texttt{a\ \textbar{}\ b} : True if either a or b is True; for
  integers, take the bitwise OR
\item
  \texttt{a\ \^{}\ b} : For booleans, True if a or b is True , but not
  both; for integers, take the bitwise EXCLUSIVE-OR
\item
  \texttt{a\ ==\ b} : True if a equals b
\item
  \texttt{a\ !=\ b}: True if a is not equal to b
\item
  \texttt{a\ \textless{}=\ b,\ a\ \textless{}\ b} : True if a is less
  than (less than or equal) to b
\item
  \texttt{a\ \textgreater{}\ b,\ a\ \textgreater{}=\ b}: True if a is
  greater than (greater than or equal) to b
\item
  \texttt{a\ is\ b} : True if a and b reference the same Python object
\item
  \texttt{a\ is\ not\ b} : True if a and b reference different Python
  objects
\end{itemize}

\subsection{Mutable and immutable
objects}\label{mutable-and-immutable-objects}

\begin{quote}
Most objects in Python, such as lists, dicts, NumPy arrays, and most
user-defined types (classes), are mutable. This means that the object or
values that they contain can be modified.
\end{quote}

Lists are mutable, so we can modify them.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a\_list }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}foo\textquotesingle{}}\NormalTok{, }\DecValTok{2}\NormalTok{, [}\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{]]}
\end{Highlighting}
\end{Shaded}

\textbf{\emph{Python is zero-indexed! The first element has a zero
subscript \texttt{{[}0{]}}!}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a\_list[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'foo'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a\_list[}\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[4, 5]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a\_list[}\DecValTok{2}\NormalTok{][}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a\_list[}\DecValTok{2}\NormalTok{] }\OperatorTok{=}\NormalTok{ (}\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a\_list}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['foo', 2, (3, 4)]
\end{verbatim}

Tuples are \emph{immutable}, so we cannot modify them.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a\_tuple }\OperatorTok{=}\NormalTok{ (}\DecValTok{3}\NormalTok{, }\DecValTok{5}\NormalTok{, (}\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a\_tuple}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(3, 5, (4, 5))
\end{verbatim}

The Python interpreter returns an error if we try to modify
\texttt{a\_tuple} because tuples are immutable.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# a\_tuple[1] = \textquotesingle{}four\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\textbf{\emph{Note:}} Tuples do not require \texttt{()}, but \texttt{()}
improve readability.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{test }\OperatorTok{=} \DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{type}\NormalTok{(test)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
tuple
\end{verbatim}

We will learn more about Python's built-in data structures in McKinney
chapter 3.

\section{Scalar Types}\label{scalar-types}

\begin{quote}
Python along with its standard library has a small set of built-in types
for handling numerical data, strings, boolean ( True or False ) values,
and dates and time. These ``single value'' types are sometimes called
scalar types and we refer to them in this book as scalars. See Table 2-4
for a list of the main scalar types. Date and time handling will be
discussed separately, as these are provided by the datetime module in
the standard library.
\end{quote}

\textbf{\emph{Table 2-2}} from McKinney lists the standard scalar types.

\begin{itemize}
\tightlist
\item
  \texttt{None}: The Python ``null'' value (only one instance of the
  None object exists)
\item
  \texttt{str}: String type; holds Unicode (UTF-8 encoded) strings
\item
  \texttt{bytes}: Raw ASCII bytes (or Unicode encoded as bytes)
\item
  \texttt{float}: Double-precision (64-bit) floating-point number (note
  there is no separate double type)
\item
  \texttt{bool}: A True or False value
\item
  \texttt{int}: Arbitrary precision signed integer
\end{itemize}

\subsection{Numeric types}\label{numeric-types}

In Python, integers are unbounded, and \texttt{**} raises numbers to a
power. So, \texttt{ival\ **\ 6} is \(17239781^6\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ival }\OperatorTok{=} \DecValTok{17239871}
\NormalTok{ival }\OperatorTok{**} \DecValTok{6}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
26254519291092456596965462913230729701102721
\end{verbatim}

Floats (decimal numbers) are 64-bit in Python.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fval }\OperatorTok{=} \FloatTok{7.243}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{type}\NormalTok{(fval)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
float
\end{verbatim}

Dividing integers yields a float, if necessary.

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{3} \OperatorTok{/} \DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.5
\end{verbatim}

We have to use \texttt{//} if we want C-style integer division (i.e.,
\(3 / 2 = 1\)).

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{3} \OperatorTok{//} \DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1
\end{verbatim}

\subsection{Booleans}\label{booleans}

\begin{quote}
The two Boolean values in Python are written as True and False.
Comparisons and other conditional expressions evaluate to either True or
False. Boolean values are combined with the and and or keywords.
\end{quote}

Python is case sensitive, so we must type Booleans as \texttt{True} and
\texttt{False}.

\begin{Shaded}
\begin{Highlighting}[]
\VariableTok{True} \KeywordTok{and} \VariableTok{True}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}\DecValTok{5} \OperatorTok{\textgreater{}} \DecValTok{1}\NormalTok{) }\KeywordTok{and}\NormalTok{ (}\DecValTok{10} \OperatorTok{\textgreater{}} \DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\VariableTok{False} \KeywordTok{or} \VariableTok{True}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}\DecValTok{5} \OperatorTok{\textgreater{}} \DecValTok{1}\NormalTok{) }\KeywordTok{or}\NormalTok{ (}\DecValTok{10} \OperatorTok{\textgreater{}} \DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

We can substitute \texttt{\&} for \texttt{and} and \texttt{\textbar{}}
for \texttt{or}.

\begin{Shaded}
\begin{Highlighting}[]
\VariableTok{True} \OperatorTok{\&} \VariableTok{True}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\VariableTok{False} \OperatorTok{|} \VariableTok{True}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\subsection{Type casting}\label{type-casting}

We can ``recast'' variables to change their types.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{s }\OperatorTok{=} \StringTok{\textquotesingle{}3.14159\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{type}\NormalTok{(s)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
str
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{1} \OperatorTok{+} \BuiltInTok{float}\NormalTok{(s)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
4.14159
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fval }\OperatorTok{=} \BuiltInTok{float}\NormalTok{(s)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{type}\NormalTok{(fval)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
float
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{int}\NormalTok{(fval)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
3
\end{verbatim}

Zero is Boolean \texttt{False}, and all other values are Boolean
\texttt{True}.

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{bool}\NormalTok{(}\DecValTok{0}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
False
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{bool}\NormalTok{(}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{bool}\NormalTok{(}\OperatorTok{{-}}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

We can recast the string \texttt{\textquotesingle{}5\textquotesingle{}}
to an integer or the integer \texttt{5} to a string to prevent the
\texttt{5\ +\ \textquotesingle{}5\textquotesingle{}} error above.

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{5} \OperatorTok{+} \BuiltInTok{int}\NormalTok{(}\StringTok{\textquotesingle{}5\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
10
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{str}\NormalTok{(}\DecValTok{5}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}5\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'55'
\end{verbatim}

\subsection{None}\label{none}

In Python, \texttt{None} is null. \texttt{None} is like \texttt{\#N/A}
or \texttt{=na()} in Excel.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=} \VariableTok{None}
\NormalTok{a }\KeywordTok{is} \VariableTok{None}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=} \DecValTok{5}
\NormalTok{b }\KeywordTok{is} \KeywordTok{not} \VariableTok{None}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{type}\NormalTok{(}\VariableTok{None}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
NoneType
\end{verbatim}

\section{Control Flow}\label{control-flow}

\begin{quote}
Python has several built-in keywords for conditional logic, loops, and
other standard control flow concepts found in other programming
languages.
\end{quote}

If you understand Excel's \texttt{if()}, then you understand Python's
\texttt{if}, \texttt{elif}, and \texttt{else}.

\subsection{if, elif, and else}\label{if-elif-and-else}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OperatorTok{=} \OperatorTok{{-}}\DecValTok{1}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{type}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
int
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{if}\NormalTok{ x }\OperatorTok{\textless{}} \DecValTok{0}\NormalTok{:}
    \BuiltInTok{print}\NormalTok{(}\StringTok{"It\textquotesingle{}s negative"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
It's negative
\end{verbatim}

Single quotes and double quotes (\texttt{\textquotesingle{}} and
\texttt{"}) are equivalent in Python. However, in the previous code
cell, we use double quotes to differentiate between the enclosing quotes
and the apostrophe in \texttt{"It\textquotesingle{}s"}.

Python's \texttt{elif} avoids Excel's nested \texttt{if()}s.
\texttt{elif} continues an \texttt{if} block, and \texttt{else} runs if
the other conditions are not met.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OperatorTok{=} \DecValTok{10}
\ControlFlowTok{if}\NormalTok{ x }\OperatorTok{\textless{}} \DecValTok{0}\NormalTok{:}
    \BuiltInTok{print}\NormalTok{(}\StringTok{"It\textquotesingle{}s negative"}\NormalTok{)}
\ControlFlowTok{elif}\NormalTok{ x }\OperatorTok{==} \DecValTok{0}\NormalTok{:}
    \BuiltInTok{print}\NormalTok{(}\StringTok{\textquotesingle{}Equal to zero\textquotesingle{}}\NormalTok{)}
\ControlFlowTok{elif} \DecValTok{0} \OperatorTok{\textless{}}\NormalTok{ x }\OperatorTok{\textless{}} \DecValTok{5}\NormalTok{:}
    \BuiltInTok{print}\NormalTok{(}\StringTok{\textquotesingle{}Positive but smaller than 5\textquotesingle{}}\NormalTok{)}
\ControlFlowTok{else}\NormalTok{:}
    \BuiltInTok{print}\NormalTok{(}\StringTok{\textquotesingle{}Positive and larger than or equal to 5\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Positive and larger than or equal to 5
\end{verbatim}

We can combine comparisons with \texttt{and} and \texttt{or}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=} \DecValTok{5}
\NormalTok{b }\OperatorTok{=} \DecValTok{7}
\NormalTok{c }\OperatorTok{=} \DecValTok{8}
\NormalTok{d }\OperatorTok{=} \DecValTok{4}
\ControlFlowTok{if}\NormalTok{ a }\OperatorTok{\textless{}}\NormalTok{ b }\KeywordTok{or}\NormalTok{ c }\OperatorTok{\textgreater{}}\NormalTok{ d:}
    \BuiltInTok{print}\NormalTok{(}\StringTok{\textquotesingle{}Made it\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Made it
\end{verbatim}

\subsection{for loops}\label{for-loops}

We use \texttt{for} loops to loop over a collection, like a list or
tuple. The \texttt{continue} keyword skips the remainder of the
\texttt{if} block for that loop iteration.

The following example assigns values with \texttt{+=}, where
\texttt{a\ +=\ 5} is an abbreviation for \texttt{a\ =\ a\ +\ 5}. There
are equivalent abbreviations for subtraction, multiplication, and
division (\texttt{-=}, \texttt{*=}, and \texttt{/=}).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sequence }\OperatorTok{=}\NormalTok{ [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\VariableTok{None}\NormalTok{, }\DecValTok{4}\NormalTok{, }\VariableTok{None}\NormalTok{, }\DecValTok{5}\NormalTok{, }\StringTok{\textquotesingle{}Alex\textquotesingle{}}\NormalTok{]}
\NormalTok{total }\OperatorTok{=} \DecValTok{0}
\ControlFlowTok{for}\NormalTok{ value }\KeywordTok{in}\NormalTok{ sequence:}
    \ControlFlowTok{if}\NormalTok{ value }\KeywordTok{is} \VariableTok{None} \KeywordTok{or} \BuiltInTok{type}\NormalTok{(value) }\KeywordTok{is} \BuiltInTok{str}\NormalTok{:}
        \ControlFlowTok{continue}
\NormalTok{    total }\OperatorTok{+=}\NormalTok{ value }\CommentTok{\# the += operator is equivalent to "total = total + value"}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
12
\end{verbatim}

The \texttt{break} keyword exits the loop altogether.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sequence }\OperatorTok{=}\NormalTok{ [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{]}
\NormalTok{total\_until\_5 }\OperatorTok{=} \DecValTok{0}
\ControlFlowTok{for}\NormalTok{ value }\KeywordTok{in}\NormalTok{ sequence:}
    \ControlFlowTok{if}\NormalTok{ value }\OperatorTok{==} \DecValTok{5}\NormalTok{:}
        \ControlFlowTok{break}
\NormalTok{    total\_until\_5 }\OperatorTok{+=}\NormalTok{ value}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_until\_5}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
13
\end{verbatim}

\subsection{range}\label{range}

\begin{quote}
The range function returns an iterator that yields a sequence of evenly
spaced integers.
\end{quote}

\begin{itemize}
\tightlist
\item
  With one argument, \texttt{range()} creates an iterator from 0 to that
  number \emph{but excludes that number} (so \texttt{range(10)} is an
  interator with a length of 10 that starts at 0)
\item
  With two arguments, the first argument is the \emph{inclusive}
  starting value, and the second argument is the \emph{exclusive} ending
  value
\item
  With three arguments, the third argument is the iterator step size
\end{itemize}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{range}\NormalTok{(}\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
range(0, 10)
\end{verbatim}

We can cast a range to a list.

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\DecValTok{10}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{10}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3, 4, 5, 6, 7, 8, 9]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3, 4, 5, 6, 7, 8, 9]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{20}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0, 2, 4, 6, 8, 10, 12, 14, 16, 18]
\end{verbatim}

Python intervals are ``closed'' (inclusive) on the left and ``open''
(exclusive) on the right. The following is an empty list because we
cannot count from 5 to 0 by steps of +1.

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[]
\end{verbatim}

However, we can count from 5 to 0 in steps of -1.

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\DecValTok{5}\NormalTok{, }\DecValTok{0}\NormalTok{, }\OperatorTok{{-}}\DecValTok{1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[5, 4, 3, 2, 1]
\end{verbatim}

For loops have the following syntax in many other programming languages.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{seq }\OperatorTok{=}\NormalTok{ [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{]}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\BuiltInTok{len}\NormalTok{(seq)):}
\NormalTok{    val }\OperatorTok{=}\NormalTok{ seq[i]}
\end{Highlighting}
\end{Shaded}

However, in Python, we can directly loop over the list \texttt{seq}. The
following code cell is equivalent to the previous code cell and more
``Pythonic''.

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ seq:}
\NormalTok{    val }\OperatorTok{=}\NormalTok{ i}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{val}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
4
\end{verbatim}

\subsection{Ternary expressions}\label{ternary-expressions}

We said above that Python \texttt{if} and \texttt{else} is cumbersome
relative to Excel's \texttt{if()}. We can complete simple comparisons on
one line in Python.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OperatorTok{=} \DecValTok{5}
\NormalTok{value }\OperatorTok{=} \StringTok{\textquotesingle{}Non{-}negative\textquotesingle{}} \ControlFlowTok{if}\NormalTok{ x }\OperatorTok{\textgreater{}=} \DecValTok{0} \ControlFlowTok{else} \StringTok{\textquotesingle{}Negative\textquotesingle{}}
\NormalTok{value}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'Non-negative'
\end{verbatim}

\chapter{McKinney Chapter 2 - Practice for Section
02}\label{mckinney-chapter-2---practice-for-section-02}

\section{Announcements}\label{announcements}

There are no due dates this week, but please take note of a few due
dates next week:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Before class on Tuesday, complete the week 2 pre-class quiz
\item
  By Friday 1/19 at 11:59 PM:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Acknowledge the academic integrity section of our syllabus
  \item
    Complete the first DataCamp course and upload your certificate
  \end{enumerate}
\end{enumerate}

\section{5-minute Recap}\label{minute-recap}

\subsection{First, Python variables are references to
objects.}\label{first-python-variables-are-references-to-objects.}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=}\NormalTok{ [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{]}
\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=}\NormalTok{ a}
\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\KeywordTok{is}\NormalTok{ b}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\textbf{\emph{Python is zero-indexed!}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a[}\DecValTok{0}\NormalTok{] }\OperatorTok{=} \DecValTok{2\_001}
\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[2001, 2, 3]
\end{verbatim}

So both variables reflect changes to the referenced object.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[2001, 2, 3]
\end{verbatim}

We can also reassign a new object, which does not change the original
object.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=} \StringTok{\textquotesingle{}Och\textquotesingle{}}
\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'Och'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[2001, 2, 3]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=}\NormalTok{ a}
\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'Och'
\end{verbatim}

\subsection{Second, we can define functions to re-use
code}\label{second-we-can-define-functions-to-re-use-code}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ square\_root(x):}
    \ControlFlowTok{return}\NormalTok{ x }\OperatorTok{**} \FloatTok{0.5}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{square\_root(}\DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2.0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{square\_root(}\DecValTok{9}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
3.0
\end{verbatim}

Note that white space is requried and not just cosmetic! Our
\texttt{square\_root()} function does not work without the white space!

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# def square\_root(x):}
\CommentTok{\# return x ** 0.5}
\CommentTok{\#   Cell In[26], line 2}
\CommentTok{\#     return x ** 0.5}
\CommentTok{\#     \^{}}
\CommentTok{\# IndentationError: expected an indented block after function definition on line 1}
\end{Highlighting}
\end{Shaded}

\subsection{\texorpdfstring{Third, \texttt{if-elif-else} blocks let us
conditionally run code
blocks}{Third, if-elif-else blocks let us conditionally run code blocks}}\label{third-if-elif-else-blocks-let-us-conditionally-run-code-blocks}

Again, note the white space is required and not just cosmetic.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OperatorTok{=} \DecValTok{5}
\ControlFlowTok{if}\NormalTok{ x }\OperatorTok{\textless{}} \DecValTok{0}\NormalTok{:}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{\}}\SpecialStringTok{ is negative\textquotesingle{}}\NormalTok{)}
\ControlFlowTok{elif}\NormalTok{ x }\OperatorTok{==} \DecValTok{0}\NormalTok{:}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{\}}\SpecialStringTok{ is zero\textquotesingle{}}\NormalTok{)}
\ControlFlowTok{else}\NormalTok{:}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{\}}\SpecialStringTok{ is positive\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
5 is positive
\end{verbatim}

\section{Practice}\label{practice}

\subsection{\texorpdfstring{Extract the year, month, and day from an
integer 8-digit date (i.e., YYYYMMDD format) using \texttt{//} (integer
division) and \texttt{\%} (modulo
division).}{Extract the year, month, and day from an integer 8-digit date (i.e., YYYYMMDD format) using // (integer division) and \% (modulo division).}}\label{extract-the-year-month-and-day-from-an-integer-8-digit-date-i.e.-yyyymmdd-format-using-integer-division-and-modulo-division.}

Try \texttt{20080915}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lb\_collapse }\OperatorTok{=} \DecValTok{20080915}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lb\_collapse }\OperatorTok{/} \DecValTok{10\_000}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2008.0915
\end{verbatim}

Integer division \texttt{//} returns the integer portion.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lb\_collapse }\OperatorTok{//} \DecValTok{10\_000}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2008
\end{verbatim}

Modulo division \texttt{\%} returns the remainder.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lb\_collapse }\OperatorTok{\%} \DecValTok{10\_000} \OperatorTok{//} \DecValTok{100}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
9
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lb\_collapse }\OperatorTok{\%} \DecValTok{100}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
15
\end{verbatim}

\subsection{\texorpdfstring{Use your answer above to write a function
\texttt{date} that accepts an integer 8-digit date argument and returns
a tuple of the year, month, and date (e.g.,
\texttt{return\ (year,\ month,\ date)}).}{Use your answer above to write a function date that accepts an integer 8-digit date argument and returns a tuple of the year, month, and date (e.g., return (year, month, date)).}}\label{use-your-answer-above-to-write-a-function-date-that-accepts-an-integer-8-digit-date-argument-and-returns-a-tuple-of-the-year-month-and-date-e.g.-return-year-month-date.}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ date(ymd):}
\NormalTok{    year }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{//} \DecValTok{10\_000}
\NormalTok{    month }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{\%} \DecValTok{10\_000} \OperatorTok{//} \DecValTok{100}
\NormalTok{    day }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{\%} \DecValTok{100}
    \ControlFlowTok{return}\NormalTok{ (year, month, day)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{date(lb\_collapse)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(2008, 9, 15)
\end{verbatim}

\subsection{\texorpdfstring{Rewrite \texttt{date} to accept an 8-digit
date as an integer or
string.}{Rewrite date to accept an 8-digit date as an integer or string.}}\label{rewrite-date-to-accept-an-8-digit-date-as-an-integer-or-string.}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ date\_2(ymd):}
    \ControlFlowTok{if} \BuiltInTok{type}\NormalTok{(ymd) }\KeywordTok{is} \BuiltInTok{str}\NormalTok{:}
\NormalTok{        ymd }\OperatorTok{=} \BuiltInTok{int}\NormalTok{(ymd)}
\NormalTok{    year }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{//} \DecValTok{10\_000}
\NormalTok{    month }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{\%} \DecValTok{10\_000} \OperatorTok{//} \DecValTok{100}
\NormalTok{    day }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{\%} \DecValTok{100}
    \ControlFlowTok{return}\NormalTok{ (year, month, day)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{date\_2(}\StringTok{\textquotesingle{}20080915\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(2008, 9, 15)
\end{verbatim}

\subsection{\texorpdfstring{Finally, rewrite \texttt{date} to accept a
list of 8-digit dates as integers or
strings.}{Finally, rewrite date to accept a list of 8-digit dates as integers or strings.}}\label{finally-rewrite-date-to-accept-a-list-of-8-digit-dates-as-integers-or-strings.}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dates }\OperatorTok{=}\NormalTok{ [}\DecValTok{20080915}\NormalTok{, }\StringTok{\textquotesingle{}20080916\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ date\_3(ymd):}
\NormalTok{    ymds }\OperatorTok{=}\NormalTok{ [] }\CommentTok{\# empty list to store our tuples of (year, month, day)}
    \ControlFlowTok{for}\NormalTok{ ymd }\KeywordTok{in}\NormalTok{ dates:}
        \ControlFlowTok{if} \BuiltInTok{type}\NormalTok{(ymd) }\KeywordTok{is} \BuiltInTok{str}\NormalTok{:}
\NormalTok{            ymd }\OperatorTok{=} \BuiltInTok{int}\NormalTok{(ymd)}
\NormalTok{        year }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{//} \DecValTok{10\_000}
\NormalTok{        month }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{\%} \DecValTok{10\_000} \OperatorTok{//} \DecValTok{100}
\NormalTok{        day }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{\%} \DecValTok{100}
\NormalTok{        ymds.append((year, month, day)) }\CommentTok{\# add new (year, month, day) to end of our list}

    \ControlFlowTok{return}\NormalTok{ ymds}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{date\_3(dates)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[(2008, 9, 15), (2008, 9, 16)]
\end{verbatim}

Return a list of tuples of year, month, and date.

\subsection{Write a for loop that prints the squares of integers from 1
to
10.}\label{write-a-for-loop-that-prints-the-squares-of-integers-from-1-to-10.}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{11}\NormalTok{):}
    \BuiltInTok{print}\NormalTok{(i}\OperatorTok{**}\DecValTok{2}\NormalTok{, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1 4 9 16 25 36 49 64 81 100 
\end{verbatim}

Above, I change the \texttt{end} argument to a space to shorten the
output.

\subsection{\texorpdfstring{Write a for loop that prints the squares of
\emph{even} integers from 1 to
10.}{Write a for loop that prints the squares of even integers from 1 to 10.}}\label{write-a-for-loop-that-prints-the-squares-of-even-integers-from-1-to-10.}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{11}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ i }\OperatorTok{\%} \DecValTok{2} \OperatorTok{==} \DecValTok{0}\NormalTok{:}
        \BuiltInTok{print}\NormalTok{(i}\OperatorTok{**}\DecValTok{2}\NormalTok{, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
4 16 36 64 100 
\end{verbatim}

\subsection{Write a for loop that sums the squares of integers from 1 to
10.}\label{write-a-for-loop-that-sums-the-squares-of-integers-from-1-to-10.}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total }\OperatorTok{=} \DecValTok{0}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{11}\NormalTok{):}
\NormalTok{    total }\OperatorTok{+=}\NormalTok{ i}\OperatorTok{**}\DecValTok{2}

\NormalTok{total}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
385
\end{verbatim}

\subsection{Write a for loop that sums the squares of integers from 1 to
10 but stops before the sum exceeds
50.}\label{write-a-for-loop-that-sums-the-squares-of-integers-from-1-to-10-but-stops-before-the-sum-exceeds-50.}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total }\OperatorTok{=} \DecValTok{0}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{11}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ (total }\OperatorTok{+}\NormalTok{ i}\OperatorTok{**}\DecValTok{2}\NormalTok{) }\OperatorTok{\textgreater{}} \DecValTok{50}\NormalTok{:}
        \ControlFlowTok{break}
\NormalTok{    total }\OperatorTok{+=}\NormalTok{ i}\OperatorTok{**}\DecValTok{2}

\NormalTok{total}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
30
\end{verbatim}

\subsection{FizzBuzz}\label{fizzbuzz}

Write a for loop that prints the numbers from 1 to 100. For multiples of
three print ``Fizz'' instead of the number. For multiples of five print
``Buzz''. For numbers that are multiples of both three and five print
``FizzBuzz''. More
\href{https://blog.codinghorror.com/why-cant-programmers-program/}{here}.

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{101}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ (i }\OperatorTok{\%} \DecValTok{3} \OperatorTok{==} \DecValTok{0}\NormalTok{) }\OperatorTok{\&}\NormalTok{ (i }\OperatorTok{\%} \DecValTok{5} \OperatorTok{==} \DecValTok{0}\NormalTok{):}
        \BuiltInTok{print}\NormalTok{(}\StringTok{\textquotesingle{}FizzBuzz\textquotesingle{}}\NormalTok{, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
    \ControlFlowTok{elif}\NormalTok{ (i }\OperatorTok{\%} \DecValTok{3} \OperatorTok{==} \DecValTok{0}\NormalTok{):}
        \BuiltInTok{print}\NormalTok{(}\StringTok{\textquotesingle{}Fizz\textquotesingle{}}\NormalTok{, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
    \ControlFlowTok{elif}\NormalTok{ (i }\OperatorTok{\%} \DecValTok{5} \OperatorTok{==} \DecValTok{0}\NormalTok{):}
        \BuiltInTok{print}\NormalTok{(}\StringTok{\textquotesingle{}Buzz\textquotesingle{}}\NormalTok{, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
    \ControlFlowTok{else}\NormalTok{:}
        \BuiltInTok{print}\NormalTok{(i, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1 2 Fizz 4 Buzz Fizz 7 8 Fizz Buzz 11 Fizz 13 14 FizzBuzz 16 17 Fizz 19 Buzz Fizz 22 23 Fizz Buzz 26 Fizz 28 29 FizzBuzz 31 32 Fizz 34 Buzz Fizz 37 38 Fizz Buzz 41 Fizz 43 44 FizzBuzz 46 47 Fizz 49 Buzz Fizz 52 53 Fizz Buzz 56 Fizz 58 59 FizzBuzz 61 62 Fizz 64 Buzz Fizz 67 68 Fizz Buzz 71 Fizz 73 74 FizzBuzz 76 77 Fizz 79 Buzz Fizz 82 83 Fizz Buzz 86 Fizz 88 89 FizzBuzz 91 92 Fizz 94 Buzz Fizz 97 98 Fizz Buzz 
\end{verbatim}

\subsection{Use ternary expressions to make your FizzBuzz code more
compact.}\label{use-ternary-expressions-to-make-your-fizzbuzz-code-more-compact.}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{101}\NormalTok{):}
    \BuiltInTok{print}\NormalTok{(}\StringTok{\textquotesingle{}Fizz\textquotesingle{}}\OperatorTok{*}\NormalTok{(i}\OperatorTok{\%}\DecValTok{3}\OperatorTok{==}\DecValTok{0}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}Buzz\textquotesingle{}}\OperatorTok{*}\NormalTok{(i}\OperatorTok{\%}\DecValTok{5}\OperatorTok{==}\DecValTok{0}\NormalTok{) }\ControlFlowTok{if}\NormalTok{ (i}\OperatorTok{\%}\DecValTok{3}\OperatorTok{==}\DecValTok{0}\NormalTok{) }\KeywordTok{or}\NormalTok{ (i}\OperatorTok{\%}\DecValTok{5}\OperatorTok{==}\DecValTok{0}\NormalTok{) }\ControlFlowTok{else}\NormalTok{ i, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1 2 Fizz 4 Buzz Fizz 7 8 Fizz Buzz 11 Fizz 13 14 FizzBuzz 16 17 Fizz 19 Buzz Fizz 22 23 Fizz Buzz 26 Fizz 28 29 FizzBuzz 31 32 Fizz 34 Buzz Fizz 37 38 Fizz Buzz 41 Fizz 43 44 FizzBuzz 46 47 Fizz 49 Buzz Fizz 52 53 Fizz Buzz 56 Fizz 58 59 FizzBuzz 61 62 Fizz 64 Buzz Fizz 67 68 Fizz Buzz 71 Fizz 73 74 FizzBuzz 76 77 Fizz 79 Buzz Fizz 82 83 Fizz Buzz 86 Fizz 88 89 FizzBuzz 91 92 Fizz 94 Buzz Fizz 97 98 Fizz Buzz 
\end{verbatim}

The solution above is shorter and uses from neat tricks, but I consider
the previous solution easier to read and troubleshoot. The solution
above uses the trick that we can multiply a string by \texttt{True} or
\texttt{False} to return the string itself or an empty string.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}Hey!\textquotesingle{}}\OperatorTok{*}\VariableTok{True}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'Hey!'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}Hey!\textquotesingle{}}\OperatorTok{*}\VariableTok{False}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
''
\end{verbatim}

\subsection{Triangle}\label{triangle}

Write a function \texttt{triangle} that accepts a positive integer \(N\)
and prints a numerical triangle of height \(N-1\). For example,
\texttt{triangle(N=6)} should print:

\begin{verbatim}
1
22
333
4444
55555
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ triangle(N):}
    \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, N):}
        \BuiltInTok{print}\NormalTok{(}\BuiltInTok{str}\NormalTok{(i) }\OperatorTok{*}\NormalTok{ i)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{triangle(}\DecValTok{6}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1
22
333
4444
55555
\end{verbatim}

The solution above works because a multiplying a string by \texttt{i}
concatenates \texttt{i} copies of the string.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}Test\textquotesingle{}} \OperatorTok{+} \StringTok{\textquotesingle{}Test\textquotesingle{}} \OperatorTok{+} \StringTok{\textquotesingle{}Test\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'TestTestTest'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}Test\textquotesingle{}} \OperatorTok{*} \DecValTok{3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'TestTestTest'
\end{verbatim}

\subsection{Two Sum}\label{two-sum}

Write a function \texttt{two\_sum} that does the following.

Given an array of integers \texttt{nums}~and an integer \texttt{target},
return the indices of the two numbers that add up to target.

You may assume that each input would have exactly one solution, and you
may not use the same element twice.

You can return the answer in any order.

Here are some examples:

Example 1:

Input: \texttt{nums\ =\ {[}2,7,11,15{]}}, \texttt{target\ =\ 9}\\
Output: \texttt{{[}0,1{]}}\\
Explanation: Because \texttt{nums{[}0{]}\ +\ nums{[}1{]}\ ==\ 9}, we
return \texttt{{[}0,\ 1{]}}.

Example 2:

Input: \texttt{nums\ =\ {[}3,2,4{]}}, \texttt{target\ =\ 6}\\
Output: \texttt{{[}1,2{]}}\\

Example 3:

Input: \texttt{nums\ =\ {[}3,3{]}}, \texttt{target\ =\ 6}\\
Output: \texttt{{[}0,1{]}}\\

I saw this question on
\href{https://leetcode.com/problems/two-sum/description/}{LeetCode}.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ two\_sum(nums, target):}
    \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\BuiltInTok{len}\NormalTok{(nums)):}
        \ControlFlowTok{for}\NormalTok{ j }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(i):}
            \ControlFlowTok{if}\NormalTok{ nums[i] }\OperatorTok{+}\NormalTok{ nums[j] }\OperatorTok{==}\NormalTok{ target:}
                \ControlFlowTok{return}\NormalTok{ [j, i]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{two\_sum(nums }\OperatorTok{=}\NormalTok{ [}\DecValTok{2}\NormalTok{,}\DecValTok{7}\NormalTok{,}\DecValTok{11}\NormalTok{,}\DecValTok{15}\NormalTok{], target }\OperatorTok{=} \DecValTok{9}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0, 1]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{two\_sum(nums }\OperatorTok{=}\NormalTok{ [}\DecValTok{3}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{], target }\OperatorTok{=} \DecValTok{6}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{two\_sum(nums }\OperatorTok{=}\NormalTok{ [}\DecValTok{3}\NormalTok{,}\DecValTok{3}\NormalTok{], target }\OperatorTok{=} \DecValTok{6}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0, 1]
\end{verbatim}

We can write more efficient code once we learn other data structures in
chapter 3 of McKinney!

\subsection{Best Time}\label{best-time}

Write a function \texttt{best\_time} that solves the following.

You are given an array \texttt{prices} where \texttt{prices{[}i{]}} is
the price of a given stock on the \(i^{th}\) day.

You want to maximize your profit by choosing a single day to buy one
stock and choosing a different day in the future to sell that stock.

Return the maximum profit you can achieve from this transaction. If you
cannot achieve any profit, return 0.

Here are some examples:

Example 1:

Input: \texttt{prices\ =\ {[}7,1,5,3,6,4{]}}\\
Output: \texttt{5}\\
Explanation: Buy on day 2 (price = 1) and sell on day 5 (price = 6),
profit = 6-1 = 5. Note that buying on day 2 and selling on day 1 is not
allowed because you must buy before you sell.

Example 2:

Input: \texttt{prices\ =\ {[}7,6,4,3,1{]}}\\
Output: \texttt{0}\\
Explanation: In this case, no transactions are done and the max profit =
0.

I saw this question on
\href{https://leetcode.com/problems/best-time-to-buy-and-sell-stock/}{LeetCode}.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ max\_profit(prices):}
\NormalTok{        min\_price }\OperatorTok{=}\NormalTok{ prices[}\DecValTok{0}\NormalTok{]}
\NormalTok{        max\_profit }\OperatorTok{=} \DecValTok{0}
        \ControlFlowTok{for}\NormalTok{ price }\KeywordTok{in}\NormalTok{ prices:}
\NormalTok{            min\_price }\OperatorTok{=}\NormalTok{ price }\ControlFlowTok{if}\NormalTok{ price }\OperatorTok{\textless{}}\NormalTok{ min\_price }\ControlFlowTok{else}\NormalTok{ min\_price}
\NormalTok{            profit }\OperatorTok{=}\NormalTok{ price }\OperatorTok{{-}}\NormalTok{ min\_price}
\NormalTok{            max\_profit }\OperatorTok{=}\NormalTok{ profit }\ControlFlowTok{if}\NormalTok{ profit }\OperatorTok{\textgreater{}}\NormalTok{ max\_profit }\ControlFlowTok{else}\NormalTok{ max\_profit}
        \ControlFlowTok{return}\NormalTok{ max\_profit}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{max\_profit(prices}\OperatorTok{=}\NormalTok{[}\DecValTok{7}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{5}\NormalTok{,}\DecValTok{3}\NormalTok{,}\DecValTok{6}\NormalTok{,}\DecValTok{4}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{max\_profit(prices}\OperatorTok{=}\NormalTok{[}\DecValTok{7}\NormalTok{,}\DecValTok{6}\NormalTok{,}\DecValTok{4}\NormalTok{,}\DecValTok{3}\NormalTok{,}\DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0
\end{verbatim}

\chapter{McKinney Chapter 2 - Practice for Section
03}\label{mckinney-chapter-2---practice-for-section-03}

\section{Announcements}\label{announcements-1}

There are no due dates this week, but please take note of a few due
dates next week:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Before class on Tuesday, complete the week 2 pre-class quiz
\item
  By Friday 1/19 at 11:59 PM:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Acknowledge the academic integrity section of our syllabus
  \item
    Complete the first DataCamp course and upload your certificate
  \end{enumerate}
\end{enumerate}

\section{5-minute Recap}\label{minute-recap-1}

\subsection{First, Python variables are references to
objects.}\label{first-python-variables-are-references-to-objects.-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=}\NormalTok{ [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{]}

\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=}\NormalTok{ a}

\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3]
\end{verbatim}

\textbf{\emph{Python is zero-indexed!}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b[}\DecValTok{0}\NormalTok{] }\OperatorTok{=} \DecValTok{2\_001}

\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[2001, 2, 3]
\end{verbatim}

So both variables reflect changes to the referenced object.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[2001, 2, 3]
\end{verbatim}

Variables \texttt{a} and \texttt{b} are two names for the same list in
memory!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\KeywordTok{is}\NormalTok{ a}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

We can also reassign a new object, which does not change the original
object.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=} \StringTok{\textquotesingle{}Och\textquotesingle{}}

\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'Och'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[2001, 2, 3]
\end{verbatim}

\subsection{Second, we can define functions to re-use
code}\label{second-we-can-define-functions-to-re-use-code-1}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ square\_root(x):}
    \ControlFlowTok{return}\NormalTok{ x }\OperatorTok{**} \FloatTok{0.5}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{square\_root(}\DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2.0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{square\_root(}\DecValTok{9}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
3.0
\end{verbatim}

Note that white space is requried and not just cosmetic! Our
\texttt{square\_root()} function does not work without the white space!

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# def square\_root(x):}
\CommentTok{\# return x ** 0.5}
\CommentTok{\#   Cell In[26], line 2}
\CommentTok{\#     return x ** 0.5}
\CommentTok{\#     \^{}}
\CommentTok{\# IndentationError: expected an indented block after function definition on line 1}
\end{Highlighting}
\end{Shaded}

\subsection{\texorpdfstring{Third, \texttt{if-elif-else} blocks let us
conditionally run code
blocks}{Third, if-elif-else blocks let us conditionally run code blocks}}\label{third-if-elif-else-blocks-let-us-conditionally-run-code-blocks-1}

Again, note the white space is required and not just cosmetic.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OperatorTok{=} \DecValTok{5}
\ControlFlowTok{if}\NormalTok{ x }\OperatorTok{\textless{}} \DecValTok{0}\NormalTok{:}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{\}}\SpecialStringTok{ is negative\textquotesingle{}}\NormalTok{)}
\ControlFlowTok{elif}\NormalTok{ x }\OperatorTok{==} \DecValTok{0}\NormalTok{:}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{\}}\SpecialStringTok{ is zero\textquotesingle{}}\NormalTok{)}
\ControlFlowTok{else}\NormalTok{:}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{\}}\SpecialStringTok{ is positive\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
5 is positive
\end{verbatim}

\section{Practice}\label{practice-1}

\subsection{\texorpdfstring{Extract the year, month, and day from an
integer 8-digit date (i.e., YYYYMMDD format) using \texttt{//} (integer
division) and \texttt{\%} (modulo
division).}{Extract the year, month, and day from an integer 8-digit date (i.e., YYYYMMDD format) using // (integer division) and \% (modulo division).}}\label{extract-the-year-month-and-day-from-an-integer-8-digit-date-i.e.-yyyymmdd-format-using-integer-division-and-modulo-division.-1}

Try \texttt{20080915}.

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{1234} \OperatorTok{/} \DecValTok{100}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
12.34
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{1234} \OperatorTok{//} \DecValTok{100}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
12
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{1234} \OperatorTok{\%} \DecValTok{100}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
34
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{12} \OperatorTok{/} \DecValTok{5}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2.4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{12} \OperatorTok{//} \DecValTok{5}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{12} \OperatorTok{\%} \DecValTok{5}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lb\_collapse }\OperatorTok{=} \DecValTok{20080915}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lb\_collapse }\OperatorTok{//} \DecValTok{10\_000}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2008
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lb\_collapse }\OperatorTok{\%} \DecValTok{10\_000} \OperatorTok{//} \DecValTok{100}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
9
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lb\_collapse }\OperatorTok{\%} \DecValTok{100}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
15
\end{verbatim}

\subsection{\texorpdfstring{Use your answer above to write a function
\texttt{date} that accepts an integer 8-digit date argument and returns
a tuple of the year, month, and date (e.g.,
\texttt{return\ (year,\ month,\ date)}).}{Use your answer above to write a function date that accepts an integer 8-digit date argument and returns a tuple of the year, month, and date (e.g., return (year, month, date)).}}\label{use-your-answer-above-to-write-a-function-date-that-accepts-an-integer-8-digit-date-argument-and-returns-a-tuple-of-the-year-month-and-date-e.g.-return-year-month-date.-1}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ date(ymd):}
\NormalTok{    year }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{//} \DecValTok{10\_000}
\NormalTok{    month }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{\%} \DecValTok{10\_000} \OperatorTok{//} \DecValTok{100}
\NormalTok{    day }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{\%} \DecValTok{100}
    \ControlFlowTok{return}\NormalTok{ (year, month, day)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{date(lb\_collapse)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(2008, 9, 15)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{date(}\DecValTok{20240112}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(2024, 1, 12)
\end{verbatim}

\subsection{\texorpdfstring{Rewrite \texttt{date} to accept an 8-digit
date as an integer or
string.}{Rewrite date to accept an 8-digit date as an integer or string.}}\label{rewrite-date-to-accept-an-8-digit-date-as-an-integer-or-string.-1}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ date\_2(ymd):}
    \ControlFlowTok{if} \BuiltInTok{type}\NormalTok{(ymd) }\KeywordTok{is} \BuiltInTok{str}\NormalTok{:}
\NormalTok{        ymd }\OperatorTok{=} \BuiltInTok{int}\NormalTok{(ymd)}
\NormalTok{    year }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{//} \DecValTok{10\_000}
\NormalTok{    month }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{\%} \DecValTok{10\_000} \OperatorTok{//} \DecValTok{100}
\NormalTok{    day }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{\%} \DecValTok{100}
    \ControlFlowTok{return}\NormalTok{ (year, month, day)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{date\_2(}\StringTok{\textquotesingle{}20080915\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(2008, 9, 15)
\end{verbatim}

\subsection{\texorpdfstring{Finally, rewrite \texttt{date} to accept a
list of 8-digit dates as integers or
strings.}{Finally, rewrite date to accept a list of 8-digit dates as integers or strings.}}\label{finally-rewrite-date-to-accept-a-list-of-8-digit-dates-as-integers-or-strings.-1}

Return a list of tuples of year, month, and date.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ymds }\OperatorTok{=}\NormalTok{ [}\DecValTok{20080915}\NormalTok{, }\StringTok{\textquotesingle{}20080916\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ date\_3(ymds):}
\NormalTok{    dates }\OperatorTok{=}\NormalTok{ []}
    \ControlFlowTok{for}\NormalTok{ ymd }\KeywordTok{in}\NormalTok{ ymds:}
        \ControlFlowTok{if} \BuiltInTok{type}\NormalTok{(ymd) }\KeywordTok{is} \BuiltInTok{str}\NormalTok{:}
\NormalTok{            ymd }\OperatorTok{=} \BuiltInTok{int}\NormalTok{(ymd)}
\NormalTok{        year }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{//} \DecValTok{10\_000}
\NormalTok{        month }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{\%} \DecValTok{10\_000} \OperatorTok{//} \DecValTok{100}
\NormalTok{        day }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{\%} \DecValTok{100}
\NormalTok{        dates.append((year, month, day))}
    \ControlFlowTok{return}\NormalTok{ dates}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{date\_3(ymds)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[(2008, 9, 15), (2008, 9, 16)]
\end{verbatim}

\subsection{Write a for loop that prints the squares of integers from 1
to
10.}\label{write-a-for-loop-that-prints-the-squares-of-integers-from-1-to-10.-1}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{11}\NormalTok{):}
    \BuiltInTok{print}\NormalTok{(i}\OperatorTok{**}\DecValTok{2}\NormalTok{, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1 4 9 16 25 36 49 64 81 100 
\end{verbatim}

Above, I change the \texttt{end} argument to a space to shorten the
output.

\subsection{\texorpdfstring{Write a for loop that prints the squares of
\emph{even} integers from 1 to
10.}{Write a for loop that prints the squares of even integers from 1 to 10.}}\label{write-a-for-loop-that-prints-the-squares-of-even-integers-from-1-to-10.-1}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{11}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ i }\OperatorTok{\%} \DecValTok{2} \OperatorTok{==} \DecValTok{0}\NormalTok{:}
        \BuiltInTok{print}\NormalTok{(i}\OperatorTok{**}\DecValTok{2}\NormalTok{, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
4 16 36 64 100 
\end{verbatim}

\subsection{Write a for loop that sums the squares of integers from 1 to
10.}\label{write-a-for-loop-that-sums-the-squares-of-integers-from-1-to-10.-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total }\OperatorTok{=} \DecValTok{0}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{11}\NormalTok{):}
\NormalTok{    total }\OperatorTok{+=}\NormalTok{ i}\OperatorTok{**}\DecValTok{2}

\NormalTok{total}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
385
\end{verbatim}

\subsection{Write a for loop that sums the squares of integers from 1 to
10 but stops before the sum exceeds
50.}\label{write-a-for-loop-that-sums-the-squares-of-integers-from-1-to-10-but-stops-before-the-sum-exceeds-50.-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total }\OperatorTok{=} \DecValTok{0}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{11}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ (total }\OperatorTok{+}\NormalTok{ i}\OperatorTok{**}\DecValTok{2}\NormalTok{) }\OperatorTok{\textgreater{}} \DecValTok{50}\NormalTok{:}
        \ControlFlowTok{break}
\NormalTok{    total }\OperatorTok{+=}\NormalTok{ i}\OperatorTok{**}\DecValTok{2}

\NormalTok{total}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
30
\end{verbatim}

\subsection{FizzBuzz}\label{fizzbuzz-1}

Write a for loop that prints the numbers from 1 to 100. For multiples of
three print ``Fizz'' instead of the number. For multiples of five print
``Buzz''. For numbers that are multiples of both three and five print
``FizzBuzz''. More
\href{https://blog.codinghorror.com/why-cant-programmers-program/}{here}.

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{101}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ (i }\OperatorTok{\%} \DecValTok{3} \OperatorTok{==} \DecValTok{0}\NormalTok{) }\KeywordTok{and}\NormalTok{ (i }\OperatorTok{\%} \DecValTok{5} \OperatorTok{==} \DecValTok{0}\NormalTok{):}
        \BuiltInTok{print}\NormalTok{(}\StringTok{\textquotesingle{}FizzBuzz\textquotesingle{}}\NormalTok{, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
    \ControlFlowTok{elif}\NormalTok{ i }\OperatorTok{\%} \DecValTok{3} \OperatorTok{==} \DecValTok{0}\NormalTok{:}
        \BuiltInTok{print}\NormalTok{(}\StringTok{\textquotesingle{}Fizz\textquotesingle{}}\NormalTok{, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
    \ControlFlowTok{elif}\NormalTok{ i }\OperatorTok{\%} \DecValTok{5} \OperatorTok{==} \DecValTok{0}\NormalTok{:}
        \BuiltInTok{print}\NormalTok{(}\StringTok{\textquotesingle{}Buzz\textquotesingle{}}\NormalTok{, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
    \ControlFlowTok{else}\NormalTok{:}
        \BuiltInTok{print}\NormalTok{(i, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1 2 Fizz 4 Buzz Fizz 7 8 Fizz Buzz 11 Fizz 13 14 FizzBuzz 16 17 Fizz 19 Buzz Fizz 22 23 Fizz Buzz 26 Fizz 28 29 FizzBuzz 31 32 Fizz 34 Buzz Fizz 37 38 Fizz Buzz 41 Fizz 43 44 FizzBuzz 46 47 Fizz 49 Buzz Fizz 52 53 Fizz Buzz 56 Fizz 58 59 FizzBuzz 61 62 Fizz 64 Buzz Fizz 67 68 Fizz Buzz 71 Fizz 73 74 FizzBuzz 76 77 Fizz 79 Buzz Fizz 82 83 Fizz Buzz 86 Fizz 88 89 FizzBuzz 91 92 Fizz 94 Buzz Fizz 97 98 Fizz Buzz 
\end{verbatim}

\subsection{Use ternary expressions to make your FizzBuzz code more
compact.}\label{use-ternary-expressions-to-make-your-fizzbuzz-code-more-compact.-1}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}Fizz\textquotesingle{}}\OperatorTok{*}\VariableTok{True} \OperatorTok{+} \StringTok{\textquotesingle{}Buzz\textquotesingle{}}\OperatorTok{*}\VariableTok{True}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'FizzBuzz'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{101}\NormalTok{):}
    \BuiltInTok{print}\NormalTok{(}\StringTok{\textquotesingle{}Fizz\textquotesingle{}}\OperatorTok{*}\NormalTok{(i}\OperatorTok{\%}\DecValTok{3}\OperatorTok{==}\DecValTok{0}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}Buzz\textquotesingle{}}\OperatorTok{*}\NormalTok{(i}\OperatorTok{\%}\DecValTok{5}\OperatorTok{==}\DecValTok{0}\NormalTok{) }\ControlFlowTok{if}\NormalTok{ (i}\OperatorTok{\%}\DecValTok{3}\OperatorTok{==}\DecValTok{0}\NormalTok{) }\KeywordTok{or}\NormalTok{ (i}\OperatorTok{\%}\DecValTok{5}\OperatorTok{==}\DecValTok{0}\NormalTok{) }\ControlFlowTok{else}\NormalTok{ i, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1 2 Fizz 4 Buzz Fizz 7 8 Fizz Buzz 11 Fizz 13 14 FizzBuzz 16 17 Fizz 19 Buzz Fizz 22 23 Fizz Buzz 26 Fizz 28 29 FizzBuzz 31 32 Fizz 34 Buzz Fizz 37 38 Fizz Buzz 41 Fizz 43 44 FizzBuzz 46 47 Fizz 49 Buzz Fizz 52 53 Fizz Buzz 56 Fizz 58 59 FizzBuzz 61 62 Fizz 64 Buzz Fizz 67 68 Fizz Buzz 71 Fizz 73 74 FizzBuzz 76 77 Fizz 79 Buzz Fizz 82 83 Fizz Buzz 86 Fizz 88 89 FizzBuzz 91 92 Fizz 94 Buzz Fizz 97 98 Fizz Buzz 
\end{verbatim}

The solution above is shorter and uses from neat tricks, but I consider
the previous solution easier to read and troubleshoot. The solution
above uses the trick that we can multiply a string by \texttt{True} or
\texttt{False} to return the string itself or an empty string.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}Hey!\textquotesingle{}}\OperatorTok{*}\VariableTok{True}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'Hey!'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}Hey!\textquotesingle{}}\OperatorTok{*}\VariableTok{False}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
''
\end{verbatim}

\subsection{Triangle}\label{triangle-1}

Write a function \texttt{triangle} that accepts a positive integer \(N\)
and prints a numerical triangle of height \(N-1\). For example,
\texttt{triangle(N=6)} should print:

\begin{verbatim}
1
22
333
4444
55555
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ triangle(N):}
    \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, N):}
        \BuiltInTok{print}\NormalTok{(}\BuiltInTok{str}\NormalTok{(i) }\OperatorTok{*}\NormalTok{ i)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{triangle(}\DecValTok{6}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1
22
333
4444
55555
\end{verbatim}

The solution above works because a multiplying a string by \texttt{i}
concatenates \texttt{i} copies of the string.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}Test\textquotesingle{}} \OperatorTok{+} \StringTok{\textquotesingle{}Test\textquotesingle{}} \OperatorTok{+} \StringTok{\textquotesingle{}Test\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'TestTestTest'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}Test\textquotesingle{}} \OperatorTok{*} \DecValTok{3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'TestTestTest'
\end{verbatim}

\subsection{Two Sum}\label{two-sum-1}

Write a function \texttt{two\_sum} that does the following.

Given an array of integers \texttt{nums}~and an integer \texttt{target},
return the indices of the two numbers that add up to target.

You may assume that each input would have exactly one solution, and you
may not use the same element twice.

You can return the answer in any order.

Here are some examples:

Example 1:

Input: \texttt{nums\ =\ {[}2,7,11,15{]}}, \texttt{target\ =\ 9}\\
Output: \texttt{{[}0,1{]}}\\
Explanation: Because \texttt{nums{[}0{]}\ +\ nums{[}1{]}\ ==\ 9}, we
return \texttt{{[}0,\ 1{]}}.

Example 2:

Input: \texttt{nums\ =\ {[}3,2,4{]}}, \texttt{target\ =\ 6}\\
Output: \texttt{{[}1,2{]}}\\

Example 3:

Input: \texttt{nums\ =\ {[}3,3{]}}, \texttt{target\ =\ 6}\\
Output: \texttt{{[}0,1{]}}\\

I saw this question on
\href{https://leetcode.com/problems/two-sum/description/}{LeetCode}.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ two\_sum(nums, target):}
    \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\BuiltInTok{len}\NormalTok{(nums)):}
        \ControlFlowTok{for}\NormalTok{ j }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(i):}
            \ControlFlowTok{if}\NormalTok{ nums[i] }\OperatorTok{+}\NormalTok{ nums[j] }\OperatorTok{==}\NormalTok{ target:}
                \ControlFlowTok{return}\NormalTok{ [j, i]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{two\_sum(nums }\OperatorTok{=}\NormalTok{ [}\DecValTok{2}\NormalTok{,}\DecValTok{7}\NormalTok{,}\DecValTok{11}\NormalTok{,}\DecValTok{15}\NormalTok{], target }\OperatorTok{=} \DecValTok{9}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0, 1]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{two\_sum(nums }\OperatorTok{=}\NormalTok{ [}\DecValTok{3}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{], target }\OperatorTok{=} \DecValTok{6}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{two\_sum(nums }\OperatorTok{=}\NormalTok{ [}\DecValTok{3}\NormalTok{,}\DecValTok{3}\NormalTok{], target }\OperatorTok{=} \DecValTok{6}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0, 1]
\end{verbatim}

We can write more efficient code once we learn other data structures in
chapter 3 of McKinney!

\subsection{Best Time}\label{best-time-1}

Write a function \texttt{best\_time} that solves the following.

You are given an array \texttt{prices} where \texttt{prices{[}i{]}} is
the price of a given stock on the \(i^{th}\) day.

You want to maximize your profit by choosing a single day to buy one
stock and choosing a different day in the future to sell that stock.

Return the maximum profit you can achieve from this transaction. If you
cannot achieve any profit, return 0.

Here are some examples:

Example 1:

Input: \texttt{prices\ =\ {[}7,1,5,3,6,4{]}}\\
Output: \texttt{5}\\
Explanation: Buy on day 2 (price = 1) and sell on day 5 (price = 6),
profit = 6-1 = 5. Note that buying on day 2 and selling on day 1 is not
allowed because you must buy before you sell.

Example 2:

Input: \texttt{prices\ =\ {[}7,6,4,3,1{]}}\\
Output: \texttt{0}\\
Explanation: In this case, no transactions are done and the max profit =
0.

I saw this question on
\href{https://leetcode.com/problems/best-time-to-buy-and-sell-stock/}{LeetCode}.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ max\_profit(prices):}
\NormalTok{        min\_price }\OperatorTok{=}\NormalTok{ prices[}\DecValTok{0}\NormalTok{]}
\NormalTok{        max\_profit }\OperatorTok{=} \DecValTok{0}
        \ControlFlowTok{for}\NormalTok{ price }\KeywordTok{in}\NormalTok{ prices:}
\NormalTok{            min\_price }\OperatorTok{=}\NormalTok{ price }\ControlFlowTok{if}\NormalTok{ price }\OperatorTok{\textless{}}\NormalTok{ min\_price }\ControlFlowTok{else}\NormalTok{ min\_price}
\NormalTok{            profit }\OperatorTok{=}\NormalTok{ price }\OperatorTok{{-}}\NormalTok{ min\_price}
\NormalTok{            max\_profit }\OperatorTok{=}\NormalTok{ profit }\ControlFlowTok{if}\NormalTok{ profit }\OperatorTok{\textgreater{}}\NormalTok{ max\_profit }\ControlFlowTok{else}\NormalTok{ max\_profit}
        \ControlFlowTok{return}\NormalTok{ max\_profit}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{max\_profit(prices}\OperatorTok{=}\NormalTok{[}\DecValTok{7}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{5}\NormalTok{,}\DecValTok{3}\NormalTok{,}\DecValTok{6}\NormalTok{,}\DecValTok{4}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{max\_profit(prices}\OperatorTok{=}\NormalTok{[}\DecValTok{7}\NormalTok{,}\DecValTok{6}\NormalTok{,}\DecValTok{4}\NormalTok{,}\DecValTok{3}\NormalTok{,}\DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0
\end{verbatim}

\chapter{McKinney Chapter 2 - Practice for Section
04}\label{mckinney-chapter-2---practice-for-section-04}

\section{Announcements}\label{announcements-2}

There are no due dates this week, but please take note of a few due
dates next week:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Before class on Tuesday, complete the week 2 pre-class quiz
\item
  By Friday 1/19 at 11:59 PM:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Acknowledge the academic integrity section of our syllabus
  \item
    Complete the first DataCamp course and upload your certificate
  \end{enumerate}
\end{enumerate}

\section{5-minute Recap}\label{minute-recap-2}

\subsection{First, Python variables are references to
objects.}\label{first-python-variables-are-references-to-objects.-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=}\NormalTok{ [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{]}

\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=}\NormalTok{ a}

\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3]
\end{verbatim}

\textbf{\emph{Python is zero-indexed!}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b[}\DecValTok{0}\NormalTok{] }\OperatorTok{=} \DecValTok{2\_001}

\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[2001, 2, 3]
\end{verbatim}

So both variables reflect changes to the referenced object.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[2001, 2, 3]
\end{verbatim}

Variables \texttt{a} and \texttt{b} are two names for the same list in
memory!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\KeywordTok{is}\NormalTok{ a}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

We can also reassign a new object, which does not change the original
object.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=} \StringTok{\textquotesingle{}Och\textquotesingle{}}

\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'Och'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[2001, 2, 3]
\end{verbatim}

\subsection{Second, we can define functions to re-use
code}\label{second-we-can-define-functions-to-re-use-code-2}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ square\_root(x):}
    \ControlFlowTok{return}\NormalTok{ x }\OperatorTok{**} \FloatTok{0.5}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{square\_root(}\DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2.0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{square\_root(}\DecValTok{9}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
3.0
\end{verbatim}

Note that white space is requried and not just cosmetic! Our
\texttt{square\_root()} function does not work without the white space!

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# def square\_root(x):}
\CommentTok{\# return x ** 0.5}
\CommentTok{\#   Cell In[26], line 2}
\CommentTok{\#     return x ** 0.5}
\CommentTok{\#     \^{}}
\CommentTok{\# IndentationError: expected an indented block after function definition on line 1}
\end{Highlighting}
\end{Shaded}

\subsection{\texorpdfstring{Third, \texttt{if-elif-else} blocks let us
conditionally run code
blocks}{Third, if-elif-else blocks let us conditionally run code blocks}}\label{third-if-elif-else-blocks-let-us-conditionally-run-code-blocks-2}

Again, note the white space is required and not just cosmetic.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OperatorTok{=} \DecValTok{5}
\ControlFlowTok{if}\NormalTok{ x }\OperatorTok{\textless{}} \DecValTok{0}\NormalTok{:}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{\}}\SpecialStringTok{ is negative\textquotesingle{}}\NormalTok{)}
\ControlFlowTok{elif}\NormalTok{ x }\OperatorTok{==} \DecValTok{0}\NormalTok{:}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{\}}\SpecialStringTok{ is zero\textquotesingle{}}\NormalTok{)}
\ControlFlowTok{else}\NormalTok{:}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{\}}\SpecialStringTok{ is positive\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
5 is positive
\end{verbatim}

\section{Practice}\label{practice-2}

\subsection{\texorpdfstring{Extract the year, month, and day from an
integer 8-digit date (i.e., YYYYMMDD format) using \texttt{//} (integer
division) and \texttt{\%} (modulo
division).}{Extract the year, month, and day from an integer 8-digit date (i.e., YYYYMMDD format) using // (integer division) and \% (modulo division).}}\label{extract-the-year-month-and-day-from-an-integer-8-digit-date-i.e.-yyyymmdd-format-using-integer-division-and-modulo-division.-2}

Try \texttt{20080915}.

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{1234} \OperatorTok{/} \DecValTok{100}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
12.34
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{1234} \OperatorTok{//} \DecValTok{100}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
12
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{1234} \OperatorTok{\%} \DecValTok{100}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
34
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{12} \OperatorTok{/} \DecValTok{5}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2.4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{12} \OperatorTok{//} \DecValTok{5}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{12} \OperatorTok{\%} \DecValTok{5}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lb\_collapse }\OperatorTok{=} \DecValTok{20080915}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lb\_collapse }\OperatorTok{//} \DecValTok{10\_000}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2008
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lb\_collapse }\OperatorTok{\%} \DecValTok{10\_000} \OperatorTok{//} \DecValTok{100}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
9
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lb\_collapse }\OperatorTok{\%} \DecValTok{100}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
15
\end{verbatim}

\subsection{\texorpdfstring{Use your answer above to write a function
\texttt{date} that accepts an integer 8-digit date argument and returns
a tuple of the year, month, and date (e.g.,
\texttt{return\ (year,\ month,\ day)}).}{Use your answer above to write a function date that accepts an integer 8-digit date argument and returns a tuple of the year, month, and date (e.g., return (year, month, day)).}}\label{use-your-answer-above-to-write-a-function-date-that-accepts-an-integer-8-digit-date-argument-and-returns-a-tuple-of-the-year-month-and-date-e.g.-return-year-month-day.}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ date(ymd):}
\NormalTok{    year }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{//} \DecValTok{10\_000}
\NormalTok{    month }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{\%} \DecValTok{10\_000} \OperatorTok{//} \DecValTok{100}
\NormalTok{    day }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{\%} \DecValTok{100}
    \ControlFlowTok{return}\NormalTok{ (year, month, day)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{date(lb\_collapse)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(2008, 9, 15)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{date(}\DecValTok{20240112}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(2024, 1, 12)
\end{verbatim}

\subsection{\texorpdfstring{Rewrite \texttt{date} to accept an 8-digit
date as an integer or
string.}{Rewrite date to accept an 8-digit date as an integer or string.}}\label{rewrite-date-to-accept-an-8-digit-date-as-an-integer-or-string.-2}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ date\_2(ymd):}
    \ControlFlowTok{if} \BuiltInTok{type}\NormalTok{(ymd) }\KeywordTok{is} \BuiltInTok{str}\NormalTok{:}
\NormalTok{        ymd }\OperatorTok{=} \BuiltInTok{int}\NormalTok{(ymd)}
\NormalTok{    year }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{//} \DecValTok{10\_000}
\NormalTok{    month }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{\%} \DecValTok{10\_000} \OperatorTok{//} \DecValTok{100}
\NormalTok{    day }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{\%} \DecValTok{100}
    \ControlFlowTok{return}\NormalTok{ (year, month, day)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{date\_2(}\StringTok{\textquotesingle{}20080915\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(2008, 9, 15)
\end{verbatim}

\subsection{\texorpdfstring{Finally, rewrite \texttt{date} to accept a
list of 8-digit dates as integers or
strings.}{Finally, rewrite date to accept a list of 8-digit dates as integers or strings.}}\label{finally-rewrite-date-to-accept-a-list-of-8-digit-dates-as-integers-or-strings.-2}

Return a list of tuples of year, month, and date.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ymds }\OperatorTok{=}\NormalTok{ [}\DecValTok{20080915}\NormalTok{, }\StringTok{\textquotesingle{}20080916\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ date\_3(ymds):}
\NormalTok{    dates }\OperatorTok{=}\NormalTok{ []}
    \ControlFlowTok{for}\NormalTok{ ymd }\KeywordTok{in}\NormalTok{ ymds:}
        \ControlFlowTok{if} \BuiltInTok{type}\NormalTok{(ymd) }\KeywordTok{is} \BuiltInTok{str}\NormalTok{:}
\NormalTok{            ymd }\OperatorTok{=} \BuiltInTok{int}\NormalTok{(ymd)}
\NormalTok{        year }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{//} \DecValTok{10\_000}
\NormalTok{        month }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{\%} \DecValTok{10\_000} \OperatorTok{//} \DecValTok{100}
\NormalTok{        day }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{\%} \DecValTok{100}
\NormalTok{        dates.append((year, month, day))}
    \ControlFlowTok{return}\NormalTok{ dates}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{date\_3(ymds)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[(2008, 9, 15), (2008, 9, 16)]
\end{verbatim}

\subsection{Write a for loop that prints the squares of integers from 1
to
10.}\label{write-a-for-loop-that-prints-the-squares-of-integers-from-1-to-10.-2}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{11}\NormalTok{):}
    \BuiltInTok{print}\NormalTok{(i}\OperatorTok{**}\DecValTok{2}\NormalTok{, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1 4 9 16 25 36 49 64 81 100 
\end{verbatim}

Above, I change the \texttt{end} argument to a space to shorten the
output.

\subsection{\texorpdfstring{Write a for loop that prints the squares of
\emph{even} integers from 1 to
10.}{Write a for loop that prints the squares of even integers from 1 to 10.}}\label{write-a-for-loop-that-prints-the-squares-of-even-integers-from-1-to-10.-2}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{11}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ i}\OperatorTok{\%}\DecValTok{2} \OperatorTok{==} \DecValTok{0}\NormalTok{:}
        \BuiltInTok{print}\NormalTok{(i}\OperatorTok{**}\DecValTok{2}\NormalTok{, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
4 16 36 64 100 
\end{verbatim}

We can also change the arguments to \texttt{range()} to start at 2 and
take steps of 2!

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{2}\NormalTok{, }\DecValTok{11}\NormalTok{, }\DecValTok{2}\NormalTok{):}
    \BuiltInTok{print}\NormalTok{(i}\OperatorTok{**}\DecValTok{2}\NormalTok{, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
4 16 36 64 100 
\end{verbatim}

\subsection{Write a for loop that sums the squares of integers from 1 to
10.}\label{write-a-for-loop-that-sums-the-squares-of-integers-from-1-to-10.-2}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{sum} \OperatorTok{=} \DecValTok{0}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{11}\NormalTok{):}
    \BuiltInTok{sum} \OperatorTok{=} \BuiltInTok{sum} \OperatorTok{+}\NormalTok{ i}\OperatorTok{**}\DecValTok{2}

\BuiltInTok{sum}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
385
\end{verbatim}

We can replace the \texttt{sum\ =\ sum\ +\ i**2} with
\texttt{sum\ +=\ i**2}.

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{sum} \OperatorTok{=} \DecValTok{0}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{11}\NormalTok{):}
    \BuiltInTok{sum} \OperatorTok{+=}\NormalTok{ i}\OperatorTok{**}\DecValTok{2}

\BuiltInTok{sum}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
385
\end{verbatim}

There are also \texttt{-=}, \texttt{*=}, and \texttt{/=} operators.

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{sum} \OperatorTok{=} \DecValTok{1}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{11}\NormalTok{):}
    \BuiltInTok{sum} \OperatorTok{*=}\NormalTok{ i}\OperatorTok{**}\DecValTok{2}
    
\BuiltInTok{sum}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
13168189440000
\end{verbatim}

\subsection{Write a for loop that sums the squares of integers from 1 to
10 but stops before the sum exceeds
50.}\label{write-a-for-loop-that-sums-the-squares-of-integers-from-1-to-10-but-stops-before-the-sum-exceeds-50.-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total }\OperatorTok{=} \DecValTok{0}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{11}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ (total }\OperatorTok{+}\NormalTok{ i}\OperatorTok{**}\DecValTok{2}\NormalTok{) }\OperatorTok{\textgreater{}} \DecValTok{50}\NormalTok{:}
        \ControlFlowTok{break}
\NormalTok{    total }\OperatorTok{+=}\NormalTok{ i}\OperatorTok{**}\DecValTok{2}

\NormalTok{total}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
30
\end{verbatim}

\subsection{FizzBuzz}\label{fizzbuzz-2}

Write a for loop that prints the numbers from 1 to 100. For multiples of
three print ``Fizz'' instead of the number. For multiples of five print
``Buzz''. For numbers that are multiples of both three and five print
``FizzBuzz''. More
\href{https://blog.codinghorror.com/why-cant-programmers-program/}{here}.

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{101}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ (i}\OperatorTok{\%}\DecValTok{3} \OperatorTok{==} \DecValTok{0}\NormalTok{) }\KeywordTok{and}\NormalTok{ (i}\OperatorTok{\%}\DecValTok{5} \OperatorTok{==} \DecValTok{0}\NormalTok{):}
        \BuiltInTok{print}\NormalTok{(}\StringTok{\textquotesingle{}FizzBuzz\textquotesingle{}}\NormalTok{, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
    \ControlFlowTok{elif}\NormalTok{ i}\OperatorTok{\%}\DecValTok{3} \OperatorTok{==} \DecValTok{0}\NormalTok{:}
        \BuiltInTok{print}\NormalTok{(}\StringTok{\textquotesingle{}Fizz\textquotesingle{}}\NormalTok{, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
    \ControlFlowTok{elif}\NormalTok{ i}\OperatorTok{\%}\DecValTok{5} \OperatorTok{==} \DecValTok{0}\NormalTok{:}
        \BuiltInTok{print}\NormalTok{(}\StringTok{\textquotesingle{}Buzz\textquotesingle{}}\NormalTok{, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
    \ControlFlowTok{else}\NormalTok{:}
        \BuiltInTok{print}\NormalTok{(i, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1 2 Fizz 4 Buzz Fizz 7 8 Fizz Buzz 11 Fizz 13 14 FizzBuzz 16 17 Fizz 19 Buzz Fizz 22 23 Fizz Buzz 26 Fizz 28 29 FizzBuzz 31 32 Fizz 34 Buzz Fizz 37 38 Fizz Buzz 41 Fizz 43 44 FizzBuzz 46 47 Fizz 49 Buzz Fizz 52 53 Fizz Buzz 56 Fizz 58 59 FizzBuzz 61 62 Fizz 64 Buzz Fizz 67 68 Fizz Buzz 71 Fizz 73 74 FizzBuzz 76 77 Fizz 79 Buzz Fizz 82 83 Fizz Buzz 86 Fizz 88 89 FizzBuzz 91 92 Fizz 94 Buzz Fizz 97 98 Fizz Buzz 
\end{verbatim}

\subsection{Use ternary expressions to make your FizzBuzz code more
compact.}\label{use-ternary-expressions-to-make-your-fizzbuzz-code-more-compact.-2}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}Fizz\textquotesingle{}} \OperatorTok{+} \StringTok{\textquotesingle{}Buzz\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'FizzBuzz'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}Fizz\textquotesingle{}} \OperatorTok{+} \StringTok{\textquotesingle{}Fizz\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'FizzFizz'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}Fizz\textquotesingle{}} \OperatorTok{*} \DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'FizzFizz'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}Fizz\textquotesingle{}} \OperatorTok{*} \DecValTok{0}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
''
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}Fizz\textquotesingle{}}\OperatorTok{*}\VariableTok{True} \OperatorTok{+} \StringTok{\textquotesingle{}Buzz\textquotesingle{}}\OperatorTok{*}\VariableTok{True}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'FizzBuzz'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{101}\NormalTok{):}
    \BuiltInTok{print}\NormalTok{(}\StringTok{\textquotesingle{}Fizz\textquotesingle{}}\OperatorTok{*}\NormalTok{(i}\OperatorTok{\%}\DecValTok{3}\OperatorTok{==}\DecValTok{0}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}Buzz\textquotesingle{}}\OperatorTok{*}\NormalTok{(i}\OperatorTok{\%}\DecValTok{5}\OperatorTok{==}\DecValTok{0}\NormalTok{) }\ControlFlowTok{if}\NormalTok{ (i}\OperatorTok{\%}\DecValTok{3}\OperatorTok{==}\DecValTok{0}\NormalTok{) }\KeywordTok{or}\NormalTok{ (i}\OperatorTok{\%}\DecValTok{5}\OperatorTok{==}\DecValTok{0}\NormalTok{) }\ControlFlowTok{else}\NormalTok{ i, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1 2 Fizz 4 Buzz Fizz 7 8 Fizz Buzz 11 Fizz 13 14 FizzBuzz 16 17 Fizz 19 Buzz Fizz 22 23 Fizz Buzz 26 Fizz 28 29 FizzBuzz 31 32 Fizz 34 Buzz Fizz 37 38 Fizz Buzz 41 Fizz 43 44 FizzBuzz 46 47 Fizz 49 Buzz Fizz 52 53 Fizz Buzz 56 Fizz 58 59 FizzBuzz 61 62 Fizz 64 Buzz Fizz 67 68 Fizz Buzz 71 Fizz 73 74 FizzBuzz 76 77 Fizz 79 Buzz Fizz 82 83 Fizz Buzz 86 Fizz 88 89 FizzBuzz 91 92 Fizz 94 Buzz Fizz 97 98 Fizz Buzz 
\end{verbatim}

The solution above is shorter and uses from neat tricks, but I consider
the previous solution easier to read and troubleshoot. The solution
above uses the trick that we can multiply a string by \texttt{True} or
\texttt{False} to return the string itself or an empty string.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}Hey!\textquotesingle{}}\OperatorTok{*}\VariableTok{True}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'Hey!'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}Hey!\textquotesingle{}}\OperatorTok{*}\VariableTok{False}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
''
\end{verbatim}

Someone pointed out an even shorter solution with \texttt{or}!

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{101}\NormalTok{):}
    \BuiltInTok{print}\NormalTok{(}\StringTok{\textquotesingle{}Fizz\textquotesingle{}}\OperatorTok{*}\NormalTok{(i}\OperatorTok{\%}\DecValTok{3}\OperatorTok{==}\DecValTok{0}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}Buzz\textquotesingle{}}\OperatorTok{*}\NormalTok{(i}\OperatorTok{\%}\DecValTok{5}\OperatorTok{==}\DecValTok{0}\NormalTok{) }\KeywordTok{or}\NormalTok{ i, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1 2 Fizz 4 Buzz Fizz 7 8 Fizz Buzz 11 Fizz 13 14 FizzBuzz 16 17 Fizz 19 Buzz Fizz 22 23 Fizz Buzz 26 Fizz 28 29 FizzBuzz 31 32 Fizz 34 Buzz Fizz 37 38 Fizz Buzz 41 Fizz 43 44 FizzBuzz 46 47 Fizz 49 Buzz Fizz 52 53 Fizz Buzz 56 Fizz 58 59 FizzBuzz 61 62 Fizz 64 Buzz Fizz 67 68 Fizz Buzz 71 Fizz 73 74 FizzBuzz 76 77 Fizz 79 Buzz Fizz 82 83 Fizz Buzz 86 Fizz 88 89 FizzBuzz 91 92 Fizz 94 Buzz Fizz 97 98 Fizz Buzz 
\end{verbatim}

\subsection{Triangle}\label{triangle-2}

Write a function \texttt{triangle} that accepts a positive integer \(N\)
and prints a numerical triangle of height \(N-1\). For example,
\texttt{triangle(N=6)} should print:

\begin{verbatim}
1
22
333
4444
55555
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ triangle(N):}
    \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, N):}
        \BuiltInTok{print}\NormalTok{(}\BuiltInTok{str}\NormalTok{(i) }\OperatorTok{*}\NormalTok{ i)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{triangle(}\DecValTok{6}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1
22
333
4444
55555
\end{verbatim}

The solution above works because a multiplying a string by \texttt{i}
concatenates \texttt{i} copies of the string.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}Test\textquotesingle{}} \OperatorTok{+} \StringTok{\textquotesingle{}Test\textquotesingle{}} \OperatorTok{+} \StringTok{\textquotesingle{}Test\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'TestTestTest'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}Test\textquotesingle{}} \OperatorTok{*} \DecValTok{3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'TestTestTest'
\end{verbatim}

\subsection{Two Sum}\label{two-sum-2}

Write a function \texttt{two\_sum} that does the following.

Given an array of integers \texttt{nums}~and an integer \texttt{target},
return the indices of the two numbers that add up to target.

You may assume that each input would have exactly one solution, and you
may not use the same element twice.

You can return the answer in any order.

Here are some examples:

Example 1:

Input: \texttt{nums\ =\ {[}2,7,11,15{]}}, \texttt{target\ =\ 9}\\
Output: \texttt{{[}0,1{]}}\\
Explanation: Because \texttt{nums{[}0{]}\ +\ nums{[}1{]}\ ==\ 9}, we
return \texttt{{[}0,\ 1{]}}.

Example 2:

Input: \texttt{nums\ =\ {[}3,2,4{]}}, \texttt{target\ =\ 6}\\
Output: \texttt{{[}1,2{]}}\\

Example 3:

Input: \texttt{nums\ =\ {[}3,3{]}}, \texttt{target\ =\ 6}\\
Output: \texttt{{[}0,1{]}}\\

I saw this question on
\href{https://leetcode.com/problems/two-sum/description/}{LeetCode}.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ two\_sum(nums, target):}
    \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\BuiltInTok{len}\NormalTok{(nums)):}
        \ControlFlowTok{for}\NormalTok{ j }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(i):}
            \ControlFlowTok{if}\NormalTok{ nums[i] }\OperatorTok{+}\NormalTok{ nums[j] }\OperatorTok{==}\NormalTok{ target:}
                \ControlFlowTok{return}\NormalTok{ [j, i]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{two\_sum(nums }\OperatorTok{=}\NormalTok{ [}\DecValTok{2}\NormalTok{,}\DecValTok{7}\NormalTok{,}\DecValTok{11}\NormalTok{,}\DecValTok{15}\NormalTok{], target }\OperatorTok{=} \DecValTok{9}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0, 1]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{two\_sum(nums }\OperatorTok{=}\NormalTok{ [}\DecValTok{3}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{], target }\OperatorTok{=} \DecValTok{6}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{two\_sum(nums }\OperatorTok{=}\NormalTok{ [}\DecValTok{3}\NormalTok{,}\DecValTok{3}\NormalTok{], target }\OperatorTok{=} \DecValTok{6}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0, 1]
\end{verbatim}

We can write more efficient code once we learn other data structures in
chapter 3 of McKinney!

\subsection{Best Time}\label{best-time-2}

Write a function \texttt{best\_time} that solves the following.

You are given an array \texttt{prices} where \texttt{prices{[}i{]}} is
the price of a given stock on the \(i^{th}\) day.

You want to maximize your profit by choosing a single day to buy one
stock and choosing a different day in the future to sell that stock.

Return the maximum profit you can achieve from this transaction. If you
cannot achieve any profit, return 0.

Here are some examples:

Example 1:

Input: \texttt{prices\ =\ {[}7,1,5,3,6,4{]}}\\
Output: \texttt{5}\\
Explanation: Buy on day 2 (price = 1) and sell on day 5 (price = 6),
profit = 6-1 = 5. Note that buying on day 2 and selling on day 1 is not
allowed because you must buy before you sell.

Example 2:

Input: \texttt{prices\ =\ {[}7,6,4,3,1{]}}\\
Output: \texttt{0}\\
Explanation: In this case, no transactions are done and the max profit =
0.

I saw this question on
\href{https://leetcode.com/problems/best-time-to-buy-and-sell-stock/}{LeetCode}.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ max\_profit(prices):}
\NormalTok{        min\_price }\OperatorTok{=}\NormalTok{ prices[}\DecValTok{0}\NormalTok{]}
\NormalTok{        max\_profit }\OperatorTok{=} \DecValTok{0}
        \ControlFlowTok{for}\NormalTok{ price }\KeywordTok{in}\NormalTok{ prices:}
\NormalTok{            min\_price }\OperatorTok{=}\NormalTok{ price }\ControlFlowTok{if}\NormalTok{ price }\OperatorTok{\textless{}}\NormalTok{ min\_price }\ControlFlowTok{else}\NormalTok{ min\_price}
\NormalTok{            profit }\OperatorTok{=}\NormalTok{ price }\OperatorTok{{-}}\NormalTok{ min\_price}
\NormalTok{            max\_profit }\OperatorTok{=}\NormalTok{ profit }\ControlFlowTok{if}\NormalTok{ profit }\OperatorTok{\textgreater{}}\NormalTok{ max\_profit }\ControlFlowTok{else}\NormalTok{ max\_profit}
        \ControlFlowTok{return}\NormalTok{ max\_profit}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{max\_profit(prices}\OperatorTok{=}\NormalTok{[}\DecValTok{7}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{5}\NormalTok{,}\DecValTok{3}\NormalTok{,}\DecValTok{6}\NormalTok{,}\DecValTok{4}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{max\_profit(prices}\OperatorTok{=}\NormalTok{[}\DecValTok{7}\NormalTok{,}\DecValTok{6}\NormalTok{,}\DecValTok{4}\NormalTok{,}\DecValTok{3}\NormalTok{,}\DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0
\end{verbatim}

\chapter{McKinney Chapter 2 - Practice for Section
05}\label{mckinney-chapter-2---practice-for-section-05}

\section{Announcements}\label{announcements-3}

There are no due dates this week, but please take note of a few due
dates next week:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Before class on Tuesday, complete the week 2 pre-class quiz
\item
  By Friday 1/19 at 11:59 PM:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Acknowledge the academic integrity section of our syllabus
  \item
    Complete the first DataCamp course and upload your certificate
  \end{enumerate}
\end{enumerate}

\section{5-Minutes Recap}\label{minutes-recap}

\subsection{First, Python variables are references to
objects.}\label{first-python-variables-are-references-to-objects.-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=}\NormalTok{ [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{]}
\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3]
\end{verbatim}

Two (or more) variables can refer to the same object.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=}\NormalTok{ a}
\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3]
\end{verbatim}

\textbf{\emph{Remember, Python is zero-indexed!}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b[}\DecValTok{0}\NormalTok{] }\OperatorTok{=} \DecValTok{2001}
\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[2001, 2, 3]
\end{verbatim}

So both variables reflect changes to the referenced object.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[2001, 2, 3]
\end{verbatim}

We can also reassign a new object, which does not change the original
object.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=} \StringTok{\textquotesingle{}W.T. Door\textquotesingle{}}
\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'W.T. Door'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[2001, 2, 3]
\end{verbatim}

\subsection{Second, we can define functions to re-use
code}\label{second-we-can-define-functions-to-re-use-code-3}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ square\_root(x):}
    \ControlFlowTok{return}\NormalTok{ x }\OperatorTok{**} \FloatTok{0.5}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{square\_root(}\DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2.0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{square\_root(}\DecValTok{9}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
3.0
\end{verbatim}

Note that white space is requried and not just cosmetic! Our
\texttt{square\_root()} function does not work without the white space!

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# def square\_root(x):}
\CommentTok{\# return x ** 0.5}
\CommentTok{\#   Cell In[26], line 2}
\CommentTok{\#     return x ** 0.5}
\CommentTok{\#     \^{}}
\CommentTok{\# IndentationError: expected an indented block after function definition on line 1}
\end{Highlighting}
\end{Shaded}

\subsection{\texorpdfstring{Third, \texttt{if-elif-else} blocks let us
conditionally run code
blocks}{Third, if-elif-else blocks let us conditionally run code blocks}}\label{third-if-elif-else-blocks-let-us-conditionally-run-code-blocks-3}

Again, note the white space is required and not just cosmetic.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OperatorTok{=} \DecValTok{5}
\ControlFlowTok{if}\NormalTok{ x }\OperatorTok{\textless{}} \DecValTok{0}\NormalTok{:}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{\}}\SpecialStringTok{ is negative\textquotesingle{}}\NormalTok{)}
\ControlFlowTok{elif}\NormalTok{ x }\OperatorTok{==} \DecValTok{0}\NormalTok{:}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{\}}\SpecialStringTok{ is zero\textquotesingle{}}\NormalTok{)}
\ControlFlowTok{else}\NormalTok{:}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{\}}\SpecialStringTok{ is positive\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
5 is positive
\end{verbatim}

\section{Practice}\label{practice-3}

\subsection{\texorpdfstring{Extract the year, month, and day from an
integer 8-digit date (i.e., YYYYMMDD format) using \texttt{//} (integer
division) and \texttt{\%} (modulo
division).}{Extract the year, month, and day from an integer 8-digit date (i.e., YYYYMMDD format) using // (integer division) and \% (modulo division).}}\label{extract-the-year-month-and-day-from-an-integer-8-digit-date-i.e.-yyyymmdd-format-using-integer-division-and-modulo-division.-3}

Try \texttt{20080915}.

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{1234} \OperatorTok{/} \DecValTok{100}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
12.34
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{1234} \OperatorTok{//} \DecValTok{100}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
12
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{1234} \OperatorTok{\%} \DecValTok{100}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
34
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lb\_collapse }\OperatorTok{=} \DecValTok{20080915}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lb\_collapse }\OperatorTok{//} \DecValTok{10\_000}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2008
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lb\_collapse }\OperatorTok{\%} \DecValTok{10\_000} \OperatorTok{//} \DecValTok{100}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
9
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lb\_collapse }\OperatorTok{\%} \DecValTok{100}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
15
\end{verbatim}

\subsection{\texorpdfstring{Use your answer above to write a function
\texttt{date} that accepts an integer 8-digit date argument and returns
a tuple of the year, month, and date (e.g.,
\texttt{return\ (year,\ month,\ date)}).}{Use your answer above to write a function date that accepts an integer 8-digit date argument and returns a tuple of the year, month, and date (e.g., return (year, month, date)).}}\label{use-your-answer-above-to-write-a-function-date-that-accepts-an-integer-8-digit-date-argument-and-returns-a-tuple-of-the-year-month-and-date-e.g.-return-year-month-date.-2}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ date(ymd):}
\NormalTok{    year }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{//} \DecValTok{10\_000}
\NormalTok{    month }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{\%} \DecValTok{10\_000} \OperatorTok{//} \DecValTok{100}
\NormalTok{    day }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{\%} \DecValTok{100}
    \ControlFlowTok{return}\NormalTok{ (year, month, day)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{date(lb\_collapse)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(2008, 9, 15)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{date(}\DecValTok{20240112}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(2024, 1, 12)
\end{verbatim}

\subsection{\texorpdfstring{Rewrite \texttt{date} to accept an 8-digit
date as an integer or
string.}{Rewrite date to accept an 8-digit date as an integer or string.}}\label{rewrite-date-to-accept-an-8-digit-date-as-an-integer-or-string.-3}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ date\_2(ymd):}
    \ControlFlowTok{if} \BuiltInTok{type}\NormalTok{(ymd) }\KeywordTok{is} \BuiltInTok{str}\NormalTok{:}
\NormalTok{        ymd }\OperatorTok{=} \BuiltInTok{int}\NormalTok{(ymd)}
\NormalTok{    year }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{//} \DecValTok{10\_000}
\NormalTok{    month }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{\%} \DecValTok{10\_000} \OperatorTok{//} \DecValTok{100}
\NormalTok{    day }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{\%} \DecValTok{100}
    \ControlFlowTok{return}\NormalTok{ (year, month, day)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{date\_2(}\StringTok{\textquotesingle{}20090915\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(2009, 9, 15)
\end{verbatim}

\subsection{\texorpdfstring{Finally, rewrite \texttt{date} to accept a
list of 8-digit dates as integers or
strings.}{Finally, rewrite date to accept a list of 8-digit dates as integers or strings.}}\label{finally-rewrite-date-to-accept-a-list-of-8-digit-dates-as-integers-or-strings.-3}

Return a list of tuples of year, month, and date.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ymds }\OperatorTok{=}\NormalTok{ [}\DecValTok{20080915}\NormalTok{, }\StringTok{\textquotesingle{}20080916\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ date\_3(ymds):}
\NormalTok{    dates }\OperatorTok{=}\NormalTok{ []}
    \ControlFlowTok{for}\NormalTok{ ymd }\KeywordTok{in}\NormalTok{ ymds:}
        \ControlFlowTok{if} \BuiltInTok{type}\NormalTok{(ymd) }\KeywordTok{is} \BuiltInTok{str}\NormalTok{:}
\NormalTok{            ymd }\OperatorTok{=} \BuiltInTok{int}\NormalTok{(ymd)}
\NormalTok{        year }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{//} \DecValTok{10\_000}
\NormalTok{        month }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{\%} \DecValTok{10\_000} \OperatorTok{//} \DecValTok{100}
\NormalTok{        day }\OperatorTok{=}\NormalTok{ ymd }\OperatorTok{\%} \DecValTok{100}
\NormalTok{        dates.append((year, month, day))}
    \ControlFlowTok{return}\NormalTok{ dates}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{date\_3(ymds)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[(2008, 9, 15), (2008, 9, 16)]
\end{verbatim}

\subsection{Write a for loop that prints the squares of integers from 1
to
10.}\label{write-a-for-loop-that-prints-the-squares-of-integers-from-1-to-10.-3}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{11}\NormalTok{):}
    \BuiltInTok{print}\NormalTok{(i}\OperatorTok{**}\DecValTok{2}\NormalTok{, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1 4 9 16 25 36 49 64 81 100 
\end{verbatim}

Above, I change the \texttt{end} argument to a space to shorten the
output.

\subsection{\texorpdfstring{Write a for loop that prints the squares of
\emph{even} integers from 1 to
10.}{Write a for loop that prints the squares of even integers from 1 to 10.}}\label{write-a-for-loop-that-prints-the-squares-of-even-integers-from-1-to-10.-3}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{11}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ i }\OperatorTok{\%} \DecValTok{2} \OperatorTok{==} \DecValTok{0}\NormalTok{:}
        \BuiltInTok{print}\NormalTok{(i}\OperatorTok{**}\DecValTok{2}\NormalTok{, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
4 16 36 64 100 
\end{verbatim}

\subsection{Write a for loop that sums the squares of integers from 1 to
10.}\label{write-a-for-loop-that-sums-the-squares-of-integers-from-1-to-10.-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total }\OperatorTok{=} \DecValTok{0}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{11}\NormalTok{):}
\NormalTok{    total }\OperatorTok{+=}\NormalTok{ i}\OperatorTok{**}\DecValTok{2}

\NormalTok{total}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
385
\end{verbatim}

\subsection{Write a for loop that sums the squares of integers from 1 to
10 but stops before the sum exceeds
50.}\label{write-a-for-loop-that-sums-the-squares-of-integers-from-1-to-10-but-stops-before-the-sum-exceeds-50.-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total }\OperatorTok{=} \DecValTok{0}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{11}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ (total }\OperatorTok{+}\NormalTok{ i}\OperatorTok{**}\DecValTok{2}\NormalTok{) }\OperatorTok{\textgreater{}} \DecValTok{50}\NormalTok{:}
        \ControlFlowTok{break}
\NormalTok{    total }\OperatorTok{+=}\NormalTok{ i}\OperatorTok{**}\DecValTok{2}

\NormalTok{total}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
30
\end{verbatim}

\subsection{FizzBuzz}\label{fizzbuzz-3}

Write a for loop that prints the numbers from 1 to 100. For multiples of
three print ``Fizz'' instead of the number. For multiples of five print
``Buzz''. For numbers that are multiples of both three and five print
``FizzBuzz''. More
\href{https://blog.codinghorror.com/why-cant-programmers-program/}{here}.

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{101}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ (i}\OperatorTok{\%}\DecValTok{3} \OperatorTok{==} \DecValTok{0}\NormalTok{) }\OperatorTok{\&}\NormalTok{ (i}\OperatorTok{\%}\DecValTok{5} \OperatorTok{==} \DecValTok{0}\NormalTok{):}
        \BuiltInTok{print}\NormalTok{(}\StringTok{\textquotesingle{}FizzBuzz\textquotesingle{}}\NormalTok{, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
    \ControlFlowTok{elif}\NormalTok{ i}\OperatorTok{\%}\DecValTok{3} \OperatorTok{==} \DecValTok{0}\NormalTok{:}
        \BuiltInTok{print}\NormalTok{(}\StringTok{\textquotesingle{}Fizz\textquotesingle{}}\NormalTok{, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
    \ControlFlowTok{elif}\NormalTok{ i}\OperatorTok{\%}\DecValTok{5} \OperatorTok{==} \DecValTok{0}\NormalTok{:}
        \BuiltInTok{print}\NormalTok{(}\StringTok{\textquotesingle{}Buzz\textquotesingle{}}\NormalTok{, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
    \ControlFlowTok{else}\NormalTok{:}
        \BuiltInTok{print}\NormalTok{(i, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1 2 Fizz 4 Buzz Fizz 7 8 Fizz Buzz 11 Fizz 13 14 FizzBuzz 16 17 Fizz 19 Buzz Fizz 22 23 Fizz Buzz 26 Fizz 28 29 FizzBuzz 31 32 Fizz 34 Buzz Fizz 37 38 Fizz Buzz 41 Fizz 43 44 FizzBuzz 46 47 Fizz 49 Buzz Fizz 52 53 Fizz Buzz 56 Fizz 58 59 FizzBuzz 61 62 Fizz 64 Buzz Fizz 67 68 Fizz Buzz 71 Fizz 73 74 FizzBuzz 76 77 Fizz 79 Buzz Fizz 82 83 Fizz Buzz 86 Fizz 88 89 FizzBuzz 91 92 Fizz 94 Buzz Fizz 97 98 Fizz Buzz 
\end{verbatim}

\subsection{Use ternary expressions to make your FizzBuzz code more
compact.}\label{use-ternary-expressions-to-make-your-fizzbuzz-code-more-compact.-3}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{101}\NormalTok{):}
    \BuiltInTok{print}\NormalTok{(}\StringTok{\textquotesingle{}Fizz\textquotesingle{}}\OperatorTok{*}\NormalTok{(i}\OperatorTok{\%}\DecValTok{3}\OperatorTok{==}\DecValTok{0}\NormalTok{) }\OperatorTok{+} \StringTok{\textquotesingle{}Buzz\textquotesingle{}}\OperatorTok{*}\NormalTok{(i}\OperatorTok{\%}\DecValTok{5}\OperatorTok{==}\DecValTok{0}\NormalTok{) }\ControlFlowTok{if}\NormalTok{ (i}\OperatorTok{\%}\DecValTok{3}\OperatorTok{==}\DecValTok{0}\NormalTok{) }\KeywordTok{or}\NormalTok{ (i}\OperatorTok{\%}\DecValTok{5}\OperatorTok{==}\DecValTok{0}\NormalTok{) }\ControlFlowTok{else}\NormalTok{ i, end}\OperatorTok{=}\StringTok{\textquotesingle{} \textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1 2 Fizz 4 Buzz Fizz 7 8 Fizz Buzz 11 Fizz 13 14 FizzBuzz 16 17 Fizz 19 Buzz Fizz 22 23 Fizz Buzz 26 Fizz 28 29 FizzBuzz 31 32 Fizz 34 Buzz Fizz 37 38 Fizz Buzz 41 Fizz 43 44 FizzBuzz 46 47 Fizz 49 Buzz Fizz 52 53 Fizz Buzz 56 Fizz 58 59 FizzBuzz 61 62 Fizz 64 Buzz Fizz 67 68 Fizz Buzz 71 Fizz 73 74 FizzBuzz 76 77 Fizz 79 Buzz Fizz 82 83 Fizz Buzz 86 Fizz 88 89 FizzBuzz 91 92 Fizz 94 Buzz Fizz 97 98 Fizz Buzz 
\end{verbatim}

The solution above is shorter and uses from neat tricks, but I consider
the previous solution easier to read and troubleshoot. The solution
above uses the trick that we can multiply a string by \texttt{True} or
\texttt{False} to return the string itself or an empty string.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}Hey!\textquotesingle{}}\OperatorTok{*}\VariableTok{True}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'Hey!'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}Hey!\textquotesingle{}}\OperatorTok{*}\VariableTok{False}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
''
\end{verbatim}

\subsection{Triangle}\label{triangle-3}

Write a function \texttt{triangle} that accepts a positive integer \(N\)
and prints a numerical triangle of height \(N-1\). For example,
\texttt{triangle(N=6)} should print:

\begin{verbatim}
1
22
333
4444
55555
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ triangle(N):}
    \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, N):}
        \BuiltInTok{print}\NormalTok{(}\BuiltInTok{str}\NormalTok{(i) }\OperatorTok{*}\NormalTok{ i)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{triangle(}\DecValTok{6}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1
22
333
4444
55555
\end{verbatim}

The solution above works because a multiplying a string by \texttt{i}
concatenates \texttt{i} copies of the string.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}Test\textquotesingle{}} \OperatorTok{+} \StringTok{\textquotesingle{}Test\textquotesingle{}} \OperatorTok{+} \StringTok{\textquotesingle{}Test\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'TestTestTest'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}Test\textquotesingle{}} \OperatorTok{*} \DecValTok{3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'TestTestTest'
\end{verbatim}

\subsection{Two Sum}\label{two-sum-3}

Write a function \texttt{two\_sum} that does the following.

Given an array of integers \texttt{nums}~and an integer \texttt{target},
return the indices of the two numbers that add up to target.

You may assume that each input would have exactly one solution, and you
may not use the same element twice.

You can return the answer in any order.

Here are some examples:

Example 1:

Input: \texttt{nums\ =\ {[}2,7,11,15{]}}, \texttt{target\ =\ 9}\\
Output: \texttt{{[}0,1{]}}\\
Explanation: Because \texttt{nums{[}0{]}\ +\ nums{[}1{]}\ ==\ 9}, we
return \texttt{{[}0,\ 1{]}}.

Example 2:

Input: \texttt{nums\ =\ {[}3,2,4{]}}, \texttt{target\ =\ 6}\\
Output: \texttt{{[}1,2{]}}\\

Example 3:

Input: \texttt{nums\ =\ {[}3,3{]}}, \texttt{target\ =\ 6}\\
Output: \texttt{{[}0,1{]}}\\

I saw this question on
\href{https://leetcode.com/problems/two-sum/description/}{LeetCode}.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ two\_sum(nums, target):}
    \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\BuiltInTok{len}\NormalTok{(nums)):}
        \ControlFlowTok{for}\NormalTok{ j }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(i):}
            \ControlFlowTok{if}\NormalTok{ nums[i] }\OperatorTok{+}\NormalTok{ nums[j] }\OperatorTok{==}\NormalTok{ target:}
                \ControlFlowTok{return}\NormalTok{ [j, i]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{two\_sum(nums }\OperatorTok{=}\NormalTok{ [}\DecValTok{2}\NormalTok{,}\DecValTok{7}\NormalTok{,}\DecValTok{11}\NormalTok{,}\DecValTok{15}\NormalTok{], target }\OperatorTok{=} \DecValTok{9}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0, 1]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{two\_sum(nums }\OperatorTok{=}\NormalTok{ [}\DecValTok{3}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{], target }\OperatorTok{=} \DecValTok{6}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{two\_sum(nums }\OperatorTok{=}\NormalTok{ [}\DecValTok{3}\NormalTok{,}\DecValTok{3}\NormalTok{], target }\OperatorTok{=} \DecValTok{6}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0, 1]
\end{verbatim}

We can write more efficient code once we learn other data structures in
chapter 3 of McKinney!

\subsection{Best Time}\label{best-time-3}

Write a function \texttt{best\_time} that solves the following.

You are given an array \texttt{prices} where \texttt{prices{[}i{]}} is
the price of a given stock on the \(i^{th}\) day.

You want to maximize your profit by choosing a single day to buy one
stock and choosing a different day in the future to sell that stock.

Return the maximum profit you can achieve from this transaction. If you
cannot achieve any profit, return 0.

Here are some examples:

Example 1:

Input: \texttt{prices\ =\ {[}7,1,5,3,6,4{]}}\\
Output: \texttt{5}\\
Explanation: Buy on day 2 (price = 1) and sell on day 5 (price = 6),
profit = 6-1 = 5. Note that buying on day 2 and selling on day 1 is not
allowed because you must buy before you sell.

Example 2:

Input: \texttt{prices\ =\ {[}7,6,4,3,1{]}}\\
Output: \texttt{0}\\
Explanation: In this case, no transactions are done and the max profit =
0.

I saw this question on
\href{https://leetcode.com/problems/best-time-to-buy-and-sell-stock/}{LeetCode}.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ max\_profit(prices):}
\NormalTok{        min\_price }\OperatorTok{=}\NormalTok{ prices[}\DecValTok{0}\NormalTok{]}
\NormalTok{        max\_profit }\OperatorTok{=} \DecValTok{0}
        \ControlFlowTok{for}\NormalTok{ price }\KeywordTok{in}\NormalTok{ prices:}
\NormalTok{            min\_price }\OperatorTok{=}\NormalTok{ price }\ControlFlowTok{if}\NormalTok{ price }\OperatorTok{\textless{}}\NormalTok{ min\_price }\ControlFlowTok{else}\NormalTok{ min\_price}
\NormalTok{            profit }\OperatorTok{=}\NormalTok{ price }\OperatorTok{{-}}\NormalTok{ min\_price}
\NormalTok{            max\_profit }\OperatorTok{=}\NormalTok{ profit }\ControlFlowTok{if}\NormalTok{ profit }\OperatorTok{\textgreater{}}\NormalTok{ max\_profit }\ControlFlowTok{else}\NormalTok{ max\_profit}
        \ControlFlowTok{return}\NormalTok{ max\_profit}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{max\_profit(prices}\OperatorTok{=}\NormalTok{[}\DecValTok{7}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{5}\NormalTok{,}\DecValTok{3}\NormalTok{,}\DecValTok{6}\NormalTok{,}\DecValTok{4}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{max\_profit(prices}\OperatorTok{=}\NormalTok{[}\DecValTok{7}\NormalTok{,}\DecValTok{6}\NormalTok{,}\DecValTok{4}\NormalTok{,}\DecValTok{3}\NormalTok{,}\DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0
\end{verbatim}

\part{Week 2}

\chapter{McKinney Chapter 3 - Built-In Data Structures, Functions, and
Files}\label{mckinney-chapter-3---built-in-data-structures-functions-and-files}

\section{Introduction}\label{introduction-1}

We must understand Python's core functionality to fully use NumPy and
pandas. Chapter 3 of Wes McKinney's
\href{https://wesmckinney.com/book/}{\emph{Python for Data Analysis}}
discusses Python's core functionality. We will focus on the following:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Data structures

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    tuples
  \item
    lists
  \item
    dicts (also known as dictionaries)
  \item
    \emph{we will ignore sets}
  \end{enumerate}
\item
  List comprehensions
\item
  Functions

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Returning multiple values
  \item
    Using anonymous functions
  \end{enumerate}
\end{enumerate}

\textbf{\emph{Note:}} Indented block quotes are from McKinney unless
otherwise indicated. The section numbers here differ from McKinney
because we will only discuss some topics.

\section{Data Structures and
Sequences}\label{data-structures-and-sequences}

\begin{quote}
Python's data structures are simple but powerful. Mastering their use is
a critical part of becoming a proficient Python programmer.
\end{quote}

\subsection{Tuple}\label{tuple}

\begin{quote}
A tuple is a fixed-length, immutable sequence of Python objects.
\end{quote}

We cannot change a tuple after we create it because tuples are
immutable. A tuple is ordered, so we can subset or slice it with a
numerical index. We will surround tuples with parentheses but the
parentheses are not always required.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tup }\OperatorTok{=}\NormalTok{ (}\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{6}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\textbf{\emph{Python is zero-indexed, so zero accesses the first element
in \texttt{tup}!}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tup[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tup[}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nested\_tup }\OperatorTok{=}\NormalTok{ ((}\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{6}\NormalTok{), (}\DecValTok{7}\NormalTok{, }\DecValTok{8}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\textbf{\emph{Python is zero-indexed!}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nested\_tup[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(4, 5, 6)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{nested\_tup[}\DecValTok{0}\NormalTok{][}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tup }\OperatorTok{=} \BuiltInTok{tuple}\NormalTok{(}\StringTok{\textquotesingle{}string\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tup}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
('s', 't', 'r', 'i', 'n', 'g')
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tup[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
's'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tup }\OperatorTok{=} \BuiltInTok{tuple}\NormalTok{([}\StringTok{\textquotesingle{}foo\textquotesingle{}}\NormalTok{, [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{], }\VariableTok{True}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tup}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
('foo', [1, 2], True)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# tup[2] = False \# gives an error, because tuples are immutable (unchangeable)}
\end{Highlighting}
\end{Shaded}

\begin{quote}
If an object inside a tuple is mutable, such as a list, you can modify
it in-place.
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tup}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
('foo', [1, 2], True)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tup[}\DecValTok{1}\NormalTok{].append(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tup}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
('foo', [1, 2, 3], True)
\end{verbatim}

\begin{quote}
You can concatenate tuples using the + operator to produce longer
tuples:
\end{quote}

Tuples are immutable, but we can combine two tuples into a new tuple.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{) }\OperatorTok{+}\NormalTok{ (}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(1, 2, 1, 2)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}\DecValTok{4}\NormalTok{, }\VariableTok{None}\NormalTok{, }\StringTok{\textquotesingle{}foo\textquotesingle{}}\NormalTok{) }\OperatorTok{+}\NormalTok{ (}\DecValTok{6}\NormalTok{, }\DecValTok{0}\NormalTok{) }\OperatorTok{+}\NormalTok{ (}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{,)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(4, None, 'foo', 6, 0, 'bar')
\end{verbatim}

\begin{quote}
Multiplying a tuple by an integer, as with lists, has the effect of
concatenating together that many copies of the tuple:
\end{quote}

This multiplication behavior is the logical extension of the addition
behavior above. The output of \texttt{tup\ +\ tup} should be the same as
the output of \texttt{2\ *\ tup}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}\StringTok{\textquotesingle{}foo\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{) }\OperatorTok{*} \DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
('foo', 'bar', 'foo', 'bar')
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}\StringTok{\textquotesingle{}foo\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{) }\OperatorTok{+}\NormalTok{ (}\StringTok{\textquotesingle{}foo\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
('foo', 'bar', 'foo', 'bar')
\end{verbatim}

\subsubsection{Unpacking tuples}\label{unpacking-tuples}

\begin{quote}
If you try to assign to a tuple-like expression of variables, Python
will attempt to unpack the value on the righthand side of the equals
sign.
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tup }\OperatorTok{=}\NormalTok{ (}\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{6}\NormalTok{)}
\NormalTok{a, b, c }\OperatorTok{=}\NormalTok{ tup}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(d, e, f) }\OperatorTok{=}\NormalTok{ (}\DecValTok{7}\NormalTok{, }\DecValTok{8}\NormalTok{, }\DecValTok{9}\NormalTok{) }\CommentTok{\# the parentheses are optional but helpful!}
\end{Highlighting}
\end{Shaded}

We can unpack nested tuples!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tup }\OperatorTok{=} \DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{, (}\DecValTok{6}\NormalTok{, }\DecValTok{7}\NormalTok{)}
\NormalTok{a, b, (c, d) }\OperatorTok{=}\NormalTok{ tup}
\end{Highlighting}
\end{Shaded}

\subsubsection{Tuple methods}\label{tuple-methods}

\begin{quote}
Since the size and contents of a tuple cannot be modified, it is very
light on instance methods. A particularly useful one (also available on
lists) is count, which counts the number of occurrences of a value.
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=}\NormalTok{ (}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{2}\NormalTok{)}
\NormalTok{a.count(}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
4
\end{verbatim}

\subsection{List}\label{list}

\begin{quote}
In contrast with tuples, lists are variable-length and their contents
can be modified in-place. You can define them using square brackets {[}
{]} or using the list type function.
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a\_list }\OperatorTok{=}\NormalTok{ [}\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{7}\NormalTok{, }\VariableTok{None}\NormalTok{]}
\NormalTok{tup }\OperatorTok{=}\NormalTok{ (}\StringTok{\textquotesingle{}foo\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}baz\textquotesingle{}}\NormalTok{)}
\NormalTok{b\_list }\OperatorTok{=} \BuiltInTok{list}\NormalTok{(tup)}
\end{Highlighting}
\end{Shaded}

\textbf{\emph{Pyhon is zero-indexed!}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a\_list[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2
\end{verbatim}

\subsubsection{Adding and removing
elements}\label{adding-and-removing-elements}

\begin{quote}
Elements can be appended to the end of the list with the append method.
\end{quote}

The \texttt{.append()} method appends an element to the list \emph{in
place} without reassigning the list.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b\_list.append(}\StringTok{\textquotesingle{}dwarf\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{quote}
Using insert you can insert an element at a specific location in the
list. The insertion index must be between 0 and the length of the list,
inclusive.
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b\_list.insert(}\DecValTok{1}\NormalTok{, }\StringTok{\textquotesingle{}red\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b\_list.index(}\StringTok{\textquotesingle{}red\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b\_list[b\_list.index(}\StringTok{\textquotesingle{}red\textquotesingle{}}\NormalTok{)] }\OperatorTok{=} \StringTok{\textquotesingle{}blue\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\begin{quote}
The inverse operation to insert is pop, which removes and returns an
element at a particular index.
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b\_list.pop(}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'bar'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b\_list}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['foo', 'blue', 'baz', 'dwarf']
\end{verbatim}

Note that \texttt{.pop(2)} removes the 2 element. If we do not want to
remove the 2 element, we should use \texttt{{[}2{]}} to access an
element without removing it.

\begin{quote}
Elements can be removed by value with remove, which locates the first
such value and removes it from the list.
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b\_list.append(}\StringTok{\textquotesingle{}foo\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b\_list.remove(}\StringTok{\textquotesingle{}foo\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}dwarf\textquotesingle{}} \KeywordTok{in}\NormalTok{ b\_list}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}dwarf\textquotesingle{}} \KeywordTok{not} \KeywordTok{in}\NormalTok{ b\_list}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
False
\end{verbatim}

\subsubsection{Concatenating and combining
lists}\label{concatenating-and-combining-lists}

\begin{quote}
Similar to tuples, adding two lists together with + concatenates them.
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{[}\DecValTok{4}\NormalTok{, }\VariableTok{None}\NormalTok{, }\StringTok{\textquotesingle{}foo\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ [}\DecValTok{7}\NormalTok{, }\DecValTok{8}\NormalTok{, (}\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[4, None, 'foo', 7, 8, (2, 3)]
\end{verbatim}

The \texttt{.append()} method adds its argument as the last element in a
list.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{xx }\OperatorTok{=}\NormalTok{ [}\DecValTok{4}\NormalTok{, }\VariableTok{None}\NormalTok{, }\StringTok{\textquotesingle{}foo\textquotesingle{}}\NormalTok{]}
\NormalTok{xx.append([}\DecValTok{7}\NormalTok{, }\DecValTok{8}\NormalTok{, (}\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{)])}
\end{Highlighting}
\end{Shaded}

\begin{quote}
If you have a list already defined, you can append multiple elements to
it using the extend method.
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OperatorTok{=}\NormalTok{ [}\DecValTok{4}\NormalTok{, }\VariableTok{None}\NormalTok{, }\StringTok{\textquotesingle{}foo\textquotesingle{}}\NormalTok{]}
\NormalTok{x.extend([}\DecValTok{7}\NormalTok{, }\DecValTok{8}\NormalTok{, (}\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{)])}
\end{Highlighting}
\end{Shaded}

\textbf{\emph{Check your output! It will take you time to understand all
these methods!}}

\subsubsection{Sorting}\label{sorting}

\begin{quote}
You can sort a list in-place (without creating a new object) by calling
its sort function.
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=}\NormalTok{ [}\DecValTok{7}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{]}
\NormalTok{a.sort()}
\end{Highlighting}
\end{Shaded}

\begin{quote}
sort has a few options that will occasionally come in handy. One is the
ability to pass a secondary sort key---that is, a function that produces
a value to use to sort the objects. For example, we could sort a
collection of strings by their lengths.
\end{quote}

Before you write your own solution to a problem, read the docstring
(help file) of the built-in function. The built-in function may already
solve your problem faster with fewer bugs.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}saw\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}small\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}He\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}foxes\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}six\textquotesingle{}}\NormalTok{]}
\NormalTok{b.sort()}
\end{Highlighting}
\end{Shaded}

Python is case sensitive, so ``He'' sorts before ``foxes''!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b.sort(key}\OperatorTok{=}\BuiltInTok{len}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\subsubsection{Slicing}\label{slicing}

\textbf{\emph{Slicing is very important!}}

\begin{quote}
You can select sections of most sequence types by using slice notation,
which in its basic form consists of start:stop passed to the indexing
operator {[} {]}.
\end{quote}

Recall that Python is zero-indexed, so the first element has an index of
0. The necessary consequence of zero-indexing is that start:stop is
inclusive on the left edge (start) and exclusive on the right edge
(stop).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{seq }\OperatorTok{=}\NormalTok{ [}\DecValTok{7}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{7}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{]}
\NormalTok{seq}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[7, 2, 3, 7, 5, 6, 0, 1]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{seq[}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{seq[:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[7, 2, 3, 7, 5]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{seq[}\DecValTok{1}\NormalTok{:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[2, 3, 7, 5]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{seq[}\DecValTok{3}\NormalTok{:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[7, 5]
\end{verbatim}

\begin{quote}
Either the start or stop can be omitted, in which case they default to
the start of the sequence and the end of the sequence, respectively.
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{seq[:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[7, 2, 3, 7, 5]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{seq[}\DecValTok{3}\NormalTok{:]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[7, 5, 6, 0, 1]
\end{verbatim}

\begin{quote}
Negative indices slice the sequence relative to the end.
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{seq[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{:]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{seq[}\OperatorTok{{-}}\DecValTok{4}\NormalTok{:]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[5, 6, 0, 1]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{seq[}\OperatorTok{{-}}\DecValTok{4}\NormalTok{:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[5, 6, 0]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{seq[}\OperatorTok{{-}}\DecValTok{6}\NormalTok{:}\OperatorTok{{-}}\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[3, 7, 5, 6]
\end{verbatim}

\begin{quote}
A step can also be used after a second colon to, say, take every other
element.
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{seq[:]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[7, 2, 3, 7, 5, 6, 0, 1]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{seq[::}\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[7, 3, 5, 0]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{seq[}\DecValTok{1}\NormalTok{::}\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[2, 7, 6, 1]
\end{verbatim}

I remember the trick above as \texttt{:2} is ``count by 2''.

\begin{quote}
A clever use of this is to pass -1, which has the useful effect of
reversing a list or tuple.
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{seq[::}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 0, 6, 5, 7, 3, 2, 7]
\end{verbatim}

We will use slicing (subsetting) all semester, so it is worth a few
minutes to understand the examples above.

\subsection{dict}\label{dict}

\begin{quote}
dict is likely the most important built-in Python data structure. A more
common name for it is hash map or associative array. It is a flexibly
sized collection of key-value pairs, where key and value are Python
objects. One approach for creating one is to use curly braces \{\} and
colons to separate keys and values.
\end{quote}

Elements in dictionaries have names, while elements in tuples and lists
have numerical indices. Dictionaries are handy for passing named
arguments and returning named results.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{empty\_dict }\OperatorTok{=}\NormalTok{ \{\}}
\NormalTok{empty\_dict}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
{}
\end{verbatim}

A dictionary is a set of key-value pairs.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d1 }\OperatorTok{=}\NormalTok{ \{}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}some value\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{: [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{]\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d1[}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'some value'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d1[}\DecValTok{7}\NormalTok{] }\OperatorTok{=} \StringTok{\textquotesingle{}an integer\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
{'a': 'some value', 'b': [1, 2, 3, 4], 7: 'an integer'}
\end{verbatim}

We access dictionary values by key names instead of key positions.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d1[}\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3, 4]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}b\textquotesingle{}} \KeywordTok{in}\NormalTok{ d1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{quote}
You can delete values either using the del keyword or the pop method
(which simultaneously returns the value and deletes the key).
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d1[}\DecValTok{5}\NormalTok{] }\OperatorTok{=} \StringTok{\textquotesingle{}some value\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d1[}\StringTok{\textquotesingle{}dummy\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \StringTok{\textquotesingle{}another value\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
{'a': 'some value',
 'b': [1, 2, 3, 4],
 7: 'an integer',
 5: 'some value',
 'dummy': 'another value'}
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{del}\NormalTok{ d1[}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
{'a': 'some value',
 'b': [1, 2, 3, 4],
 7: 'an integer',
 'dummy': 'another value'}
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ret }\OperatorTok{=}\NormalTok{ d1.pop(}\StringTok{\textquotesingle{}dummy\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ret}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'another value'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
{'a': 'some value', 'b': [1, 2, 3, 4], 7: 'an integer'}
\end{verbatim}

\begin{quote}
The keys and values method give you iterators of the dict's keys and
values, respectively. While the key-value pairs are not in any
particular order, these functions output the keys and values in the same
order.
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d1.keys()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
dict_keys(['a', 'b', 7])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d1.values()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
dict_values(['some value', [1, 2, 3, 4], 'an integer'])
\end{verbatim}

\begin{quote}
You can merge one dict into another using the update method.
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
{'a': 'some value', 'b': [1, 2, 3, 4], 7: 'an integer'}
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d1.update(\{}\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}foo\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{: }\DecValTok{12}\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
{'a': 'some value', 'b': 'foo', 7: 'an integer', 'c': 12}
\end{verbatim}

\section{List, Set, and Dict
Comprehensions}\label{list-set-and-dict-comprehensions}

We will focus on list comprehensions.

\begin{quote}
List comprehensions are one of the most-loved Python language features.
They allow you to concisely form a new list by filtering the elements of
a collection, transforming the elements passing the filter in one
concise expression. They take the basic form:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{[expr }\ControlFlowTok{for}\NormalTok{ val }\KeywordTok{in}\NormalTok{ collection }\ControlFlowTok{if}\NormalTok{ condition]}
\end{Highlighting}
\end{Shaded}

This is equivalent to the following for loop:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{result }\OperatorTok{=}\NormalTok{ []}
\ControlFlowTok{for}\NormalTok{ val }\KeywordTok{in}\NormalTok{ collection:}
    \ControlFlowTok{if}\NormalTok{ condition:}
\NormalTok{        result.append(expr)}
\end{Highlighting}
\end{Shaded}

The filter condition can be omitted, leaving only the expression.
\end{quote}

List comprehensions are very
\href{https://blog.startifact.com/posts/older/what-is-pythonic.html}{Pythonic}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{strings }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}as\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}bat\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}car\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}dove\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}python\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

We could use a for loop to capitalize the strings in \texttt{strings}
and keep only strings with lengths greater than two.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{caps }\OperatorTok{=}\NormalTok{ []}
\ControlFlowTok{for}\NormalTok{ x }\KeywordTok{in}\NormalTok{ strings:}
    \ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(x) }\OperatorTok{\textgreater{}} \DecValTok{2}\NormalTok{:}
\NormalTok{        caps.append(x.upper())}

\NormalTok{caps}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['BAT', 'CAR', 'DOVE', 'PYTHON']
\end{verbatim}

A list comprehension is a more Pythonic solution and replaces four lines
of code with one. The general format for a list comprehension is
\texttt{{[}operation\ on\ x\ for\ x\ in\ list\ if\ condition{]}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{[x.upper() }\ControlFlowTok{for}\NormalTok{ x }\KeywordTok{in}\NormalTok{ strings }\ControlFlowTok{if} \BuiltInTok{len}\NormalTok{(x) }\OperatorTok{\textgreater{}} \DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['BAT', 'CAR', 'DOVE', 'PYTHON']
\end{verbatim}

Here is another example. Write a for-loop and the equivalent list
comprehension that squares the integers from 1 to 10.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{squares }\OperatorTok{=}\NormalTok{ []}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{11}\NormalTok{):}
\NormalTok{    squares.append(i }\OperatorTok{**} \DecValTok{2}\NormalTok{)}
    
\NormalTok{squares}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 4, 9, 16, 25, 36, 49, 64, 81, 100]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{[i}\OperatorTok{**}\DecValTok{2} \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{11}\NormalTok{)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 4, 9, 16, 25, 36, 49, 64, 81, 100]
\end{verbatim}

\section{Functions}\label{functions}

\begin{quote}
Functions are the primary and most important method of code organization
and reuse in Python. As a rule of thumb, if you anticipate needing to
repeat the same or very similar code more than once, it may be worth
writing a reusable function. Functions can also help make your code more
readable by giving a name to a group of Python statements.

Functions are declared with the def keyword and returned from with the
return keyword:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ my\_function(x, y, z}\OperatorTok{=}\FloatTok{1.5}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ z }\OperatorTok{\textgreater{}} \DecValTok{1}\NormalTok{:}
         \ControlFlowTok{return}\NormalTok{ z }\OperatorTok{*}\NormalTok{ (x }\OperatorTok{+}\NormalTok{ y)}
     \ControlFlowTok{else}\NormalTok{:}
         \ControlFlowTok{return}\NormalTok{ z }\OperatorTok{/}\NormalTok{ (x }\OperatorTok{+}\NormalTok{ y)}
\end{Highlighting}
\end{Shaded}

There is no issue with having multiple return statements. If Python
reaches the end of a function without encountering a return statement,
None is returned automatically.

Each function can have positional arguments and keyword arguments.
Keyword arguments are most commonly used to specify default values or
optional arguments. In the preceding function, x and y are positional
arguments while z is a keyword argument. This means that the function
can be called in any of these ways:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ my\_function(}\DecValTok{5}\NormalTok{, }\DecValTok{6}\NormalTok{, z}\OperatorTok{=}\FloatTok{0.7}\NormalTok{)}
\NormalTok{ my\_function(}\FloatTok{3.14}\NormalTok{, }\DecValTok{7}\NormalTok{, }\FloatTok{3.5}\NormalTok{)}
\NormalTok{ my\_function(}\DecValTok{10}\NormalTok{, }\DecValTok{20}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The main restriction on function arguments is that the keyword arguments
must follow the positional arguments (if any). You can specify keyword
arguments in any order; this frees you from having to remember which
order the function arguments were specified in and only what their names
are.
\end{quote}

Here is the basic syntax for a function:

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ mult\_by\_two(x):}
    \ControlFlowTok{return} \DecValTok{2}\OperatorTok{*}\NormalTok{x}
\end{Highlighting}
\end{Shaded}

\subsection{Returning Multiple Values}\label{returning-multiple-values}

We can write Python functions that return multiple objects. In reality,
the function \texttt{f()} below returns one object, a tuple, that we can
unpack to multiple objects.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ f():}
\NormalTok{    a }\OperatorTok{=} \DecValTok{5}
\NormalTok{    b }\OperatorTok{=} \DecValTok{6}
\NormalTok{    c }\OperatorTok{=} \DecValTok{7}
    \ControlFlowTok{return}\NormalTok{ (a, b, c)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{f()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(5, 6, 7)
\end{verbatim}

If we want to return multiple objects with names or labels, we can
return a dictionary.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ f():}
\NormalTok{    a }\OperatorTok{=} \DecValTok{5}
\NormalTok{    b }\OperatorTok{=} \DecValTok{6}
\NormalTok{    c }\OperatorTok{=} \DecValTok{7}
    \ControlFlowTok{return}\NormalTok{ \{}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{ : a, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{ : b, }\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{ : c\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{f()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
{'a': 5, 'b': 6, 'c': 7}
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{f()[}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
5
\end{verbatim}

\subsection{Anonymous (Lambda)
Functions}\label{anonymous-lambda-functions}

\begin{quote}
Python has support for so-called anonymous or lambda functions, which
are a way of writing functions consisting of a single statement, the
result of which is the return value. They are defined with the lambda
keyword, which has no meaning other than ``we are declaring an anonymous
function.''
\end{quote}

\begin{quote}
I usually refer to these as lambda functions in the rest of the book.
They are especially convenient in data analysis because, as you'll see,
there are many cases where data transformation functions will take
functions as arguments. It's often less typing (and clearer) to pass a
lambda function as opposed to writing a full-out function declaration or
even assigning the lambda function to a local variable.
\end{quote}

Lambda functions are very Pythonic and let us to write simple functions
on the fly. For example, we could use a lambda function to sort
\texttt{strings} by the number of unique letters.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{strings }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}foo\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}card\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}aaaa\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}abab\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{strings.sort()}
\NormalTok{strings}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['aaaa', 'abab', 'bar', 'card', 'foo']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{strings.sort(key}\OperatorTok{=}\BuiltInTok{len}\NormalTok{)}
\NormalTok{strings}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['bar', 'foo', 'aaaa', 'abab', 'card']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{strings.sort(key}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{])}
\NormalTok{strings}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['aaaa', 'abab', 'card', 'foo', 'bar']
\end{verbatim}

How can I sort by the \emph{second} letter in each string?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{strings.sort(key}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\DecValTok{1}\NormalTok{])}
\NormalTok{strings}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['aaaa', 'card', 'bar', 'abab', 'foo']
\end{verbatim}

\chapter{McKinney Chapter 3 - Practice for Section
02}\label{mckinney-chapter-3---practice-for-section-02}

\section{Announcements}\label{announcements-4}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Due Friday, 1/19, at 11:59 PM:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Complete \emph{Introduction to Python} course on DataCamp (and
    upload certificate to Canvas)
  \item
    Acknowledge academic integrity statement on Canvas
  \end{enumerate}
\item
  I will record and post the next lecture video on Thursday, 1/18, and
  the associate pre-class quiz is due before class on Tuesday, 1/23
\item
  Start joining groups on Canvas (Canvas \textgreater{} People
  \textgreater{} Team Projects); I removed joining groups as a scored
  assignment, but please prioritize joining groups
\end{enumerate}

\section{10-minute Recap}\label{minute-recap-3}

\subsection{List}\label{list-1}

A list is a collection of items that are ordered and changeable. You can
add, remove, or modify elements in a list. In Python, you can create an
empty list using either \texttt{{[}{]}} or \texttt{list()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_list }\OperatorTok{=}\NormalTok{ [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{]]]}

\NormalTok{my\_list}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3, [1, 2, 3, [1, 2, 3]]]
\end{verbatim}

\textbf{\emph{Python is zero-indexed!}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_list[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_list[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{][}\OperatorTok{{-}}\DecValTok{1}\NormalTok{][}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_list[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{][}\OperatorTok{{-}}\DecValTok{1}\NormalTok{][}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{=} \StringTok{\textquotesingle{}Matilda\textquotesingle{}}

\NormalTok{my\_list}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3, [1, 2, 3, [1, 2, 'Matilda']]]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_list[}\DecValTok{3}\NormalTok{] }\KeywordTok{is}\NormalTok{ my\_list[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\subsection{Tuple}\label{tuple-1}

A tuple is similar to a list, but it is immutable, meaning that you
cannot change its contents once it has been created. You can create a
tuple using parentheses \texttt{()} or the \texttt{tuple()} function.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_tuple }\OperatorTok{=}\NormalTok{ (}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, (}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, (}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{)))}

\NormalTok{my\_tuple}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(1, 2, 3, (1, 2, 3, (1, 2, 3)))
\end{verbatim}

\textbf{\emph{Tuples are immutable!}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# my\_tuple[{-}1][{-}1][{-}1] = \textquotesingle{}Matilda\textquotesingle{}}

\CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# TypeError                                 Traceback (most recent call last)}
\CommentTok{\# Cell In[14], line 1}
\CommentTok{\# {-}{-}{-}{-}\textgreater{} 1 my\_tuple[{-}1][{-}1][{-}1] = \textquotesingle{}Matilda\textquotesingle{}}

\CommentTok{\# TypeError: \textquotesingle{}tuple\textquotesingle{} object does not support item assignment}
\end{Highlighting}
\end{Shaded}

In the following example, we can replace the innermost \texttt{3} with
\texttt{\textquotesingle{}Matilda\textquotesingle{}} because it is an
object in a list.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_tuple\_2 }\OperatorTok{=}\NormalTok{ (}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, (}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{]))}

\NormalTok{my\_tuple\_2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(1, 2, 3, (1, 2, 3, [1, 2, 3]))
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_tuple\_2[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{][}\OperatorTok{{-}}\DecValTok{1}\NormalTok{][}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{=} \StringTok{\textquotesingle{}Matilda\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{Dictionary}\label{dictionary}

A dictionary is a collection of key-value pairs that are unordered and
changeable. You can add, remove, or modify elements in a dictionary. In
Python, you can create an empty dictionary using either \texttt{\{\}} or
the \texttt{dict()} function.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices\_list }\OperatorTok{=}\NormalTok{ [}\DecValTok{10}\NormalTok{, }\DecValTok{20}\NormalTok{, }\DecValTok{300}\NormalTok{] }\CommentTok{\# for AAPL, MSFT, TSLA}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices\_dict }\OperatorTok{=}\NormalTok{ \{}\StringTok{\textquotesingle{}AAPL\textquotesingle{}}\NormalTok{: }\DecValTok{10}\NormalTok{, }\StringTok{\textquotesingle{}MSFT\textquotesingle{}}\NormalTok{: }\DecValTok{20}\NormalTok{, }\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{: }\DecValTok{300}\NormalTok{\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices\_dict[}\StringTok{\textquotesingle{}AAPL\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
10
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_dict }\OperatorTok{=}\NormalTok{ \{}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{: }\DecValTok{1}\NormalTok{, }\StringTok{\textquotesingle{}B\textquotesingle{}}\NormalTok{: [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{], }\StringTok{\textquotesingle{}C\textquotesingle{}}\NormalTok{: \{}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{: }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{: }\DecValTok{2}\NormalTok{\}\}}

\NormalTok{my\_dict}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
{'A': 1, 'B': [1, 2, 3], 'C': {'A': 1, 2: 2}}
\end{verbatim}

\subsection{List Comprehension}\label{list-comprehension}

A list comprehension is a concise way of creating a new list by
iterating over an existing list or other iterable object. It is more
time and space-efficient than traditional for loops and offers a cleaner
syntax. The basic syntax of a list comprehension is
\texttt{new\_list\ =\ {[}expression\ for\ item\ in\ iterable\ if\ condition{]}}
where:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \texttt{expression} is the operation to be performed on each element
  of the iterable
\item
  \texttt{item} is the current element being processed
\item
  \texttt{iterable} is the list or other iterable object being iterated
  over
\item
  \texttt{condition} is an optional filter that only accepts items that
  evaluate to True.
\end{enumerate}

For example, we can use the following list comprehension to create a new
list of even numbers from 0 to 8:
\texttt{even\_numbers\ =\ {[}x\ for\ x\ in\ range(9)\ if\ x\ \%\ 2\ ==\ 0{]}}

List comprehensions are a powerful tool in Python that can help you
write more efficient and readable code (i.e., more Pythonic code).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{even\_numbers }\OperatorTok{=}\NormalTok{ []}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{9}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ i}\OperatorTok{\%}\DecValTok{2} \OperatorTok{==} \DecValTok{0}\NormalTok{:}
\NormalTok{        even\_numbers.append(i)}

\NormalTok{even\_numbers}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0, 2, 4, 6, 8]
\end{verbatim}

Here is the cooler, more Pythonic list comprehension version:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{[i }\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{9}\NormalTok{) }\ControlFlowTok{if}\NormalTok{ i}\OperatorTok{\%}\DecValTok{2} \OperatorTok{==} \DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0, 2, 4, 6, 8]
\end{verbatim}

\section{Practice}\label{practice-4}

\subsection{\texorpdfstring{Swap the values assigned to \texttt{a} and
\texttt{b} using a third variable
\texttt{c}.}{Swap the values assigned to a and b using a third variable c.}}\label{swap-the-values-assigned-to-a-and-b-using-a-third-variable-c.}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=} \DecValTok{1}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=} \DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{c }\OperatorTok{=}\NormalTok{ a}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=}\NormalTok{ b}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=}\NormalTok{ c}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{del}\NormalTok{ c}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}a: }\SpecialCharTok{\{}\NormalTok{a}\SpecialCharTok{\}}\SpecialStringTok{, b: }\SpecialCharTok{\{}\NormalTok{b}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
a: 2, b: 1
\end{verbatim}

\subsection{\texorpdfstring{Swap the values assigned to \texttt{a} and
\texttt{b} \textbf{\emph{without}} using a third variable
\texttt{c}.}{Swap the values assigned to a and b without using a third variable c.}}\label{swap-the-values-assigned-to-a-and-b-without-using-a-third-variable-c.}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=} \DecValTok{1}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=} \DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(b, a) }\OperatorTok{=}\NormalTok{ (a, b)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}a: }\SpecialCharTok{\{}\NormalTok{a}\SpecialCharTok{\}}\SpecialStringTok{, b: }\SpecialCharTok{\{}\NormalTok{b}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
a: 2, b: 1
\end{verbatim}

\subsection{What is the output of the following code and
why?}\label{what-is-the-output-of-the-following-code-and-why}

The parentheses \texttt{()} are optional for tuples, but they are often
useful!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=} \DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}
\BuiltInTok{type}\NormalTok{(\_)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
tuple
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1} \OperatorTok{==}\NormalTok{ (}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(1, 1, False)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{) }\OperatorTok{==} \DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(False, 1, 1)
\end{verbatim}

Here we can wrap both sides with parentheses to remove ambiguity!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{) }\OperatorTok{==}\NormalTok{ (}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\subsection{\texorpdfstring{Create a list \texttt{l1} of integers from 1
to
100.}{Create a list l1 of integers from 1 to 100.}}\label{create-a-list-l1-of-integers-from-1-to-100.}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l1 }\OperatorTok{=} \BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{101}\NormalTok{))}
\CommentTok{\# the last entry in a code cell prints automatically...}
\CommentTok{\# here I wrap l1 with print for fewer lines of printout}
\BuiltInTok{print}\NormalTok{(l1)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100]
\end{verbatim}

\subsection{\texorpdfstring{Slice \texttt{l1} to create a list of
integers from 60 to 50
(inclusive).}{Slice l1 to create a list of integers from 60 to 50 (inclusive).}}\label{slice-l1-to-create-a-list-of-integers-from-60-to-50-inclusive.}

Name this list \texttt{l2}.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# with zero{-}indexing:}
\CommentTok{\# left edge included, right excluded}
\CommentTok{\# so length of list is right {-} left}
\NormalTok{l2 }\OperatorTok{=}\NormalTok{ l1[}\DecValTok{49}\NormalTok{:}\DecValTok{60}\NormalTok{]}
\NormalTok{l2.reverse()}
\NormalTok{l2 }\CommentTok{\# most Python methods modify objects "in place"}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[60, 59, 58, 57, 56, 55, 54, 53, 52, 51, 50]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l2\_alt }\OperatorTok{=}\NormalTok{ l1[}\DecValTok{49}\NormalTok{:}\DecValTok{60}\NormalTok{][::}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}

\NormalTok{l2\_alt}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[60, 59, 58, 57, 56, 55, 54, 53, 52, 51, 50]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l1[}\OperatorTok{{-}}\DecValTok{41}\NormalTok{:}\OperatorTok{{-}}\DecValTok{52}\NormalTok{:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[60, 59, 58, 57, 56, 55, 54, 53, 52, 51, 50]
\end{verbatim}

\subsection{\texorpdfstring{Create a list \texttt{l3} of odd integers
from 1 to
21.}{Create a list l3 of odd integers from 1 to 21.}}\label{create-a-list-l3-of-odd-integers-from-1-to-21.}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l3 }\OperatorTok{=}\NormalTok{ []}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{22}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ i}\OperatorTok{\%}\DecValTok{2} \OperatorTok{==} \DecValTok{1}\NormalTok{:}
\NormalTok{        l3.append(i)}

\NormalTok{l3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l3\_alt }\OperatorTok{=}\NormalTok{ [i }\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{22}\NormalTok{) }\ControlFlowTok{if}\NormalTok{ i}\OperatorTok{\%}\DecValTok{2} \OperatorTok{==} \DecValTok{1}\NormalTok{]}

\NormalTok{l3\_alt}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{22}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21]
\end{verbatim}

\subsection{\texorpdfstring{Create a list \texttt{l4} of the squares of
integers from 1 to
100.}{Create a list l4 of the squares of integers from 1 to 100.}}\label{create-a-list-l4-of-the-squares-of-integers-from-1-to-100.}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l4 }\OperatorTok{=}\NormalTok{ [i}\OperatorTok{**}\DecValTok{2} \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{101}\NormalTok{)]}

\BuiltInTok{print}\NormalTok{(l4)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 4, 9, 16, 25, 36, 49, 64, 81, 100, 121, 144, 169, 196, 225, 256, 289, 324, 361, 400, 441, 484, 529, 576, 625, 676, 729, 784, 841, 900, 961, 1024, 1089, 1156, 1225, 1296, 1369, 1444, 1521, 1600, 1681, 1764, 1849, 1936, 2025, 2116, 2209, 2304, 2401, 2500, 2601, 2704, 2809, 2916, 3025, 3136, 3249, 3364, 3481, 3600, 3721, 3844, 3969, 4096, 4225, 4356, 4489, 4624, 4761, 4900, 5041, 5184, 5329, 5476, 5625, 5776, 5929, 6084, 6241, 6400, 6561, 6724, 6889, 7056, 7225, 7396, 7569, 7744, 7921, 8100, 8281, 8464, 8649, 8836, 9025, 9216, 9409, 9604, 9801, 10000]
\end{verbatim}

\subsection{\texorpdfstring{Create a list \texttt{l5} that contains the
squares of \textbf{\emph{odd}} integers from 1 to
100.}{Create a list l5 that contains the squares of odd integers from 1 to 100.}}\label{create-a-list-l5-that-contains-the-squares-of-odd-integers-from-1-to-100.}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l5 }\OperatorTok{=}\NormalTok{ [i}\OperatorTok{**}\DecValTok{2} \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{101}\NormalTok{) }\ControlFlowTok{if}\NormalTok{ i}\OperatorTok{\%}\DecValTok{2} \OperatorTok{!=} \DecValTok{0}\NormalTok{]}

\BuiltInTok{print}\NormalTok{(l5)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 9, 25, 49, 81, 121, 169, 225, 289, 361, 441, 529, 625, 729, 841, 961, 1089, 1225, 1369, 1521, 1681, 1849, 2025, 2209, 2401, 2601, 2809, 3025, 3249, 3481, 3721, 3969, 4225, 4489, 4761, 5041, 5329, 5625, 5929, 6241, 6561, 6889, 7225, 7569, 7921, 8281, 8649, 9025, 9409, 9801]
\end{verbatim}

\subsection{\texorpdfstring{Use a lambda function to sort
\texttt{strings} by the last
letter.}{Use a lambda function to sort strings by the last letter.}}\label{use-a-lambda-function-to-sort-strings-by-the-last-letter.}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{strings }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}card\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}aaaa\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}foo\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}abab\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ get\_last\_letter(x):}
    \ControlFlowTok{return}\NormalTok{ x[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{get\_last\_letter(strings[}\DecValTok{0}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'd'
\end{verbatim}

I would usually use the \texttt{.sort()} method, which would modify the
\texttt{strings} list \emph{in place.} However, for this exercise I want
to leave the \texttt{strings} list as is, so I can I can repeat this
exercise a few times.

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{sorted}\NormalTok{(strings)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['aaaa', 'abab', 'bar', 'card', 'foo']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{sorted}\NormalTok{(strings, key}\OperatorTok{=}\NormalTok{get\_last\_letter)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['aaaa', 'abab', 'card', 'foo', 'bar']
\end{verbatim}

Here is the anonymous function version.

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{sorted}\NormalTok{(strings, key}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['aaaa', 'abab', 'card', 'foo', 'bar']
\end{verbatim}

Anonymous functions are very Pythonic and the ideal way to implement a
calculation that you only plan to use once, thereby avoiding the
overhead of writing a function.

\subsection{\texorpdfstring{Given an integer array \texttt{nums} and an
integer \texttt{k}, return the \(k^{th}\) largest element in the
array.}{Given an integer array nums and an integer k, return the k\^{}\{th\} largest element in the array.}}\label{given-an-integer-array-nums-and-an-integer-k-return-the-kth-largest-element-in-the-array.}

Note that it is the \(k^{th}\) largest element in the sorted order, not
the \(k^{th}\) distinct element.

Example 1:

Input: \texttt{nums\ =\ {[}3,2,1,5,6,4{]}}, \texttt{k\ =\ 2}\\
Output: \texttt{5}

Example 2:

Input: \texttt{nums\ =\ {[}3,2,3,1,2,4,5,5,6{]}}, \texttt{k\ =\ 4}\\
Output: \texttt{4}

I saw this question on
\href{https://leetcode.com/problems/kth-largest-element-in-an-array/}{LeetCode}.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ get\_largest(x, k):}
    \ControlFlowTok{return} \BuiltInTok{sorted}\NormalTok{(x)[}\OperatorTok{{-}}\NormalTok{k]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{get\_largest(x}\OperatorTok{=}\NormalTok{[}\DecValTok{3}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{5}\NormalTok{,}\DecValTok{6}\NormalTok{,}\DecValTok{4}\NormalTok{], k}\OperatorTok{=}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{get\_largest(x}\OperatorTok{=}\NormalTok{[}\DecValTok{3}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{3}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{,}\DecValTok{5}\NormalTok{,}\DecValTok{5}\NormalTok{,}\DecValTok{6}\NormalTok{], k}\OperatorTok{=}\DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
4
\end{verbatim}

\subsection{\texorpdfstring{Given an integer array \texttt{nums} and an
integer \texttt{k}, return the \texttt{k} most frequent
elements.}{Given an integer array nums and an integer k, return the k most frequent elements.}}\label{given-an-integer-array-nums-and-an-integer-k-return-the-k-most-frequent-elements.}

You may return the answer in any order.

Example 1:

Input: \texttt{nums\ =\ {[}1,1,1,2,2,3{]}}, \texttt{k\ =\ 2}\\
Output: \texttt{{[}1,2{]}}

Example 2:

Input: \texttt{nums\ =\ {[}1{]}}, \texttt{k\ =\ 1}\\
Output: \texttt{{[}1{]}}

I saw this question on
\href{https://leetcode.com/problems/top-k-frequent-elements/}{LeetCode}.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ get\_frequent(nums, k):}
\NormalTok{    counts }\OperatorTok{=}\NormalTok{ \{\}}
    \ControlFlowTok{for}\NormalTok{ n }\KeywordTok{in}\NormalTok{ nums:}
        \ControlFlowTok{if}\NormalTok{ n }\KeywordTok{in}\NormalTok{ counts:}
\NormalTok{            counts[n] }\OperatorTok{+=} \DecValTok{1}
        \ControlFlowTok{else}\NormalTok{:}
\NormalTok{            counts[n] }\OperatorTok{=} \DecValTok{1}
    \ControlFlowTok{return}\NormalTok{ [x[}\DecValTok{0}\NormalTok{] }\ControlFlowTok{for}\NormalTok{ x }\KeywordTok{in} \BuiltInTok{sorted}\NormalTok{(counts.items(), key}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\DecValTok{1}\NormalTok{], reverse}\OperatorTok{=}\VariableTok{True}\NormalTok{)[:k]]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{get\_frequent(nums}\OperatorTok{=}\NormalTok{[}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{3}\NormalTok{], k}\OperatorTok{=}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2]
\end{verbatim}

\subsection{Test whether the given strings are
palindromes.}\label{test-whether-the-given-strings-are-palindromes.}

Input: \texttt{{[}"aba",\ "no"{]}}\\
Output: \texttt{{[}True,\ False{]}}

We can reverse a string with a \texttt{{[}::-1{]}} slice just like we
reverse a string!

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ is\_palindrome(xs):}
    \ControlFlowTok{return}\NormalTok{ [x }\OperatorTok{==}\NormalTok{ x[::}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\ControlFlowTok{for}\NormalTok{ x }\KeywordTok{in}\NormalTok{ xs]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{is\_palindrome([}\StringTok{"aba"}\NormalTok{, }\StringTok{"no"}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[True, False]
\end{verbatim}

\subsection{\texorpdfstring{Write a function \texttt{returns()} that
accepts lists of prices and dividends and returns a list of
returns.}{Write a function returns() that accepts lists of prices and dividends and returns a list of returns.}}\label{write-a-function-returns-that-accepts-lists-of-prices-and-dividends-and-returns-a-list-of-returns.}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices }\OperatorTok{=}\NormalTok{ [}\DecValTok{100}\NormalTok{, }\DecValTok{150}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{50}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{150}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{150}\NormalTok{]}
\NormalTok{dividends }\OperatorTok{=}\NormalTok{ [}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

This type problem is the rare case where I use a loop counter in Python.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ returns(p, d):}
\NormalTok{    rs }\OperatorTok{=}\NormalTok{ []}
    \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\BuiltInTok{len}\NormalTok{(p)):}
\NormalTok{        r }\OperatorTok{=}\NormalTok{ (p[i] }\OperatorTok{+}\NormalTok{ d[i] }\OperatorTok{{-}}\NormalTok{ p[i}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]) }\OperatorTok{/}\NormalTok{ p[i}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{        rs.append(r)}

    \ControlFlowTok{return}\NormalTok{ rs}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'%.4f'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns(p}\OperatorTok{=}\NormalTok{prices, d}\OperatorTok{=}\NormalTok{dividends)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0.5100, -0.3267, -0.4900, 1.0400, 0.5200, -0.3200, 0.5200]
\end{verbatim}

Here is a solution that avoids a loop counter and combines a list
comprehension \texttt{zip()} to loop over prices, dividends, and lagged
prices. This solution may be a little more Pythonic, but I find it
harder to follow that our loop-counter solution above.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{[(p }\OperatorTok{+}\NormalTok{ d }\OperatorTok{{-}}\NormalTok{ p\_lag) }\OperatorTok{/}\NormalTok{ p\_lag }\ControlFlowTok{for}\NormalTok{ p, d, p\_lag }\KeywordTok{in} \BuiltInTok{zip}\NormalTok{(prices[}\DecValTok{1}\NormalTok{:], dividends[}\DecValTok{1}\NormalTok{:], prices[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{])]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0.5100, -0.3267, -0.4900, 1.0400, 0.5200, -0.3200, 0.5200]
\end{verbatim}

\subsection{\texorpdfstring{Rewrite the function \texttt{returns()} so
it returns lists of returns, capital gains yields, and dividend
yields.}{Rewrite the function returns() so it returns lists of returns, capital gains yields, and dividend yields.}}\label{rewrite-the-function-returns-so-it-returns-lists-of-returns-capital-gains-yields-and-dividend-yields.}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ returns\_2(p, d):}
\NormalTok{    rs, d\_ps, cg\_ps }\OperatorTok{=}\NormalTok{ [], [], []}
    \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\BuiltInTok{len}\NormalTok{(p)):}
\NormalTok{        r }\OperatorTok{=}\NormalTok{ (p[i] }\OperatorTok{+}\NormalTok{ d[i] }\OperatorTok{{-}}\NormalTok{ p[i}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]) }\OperatorTok{/}\NormalTok{ p[i}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{        d\_p }\OperatorTok{=}\NormalTok{ d[i] }\OperatorTok{/}\NormalTok{ p[i}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{        cg\_p }\OperatorTok{=}\NormalTok{ r }\OperatorTok{{-}}\NormalTok{ d\_p}
\NormalTok{        rs.append(r)}
\NormalTok{        d\_ps.append(d\_p)}
\NormalTok{        cg\_ps.append(cg\_p)}

    \ControlFlowTok{return}\NormalTok{ \{}\StringTok{\textquotesingle{}r\textquotesingle{}}\NormalTok{: rs, }\StringTok{\textquotesingle{}d\_p\textquotesingle{}}\NormalTok{: d\_ps, }\StringTok{\textquotesingle{}cg\textquotesingle{}}\NormalTok{: cg\_ps\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2(p}\OperatorTok{=}\NormalTok{prices, d}\OperatorTok{=}\NormalTok{dividends)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
{'r': [0.5100, -0.3267, -0.4900, 1.0400, 0.5200, -0.3200, 0.5200],
 'd_p': [0.0100, 0.0067, 0.0100, 0.0400, 0.0200, 0.0133, 0.0200],
 'cg': [0.5000, -0.3333, -0.5000, 1.0000, 0.5000, -0.3333, 0.5000]}
\end{verbatim}

\subsection{\texorpdfstring{Rescale and shift numbers so that they cover
the range
\texttt{{[}0,\ 1{]}}.}{Rescale and shift numbers so that they cover the range {[}0, 1{]}.}}\label{rescale-and-shift-numbers-so-that-they-cover-the-range-0-1.}

Input: \texttt{{[}18.5,\ 17.0,\ 18.0,\ 19.0,\ 18.0{]}}\\
Output: \texttt{{[}0.75,\ 0.0,\ 0.5,\ 1.0,\ 0.5{]}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{numbers }\OperatorTok{=}\NormalTok{ [}\FloatTok{18.5}\NormalTok{, }\FloatTok{17.0}\NormalTok{, }\FloatTok{18.0}\NormalTok{, }\FloatTok{19.0}\NormalTok{, }\FloatTok{18.0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ rescale(x):}
\NormalTok{    x\_min }\OperatorTok{=} \BuiltInTok{min}\NormalTok{(x)}
\NormalTok{    x\_max }\OperatorTok{=} \BuiltInTok{max}\NormalTok{(x)}

    \CommentTok{\# Here is the for{-}loop equivalent of the list comprehension below}
    \CommentTok{\# rescaled = []}
    \CommentTok{\# for y in x:}
    \CommentTok{\#     rescaled.append((y {-} x\_min) / (x\_max {-} x\_min))}
     
    \ControlFlowTok{return}\NormalTok{ [(y }\OperatorTok{{-}}\NormalTok{ x\_min) }\OperatorTok{/}\NormalTok{ (x\_max }\OperatorTok{{-}}\NormalTok{ x\_min) }\ControlFlowTok{for}\NormalTok{ y }\KeywordTok{in}\NormalTok{ x]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rescale(numbers)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0.7500, 0.0000, 0.5000, 1.0000, 0.5000]
\end{verbatim}

\chapter{McKinney Chapter 3 - Practice for Section
03}\label{mckinney-chapter-3---practice-for-section-03}

\section{Announcements}\label{announcements-5}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Due Friday, 1/19, at 11:59 PM:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Complete \emph{Introduction to Python} course on DataCamp (and
    upload certificate to Canvas)
  \item
    Acknowledge academic integrity statement on Canvas
  \end{enumerate}
\item
  I will record and post the next lecture video on Thursday, 1/18, and
  the associate pre-class quiz is due before class on Tuesday, 1/23
\item
  Start joining groups on Canvas (Canvas \textgreater{} People
  \textgreater{} Team Projects); I removed joining groups as a scored
  assignment, but please prioritize joining groups
\end{enumerate}

\section{10-minute Recap}\label{minute-recap-4}

\subsection{List}\label{list-2}

A list is a collection of items that are ordered and changeable. You can
add, remove, or modify elements in a list. In Python, you can create an
empty list using either \texttt{{[}{]}} or \texttt{list()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_list }\OperatorTok{=}\NormalTok{ [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{]]]}
\end{Highlighting}
\end{Shaded}

\textbf{\emph{Python is zero-indexed!}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_list[}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_list[:}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_list[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{][}\OperatorTok{{-}}\DecValTok{1}\NormalTok{][}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_list[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{][}\OperatorTok{{-}}\DecValTok{1}\NormalTok{][}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{=} \StringTok{\textquotesingle{}McKinney\textquotesingle{}}

\NormalTok{my\_list}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3, [1, 2, 3, [1, 2, 'McKinney']]]
\end{verbatim}

\subsection{Tuple}\label{tuple-2}

A tuple is similar to a list, but it is immutable, meaning that you
cannot change its contents once it has been created. You can create a
tuple using parentheses \texttt{()} or the \texttt{tuple()} function.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_tuple }\OperatorTok{=}\NormalTok{ (}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, (}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, (}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{)))}

\NormalTok{my\_tuple}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(1, 2, 3, (1, 2, 3, (1, 2, 3)))
\end{verbatim}

Unlike lists, tuples are immutable and cannot be changed!

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# my\_tuple[{-}1][{-}1][{-}1] = \textquotesingle{}McKinney\textquotesingle{}}

\CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# TypeError                                 Traceback (most recent call last)}
\CommentTok{\# Cell In[15], line 1}
\CommentTok{\# {-}{-}{-}{-}\textgreater{} 1 my\_tuple[{-}1][{-}1][{-}1] = \textquotesingle{}McKinney\textquotesingle{}}

\CommentTok{\# TypeError: \textquotesingle{}tuple\textquotesingle{} object does not support item assignment}
\end{Highlighting}
\end{Shaded}

The following result is surprising! Tuples are immutable, but a list
nested inside a tuple is mutable!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_tuple\_2 }\OperatorTok{=}\NormalTok{ (}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, (}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{]))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_tuple\_2[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{][}\OperatorTok{{-}}\DecValTok{1}\NormalTok{][}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{=} \StringTok{\textquotesingle{}McKinney\textquotesingle{}}

\NormalTok{my\_tuple\_2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(1, 2, 3, (1, 2, 3, [1, 2, 'McKinney']))
\end{verbatim}

\subsection{Dictionary}\label{dictionary-1}

A dictionary is a collection of key-value pairs that are unordered and
changeable. You can add, remove, or modify elements in a dictionary. In
Python, you can create an empty dictionary using either \texttt{\{\}} or
the \texttt{dict()} function.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stock\_prices }\OperatorTok{=}\NormalTok{ [}\DecValTok{100}\NormalTok{, }\DecValTok{200}\NormalTok{, }\DecValTok{300}\NormalTok{] }\CommentTok{\# AAPL, MSFT, TSLA}
\end{Highlighting}
\end{Shaded}

Dictionaries let us index a value by its key!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stock\_prices }\OperatorTok{=}\NormalTok{ \{}\StringTok{\textquotesingle{}AAPL\textquotesingle{}}\NormalTok{: }\DecValTok{100}\NormalTok{, }\StringTok{\textquotesingle{}MSFT\textquotesingle{}}\NormalTok{: }\DecValTok{200}\NormalTok{, }\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{: }\DecValTok{300}\NormalTok{\}}

\NormalTok{stock\_prices[}\StringTok{\textquotesingle{}AAPL\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
100
\end{verbatim}

\subsection{List Comprehension}\label{list-comprehension-1}

A list comprehension is a concise way of creating a new list by
iterating over an existing list or other iterable object. It is more
time and space-efficient than traditional for loops and offers a cleaner
syntax. The basic syntax of a list comprehension is
\texttt{new\_list\ =\ {[}expression\ for\ item\ in\ iterable\ if\ condition{]}}
where:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \texttt{expression} is the operation to be performed on each element
  of the iterable
\item
  \texttt{item} is the current element being processed
\item
  \texttt{iterable} is the list or other iterable object being iterated
  over
\item
  \texttt{condition} is an optional filter that only accepts items that
  evaluate to True.
\end{enumerate}

For example, we can use the following list comprehension to create a new
list of even numbers from 0 to 8:
\texttt{even\_numbers\ =\ {[}x\ for\ x\ in\ range(9)\ if\ x\ \%\ 2\ ==\ 0{]}}

List comprehensions are a powerful tool in Python that can help you
write more efficient and readable code (i.e., more Pythonic code).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{even\_numbers }\OperatorTok{=}\NormalTok{ []}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{9}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ i}\OperatorTok{\%}\DecValTok{2} \OperatorTok{==} \DecValTok{0}\NormalTok{:}
\NormalTok{        even\_numbers.append(i)}

\NormalTok{even\_numbers}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0, 2, 4, 6, 8]
\end{verbatim}

The list comprehension version of the code above is:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{[i }\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{9}\NormalTok{) }\ControlFlowTok{if}\NormalTok{ i}\OperatorTok{\%}\DecValTok{2} \OperatorTok{==} \DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0, 2, 4, 6, 8]
\end{verbatim}

List comprehensions are ``very Pythonic'' (the code style that other
Python programmers expect).

\section{Practice}\label{practice-5}

\subsection{\texorpdfstring{Swap the values assigned to \texttt{a} and
\texttt{b} using a third variable
\texttt{c}.}{Swap the values assigned to a and b using a third variable c.}}\label{swap-the-values-assigned-to-a-and-b-using-a-third-variable-c.-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=} \DecValTok{1}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=} \DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{c }\OperatorTok{=}\NormalTok{ a}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=}\NormalTok{ b}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=}\NormalTok{ c}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{del}\NormalTok{ c}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}a is }\SpecialCharTok{\{}\NormalTok{a}\SpecialCharTok{\}}\SpecialStringTok{, b is }\SpecialCharTok{\{}\NormalTok{b}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
a is 2, b is 1
\end{verbatim}

\subsection{\texorpdfstring{Swap the values assigned to \texttt{a} and
\texttt{b} \textbf{\emph{without}} using a third variable
\texttt{c}.}{Swap the values assigned to a and b without using a third variable c.}}\label{swap-the-values-assigned-to-a-and-b-without-using-a-third-variable-c.-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=} \DecValTok{1}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=} \DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b, a }\OperatorTok{=}\NormalTok{ a, b}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}a is }\SpecialCharTok{\{}\NormalTok{a}\SpecialCharTok{\}}\SpecialStringTok{, b is }\SpecialCharTok{\{}\NormalTok{b}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
a is 2, b is 1
\end{verbatim}

The code above uses ``f strings''! Here is the non-f-string equivalent:

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(}\StringTok{\textquotesingle{}a is \textquotesingle{}} \OperatorTok{+} \BuiltInTok{str}\NormalTok{(a) }\OperatorTok{+} \StringTok{\textquotesingle{}, b is \textquotesingle{}} \OperatorTok{+} \BuiltInTok{str}\NormalTok{(b))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
a is 2, b is 1
\end{verbatim}

\subsection{What is the output of the following code and
why?}\label{what-is-the-output-of-the-following-code-and-why-1}

The parentheses \texttt{()} around tuples are optional to create tuples,
but avoid ambiguity!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=} \DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}
\BuiltInTok{type}\NormalTok{(\_)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
tuple
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1} \OperatorTok{==}\NormalTok{ (}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(1, 1, False)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{) }\OperatorTok{==} \DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(False, 1, 1)
\end{verbatim}

If we want to remove ambiguity, we should add parentheses \texttt{()} to
both sides.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{) }\OperatorTok{==}\NormalTok{ (}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\subsection{\texorpdfstring{Create a list \texttt{l1} of integers from 1
to
100.}{Create a list l1 of integers from 1 to 100.}}\label{create-a-list-l1-of-integers-from-1-to-100.-1}

Jupyter prints the last line of code in a code cell automatically. In
the next cell, I wrap \texttt{l1} with \texttt{print()} so the list
contents wrap around.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l1 }\OperatorTok{=} \BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{101}\NormalTok{))}
\BuiltInTok{print}\NormalTok{(l1)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100]
\end{verbatim}

\subsection{\texorpdfstring{Slice \texttt{l1} to create a list of
integers from 60 to 50
(inclusive).}{Slice l1 to create a list of integers from 60 to 50 (inclusive).}}\label{slice-l1-to-create-a-list-of-integers-from-60-to-50-inclusive.-1}

Name this list \texttt{l2}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l1.index(}\DecValTok{50}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
49
\end{verbatim}

With zero-indexing, left edges are included and right edges are
excluded. So, right - left is the number of elements in a sequence.

In the code below, the first \texttt{{[}{]}} slices 50 to 60, and the
second \texttt{{[}::-1{]}} reverses.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l2 }\OperatorTok{=}\NormalTok{ l1[}\DecValTok{49}\NormalTok{:}\DecValTok{60}\NormalTok{][::}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}

\NormalTok{l2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[60, 59, 58, 57, 56, 55, 54, 53, 52, 51, 50]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l1[}\DecValTok{59}\NormalTok{:}\DecValTok{48}\NormalTok{:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[60, 59, 58, 57, 56, 55, 54, 53, 52, 51, 50]
\end{verbatim}

\subsection{\texorpdfstring{Create a list \texttt{l3} of odd integers
from 1 to
21.}{Create a list l3 of odd integers from 1 to 21.}}\label{create-a-list-l3-of-odd-integers-from-1-to-21.-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l3 }\OperatorTok{=}\NormalTok{ l1[}\DecValTok{0}\NormalTok{:}\DecValTok{21}\NormalTok{][::}\DecValTok{2}\NormalTok{]}

\NormalTok{l3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l1[}\DecValTok{0}\NormalTok{:}\DecValTok{21}\NormalTok{:}\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{22}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{[i }\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{22}\NormalTok{) }\ControlFlowTok{if}\NormalTok{ i}\OperatorTok{\%}\DecValTok{2} \OperatorTok{!=} \DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21]
\end{verbatim}

What is the advantage of the list comprehension? There is no advantage
in this example, but the list comprehension lets us specify several
conditions and variable step sizes.

\subsection{\texorpdfstring{Create a list \texttt{l4} of the squares of
integers from 1 to
100.}{Create a list l4 of the squares of integers from 1 to 100.}}\label{create-a-list-l4-of-the-squares-of-integers-from-1-to-100.-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l4 }\OperatorTok{=}\NormalTok{ [i}\OperatorTok{**}\DecValTok{2} \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{101}\NormalTok{)]}

\BuiltInTok{print}\NormalTok{(l4)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 4, 9, 16, 25, 36, 49, 64, 81, 100, 121, 144, 169, 196, 225, 256, 289, 324, 361, 400, 441, 484, 529, 576, 625, 676, 729, 784, 841, 900, 961, 1024, 1089, 1156, 1225, 1296, 1369, 1444, 1521, 1600, 1681, 1764, 1849, 1936, 2025, 2116, 2209, 2304, 2401, 2500, 2601, 2704, 2809, 2916, 3025, 3136, 3249, 3364, 3481, 3600, 3721, 3844, 3969, 4096, 4225, 4356, 4489, 4624, 4761, 4900, 5041, 5184, 5329, 5476, 5625, 5776, 5929, 6084, 6241, 6400, 6561, 6724, 6889, 7056, 7225, 7396, 7569, 7744, 7921, 8100, 8281, 8464, 8649, 8836, 9025, 9216, 9409, 9604, 9801, 10000]
\end{verbatim}

\subsection{\texorpdfstring{Create a list \texttt{l5} that contains the
squares of \textbf{\emph{odd}} integers from 1 to
100.}{Create a list l5 that contains the squares of odd integers from 1 to 100.}}\label{create-a-list-l5-that-contains-the-squares-of-odd-integers-from-1-to-100.-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l5 }\OperatorTok{=}\NormalTok{ [i}\OperatorTok{**}\DecValTok{2} \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{101}\NormalTok{) }\ControlFlowTok{if}\NormalTok{ i}\OperatorTok{\%}\DecValTok{2} \OperatorTok{!=} \DecValTok{0}\NormalTok{]}

\BuiltInTok{print}\NormalTok{(l5)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 9, 25, 49, 81, 121, 169, 225, 289, 361, 441, 529, 625, 729, 841, 961, 1089, 1225, 1369, 1521, 1681, 1849, 2025, 2209, 2401, 2601, 2809, 3025, 3249, 3481, 3721, 3969, 4225, 4489, 4761, 5041, 5329, 5625, 5929, 6241, 6561, 6889, 7225, 7569, 7921, 8281, 8649, 9025, 9409, 9801]
\end{verbatim}

\subsection{\texorpdfstring{Use a lambda function to sort
\texttt{strings} by the last
letter.}{Use a lambda function to sort strings by the last letter.}}\label{use-a-lambda-function-to-sort-strings-by-the-last-letter.-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{strings }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}card\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}aaaa\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}foo\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}abab\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

Almost all core Python methods modify the object in place. Here we use
the \texttt{sorted()} function so we can see the output/results more
easily.

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{sorted}\NormalTok{(strings, key}\OperatorTok{=}\BuiltInTok{len}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['foo', 'bar', 'card', 'aaaa', 'abab']
\end{verbatim}

How do we get the last letter in a string?

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}Friday\textquotesingle{}}\NormalTok{[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'y'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ get\_last\_letter(x):}
    \ControlFlowTok{return}\NormalTok{ x[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{get\_last\_letter(}\StringTok{\textquotesingle{}Friday\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'y'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{sorted}\NormalTok{(strings, key}\OperatorTok{=}\NormalTok{get\_last\_letter)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['aaaa', 'abab', 'card', 'foo', 'bar']
\end{verbatim}

We can get the same result without the hassle of writing the
\texttt{get\_last\_letter()} function! Enter, anonymous (or lambda)
functions!

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{sorted}\NormalTok{(strings, key}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['aaaa', 'abab', 'card', 'foo', 'bar']
\end{verbatim}

We can translate \texttt{lambda\ x:\ x{[}-1{]}} into the following:

\begin{verbatim}
def function_that_I_do_not_want_to_use_again(x):
    return x[-1]
\end{verbatim}

\subsection{\texorpdfstring{Given an integer array \texttt{nums} and an
integer \texttt{k}, return the \(k^{th}\) largest element in the
array.}{Given an integer array nums and an integer k, return the k\^{}\{th\} largest element in the array.}}\label{given-an-integer-array-nums-and-an-integer-k-return-the-kth-largest-element-in-the-array.-1}

Note that it is the \(k^{th}\) largest element in the sorted order, not
the \(k^{th}\) distinct element.

Example 1:

Input: \texttt{nums\ =\ {[}3,2,1,5,6,4{]}}, \texttt{k\ =\ 2}\\
Output: \texttt{5}

Example 2:

Input: \texttt{nums\ =\ {[}3,2,3,1,2,4,5,5,6{]}}, \texttt{k\ =\ 4}\\
Output: \texttt{4}

I saw this question on
\href{https://leetcode.com/problems/kth-largest-element-in-an-array/}{LeetCode}.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ get\_largest(x, k):}
    \ControlFlowTok{return} \BuiltInTok{sorted}\NormalTok{(x)[}\OperatorTok{{-}}\NormalTok{k]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{get\_largest(x}\OperatorTok{=}\NormalTok{[}\DecValTok{3}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{5}\NormalTok{,}\DecValTok{6}\NormalTok{,}\DecValTok{4}\NormalTok{], k}\OperatorTok{=}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{get\_largest(x}\OperatorTok{=}\NormalTok{[}\DecValTok{3}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{3}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{,}\DecValTok{5}\NormalTok{,}\DecValTok{5}\NormalTok{,}\DecValTok{6}\NormalTok{], k}\OperatorTok{=}\DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
4
\end{verbatim}

\subsection{\texorpdfstring{Given an integer array \texttt{nums} and an
integer \texttt{k}, return the \texttt{k} most frequent
elements.}{Given an integer array nums and an integer k, return the k most frequent elements.}}\label{given-an-integer-array-nums-and-an-integer-k-return-the-k-most-frequent-elements.-1}

You may return the answer in any order.

Example 1:

Input: \texttt{nums\ =\ {[}1,1,1,2,2,3{]}}, \texttt{k\ =\ 2}\\
Output: \texttt{{[}1,2{]}}

Example 2:

Input: \texttt{nums\ =\ {[}1{]}}, \texttt{k\ =\ 1}\\
Output: \texttt{{[}1{]}}

I saw this question on
\href{https://leetcode.com/problems/top-k-frequent-elements/}{LeetCode}.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ get\_frequent(nums, k):}
\NormalTok{    counts }\OperatorTok{=}\NormalTok{ \{\}}
    \ControlFlowTok{for}\NormalTok{ n }\KeywordTok{in}\NormalTok{ nums:}
        \ControlFlowTok{if}\NormalTok{ n }\KeywordTok{in}\NormalTok{ counts:}
\NormalTok{            counts[n] }\OperatorTok{+=} \DecValTok{1}
        \ControlFlowTok{else}\NormalTok{:}
\NormalTok{            counts[n] }\OperatorTok{=} \DecValTok{1}
    \ControlFlowTok{return}\NormalTok{ [x[}\DecValTok{0}\NormalTok{] }\ControlFlowTok{for}\NormalTok{ x }\KeywordTok{in} \BuiltInTok{sorted}\NormalTok{(counts.items(), key}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\DecValTok{1}\NormalTok{], reverse}\OperatorTok{=}\VariableTok{True}\NormalTok{)[:k]]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{get\_frequent(nums}\OperatorTok{=}\NormalTok{[}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{3}\NormalTok{], k}\OperatorTok{=}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2]
\end{verbatim}

\subsection{Test whether the given strings are
palindromes.}\label{test-whether-the-given-strings-are-palindromes.-1}

Input: \texttt{{[}"aba",\ "no"{]}}\\
Output: \texttt{{[}True,\ False{]}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ is\_palindrome(xs):}
    \ControlFlowTok{return}\NormalTok{ [x }\OperatorTok{==}\NormalTok{ x[::}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\ControlFlowTok{for}\NormalTok{ x }\KeywordTok{in}\NormalTok{ xs]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{is\_palindrome([}\StringTok{"aba"}\NormalTok{, }\StringTok{"no"}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[True, False]
\end{verbatim}

\subsection{\texorpdfstring{Write a function \texttt{returns()} that
accepts lists of prices and dividends and returns a list of
returns.}{Write a function returns() that accepts lists of prices and dividends and returns a list of returns.}}\label{write-a-function-returns-that-accepts-lists-of-prices-and-dividends-and-returns-a-list-of-returns.-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices }\OperatorTok{=}\NormalTok{ [}\DecValTok{100}\NormalTok{, }\DecValTok{150}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{50}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{150}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{150}\NormalTok{]}
\NormalTok{dividends }\OperatorTok{=}\NormalTok{ [}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

This example is one the rare where I use a loop counter.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ returns(p, d):}
\NormalTok{    rs }\OperatorTok{=}\NormalTok{ []}
    \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\BuiltInTok{len}\NormalTok{(p)):}
\NormalTok{        r }\OperatorTok{=}\NormalTok{ (p[i] }\OperatorTok{+}\NormalTok{ d[i] }\OperatorTok{{-}}\NormalTok{ p[i}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]) }\OperatorTok{/}\NormalTok{ p[i}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{        rs.append(r)}
    
    \ControlFlowTok{return}\NormalTok{ rs}
\end{Highlighting}
\end{Shaded}

We can use a magic called \texttt{\%precision} to print fewer decimal
places!

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'%.4f'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns(p}\OperatorTok{=}\NormalTok{prices, d}\OperatorTok{=}\NormalTok{dividends)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0.5100, -0.3267, -0.4900, 1.0400, 0.5200, -0.3200, 0.5200]
\end{verbatim}

Here is a solution that avoids a loop counter and combines a list
comprehension \texttt{zip()} to loop over prices, dividends, and lagged
prices. This solution may be a little more Pythonic, but I find it
harder to follow that our loop-counter solution above.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{[(p }\OperatorTok{+}\NormalTok{ d }\OperatorTok{{-}}\NormalTok{ p\_lag) }\OperatorTok{/}\NormalTok{ p\_lag }\ControlFlowTok{for}\NormalTok{ p, d, p\_lag }\KeywordTok{in} \BuiltInTok{zip}\NormalTok{(prices[}\DecValTok{1}\NormalTok{:], dividends[}\DecValTok{1}\NormalTok{:], prices[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{])]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0.5100, -0.3267, -0.4900, 1.0400, 0.5200, -0.3200, 0.5200]
\end{verbatim}

\subsection{\texorpdfstring{Rewrite the function \texttt{returns()} so
it returns lists of returns, capital gains yields, and dividend
yields.}{Rewrite the function returns() so it returns lists of returns, capital gains yields, and dividend yields.}}\label{rewrite-the-function-returns-so-it-returns-lists-of-returns-capital-gains-yields-and-dividend-yields.-1}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ returns\_2(p, d):}
\NormalTok{    rs, dps, cgs }\OperatorTok{=}\NormalTok{ [], [], []}
    \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\BuiltInTok{len}\NormalTok{(p)):}
\NormalTok{        r }\OperatorTok{=}\NormalTok{ (p[i] }\OperatorTok{+}\NormalTok{ d[i] }\OperatorTok{{-}}\NormalTok{ p[i}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]) }\OperatorTok{/}\NormalTok{ p[i}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{        dp }\OperatorTok{=}\NormalTok{ d[i] }\OperatorTok{/}\NormalTok{ p[i}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{        cg }\OperatorTok{=}\NormalTok{ r }\OperatorTok{{-}}\NormalTok{ dp}
\NormalTok{        rs.append(r)}
\NormalTok{        dps.append(dp)}
\NormalTok{        cgs.append(cg)}
    
    \ControlFlowTok{return}\NormalTok{ \{}\StringTok{\textquotesingle{}r\textquotesingle{}}\NormalTok{:rs, }\StringTok{\textquotesingle{}dp\textquotesingle{}}\NormalTok{:dps, }\StringTok{\textquotesingle{}cg\textquotesingle{}}\NormalTok{:cgs\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2(p}\OperatorTok{=}\NormalTok{prices, d}\OperatorTok{=}\NormalTok{dividends)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
{'r': [0.5100, -0.3267, -0.4900, 1.0400, 0.5200, -0.3200, 0.5200],
 'dp': [0.0100, 0.0067, 0.0100, 0.0400, 0.0200, 0.0133, 0.0200],
 'cg': [0.5000, -0.3333, -0.5000, 1.0000, 0.5000, -0.3333, 0.5000]}
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2(p}\OperatorTok{=}\NormalTok{prices, d}\OperatorTok{=}\NormalTok{dividends)[}\StringTok{\textquotesingle{}r\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0.5100, -0.3267, -0.4900, 1.0400, 0.5200, -0.3200, 0.5200]
\end{verbatim}

\subsection{\texorpdfstring{Rescale and shift numbers so that they cover
the range
\texttt{{[}0,\ 1{]}}.}{Rescale and shift numbers so that they cover the range {[}0, 1{]}.}}\label{rescale-and-shift-numbers-so-that-they-cover-the-range-0-1.-1}

Input: \texttt{{[}18.5,\ 17.0,\ 18.0,\ 19.0,\ 18.0{]}}\\
Output: \texttt{{[}0.75,\ 0.0,\ 0.5,\ 1.0,\ 0.5{]}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OperatorTok{=}\NormalTok{ [}\FloatTok{18.5}\NormalTok{, }\FloatTok{17.0}\NormalTok{, }\FloatTok{18.0}\NormalTok{, }\FloatTok{19.0}\NormalTok{, }\FloatTok{18.0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ rescale(x):}
\NormalTok{    x\_min }\OperatorTok{=} \BuiltInTok{min}\NormalTok{(x)}
\NormalTok{    x\_max }\OperatorTok{=} \BuiltInTok{max}\NormalTok{(x)}
    \ControlFlowTok{return}\NormalTok{ [(i }\OperatorTok{{-}}\NormalTok{ x\_min) }\OperatorTok{/}\NormalTok{ (x\_max }\OperatorTok{{-}}\NormalTok{ x\_min) }\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ x]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rescale(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0.7500, 0.0000, 0.5000, 1.0000, 0.5000]
\end{verbatim}

Now we can rescale any list!

\chapter{McKinney Chapter 3 - Practice for Section
04}\label{mckinney-chapter-3---practice-for-section-04}

\section{Announcements}\label{announcements-6}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Due Friday, 1/19, at 11:59 PM:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Complete \emph{Introduction to Python} course on DataCamp (and
    upload certificate to Canvas)
  \item
    Acknowledge academic integrity statement on Canvas
  \end{enumerate}
\item
  I will record and post the next lecture video on Thursday, 1/18, and
  the associate pre-class quiz is due before class on Tuesday, 1/23
\item
  Start joining groups on Canvas (Canvas \textgreater{} People
  \textgreater{} Team Projects); I removed joining groups as a scored
  assignment, but please prioritize joining groups
\end{enumerate}

\section{10-minute Recap}\label{minute-recap-5}

\subsection{List}\label{list-3}

A list is a collection of items that are ordered and changeable. You can
add, remove, or modify elements in a list. In Python, you can create an
empty list using either \texttt{{[}{]}} or \texttt{list()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_list }\OperatorTok{=}\NormalTok{ [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{]]]}
\end{Highlighting}
\end{Shaded}

\textbf{\emph{Python is zero-indexed!}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_list[}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2
\end{verbatim}

We can chain index operations!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_list[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{][}\OperatorTok{{-}}\DecValTok{1}\NormalTok{][}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_list[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{][}\OperatorTok{{-}}\DecValTok{1}\NormalTok{][}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{=} \StringTok{\textquotesingle{}Foobar\textquotesingle{}}

\NormalTok{my\_list}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3, [1, 2, 3, [1, 2, 'Foobar']]]
\end{verbatim}

\subsection{Tuple}\label{tuple-3}

A tuple is similar to a list, but it is immutable, meaning that you
cannot change its contents once it has been created. You can create a
tuple using parentheses \texttt{()} or the \texttt{tuple()} function.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_tuple }\OperatorTok{=}\NormalTok{ (}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, (}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, (}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{)))}
\end{Highlighting}
\end{Shaded}

Tuples are immutable and cannot be changed!

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# my\_tuple[{-}1][{-}1][{-}1] = \textquotesingle{}Foobar\textquotesingle{}}
\CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# TypeError                                 Traceback (most recent call last)}
\CommentTok{\# Cell In[10], line 1}
\CommentTok{\# {-}{-}{-}{-}\textgreater{} 1 my\_tuple[{-}1][{-}1][{-}1] = \textquotesingle{}Foobar\textquotesingle{}}

\CommentTok{\# TypeError: \textquotesingle{}tuple\textquotesingle{} object does not support item assignment}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_tuple\_2 }\OperatorTok{=}\NormalTok{ (}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, (}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{]))}
\end{Highlighting}
\end{Shaded}

We cannot change the tuple, but we can change the list \emph{inside} the
tuple.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_tuple\_2[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{][}\OperatorTok{{-}}\DecValTok{1}\NormalTok{][}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{=} \StringTok{\textquotesingle{}Foobar\textquotesingle{}}

\NormalTok{my\_tuple\_2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(1, 2, 3, (1, 2, 3, [1, 2, 'Foobar']))
\end{verbatim}

Here is a crazy-making example of when we might want to use tuples
instead of lists to prevent modifying \texttt{my\_list}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_list}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3, [1, 2, 3, [1, 2, 'Foobar']]]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ foobar():}
\NormalTok{    my\_list[}\DecValTok{0}\NormalTok{] }\OperatorTok{+=} \DecValTok{7}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{foobar()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_list}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[8, 2, 3, [1, 2, 3, [1, 2, 'Foobar']]]
\end{verbatim}

\subsection{Dictionary}\label{dictionary-2}

A dictionary is a collection of key-value pairs that are unordered and
changeable. You can add, remove, or modify elements in a dictionary. In
Python, you can create an empty dictionary using either \texttt{\{\}} or
the \texttt{dict()} function.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stock\_prices }\OperatorTok{=}\NormalTok{ [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{] }\CommentTok{\# AAPL, MSFT, and TSLA}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stock\_prices }\OperatorTok{=}\NormalTok{ \{}\StringTok{\textquotesingle{}AAPL\textquotesingle{}}\NormalTok{: }\DecValTok{1}\NormalTok{, }\StringTok{\textquotesingle{}MSFT\textquotesingle{}}\NormalTok{: }\DecValTok{2}\NormalTok{, }\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{: }\DecValTok{3}\NormalTok{\}}

\NormalTok{stock\_prices[}\StringTok{\textquotesingle{}AAPL\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1
\end{verbatim}

\subsection{List Comprehension}\label{list-comprehension-2}

A list comprehension is a concise way of creating a new list by
iterating over an existing list or other iterable object. It is more
time and space-efficient than traditional for loops and offers a cleaner
syntax. The basic syntax of a list comprehension is
\texttt{new\_list\ =\ {[}expression\ for\ item\ in\ iterable\ if\ condition{]}}
where:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \texttt{expression} is the operation to be performed on each element
  of the iterable
\item
  \texttt{item} is the current element being processed
\item
  \texttt{iterable} is the list or other iterable object being iterated
  over
\item
  \texttt{condition} is an optional filter that only accepts items that
  evaluate to True.
\end{enumerate}

For example, we can use the following list comprehension to create a new
list of even numbers from 0 to 8:
\texttt{even\_numbers\ =\ {[}x\ for\ x\ in\ range(9)\ if\ x\ \%\ 2\ ==\ 0{]}}

List comprehensions are a powerful tool in Python that can help you
write more efficient and readable code (i.e., more Pythonic code).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{even\_numbers }\OperatorTok{=}\NormalTok{ []}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{9}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ i}\OperatorTok{\%}\DecValTok{2} \OperatorTok{==} \DecValTok{0}\NormalTok{:}
\NormalTok{        even\_numbers.append(i)}

\NormalTok{even\_numbers}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0, 2, 4, 6, 8]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%\%}\NormalTok{timeit}
\NormalTok{[i }\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{9}\NormalTok{) }\ControlFlowTok{if}\NormalTok{ i}\OperatorTok{\%}\DecValTok{2} \OperatorTok{==} \DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
405 ns ± 23.3 ns per loop (mean ± std. dev. of 7 runs, 1,000,000 loops each)
\end{verbatim}

Here is another way to get even up to 8:

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%\%}\NormalTok{timeit}
\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{9}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
152 ns ± 7.38 ns per loop (mean ± std. dev. of 7 runs, 10,000,000 loops each)
\end{verbatim}

The first is more flexible and allows testing multiple conditions. The
second is more streamlined. Above, we use the \texttt{\%\%timeit} magic
to time our code, but, remember, premature optimization is the root of
all evil!

\section{Practice}\label{practice-6}

\subsection{\texorpdfstring{Swap the values assigned to \texttt{a} and
\texttt{b} using a third variable
\texttt{c}.}{Swap the values assigned to a and b using a third variable c.}}\label{swap-the-values-assigned-to-a-and-b-using-a-third-variable-c.-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=} \DecValTok{1}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=} \DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{c }\OperatorTok{=}\NormalTok{ a}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=}\NormalTok{ b}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=}\NormalTok{ c}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{del}\NormalTok{ c}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}a is }\SpecialCharTok{\{}\NormalTok{a}\SpecialCharTok{\}}\SpecialStringTok{, and b is }\SpecialCharTok{\{}\NormalTok{b}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
a is 2, and b is 1
\end{verbatim}

\subsection{\texorpdfstring{Swap the values assigned to \texttt{a} and
\texttt{b} \textbf{\emph{without}} using a third variable
\texttt{c}.}{Swap the values assigned to a and b without using a third variable c.}}\label{swap-the-values-assigned-to-a-and-b-without-using-a-third-variable-c.-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=} \DecValTok{1}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=} \DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b, a }\OperatorTok{=}\NormalTok{ a, b}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}a is }\SpecialCharTok{\{}\NormalTok{a}\SpecialCharTok{\}}\SpecialStringTok{, and b is }\SpecialCharTok{\{}\NormalTok{b}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
a is 2, and b is 1
\end{verbatim}

\subsection{What is the output of the following code and
why?}\label{what-is-the-output-of-the-following-code-and-why-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=} \DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}

\BuiltInTok{type}\NormalTok{(\_)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
tuple
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1} \OperatorTok{==}\NormalTok{ (}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(1, 1, False)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{) }\OperatorTok{==} \DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(False, 1, 1)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{) }\OperatorTok{==}\NormalTok{ (}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\textbf{\emph{Parentheses around tuples are optional, but eliminate
ambiguity!}} Also, always check your output!

\subsection{\texorpdfstring{Create a list \texttt{l1} of integers from 1
to
100.}{Create a list l1 of integers from 1 to 100.}}\label{create-a-list-l1-of-integers-from-1-to-100.-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l1 }\OperatorTok{=} \BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{101}\NormalTok{))}

\BuiltInTok{print}\NormalTok{(l1) }\CommentTok{\# we can use print to print a list with less white space}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100]
\end{verbatim}

\subsection{\texorpdfstring{Slice \texttt{l1} to create a list of
integers from 60 to 50
(inclusive).}{Slice l1 to create a list of integers from 60 to 50 (inclusive).}}\label{slice-l1-to-create-a-list-of-integers-from-60-to-50-inclusive.-2}

Name this list \texttt{l2}.

Below, there are two steps:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The \texttt{{[}49:60{]}} slices from 50 to 60
\item
  The \texttt{{[}::-1{]}} reverse the list
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l2 }\OperatorTok{=}\NormalTok{ l1[}\DecValTok{49}\NormalTok{:}\DecValTok{60}\NormalTok{][::}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}

\NormalTok{l2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[60, 59, 58, 57, 56, 55, 54, 53, 52, 51, 50]
\end{verbatim}

Most methods on core Python data structures modify the data structure
``in place''.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l2\_alt }\OperatorTok{=}\NormalTok{ l1[}\DecValTok{49}\NormalTok{:}\DecValTok{60}\NormalTok{]}
\NormalTok{l2\_alt.reverse()}

\NormalTok{l2\_alt}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[60, 59, 58, 57, 56, 55, 54, 53, 52, 51, 50]
\end{verbatim}

\subsection{\texorpdfstring{Create a list \texttt{l3} of odd integers
from 1 to
21.}{Create a list l3 of odd integers from 1 to 21.}}\label{create-a-list-l3-of-odd-integers-from-1-to-21.-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l3 }\OperatorTok{=}\NormalTok{ [i }\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{22}\NormalTok{) }\ControlFlowTok{if}\NormalTok{ i}\OperatorTok{\%}\DecValTok{2} \OperatorTok{!=} \DecValTok{0}\NormalTok{]}

\NormalTok{l3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{22}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21]
\end{verbatim}

\subsection{\texorpdfstring{Create a list \texttt{l4} of the squares of
integers from 1 to
100.}{Create a list l4 of the squares of integers from 1 to 100.}}\label{create-a-list-l4-of-the-squares-of-integers-from-1-to-100.-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l4 }\OperatorTok{=}\NormalTok{ [i}\OperatorTok{**}\DecValTok{2} \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{101}\NormalTok{)]}

\BuiltInTok{print}\NormalTok{(l4)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 4, 9, 16, 25, 36, 49, 64, 81, 100, 121, 144, 169, 196, 225, 256, 289, 324, 361, 400, 441, 484, 529, 576, 625, 676, 729, 784, 841, 900, 961, 1024, 1089, 1156, 1225, 1296, 1369, 1444, 1521, 1600, 1681, 1764, 1849, 1936, 2025, 2116, 2209, 2304, 2401, 2500, 2601, 2704, 2809, 2916, 3025, 3136, 3249, 3364, 3481, 3600, 3721, 3844, 3969, 4096, 4225, 4356, 4489, 4624, 4761, 4900, 5041, 5184, 5329, 5476, 5625, 5776, 5929, 6084, 6241, 6400, 6561, 6724, 6889, 7056, 7225, 7396, 7569, 7744, 7921, 8100, 8281, 8464, 8649, 8836, 9025, 9216, 9409, 9604, 9801, 10000]
\end{verbatim}

\subsection{\texorpdfstring{Create a list \texttt{l5} that contains the
squares of \textbf{\emph{odd}} integers from 1 to
100.}{Create a list l5 that contains the squares of odd integers from 1 to 100.}}\label{create-a-list-l5-that-contains-the-squares-of-odd-integers-from-1-to-100.-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l5 }\OperatorTok{=}\NormalTok{ [i}\OperatorTok{**}\DecValTok{2} \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{101}\NormalTok{) }\ControlFlowTok{if}\NormalTok{ i}\OperatorTok{\%}\DecValTok{2} \OperatorTok{!=} \DecValTok{0}\NormalTok{]}

\BuiltInTok{print}\NormalTok{(l5)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 9, 25, 49, 81, 121, 169, 225, 289, 361, 441, 529, 625, 729, 841, 961, 1089, 1225, 1369, 1521, 1681, 1849, 2025, 2209, 2401, 2601, 2809, 3025, 3249, 3481, 3721, 3969, 4225, 4489, 4761, 5041, 5329, 5625, 5929, 6241, 6561, 6889, 7225, 7569, 7921, 8281, 8649, 9025, 9409, 9801]
\end{verbatim}

\subsection{\texorpdfstring{Use a lambda function to sort
\texttt{strings} by the last
letter.}{Use a lambda function to sort strings by the last letter.}}\label{use-a-lambda-function-to-sort-strings-by-the-last-letter.-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{strings }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}card\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}aaaa\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}foo\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}abab\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

Most core Python methods modify their object \emph{in place}. Here we
will use \texttt{sorted()}, which is the function equivalent of the
\texttt{.sort()} method. Using the function helps us focus on the
output.

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{sorted}\NormalTok{(strings, key}\OperatorTok{=}\BuiltInTok{len}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['foo', 'bar', 'card', 'aaaa', 'abab']
\end{verbatim}

What if, we want sort by length, then by alphabetical order within
length?

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Sort by alphabetical order
\item
  Then, sort by length
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{sorted}\NormalTok{(}\BuiltInTok{sorted}\NormalTok{(strings), key}\OperatorTok{=}\BuiltInTok{len}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['bar', 'foo', 'aaaa', 'abab', 'card']
\end{verbatim}

Just like we get the last element in a list or tuple with
\texttt{{[}-1{]}}, we get the last character in a string with
\texttt{{[}-1{]}}!

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}Friday!\textquotesingle{}}\NormalTok{[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'!'
\end{verbatim}

How can I reverse a string?

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}Friday!\textquotesingle{}}\NormalTok{[::}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'!yadirF'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ get\_last\_letter(x):}
    \ControlFlowTok{return}\NormalTok{ x[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{get\_last\_letter(}\StringTok{\textquotesingle{}Friday!\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'!'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{sorted}\NormalTok{(strings, key}\OperatorTok{=}\NormalTok{get\_last\_letter)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['aaaa', 'abab', 'card', 'foo', 'bar']
\end{verbatim}

For cases when would only use a function once, we can skip all the
overhead of writing a function and use an anonymous function (or a
lambda function).

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{sorted}\NormalTok{(strings, key}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['aaaa', 'abab', 'card', 'foo', 'bar']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{sorted}\NormalTok{(strings, key}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['card', 'aaaa', 'bar', 'abab', 'foo']
\end{verbatim}

Here \texttt{lambda} is a keyword that indicates what follows in a
nameless function that only exists in this specific context.

\subsection{\texorpdfstring{Given an integer array \texttt{nums} and an
integer \texttt{k}, return the \(k^{th}\) largest element in the
array.}{Given an integer array nums and an integer k, return the k\^{}\{th\} largest element in the array.}}\label{given-an-integer-array-nums-and-an-integer-k-return-the-kth-largest-element-in-the-array.-2}

Note that it is the \(k^{th}\) largest element in the sorted order, not
the \(k^{th}\) distinct element.

Example 1:

Input: \texttt{nums\ =\ {[}3,2,1,5,6,4{]}}, \texttt{k\ =\ 2}\\
Output: \texttt{5}

Example 2:

Input: \texttt{nums\ =\ {[}3,2,3,1,2,4,5,5,6{]}}, \texttt{k\ =\ 4}\\
Output: \texttt{4}

I saw this question on
\href{https://leetcode.com/problems/kth-largest-element-in-an-array/}{LeetCode}.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ get\_largest(x, k):}
    \ControlFlowTok{return} \BuiltInTok{sorted}\NormalTok{(x)[}\OperatorTok{{-}}\NormalTok{k]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{get\_largest(x}\OperatorTok{=}\NormalTok{[}\DecValTok{3}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{5}\NormalTok{,}\DecValTok{6}\NormalTok{,}\DecValTok{4}\NormalTok{], k}\OperatorTok{=}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{get\_largest(x}\OperatorTok{=}\NormalTok{[}\DecValTok{3}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{3}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{,}\DecValTok{5}\NormalTok{,}\DecValTok{5}\NormalTok{,}\DecValTok{6}\NormalTok{], k}\OperatorTok{=}\DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
4
\end{verbatim}

\subsection{\texorpdfstring{Given an integer array \texttt{nums} and an
integer \texttt{k}, return the \texttt{k} most frequent
elements.}{Given an integer array nums and an integer k, return the k most frequent elements.}}\label{given-an-integer-array-nums-and-an-integer-k-return-the-k-most-frequent-elements.-2}

You may return the answer in any order.

Example 1:

Input: \texttt{nums\ =\ {[}1,1,1,2,2,3{]}}, \texttt{k\ =\ 2}\\
Output: \texttt{{[}1,2{]}}

Example 2:

Input: \texttt{nums\ =\ {[}1{]}}, \texttt{k\ =\ 1}\\
Output: \texttt{{[}1{]}}

I saw this question on
\href{https://leetcode.com/problems/top-k-frequent-elements/}{LeetCode}.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ get\_frequent(nums, k):}
\NormalTok{    counts }\OperatorTok{=}\NormalTok{ \{\}}
    \ControlFlowTok{for}\NormalTok{ n }\KeywordTok{in}\NormalTok{ nums:}
        \ControlFlowTok{if}\NormalTok{ n }\KeywordTok{in}\NormalTok{ counts:}
\NormalTok{            counts[n] }\OperatorTok{+=} \DecValTok{1}
        \ControlFlowTok{else}\NormalTok{:}
\NormalTok{            counts[n] }\OperatorTok{=} \DecValTok{1}
    \ControlFlowTok{return}\NormalTok{ [x[}\DecValTok{0}\NormalTok{] }\ControlFlowTok{for}\NormalTok{ x }\KeywordTok{in} \BuiltInTok{sorted}\NormalTok{(counts.items(), key}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\DecValTok{1}\NormalTok{], reverse}\OperatorTok{=}\VariableTok{True}\NormalTok{)[:k]]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{get\_frequent(nums}\OperatorTok{=}\NormalTok{[}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{3}\NormalTok{], k}\OperatorTok{=}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2]
\end{verbatim}

\subsection{Test whether the given strings are
palindromes.}\label{test-whether-the-given-strings-are-palindromes.-2}

Input: \texttt{{[}"aba",\ "no"{]}}\\
Output: \texttt{{[}True,\ False{]}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ is\_palindrome(xs):}
    \ControlFlowTok{return}\NormalTok{ [x }\OperatorTok{==}\NormalTok{ x[::}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\ControlFlowTok{for}\NormalTok{ x }\KeywordTok{in}\NormalTok{ xs]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{is\_palindrome([}\StringTok{"aba"}\NormalTok{, }\StringTok{"no"}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[True, False]
\end{verbatim}

\subsection{\texorpdfstring{Write a function \texttt{returns()} that
accepts lists of prices and dividends and returns a list of
returns.}{Write a function returns() that accepts lists of prices and dividends and returns a list of returns.}}\label{write-a-function-returns-that-accepts-lists-of-prices-and-dividends-and-returns-a-list-of-returns.-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices }\OperatorTok{=}\NormalTok{ [}\DecValTok{100}\NormalTok{, }\DecValTok{150}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{50}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{150}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{150}\NormalTok{]}
\NormalTok{dividends }\OperatorTok{=}\NormalTok{ [}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ returns(p, d):}
\NormalTok{    rs }\OperatorTok{=}\NormalTok{ []}
    \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\BuiltInTok{len}\NormalTok{(p)):}
\NormalTok{        r }\OperatorTok{=}\NormalTok{ (p[i] }\OperatorTok{{-}}\NormalTok{ p[i}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{+}\NormalTok{ d[i]) }\OperatorTok{/}\NormalTok{ p[i}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{        rs.append(r)}
    \ControlFlowTok{return}\NormalTok{ rs}
\end{Highlighting}
\end{Shaded}

We can use the magic \texttt{\%precision\ 4} to display floats to only 4
decimal places.

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'%.4f'
\end{verbatim}

We have 2+ arguments, it is a good practice to specify argument names
(or keywords).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns(p}\OperatorTok{=}\NormalTok{prices, d}\OperatorTok{=}\NormalTok{dividends)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0.5100, -0.3267, -0.4900, 1.0400, 0.5200, -0.3200, 0.5200]
\end{verbatim}

Here is a solution that avoids a loop counter and combines a list
comprehension \texttt{zip()} to loop over prices, dividends, and lagged
prices. This solution may be a little more Pythonic, but I find it
harder to follow that our loop-counter solution above.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{[(p }\OperatorTok{+}\NormalTok{ d }\OperatorTok{{-}}\NormalTok{ p\_lag) }\OperatorTok{/}\NormalTok{ p\_lag }\ControlFlowTok{for}\NormalTok{ p, d, p\_lag }\KeywordTok{in} \BuiltInTok{zip}\NormalTok{(prices[}\DecValTok{1}\NormalTok{:], dividends[}\DecValTok{1}\NormalTok{:], prices[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{])]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0.5100, -0.3267, -0.4900, 1.0400, 0.5200, -0.3200, 0.5200]
\end{verbatim}

\subsection{\texorpdfstring{Rewrite the function \texttt{returns()} so
it returns lists of returns, capital gains yields, and dividend
yields.}{Rewrite the function returns() so it returns lists of returns, capital gains yields, and dividend yields.}}\label{rewrite-the-function-returns-so-it-returns-lists-of-returns-capital-gains-yields-and-dividend-yields.-2}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ returns\_2(p, d):}
\NormalTok{    rs, dps, cgs }\OperatorTok{=}\NormalTok{ [], [], []}
    \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\BuiltInTok{len}\NormalTok{(p)):}
\NormalTok{        r }\OperatorTok{=}\NormalTok{ (p[i] }\OperatorTok{{-}}\NormalTok{ p[i}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{+}\NormalTok{ d[i]) }\OperatorTok{/}\NormalTok{ p[i}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{        dp }\OperatorTok{=}\NormalTok{ d[i] }\OperatorTok{/}\NormalTok{ p[i}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{        cg }\OperatorTok{=}\NormalTok{ r }\OperatorTok{{-}}\NormalTok{ dp}
\NormalTok{        rs.append(r)}
\NormalTok{        dps.append(dp)}
\NormalTok{        cgs.append(cg)}
    \ControlFlowTok{return}\NormalTok{ \{}\StringTok{\textquotesingle{}r\textquotesingle{}}\NormalTok{:rs, }\StringTok{\textquotesingle{}dp\textquotesingle{}}\NormalTok{:dps, }\StringTok{\textquotesingle{}cg\textquotesingle{}}\NormalTok{:cgs\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2(p}\OperatorTok{=}\NormalTok{prices, d}\OperatorTok{=}\NormalTok{dividends)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
{'r': [0.5100, -0.3267, -0.4900, 1.0400, 0.5200, -0.3200, 0.5200],
 'dp': [0.0100, 0.0067, 0.0100, 0.0400, 0.0200, 0.0133, 0.0200],
 'cg': [0.5000, -0.3333, -0.5000, 1.0000, 0.5000, -0.3333, 0.5000]}
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2(p}\OperatorTok{=}\NormalTok{prices, d}\OperatorTok{=}\NormalTok{dividends)[}\StringTok{\textquotesingle{}r\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0.5100, -0.3267, -0.4900, 1.0400, 0.5200, -0.3200, 0.5200]
\end{verbatim}

\subsection{\texorpdfstring{Rescale and shift numbers so that they cover
the range
\texttt{{[}0,\ 1{]}}.}{Rescale and shift numbers so that they cover the range {[}0, 1{]}.}}\label{rescale-and-shift-numbers-so-that-they-cover-the-range-0-1.-2}

Input: \texttt{{[}18.5,\ 17.0,\ 18.0,\ 19.0,\ 18.0{]}}\\
Output: \texttt{{[}0.75,\ 0.0,\ 0.5,\ 1.0,\ 0.5{]}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OperatorTok{=}\NormalTok{ [}\FloatTok{18.5}\NormalTok{, }\FloatTok{17.0}\NormalTok{, }\FloatTok{18.0}\NormalTok{, }\FloatTok{19.0}\NormalTok{, }\FloatTok{18.0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ rescale(x):}
\NormalTok{    x\_min }\OperatorTok{=} \BuiltInTok{min}\NormalTok{(x)}
\NormalTok{    x\_max }\OperatorTok{=} \BuiltInTok{max}\NormalTok{(x)}
    \ControlFlowTok{return}\NormalTok{ [(i }\OperatorTok{{-}}\NormalTok{ x\_min) }\OperatorTok{/}\NormalTok{ (x\_max }\OperatorTok{{-}}\NormalTok{ x\_min) }\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ x]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x\_rescaled }\OperatorTok{=}\NormalTok{ rescale(x)}

\NormalTok{x\_rescaled}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0.7500, 0.0000, 0.5000, 1.0000, 0.5000]
\end{verbatim}

\chapter{McKinney Chapter 3 - Practice for Section
05}\label{mckinney-chapter-3---practice-for-section-05}

\section{Announcements}\label{announcements-7}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Due Friday, 1/19, at 11:59 PM:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Complete \emph{Introduction to Python} course on DataCamp (and
    upload certificate to Canvas)
  \item
    Acknowledge academic integrity statement on Canvas
  \end{enumerate}
\item
  I will record and post the next lecture video on Thursday, 1/18, and
  the associate pre-class quiz is due before class on Tuesday, 1/23
\item
  Start joining groups on Canvas (Canvas \textgreater{} People
  \textgreater{} Team Projects); I removed joining groups as a scored
  assignment, but please prioritize joining groups
\end{enumerate}

\section{10-minute Recap}\label{minute-recap-6}

\subsection{List}\label{list-4}

A list is a collection of items that are ordered and changeable. You can
add, remove, or modify elements in a list. In Python, you can create an
empty list using either \texttt{{[}{]}} or \texttt{list()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_list }\OperatorTok{=}\NormalTok{ [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{]]]}

\NormalTok{my\_list}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3, [1, 2, 3, [1, 2, 3]]]
\end{verbatim}

\textbf{\emph{Python is zero-indexed!}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_list[}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2
\end{verbatim}

We can chain indexes!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_list[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{][}\OperatorTok{{-}}\DecValTok{1}\NormalTok{][}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_list[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{][}\OperatorTok{{-}}\DecValTok{1}\NormalTok{][}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{=} \DecValTok{2\_001}

\NormalTok{my\_list}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3, [1, 2, 3, [1, 2, 2001]]]
\end{verbatim}

\subsection{Tuple}\label{tuple-4}

A tuple is similar to a list, but it is immutable, meaning that you
cannot change its contents once it has been created. You can create a
tuple using parentheses \texttt{()} or the \texttt{tuple()} function.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_tuple }\OperatorTok{=}\NormalTok{ (}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, (}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, (}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{)))}

\NormalTok{my\_tuple}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(1, 2, 3, (1, 2, 3, (1, 2, 3)))
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_tuple[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{][}\OperatorTok{{-}}\DecValTok{1}\NormalTok{][}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
3
\end{verbatim}

\textbf{\emph{Tuples are immutable, so they cannot be changed!}}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# my\_tuple[{-}1][{-}1][{-}1] = 2\_001}
\CommentTok{\# {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# TypeError                                 Traceback (most recent call last)}
\CommentTok{\# Cell In[12], line 1}
\CommentTok{\# {-}{-}{-}{-}\textgreater{} 1 my\_tuple[{-}1][{-}1][{-}1] = 2\_001}

\CommentTok{\# TypeError: \textquotesingle{}tuple\textquotesingle{} object does not support item assignment}
\end{Highlighting}
\end{Shaded}

\subsection{Dictionary}\label{dictionary-3}

A dictionary is a collection of key-value pairs that are unordered and
changeable. You can add, remove, or modify elements in a dictionary. In
Python, you can create an empty dictionary using either \texttt{\{\}} or
the \texttt{dict()} function.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_dict }\OperatorTok{=}\NormalTok{ \{}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{: }\DecValTok{1}\NormalTok{, }\StringTok{\textquotesingle{}B\textquotesingle{}}\NormalTok{: }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{: }\DecValTok{2\_001}\NormalTok{, }\StringTok{\textquotesingle{}D\textquotesingle{}}\NormalTok{: [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{]\}}

\NormalTok{my\_dict}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
{'A': 1, 'B': 2, 3: 2001, 'D': [1, 2, 3]}
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_dict[}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_dict[}\StringTok{\textquotesingle{}E\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ [}\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{6}\NormalTok{]}

\NormalTok{my\_dict}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
{'A': 1, 'B': 2, 3: 2001, 'D': [1, 2, 3], 'E': [4, 5, 6]}
\end{verbatim}

\subsection{List Comprehension}\label{list-comprehension-3}

A list comprehension is a concise way of creating a new list by
iterating over an existing list or other iterable object. It is more
time and space-efficient than traditional for loops and offers a cleaner
syntax. The basic syntax of a list comprehension is
\texttt{new\_list\ =\ {[}expression\ for\ item\ in\ iterable\ if\ condition{]}}
where:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \texttt{expression} is the operation to be performed on each element
  of the iterable
\item
  \texttt{item} is the current element being processed
\item
  \texttt{iterable} is the list or other iterable object being iterated
  over
\item
  \texttt{condition} is an optional filter that only accepts items that
  evaluate to True.
\end{enumerate}

For example, we can use the following list comprehension to create a new
list of even numbers from 0 to 8:
\texttt{even\_numbers\ =\ {[}x\ for\ x\ in\ range(9)\ if\ x\ \%\ 2\ ==\ 0{]}}

List comprehensions are a powerful tool in Python that can help you
write more efficient and readable code (i.e., more Pythonic code).

What if we wanted multiples of 3 from 1 to 25?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{[i }\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{26}\NormalTok{) }\ControlFlowTok{if}\NormalTok{ i}\OperatorTok{\%}\DecValTok{3} \OperatorTok{==} \DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[3, 6, 9, 12, 15, 18, 21, 24]
\end{verbatim}

The list comprehension above is a simplification of:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{empty\_list }\OperatorTok{=}\NormalTok{ []}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{26}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ i}\OperatorTok{\%}\DecValTok{3} \OperatorTok{==} \DecValTok{0}\NormalTok{:}
\NormalTok{        empty\_list.append(i)}

\NormalTok{empty\_list}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[3, 6, 9, 12, 15, 18, 21, 24]
\end{verbatim}

\section{Practice}\label{practice-7}

\subsection{\texorpdfstring{Swap the values assigned to \texttt{a} and
\texttt{b} using a third variable
\texttt{c}.}{Swap the values assigned to a and b using a third variable c.}}\label{swap-the-values-assigned-to-a-and-b-using-a-third-variable-c.-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=} \DecValTok{1}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=} \DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{c }\OperatorTok{=}\NormalTok{ a}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=}\NormalTok{ b}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=}\NormalTok{ c}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{del}\NormalTok{ c}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}Variable a is }\SpecialCharTok{\{}\NormalTok{a}\SpecialCharTok{\}}\SpecialStringTok{, and variable b is }\SpecialCharTok{\{}\NormalTok{b}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Variable a is 2, and variable b is 1
\end{verbatim}

\subsection{\texorpdfstring{Swap the values assigned to \texttt{a} and
\texttt{b} \textbf{\emph{without}} using a third variable
\texttt{c}.}{Swap the values assigned to a and b without using a third variable c.}}\label{swap-the-values-assigned-to-a-and-b-without-using-a-third-variable-c.-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=} \DecValTok{1}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=} \DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b, a }\OperatorTok{=}\NormalTok{ a, b}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}Variable a is }\SpecialCharTok{\{}\NormalTok{a}\SpecialCharTok{\}}\SpecialStringTok{, and variable b is }\SpecialCharTok{\{}\NormalTok{b}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Variable a is 2, and variable b is 1
\end{verbatim}

The parentheses \texttt{()} around tuples are optional, but often very
helpful! The commas \texttt{,} make the tuple, not the parentheses.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=} \DecValTok{1}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=} \DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(b, a) }\OperatorTok{=}\NormalTok{ (a, b)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}Variable a is }\SpecialCharTok{\{}\NormalTok{a}\SpecialCharTok{\}}\SpecialStringTok{, and variable b is }\SpecialCharTok{\{}\NormalTok{b}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Variable a is 2, and variable b is 1
\end{verbatim}

\subsection{What is the output of the following code and
why?}\label{what-is-the-output-of-the-following-code-and-why-3}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1} \OperatorTok{==}\NormalTok{ (}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(1, 1, False)
\end{verbatim}

Without parentheses \texttt{()}, Python reads the final element in the
tuple as \texttt{1\ ==\ (1,\ 1,\ 1)}, which is \texttt{False}. We can
use parentheses \texttt{()} to force Python to do what we want!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{) }\OperatorTok{==}\NormalTok{ (}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

For this example, we must use parentheses \texttt{()} to be unambiguos!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{) }\OperatorTok{==} \DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(False, 1, 1)
\end{verbatim}

\subsection{\texorpdfstring{Create a list \texttt{l1} of integers from 1
to
100.}{Create a list l1 of integers from 1 to 100.}}\label{create-a-list-l1-of-integers-from-1-to-100.-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l1 }\OperatorTok{=} \BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{101}\NormalTok{))}
\CommentTok{\# the last entry in a code cell automatically prints}
\CommentTok{\# here we use print() to wrap the list to take up less space}
\BuiltInTok{print}\NormalTok{(l1) }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100]
\end{verbatim}

\subsection{\texorpdfstring{Slice \texttt{l1} to create a list of
integers from 60 to 50
(inclusive).}{Slice l1 to create a list of integers from 60 to 50 (inclusive).}}\label{slice-l1-to-create-a-list-of-integers-from-60-to-50-inclusive.-3}

Name this list \texttt{l2}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l1.index(}\DecValTok{50}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
49
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l1[}\DecValTok{49}\NormalTok{:}\DecValTok{60}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60]
\end{verbatim}

In the solution above, we have to ``brute force'' picking the left edge
at 49. However these are 11 values in 50 to 60 inclusive (i.e., 60 - 50
+ 1), so we can add 11 to 49 to find the right edge. This trick is one
of the benefits of Python's zero-indexing.

How do we reverse? I prefer \texttt{{[}::-1{]}}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l2 }\OperatorTok{=}\NormalTok{ l1[}\DecValTok{49}\NormalTok{:}\DecValTok{60}\NormalTok{][::}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\CommentTok{\# the first [] slices, and the second [] reverses}
\NormalTok{l2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[60, 59, 58, 57, 56, 55, 54, 53, 52, 51, 50]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l2\_alt }\OperatorTok{=}\NormalTok{ l1[}\DecValTok{49}\NormalTok{:}\DecValTok{60}\NormalTok{]}
\NormalTok{l2\_alt.reverse() }\CommentTok{\# note, most core python operators modify the object "in place"}
\NormalTok{l2\_alt}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[60, 59, 58, 57, 56, 55, 54, 53, 52, 51, 50]
\end{verbatim}

\subsection{\texorpdfstring{Create a list \texttt{l3} of odd integers
from 1 to
21.}{Create a list l3 of odd integers from 1 to 21.}}\label{create-a-list-l3-of-odd-integers-from-1-to-21.-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l3 }\OperatorTok{=}\NormalTok{ l1[}\DecValTok{0}\NormalTok{:}\DecValTok{21}\NormalTok{][::}\DecValTok{2}\NormalTok{]}

\NormalTok{l3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l1[}\DecValTok{0}\NormalTok{:}\DecValTok{21}\NormalTok{:}\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{22}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{[i }\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{22}\NormalTok{) }\ControlFlowTok{if}\NormalTok{ i}\OperatorTok{\%}\DecValTok{2} \OperatorTok{!=} \DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 3, 5, 7, 9, 11, 13, 15, 17, 19, 21]
\end{verbatim}

What is the advantage of the list comprehension? There is no advantage
in this example, but the list comprehension lets us specify several
conditions and variable step sizes.

\subsection{\texorpdfstring{Create a list \texttt{l4} of the squares of
integers from 1 to
100.}{Create a list l4 of the squares of integers from 1 to 100.}}\label{create-a-list-l4-of-the-squares-of-integers-from-1-to-100.-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l4 }\OperatorTok{=}\NormalTok{ [i}\OperatorTok{**}\DecValTok{2} \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{101}\NormalTok{)]}

\BuiltInTok{print}\NormalTok{(l4)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 4, 9, 16, 25, 36, 49, 64, 81, 100, 121, 144, 169, 196, 225, 256, 289, 324, 361, 400, 441, 484, 529, 576, 625, 676, 729, 784, 841, 900, 961, 1024, 1089, 1156, 1225, 1296, 1369, 1444, 1521, 1600, 1681, 1764, 1849, 1936, 2025, 2116, 2209, 2304, 2401, 2500, 2601, 2704, 2809, 2916, 3025, 3136, 3249, 3364, 3481, 3600, 3721, 3844, 3969, 4096, 4225, 4356, 4489, 4624, 4761, 4900, 5041, 5184, 5329, 5476, 5625, 5776, 5929, 6084, 6241, 6400, 6561, 6724, 6889, 7056, 7225, 7396, 7569, 7744, 7921, 8100, 8281, 8464, 8649, 8836, 9025, 9216, 9409, 9604, 9801, 10000]
\end{verbatim}

\subsection{\texorpdfstring{Create a list \texttt{l5} that contains the
squares of \textbf{\emph{odd}} integers from 1 to
100.}{Create a list l5 that contains the squares of odd integers from 1 to 100.}}\label{create-a-list-l5-that-contains-the-squares-of-odd-integers-from-1-to-100.-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{l5 }\OperatorTok{=}\NormalTok{ [i}\OperatorTok{**}\DecValTok{2} \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\DecValTok{101}\NormalTok{) }\ControlFlowTok{if}\NormalTok{ i}\OperatorTok{\%}\DecValTok{2} \OperatorTok{!=} \DecValTok{0}\NormalTok{]}

\BuiltInTok{print}\NormalTok{(l5)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 9, 25, 49, 81, 121, 169, 225, 289, 361, 441, 529, 625, 729, 841, 961, 1089, 1225, 1369, 1521, 1681, 1849, 2025, 2209, 2401, 2601, 2809, 3025, 3249, 3481, 3721, 3969, 4225, 4489, 4761, 5041, 5329, 5625, 5929, 6241, 6561, 6889, 7225, 7569, 7921, 8281, 8649, 9025, 9409, 9801]
\end{verbatim}

\subsection{\texorpdfstring{Use a lambda function to sort
\texttt{strings} by the last
letter.}{Use a lambda function to sort strings by the last letter.}}\label{use-a-lambda-function-to-sort-strings-by-the-last-letter.-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{strings }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}card\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}aaaa\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}foo\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}abab\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

Most core Python methods modify their objects \emph{in place}. For
clarity, I will use the \texttt{sorted()} function, which \emph{does not
modify its argument in place.}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{sorted}\NormalTok{(strings)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['aaaa', 'abab', 'bar', 'card', 'foo']
\end{verbatim}

We can pass a function name to the \texttt{key=} argument. Python applis
this function to every element in the list, then uses the function
output to sort the list.

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{sorted}\NormalTok{(strings, key}\OperatorTok{=}\BuiltInTok{len}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['foo', 'bar', 'card', 'aaaa', 'abab']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{sorted}\NormalTok{(strings, key}\OperatorTok{=}\BuiltInTok{len}\NormalTok{, reverse}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['card', 'aaaa', 'abab', 'foo', 'bar']
\end{verbatim}

We can index and slice strings just like we do lists!

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}string\textquotesingle{}}\NormalTok{[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'g'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}string\textquotesingle{}}\NormalTok{[}\OperatorTok{{-}}\DecValTok{2}\NormalTok{:]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'ng'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ get\_last\_letter(x):}
    \ControlFlowTok{return}\NormalTok{ x[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{get\_last\_letter(}\StringTok{\textquotesingle{}string\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'g'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{sorted}\NormalTok{(strings, key}\OperatorTok{=}\NormalTok{get\_last\_letter)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['aaaa', 'abab', 'card', 'foo', 'bar']
\end{verbatim}

Anonymous functions (also called lambda functions) let us skip the
function writing and naming steps!

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{sorted}\NormalTok{(strings, key}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['aaaa', 'abab', 'card', 'foo', 'bar']
\end{verbatim}

\subsection{\texorpdfstring{Given an integer array \texttt{nums} and an
integer \texttt{k}, return the \(k^{th}\) largest element in the
array.}{Given an integer array nums and an integer k, return the k\^{}\{th\} largest element in the array.}}\label{given-an-integer-array-nums-and-an-integer-k-return-the-kth-largest-element-in-the-array.-3}

Note that it is the \(k^{th}\) largest element in the sorted order, not
the \(k^{th}\) distinct element.

Example 1:

Input: \texttt{nums\ =\ {[}3,2,1,5,6,4{]}}, \texttt{k\ =\ 2}\\
Output: \texttt{5}

Example 2:

Input: \texttt{nums\ =\ {[}3,2,3,1,2,4,5,5,6{]}}, \texttt{k\ =\ 4}\\
Output: \texttt{4}

I saw this question on
\href{https://leetcode.com/problems/kth-largest-element-in-an-array/}{LeetCode}.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ get\_largest(x, k):}
    \ControlFlowTok{return} \BuiltInTok{sorted}\NormalTok{(x)[}\OperatorTok{{-}}\NormalTok{k]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{get\_largest(x}\OperatorTok{=}\NormalTok{[}\DecValTok{3}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{5}\NormalTok{,}\DecValTok{6}\NormalTok{,}\DecValTok{4}\NormalTok{], k}\OperatorTok{=}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{get\_largest(x}\OperatorTok{=}\NormalTok{[}\DecValTok{3}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{3}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{4}\NormalTok{,}\DecValTok{5}\NormalTok{,}\DecValTok{5}\NormalTok{,}\DecValTok{6}\NormalTok{], k}\OperatorTok{=}\DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
4
\end{verbatim}

\subsection{\texorpdfstring{Given an integer array \texttt{nums} and an
integer \texttt{k}, return the \texttt{k} most frequent
elements.}{Given an integer array nums and an integer k, return the k most frequent elements.}}\label{given-an-integer-array-nums-and-an-integer-k-return-the-k-most-frequent-elements.-3}

You may return the answer in any order.

Example 1:

Input: \texttt{nums\ =\ {[}1,1,1,2,2,3{]}}, \texttt{k\ =\ 2}\\
Output: \texttt{{[}1,2{]}}

Example 2:

Input: \texttt{nums\ =\ {[}1{]}}, \texttt{k\ =\ 1}\\
Output: \texttt{{[}1{]}}

I saw this question on
\href{https://leetcode.com/problems/top-k-frequent-elements/}{LeetCode}.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ get\_frequent(nums, k):}
\NormalTok{    counts }\OperatorTok{=}\NormalTok{ \{\}}
    \ControlFlowTok{for}\NormalTok{ n }\KeywordTok{in}\NormalTok{ nums:}
        \ControlFlowTok{if}\NormalTok{ n }\KeywordTok{in}\NormalTok{ counts:}
\NormalTok{            counts[n] }\OperatorTok{+=} \DecValTok{1}
        \ControlFlowTok{else}\NormalTok{:}
\NormalTok{            counts[n] }\OperatorTok{=} \DecValTok{1}
    \ControlFlowTok{return}\NormalTok{ [x[}\DecValTok{0}\NormalTok{] }\ControlFlowTok{for}\NormalTok{ x }\KeywordTok{in} \BuiltInTok{sorted}\NormalTok{(counts.items(), key}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\DecValTok{1}\NormalTok{], reverse}\OperatorTok{=}\VariableTok{True}\NormalTok{)[:k]]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{get\_frequent(nums}\OperatorTok{=}\NormalTok{[}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{3}\NormalTok{], k}\OperatorTok{=}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[1, 2]
\end{verbatim}

\subsection{Test whether the given strings are
palindromes.}\label{test-whether-the-given-strings-are-palindromes.-3}

Input: \texttt{{[}"aba",\ "no"{]}}\\
Output: \texttt{{[}True,\ False{]}}

We can reverse a string with a \texttt{{[}::-1{]}} slice just like we
reverse a string!

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ is\_palindrome(xs):}
    \ControlFlowTok{return}\NormalTok{ [x }\OperatorTok{==}\NormalTok{ x[::}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\ControlFlowTok{for}\NormalTok{ x }\KeywordTok{in}\NormalTok{ xs]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{is\_palindrome([}\StringTok{"aba"}\NormalTok{, }\StringTok{"no"}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[True, False]
\end{verbatim}

\subsection{\texorpdfstring{Write a function \texttt{returns()} that
accepts lists of prices and dividends and returns a list of
returns.}{Write a function returns() that accepts lists of prices and dividends and returns a list of returns.}}\label{write-a-function-returns-that-accepts-lists-of-prices-and-dividends-and-returns-a-list-of-returns.-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices }\OperatorTok{=}\NormalTok{ [}\DecValTok{100}\NormalTok{, }\DecValTok{150}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{50}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{150}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{150}\NormalTok{]}
\NormalTok{dividends }\OperatorTok{=}\NormalTok{ [}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

Although loop counters are un-Pythonic, this calculation is the rare
case where I found loop counters more clear.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ returns(p, d):}
\NormalTok{    rs }\OperatorTok{=}\NormalTok{ []}
    \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\BuiltInTok{len}\NormalTok{(p)):}
\NormalTok{        r }\OperatorTok{=}\NormalTok{ (p[i] }\OperatorTok{+}\NormalTok{ d[i] }\OperatorTok{{-}}\NormalTok{ p[i}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]) }\OperatorTok{/}\NormalTok{ p[i}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{        rs.append(r)}

    \ControlFlowTok{return}\NormalTok{ rs}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns(p}\OperatorTok{=}\NormalTok{prices, d}\OperatorTok{=}\NormalTok{dividends)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0.51, -0.32666666666666666, -0.49, 1.04, 0.52, -0.32, 0.52]
\end{verbatim}

Here is a solution that avoids a loop counter and combines a list
comprehension \texttt{zip()} to loop over prices, dividends, and lagged
prices. This solution may be a little more Pythonic, but I find it
harder to follow that our loop-counter solution above.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{[(p }\OperatorTok{+}\NormalTok{ d }\OperatorTok{{-}}\NormalTok{ p\_lag) }\OperatorTok{/}\NormalTok{ p\_lag }\ControlFlowTok{for}\NormalTok{ p, d, p\_lag }\KeywordTok{in} \BuiltInTok{zip}\NormalTok{(prices[}\DecValTok{1}\NormalTok{:], dividends[}\DecValTok{1}\NormalTok{:], prices[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{])]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0.51, -0.32666666666666666, -0.49, 1.04, 0.52, -0.32, 0.52]
\end{verbatim}

\subsection{\texorpdfstring{Rewrite the function \texttt{returns()} so
it returns lists of returns, capital gains yields, and dividend
yields.}{Rewrite the function returns() so it returns lists of returns, capital gains yields, and dividend yields.}}\label{rewrite-the-function-returns-so-it-returns-lists-of-returns-capital-gains-yields-and-dividend-yields.-3}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ returns\_2(p, d):}
\NormalTok{    rs, d\_ps, cgs }\OperatorTok{=}\NormalTok{ [], [], []}
    \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{1}\NormalTok{, }\BuiltInTok{len}\NormalTok{(p)):}
\NormalTok{        r }\OperatorTok{=}\NormalTok{ (p[i] }\OperatorTok{+}\NormalTok{ d[i] }\OperatorTok{{-}}\NormalTok{ p[i}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]) }\OperatorTok{/}\NormalTok{ p[i}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{        d\_p }\OperatorTok{=}\NormalTok{ d[i] }\OperatorTok{/}\NormalTok{ p[i}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{        cg }\OperatorTok{=}\NormalTok{ r }\OperatorTok{{-}}\NormalTok{ d\_p}
\NormalTok{        rs.append(r)}
\NormalTok{        d\_ps.append(d\_p)}
\NormalTok{        cgs.append(cg)}

    \ControlFlowTok{return}\NormalTok{ \{}\StringTok{\textquotesingle{}r\textquotesingle{}}\NormalTok{:rs, }\StringTok{\textquotesingle{}d\_p\textquotesingle{}}\NormalTok{:d\_ps, }\StringTok{\textquotesingle{}cg\textquotesingle{}}\NormalTok{:cgs\}}
\end{Highlighting}
\end{Shaded}

The \texttt{\%precision} magic makes it easy to round all float on print
to 4 decimal places.

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'%.4f'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2(p}\OperatorTok{=}\NormalTok{prices, d}\OperatorTok{=}\NormalTok{dividends)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
{'r': [0.5100, -0.3267, -0.4900, 1.0400, 0.5200, -0.3200, 0.5200],
 'd_p': [0.0100, 0.0067, 0.0100, 0.0400, 0.0200, 0.0133, 0.0200],
 'cg': [0.5000, -0.3333, -0.5000, 1.0000, 0.5000, -0.3333, 0.5000]}
\end{verbatim}

By returning a dictionary instead of tuple, we can index returns,
dividend yields, and capital gains yields by name instead of position.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2(p}\OperatorTok{=}\NormalTok{prices, d}\OperatorTok{=}\NormalTok{dividends)[}\StringTok{\textquotesingle{}r\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0.5100, -0.3267, -0.4900, 1.0400, 0.5200, -0.3200, 0.5200]
\end{verbatim}

\subsection{\texorpdfstring{Rescale and shift numbers so that they cover
the range
\texttt{{[}0,\ 1{]}}.}{Rescale and shift numbers so that they cover the range {[}0, 1{]}.}}\label{rescale-and-shift-numbers-so-that-they-cover-the-range-0-1.-3}

Input: \texttt{{[}18.5,\ 17.0,\ 18.0,\ 19.0,\ 18.0{]}}\\
Output: \texttt{{[}0.75,\ 0.0,\ 0.5,\ 1.0,\ 0.5{]}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OperatorTok{=}\NormalTok{ [}\FloatTok{18.5}\NormalTok{, }\FloatTok{17.0}\NormalTok{, }\FloatTok{18.0}\NormalTok{, }\FloatTok{19.0}\NormalTok{, }\FloatTok{18.0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ rescale(x):}
\NormalTok{    x\_min }\OperatorTok{=} \BuiltInTok{min}\NormalTok{(x)}
\NormalTok{    x\_max }\OperatorTok{=} \BuiltInTok{max}\NormalTok{(x)}
    \ControlFlowTok{return}\NormalTok{ [(i }\OperatorTok{{-}}\NormalTok{ x\_min) }\OperatorTok{/}\NormalTok{ (x\_max }\OperatorTok{{-}}\NormalTok{ x\_min) }\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ x]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rescale(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0.7500, 0.0000, 0.5000, 1.0000, 0.5000]
\end{verbatim}

\part{Week 3}

\chapter{McKinney Chapter 4 - NumPy Basics: Arrays and Vectorized
Computation}\label{mckinney-chapter-4---numpy-basics-arrays-and-vectorized-computation}

\section{Introduction}\label{introduction-2}

Chapter 4 of Wes McKinney's
\href{https://wesmckinney.com/book/}{\emph{Python for Data Analysis}}
discusses the NumPy package (an abbreviation of numerical Python), which
is the foundation for numerical computing in Python, including pandas.

We will focus on:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Creating arrays
\item
  Slicing arrays
\item
  Applying functions and methods to arrays
\item
  Using conditional logic with arrays (i.e., \texttt{np.where()} and
  \texttt{np.select()})
\end{enumerate}

\textbf{\emph{Note:}} Indented block quotes are from McKinney unless
otherwise indicated. The section numbers here differ from McKinney
because we will only discuss some topics.

The typical abbreviation for NumPy is \texttt{np}.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\end{Highlighting}
\end{Shaded}

The ``magic'' function \texttt{\%precision\ 4} tells JupyterLab to print
NumPy arrays to 4 decimals. This magic function only changes the printed
precision and does not change the stored precision of the underlying
values.

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'%.4f'
\end{verbatim}

McKinney thoroughly discuesses the history on NumPy, as well as its
technical advantages. But here is a simple illustration of the speed and
syntax advantages of NumPy of Python's built-in data structures. First,
we create a list and array with values from 0 to 999,999.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_list }\OperatorTok{=} \BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\DecValTok{1\_000\_000}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_arr }\OperatorTok{=}\NormalTok{ np.arange(}\DecValTok{1\_000\_000}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_list[:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0, 1, 2, 3, 4]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_arr[:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0, 1, 2, 3, 4])
\end{verbatim}

If we want to double each value in \texttt{my\_list} we have to use a
for loop or a list comprehension.

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{len}\NormalTok{(my\_list }\OperatorTok{*} \DecValTok{2}\NormalTok{) }\CommentTok{\# concatenates two copies of my\_list}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2000000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# [2 * x for x in my\_list] \# list comprehension to double each value}
\end{Highlighting}
\end{Shaded}

However, we can multiply \texttt{my\_arr} by two because math ``just
works'' with NumPy.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_arr }\OperatorTok{*} \DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([      0,       2,       4, ..., 1999994, 1999996, 1999998])
\end{verbatim}

We can use the ``magic'' function \texttt{\%timeit} to time these two
calculations.

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{timeit [x }\OperatorTok{*} \DecValTok{2} \ControlFlowTok{for}\NormalTok{ x }\KeywordTok{in}\NormalTok{ my\_list]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
61.2 ms ± 2.09 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{timeit my\_arr }\OperatorTok{*} \DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.18 ms ± 47.9 µs per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
\end{verbatim}

The NumPy version is a hundred times faster than the list version. The
NumPy version is also faster to type, read, and troubleshoot, which are
typically more important. Our time is more valuable than the computer
time!

\section{The NumPy ndarray: A Multidimensional Array
Object}\label{the-numpy-ndarray-a-multidimensional-array-object}

\begin{quote}
One of the key features of NumPy is its N-dimensional array object, or
ndarray, which is a fast, flexible container for large datasets in
Python. Arrays enable you to perform mathematical operations on whole
blocks of data using similar syntax to the equivalent operations between
scalar elements.
\end{quote}

We generate random data to explore NumPy arrays. Whenever we generate
random data, we should set the random number seed with
\texttt{np.random.seed(42)}, which makes our random numbers repeatable.
If we use the same random number seed, our random numbers will be the
same.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{data }\OperatorTok{=}\NormalTok{ np.random.randn(}\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{)}
\NormalTok{data}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.4967, -0.1383,  0.6477],
       [ 1.523 , -0.2342, -0.2341]])
\end{verbatim}

Multiplying \texttt{data} by 10 multiplies each element in \texttt{data}
by 10, and adding \texttt{data} to itself adds each element to itself
(i.e., element-wise addition). To achieve this common-sense behavior,
NumPy arrays must contain homogeneous data types (e.g., all floats or
all integers).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data }\OperatorTok{*} \DecValTok{10}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 4.9671, -1.3826,  6.4769],
       [15.2303, -2.3415, -2.3414]])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data\_2 }\OperatorTok{=}\NormalTok{ data }\OperatorTok{+}\NormalTok{ data}
\NormalTok{data\_2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.9934, -0.2765,  1.2954],
       [ 3.0461, -0.4683, -0.4683]])
\end{verbatim}

NumPy arrays have attributes. Recall that Jupyter Notebooks provides tab
completion.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.ndim}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.shape}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(2, 3)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.dtype}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
dtype('float64')
\end{verbatim}

We access or slice elements in a NumPy array using \texttt{{[}{]}}, the
same as we slice lists and tuples.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0.4967, -0.1383,  0.6477])
\end{verbatim}

As with list and tuples, we can chain \texttt{{[}{]}}s.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data[}\DecValTok{0}\NormalTok{][}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.4967
\end{verbatim}

However, with NumPy arrays. we can replace \(n\) chained
\texttt{{[}{]}}s with one pair of \texttt{{[}{]}}s containing \(n\)
values separated by commas. For example, \texttt{{[}i{]}{[}j{]}} becomes
\texttt{{[}i,\ j{]}}, \texttt{{[}i{]}{[}j{]}{[}k{]}} becomes
\texttt{{[}i,\ j,\ k{]}}. This abbreviated notation is similar to what
you see in your math and econometrics courses.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data[}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{] }\CommentTok{\# zero row, zero column}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.4967
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data[}\DecValTok{0}\NormalTok{][}\DecValTok{0}\NormalTok{] }\OperatorTok{==}\NormalTok{ data[}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\subsection{Creating ndarrays}\label{creating-ndarrays}

\begin{quote}
The easiest way to create an array is to use the array function. This
accepts any sequence-like object (including other arrays) and produces a
new NumPy array containing the passed data
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data1 }\OperatorTok{=}\NormalTok{ [}\DecValTok{6}\NormalTok{, }\FloatTok{7.5}\NormalTok{, }\DecValTok{8}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{]}
\NormalTok{arr1 }\OperatorTok{=}\NormalTok{ np.array(data1)}
\NormalTok{arr1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([6. , 7.5, 8. , 0. , 1. ])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr1.dtype}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
dtype('float64')
\end{verbatim}

Here \texttt{np.array()} casts the values in \texttt{data1} to floats
becuase NumPy arrays must have homogenous data types. We could coerce
these values to integers but would lose information.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.array(data1, dtype}\OperatorTok{=}\NormalTok{np.int64)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([6, 7, 8, 0, 1], dtype=int64)
\end{verbatim}

We can coerce or cast a list-of-lists to a two-dimensional NumPy array.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data2 }\OperatorTok{=}\NormalTok{ [[}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{], [}\DecValTok{5}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{7}\NormalTok{, }\DecValTok{8}\NormalTok{]]}
\NormalTok{arr2 }\OperatorTok{=}\NormalTok{ np.array(data2)}
\NormalTok{arr2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[1, 2, 3, 4],
       [5, 6, 7, 8]])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr2.ndim}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr2.shape}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(2, 4)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr2.dtype}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
dtype('int32')
\end{verbatim}

There are several other ways to create NumPy arrays.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.zeros(}\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0., 0., 0., 0., 0., 0., 0., 0., 0., 0.])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.zeros((}\DecValTok{3}\NormalTok{, }\DecValTok{6}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[0., 0., 0., 0., 0., 0.],
       [0., 0., 0., 0., 0., 0.],
       [0., 0., 0., 0., 0., 0.]])
\end{verbatim}

The \texttt{np.arange()} function is similar to Python's built-in
\texttt{range()} but creates an array directly.

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\DecValTok{15}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.array(}\BuiltInTok{range}\NormalTok{(}\DecValTok{15}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.arange(}\DecValTok{15}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14])
\end{verbatim}

\textbf{\emph{Table 4-1}} from McKinney lists some NumPy array creation
functions.

\begin{itemize}
\tightlist
\item
  \texttt{array}: Convert input data (list, tuple, array, or other
  sequence type) to an ndarray either by inferring a dtype or explicitly
  specifying a dtype; copies the input data by default
\item
  \texttt{asarray}: Convert input to ndarray, but do not copy if the
  input is already an ndarray
\item
  \texttt{arange}: Like the built-in range but returns an ndarray
  instead of a list
\item
  \texttt{ones}, \texttt{ones\_like}: Produce an array of all 1s with
  the given shape and dtype; \texttt{ones\_like} takes another array and
  produces a \texttt{ones} array of the - same shape and dtype
\item
  \texttt{zeros}, \texttt{zeros\_like}: Like \texttt{ones} and
  \texttt{ones\_like} but producing arrays of 0s instead
\item
  \texttt{empty}, \texttt{empty\_like}: Create new arrays by allocating
  new memory, but do not populate with any values like ones and zeros
\item
  \texttt{full}, \texttt{full\_like}: Produce an array of the given
  shape and dtype with all values set to the indicated ``fill value''
\item
  \texttt{eye}, \texttt{identity}: Create a square N-by-N identity
  matrix (1s on the diagonal and 0s elsewhere)
\end{itemize}

\subsection{Arithmetic with NumPy
Arrays}\label{arithmetic-with-numpy-arrays}

\begin{quote}
Arrays are important because they enable you to express batch operations
on data without writing any for loops. NumPy users call this
vectorization. Any arithmetic operations between equal-size arrays
applies the operation element-wise
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr }\OperatorTok{=}\NormalTok{ np.array([[}\FloatTok{1.}\NormalTok{, }\FloatTok{2.}\NormalTok{, }\FloatTok{3.}\NormalTok{], [}\FloatTok{4.}\NormalTok{, }\FloatTok{5.}\NormalTok{, }\FloatTok{6.}\NormalTok{]])}
\NormalTok{arr}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[1., 2., 3.],
       [4., 5., 6.]])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr.shape}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
(2, 3)
\end{verbatim}

NumPy array addition is elementwise.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr }\OperatorTok{+}\NormalTok{ arr}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 2.,  4.,  6.],
       [ 8., 10., 12.]])
\end{verbatim}

NumPy array multiplication is elementwise.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr }\OperatorTok{*}\NormalTok{ arr}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 1.,  4.,  9.],
       [16., 25., 36.]])
\end{verbatim}

NumPy array division is elementwise.

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{1} \OperatorTok{/}\NormalTok{ arr}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[1.    , 0.5   , 0.3333],
       [0.25  , 0.2   , 0.1667]])
\end{verbatim}

NumPy powers are elementwise, too.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr }\OperatorTok{**} \DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 1.,  4.,  9.],
       [16., 25., 36.]])
\end{verbatim}

We can also raise a single value to an array!

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{2} \OperatorTok{**}\NormalTok{ arr}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 2.,  4.,  8.],
       [16., 32., 64.]])
\end{verbatim}

\subsection{Basic Indexing and
Slicing}\label{basic-indexing-and-slicing}

One-dimensional array index and slice the same as lists.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr }\OperatorTok{=}\NormalTok{ np.arange(}\DecValTok{10}\NormalTok{)}
\NormalTok{arr}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr[}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr[}\DecValTok{5}\NormalTok{:}\DecValTok{8}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([5, 6, 7])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{equiv\_list }\OperatorTok{=} \BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\DecValTok{10}\NormalTok{))}
\NormalTok{equiv\_list}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0, 1, 2, 3, 4, 5, 6, 7, 8, 9]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{equiv\_list[}\DecValTok{5}\NormalTok{:}\DecValTok{8}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[5, 6, 7]
\end{verbatim}

We have to jump through some hoops if we want to replace elements 5, 6,
and 7 in \texttt{equiv\_list} with the value 12.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# TypeError: can only assign an iterable}
\CommentTok{\# equiv\_list[5:8] = 12}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{equiv\_list[}\DecValTok{5}\NormalTok{:}\DecValTok{8}\NormalTok{] }\OperatorTok{=}\NormalTok{ [}\DecValTok{12}\NormalTok{] }\OperatorTok{*} \DecValTok{3}
\NormalTok{equiv\_list}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0, 1, 2, 3, 4, 12, 12, 12, 8, 9]
\end{verbatim}

However, this operation is easy with the NumPy array \texttt{arr}!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr[}\DecValTok{5}\NormalTok{:}\DecValTok{8}\NormalTok{] }\OperatorTok{=} \DecValTok{12}
\NormalTok{arr}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0,  1,  2,  3,  4, 12, 12, 12,  8,  9])
\end{verbatim}

``Broadcasting'' is the name for this behavior.

\begin{quote}
As you can see, if you assign a scalar value to a slice, as in
\texttt{arr{[}5:8{]}\ =\ 12}, the value is propagated (or broadcasted
henceforth) to the entire selection. An important first distinction from
Python's built-in lists is that array slices are views on the original
array. This means that the data is not copied, and any modifications to
the view will be reflected in the source array.
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr\_slice }\OperatorTok{=}\NormalTok{ arr[}\DecValTok{5}\NormalTok{:}\DecValTok{8}\NormalTok{]}
\NormalTok{arr\_slice}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([12, 12, 12])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OperatorTok{=}\NormalTok{ arr\_slice}
\NormalTok{x}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([12, 12, 12])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\KeywordTok{is}\NormalTok{ arr\_slice}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{y }\OperatorTok{=}\NormalTok{ x.copy()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{y }\KeywordTok{is}\NormalTok{ arr\_slice}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
False
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr\_slice[}\DecValTok{1}\NormalTok{] }\OperatorTok{=} \DecValTok{12345}
\NormalTok{arr\_slice}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([   12, 12345,    12])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([    0,     1,     2,     3,     4,    12, 12345,    12,     8,
           9])
\end{verbatim}

The \texttt{:} slices every element in \texttt{arr\_slice}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr\_slice[:] }\OperatorTok{=} \DecValTok{64}
\NormalTok{arr\_slice}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([64, 64, 64])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0,  1,  2,  3,  4, 64, 64, 64,  8,  9])
\end{verbatim}

\begin{quote}
If you want a copy of a slice of an ndarray instead of a view, you will
need to explicitly copy the array-for example,
\texttt{arr{[}5:8{]}.copy()}.
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr\_slice\_2 }\OperatorTok{=}\NormalTok{ arr[}\DecValTok{5}\NormalTok{:}\DecValTok{8}\NormalTok{].copy()}
\NormalTok{arr\_slice\_2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([64, 64, 64])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr\_slice\_2[:] }\OperatorTok{=} \DecValTok{2\_001}
\NormalTok{arr\_slice\_2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([2001, 2001, 2001])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0,  1,  2,  3,  4, 64, 64, 64,  8,  9])
\end{verbatim}

\subsection{Indexing with slices}\label{indexing-with-slices}

We can slice across two or more dimensions, including the
\texttt{{[}i,\ j{]}} notation.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr2d }\OperatorTok{=}\NormalTok{ np.array([[}\DecValTok{1}\NormalTok{,}\DecValTok{2}\NormalTok{,}\DecValTok{3}\NormalTok{], [}\DecValTok{4}\NormalTok{,}\DecValTok{5}\NormalTok{,}\DecValTok{6}\NormalTok{], [}\DecValTok{7}\NormalTok{,}\DecValTok{8}\NormalTok{,}\DecValTok{9}\NormalTok{]])}
\NormalTok{arr2d}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[1, 2, 3],
       [4, 5, 6],
       [7, 8, 9]])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr2d[:}\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[1, 2, 3],
       [4, 5, 6]])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr2d[:}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{:]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[2, 3],
       [5, 6]])
\end{verbatim}

A colon (\texttt{:}) by itself selects the entire dimension and is
necessary to slice higher dimensions.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr2d[:, :}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[1],
       [4],
       [7]])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr2d[:}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{:] }\OperatorTok{=} \DecValTok{0}
\NormalTok{arr2d}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[1, 0, 0],
       [4, 0, 0],
       [7, 8, 9]])
\end{verbatim}

Slicing multi-dimension arrays is tricky! \textbf{\emph{Always check
your output!}}

\subsection{Boolean Indexing}\label{boolean-indexing}

We can use Booleans (\texttt{True}s and \texttt{False}s) to slice
arrays, too. Boolean indexing in Python is like combining
\texttt{index()} and \texttt{match()} in Excel.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{names }\OperatorTok{=}\NormalTok{ np.array([}\StringTok{\textquotesingle{}Bob\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Joe\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Will\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Bob\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Will\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Joe\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Joe\textquotesingle{}}\NormalTok{])}
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{data }\OperatorTok{=}\NormalTok{ np.random.randn(}\DecValTok{7}\NormalTok{, }\DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{names}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array(['Bob', 'Joe', 'Will', 'Bob', 'Will', 'Joe', 'Joe'], dtype='<U4')
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.4967, -0.1383,  0.6477,  1.523 ],
       [-0.2342, -0.2341,  1.5792,  0.7674],
       [-0.4695,  0.5426, -0.4634, -0.4657],
       [ 0.242 , -1.9133, -1.7249, -0.5623],
       [-1.0128,  0.3142, -0.908 , -1.4123],
       [ 1.4656, -0.2258,  0.0675, -1.4247],
       [-0.5444,  0.1109, -1.151 ,  0.3757]])
\end{verbatim}

Here \texttt{names} provides seven names for the seven rows in
\texttt{data}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{names }\OperatorTok{==} \StringTok{\textquotesingle{}Bob\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ True, False, False,  True, False, False, False])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data[names }\OperatorTok{==} \StringTok{\textquotesingle{}Bob\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.4967, -0.1383,  0.6477,  1.523 ],
       [ 0.242 , -1.9133, -1.7249, -0.5623]])
\end{verbatim}

We can combine Boolean slicing with \texttt{:} slicing.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data[names }\OperatorTok{==} \StringTok{\textquotesingle{}Bob\textquotesingle{}}\NormalTok{, }\DecValTok{2}\NormalTok{:]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.6477,  1.523 ],
       [-1.7249, -0.5623]])
\end{verbatim}

We can use \texttt{\textasciitilde{}} to invert a Boolean.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cond }\OperatorTok{=}\NormalTok{ names }\OperatorTok{==} \StringTok{\textquotesingle{}Bob\textquotesingle{}}
\NormalTok{data[}\OperatorTok{\textasciitilde{}}\NormalTok{cond]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[-0.2342, -0.2341,  1.5792,  0.7674],
       [-0.4695,  0.5426, -0.4634, -0.4657],
       [-1.0128,  0.3142, -0.908 , -1.4123],
       [ 1.4656, -0.2258,  0.0675, -1.4247],
       [-0.5444,  0.1109, -1.151 ,  0.3757]])
\end{verbatim}

For NumPy arrays, we must use \texttt{\&} and \texttt{\textbar{}}
instead of \texttt{and} and \texttt{or}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cond }\OperatorTok{=}\NormalTok{ (names }\OperatorTok{==} \StringTok{\textquotesingle{}Bob\textquotesingle{}}\NormalTok{) }\OperatorTok{|}\NormalTok{ (names }\OperatorTok{==} \StringTok{\textquotesingle{}Will\textquotesingle{}}\NormalTok{)}
\NormalTok{data[cond]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.4967, -0.1383,  0.6477,  1.523 ],
       [-0.4695,  0.5426, -0.4634, -0.4657],
       [ 0.242 , -1.9133, -1.7249, -0.5623],
       [-1.0128,  0.3142, -0.908 , -1.4123]])
\end{verbatim}

We can also create a Boolean for each element.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.4967, -0.1383,  0.6477,  1.523 ],
       [-0.2342, -0.2341,  1.5792,  0.7674],
       [-0.4695,  0.5426, -0.4634, -0.4657],
       [ 0.242 , -1.9133, -1.7249, -0.5623],
       [-1.0128,  0.3142, -0.908 , -1.4123],
       [ 1.4656, -0.2258,  0.0675, -1.4247],
       [-0.5444,  0.1109, -1.151 ,  0.3757]])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data }\OperatorTok{\textless{}} \DecValTok{0}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[False,  True, False, False],
       [ True,  True, False, False],
       [ True, False,  True,  True],
       [False,  True,  True,  True],
       [ True, False,  True,  True],
       [False,  True, False,  True],
       [ True, False,  True, False]])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data[data }\OperatorTok{\textless{}} \DecValTok{0}\NormalTok{] }\OperatorTok{=} \DecValTok{0}
\NormalTok{data}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[0.4967, 0.    , 0.6477, 1.523 ],
       [0.    , 0.    , 1.5792, 0.7674],
       [0.    , 0.5426, 0.    , 0.    ],
       [0.242 , 0.    , 0.    , 0.    ],
       [0.    , 0.3142, 0.    , 0.    ],
       [1.4656, 0.    , 0.0675, 0.    ],
       [0.    , 0.1109, 0.    , 0.3757]])
\end{verbatim}

\section{Universal Functions: Fast Element-Wise Array
Functions}\label{universal-functions-fast-element-wise-array-functions}

\begin{quote}
A universal function, or ufunc, is a function that performs element-wise
operations on data in ndarrays. You can think of them as fast vectorized
wrappers for simple functions that take one or more scalar values and
produce one or more scalar results.
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr }\OperatorTok{=}\NormalTok{ np.arange(}\DecValTok{10}\NormalTok{)}
\NormalTok{arr}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.sqrt(}\DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2.0000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.sqrt(arr)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0.    , 1.    , 1.4142, 1.7321, 2.    , 2.2361, 2.4495, 2.6458,
       2.8284, 3.    ])
\end{verbatim}

Like above, we can raise a single value to a NumPy array of powers.

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{2}\OperatorTok{**}\NormalTok{arr}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([  1,   2,   4,   8,  16,  32,  64, 128, 256, 512], dtype=int32)
\end{verbatim}

\texttt{np.exp(x)} is \(e^x\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.exp(arr)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([1.0000e+00, 2.7183e+00, 7.3891e+00, 2.0086e+01, 5.4598e+01,
       1.4841e+02, 4.0343e+02, 1.0966e+03, 2.9810e+03, 8.1031e+03])
\end{verbatim}

The functions above accept one argument. These ``unary'' functions
operate on one array and return a new array with the same shape. There
are also ``binary'' functions that operate on two arrays and return one
array.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{x }\OperatorTok{=}\NormalTok{ np.random.randn(}\DecValTok{8}\NormalTok{)}
\NormalTok{y }\OperatorTok{=}\NormalTok{ np.random.randn(}\DecValTok{8}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0.4967, -0.1383,  0.6477,  1.523 , -0.2342, -0.2341,  1.5792,
        0.7674])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{y}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([-0.4695,  0.5426, -0.4634, -0.4657,  0.242 , -1.9133, -1.7249,
       -0.5623])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.maximum(x, y)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0.4967,  0.5426,  0.6477,  1.523 ,  0.242 , -0.2341,  1.5792,
        0.7674])
\end{verbatim}

\textbf{\emph{Be careful! Function names are not the whole story. Check
your output and read the docstring!}} For example, \texttt{np.max()}
returns the maximum of an array, instead of the elementwise maximum of
two arrays for \texttt{np.maximum()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.}\BuiltInTok{max}\NormalTok{(x)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.5792
\end{verbatim}

\textbf{\emph{Table 4-4}} from McKinney lists some fast, element-wise
unary functions:

\begin{itemize}
\tightlist
\item
  \texttt{abs}, \texttt{fabs}: Compute the absolute value element-wise
  for integer, oating-point, or complex values
\item
  \texttt{sqrt}: Compute the square root of each element (equivalent to
  arr ** 0.5)
\item
  \texttt{square}: Compute the square of each element (equivalent to arr
  ** 2)
\item
  \texttt{exp}: Compute the exponent \(e^x\) of each element
\item
  \texttt{log}, \texttt{log10}, \texttt{log2}, \texttt{log1p}: Natural
  logarithm (base e), log base 10, log base 2, and log(1 + x),
  respectively
\item
  \texttt{sign}: Compute the sign of each element: 1 (positive), 0
  (zero), or --1 (negative)
\item
  \texttt{ceil}: Compute the ceiling of each element (i.e., the smallest
  integer greater than or equal to thatnumber)
\item
  \texttt{floor}: Compute the oor of each element (i.e., the largest
  integer less than or equal to each element)
\item
  \texttt{rint}: Round elements to the nearest integer, preserving the
  dtype
\item
  \texttt{modf}: Return fractional and integral parts of array as a
  separate array
\item
  \texttt{isnan}: Return boolean array indicating whether each value is
  NaN (Not a Number)
\item
  \texttt{isfinite}, \texttt{isinf}: Return boolean array indicating
  whether each element is finite (non-inf, non-NaN) or infinite,
  respectively
\item
  \texttt{cos}, \texttt{cosh}, \texttt{sin}, \texttt{sinh},
  \texttt{tan}, \texttt{tanh}: Regular and hyperbolic trigonometric
  functions
\item
  \texttt{arccos}, \texttt{arccosh}, \texttt{arcsin}, \texttt{arcsinh},
  \texttt{arctan}, \texttt{arctanh}: Inverse trigonometric functions
\item
  \texttt{logical\_not}: Compute truth value of not x element-wise
  (equivalent to \textasciitilde arr).
\end{itemize}

\textbf{\emph{Table 4-5}} from McKinney lists some fast, element-wise
binary functions:

\begin{itemize}
\tightlist
\item
  \texttt{add}: Add corresponding elements in arrays
\item
  \texttt{subtract}: Subtract elements in second array from first array
\item
  \texttt{multiply}: Multiply array elements
\item
  \texttt{divide}, \texttt{floor\_divide}: Divide or floor divide
  (truncating the remainder)
\item
  \texttt{power}: Raise elements in first array to powers indicated in
  second array
\item
  \texttt{maximum}, \texttt{fmax}: Element-wise maximum; \texttt{fmax}
  ignores \texttt{NaN}
\item
  \texttt{minimum}, \texttt{fmin}: Element-wise minimum; \texttt{fmin}
  ignores \texttt{NaN}
\item
  \texttt{mod}: Element-wise modulus (remainder of division)
\item
  \texttt{copysign}: Copy sign of values in second argument to values in
  first argument
\item
  \texttt{greater}, \texttt{greater\_equal}, \texttt{less},
  \texttt{less\_equal}, \texttt{equal}, \texttt{not\_equal}: Perform
  element-wise comparison, yielding boolean array (equivalent to infix
  operators \textgreater, \textgreater=, \textless, \textless=, ==, !=)
\item
  \texttt{logical\_and}, \texttt{logical\_or}, \texttt{logical\_xor}:
  Compute element-wise truth value of logical operation (equivalent to
  infix operators \& \textbar, \^{})
\end{itemize}

\section{Array-Oriented Programming with
Arrays}\label{array-oriented-programming-with-arrays}

\begin{quote}
Using NumPy arrays enables you to express many kinds of data processing
tasks as concise array expressions that might otherwise require writing
loops. This practice of replacing explicit loops with array expressions
is commonly referred to as vectorization. In general, vectorized array
operations will often be one or two (or more) orders of magnitude faster
than their pure Python equivalents, with the biggest impact in any kind
of numerical computations. Later, in Appendix A, I explain broadcasting,
a powerful method for vectorizing computations.
\end{quote}

\subsection{Expressing Conditional Logic as Array
Operations}\label{expressing-conditional-logic-as-array-operations}

\begin{quote}
The numpy.where function is a vectorized version of the ternary
expression x if condition else y.
\end{quote}

NumPy's \texttt{where()} is an if-else statement that operates like
Excel's \texttt{if()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{xarr }\OperatorTok{=}\NormalTok{ np.array([}\FloatTok{1.1}\NormalTok{, }\FloatTok{1.2}\NormalTok{, }\FloatTok{1.3}\NormalTok{, }\FloatTok{1.4}\NormalTok{, }\FloatTok{1.5}\NormalTok{])}
\NormalTok{yarr }\OperatorTok{=}\NormalTok{ np.array([}\FloatTok{2.1}\NormalTok{, }\FloatTok{2.2}\NormalTok{, }\FloatTok{2.3}\NormalTok{, }\FloatTok{2.4}\NormalTok{, }\FloatTok{2.5}\NormalTok{])}
\NormalTok{cond }\OperatorTok{=}\NormalTok{ np.array([}\VariableTok{True}\NormalTok{, }\VariableTok{False}\NormalTok{, }\VariableTok{True}\NormalTok{, }\VariableTok{True}\NormalTok{, }\VariableTok{False}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.where(cond, xarr, yarr)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([1.1, 2.2, 1.3, 1.4, 2.5])
\end{verbatim}

We could use a list comprehension, instead, but the list comprehension
is takes longer to type, read, and troubleshoot.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.array([(x }\ControlFlowTok{if}\NormalTok{ c }\ControlFlowTok{else}\NormalTok{ y) }\ControlFlowTok{for}\NormalTok{ x, y, c }\KeywordTok{in} \BuiltInTok{zip}\NormalTok{(xarr, yarr, cond)])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([1.1, 2.2, 1.3, 1.4, 2.5])
\end{verbatim}

We could also use \texttt{np.select()} here, but it is overkill to test
one condition. \texttt{np.select()} lets us test more more than one
condition and provides a default value if no condition is met.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.select(}
\NormalTok{    condlist}\OperatorTok{=}\NormalTok{[cond}\OperatorTok{==}\VariableTok{True}\NormalTok{, cond}\OperatorTok{==}\VariableTok{False}\NormalTok{],}
\NormalTok{    choicelist}\OperatorTok{=}\NormalTok{[xarr, yarr]}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([1.1, 2.2, 1.3, 1.4, 2.5])
\end{verbatim}

\subsection{Mathematical and Statistical
Methods}\label{mathematical-and-statistical-methods}

\begin{quote}
A set of mathematical functions that compute statistics about an entire
array or about the data along an axis are accessible as methods of the
array class. You can use aggregations (often called reductions) like
sum, mean, and std (standard deviation) either by calling the array
instance method or using the top-level NumPy function.
\end{quote}

We will use these aggregations extensively in pandas.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{arr }\OperatorTok{=}\NormalTok{ np.random.randn(}\DecValTok{5}\NormalTok{, }\DecValTok{4}\NormalTok{)}
\NormalTok{arr}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.4967, -0.1383,  0.6477,  1.523 ],
       [-0.2342, -0.2341,  1.5792,  0.7674],
       [-0.4695,  0.5426, -0.4634, -0.4657],
       [ 0.242 , -1.9133, -1.7249, -0.5623],
       [-1.0128,  0.3142, -0.908 , -1.4123]])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr.mean()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-0.1713
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr.}\BuiltInTok{sum}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-3.4260
\end{verbatim}

The aggregation methods above aggregated the whole array. We can use the
\texttt{axis} argument to aggregate columns (\texttt{axis=0}) and rows
(\texttt{axis=1}).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr.mean(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0.6323,  0.4696, -0.214 , -0.9896, -0.7547])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr[}\DecValTok{0}\NormalTok{].mean()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.6323
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr.mean(axis}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([-0.1956, -0.2858, -0.1739, -0.03  ])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr[:, }\DecValTok{0}\NormalTok{].mean()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-0.1956
\end{verbatim}

The \texttt{.cumsum()} method returns the sum of all previous elements.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr }\OperatorTok{=}\NormalTok{ np.array([}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{7}\NormalTok{]) }\CommentTok{\# same output as np.arange(8)}
\NormalTok{arr.cumsum()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0,  1,  3,  6, 10, 15, 21, 28])
\end{verbatim}

We can use the \texttt{.cumsum()} method along the axis of a
multi-dimension array, too.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr }\OperatorTok{=}\NormalTok{ np.array([[}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{], [}\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{], [}\DecValTok{6}\NormalTok{, }\DecValTok{7}\NormalTok{, }\DecValTok{8}\NormalTok{]])}
\NormalTok{arr}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[0, 1, 2],
       [3, 4, 5],
       [6, 7, 8]])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr.cumsum(axis}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0,  1,  2],
       [ 3,  5,  7],
       [ 9, 12, 15]])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr.cumprod(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[  0,   0,   0],
       [  3,  12,  60],
       [  6,  42, 336]])
\end{verbatim}

\textbf{\emph{Table 4-6}} from McKinney lists some basic statistical
methods:

\begin{itemize}
\tightlist
\item
  \texttt{sum}: Sum of all the elements in the array or along an axis;
  zero-length arrays have sum 0
\item
  \texttt{mean}: Arithmetic mean; zero-length arrays have NaN mean
\item
  \texttt{std}, \texttt{var}: Standard deviation and variance,
  respectively, with optional degrees of freedom adjustment (default
  denominator \(n\))
\item
  \texttt{min}, \texttt{max}: Minimum and maximum
\item
  \texttt{argmin}, \texttt{argmax}: Indices of minimum and maximum
  elements, respectively
\item
  \texttt{cumsum}: Cumulative sum of elements starting from 0
\item
  \texttt{cumprod}: Cumulative product of elements starting from 1
\end{itemize}

\subsection{Methods for Boolean
Arrays}\label{methods-for-boolean-arrays}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{arr }\OperatorTok{=}\NormalTok{ np.random.randn(}\DecValTok{100}\NormalTok{)}
\NormalTok{arr}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0.4967, -0.1383,  0.6477,  1.523 , -0.2342, -0.2341,  1.5792,
        0.7674, -0.4695,  0.5426, -0.4634, -0.4657,  0.242 , -1.9133,
       -1.7249, -0.5623, -1.0128,  0.3142, -0.908 , -1.4123,  1.4656,
       -0.2258,  0.0675, -1.4247, -0.5444,  0.1109, -1.151 ,  0.3757,
       -0.6006, -0.2917, -0.6017,  1.8523, -0.0135, -1.0577,  0.8225,
       -1.2208,  0.2089, -1.9597, -1.3282,  0.1969,  0.7385,  0.1714,
       -0.1156, -0.3011, -1.4785, -0.7198, -0.4606,  1.0571,  0.3436,
       -1.763 ,  0.3241, -0.3851, -0.6769,  0.6117,  1.031 ,  0.9313,
       -0.8392, -0.3092,  0.3313,  0.9755, -0.4792, -0.1857, -1.1063,
       -1.1962,  0.8125,  1.3562, -0.072 ,  1.0035,  0.3616, -0.6451,
        0.3614,  1.538 , -0.0358,  1.5646, -2.6197,  0.8219,  0.087 ,
       -0.299 ,  0.0918, -1.9876, -0.2197,  0.3571,  1.4779, -0.5183,
       -0.8085, -0.5018,  0.9154,  0.3288, -0.5298,  0.5133,  0.0971,
        0.9686, -0.7021, -0.3277, -0.3921, -1.4635,  0.2961,  0.2611,
        0.0051, -0.2346])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr }\OperatorTok{\textgreater{}} \DecValTok{0}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ True, False,  True,  True, False, False,  True,  True, False,
        True, False, False,  True, False, False, False, False,  True,
       False, False,  True, False,  True, False, False,  True, False,
        True, False, False, False,  True, False, False,  True, False,
        True, False, False,  True,  True,  True, False, False, False,
       False, False,  True,  True, False,  True, False, False,  True,
        True,  True, False, False,  True,  True, False, False, False,
       False,  True,  True, False,  True,  True, False,  True,  True,
       False,  True, False,  True,  True, False,  True, False, False,
        True,  True, False, False, False,  True,  True, False,  True,
        True,  True, False, False, False, False,  True,  True,  True,
       False])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(arr }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{).}\BuiltInTok{sum}\NormalTok{() }\CommentTok{\# Number of positive values}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
46
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(arr }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{).mean() }\CommentTok{\# percentage of positive values}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.4600
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{bools }\OperatorTok{=}\NormalTok{ np.array([}\VariableTok{False}\NormalTok{, }\VariableTok{False}\NormalTok{, }\VariableTok{True}\NormalTok{, }\VariableTok{False}\NormalTok{])}
\NormalTok{bools}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([False, False,  True, False])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{bools.}\BuiltInTok{any}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{bools.}\BuiltInTok{all}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
False
\end{verbatim}

\chapter{McKinney Chapter 4 - Practice for Section
02}\label{mckinney-chapter-4---practice-for-section-02}

\section{Announcements}\label{announcements-8}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Our second DataCamp course, \emph{Intermediate Python}, is due Friday,
  1/26, at 11:59 PM
\item
  I will record our week 4 lecture video on McKinney chapter 5 this
  Thursday evening, and the week 4 pre-class quiz is due before class
  next Tuesday, 1/30
\item
  Team projects

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Continue to join teams on Canvas \textgreater{} People
    \textgreater{} Team Projects
  \item
    I removed the join-a-team assignment, but I will give the first
    project assignment in early February, so join a team by then
  \end{enumerate}
\end{enumerate}

\section{10-minute Recap}\label{minute-recap-7}

\subsection{NumPy Arrays}\label{numpy-arrays}

NumPy arrays are multidimensional data structures that can store
numerical data efficiently and perform fast mathematical operations on
them.The \texttt{\%precision} magic displays floats (including in
arrays) to 4 digits.

NumPy arrays are multidimensional data structures that can store
numerical data efficiently and perform fast mathematical operations on
them.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ this}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
The Zen of Python, by Tim Peters

Beautiful is better than ugly.
Explicit is better than implicit.
Simple is better than complex.
Complex is better than complicated.
Flat is better than nested.
Sparse is better than dense.
Readability counts.
Special cases aren't special enough to break the rules.
Although practicality beats purity.
Errors should never pass silently.
Unless explicitly silenced.
In the face of ambiguity, refuse the temptation to guess.
There should be one-- and preferably only one --obvious way to do it.
Although that way may not be obvious at first unless you're Dutch.
Now is better than never.
Although never is often better than *right* now.
If the implementation is hard to explain, it's a bad idea.
If the implementation is easy to explain, it may be a good idea.
Namespaces are one honking great idea -- let's do more of those!
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'%.4f'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.arange(}\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.ones(}\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([1., 1., 1., 1., 1., 1., 1., 1., 1., 1.])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.ones((}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{)) }\CommentTok{\# 2 rows and 2 columns}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[1., 1.],
       [1., 1.]])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.ones((}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{)) }\CommentTok{\# 2 rows, 2 columns, 2 stacks, 2 times}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[[[1., 1.],
         [1., 1.]],

        [[1., 1.],
         [1., 1.]]],


       [[[1., 1.],
         [1., 1.]],

        [[1., 1.],
         [1., 1.]]]])
\end{verbatim}

The \texttt{np.random.rand()} function creates standard normal random
variables (i.e., mean of 0 and standard deviation of 1). We generally
use the \texttt{np.random.seed()} function to make our random numbers
repeatable.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{) }\CommentTok{\# from the *Hitch{-}Hiker\textquotesingle{}s Guide to the Galaxy*}
\NormalTok{np.random.randn(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.4967, -0.1383],
       [ 0.6477,  1.523 ]])
\end{verbatim}

\subsection{Vectorized Functions}\label{vectorized-functions}

Vectorized computation is the process of applying an operation to an
entire array or a subset of an array without using explicit loops. NumPy
supports vectorized computation using universal functions (ufuncs),
which are functions that operate on arrays element-wise.

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{4}\OperatorTok{**}\FloatTok{0.5}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2.0000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{[i}\OperatorTok{**}\FloatTok{0.5} \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{10}\NormalTok{)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0.0000,
 1.0000,
 1.4142,
 1.7321,
 2.0000,
 2.2361,
 2.4495,
 2.6458,
 2.8284,
 3.0000]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.sqrt(np.arange(}\DecValTok{10}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0.    , 1.    , 1.4142, 1.7321, 2.    , 2.2361, 2.4495, 2.6458,
       2.8284, 3.    ])
\end{verbatim}

\subsection{Indexing and Slicing}\label{indexing-and-slicing}

Indexing and slicing are techniques to access or modify specific
elements or subsets of an array. NumPy also supports advanced indexing
methods, such as fancy indexing and boolean indexing, which allow more
flexible and complex selection of array elements.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{my\_array }\OperatorTok{=}\NormalTok{ np.random.randn(}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{)}

\NormalTok{my\_array}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.4967, -0.1383,  0.6477],
       [ 1.523 , -0.2342, -0.2341],
       [ 1.5792,  0.7674, -0.4695]])
\end{verbatim}

How can we get the first row in \texttt{my\_array}?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_array[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0.4967, -0.1383,  0.6477])
\end{verbatim}

How can we get the 0.4967? Chain the \texttt{{[}0{]}} indexes.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_array[}\DecValTok{0}\NormalTok{][}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.4967
\end{verbatim}

This indexing is common enough, the we can replace
\texttt{{[}0{]}{[}0{]}} with \texttt{{[}0,\ 0{]}}, which is \(i, j\)
notation.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_array[}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.4967
\end{verbatim}

What if we want the first two columns of the first two rows?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_array[:}\DecValTok{2}\NormalTok{, :}\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.4967, -0.1383],
       [ 1.523 , -0.2342]])
\end{verbatim}

\section{Practice}\label{practice-8}

\subsection{\texorpdfstring{Create a 1-dimensional array named
\texttt{a1} that counts from 0 to 24 by
1.}{Create a 1-dimensional array named a1 that counts from 0 to 24 by 1.}}\label{create-a-1-dimensional-array-named-a1-that-counts-from-0-to-24-by-1.}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a1 }\OperatorTok{=}\NormalTok{ np.arange(}\DecValTok{25}\NormalTok{)}

\NormalTok{a1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16,
       17, 18, 19, 20, 21, 22, 23, 24])
\end{verbatim}

Here, \texttt{np.arange()} replaces \texttt{np.array()},
\texttt{list()}, and \texttt{range()}!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.array(}\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\DecValTok{25}\NormalTok{)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16,
       17, 18, 19, 20, 21, 22, 23, 24])
\end{verbatim}

\subsection{\texorpdfstring{Create a 1-dimentional array named
\texttt{a2} that counts from 0 to 24 by
3.}{Create a 1-dimentional array named a2 that counts from 0 to 24 by 3.}}\label{create-a-1-dimentional-array-named-a2-that-counts-from-0-to-24-by-3.}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a2 }\OperatorTok{=}\NormalTok{ np.arange(}\DecValTok{0}\NormalTok{, }\DecValTok{25}\NormalTok{, }\DecValTok{3}\NormalTok{) }\CommentTok{\# start, stop, step size}

\NormalTok{a2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0,  3,  6,  9, 12, 15, 18, 21, 24])
\end{verbatim}

\subsection{\texorpdfstring{Create a 1-dimentional array named
\texttt{a3} that counts from 0 to 100 by multiples of 3 or
5.}{Create a 1-dimentional array named a3 that counts from 0 to 100 by multiples of 3 or 5.}}\label{create-a-1-dimentional-array-named-a3-that-counts-from-0-to-100-by-multiples-of-3-or-5.}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a3 }\OperatorTok{=}\NormalTok{ np.array([i }\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{101}\NormalTok{) }\ControlFlowTok{if}\NormalTok{ (i}\OperatorTok{\%}\DecValTok{3}\OperatorTok{==}\DecValTok{0}\NormalTok{) }\KeywordTok{or}\NormalTok{ (i}\OperatorTok{\%}\DecValTok{5}\OperatorTok{==}\DecValTok{0}\NormalTok{)]) }\CommentTok{\# here we could replace "or" with "|"}

\NormalTok{a3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([  0,   3,   5,   6,   9,  10,  12,  15,  18,  20,  21,  24,  25,
        27,  30,  33,  35,  36,  39,  40,  42,  45,  48,  50,  51,  54,
        55,  57,  60,  63,  65,  66,  69,  70,  72,  75,  78,  80,  81,
        84,  85,  87,  90,  93,  95,  96,  99, 100])
\end{verbatim}

We can also use Booleans to slice the output of \texttt{np.arange(101)}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a3\_alt }\OperatorTok{=}\NormalTok{ np.arange(}\DecValTok{101}\NormalTok{)}
\NormalTok{a3\_alt }\OperatorTok{=}\NormalTok{ a3\_alt[ (a3\_alt}\OperatorTok{\%}\DecValTok{3}\OperatorTok{==}\DecValTok{0}\NormalTok{) }\OperatorTok{|}\NormalTok{ (a3\_alt}\OperatorTok{\%}\DecValTok{5}\OperatorTok{==}\DecValTok{0}\NormalTok{) ]}

\NormalTok{a3\_alt}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([  0,   3,   5,   6,   9,  10,  12,  15,  18,  20,  21,  24,  25,
        27,  30,  33,  35,  36,  39,  40,  42,  45,  48,  50,  51,  54,
        55,  57,  60,  63,  65,  66,  69,  70,  72,  75,  78,  80,  81,
        84,  85,  87,  90,  93,  95,  96,  99, 100])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(a3 }\OperatorTok{==}\NormalTok{ a3\_alt).}\BuiltInTok{all}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

The \texttt{np.allclose()} functions helps us test equality with some
non-zero tolerance. More later in the class!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(a3, a3\_alt)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(a3 }\OperatorTok{==} \FloatTok{1.000001}\OperatorTok{*}\NormalTok{a3\_alt).}\BuiltInTok{all}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
False
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(a3, }\FloatTok{1.000001}\OperatorTok{*}\NormalTok{a3\_alt)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\subsection{\texorpdfstring{Create a 1-dimensional array \texttt{a3}
that contains the squares of the even integers through
100,000.}{Create a 1-dimensional array a3 that contains the squares of the even integers through 100,000.}}\label{create-a-1-dimensional-array-a3-that-contains-the-squares-of-the-even-integers-through-100000.}

How much faster is the NumPy version than the list comprehension
version?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.arange(}\DecValTok{0}\NormalTok{, }\DecValTok{100\_001}\NormalTok{, }\DecValTok{2}\NormalTok{)}\OperatorTok{**}\DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([         0,          4,         16, ..., 1409265424, 1409665412,
       1410065408])
\end{verbatim}

On some computers, the output above is wrong because NumPy defaults to
32-bit integers, depending on the computer! \textbf{\emph{Always check
your output!}} To avoid this problem, we can force \texttt{np.arange()}
to use 64-bit integers with the \texttt{dtype=} argument.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.arange(}\DecValTok{0}\NormalTok{, }\DecValTok{100\_001}\NormalTok{, }\DecValTok{2}\NormalTok{, dtype}\OperatorTok{=}\NormalTok{np.int64)}\OperatorTok{**}\DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([          0,           4,          16, ...,  9999200016,
        9999600004, 10000000000], dtype=int64)
\end{verbatim}

We can use the \texttt{\%timeit} magic to time which code is faster! The
\texttt{\%timeit} magic runs the code on the same line many times and
reports the mean computation time. The \texttt{\%\%timet} magic with two
percent signs runs the code in the same cell many times and reports the
mean computation time.

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{timeit np.arange(}\DecValTok{0}\NormalTok{, }\DecValTok{100\_001}\NormalTok{, }\DecValTok{2}\NormalTok{, dtype}\OperatorTok{=}\NormalTok{np.int64)}\OperatorTok{**}\DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
32.5 µs ± 3.41 µs per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{timeit np.array([i}\OperatorTok{**}\DecValTok{2} \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100\_001}\NormalTok{)])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
13.1 ms ± 700 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
\end{verbatim}

The NumPy version is about 1,000 times faster!

\subsection{\texorpdfstring{Write a function that mimic Excel's
\texttt{pv}
function.}{Write a function that mimic Excel's pv function.}}\label{write-a-function-that-mimic-excels-pv-function.}

Here is how we call Excel's \texttt{pv} function:
\texttt{=PV(rate,\ nper,\ pmt,\ {[}fv{]},\ {[}type{]})} We can use the
annuity and lump sum present value formulas.

Present value of an annuity payment \texttt{pmt}:
\(PV_{pmt} = \frac{pmt}{rate} \times \left(1 - \frac{1}{(1+rate)^{nper}} \right)\)

Present value of a lump sum \texttt{fv}:
\(PV_{fv} = \frac{fv}{(1+rate)^{nper}}\)

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_pv(rate, nper, pmt}\OperatorTok{=}\VariableTok{None}\NormalTok{, fv}\OperatorTok{=}\VariableTok{None}\NormalTok{, }\BuiltInTok{type}\OperatorTok{=}\VariableTok{None}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ pmt }\KeywordTok{is} \VariableTok{None}\NormalTok{:}
\NormalTok{        pmt }\OperatorTok{=} \DecValTok{0}
    \ControlFlowTok{if}\NormalTok{ fv }\KeywordTok{is} \VariableTok{None}\NormalTok{:}
\NormalTok{        fv }\OperatorTok{=} \DecValTok{0}
    \ControlFlowTok{if} \BuiltInTok{type} \KeywordTok{is} \VariableTok{None}\NormalTok{:}
        \BuiltInTok{type} \OperatorTok{=} \StringTok{\textquotesingle{}END\textquotesingle{}}
    
\NormalTok{    pv\_pmt }\OperatorTok{=}\NormalTok{ (pmt }\OperatorTok{/}\NormalTok{ rate) }\OperatorTok{*}\NormalTok{ (}\DecValTok{1} \OperatorTok{{-}} \DecValTok{1} \OperatorTok{/}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ rate)}\OperatorTok{**}\NormalTok{nper)}
\NormalTok{    pv\_fv }\OperatorTok{=}\NormalTok{ fv }\OperatorTok{/}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ rate)}\OperatorTok{**}\NormalTok{nper}
\NormalTok{    pv }\OperatorTok{=}\NormalTok{ pv\_pmt }\OperatorTok{+}\NormalTok{ pv\_fv}

    \ControlFlowTok{if} \BuiltInTok{type} \OperatorTok{==} \StringTok{\textquotesingle{}BGN\textquotesingle{}}\NormalTok{:}
\NormalTok{        pv }\OperatorTok{*=}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ rate) }\CommentTok{\# same as pv = pv*(1 + rate)}
    
    \ControlFlowTok{return} \OperatorTok{{-}}\DecValTok{1} \OperatorTok{*}\NormalTok{ pv}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_pv(rate}\OperatorTok{=}\FloatTok{0.05}\NormalTok{, nper}\OperatorTok{=}\DecValTok{14}\NormalTok{, pmt}\OperatorTok{=}\DecValTok{50}\NormalTok{, fv}\OperatorTok{=}\DecValTok{1\_000}\NormalTok{, }\BuiltInTok{type}\OperatorTok{=}\StringTok{\textquotesingle{}END\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-1000.0000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_pv(rate}\OperatorTok{=}\FloatTok{0.05}\NormalTok{, nper}\OperatorTok{=}\DecValTok{14}\NormalTok{, fv}\OperatorTok{=}\DecValTok{1\_000}\NormalTok{, }\BuiltInTok{type}\OperatorTok{=}\StringTok{\textquotesingle{}END\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-505.0680
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=} \DecValTok{5}
\NormalTok{a}\OperatorTok{*=} \DecValTok{5}
\NormalTok{a}\OperatorTok{*=} \DecValTok{5}
\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
125
\end{verbatim}

\subsection{\texorpdfstring{Write a function that mimic Excel's
\texttt{fv}
function.}{Write a function that mimic Excel's fv function.}}\label{write-a-function-that-mimic-excels-fv-function.}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_fv(rate, nper, pmt}\OperatorTok{=}\VariableTok{None}\NormalTok{, pv}\OperatorTok{=}\VariableTok{None}\NormalTok{, }\BuiltInTok{type}\OperatorTok{=}\VariableTok{None}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ pmt }\KeywordTok{is} \VariableTok{None}\NormalTok{:}
\NormalTok{        pmt }\OperatorTok{=} \DecValTok{0}
    \ControlFlowTok{if}\NormalTok{ pv }\KeywordTok{is} \VariableTok{None}\NormalTok{:}
\NormalTok{        pv }\OperatorTok{=} \DecValTok{0}
    \ControlFlowTok{if} \BuiltInTok{type} \KeywordTok{is} \VariableTok{None}\NormalTok{:}
        \BuiltInTok{type} \OperatorTok{=} \StringTok{\textquotesingle{}END\textquotesingle{}}
    
\NormalTok{    fv\_pmt }\OperatorTok{=}\NormalTok{ (pmt }\OperatorTok{/}\NormalTok{ rate) }\OperatorTok{*}\NormalTok{ ((}\DecValTok{1} \OperatorTok{+}\NormalTok{ rate)}\OperatorTok{**}\NormalTok{nper }\OperatorTok{{-}} \DecValTok{1}\NormalTok{)}
\NormalTok{    fv\_pv }\OperatorTok{=}\NormalTok{ pv }\OperatorTok{*}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ rate)}\OperatorTok{**}\NormalTok{nper}
\NormalTok{    fv }\OperatorTok{=}\NormalTok{ fv\_pmt }\OperatorTok{+}\NormalTok{ fv\_pv}

    \ControlFlowTok{if} \BuiltInTok{type} \OperatorTok{==} \StringTok{\textquotesingle{}BGN\textquotesingle{}}\NormalTok{:}
\NormalTok{        fv }\OperatorTok{*=}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ rate) }\CommentTok{\# same as pv = pv*(1 + rate)}
    
    \ControlFlowTok{return} \OperatorTok{{-}}\DecValTok{1} \OperatorTok{*}\NormalTok{ fv}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_fv(rate}\OperatorTok{=}\FloatTok{0.072}\NormalTok{, nper}\OperatorTok{=}\DecValTok{10}\NormalTok{, pv}\OperatorTok{={-}}\DecValTok{1000}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2004.2314
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_fv(rate}\OperatorTok{=}\FloatTok{0.072}\NormalTok{, nper}\OperatorTok{=}\DecValTok{10}\NormalTok{, pmt}\OperatorTok{=}\DecValTok{72}\NormalTok{, pv}\OperatorTok{={-}}\DecValTok{1000}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1000.0000
\end{verbatim}

\subsection{\texorpdfstring{Replace the negative values in \texttt{data}
with -1 and positive values with
+1.}{Replace the negative values in data with -1 and positive values with +1.}}\label{replace-the-negative-values-in-data-with--1-and-positive-values-with-1.}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{data }\OperatorTok{=}\NormalTok{ np.random.randn(}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{)}
\NormalTok{data}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.4967, -0.1383,  0.6477],
       [ 1.523 , -0.2342, -0.2341],
       [ 1.5792,  0.7674, -0.4695]])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data[data }\OperatorTok{\textless{}} \DecValTok{0}\NormalTok{] }\OperatorTok{=} \OperatorTok{{-}}\DecValTok{1}
\NormalTok{data[data }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{] }\OperatorTok{=} \OperatorTok{+}\DecValTok{1}
\NormalTok{data}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 1., -1.,  1.],
       [ 1., -1., -1.],
       [ 1.,  1., -1.]])
\end{verbatim}

\textbf{\emph{Here is a second option!}} NumPy's \texttt{np.where()}
function has the same logic as Excel's \texttt{if()} function! I will
recreate \texttt{data} so we start from the same point.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{data }\OperatorTok{=}\NormalTok{ np.random.randn(}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{)}
\NormalTok{data\_where }\OperatorTok{=}\NormalTok{ np.where(data }\OperatorTok{\textless{}} \DecValTok{0}\NormalTok{, }\OperatorTok{{-}}\DecValTok{1}\NormalTok{, np.where(data }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{, }\OperatorTok{+}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{))}
\NormalTok{data\_where}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 1, -1,  1],
       [ 1, -1, -1],
       [ 1,  1, -1]])
\end{verbatim}

\textbf{\emph{Here is a third option!}} NumPy's \texttt{np.select()}
function lets us test \emph{many} conditions! I will recreate
\texttt{data} so we start from the same point.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{data }\OperatorTok{=}\NormalTok{ np.random.randn(}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{)}
\NormalTok{data\_select }\OperatorTok{=}\NormalTok{ np.select(}
\NormalTok{    condlist}\OperatorTok{=}\NormalTok{[data}\OperatorTok{\textless{}}\DecValTok{0}\NormalTok{, data}\OperatorTok{\textgreater{}}\DecValTok{0}\NormalTok{],}
\NormalTok{    choicelist}\OperatorTok{=}\NormalTok{[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{, }\OperatorTok{+}\DecValTok{1}\NormalTok{],}
\NormalTok{    default}\OperatorTok{=}\DecValTok{0}
\NormalTok{)}
\NormalTok{data\_select}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 1, -1,  1],
       [ 1, -1, -1],
       [ 1,  1, -1]])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(data\_where }\OperatorTok{==}\NormalTok{ data\_select).}\BuiltInTok{all}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

Here is a more complex application of \texttt{np.select()} Say, we want
to truncate values to be between -0.5 and +0.5.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{data }\OperatorTok{=}\NormalTok{ np.random.randn(}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{)}
\NormalTok{data}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.4967, -0.1383,  0.6477],
       [ 1.523 , -0.2342, -0.2341],
       [ 1.5792,  0.7674, -0.4695]])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.select(}
\NormalTok{    condlist}\OperatorTok{=}\NormalTok{[data}\OperatorTok{\textless{}{-}}\FloatTok{0.5}\NormalTok{, data}\OperatorTok{\textgreater{}+}\FloatTok{0.5}\NormalTok{],}
\NormalTok{    choicelist}\OperatorTok{=}\NormalTok{[}\OperatorTok{{-}}\FloatTok{0.5}\NormalTok{, }\OperatorTok{+}\FloatTok{0.5}\NormalTok{],}
\NormalTok{    default}\OperatorTok{=}\NormalTok{data}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.4967, -0.1383,  0.5   ],
       [ 0.5   , -0.2342, -0.2341],
       [ 0.5   ,  0.5   , -0.4695]])
\end{verbatim}

\subsection{\texorpdfstring{Write a function \texttt{npmts()} that
calculates the number of payments that generate \(x\%\) of the present
value of a
perpetuity.}{Write a function npmts() that calculates the number of payments that generate x\textbackslash\% of the present value of a perpetuity.}}\label{write-a-function-npmts-that-calculates-the-number-of-payments-that-generate-x-of-the-present-value-of-a-perpetuity.}

Your \texttt{npmts()} should accept arguments \texttt{c1}, \texttt{r},
and \texttt{g} that represent \(C_1\), \(r\), and \(g\). The present
value of a growing perpetuity is \(PV = \frac{C_1}{r - g}\), and the
present value of a growing annuity is
\(PV = \frac{C_1}{r - g}\left[ 1 - \left( \frac{1 + g}{1 + r} \right)^t \right]\).

We can use the growing annuity and perpetuity formulas to show:
\(x = \left[ 1 - \left( \frac{1 + g}{1 + r} \right)^t \right]\).

Then: \(1 - x = \left( \frac{1 + g}{1 + r} \right)^t\).

Finally: \(t = \frac{\log(1-x)}{\log\left(\frac{1 + g}{1 + r}\right)}\)

\textbf{\emph{We do not need to accept an argument \texttt{c1} because
\(C_1\) cancels out!}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ npmts(x, r, g):}
    \ControlFlowTok{return}\NormalTok{ np.log(}\DecValTok{1}\OperatorTok{{-}}\NormalTok{x) }\OperatorTok{/}\NormalTok{ np.log((}\DecValTok{1} \OperatorTok{+}\NormalTok{ g) }\OperatorTok{/}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ r))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{npmts(}\FloatTok{0.5}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\FloatTok{0.05}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
14.9000
\end{verbatim}

\subsection{Write a function that calculates the internal rate of return
given a NumPy array of cash
flows.}\label{write-a-function-that-calculates-the-internal-rate-of-return-given-a-numpy-array-of-cash-flows.}

Here are some data where the \(IRR\) is obvious!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{c }\OperatorTok{=}\NormalTok{ np.array([}\OperatorTok{{-}}\DecValTok{100}\NormalTok{, }\OperatorTok{+}\DecValTok{110}\NormalTok{])}
\NormalTok{r }\OperatorTok{=} \FloatTok{0.1}
\end{Highlighting}
\end{Shaded}

First, write a function that calculates net present value (NPV) given
cash flows in a NumpPy array \texttt{c} and a discount rate in a scalar
\texttt{r}. The \texttt{npv()} function below uses NumPy arrays to
calculate NPV as: \[NPV = \sum_{t=0}^T \frac{c_t}{(1+r)^t}\]

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_npv(r, c):}
\NormalTok{    t }\OperatorTok{=}\NormalTok{ np.arange(}\BuiltInTok{len}\NormalTok{(c))}
    \ControlFlowTok{return}\NormalTok{ (c }\OperatorTok{/}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ r)}\OperatorTok{**}\NormalTok{t).}\BuiltInTok{sum}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_npv(r}\OperatorTok{=}\NormalTok{r, c}\OperatorTok{=}\NormalTok{c)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-0.0000
\end{verbatim}

We can use a \texttt{while} loop to guess IRR values until we find an
NPV close to zero. We can use the
\href{https://en.wikipedia.org/wiki/Newton\%27s_method}{Newton-Rapshon
method} to make smarter guesses. If we have function \(f(x)\) and guess
\(x_t\), our next guess should be
\(x_{t+1} = x_t - \frac{f(x_t)}{f'(x_t)}\). Here our \(f(x)\) is
\(NPV(r)\), and we can approximate \(f'(x_t)\) as
\(\frac{NPV(r+0.000001) - NPV(r)}{0.000001}\). We will make guess until
\(|NPV| < 0.000001\).

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_irr(c, guess}\OperatorTok{=}\DecValTok{0}\NormalTok{, tol}\OperatorTok{=}\FloatTok{1e{-}6}\NormalTok{, step}\OperatorTok{=}\FloatTok{1e{-}6}\NormalTok{):}
\NormalTok{    irr }\OperatorTok{=}\NormalTok{ guess}
\NormalTok{    npv }\OperatorTok{=}\NormalTok{ calc\_npv(r}\OperatorTok{=}\NormalTok{irr, c}\OperatorTok{=}\NormalTok{c) }\CommentTok{\# I made this change after class to possibly save us an iteration}
    \ControlFlowTok{while}\NormalTok{ np.}\BuiltInTok{abs}\NormalTok{(npv) }\OperatorTok{\textgreater{}}\NormalTok{ tol:}
\NormalTok{        npv }\OperatorTok{=}\NormalTok{ calc\_npv(r}\OperatorTok{=}\NormalTok{irr, c}\OperatorTok{=}\NormalTok{c)}
\NormalTok{        deriv }\OperatorTok{=}\NormalTok{ (calc\_npv(r}\OperatorTok{=}\NormalTok{irr}\OperatorTok{+}\NormalTok{step, c}\OperatorTok{=}\NormalTok{c) }\OperatorTok{{-}}\NormalTok{ npv) }\OperatorTok{/}\NormalTok{ step}
\NormalTok{        irr }\OperatorTok{=}\NormalTok{ irr }\OperatorTok{{-}}\NormalTok{ npv }\OperatorTok{/}\NormalTok{ deriv}
        \CommentTok{\# print(f\textquotesingle{}IRR is \{irr\}, and NPV is \{npv\}\textquotesingle{})}
    \ControlFlowTok{return}\NormalTok{ irr}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_irr(c)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.1000
\end{verbatim}

\subsection{\texorpdfstring{Write a function \texttt{returns()} that
accepts \emph{NumPy arrays} of prices and dividends and returns a
\emph{NumPy array} of
returns.}{Write a function returns() that accepts NumPy arrays of prices and dividends and returns a NumPy array of returns.}}\label{write-a-function-returns-that-accepts-numpy-arrays-of-prices-and-dividends-and-returns-a-numpy-array-of-returns.}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices }\OperatorTok{=}\NormalTok{ np.array([}\DecValTok{100}\NormalTok{, }\DecValTok{150}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{50}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{150}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{150}\NormalTok{])}
\NormalTok{dividends }\OperatorTok{=}\NormalTok{ np.array([}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

We want to slice our arrays to ``lag'' or ``shift'' them! For example,
we slice the \texttt{prices} array to calculate capital gains as
follows.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices[}\DecValTok{1}\NormalTok{:] }\OperatorTok{{-}}\NormalTok{ prices[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 50, -50, -50,  50,  50, -50,  50])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ returns(p, d):}
    \ControlFlowTok{return}\NormalTok{ (p[}\DecValTok{1}\NormalTok{:] }\OperatorTok{{-}}\NormalTok{ p[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{+}\NormalTok{ d[}\DecValTok{1}\NormalTok{:]) }\OperatorTok{/}\NormalTok{ p[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns(p}\OperatorTok{=}\NormalTok{prices, d}\OperatorTok{=}\NormalTok{dividends)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0.51  , -0.3267, -0.49  ,  1.04  ,  0.52  , -0.32  ,  0.52  ])
\end{verbatim}

\subsection{\texorpdfstring{Rewrite the function \texttt{returns()} so
it returns \emph{NumPy arrays} of returns, capital gains yields, and
dividend
yields.}{Rewrite the function returns() so it returns NumPy arrays of returns, capital gains yields, and dividend yields.}}\label{rewrite-the-function-returns-so-it-returns-numpy-arrays-of-returns-capital-gains-yields-and-dividend-yields.}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ returns\_2(p, d):}
\NormalTok{    r }\OperatorTok{=}\NormalTok{ (p[}\DecValTok{1}\NormalTok{:] }\OperatorTok{{-}}\NormalTok{ p[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{+}\NormalTok{ d[}\DecValTok{1}\NormalTok{:]) }\OperatorTok{/}\NormalTok{ p[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    dp }\OperatorTok{=}\NormalTok{ d[}\DecValTok{1}\NormalTok{:] }\OperatorTok{/}\NormalTok{ p[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    cgp }\OperatorTok{=}\NormalTok{ r }\OperatorTok{{-}}\NormalTok{ dp}
    \ControlFlowTok{return}\NormalTok{ \{}\StringTok{\textquotesingle{}r\textquotesingle{}}\NormalTok{:r, }\StringTok{\textquotesingle{}dp\textquotesingle{}}\NormalTok{:dp, }\StringTok{\textquotesingle{}cgp\textquotesingle{}}\NormalTok{:cgp\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2(p}\OperatorTok{=}\NormalTok{prices, d}\OperatorTok{=}\NormalTok{dividends)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
{'r': array([ 0.51  , -0.3267, -0.49  ,  1.04  ,  0.52  , -0.32  ,  0.52  ]),
 'dp': array([0.01  , 0.0067, 0.01  , 0.04  , 0.02  , 0.0133, 0.02  ]),
 'cgp': array([ 0.5   , -0.3333, -0.5   ,  1.    ,  0.5   , -0.3333,  0.5   ])}
\end{verbatim}

\subsection{Rescale and shift numbers so that they cover the range {[}0,
1{]}}\label{rescale-and-shift-numbers-so-that-they-cover-the-range-0-1}

Input: \texttt{np.array({[}18.5,\ 17.0,\ 18.0,\ 19.0,\ 18.0{]})}\\
Output: \texttt{np.array({[}0.75,\ 0.0,\ 0.5,\ 1.0,\ 0.5{]})}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{numbers }\OperatorTok{=}\NormalTok{ np.array([}\FloatTok{18.5}\NormalTok{, }\FloatTok{17.0}\NormalTok{, }\FloatTok{18.0}\NormalTok{, }\FloatTok{19.0}\NormalTok{, }\FloatTok{18.0}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(numbers }\OperatorTok{{-}}\NormalTok{ numbers.}\BuiltInTok{min}\NormalTok{()) }\OperatorTok{/}\NormalTok{ (numbers.}\BuiltInTok{max}\NormalTok{() }\OperatorTok{{-}}\NormalTok{ numbers.}\BuiltInTok{min}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0.75, 0.  , 0.5 , 1.  , 0.5 ])
\end{verbatim}

\subsection{\texorpdfstring{Write functions \texttt{var()} and
\texttt{std()} that calculate variance and standard
deviation.}{Write functions var() and std() that calculate variance and standard deviation.}}\label{write-functions-var-and-std-that-calculate-variance-and-standard-deviation.}

NumPy's \texttt{.var()} and \texttt{.std()} methods return
\emph{population} statistics (i.e., denominators of \(n\)). The pandas
equivalents return \emph{sample} statistics (denominators of \(n-1\)),
which are more appropriate for financial data analysis where we have a
sample instead of a population.

Both function should have an argument \texttt{sample} that is
\texttt{True} by default so both functions return sample statistics by
default.

Use \texttt{numbers} to compare your functions with NumPy's
\texttt{.var()} and \texttt{.std()} methods.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{((numbers }\OperatorTok{{-}}\NormalTok{ numbers.mean())}\OperatorTok{**}\DecValTok{2}\NormalTok{).mean()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.4400
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{numbers.var()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.4400
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ var(x, sample}\OperatorTok{=}\VariableTok{True}\NormalTok{):}
\NormalTok{    mu\_x }\OperatorTok{=}\NormalTok{ x.mean()}
    \ControlFlowTok{return}\NormalTok{ ((x }\OperatorTok{{-}}\NormalTok{ mu\_x)}\OperatorTok{**}\DecValTok{2}\NormalTok{).}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{/}\NormalTok{ (}\BuiltInTok{len}\NormalTok{(x) }\OperatorTok{{-}}\NormalTok{ sample)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{var(numbers)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.5500
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{var(numbers) }\OperatorTok{==}\NormalTok{ numbers.var(ddof}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{var(numbers, sample}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.4400
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{var(numbers, sample}\OperatorTok{=}\VariableTok{False}\NormalTok{) }\OperatorTok{==}\NormalTok{ numbers.var()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ std(x, sample}\OperatorTok{=}\VariableTok{True}\NormalTok{):}
    \ControlFlowTok{return}\NormalTok{ np.sqrt(var(x}\OperatorTok{=}\NormalTok{x, sample}\OperatorTok{=}\NormalTok{sample))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{std(numbers, sample}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.6633
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{std(numbers, sample}\OperatorTok{=}\VariableTok{False}\NormalTok{) }\OperatorTok{==}\NormalTok{ numbers.std()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{std(numbers)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.7416
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{std(numbers) }\OperatorTok{==}\NormalTok{ numbers.std(ddof}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\chapter{McKinney Chapter 4 - Practice for Section
03}\label{mckinney-chapter-4---practice-for-section-03}

\section{Announcements}\label{announcements-9}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Our second DataCamp course, \emph{Intermediate Python}, is due Friday,
  1/26, at 11:59 PM
\item
  I will record our week 4 lecture video on McKinney chapter 5 this
  Thursday evening, and the week 4 pre-class quiz is due before class
  next Tuesday, 1/30
\item
  Team projects

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Continue to join teams on Canvas \textgreater{} People
    \textgreater{} Team Projects
  \item
    I removed the join-a-team assignment, but I will give the first
    project assignment in early February, so join a team by then
  \end{enumerate}
\end{enumerate}

\section{10-minute Recap}\label{minute-recap-8}

\subsection{NumPy Arrays}\label{numpy-arrays-1}

NumPy arrays are multidimensional data structures that can store
numerical data efficiently and perform fast mathematical operations on
them.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ this}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
The Zen of Python, by Tim Peters

Beautiful is better than ugly.
Explicit is better than implicit.
Simple is better than complex.
Complex is better than complicated.
Flat is better than nested.
Sparse is better than dense.
Readability counts.
Special cases aren't special enough to break the rules.
Although practicality beats purity.
Errors should never pass silently.
Unless explicitly silenced.
In the face of ambiguity, refuse the temptation to guess.
There should be one-- and preferably only one --obvious way to do it.
Although that way may not be obvious at first unless you're Dutch.
Now is better than never.
Although never is often better than *right* now.
If the implementation is hard to explain, it's a bad idea.
If the implementation is easy to explain, it may be a good idea.
Namespaces are one honking great idea -- let's do more of those!
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'%.4f'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.arange(}\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.ones((}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[1., 1.],
       [1., 1.]])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.ones((}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[[[1., 1.],
         [1., 1.]],

        [[1., 1.],
         [1., 1.]]],


       [[[1., 1.],
         [1., 1.]],

        [[1., 1.],
         [1., 1.]]]])
\end{verbatim}

We can use \texttt{np.ranom.rand()} to create n-dimensional arrays of
standard normal random variables (i.e., \(\mu=0, \sigma=1\)). We can use
\texttt{np.random.seed()} to set the random number generator seed to
make our analysis repeatable.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{np.random.randn(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.4967, -0.1383],
       [ 0.6477,  1.523 ]])
\end{verbatim}

\subsection{Vectorized Functions}\label{vectorized-functions-1}

Vectorized computation is the process of applying an operation to an
entire array or a subset of an array without using explicit loops. NumPy
supports vectorized computation using universal functions (ufuncs),
which are functions that operate on arrays element-wise.

Say we want to calculate square roots.

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{4}\OperatorTok{**}\FloatTok{0.5}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2.0000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{[i}\OperatorTok{**}\FloatTok{0.5} \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{10}\NormalTok{)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0.0000,
 1.0000,
 1.4142,
 1.7321,
 2.0000,
 2.2361,
 2.4495,
 2.6458,
 2.8284,
 3.0000]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.sqrt(}\DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2.0000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.sqrt(np.arange(}\DecValTok{10}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0.    , 1.    , 1.4142, 1.7321, 2.    , 2.2361, 2.4495, 2.6458,
       2.8284, 3.    ])
\end{verbatim}

\subsection{Indexing and Slicing}\label{indexing-and-slicing-1}

Indexing and slicing are techniques to access or modify specific
elements or subsets of an array. NumPy also supports advanced indexing
methods, such as fancy indexing and boolean indexing, which allow more
flexible and complex selection of array elements.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{my\_array }\OperatorTok{=}\NormalTok{ np.random.randn(}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{)}

\NormalTok{my\_array}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.4967, -0.1383,  0.6477],
       [ 1.523 , -0.2342, -0.2341],
       [ 1.5792,  0.7674, -0.4695]])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_array[}\DecValTok{0}\NormalTok{] }\CommentTok{\# indexes first array in array of arrays}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0.4967, -0.1383,  0.6477])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_array[}\DecValTok{0}\NormalTok{][}\DecValTok{0}\NormalTok{] }\CommentTok{\# indexes first element in first array in array of arrays}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.4967
\end{verbatim}

In NumPy, we typically replace the chained \texttt{{[}i{]}{[}j{]}}
notation with the \texttt{{[}i,\ j{]}} from linear algebra class.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_array[}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.4967
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_array[:}\DecValTok{2}\NormalTok{, :}\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.4967, -0.1383],
       [ 1.523 , -0.2342]])
\end{verbatim}

\section{Practice}\label{practice-9}

\subsection{\texorpdfstring{Create a 1-dimensional array named
\texttt{a1} that counts from 0 to 24 by
1.}{Create a 1-dimensional array named a1 that counts from 0 to 24 by 1.}}\label{create-a-1-dimensional-array-named-a1-that-counts-from-0-to-24-by-1.-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a1 }\OperatorTok{=}\NormalTok{ np.arange(}\DecValTok{25}\NormalTok{)}

\NormalTok{a1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16,
       17, 18, 19, 20, 21, 22, 23, 24])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a1.ndim}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a1.dtype}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
dtype('int32')
\end{verbatim}

\subsection{\texorpdfstring{Create a 1-dimentional array named
\texttt{a2} that counts from 0 to 24 by
3.}{Create a 1-dimentional array named a2 that counts from 0 to 24 by 3.}}\label{create-a-1-dimentional-array-named-a2-that-counts-from-0-to-24-by-3.-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a2 }\OperatorTok{=}\NormalTok{ np.arange(}\DecValTok{0}\NormalTok{, }\DecValTok{25}\NormalTok{, }\DecValTok{3}\NormalTok{)}

\NormalTok{a2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0,  3,  6,  9, 12, 15, 18, 21, 24])
\end{verbatim}

\subsection{\texorpdfstring{Create a 1-dimentional array named
\texttt{a3} that counts from 0 to 100 by multiples of 3 or
5.}{Create a 1-dimentional array named a3 that counts from 0 to 100 by multiples of 3 or 5.}}\label{create-a-1-dimentional-array-named-a3-that-counts-from-0-to-100-by-multiples-of-3-or-5.-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a3 }\OperatorTok{=}\NormalTok{ np.array([i }\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{101}\NormalTok{) }\ControlFlowTok{if}\NormalTok{ (i}\OperatorTok{\%}\DecValTok{3}\OperatorTok{==}\DecValTok{0}\NormalTok{) }\KeywordTok{or}\NormalTok{ (i}\OperatorTok{\%}\DecValTok{5}\OperatorTok{==}\DecValTok{0}\NormalTok{)]) }\CommentTok{\# core Python allows "or" or "|"}

\NormalTok{a3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([  0,   3,   5,   6,   9,  10,  12,  15,  18,  20,  21,  24,  25,
        27,  30,  33,  35,  36,  39,  40,  42,  45,  48,  50,  51,  54,
        55,  57,  60,  63,  65,  66,  69,  70,  72,  75,  78,  80,  81,
        84,  85,  87,  90,  93,  95,  96,  99, 100])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a3.ndim}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a3\_alt }\OperatorTok{=}\NormalTok{ np.arange(}\DecValTok{101}\NormalTok{)}
\NormalTok{a3\_alt }\OperatorTok{=}\NormalTok{ a3\_alt[(a3\_alt}\OperatorTok{\%}\DecValTok{3}\OperatorTok{==}\DecValTok{0}\NormalTok{) }\OperatorTok{|}\NormalTok{ (a3\_alt}\OperatorTok{\%}\DecValTok{5}\OperatorTok{==}\DecValTok{0}\NormalTok{)] }\CommentTok{\# NumPy does not allow "or", only "|"}

\NormalTok{a3\_alt}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([  0,   3,   5,   6,   9,  10,  12,  15,  18,  20,  21,  24,  25,
        27,  30,  33,  35,  36,  39,  40,  42,  45,  48,  50,  51,  54,
        55,  57,  60,  63,  65,  66,  69,  70,  72,  75,  78,  80,  81,
        84,  85,  87,  90,  93,  95,  96,  99, 100])
\end{verbatim}

How can we test if \texttt{a3} and \texttt{a3\_alt} have the same
values?

The \texttt{==} operators tests is NumPy arrays are the same, element by
element. We can append the \texttt{.all()} to make sure all
element-by-element comparisons are \texttt{True}!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(a3 }\OperatorTok{==}\NormalTok{ a3\_alt).}\BuiltInTok{all}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

if we want to compare within some tolerance, we can use
\texttt{np.allclose()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(a3, a3\_alt)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

Minor detour for another example! How do I slice values greater than 5
in an array from 0 to 9?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ten }\OperatorTok{=}\NormalTok{ np.arange(}\DecValTok{10}\NormalTok{)}
\NormalTok{gt\_five }\OperatorTok{=}\NormalTok{ ten[ten }\OperatorTok{\textgreater{}} \DecValTok{5}\NormalTok{]}

\NormalTok{gt\_five}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([6, 7, 8, 9])
\end{verbatim}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\subsection{\texorpdfstring{Create a 1-dimensional array \texttt{a3}
that contains the squares of the even integers through
100,000.}{Create a 1-dimensional array a3 that contains the squares of the even integers through 100,000.}}\label{create-a-1-dimensional-array-a3-that-contains-the-squares-of-the-even-integers-through-100000.-1}

How much faster is the NumPy version than the list comprehension
version?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.arange(}\DecValTok{0}\NormalTok{, }\DecValTok{100\_001}\NormalTok{, }\DecValTok{2}\NormalTok{)}\OperatorTok{**}\DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([         0,          4,         16, ..., 1409265424, 1409665412,
       1410065408])
\end{verbatim}

On some computers, the output above is wrong because NumPy defaults to
32-bit integers, depending on the computer! \textbf{\emph{Always check
your output!}} To avoid this problem, we can force \texttt{np.arange()}
to use 64-bit integers with the \texttt{dtype=} argument.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.arange(}\DecValTok{0}\NormalTok{, }\DecValTok{100\_001}\NormalTok{, }\DecValTok{2}\NormalTok{, dtype}\OperatorTok{=}\NormalTok{np.int64)}\OperatorTok{**}\DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([          0,           4,          16, ...,  9999200016,
        9999600004, 10000000000], dtype=int64)
\end{verbatim}

We can use the \texttt{\%timeit} magic to time which code is faster! The
\texttt{\%timeit} magic runs the code on the same line many times and
reports the mean computation time. The \texttt{\%\%timet} magic with two
percent signs runs the code in the same cell many times and reports the
mean computation time.

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{timeit np.arange(}\DecValTok{0}\NormalTok{, }\DecValTok{100\_001}\NormalTok{, }\DecValTok{2}\NormalTok{, dtype}\OperatorTok{=}\NormalTok{np.int64)}\OperatorTok{**}\DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
43.8 µs ± 5.15 µs per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{timeit np.array([i}\OperatorTok{**}\DecValTok{2} \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100\_001}\NormalTok{)])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
13.4 ms ± 918 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
\end{verbatim}

The NumPy version is about 1,000 times faster!

\subsection{\texorpdfstring{Write a function that mimic Excel's
\texttt{pv}
function.}{Write a function that mimic Excel's pv function.}}\label{write-a-function-that-mimic-excels-pv-function.-1}

Here is how we call Excel's \texttt{pv} function:
\texttt{=PV(rate,\ nper,\ pmt,\ {[}fv{]},\ {[}type{]})} We can use the
annuity and lump sum present value formulas.

Present value of an annuity payment \texttt{pmt}:
\(PV_{pmt} = \frac{pmt}{rate} \times \left(1 - \frac{1}{(1+rate)^{nper}} \right)\)

Present value of a lump sum \texttt{fv}:
\(PV_{fv} = \frac{fv}{(1+rate)^{nper}}\)

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ pv(rate, nper, pmt}\OperatorTok{=}\VariableTok{None}\NormalTok{, fv}\OperatorTok{=}\VariableTok{None}\NormalTok{, }\BuiltInTok{type}\OperatorTok{=}\VariableTok{None}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ pmt }\KeywordTok{is} \VariableTok{None}\NormalTok{:}
\NormalTok{        pmt }\OperatorTok{=} \DecValTok{0}
    \ControlFlowTok{if}\NormalTok{ fv }\KeywordTok{is} \VariableTok{None}\NormalTok{:}
\NormalTok{        fv }\OperatorTok{=} \DecValTok{0}
    \ControlFlowTok{if} \BuiltInTok{type} \KeywordTok{is} \VariableTok{None}\NormalTok{:}
        \BuiltInTok{type} \OperatorTok{=} \StringTok{\textquotesingle{}END\textquotesingle{}}
    
\NormalTok{    pv\_pmt }\OperatorTok{=}\NormalTok{ (pmt }\OperatorTok{/}\NormalTok{ rate) }\OperatorTok{*}\NormalTok{ (}\DecValTok{1} \OperatorTok{{-}} \DecValTok{1} \OperatorTok{/}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ rate)}\OperatorTok{**}\NormalTok{nper)}
\NormalTok{    pv\_fv }\OperatorTok{=}\NormalTok{ fv }\OperatorTok{/}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ rate)}\OperatorTok{**}\NormalTok{nper}
\NormalTok{    pv }\OperatorTok{=}\NormalTok{ pv\_pmt }\OperatorTok{+}\NormalTok{ pv\_fv}

    \ControlFlowTok{if} \BuiltInTok{type} \OperatorTok{==} \StringTok{\textquotesingle{}BGN\textquotesingle{}}\NormalTok{:}
\NormalTok{        pv }\OperatorTok{*=}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ rate) }\CommentTok{\# same as pv = pv*(1 + rate)}
    
    \ControlFlowTok{return} \OperatorTok{{-}}\DecValTok{1} \OperatorTok{*}\NormalTok{ pv}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pv(rate }\OperatorTok{=} \FloatTok{0.05}\NormalTok{, nper }\OperatorTok{=} \DecValTok{14}\NormalTok{, fv }\OperatorTok{=} \DecValTok{1\_000}\NormalTok{, }\BuiltInTok{type} \OperatorTok{=} \StringTok{\textquotesingle{}END\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-505.0680
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=} \DecValTok{5}
\NormalTok{a}\OperatorTok{*=} \DecValTok{5}
\NormalTok{a}\OperatorTok{*=} \DecValTok{5}
\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
125
\end{verbatim}

\subsection{\texorpdfstring{Write a function that mimic Excel's
\texttt{fv}
function.}{Write a function that mimic Excel's fv function.}}\label{write-a-function-that-mimic-excels-fv-function.-1}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_fv(rate, nper, pmt}\OperatorTok{=}\VariableTok{None}\NormalTok{, pv}\OperatorTok{=}\VariableTok{None}\NormalTok{, }\BuiltInTok{type}\OperatorTok{=}\VariableTok{None}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ pmt }\KeywordTok{is} \VariableTok{None}\NormalTok{:}
\NormalTok{        pmt }\OperatorTok{=} \DecValTok{0}
    \ControlFlowTok{if}\NormalTok{ pv }\KeywordTok{is} \VariableTok{None}\NormalTok{:}
\NormalTok{        pv }\OperatorTok{=} \DecValTok{0}
    \ControlFlowTok{if} \BuiltInTok{type} \KeywordTok{is} \VariableTok{None}\NormalTok{:}
        \BuiltInTok{type} \OperatorTok{=} \StringTok{\textquotesingle{}END\textquotesingle{}}
    
\NormalTok{    fv\_pmt }\OperatorTok{=}\NormalTok{ (pmt }\OperatorTok{/}\NormalTok{ rate) }\OperatorTok{*}\NormalTok{ ((}\DecValTok{1} \OperatorTok{+}\NormalTok{ rate)}\OperatorTok{**}\NormalTok{nper }\OperatorTok{{-}} \DecValTok{1}\NormalTok{)}
\NormalTok{    fv\_pv }\OperatorTok{=}\NormalTok{ pv }\OperatorTok{*}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ rate)}\OperatorTok{**}\NormalTok{nper}
\NormalTok{    fv }\OperatorTok{=}\NormalTok{ fv\_pmt }\OperatorTok{+}\NormalTok{ fv\_pv}

    \ControlFlowTok{if} \BuiltInTok{type} \OperatorTok{==} \StringTok{\textquotesingle{}BGN\textquotesingle{}}\NormalTok{:}
\NormalTok{        fv }\OperatorTok{*=}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ rate) }\CommentTok{\# same as pv = pv*(1 + rate)}
    
    \ControlFlowTok{return} \OperatorTok{{-}}\DecValTok{1} \OperatorTok{*}\NormalTok{ fv}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_fv(rate}\OperatorTok{=}\FloatTok{0.072}\NormalTok{, nper}\OperatorTok{=}\DecValTok{10}\NormalTok{, pv}\OperatorTok{={-}}\DecValTok{1000}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2004.2314
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_fv(rate}\OperatorTok{=}\FloatTok{0.072}\NormalTok{, nper}\OperatorTok{=}\DecValTok{10}\NormalTok{, pmt}\OperatorTok{=}\DecValTok{72}\NormalTok{, pv}\OperatorTok{={-}}\DecValTok{1000}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1000.0000
\end{verbatim}

\subsection{\texorpdfstring{Replace the negative values in \texttt{data}
with -1 and positive values with
+1.}{Replace the negative values in data with -1 and positive values with +1.}}\label{replace-the-negative-values-in-data-with--1-and-positive-values-with-1.-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{data }\OperatorTok{=}\NormalTok{ np.random.randn(}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{)}
\NormalTok{data}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.4967, -0.1383,  0.6477,  1.523 ],
       [-0.2342, -0.2341,  1.5792,  0.7674],
       [-0.4695,  0.5426, -0.4634, -0.4657],
       [ 0.242 , -1.9133, -1.7249, -0.5623]])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data[data }\OperatorTok{\textless{}} \DecValTok{0}\NormalTok{] }\OperatorTok{=} \OperatorTok{{-}}\DecValTok{1}
\NormalTok{data[data }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{] }\OperatorTok{=} \OperatorTok{+}\DecValTok{1}

\NormalTok{data}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 1., -1.,  1.,  1.],
       [-1., -1.,  1.,  1.],
       [-1.,  1., -1., -1.],
       [ 1., -1., -1., -1.]])
\end{verbatim}

\textbf{\emph{We have a second option in NumPy!}} NumPy's
\texttt{np.where()} function works the same as Excel's \texttt{if()}
function.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{data }\OperatorTok{=}\NormalTok{ np.random.randn(}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{)}

\NormalTok{np.where( }\CommentTok{\# we can add whitespace inside parentheses ()!}
\NormalTok{    data }\OperatorTok{\textless{}} \DecValTok{0}\NormalTok{, }\CommentTok{\# condition to test}
    \OperatorTok{{-}}\DecValTok{1}\NormalTok{, }\CommentTok{\# result if true}
\NormalTok{    np.where(data }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{, }\OperatorTok{+}\DecValTok{1}\NormalTok{, data) }\CommentTok{\# result if false}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 1., -1.,  1.,  1.],
       [-1., -1.,  1.,  1.],
       [-1.,  1., -1., -1.],
       [ 1., -1., -1., -1.]])
\end{verbatim}

\textbf{\emph{We also have a third option in NumPy!}} NumPy's
\texttt{np.select()} function lets test multiple conditions!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{data }\OperatorTok{=}\NormalTok{ np.random.randn(}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{)}

\NormalTok{np.select( }\CommentTok{\# we can add whitespace inside parentheses ()!}
\NormalTok{    condlist}\OperatorTok{=}\NormalTok{[data}\OperatorTok{\textless{}}\DecValTok{0}\NormalTok{, data}\OperatorTok{\textgreater{}}\DecValTok{0}\NormalTok{],}
\NormalTok{    choicelist}\OperatorTok{=}\NormalTok{[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{, }\OperatorTok{+}\DecValTok{1}\NormalTok{],}
\NormalTok{    default}\OperatorTok{=}\NormalTok{data}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 1., -1.,  1.,  1.],
       [-1., -1.,  1.,  1.],
       [-1.,  1., -1., -1.],
       [ 1., -1., -1., -1.]])
\end{verbatim}

\subsection{\texorpdfstring{Write a function \texttt{npmts()} that
calculates the number of payments that generate \(x\%\) of the present
value of a
perpetuity.}{Write a function npmts() that calculates the number of payments that generate x\textbackslash\% of the present value of a perpetuity.}}\label{write-a-function-npmts-that-calculates-the-number-of-payments-that-generate-x-of-the-present-value-of-a-perpetuity.-1}

Your \texttt{npmts()} should accept arguments \texttt{c1}, \texttt{r},
and \texttt{g} that represent \(C_1\), \(r\), and \(g\). The present
value of a growing perpetuity is \(PV = \frac{C_1}{r - g}\), and the
present value of a growing annuity is
\(PV = \frac{C_1}{r - g}\left[ 1 - \left( \frac{1 + g}{1 + r} \right)^t \right]\).

We can use the growing annuity and perpetuity formulas to show:
\(x = \left[ 1 - \left( \frac{1 + g}{1 + r} \right)^t \right]\).

Then: \(1 - x = \left( \frac{1 + g}{1 + r} \right)^t\).

Finally: \(t = \frac{\log(1-x)}{\log\left(\frac{1 + g}{1 + r}\right)}\)

\textbf{\emph{We do not need to accept an argument \texttt{c1} because
\(C_1\) cancels out!}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ npmts(x, r, g):}
    \ControlFlowTok{return}\NormalTok{ np.log(}\DecValTok{1}\OperatorTok{{-}}\NormalTok{x) }\OperatorTok{/}\NormalTok{ np.log((}\DecValTok{1} \OperatorTok{+}\NormalTok{ g) }\OperatorTok{/}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ r))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{npmts(}\FloatTok{0.5}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\FloatTok{0.05}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
14.9000
\end{verbatim}

\subsection{Write a function that calculates the internal rate of return
given a NumPy array of cash
flows.}\label{write-a-function-that-calculates-the-internal-rate-of-return-given-a-numpy-array-of-cash-flows.-1}

Here are some data where the \(IRR\) is obvious!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{c }\OperatorTok{=}\NormalTok{ np.array([}\OperatorTok{{-}}\DecValTok{100}\NormalTok{, }\DecValTok{110}\NormalTok{])}
\NormalTok{r }\OperatorTok{=} \FloatTok{0.10}
\end{Highlighting}
\end{Shaded}

First, write a function that calculates net present value (NPV) given
cash flows in a NumpPy array \texttt{c} and a discount rate in a scalar
\texttt{r}. The \texttt{npv()} function below uses NumPy arrays to
calculate NPV as: \[NPV = \sum_{t=0}^T \frac{c_t}{(1+r)^t}\]

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_npv(r, c):}
\NormalTok{    t }\OperatorTok{=}\NormalTok{ np.arange(}\BuiltInTok{len}\NormalTok{(c))}
    \ControlFlowTok{return}\NormalTok{ (c }\OperatorTok{/}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ r)}\OperatorTok{**}\NormalTok{t).}\BuiltInTok{sum}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_npv(r}\OperatorTok{=}\NormalTok{r, c}\OperatorTok{=}\NormalTok{c)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-0.0000
\end{verbatim}

We can use a \texttt{while} loop to guess IRR values until we find an
NPV close to zero. We can use the
\href{https://en.wikipedia.org/wiki/Newton\%27s_method}{Newton-Rapshon
method} to make smarter guesses. If we have function \(f(x)\) and guess
\(x_t\), our next guess should be
\(x_{t+1} = x_t - \frac{f(x_t)}{f'(x_t)}\). Here our \(f(x)\) is
\(NPV(r)\), and we can approximate \(f'(x_t)\) as
\(\frac{NPV(r+0.000001) - NPV(r)}{0.000001}\). We will make guess until
\(|NPV| < 0.000001\).

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_irr(c, guess}\OperatorTok{=}\DecValTok{0}\NormalTok{):}
\NormalTok{    irr }\OperatorTok{=}\NormalTok{ guess}
\NormalTok{    npv }\OperatorTok{=}\NormalTok{ calc\_npv(r}\OperatorTok{=}\NormalTok{irr, c}\OperatorTok{=}\NormalTok{c)}
    \ControlFlowTok{while}\NormalTok{ np.}\BuiltInTok{abs}\NormalTok{(npv) }\OperatorTok{\textgreater{}} \FloatTok{1e{-}6}\NormalTok{:}
\NormalTok{        slope }\OperatorTok{=}\NormalTok{ (calc\_npv(r}\OperatorTok{=}\NormalTok{irr}\OperatorTok{+}\FloatTok{1e{-}6}\NormalTok{, c}\OperatorTok{=}\NormalTok{c) }\OperatorTok{{-}}\NormalTok{ npv) }\OperatorTok{/} \FloatTok{1e{-}6} \CommentTok{\# Delta NPV / Delta r}
\NormalTok{        irr }\OperatorTok{=}\NormalTok{ irr }\OperatorTok{{-}}\NormalTok{ npv }\OperatorTok{/}\NormalTok{ slope}
\NormalTok{        npv }\OperatorTok{=}\NormalTok{ calc\_npv(r}\OperatorTok{=}\NormalTok{irr, c}\OperatorTok{=}\NormalTok{c)}
        \CommentTok{\# print(f\textquotesingle{}NPV is \{npv\}, IRR is \{irr\}\textquotesingle{})}

    \ControlFlowTok{return}\NormalTok{ irr}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_irr(c}\OperatorTok{=}\NormalTok{c) }\CommentTok{\# c is the first positional argument, so we can omit "c=" }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.1000
\end{verbatim}

\subsection{\texorpdfstring{Write a function \texttt{returns()} that
accepts \emph{NumPy arrays} of prices and dividends and returns a
\emph{NumPy array} of
returns.}{Write a function returns() that accepts NumPy arrays of prices and dividends and returns a NumPy array of returns.}}\label{write-a-function-returns-that-accepts-numpy-arrays-of-prices-and-dividends-and-returns-a-numpy-array-of-returns.-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices }\OperatorTok{=}\NormalTok{ np.array([}\DecValTok{100}\NormalTok{, }\DecValTok{150}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{50}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{150}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{150}\NormalTok{])}
\NormalTok{dividends }\OperatorTok{=}\NormalTok{ np.array([}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

Here is the return for the first period.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(prices[}\DecValTok{1}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ prices[}\DecValTok{0}\NormalTok{] }\OperatorTok{+}\NormalTok{ dividends[}\DecValTok{1}\NormalTok{]) }\OperatorTok{/}\NormalTok{ prices[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.5100
\end{verbatim}

Here are the capital gains for every period.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices[}\DecValTok{1}\NormalTok{:] }\OperatorTok{{-}}\NormalTok{ prices[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 50, -50, -50,  50,  50, -50,  50])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(prices[}\DecValTok{1}\NormalTok{:] }\OperatorTok{{-}}\NormalTok{ prices[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{+}\NormalTok{ dividends[}\DecValTok{1}\NormalTok{:]) }\OperatorTok{/}\NormalTok{ prices[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0.51  , -0.3267, -0.49  ,  1.04  ,  0.52  , -0.32  ,  0.52  ])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ returns(p, d):}
    \ControlFlowTok{return}\NormalTok{ (p[}\DecValTok{1}\NormalTok{:] }\OperatorTok{{-}}\NormalTok{ p[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{+}\NormalTok{ d[}\DecValTok{1}\NormalTok{:]) }\OperatorTok{/}\NormalTok{ p[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns(p}\OperatorTok{=}\NormalTok{prices, d}\OperatorTok{=}\NormalTok{dividends)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0.51  , -0.3267, -0.49  ,  1.04  ,  0.52  , -0.32  ,  0.52  ])
\end{verbatim}

\subsection{\texorpdfstring{Rewrite the function \texttt{returns()} so
it returns \emph{NumPy arrays} of returns, capital gains yields, and
dividend
yields.}{Rewrite the function returns() so it returns NumPy arrays of returns, capital gains yields, and dividend yields.}}\label{rewrite-the-function-returns-so-it-returns-numpy-arrays-of-returns-capital-gains-yields-and-dividend-yields.-1}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ returns\_2(p, d):}
\NormalTok{    r }\OperatorTok{=}\NormalTok{ (p[}\DecValTok{1}\NormalTok{:] }\OperatorTok{{-}}\NormalTok{ p[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{+}\NormalTok{ d[}\DecValTok{1}\NormalTok{:]) }\OperatorTok{/}\NormalTok{ p[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    dp }\OperatorTok{=}\NormalTok{ d[}\DecValTok{1}\NormalTok{:] }\OperatorTok{/}\NormalTok{ p[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    cgp }\OperatorTok{=}\NormalTok{ r }\OperatorTok{{-}}\NormalTok{ dp}
    \ControlFlowTok{return}\NormalTok{ \{}\StringTok{\textquotesingle{}r\textquotesingle{}}\NormalTok{:r, }\StringTok{\textquotesingle{}dp\textquotesingle{}}\NormalTok{:dp, }\StringTok{\textquotesingle{}cgp\textquotesingle{}}\NormalTok{:cgp\}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2(p}\OperatorTok{=}\NormalTok{prices, d}\OperatorTok{=}\NormalTok{dividends)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
{'r': array([ 0.51  , -0.3267, -0.49  ,  1.04  ,  0.52  , -0.32  ,  0.52  ]),
 'dp': array([0.01  , 0.0067, 0.01  , 0.04  , 0.02  , 0.0133, 0.02  ]),
 'cgp': array([ 0.5   , -0.3333, -0.5   ,  1.    ,  0.5   , -0.3333,  0.5   ])}
\end{verbatim}

\subsection{Rescale and shift numbers so that they cover the range {[}0,
1{]}}\label{rescale-and-shift-numbers-so-that-they-cover-the-range-0-1-1}

Input: \texttt{np.array({[}18.5,\ 17.0,\ 18.0,\ 19.0,\ 18.0{]})}\\
Output: \texttt{np.array({[}0.75,\ 0.0,\ 0.5,\ 1.0,\ 0.5{]})}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{numbers }\OperatorTok{=}\NormalTok{ np.array([}\FloatTok{18.5}\NormalTok{, }\FloatTok{17.0}\NormalTok{, }\FloatTok{18.0}\NormalTok{, }\FloatTok{19.0}\NormalTok{, }\FloatTok{18.0}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(numbers }\OperatorTok{{-}}\NormalTok{ numbers.}\BuiltInTok{min}\NormalTok{()) }\OperatorTok{/}\NormalTok{ (numbers.}\BuiltInTok{max}\NormalTok{() }\OperatorTok{{-}}\NormalTok{ numbers.}\BuiltInTok{min}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0.75, 0.  , 0.5 , 1.  , 0.5 ])
\end{verbatim}

\subsection{\texorpdfstring{Write functions \texttt{var()} and
\texttt{std()} that calculate variance and standard
deviation.}{Write functions var() and std() that calculate variance and standard deviation.}}\label{write-functions-var-and-std-that-calculate-variance-and-standard-deviation.-1}

NumPy's \texttt{.var()} and \texttt{.std()} methods return
\emph{population} statistics (i.e., denominators of \(n\)). The pandas
equivalents return \emph{sample} statistics (denominators of \(n-1\)),
which are more appropriate for financial data analysis where we have a
sample instead of a population.

Both function should have an argument \texttt{sample} that is
\texttt{True} by default so both functions return sample statistics by
default.

Use \texttt{numbers} to compare your functions with NumPy's
\texttt{.var()} and \texttt{.std()} methods.

The population variance is ``the average squared distance from the
average.''

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{((numbers }\OperatorTok{{-}}\NormalTok{ numbers.mean())}\OperatorTok{**}\DecValTok{2}\NormalTok{).mean()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.4400
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{numbers.var()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.4400
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ var(x, sample}\OperatorTok{=}\VariableTok{True}\NormalTok{):}
\NormalTok{    mu\_x }\OperatorTok{=}\NormalTok{ x.mean()}
    \ControlFlowTok{return}\NormalTok{ ((x }\OperatorTok{{-}}\NormalTok{ mu\_x)}\OperatorTok{**}\DecValTok{2}\NormalTok{).}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{/}\NormalTok{ (}\BuiltInTok{len}\NormalTok{(x) }\OperatorTok{{-}}\NormalTok{ sample)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{var(numbers)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.5500
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{var(numbers) }\OperatorTok{==}\NormalTok{ numbers.var(ddof}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{var(numbers, sample}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.4400
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{var(numbers, sample}\OperatorTok{=}\VariableTok{False}\NormalTok{) }\OperatorTok{==}\NormalTok{ numbers.var()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ std(x, sample}\OperatorTok{=}\VariableTok{True}\NormalTok{):}
    \ControlFlowTok{return}\NormalTok{ np.sqrt(var(x}\OperatorTok{=}\NormalTok{x, sample}\OperatorTok{=}\NormalTok{sample))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{std(numbers, sample}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.6633
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{std(numbers, sample}\OperatorTok{=}\VariableTok{False}\NormalTok{) }\OperatorTok{==}\NormalTok{ numbers.std()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{std(numbers)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.7416
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{std(numbers) }\OperatorTok{==}\NormalTok{ numbers.std(ddof}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\chapter{McKinney Chapter 4 - Practice for Section
04}\label{mckinney-chapter-4---practice-for-section-04}

\section{Announcements}\label{announcements-10}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Our second DataCamp course, \emph{Intermediate Python}, is due Friday,
  1/26, at 11:59 PM
\item
  I will record our week 4 lecture video on McKinney chapter 5 this
  Thursday evening, and the week 4 pre-class quiz is due before class
  next Tuesday, 1/30
\item
  Team projects

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Continue to join teams on Canvas \textgreater{} People
    \textgreater{} Team Projects
  \item
    I removed the join-a-team assignment, but I will give the first
    project assignment in early February, so join a team by then
  \end{enumerate}
\end{enumerate}

\section{10-minute Recap}\label{minute-recap-9}

\subsection{NumPy Arrays}\label{numpy-arrays-2}

NumPy arrays are multidimensional data structures that can store
numerical data efficiently and perform fast mathematical operations on
them.

We use the abbreviation \texttt{np} for NumPy, and the magic
\texttt{\%precision} to display floats to fewer decimal places (here 4).

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ this}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
The Zen of Python, by Tim Peters

Beautiful is better than ugly.
Explicit is better than implicit.
Simple is better than complex.
Complex is better than complicated.
Flat is better than nested.
Sparse is better than dense.
Readability counts.
Special cases aren't special enough to break the rules.
Although practicality beats purity.
Errors should never pass silently.
Unless explicitly silenced.
In the face of ambiguity, refuse the temptation to guess.
There should be one-- and preferably only one --obvious way to do it.
Although that way may not be obvious at first unless you're Dutch.
Now is better than never.
Although never is often better than *right* now.
If the implementation is hard to explain, it's a bad idea.
If the implementation is easy to explain, it may be a good idea.
Namespaces are one honking great idea -- let's do more of those!
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'%.4f'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.arange(}\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.zeros((}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[0., 0.],
       [0., 0.]])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.zeros((}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{)) }\CommentTok{\# x, y, z, and time?}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[[[0., 0.],
         [0., 0.]],

        [[0., 0.],
         [0., 0.]]],


       [[[0., 0.],
         [0., 0.]],

        [[0., 0.],
         [0., 0.]]]])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{np.random.randn(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.4967, -0.1383],
       [ 0.6477,  1.523 ]])
\end{verbatim}

\subsection{Vectorized Functions}\label{vectorized-functions-2}

Vectorized computation is the process of applying an operation to an
entire array or a subset of an array without using explicit loops. NumPy
supports vectorized computation using universal functions (ufuncs),
which are functions that operate on arrays element-wise.

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{4}\OperatorTok{**}\FloatTok{0.5}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2.0000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{[i}\OperatorTok{**}\FloatTok{0.5} \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{10}\NormalTok{)]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[0.0000,
 1.0000,
 1.4142,
 1.7321,
 2.0000,
 2.2361,
 2.4495,
 2.6458,
 2.8284,
 3.0000]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.sqrt(}\DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2.0000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.sqrt(np.arange(}\DecValTok{10}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0.    , 1.    , 1.4142, 1.7321, 2.    , 2.2361, 2.4495, 2.6458,
       2.8284, 3.    ])
\end{verbatim}

\subsection{Indexing and Slicing}\label{indexing-and-slicing-2}

Indexing and slicing are techniques to access or modify specific
elements or subsets of an array. NumPy also supports advanced indexing
methods, such as fancy indexing and boolean indexing, which allow more
flexible and complex selection of array elements.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{my\_array }\OperatorTok{=}\NormalTok{ np.random.randn(}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{)}

\NormalTok{my\_array}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.4967, -0.1383,  0.6477],
       [ 1.523 , -0.2342, -0.2341],
       [ 1.5792,  0.7674, -0.4695]])
\end{verbatim}

How do we get the first ``row''?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_array[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0.4967, -0.1383,  0.6477])
\end{verbatim}

How do we get the first element in the first row?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_array[}\DecValTok{0}\NormalTok{][}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.4967
\end{verbatim}

But, NumPy is designed for matrix algebra and lets us use the \(i, j\)
notation from linear algebra class (and MATLAB).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_array[}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.4967
\end{verbatim}

How do we get the first 2 rows? Slice it!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_array[:}\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.4967, -0.1383,  0.6477],
       [ 1.523 , -0.2342, -0.2341]])
\end{verbatim}

How do we get the first 2 columns in the first 2 rows? Slice it using
\(i, j\) notation!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_array[:}\DecValTok{2}\NormalTok{, :}\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.4967, -0.1383],
       [ 1.523 , -0.2342]])
\end{verbatim}

\section{Practice}\label{practice-10}

\subsection{\texorpdfstring{Create a 1-dimensional array named
\texttt{a1} that counts from 0 to 24 by
1.}{Create a 1-dimensional array named a1 that counts from 0 to 24 by 1.}}\label{create-a-1-dimensional-array-named-a1-that-counts-from-0-to-24-by-1.-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a1 }\OperatorTok{=}\NormalTok{ np.arange(}\DecValTok{25}\NormalTok{)}

\NormalTok{a1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16,
       17, 18, 19, 20, 21, 22, 23, 24])
\end{verbatim}

\subsection{\texorpdfstring{Create a 1-dimentional array named
\texttt{a2} that counts from 0 to 24 by
3.}{Create a 1-dimentional array named a2 that counts from 0 to 24 by 3.}}\label{create-a-1-dimentional-array-named-a2-that-counts-from-0-to-24-by-3.-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a2 }\OperatorTok{=}\NormalTok{ np.arange(}\DecValTok{0}\NormalTok{, }\DecValTok{25}\NormalTok{, }\DecValTok{3}\NormalTok{)}

\NormalTok{a2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0,  3,  6,  9, 12, 15, 18, 21, 24])
\end{verbatim}

\subsection{\texorpdfstring{Create a 1-dimentional array named
\texttt{a3} that counts from 0 to 100 by multiples of 3 or
5.}{Create a 1-dimentional array named a3 that counts from 0 to 100 by multiples of 3 or 5.}}\label{create-a-1-dimentional-array-named-a3-that-counts-from-0-to-100-by-multiples-of-3-or-5.-2}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{5} \OperatorTok{/} \DecValTok{3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.6667
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{5} \OperatorTok{//} \DecValTok{3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{5} \OperatorTok{\%} \DecValTok{3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a3 }\OperatorTok{=}\NormalTok{ np.array([i }\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{101}\NormalTok{) }\ControlFlowTok{if}\NormalTok{ (i}\OperatorTok{\%}\DecValTok{3}\OperatorTok{==}\DecValTok{0}\NormalTok{) }\KeywordTok{or}\NormalTok{ (i}\OperatorTok{\%}\DecValTok{5}\OperatorTok{==}\DecValTok{0}\NormalTok{)])}

\NormalTok{a3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([  0,   3,   5,   6,   9,  10,  12,  15,  18,  20,  21,  24,  25,
        27,  30,  33,  35,  36,  39,  40,  42,  45,  48,  50,  51,  54,
        55,  57,  60,  63,  65,  66,  69,  70,  72,  75,  78,  80,  81,
        84,  85,  87,  90,  93,  95,  96,  99, 100])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a3\_alt }\OperatorTok{=}\NormalTok{ np.arange(}\DecValTok{101}\NormalTok{)}
\NormalTok{a3\_alt }\OperatorTok{=}\NormalTok{ a3\_alt[(a3\_alt}\OperatorTok{\%}\DecValTok{3}\OperatorTok{==}\DecValTok{0}\NormalTok{) }\OperatorTok{|}\NormalTok{ (a3\_alt}\OperatorTok{\%}\DecValTok{5}\OperatorTok{==}\DecValTok{0}\NormalTok{)] }\CommentTok{\# must use "|" instead of "or" in NumPy}

\NormalTok{a3\_alt}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([  0,   3,   5,   6,   9,  10,  12,  15,  18,  20,  21,  24,  25,
        27,  30,  33,  35,  36,  39,  40,  42,  45,  48,  50,  51,  54,
        55,  57,  60,  63,  65,  66,  69,  70,  72,  75,  78,  80,  81,
        84,  85,  87,  90,  93,  95,  96,  99, 100])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(a3 }\OperatorTok{==}\NormalTok{ a3\_alt).}\BuiltInTok{all}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(a3, a3\_alt)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\subsection{\texorpdfstring{Create a 1-dimensional array \texttt{a3}
that contains the squares of the even integers through
100,000.}{Create a 1-dimensional array a3 that contains the squares of the even integers through 100,000.}}\label{create-a-1-dimensional-array-a3-that-contains-the-squares-of-the-even-integers-through-100000.-2}

How much faster is the NumPy version than the list comprehension
version?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.arange(}\DecValTok{0}\NormalTok{, }\DecValTok{100\_001}\NormalTok{, }\DecValTok{2}\NormalTok{)}\OperatorTok{**}\DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([         0,          4,         16, ..., 1409265424, 1409665412,
       1410065408])
\end{verbatim}

On some computers, the output above is wrong because NumPy defaults to
32-bit integers, depending on the computer! \textbf{\emph{Always check
your output!}} To avoid this problem, we can force \texttt{np.arange()}
to use 64-bit integers with the \texttt{dtype=} argument.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.arange(}\DecValTok{0}\NormalTok{, }\DecValTok{100\_001}\NormalTok{, }\DecValTok{2}\NormalTok{, dtype}\OperatorTok{=}\NormalTok{np.int64)}\OperatorTok{**}\DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([          0,           4,          16, ...,  9999200016,
        9999600004, 10000000000], dtype=int64)
\end{verbatim}

We can use the \texttt{\%timeit} magic to time which code is faster! The
\texttt{\%timeit} magic runs the code on the same line many times and
reports the mean computation time. The \texttt{\%\%timet} magic with two
percent signs runs the code in the same cell many times and reports the
mean computation time.

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{timeit np.arange(}\DecValTok{0}\NormalTok{, }\DecValTok{100\_001}\NormalTok{, }\DecValTok{2}\NormalTok{, dtype}\OperatorTok{=}\NormalTok{np.int64)}\OperatorTok{**}\DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
41.6 µs ± 3.42 µs per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{timeit np.array([i}\OperatorTok{**}\DecValTok{2} \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100\_001}\NormalTok{)])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
12 ms ± 2.06 ms per loop (mean ± std. dev. of 7 runs, 100 loops each)
\end{verbatim}

The NumPy version is about 1,000 times faster!

\subsection{\texorpdfstring{Write a function that mimic Excel's
\texttt{pv}
function.}{Write a function that mimic Excel's pv function.}}\label{write-a-function-that-mimic-excels-pv-function.-2}

Here is how we call Excel's \texttt{pv} function:
\texttt{=PV(rate,\ nper,\ pmt,\ {[}fv{]},\ {[}type{]})} We can use the
annuity and lump sum present value formulas.

Present value of an annuity payment \texttt{pmt}:
\(PV_{pmt} = \frac{pmt}{rate} \times \left(1 - \frac{1}{(1+rate)^{nper}} \right)\)

Present value of a lump sum \texttt{fv}:
\(PV_{fv} = \frac{fv}{(1+rate)^{nper}}\)

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ pv(rate, nper, pmt}\OperatorTok{=}\VariableTok{None}\NormalTok{, fv}\OperatorTok{=}\VariableTok{None}\NormalTok{, }\BuiltInTok{type}\OperatorTok{=}\VariableTok{None}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ pmt }\KeywordTok{is} \VariableTok{None}\NormalTok{:}
\NormalTok{        pmt }\OperatorTok{=} \DecValTok{0}
    \ControlFlowTok{if}\NormalTok{ fv }\KeywordTok{is} \VariableTok{None}\NormalTok{:}
\NormalTok{        fv }\OperatorTok{=} \DecValTok{0}
    \ControlFlowTok{if} \BuiltInTok{type} \KeywordTok{is} \VariableTok{None}\NormalTok{:}
        \BuiltInTok{type} \OperatorTok{=} \StringTok{\textquotesingle{}END\textquotesingle{}}
    
\NormalTok{    pv\_pmt }\OperatorTok{=}\NormalTok{ (pmt }\OperatorTok{/}\NormalTok{ rate) }\OperatorTok{*}\NormalTok{ (}\DecValTok{1} \OperatorTok{{-}} \DecValTok{1} \OperatorTok{/}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ rate)}\OperatorTok{**}\NormalTok{nper)}
\NormalTok{    pv\_fv }\OperatorTok{=}\NormalTok{ fv }\OperatorTok{/}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ rate)}\OperatorTok{**}\NormalTok{nper}
\NormalTok{    pv }\OperatorTok{=}\NormalTok{ pv\_pmt }\OperatorTok{+}\NormalTok{ pv\_fv}

    \ControlFlowTok{if} \BuiltInTok{type} \OperatorTok{==} \StringTok{\textquotesingle{}BGN\textquotesingle{}}\NormalTok{:}
\NormalTok{        pv }\OperatorTok{*=}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ rate) }\CommentTok{\# same as pv = pv*(1 + rate)}
    
    \ControlFlowTok{return} \OperatorTok{{-}}\DecValTok{1} \OperatorTok{*}\NormalTok{ pv}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pv(rate }\OperatorTok{=} \FloatTok{0.05}\NormalTok{, nper }\OperatorTok{=} \DecValTok{14}\NormalTok{, fv }\OperatorTok{=} \DecValTok{1\_000}\NormalTok{, }\BuiltInTok{type} \OperatorTok{=} \StringTok{\textquotesingle{}END\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-505.0680
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=} \DecValTok{5}
\NormalTok{a}\OperatorTok{*=} \DecValTok{5}
\NormalTok{a}\OperatorTok{*=} \DecValTok{5}
\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
125
\end{verbatim}

\subsection{\texorpdfstring{Write a function that mimic Excel's
\texttt{fv}
function.}{Write a function that mimic Excel's fv function.}}\label{write-a-function-that-mimic-excels-fv-function.-2}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_fv(rate, nper, pmt}\OperatorTok{=}\VariableTok{None}\NormalTok{, pv}\OperatorTok{=}\VariableTok{None}\NormalTok{, }\BuiltInTok{type}\OperatorTok{=}\VariableTok{None}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ pmt }\KeywordTok{is} \VariableTok{None}\NormalTok{:}
\NormalTok{        pmt }\OperatorTok{=} \DecValTok{0}
    \ControlFlowTok{if}\NormalTok{ pv }\KeywordTok{is} \VariableTok{None}\NormalTok{:}
\NormalTok{        pv }\OperatorTok{=} \DecValTok{0}
    \ControlFlowTok{if} \BuiltInTok{type} \KeywordTok{is} \VariableTok{None}\NormalTok{:}
        \BuiltInTok{type} \OperatorTok{=} \StringTok{\textquotesingle{}END\textquotesingle{}}
    
\NormalTok{    fv\_pmt }\OperatorTok{=}\NormalTok{ (pmt }\OperatorTok{/}\NormalTok{ rate) }\OperatorTok{*}\NormalTok{ ((}\DecValTok{1} \OperatorTok{+}\NormalTok{ rate)}\OperatorTok{**}\NormalTok{nper }\OperatorTok{{-}} \DecValTok{1}\NormalTok{)}
\NormalTok{    fv\_pv }\OperatorTok{=}\NormalTok{ pv }\OperatorTok{*}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ rate)}\OperatorTok{**}\NormalTok{nper}
\NormalTok{    fv }\OperatorTok{=}\NormalTok{ fv\_pmt }\OperatorTok{+}\NormalTok{ fv\_pv}

    \ControlFlowTok{if} \BuiltInTok{type} \OperatorTok{==} \StringTok{\textquotesingle{}BGN\textquotesingle{}}\NormalTok{:}
\NormalTok{        fv }\OperatorTok{*=}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ rate) }\CommentTok{\# same as pv = pv*(1 + rate)}
    
    \ControlFlowTok{return} \OperatorTok{{-}}\DecValTok{1} \OperatorTok{*}\NormalTok{ fv}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_fv(rate}\OperatorTok{=}\FloatTok{0.072}\NormalTok{, nper}\OperatorTok{=}\DecValTok{10}\NormalTok{, pv}\OperatorTok{={-}}\DecValTok{1000}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2004.2314
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_fv(rate}\OperatorTok{=}\FloatTok{0.072}\NormalTok{, nper}\OperatorTok{=}\DecValTok{10}\NormalTok{, pmt}\OperatorTok{=}\DecValTok{72}\NormalTok{, pv}\OperatorTok{={-}}\DecValTok{1000}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1000.0000
\end{verbatim}

\subsection{\texorpdfstring{Replace the negative values in \texttt{data}
with -1 and positive values with
+1.}{Replace the negative values in data with -1 and positive values with +1.}}\label{replace-the-negative-values-in-data-with--1-and-positive-values-with-1.-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{data }\OperatorTok{=}\NormalTok{ np.random.randn(}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{)}
\NormalTok{data}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.4967, -0.1383,  0.6477,  1.523 ],
       [-0.2342, -0.2341,  1.5792,  0.7674],
       [-0.4695,  0.5426, -0.4634, -0.4657],
       [ 0.242 , -1.9133, -1.7249, -0.5623]])
\end{verbatim}

One approach, is to slice \texttt{data} with a Boolean array, just like
we did above for the multiples of 3 and 5 exercise.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data[data }\OperatorTok{\textless{}} \DecValTok{0}\NormalTok{] }\OperatorTok{=} \OperatorTok{{-}}\DecValTok{1}
\NormalTok{data[data }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{] }\OperatorTok{=} \OperatorTok{+}\DecValTok{1}

\NormalTok{data}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 1., -1.,  1.,  1.],
       [-1., -1.,  1.,  1.],
       [-1.,  1., -1., -1.],
       [ 1., -1., -1., -1.]])
\end{verbatim}

\textbf{\emph{A second approach, is to use NumPy's \texttt{np.where()}
function.}} \texttt{np.where()} is similar to Excel's \texttt{if()}, but
vectorized!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{data }\OperatorTok{=}\NormalTok{ np.random.randn(}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{)}
\NormalTok{np.where( }\CommentTok{\# Python ignores whitespace inside parentheses ()!}
\NormalTok{    data }\OperatorTok{\textless{}} \DecValTok{0}\NormalTok{, }\CommentTok{\# condition to test}
    \OperatorTok{{-}}\DecValTok{1}\NormalTok{, }\CommentTok{\# result if true}
\NormalTok{    np.where(data }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{, }\OperatorTok{+}\DecValTok{1}\NormalTok{, data) }\CommentTok{\# result if false}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 1., -1.,  1.,  1.],
       [-1., -1.,  1.,  1.],
       [-1.,  1., -1., -1.],
       [ 1., -1., -1., -1.]])
\end{verbatim}

\textbf{\emph{A THIRD approach, is to use NumPy's \texttt{np.select()}
function.}} \texttt{np.select()} is similar to Excel's \texttt{if()},
but vectorized and allows many conditions!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{data }\OperatorTok{=}\NormalTok{ np.random.randn(}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{)}
\NormalTok{np.select( }\CommentTok{\# Python ignores whitespace inside parentheses ()!}
\NormalTok{    condlist}\OperatorTok{=}\NormalTok{[data}\OperatorTok{\textless{}}\DecValTok{0}\NormalTok{, data}\OperatorTok{\textgreater{}}\DecValTok{0}\NormalTok{],}
\NormalTok{    choicelist}\OperatorTok{=}\NormalTok{[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{, }\OperatorTok{+}\DecValTok{1}\NormalTok{],}
\NormalTok{    default}\OperatorTok{=}\NormalTok{data}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 1., -1.,  1.,  1.],
       [-1., -1.,  1.,  1.],
       [-1.,  1., -1., -1.],
       [ 1., -1., -1., -1.]])
\end{verbatim}

\subsection{\texorpdfstring{Write a function \texttt{npmts()} that
calculates the number of payments that generate \(x\%\) of the present
value of a
perpetuity.}{Write a function npmts() that calculates the number of payments that generate x\textbackslash\% of the present value of a perpetuity.}}\label{write-a-function-npmts-that-calculates-the-number-of-payments-that-generate-x-of-the-present-value-of-a-perpetuity.-2}

Your \texttt{npmts()} should accept arguments \texttt{c1}, \texttt{r},
and \texttt{g} that represent \(C_1\), \(r\), and \(g\). The present
value of a growing perpetuity is \(PV = \frac{C_1}{r - g}\), and the
present value of a growing annuity is
\(PV = \frac{C_1}{r - g}\left[ 1 - \left( \frac{1 + g}{1 + r} \right)^t \right]\).

We can use the growing annuity and perpetuity formulas to show:
\(x = \left[ 1 - \left( \frac{1 + g}{1 + r} \right)^t \right]\).

Then: \(1 - x = \left( \frac{1 + g}{1 + r} \right)^t\).

Finally: \(t = \frac{\log(1-x)}{\log\left(\frac{1 + g}{1 + r}\right)}\)

\textbf{\emph{We do not need to accept an argument \texttt{c1} because
\(C_1\) cancels out!}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ npmts(x, r, g):}
    \ControlFlowTok{return}\NormalTok{ np.log(}\DecValTok{1}\OperatorTok{{-}}\NormalTok{x) }\OperatorTok{/}\NormalTok{ np.log((}\DecValTok{1} \OperatorTok{+}\NormalTok{ g) }\OperatorTok{/}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ r))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{npmts(}\FloatTok{0.5}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\FloatTok{0.05}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
14.9000
\end{verbatim}

\subsection{Write a function that calculates the internal rate of return
given a NumPy array of cash
flows.}\label{write-a-function-that-calculates-the-internal-rate-of-return-given-a-numpy-array-of-cash-flows.-2}

Here are some data where the \(IRR\) is obvious!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{c }\OperatorTok{=}\NormalTok{ np.array([}\OperatorTok{{-}}\DecValTok{100}\NormalTok{, }\OperatorTok{+}\DecValTok{110}\NormalTok{])}
\NormalTok{r }\OperatorTok{=} \FloatTok{0.1}
\end{Highlighting}
\end{Shaded}

First, write a function that calculates net present value (NPV) given
cash flows in a NumpPy array \texttt{c} and a discount rate in a scalar
\texttt{r}. The \texttt{npv()} function below uses NumPy arrays to
calculate NPV as: \[NPV = \sum_{t=0}^T \frac{c_t}{(1+r)^t}\]

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_npv(r, c):}
\NormalTok{    t }\OperatorTok{=}\NormalTok{ np.arange(}\BuiltInTok{len}\NormalTok{(c))}
    \ControlFlowTok{return}\NormalTok{ (c }\OperatorTok{/}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ r)}\OperatorTok{**}\NormalTok{t).}\BuiltInTok{sum}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_npv(r}\OperatorTok{=}\NormalTok{r, c}\OperatorTok{=}\NormalTok{c)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-0.0000
\end{verbatim}

We can use a \texttt{while} loop to guess IRR values until we find an
NPV close to zero. We can use the
\href{https://en.wikipedia.org/wiki/Newton\%27s_method}{Newton-Rapshon
method} to make smarter guesses. If we have function \(f(x)\) and guess
\(x_t\), our next guess should be
\(x_{t+1} = x_t - \frac{f(x_t)}{f'(x_t)}\). Here our \(f(x)\) is
\(NPV(r)\), and we can approximate \(f'(x_t)\) as
\(\frac{NPV(r+0.000001) - NPV(r)}{0.000001}\). We will make guess until
\(|NPV| < 0.000001\).

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_irr(c, guess}\OperatorTok{=}\DecValTok{0}\NormalTok{):}
\NormalTok{    irr }\OperatorTok{=}\NormalTok{ guess}
\NormalTok{    npv }\OperatorTok{=}\NormalTok{ calc\_npv(r}\OperatorTok{=}\NormalTok{irr, c}\OperatorTok{=}\NormalTok{c)}
    \ControlFlowTok{while}\NormalTok{ np.}\BuiltInTok{abs}\NormalTok{(npv) }\OperatorTok{\textgreater{}} \FloatTok{1e{-}6}\NormalTok{:}
\NormalTok{        slope }\OperatorTok{=}\NormalTok{ (calc\_npv(r}\OperatorTok{=}\NormalTok{irr}\OperatorTok{+}\FloatTok{1e{-}6}\NormalTok{, c}\OperatorTok{=}\NormalTok{c) }\OperatorTok{{-}}\NormalTok{ npv) }\OperatorTok{/} \FloatTok{1e{-}6}
\NormalTok{        irr }\OperatorTok{=}\NormalTok{ irr }\OperatorTok{{-}}\NormalTok{ npv }\OperatorTok{/}\NormalTok{ slope }\CommentTok{\# N}
\NormalTok{        npv }\OperatorTok{=}\NormalTok{ calc\_npv(r}\OperatorTok{=}\NormalTok{irr, c}\OperatorTok{=}\NormalTok{c)}
        \CommentTok{\# print(f\textquotesingle{}NPV is \{npv\}, and IRR is \{irr\}\textquotesingle{})}

    \ControlFlowTok{return}\NormalTok{ irr}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_irr(c}\OperatorTok{=}\NormalTok{c)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.1000
\end{verbatim}

\subsection{\texorpdfstring{Write a function \texttt{returns()} that
accepts \emph{NumPy arrays} of prices and dividends and returns a
\emph{NumPy array} of
returns.}{Write a function returns() that accepts NumPy arrays of prices and dividends and returns a NumPy array of returns.}}\label{write-a-function-returns-that-accepts-numpy-arrays-of-prices-and-dividends-and-returns-a-numpy-array-of-returns.-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices }\OperatorTok{=}\NormalTok{ np.array([}\DecValTok{100}\NormalTok{, }\DecValTok{150}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{50}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{150}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{150}\NormalTok{])}
\NormalTok{dividends }\OperatorTok{=}\NormalTok{ np.array([}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

We can slice \texttt{prices} to calculate capital gains without a for
loop!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices[}\DecValTok{1}\NormalTok{:] }\OperatorTok{{-}}\NormalTok{ prices[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 50, -50, -50,  50,  50, -50,  50])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(prices[}\DecValTok{1}\NormalTok{:] }\OperatorTok{{-}}\NormalTok{ prices[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{+}\NormalTok{ dividends[}\DecValTok{1}\NormalTok{:]) }\OperatorTok{/}\NormalTok{ prices[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0.51  , -0.3267, -0.49  ,  1.04  ,  0.52  , -0.32  ,  0.52  ])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ returns(p, d):}
    \ControlFlowTok{return}\NormalTok{ (p[}\DecValTok{1}\NormalTok{:] }\OperatorTok{{-}}\NormalTok{ p[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{+}\NormalTok{ d[}\DecValTok{1}\NormalTok{:]) }\OperatorTok{/}\NormalTok{ p[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns(p}\OperatorTok{=}\NormalTok{prices, d}\OperatorTok{=}\NormalTok{dividends)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0.51  , -0.3267, -0.49  ,  1.04  ,  0.52  , -0.32  ,  0.52  ])
\end{verbatim}

\subsection{\texorpdfstring{Rewrite the function \texttt{returns()} so
it returns \emph{NumPy arrays} of returns, capital gains yields, and
dividend
yields.}{Rewrite the function returns() so it returns NumPy arrays of returns, capital gains yields, and dividend yields.}}\label{rewrite-the-function-returns-so-it-returns-numpy-arrays-of-returns-capital-gains-yields-and-dividend-yields.-2}

\subsection{Rescale and shift numbers so that they cover the range {[}0,
1{]}}\label{rescale-and-shift-numbers-so-that-they-cover-the-range-0-1-2}

Input: \texttt{np.array({[}18.5,\ 17.0,\ 18.0,\ 19.0,\ 18.0{]})}\\
Output: \texttt{np.array({[}0.75,\ 0.0,\ 0.5,\ 1.0,\ 0.5{]})}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{numbers }\OperatorTok{=}\NormalTok{ np.array([}\FloatTok{18.5}\NormalTok{, }\FloatTok{17.0}\NormalTok{, }\FloatTok{18.0}\NormalTok{, }\FloatTok{19.0}\NormalTok{, }\FloatTok{18.0}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(numbers }\OperatorTok{{-}}\NormalTok{ numbers.}\BuiltInTok{min}\NormalTok{()) }\OperatorTok{/}\NormalTok{ (numbers.}\BuiltInTok{max}\NormalTok{() }\OperatorTok{{-}}\NormalTok{ numbers.}\BuiltInTok{min}\NormalTok{())}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0.75, 0.  , 0.5 , 1.  , 0.5 ])
\end{verbatim}

\subsection{\texorpdfstring{Write functions \texttt{var()} and
\texttt{std()} that calculate variance and standard
deviation.}{Write functions var() and std() that calculate variance and standard deviation.}}\label{write-functions-var-and-std-that-calculate-variance-and-standard-deviation.-2}

NumPy's \texttt{.var()} and \texttt{.std()} methods return
\emph{population} statistics (i.e., denominators of \(n\)). The pandas
equivalents return \emph{sample} statistics (denominators of \(n-1\)),
which are more appropriate for financial data analysis where we have a
sample instead of a population.

Both function should have an argument \texttt{sample} that is
\texttt{True} by default so both functions return sample statistics by
default.

Use \texttt{numbers} to compare your functions with NumPy's
\texttt{.var()} and \texttt{.std()} methods.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{((numbers }\OperatorTok{{-}}\NormalTok{ numbers.mean())}\OperatorTok{**}\DecValTok{2}\NormalTok{).mean()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.4400
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{numbers.var()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.4400
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ var(x, sample}\OperatorTok{=}\VariableTok{True}\NormalTok{):}
\NormalTok{    mu\_x }\OperatorTok{=}\NormalTok{ x.mean()}
    \ControlFlowTok{return}\NormalTok{ ((x }\OperatorTok{{-}}\NormalTok{ mu\_x)}\OperatorTok{**}\DecValTok{2}\NormalTok{).}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{/}\NormalTok{ (}\BuiltInTok{len}\NormalTok{(x) }\OperatorTok{{-}}\NormalTok{ sample)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{var(numbers)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.5500
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{var(numbers) }\OperatorTok{==}\NormalTok{ numbers.var(ddof}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{var(numbers, sample}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.4400
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{var(numbers, sample}\OperatorTok{=}\VariableTok{False}\NormalTok{) }\OperatorTok{==}\NormalTok{ numbers.var()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ std(x, sample}\OperatorTok{=}\VariableTok{True}\NormalTok{):}
    \ControlFlowTok{return}\NormalTok{ np.sqrt(var(x}\OperatorTok{=}\NormalTok{x, sample}\OperatorTok{=}\NormalTok{sample))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{std(numbers, sample}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.6633
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{std(numbers, sample}\OperatorTok{=}\VariableTok{False}\NormalTok{) }\OperatorTok{==}\NormalTok{ numbers.std()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{std(numbers)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.7416
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{std(numbers) }\OperatorTok{==}\NormalTok{ numbers.std(ddof}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\chapter{McKinney Chapter 4 - Practice for Section
05}\label{mckinney-chapter-4---practice-for-section-05}

\section{Announcements}\label{announcements-11}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Our second DataCamp course, \emph{Intermediate Python}, is due Friday,
  1/26, at 11:59 PM
\item
  I will record our week 4 lecture video on McKinney chapter 5 this
  Thursday evening, and the week 4 pre-class quiz is due before class
  next Tuesday, 1/30
\item
  Team projects

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Continue to join teams on Canvas \textgreater{} People
    \textgreater{} Team Projects
  \item
    I removed the join-a-team assignment, but I will give the first
    project assignment in early February, so join a team by then
  \end{enumerate}
\end{enumerate}

\section{10-minute Recap}\label{minute-recap-10}

\subsection{NumPy Arrays}\label{numpy-arrays-3}

NumPy arrays are multidimensional data structures that can store
numerical data efficiently and perform fast mathematical operations on
them.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ this}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
The Zen of Python, by Tim Peters

Beautiful is better than ugly.
Explicit is better than implicit.
Simple is better than complex.
Complex is better than complicated.
Flat is better than nested.
Sparse is better than dense.
Readability counts.
Special cases aren't special enough to break the rules.
Although practicality beats purity.
Errors should never pass silently.
Unless explicitly silenced.
In the face of ambiguity, refuse the temptation to guess.
There should be one-- and preferably only one --obvious way to do it.
Although that way may not be obvious at first unless you're Dutch.
Now is better than never.
Although never is often better than *right* now.
If the implementation is hard to explain, it's a bad idea.
If the implementation is easy to explain, it may be a good idea.
Namespaces are one honking great idea -- let's do more of those!
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'%.4f'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.arange(}\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.ones(}\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([1., 1., 1., 1., 1., 1., 1., 1., 1., 1.])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.ones((}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[1., 1.],
       [1., 1.]])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.ones((}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[[[1., 1.],
         [1., 1.]],

        [[1., 1.],
         [1., 1.]]],


       [[[1., 1.],
         [1., 1.]],

        [[1., 1.],
         [1., 1.]]]])
\end{verbatim}

We will use standard normal random variables from
\texttt{np.random.randn()} to tinker with ideas. If we want to get the
same random numbers (every time and across computers), we should use
\texttt{np.random.seed()} to set the seed of the random number
generator.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{np.random.randn(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.4967, -0.1383],
       [ 0.6477,  1.523 ]])
\end{verbatim}

\subsection{Vectorized Functions}\label{vectorized-functions-3}

Vectorized computation is the process of applying an operation to an
entire array or a subset of an array without using explicit loops. NumPy
supports vectorized computation using universal functions (ufuncs),
which are functions that operate on arrays element-wise.

\begin{Shaded}
\begin{Highlighting}[]
\DecValTok{4}\OperatorTok{**}\NormalTok{(}\DecValTok{1}\OperatorTok{/}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2.0000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.sqrt(}\DecValTok{4}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2.0000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.arange(}\DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0, 1, 2, 3, 4])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.sqrt(np.arange(}\DecValTok{5}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0.    , 1.    , 1.4142, 1.7321, 2.    ])
\end{verbatim}

\subsection{Indexing and Slicing}\label{indexing-and-slicing-3}

Indexing and slicing are techniques to access or modify specific
elements or subsets of an array. NumPy also supports advanced indexing
methods, such as fancy indexing and boolean indexing, which allow more
flexible and complex selection of array elements.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{) }\CommentTok{\# 42 is the answer to everything from *The Hitchhikers Guide to the Galaxy*}
\NormalTok{my\_array }\OperatorTok{=}\NormalTok{ np.random.randn(}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{)}

\NormalTok{my\_array}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.4967, -0.1383,  0.6477],
       [ 1.523 , -0.2342, -0.2341],
       [ 1.5792,  0.7674, -0.4695]])
\end{verbatim}

We can index the ``first row'' with the \texttt{{[}0{]}} index.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_array[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0.4967, -0.1383,  0.6477])
\end{verbatim}

We can index the first element in the first row by chaining a
\texttt{{[}0{]}} index.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_array[}\DecValTok{0}\NormalTok{][}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.4967
\end{verbatim}

A simpler syntax for \texttt{{[}0{]}{[}0{]}} is \texttt{{[}0,\ 0{]}},
which has a \(i, j\) interpretation!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_array[}\DecValTok{0}\NormalTok{, }\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.4967
\end{verbatim}

we can combine this notation with slices, like for lists! What if we
want the first two columns in the first two rows?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_array[:}\DecValTok{2}\NormalTok{] }\CommentTok{\# first two rows}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.4967, -0.1383,  0.6477],
       [ 1.523 , -0.2342, -0.2341]])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_array[:}\DecValTok{2}\NormalTok{][:}\DecValTok{2}\NormalTok{] }\CommentTok{\# first two rows and first two columns}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.4967, -0.1383,  0.6477],
       [ 1.523 , -0.2342, -0.2341]])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{my\_array[:}\DecValTok{2}\NormalTok{, :}\DecValTok{2}\NormalTok{] }\CommentTok{\# first two rows and first two columns}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.4967, -0.1383],
       [ 1.523 , -0.2342]])
\end{verbatim}

\section{Practice}\label{practice-11}

\subsection{\texorpdfstring{Create a 1-dimensional array named
\texttt{a1} that counts from 0 to 24 by
1.}{Create a 1-dimensional array named a1 that counts from 0 to 24 by 1.}}\label{create-a-1-dimensional-array-named-a1-that-counts-from-0-to-24-by-1.-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a1 }\OperatorTok{=}\NormalTok{ np.arange(}\DecValTok{25}\NormalTok{)}

\NormalTok{a1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16,
       17, 18, 19, 20, 21, 22, 23, 24])
\end{verbatim}

The above is much easier than a step-by-step solution!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.array(}\BuiltInTok{list}\NormalTok{(}\BuiltInTok{range}\NormalTok{(}\DecValTok{25}\NormalTok{)))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0,  1,  2,  3,  4,  5,  6,  7,  8,  9, 10, 11, 12, 13, 14, 15, 16,
       17, 18, 19, 20, 21, 22, 23, 24])
\end{verbatim}

\subsection{\texorpdfstring{Create a 1-dimentional array named
\texttt{a2} that counts from 0 to 24 by
3.}{Create a 1-dimentional array named a2 that counts from 0 to 24 by 3.}}\label{create-a-1-dimentional-array-named-a2-that-counts-from-0-to-24-by-3.-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a2 }\OperatorTok{=}\NormalTok{ np.arange(}\DecValTok{0}\NormalTok{, }\DecValTok{25}\NormalTok{, }\DecValTok{3}\NormalTok{) }\CommentTok{\# start, stop, size (if we want to give size, we must give start)}

\NormalTok{a2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0,  3,  6,  9, 12, 15, 18, 21, 24])
\end{verbatim}

\subsection{\texorpdfstring{Create a 1-dimentional array named
\texttt{a3} that counts from 0 to 100 by multiples of 3 or
5.}{Create a 1-dimentional array named a3 that counts from 0 to 100 by multiples of 3 or 5.}}\label{create-a-1-dimentional-array-named-a3-that-counts-from-0-to-100-by-multiples-of-3-or-5.-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a3 }\OperatorTok{=}\NormalTok{ np.array([i }\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{101}\NormalTok{) }\ControlFlowTok{if}\NormalTok{ (i}\OperatorTok{\%}\DecValTok{3}\OperatorTok{==}\DecValTok{0}\NormalTok{) }\OperatorTok{|}\NormalTok{ (i}\OperatorTok{\%}\DecValTok{5}\OperatorTok{==}\DecValTok{0}\NormalTok{)])}

\NormalTok{a3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([  0,   3,   5,   6,   9,  10,  12,  15,  18,  20,  21,  24,  25,
        27,  30,  33,  35,  36,  39,  40,  42,  45,  48,  50,  51,  54,
        55,  57,  60,  63,  65,  66,  69,  70,  72,  75,  78,  80,  81,
        84,  85,  87,  90,  93,  95,  96,  99, 100])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a3\_alt }\OperatorTok{=}\NormalTok{ np.arange(}\DecValTok{101}\NormalTok{)}
\NormalTok{a3\_alt }\OperatorTok{=}\NormalTok{ a3\_alt[ (a3\_alt}\OperatorTok{\%}\DecValTok{3}\OperatorTok{==}\DecValTok{0}\NormalTok{) }\OperatorTok{|}\NormalTok{ (a3\_alt}\OperatorTok{\%}\DecValTok{5}\OperatorTok{==}\DecValTok{0}\NormalTok{) ]}

\NormalTok{a3\_alt}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([  0,   3,   5,   6,   9,  10,  12,  15,  18,  20,  21,  24,  25,
        27,  30,  33,  35,  36,  39,  40,  42,  45,  48,  50,  51,  54,
        55,  57,  60,  63,  65,  66,  69,  70,  72,  75,  78,  80,  81,
        84,  85,  87,  90,  93,  95,  96,  99, 100])
\end{verbatim}

How can we make sure these two answers are iedntical?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a3 }\OperatorTok{==}\NormalTok{ a3\_alt}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ True,  True,  True,  True,  True,  True,  True,  True,  True,
        True,  True,  True,  True,  True,  True,  True,  True,  True,
        True,  True,  True,  True,  True,  True,  True,  True,  True,
        True,  True,  True,  True,  True,  True,  True,  True,  True,
        True,  True,  True,  True,  True,  True,  True,  True,  True,
        True,  True,  True])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(a3 }\OperatorTok{==}\NormalTok{ a3\_alt).}\BuiltInTok{all}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(a3, a3\_alt)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\subsection{\texorpdfstring{Create a 1-dimensional array \texttt{a3}
that contains the squares of the even integers through
100,000.}{Create a 1-dimensional array a3 that contains the squares of the even integers through 100,000.}}\label{create-a-1-dimensional-array-a3-that-contains-the-squares-of-the-even-integers-through-100000.-3}

How much faster is the NumPy version than the list comprehension
version?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.arange(}\DecValTok{0}\NormalTok{, }\DecValTok{100\_001}\NormalTok{, }\DecValTok{2}\NormalTok{)}\OperatorTok{**}\DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([         0,          4,         16, ..., 1409265424, 1409665412,
       1410065408])
\end{verbatim}

On some computers, the output above is wrong because NumPy defaults to
32-bit integers, depending on the computer! \textbf{\emph{Always check
your output!}} To avoid this problem, we can force \texttt{np.arange()}
to use 64-bit integers with the \texttt{dtype=} argument.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.arange(}\DecValTok{0}\NormalTok{, }\DecValTok{100\_001}\NormalTok{, }\DecValTok{2}\NormalTok{, dtype}\OperatorTok{=}\NormalTok{np.int64)}\OperatorTok{**}\DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([          0,           4,          16, ...,  9999200016,
        9999600004, 10000000000], dtype=int64)
\end{verbatim}

We can use the \texttt{\%timeit} magic to time which code is faster! The
\texttt{\%timeit} magic runs the code on the same line many times and
reports the mean computation time. The \texttt{\%\%timet} magic with two
percent signs runs the code in the same cell many times and reports the
mean computation time.

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{timeit np.arange(}\DecValTok{0}\NormalTok{, }\DecValTok{100\_001}\NormalTok{, }\DecValTok{2}\NormalTok{, dtype}\OperatorTok{=}\NormalTok{np.int64)}\OperatorTok{**}\DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
47.8 µs ± 4.61 µs per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{timeit np.array([i}\OperatorTok{**}\DecValTok{2} \ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{0}\NormalTok{, }\DecValTok{100\_001}\NormalTok{)])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
13.6 ms ± 761 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
\end{verbatim}

The NumPy version is about 1,000 times faster!

\subsection{\texorpdfstring{Write a function that mimic Excel's
\texttt{pv}
function.}{Write a function that mimic Excel's pv function.}}\label{write-a-function-that-mimic-excels-pv-function.-3}

Here is how we call Excel's \texttt{pv} function:
\texttt{=PV(rate,\ nper,\ pmt,\ {[}fv{]},\ {[}type{]})} We can use the
annuity and lump sum present value formulas.

Present value of an annuity payment \texttt{pmt}:
\(PV_{pmt} = \frac{pmt}{rate} \times \left(1 - \frac{1}{(1+rate)^{nper}} \right)\)

Present value of a lump sum \texttt{fv}:
\(PV_{fv} = \frac{fv}{(1+rate)^{nper}}\)

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ pv(rate, nper, pmt}\OperatorTok{=}\VariableTok{None}\NormalTok{, fv}\OperatorTok{=}\VariableTok{None}\NormalTok{, }\BuiltInTok{type}\OperatorTok{=}\VariableTok{None}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ pmt }\KeywordTok{is} \VariableTok{None}\NormalTok{:}
\NormalTok{        pmt }\OperatorTok{=} \DecValTok{0}
    \ControlFlowTok{if}\NormalTok{ fv }\KeywordTok{is} \VariableTok{None}\NormalTok{:}
\NormalTok{        fv }\OperatorTok{=} \DecValTok{0}
    \ControlFlowTok{if} \BuiltInTok{type} \KeywordTok{is} \VariableTok{None}\NormalTok{:}
        \BuiltInTok{type} \OperatorTok{=} \StringTok{\textquotesingle{}END\textquotesingle{}}
        
\NormalTok{    pv\_pmt }\OperatorTok{=}\NormalTok{ (pmt }\OperatorTok{/}\NormalTok{ rate) }\OperatorTok{*}\NormalTok{ (}\DecValTok{1} \OperatorTok{{-}} \DecValTok{1} \OperatorTok{/}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ rate)}\OperatorTok{**}\NormalTok{nper)}
\NormalTok{    pv\_fv }\OperatorTok{=}\NormalTok{ fv }\OperatorTok{/}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ rate)}\OperatorTok{**}\NormalTok{nper}
\NormalTok{    pv }\OperatorTok{=} \OperatorTok{{-}}\DecValTok{1} \OperatorTok{*}\NormalTok{ (pv\_pmt }\OperatorTok{+}\NormalTok{ pv\_fv)}

    \ControlFlowTok{if} \BuiltInTok{type} \OperatorTok{==} \StringTok{\textquotesingle{}BGN\textquotesingle{}}\NormalTok{:}
\NormalTok{        pv }\OperatorTok{*=}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ rate) }\CommentTok{\# same as pv = pv*(1 + rate)}
    
    \ControlFlowTok{return} \OperatorTok{{-}}\DecValTok{1} \OperatorTok{*}\NormalTok{ pv}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pv(rate }\OperatorTok{=} \FloatTok{0.05}\NormalTok{, nper }\OperatorTok{=} \DecValTok{1\_000}\NormalTok{, pmt }\OperatorTok{=} \DecValTok{5}\NormalTok{, }\BuiltInTok{type} \OperatorTok{=} \StringTok{\textquotesingle{}BGN\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
105.0000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=} \DecValTok{5}
\NormalTok{a}\OperatorTok{*=} \DecValTok{5}
\NormalTok{a}\OperatorTok{*=} \DecValTok{5}
\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
125
\end{verbatim}

\subsection{\texorpdfstring{Write a function that mimic Excel's
\texttt{fv}
function.}{Write a function that mimic Excel's fv function.}}\label{write-a-function-that-mimic-excels-fv-function.-3}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_fv(rate, nper, pmt}\OperatorTok{=}\VariableTok{None}\NormalTok{, pv}\OperatorTok{=}\VariableTok{None}\NormalTok{, }\BuiltInTok{type}\OperatorTok{=}\VariableTok{None}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ pmt }\KeywordTok{is} \VariableTok{None}\NormalTok{:}
\NormalTok{        pmt }\OperatorTok{=} \DecValTok{0}
    \ControlFlowTok{if}\NormalTok{ pv }\KeywordTok{is} \VariableTok{None}\NormalTok{:}
\NormalTok{        pv }\OperatorTok{=} \DecValTok{0}
    \ControlFlowTok{if} \BuiltInTok{type} \KeywordTok{is} \VariableTok{None}\NormalTok{:}
        \BuiltInTok{type} \OperatorTok{=} \StringTok{\textquotesingle{}END\textquotesingle{}}
    
\NormalTok{    fv\_pmt }\OperatorTok{=}\NormalTok{ (pmt }\OperatorTok{/}\NormalTok{ rate) }\OperatorTok{*}\NormalTok{ ((}\DecValTok{1} \OperatorTok{+}\NormalTok{ rate)}\OperatorTok{**}\NormalTok{nper }\OperatorTok{{-}} \DecValTok{1}\NormalTok{)}
\NormalTok{    fv\_pv }\OperatorTok{=}\NormalTok{ pv }\OperatorTok{*}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ rate)}\OperatorTok{**}\NormalTok{nper}
\NormalTok{    fv }\OperatorTok{=}\NormalTok{ fv\_pmt }\OperatorTok{+}\NormalTok{ fv\_pv}

    \ControlFlowTok{if} \BuiltInTok{type} \OperatorTok{==} \StringTok{\textquotesingle{}BGN\textquotesingle{}}\NormalTok{:}
\NormalTok{        fv }\OperatorTok{*=}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ rate) }\CommentTok{\# same as pv = pv*(1 + rate)}
    
    \ControlFlowTok{return} \OperatorTok{{-}}\DecValTok{1} \OperatorTok{*}\NormalTok{ fv}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_fv(rate}\OperatorTok{=}\FloatTok{0.072}\NormalTok{, nper}\OperatorTok{=}\DecValTok{10}\NormalTok{, pv}\OperatorTok{={-}}\DecValTok{1000}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2004.2314
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_fv(rate}\OperatorTok{=}\FloatTok{0.072}\NormalTok{, nper}\OperatorTok{=}\DecValTok{10}\NormalTok{, pmt}\OperatorTok{=}\DecValTok{72}\NormalTok{, pv}\OperatorTok{={-}}\DecValTok{1000}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1000.0000
\end{verbatim}

\subsection{\texorpdfstring{Replace the negative values in \texttt{data}
with -1 and positive values with
+1.}{Replace the negative values in data with -1 and positive values with +1.}}\label{replace-the-negative-values-in-data-with--1-and-positive-values-with-1.-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{data }\OperatorTok{=}\NormalTok{ np.random.randn(}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{)}
\NormalTok{data}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.4967, -0.1383,  0.6477,  1.523 ],
       [-0.2342, -0.2341,  1.5792,  0.7674],
       [-0.4695,  0.5426, -0.4634, -0.4657],
       [ 0.242 , -1.9133, -1.7249, -0.5623]])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data[data }\OperatorTok{\textless{}} \DecValTok{0}\NormalTok{] }\OperatorTok{=} \OperatorTok{{-}}\DecValTok{1}
\NormalTok{data[data }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{] }\OperatorTok{=} \OperatorTok{+}\DecValTok{1}

\NormalTok{data }\CommentTok{\# here "1." and "{-}1." indicate that these values are floats}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 1., -1.,  1.,  1.],
       [-1., -1.,  1.,  1.],
       [-1.,  1., -1., -1.],
       [ 1., -1., -1., -1.]])
\end{verbatim}

\textbf{\emph{Here is a second option!}} NumPy's \texttt{np.where()}
function has the same logic as Excel's \texttt{if()} function! I will
recreate \texttt{data} so we start from the same point.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{data }\OperatorTok{=}\NormalTok{ np.random.randn(}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{)}

\NormalTok{np.where(data }\OperatorTok{\textless{}} \DecValTok{0}\NormalTok{, }\OperatorTok{{-}}\DecValTok{1}\NormalTok{, np.where(data }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{, }\OperatorTok{+}\DecValTok{1}\NormalTok{, data))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 1., -1.,  1.,  1.],
       [-1., -1.,  1.,  1.],
       [-1.,  1., -1., -1.],
       [ 1., -1., -1., -1.]])
\end{verbatim}

The nested \texttt{np.where()} function calls can get confusing! An
option is to insert white space!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{data }\OperatorTok{=}\NormalTok{ np.random.randn(}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{)}

\NormalTok{np.where(}
\NormalTok{    data }\OperatorTok{\textless{}} \DecValTok{0}\NormalTok{, }\CommentTok{\# condition}
    \OperatorTok{{-}}\DecValTok{1}\NormalTok{, }\CommentTok{\# result if True}
\NormalTok{    np.where(data }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{, }\OperatorTok{+}\DecValTok{1}\NormalTok{, data) }\CommentTok{\# result if False}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 1., -1.,  1.,  1.],
       [-1., -1.,  1.,  1.],
       [-1.,  1., -1., -1.],
       [ 1., -1., -1., -1.]])
\end{verbatim}

\textbf{\emph{Here is a third option!}} NumPy's \texttt{np.select()}
function lets us test \emph{many} conditions! I will recreate
\texttt{data} so we start from the same point.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{data }\OperatorTok{=}\NormalTok{ np.random.randn(}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{)}

\NormalTok{np.select(}
\NormalTok{    condlist}\OperatorTok{=}\NormalTok{[data}\OperatorTok{\textless{}}\DecValTok{0}\NormalTok{, data}\OperatorTok{\textgreater{}}\DecValTok{0}\NormalTok{],}
\NormalTok{    choicelist}\OperatorTok{=}\NormalTok{[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{, }\OperatorTok{+}\DecValTok{1}\NormalTok{],}
\NormalTok{    default}\OperatorTok{=}\NormalTok{data}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 1., -1.,  1.,  1.],
       [-1., -1.,  1.,  1.],
       [-1.,  1., -1., -1.],
       [ 1., -1., -1., -1.]])
\end{verbatim}

\subsection{\texorpdfstring{Write a function \texttt{npmts()} that
calculates the number of payments that generate \(x\%\) of the present
value of a
perpetuity.}{Write a function npmts() that calculates the number of payments that generate x\textbackslash\% of the present value of a perpetuity.}}\label{write-a-function-npmts-that-calculates-the-number-of-payments-that-generate-x-of-the-present-value-of-a-perpetuity.-3}

Your \texttt{npmts()} should accept arguments \texttt{c1}, \texttt{r},
and \texttt{g} that represent \(C_1\), \(r\), and \(g\). The present
value of a growing perpetuity is \(PV = \frac{C_1}{r - g}\), and the
present value of a growing annuity is
\(PV = \frac{C_1}{r - g}\left[ 1 - \left( \frac{1 + g}{1 + r} \right)^t \right]\).

We can use the growing annuity and perpetuity formulas to show:
\(x = \left[ 1 - \left( \frac{1 + g}{1 + r} \right)^t \right]\).

Then: \(1 - x = \left( \frac{1 + g}{1 + r} \right)^t\).

Finally: \(t = \frac{\log(1-x)}{\log\left(\frac{1 + g}{1 + r}\right)}\)

\textbf{\emph{We do not need to accept an argument \texttt{c1} because
\(C_1\) cancels out!}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ npmts(x, r, g):}
    \ControlFlowTok{return}\NormalTok{ np.log(}\DecValTok{1}\OperatorTok{{-}}\NormalTok{x) }\OperatorTok{/}\NormalTok{ np.log((}\DecValTok{1} \OperatorTok{+}\NormalTok{ g) }\OperatorTok{/}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ r))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{npmts(}\FloatTok{0.5}\NormalTok{, }\FloatTok{0.1}\NormalTok{, }\FloatTok{0.05}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
14.9000
\end{verbatim}

\subsection{Write a function that calculates the internal rate of return
given a NumPy array of cash
flows.}\label{write-a-function-that-calculates-the-internal-rate-of-return-given-a-numpy-array-of-cash-flows.-3}

Let us pick a set of cash flows \texttt{c} where we know the internal
rate of return! For the following \texttt{c}, the IRR is 10\%.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{c }\OperatorTok{=}\NormalTok{ np.array([}\OperatorTok{{-}}\DecValTok{100}\NormalTok{, }\OperatorTok{+}\DecValTok{110}\NormalTok{])}
\NormalTok{r }\OperatorTok{=} \FloatTok{0.1}
\end{Highlighting}
\end{Shaded}

First we need an function to calculate net present value (NPV) from
\texttt{c} and \texttt{r}! The \texttt{npv()} function below uses NumPy
arrays to calculate NPV as: \[NPV = \sum_{t=0}^T \frac{c_t}{(1+r)^t}\]

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_npv(r, c):}
\NormalTok{    t }\OperatorTok{=}\NormalTok{ np.arange(}\BuiltInTok{len}\NormalTok{(c))}
    \ControlFlowTok{return}\NormalTok{ (c }\OperatorTok{/}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ r)}\OperatorTok{**}\NormalTok{t).}\BuiltInTok{sum}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_npv(r}\OperatorTok{=}\NormalTok{r, c}\OperatorTok{=}\NormalTok{c)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-0.0000
\end{verbatim}

We can use a \texttt{while} loop to guess IRR values until we find an
NPV close to zero. We can use the
\href{https://en.wikipedia.org/wiki/Newton\%27s_method}{Newton-Rapshon
method} to make smarter guesses. If we have function \(f(x)\) and guess
\(x_t\), our next guess should be
\(x_{t+1} = x_t - \frac{f(x_t)}{f'(x_t)}\). Here our \(f(x)\) is
\(NPV(r)\), and we can approximate \(f'(x_t)\) as
\(\frac{NPV(r+0.000001) - NPV(r)}{0.000001}\). We will make guess until
\(|NPV| < 0.000001\).

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_irr(c, guess}\OperatorTok{=}\DecValTok{0}\NormalTok{, tol}\OperatorTok{=}\FloatTok{1e{-}6}\NormalTok{, step}\OperatorTok{=}\FloatTok{1e{-}6}\NormalTok{):}
\NormalTok{    irr }\OperatorTok{=}\NormalTok{ guess}
\NormalTok{    npv }\OperatorTok{=}\NormalTok{ calc\_npv(r}\OperatorTok{=}\NormalTok{irr, c}\OperatorTok{=}\NormalTok{c)}
    \ControlFlowTok{while}\NormalTok{ np.}\BuiltInTok{abs}\NormalTok{(npv) }\OperatorTok{\textgreater{}}\NormalTok{ tol:}
\NormalTok{        deriv }\OperatorTok{=}\NormalTok{ (calc\_npv(r}\OperatorTok{=}\NormalTok{irr}\OperatorTok{+}\NormalTok{step, c}\OperatorTok{=}\NormalTok{c) }\OperatorTok{{-}}\NormalTok{ npv) }\OperatorTok{/}\NormalTok{ step }\CommentTok{\# Delta NPV / Delta r}
\NormalTok{        irr }\OperatorTok{=}\NormalTok{ irr }\OperatorTok{{-}}\NormalTok{ npv }\OperatorTok{/}\NormalTok{ deriv}
\NormalTok{        npv }\OperatorTok{=}\NormalTok{ calc\_npv(r}\OperatorTok{=}\NormalTok{irr, c}\OperatorTok{=}\NormalTok{c)}
        \CommentTok{\# print(f\textquotesingle{}IRR is \{irr\}, and NPV is \{npv\}\textquotesingle{})}
    \ControlFlowTok{return}\NormalTok{ irr}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_irr(c}\OperatorTok{=}\NormalTok{c)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.1000
\end{verbatim}

\subsection{\texorpdfstring{Write a function \texttt{returns()} that
accepts \emph{NumPy arrays} of prices and dividends and returns a
\emph{NumPy array} of
returns.}{Write a function returns() that accepts NumPy arrays of prices and dividends and returns a NumPy array of returns.}}\label{write-a-function-returns-that-accepts-numpy-arrays-of-prices-and-dividends-and-returns-a-numpy-array-of-returns.-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices }\OperatorTok{=}\NormalTok{ np.array([}\DecValTok{100}\NormalTok{, }\DecValTok{150}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{50}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{150}\NormalTok{, }\DecValTok{100}\NormalTok{, }\DecValTok{150}\NormalTok{])}
\NormalTok{dividends }\OperatorTok{=}\NormalTok{ np.array([}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

We want to slice our arrays to ``lag'' or ``shift'' them! For example,
we slice the \texttt{prices} array to calculate capital gains as
follows.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices[}\DecValTok{1}\NormalTok{:] }\OperatorTok{{-}}\NormalTok{ prices[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 50, -50, -50,  50,  50, -50,  50])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ returns(p, d):}
    \ControlFlowTok{return}\NormalTok{ (p[}\DecValTok{1}\NormalTok{:] }\OperatorTok{{-}}\NormalTok{ p[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{+}\NormalTok{ d[}\DecValTok{1}\NormalTok{:]) }\OperatorTok{/}\NormalTok{ p[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns(p}\OperatorTok{=}\NormalTok{prices, d}\OperatorTok{=}\NormalTok{dividends)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 0.51  , -0.3267, -0.49  ,  1.04  ,  0.52  , -0.32  ,  0.52  ])
\end{verbatim}

\subsection{\texorpdfstring{Rewrite the function \texttt{returns()} so
it returns \emph{NumPy arrays} of returns, capital gains yields, and
dividend
yields.}{Rewrite the function returns() so it returns NumPy arrays of returns, capital gains yields, and dividend yields.}}\label{rewrite-the-function-returns-so-it-returns-numpy-arrays-of-returns-capital-gains-yields-and-dividend-yields.-3}

\subsection{Rescale and shift numbers so that they cover the range {[}0,
1{]}}\label{rescale-and-shift-numbers-so-that-they-cover-the-range-0-1-3}

Input: \texttt{np.array({[}18.5,\ 17.0,\ 18.0,\ 19.0,\ 18.0{]})}\\
Output: \texttt{np.array({[}0.75,\ 0.0,\ 0.5,\ 1.0,\ 0.5{]})}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{numbers }\OperatorTok{=}\NormalTok{ np.array([}\FloatTok{18.5}\NormalTok{, }\FloatTok{17.0}\NormalTok{, }\FloatTok{18.0}\NormalTok{, }\FloatTok{19.0}\NormalTok{, }\FloatTok{18.0}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\subsection{\texorpdfstring{Write functions \texttt{var()} and
\texttt{std()} that calculate variance and standard
deviation.}{Write functions var() and std() that calculate variance and standard deviation.}}\label{write-functions-var-and-std-that-calculate-variance-and-standard-deviation.-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{((numbers }\OperatorTok{{-}}\NormalTok{ numbers.mean())}\OperatorTok{**}\DecValTok{2}\NormalTok{).mean()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.4400
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{numbers.var()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.4400
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ var(x, sample}\OperatorTok{=}\VariableTok{True}\NormalTok{):}
\NormalTok{    mu\_x }\OperatorTok{=}\NormalTok{ x.mean()}
    \ControlFlowTok{return}\NormalTok{ ((x }\OperatorTok{{-}}\NormalTok{ mu\_x)}\OperatorTok{**}\DecValTok{2}\NormalTok{).}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{/}\NormalTok{ (}\BuiltInTok{len}\NormalTok{(x) }\OperatorTok{{-}}\NormalTok{ sample)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{var(numbers)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.5500
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{var(numbers) }\OperatorTok{==}\NormalTok{ numbers.var(ddof}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{var(numbers, sample}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.4400
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{var(numbers, sample}\OperatorTok{=}\VariableTok{False}\NormalTok{) }\OperatorTok{==}\NormalTok{ numbers.var()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ std(x, sample}\OperatorTok{=}\VariableTok{True}\NormalTok{):}
    \ControlFlowTok{return}\NormalTok{ np.sqrt(var(x}\OperatorTok{=}\NormalTok{x, sample}\OperatorTok{=}\NormalTok{sample))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{std(numbers, sample}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.6633
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{std(numbers, sample}\OperatorTok{=}\VariableTok{False}\NormalTok{) }\OperatorTok{==}\NormalTok{ numbers.std()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{std(numbers)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.7416
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{std(numbers) }\OperatorTok{==}\NormalTok{ numbers.std(ddof}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\part{Week 4}

\chapter{McKinney Chapter 5 - Getting Started with
pandas}\label{mckinney-chapter-5---getting-started-with-pandas}

\section{Introduction}\label{introduction-3}

Chapter 5 of Wes McKinney's
\href{https://wesmckinney.com/book/}{\emph{Python for Data Analysis}}
discusses the fundamentals of pandas, which will be our main tool for
the rest of the semester. pandas is an abbreviation for \emph{pan}el
\emph{da}ta, which provide time-stamped data for multiple individuals or
firms.

\textbf{\emph{Note:}} Indented block quotes are from McKinney unless
otherwise indicated. The section numbers here differ from McKinney
because we will only discuss some topics.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\begin{quote}
pandas will be a major tool of interest throughout much of the rest of
the book. It contains data structures and data manipulation tools
designed to make data cleaning and analysis fast and easy in Python.
pandas is often used in tandem with numerical computing tools like NumPy
and SciPy, analytical libraries like statsmodels and scikit-learn, and
data visualization libraries like matplotlib. pandas adopts significant
parts of NumPy's idiomatic style of array-based computing, especially
array-based functions and a preference for data processing without for
loops.

While pandas adopts many coding idioms from NumPy, the biggest
difference is that pandas is designed for working with tabular or
heterogeneous data. NumPy, by contrast, is best suited for working with
homogeneous numerical array data.
\end{quote}

We will use pandas---a wrapper for NumPy that helps us manipulate and
combine data---every day for the rest of the course.

\section{Introduction to pandas Data
Structures}\label{introduction-to-pandas-data-structures}

\begin{quote}
To get started with pandas, you will need to get comfortable with its
two workhorse data structures: Series and DataFrame. While they are not
a universal solution for every problem, they provide a solid,
easy-to-use basis for most applications.
\end{quote}

\subsection{Series}\label{series}

\begin{quote}
A Series is a one-dimensional array-like object containing a sequence of
values (of similar types to NumPy types) and an associated array of data
labels, called its index. The simplest Series is formed from only an
array of data.
\end{quote}

The early examples use integer and string labels, but date-time labels
are most useful.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{obj }\OperatorTok{=}\NormalTok{ pd.Series([}\DecValTok{4}\NormalTok{, }\DecValTok{7}\NormalTok{, }\OperatorTok{{-}}\DecValTok{5}\NormalTok{, }\DecValTok{3}\NormalTok{])}
\NormalTok{obj}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0    4
1    7
2   -5
3    3
dtype: int64
\end{verbatim}

Contrast \texttt{obj} with a NumPy array equivalent:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.array([}\DecValTok{4}\NormalTok{, }\DecValTok{7}\NormalTok{, }\OperatorTok{{-}}\DecValTok{5}\NormalTok{, }\DecValTok{3}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 4,  7, -5,  3])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{obj.values}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 4,  7, -5,  3], dtype=int64)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{obj.index  }\CommentTok{\# similar to range(4)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
RangeIndex(start=0, stop=4, step=1)
\end{verbatim}

We did not explicitly assign an index to \texttt{obj}, so \texttt{obj}
has an integer index that starts at 0. We can explicitly assign an index
with the \texttt{index=} argument.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{obj2 }\OperatorTok{=}\NormalTok{ pd.Series([}\DecValTok{4}\NormalTok{, }\DecValTok{7}\NormalTok{, }\OperatorTok{{-}}\DecValTok{5}\NormalTok{, }\DecValTok{3}\NormalTok{], index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}d\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{])}
\NormalTok{obj2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
d    4
b    7
a   -5
c    3
dtype: int64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{obj2.index}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Index(['d', 'b', 'a', 'c'], dtype='object')
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{obj2[}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{obj2.iloc[}\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{obj2[}\StringTok{\textquotesingle{}d\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \DecValTok{6}
\NormalTok{obj2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
d    6
b    7
a   -5
c    3
dtype: int64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{obj2[[}\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}d\textquotesingle{}}\NormalTok{]]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
c    3
a   -5
d    6
dtype: int64
\end{verbatim}

A pandas series behaves like a NumPy array. We can use Boolean filters
and perform vectorized mathematical operations.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{obj2 }\OperatorTok{\textgreater{}} \DecValTok{0}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
d     True
b     True
a    False
c     True
dtype: bool
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{obj2[obj2 }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
d    6
b    7
c    3
dtype: int64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{obj2 }\OperatorTok{*} \DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
d    12
b    14
a   -10
c     6
dtype: int64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}b\textquotesingle{}} \KeywordTok{in}\NormalTok{ obj2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\textquotesingle{}e\textquotesingle{}} \KeywordTok{in}\NormalTok{ obj2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
False
\end{verbatim}

We can create a pandas series from a dictionary. The dictionary labels
become the series index.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sdata }\OperatorTok{=}\NormalTok{ \{}\StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{: }\DecValTok{35000}\NormalTok{, }\StringTok{\textquotesingle{}Texas\textquotesingle{}}\NormalTok{: }\DecValTok{71000}\NormalTok{, }\StringTok{\textquotesingle{}Oregon\textquotesingle{}}\NormalTok{: }\DecValTok{16000}\NormalTok{, }\StringTok{\textquotesingle{}Utah\textquotesingle{}}\NormalTok{: }\DecValTok{5000}\NormalTok{\}}
\NormalTok{obj3 }\OperatorTok{=}\NormalTok{ pd.Series(sdata)}
\NormalTok{obj3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Ohio      35000
Texas     71000
Oregon    16000
Utah       5000
dtype: int64
\end{verbatim}

We can create a pandas series from a list, too. Note that pandas
respects the order of the assigned index. Also, pandas keeps California
with \texttt{NaN} (not a number or missing value) and drops Utah because
it was not in the index.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{states }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}California\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Oregon\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Texas\textquotesingle{}}\NormalTok{]}
\NormalTok{obj4 }\OperatorTok{=}\NormalTok{ pd.Series(sdata, index}\OperatorTok{=}\NormalTok{states)}
\NormalTok{obj4}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
California          NaN
Ohio         35000.0000
Oregon       16000.0000
Texas        71000.0000
dtype: float64
\end{verbatim}

Indices are one of pandas' super powers. When we perform mathematical
operations, pandas aligns series by their indices. Here \texttt{NaN} is
``not a number'', which indicates missing values. \texttt{NaN} is
considered a float, so the data type switches from int64 to float64.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{obj3 }\OperatorTok{+}\NormalTok{ obj4}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
California           NaN
Ohio          70000.0000
Oregon        32000.0000
Texas        142000.0000
Utah                 NaN
dtype: float64
\end{verbatim}

\subsection{DataFrame}\label{dataframe}

A pandas data frame is like a worksheet in an Excel workbook with row
and columns that provide fast indexing.

\begin{quote}
A DataFrame represents a rectangular table of data and contains an
ordered collection of columns, each of which can be a different value
type (numeric, string, boolean, etc.). The DataFrame has both a row and
column index; it can be thought of as a dict of Series all sharing the
same index. Under the hood, the data is stored as one or more
two-dimensional blocks rather than a list, dict, or some other
collection of one-dimensional arrays. The exact details of DataFrame's
internals are outside the scope of this book.

There are many ways to construct a DataFrame, though one of the most
common is from a dict of equal-length lists or NumPy arrays:
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data }\OperatorTok{=}\NormalTok{ \{}
    \StringTok{\textquotesingle{}state\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Nevada\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Nevada\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Nevada\textquotesingle{}}\NormalTok{],}
    \StringTok{\textquotesingle{}year\textquotesingle{}}\NormalTok{: [}\DecValTok{2000}\NormalTok{, }\DecValTok{2001}\NormalTok{, }\DecValTok{2002}\NormalTok{, }\DecValTok{2001}\NormalTok{, }\DecValTok{2002}\NormalTok{, }\DecValTok{2003}\NormalTok{],}
    \StringTok{\textquotesingle{}pop\textquotesingle{}}\NormalTok{: [}\FloatTok{1.5}\NormalTok{, }\FloatTok{1.7}\NormalTok{, }\FloatTok{3.6}\NormalTok{, }\FloatTok{2.4}\NormalTok{, }\FloatTok{2.9}\NormalTok{, }\FloatTok{3.2}\NormalTok{]}
\NormalTok{\}}
\NormalTok{frame }\OperatorTok{=}\NormalTok{ pd.DataFrame(data)}

\NormalTok{frame}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& state & year & pop \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & Ohio & 2000 & 1.5000 \\
1 & Ohio & 2001 & 1.7000 \\
2 & Ohio & 2002 & 3.6000 \\
3 & Nevada & 2001 & 2.4000 \\
4 & Nevada & 2002 & 2.9000 \\
5 & Nevada & 2003 & 3.2000 \\
\end{longtable}

We did not specify an index, so \texttt{frame} has the default index of
integers starting at 0.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame2 }\OperatorTok{=}\NormalTok{ pd.DataFrame(}
\NormalTok{    data, }
\NormalTok{    columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}year\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}state\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}pop\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}debt\textquotesingle{}}\NormalTok{],}
\NormalTok{    index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}one\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}two\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}three\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}four\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}five\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}six\textquotesingle{}}\NormalTok{]}
\NormalTok{)}

\NormalTok{frame2}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& year & state & pop & debt \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
one & 2000 & Ohio & 1.5000 & NaN \\
two & 2001 & Ohio & 1.7000 & NaN \\
three & 2002 & Ohio & 3.6000 & NaN \\
four & 2001 & Nevada & 2.4000 & NaN \\
five & 2002 & Nevada & 2.9000 & NaN \\
six & 2003 & Nevada & 3.2000 & NaN \\
\end{longtable}

If we extract one column, via either \texttt{df.column} or
\texttt{df{[}\textquotesingle{}column\textquotesingle{}{]}}, the result
is a series. We can use either the \texttt{df.colname} or the
\texttt{df{[}\textquotesingle{}colname\textquotesingle{}{]}} syntax to
\emph{extract} a column from a data frame as a series.
\textbf{\emph{However, we must use the
\texttt{df{[}\textquotesingle{}colname\textquotesingle{}{]}} syntax to
}add* a column to a data frame.}* Also, we must use the
\texttt{df{[}\textquotesingle{}colname\textquotesingle{}{]}} syntax to
extract or add a column whose name contains a whitespace.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame2[}\StringTok{\textquotesingle{}state\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
one        Ohio
two        Ohio
three      Ohio
four     Nevada
five     Nevada
six      Nevada
Name: state, dtype: object
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame2.state}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
one        Ohio
two        Ohio
three      Ohio
four     Nevada
five     Nevada
six      Nevada
Name: state, dtype: object
\end{verbatim}

Similarly, if we extract one row. via either
\texttt{df.loc{[}\textquotesingle{}rowlabel\textquotesingle{}{]}} or
\texttt{df.iloc{[}rownumber{]}}, the result is a series.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame2}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& year & state & pop & debt \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
one & 2000 & Ohio & 1.5000 & NaN \\
two & 2001 & Ohio & 1.7000 & NaN \\
three & 2002 & Ohio & 3.6000 & NaN \\
four & 2001 & Nevada & 2.4000 & NaN \\
five & 2002 & Nevada & 2.9000 & NaN \\
six & 2003 & Nevada & 3.2000 & NaN \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame2.loc[}\StringTok{\textquotesingle{}one\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
year      2000
state     Ohio
pop     1.5000
debt       NaN
Name: one, dtype: object
\end{verbatim}

Data frame have two dimensions, so we have to slice data frames more
precisely than series.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The \texttt{.loc{[}{]}} method slices by row labels and column names
\item
  The \texttt{.iloc{[}{]}} method slices by \emph{integer} row and label
  indices
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame2.loc[}\StringTok{\textquotesingle{}three\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
year      2002
state     Ohio
pop     3.6000
debt       NaN
Name: three, dtype: object
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame2.iloc[}\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
year      2002
state     Ohio
pop     3.6000
debt       NaN
Name: three, dtype: object
\end{verbatim}

We can use NumPy's \texttt{{[}row,\ column{]}} syntanx with
\texttt{.loc{[}{]}} and \texttt{.iloc{[}{]}}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame2.loc[}\StringTok{\textquotesingle{}three\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}state\textquotesingle{}}\NormalTok{] }\CommentTok{\# row, column}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'Ohio'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame2.loc[}\StringTok{\textquotesingle{}three\textquotesingle{}}\NormalTok{, [}\StringTok{\textquotesingle{}state\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}pop\textquotesingle{}}\NormalTok{]] }\CommentTok{\# row, column}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
state     Ohio
pop     3.6000
Name: three, dtype: object
\end{verbatim}

We can assign either scalars or arrays to data frame columns.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Scalars will broadcast to every row in the data frame
\item
  Arrays must have the same length as the column
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame2[}\StringTok{\textquotesingle{}debt\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \FloatTok{16.5}
\NormalTok{frame2}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& year & state & pop & debt \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
one & 2000 & Ohio & 1.5000 & 16.5000 \\
two & 2001 & Ohio & 1.7000 & 16.5000 \\
three & 2002 & Ohio & 3.6000 & 16.5000 \\
four & 2001 & Nevada & 2.4000 & 16.5000 \\
five & 2002 & Nevada & 2.9000 & 16.5000 \\
six & 2003 & Nevada & 3.2000 & 16.5000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame2[}\StringTok{\textquotesingle{}debt\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ np.arange(}\FloatTok{6.}\NormalTok{)}
\NormalTok{frame2}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& year & state & pop & debt \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
one & 2000 & Ohio & 1.5000 & 0.0000 \\
two & 2001 & Ohio & 1.7000 & 1.0000 \\
three & 2002 & Ohio & 3.6000 & 2.0000 \\
four & 2001 & Nevada & 2.4000 & 3.0000 \\
five & 2002 & Nevada & 2.9000 & 4.0000 \\
six & 2003 & Nevada & 3.2000 & 5.0000 \\
\end{longtable}

If we assign a series to a data frame column, pandas will use the index
to align it with the data frame. Data frame rows not in the series will
be missing values \texttt{NaN}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{val }\OperatorTok{=}\NormalTok{ pd.Series([}\OperatorTok{{-}}\FloatTok{1.2}\NormalTok{, }\OperatorTok{{-}}\FloatTok{1.5}\NormalTok{, }\OperatorTok{{-}}\FloatTok{1.7}\NormalTok{], index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}two\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}four\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}five\textquotesingle{}}\NormalTok{])}
\NormalTok{val}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
two    -1.2000
four   -1.5000
five   -1.7000
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame2[}\StringTok{\textquotesingle{}debt\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ val}
\NormalTok{frame2}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& year & state & pop & debt \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
one & 2000 & Ohio & 1.5000 & NaN \\
two & 2001 & Ohio & 1.7000 & -1.2000 \\
three & 2002 & Ohio & 3.6000 & NaN \\
four & 2001 & Nevada & 2.4000 & -1.5000 \\
five & 2002 & Nevada & 2.9000 & -1.7000 \\
six & 2003 & Nevada & 3.2000 & NaN \\
\end{longtable}

We can add columns to our data frame, then delete them with
\texttt{del}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame2[}\StringTok{\textquotesingle{}eastern\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ (frame2.state }\OperatorTok{==} \StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{)}
\NormalTok{frame2}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& year & state & pop & debt & eastern \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
one & 2000 & Ohio & 1.5000 & NaN & True \\
two & 2001 & Ohio & 1.7000 & -1.2000 & True \\
three & 2002 & Ohio & 3.6000 & NaN & True \\
four & 2001 & Nevada & 2.4000 & -1.5000 & False \\
five & 2002 & Nevada & 2.9000 & -1.7000 & False \\
six & 2003 & Nevada & 3.2000 & NaN & False \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{del}\NormalTok{ frame2[}\StringTok{\textquotesingle{}eastern\textquotesingle{}}\NormalTok{]}
\NormalTok{frame2}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& year & state & pop & debt \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
one & 2000 & Ohio & 1.5000 & NaN \\
two & 2001 & Ohio & 1.7000 & -1.2000 \\
three & 2002 & Ohio & 3.6000 & NaN \\
four & 2001 & Nevada & 2.4000 & -1.5000 \\
five & 2002 & Nevada & 2.9000 & -1.7000 \\
six & 2003 & Nevada & 3.2000 & NaN \\
\end{longtable}

\subsection{Index Objects}\label{index-objects}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{obj }\OperatorTok{=}\NormalTok{ pd.Series(}\BuiltInTok{range}\NormalTok{(}\DecValTok{3}\NormalTok{), index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{])}
\NormalTok{index }\OperatorTok{=}\NormalTok{ obj.index}
\NormalTok{index}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Index(['a', 'b', 'c'], dtype='object')
\end{verbatim}

Index objects are immutable!

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# index[1] = \textquotesingle{}d\textquotesingle{}  \# TypeError: Index does not support mutable operations}
\end{Highlighting}
\end{Shaded}

Indices can contain duplicates, so an index does not guarantee our data
are duplicate-free.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dup\_labels }\OperatorTok{=}\NormalTok{ pd.Index([}\StringTok{\textquotesingle{}foo\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}foo\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{])}
\NormalTok{dup\_labels}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Index(['foo', 'foo', 'bar', 'bar'], dtype='object')
\end{verbatim}

\section{Essential Functionality}\label{essential-functionality}

This section provides the most import pandas operations. It is difficult
to provide an exhaustive reference, but this section provides a head
start on the core pandas functionality.

\subsection{Dropping Entries from an
Axis}\label{dropping-entries-from-an-axis}

\begin{quote}
Dropping one or more entries from an axis is easy if you already have an
index array or list without those entries. As that can require a bit of
munging and set logic, the drop method will return a new object with the
indicated value or values deleted from an axis.
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{obj }\OperatorTok{=}\NormalTok{ pd.Series(np.arange(}\FloatTok{5.}\NormalTok{), index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}d\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}e\textquotesingle{}}\NormalTok{])}
\NormalTok{obj}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
a   0.0000
b   1.0000
c   2.0000
d   3.0000
e   4.0000
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{obj\_without\_d\_and\_c }\OperatorTok{=}\NormalTok{ obj.drop([}\StringTok{\textquotesingle{}d\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{])}
\NormalTok{obj\_without\_d\_and\_c}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
a   0.0000
b   1.0000
e   4.0000
dtype: float64
\end{verbatim}

The \texttt{.drop()} method works on data frames, too.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data }\OperatorTok{=}\NormalTok{ pd.DataFrame(}
\NormalTok{    np.arange(}\DecValTok{16}\NormalTok{).reshape((}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{)),}
\NormalTok{    index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Colorado\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Utah\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}New York\textquotesingle{}}\NormalTok{],}
\NormalTok{    columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}one\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}two\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}three\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}four\textquotesingle{}}\NormalTok{]}
\NormalTok{)}

\NormalTok{data}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& one & two & three & four \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Ohio & 0 & 1 & 2 & 3 \\
Colorado & 4 & 5 & 6 & 7 \\
Utah & 8 & 9 & 10 & 11 \\
New York & 12 & 13 & 14 & 15 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.drop([}\StringTok{\textquotesingle{}Colorado\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{]) }\CommentTok{\# implied ", axis=0"}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& one & two & three & four \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Utah & 8 & 9 & 10 & 11 \\
New York & 12 & 13 & 14 & 15 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.drop([}\StringTok{\textquotesingle{}Colorado\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& one & two & three & four \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Utah & 8 & 9 & 10 & 11 \\
New York & 12 & 13 & 14 & 15 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.drop(index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Colorado\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& one & two & three & four \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Utah & 8 & 9 & 10 & 11 \\
New York & 12 & 13 & 14 & 15 \\
\end{longtable}

The \texttt{.drop()} method accepts an \texttt{axis} argument and the
default is \texttt{axis=0} to drop rows based on labels. To drop
columns, we use \texttt{axis=1} or
\texttt{axis=\textquotesingle{}columns\textquotesingle{}}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.drop(}\StringTok{\textquotesingle{}two\textquotesingle{}}\NormalTok{, axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& one & three & four \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Ohio & 0 & 2 & 3 \\
Colorado & 4 & 6 & 7 \\
Utah & 8 & 10 & 11 \\
New York & 12 & 14 & 15 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.drop(columns}\OperatorTok{=}\StringTok{\textquotesingle{}two\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& one & three & four \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Ohio & 0 & 2 & 3 \\
Colorado & 4 & 6 & 7 \\
Utah & 8 & 10 & 11 \\
New York & 12 & 14 & 15 \\
\end{longtable}

\subsection{Indexing, Selection, and
Filtering}\label{indexing-selection-and-filtering}

Indexing, selecting, and filtering will be among our most-used pandas
features.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{obj }\OperatorTok{=}\NormalTok{ pd.Series(np.arange(}\FloatTok{4.}\NormalTok{), index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}d\textquotesingle{}}\NormalTok{])}
\NormalTok{obj}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
a   0.0000
b   1.0000
c   2.0000
d   3.0000
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{obj[}\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.0000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{obj.iloc[}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.0000
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{obj.iloc[}\DecValTok{1}\NormalTok{:}\DecValTok{3}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
b   1.0000
c   2.0000
dtype: float64
\end{verbatim}

\textbf{\emph{When we slice with labels, the left and right endpoints
are inclusive.}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{obj[}\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
b   1.0000
c   2.0000
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{obj[}\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \DecValTok{5}
\NormalTok{obj}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
a   0.0000
b   5.0000
c   5.0000
d   3.0000
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data }\OperatorTok{=}\NormalTok{ pd.DataFrame(}
\NormalTok{    np.arange(}\DecValTok{16}\NormalTok{).reshape((}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{)),}
\NormalTok{    index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Colorado\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Utah\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}New York\textquotesingle{}}\NormalTok{],}
\NormalTok{    columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}one\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}two\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}three\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}four\textquotesingle{}}\NormalTok{]}
\NormalTok{)}

\NormalTok{data}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& one & two & three & four \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Ohio & 0 & 1 & 2 & 3 \\
Colorado & 4 & 5 & 6 & 7 \\
Utah & 8 & 9 & 10 & 11 \\
New York & 12 & 13 & 14 & 15 \\
\end{longtable}

Indexing one column returns a series.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data[}\StringTok{\textquotesingle{}two\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Ohio         1
Colorado     5
Utah         9
New York    13
Name: two, dtype: int32
\end{verbatim}

Indexing two or more columns returns a data frame.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data[[}\StringTok{\textquotesingle{}three\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}one\textquotesingle{}}\NormalTok{]]}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lll@{}}
\toprule\noalign{}
& three & one \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Ohio & 2 & 0 \\
Colorado & 6 & 4 \\
Utah & 10 & 8 \\
New York & 14 & 12 \\
\end{longtable}

If we want a one-column data frame, we can use \texttt{{[}{[}{]}{]}}:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data[}\StringTok{\textquotesingle{}three\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Ohio         2
Colorado     6
Utah        10
New York    14
Name: three, dtype: int32
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data[[}\StringTok{\textquotesingle{}three\textquotesingle{}}\NormalTok{]]}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}ll@{}}
\toprule\noalign{}
& three \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Ohio & 2 \\
Colorado & 6 \\
Utah & 10 \\
New York & 14 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.iloc[:}\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& one & two & three & four \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Ohio & 0 & 1 & 2 & 3 \\
Colorado & 4 & 5 & 6 & 7 \\
\end{longtable}

We can index a data frame with Booleans, as we did with NumPy arrays.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data }\OperatorTok{\textless{}} \DecValTok{5}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& one & two & three & four \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Ohio & True & True & True & True \\
Colorado & True & False & False & False \\
Utah & False & False & False & False \\
New York & False & False & False & False \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& one & two & three & four \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Ohio & 0 & 1 & 2 & 3 \\
Colorado & 4 & 5 & 6 & 7 \\
Utah & 8 & 9 & 10 & 11 \\
New York & 12 & 13 & 14 & 15 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data[data }\OperatorTok{\textless{}} \DecValTok{5}\NormalTok{] }\OperatorTok{=} \DecValTok{0}
\NormalTok{data}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& one & two & three & four \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Ohio & 0 & 0 & 0 & 0 \\
Colorado & 0 & 5 & 6 & 7 \\
Utah & 8 & 9 & 10 & 11 \\
New York & 12 & 13 & 14 & 15 \\
\end{longtable}

Finally, we can chain slices.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.iloc[:, :}\DecValTok{3}\NormalTok{][data.three }\OperatorTok{\textgreater{}} \DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& one & two & three \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Colorado & 0 & 5 & 6 \\
Utah & 8 & 9 & 10 \\
New York & 12 & 13 & 14 \\
\end{longtable}

\textbf{\emph{Table 5-4}} summarizes data frame indexing and slicing
options:

\begin{itemize}
\tightlist
\item
  \texttt{df{[}val{]}}: Select single column or sequence of columns from
  the DataFrame; special case conveniences: boolean array (filter rows),
  slice (slice rows), or boolean DataFrame (set values based on some
  criterion)
\item
  \texttt{df.loc{[}val{]}}: Selects single row or subset of rows from
  the DataFrame by label
\item
  \texttt{df.loc{[}:,\ val{]}}: Selects single column or subset of
  columns by label
\item
  \texttt{df.loc{[}val1,\ val2{]}}: Select both rows and columns by
  label
\item
  \texttt{df.iloc{[}where{]}}: Selects single row or subset of rows from
  the DataFrame by integer position
\item
  \texttt{df.iloc{[}:,\ where{]}}: Selects single column or subset of
  columns by integer position
\item
  \texttt{df.iloc{[}where\_i,\ where\_j{]}}: Select both rows and
  columns by integer position
\item
  \texttt{df.at{[}label\_i,\ label\_j{]}}: Select a single scalar value
  by row and column label
\item
  \texttt{df.iat{[}i,\ j{]}}: Select a single scalar value by row and
  column position (integers) reindex method Select either rows or
  columns by labels
\item
  \texttt{get\_value}, \texttt{set\_value} methods: Select single value
  by row and column label
\end{itemize}

pandas is powerful and these options can be overwhelming! We will
typically use \texttt{df{[}val{]}} to select columns (here \texttt{val}
is either a string or list of strings), \texttt{df.loc{[}val{]}} to
select rows (here \texttt{val} is a row label), and
\texttt{df.loc{[}val1,\ val2{]}} to select both rows and columns. The
other options add flexibility, and we may occasionally use them.
However, our data will be large enough that counting row and column
number will be tedious, making \texttt{.iloc{[}{]}} impractical.

\subsection{Arithmetic and Data
Alignment}\label{arithmetic-and-data-alignment}

\begin{quote}
An important pandas feature for some applications is the behavior of
arithmetic between objects with different indexes. When you are adding
together objects, if any index pairs are not the same, the respective
index in the result will be the union of the index pairs. For users with
database experience, this is similar to an automatic outer join on the
index labels.
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{s1 }\OperatorTok{=}\NormalTok{ pd.Series([}\FloatTok{7.3}\NormalTok{, }\OperatorTok{{-}}\FloatTok{2.5}\NormalTok{, }\FloatTok{3.4}\NormalTok{, }\FloatTok{1.5}\NormalTok{], index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}d\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}e\textquotesingle{}}\NormalTok{])}
\NormalTok{s2 }\OperatorTok{=}\NormalTok{ pd.Series([}\OperatorTok{{-}}\FloatTok{2.1}\NormalTok{, }\FloatTok{3.6}\NormalTok{, }\OperatorTok{{-}}\FloatTok{1.5}\NormalTok{, }\DecValTok{4}\NormalTok{, }\FloatTok{3.1}\NormalTok{], index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}e\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}f\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}g\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{s1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
a    7.3000
c   -2.5000
d    3.4000
e    1.5000
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{s2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
a   -2.1000
c    3.6000
e   -1.5000
f    4.0000
g    3.1000
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{s1 }\OperatorTok{+}\NormalTok{ s2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
a   5.2000
c   1.1000
d      NaN
e   0.0000
f      NaN
g      NaN
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df1 }\OperatorTok{=}\NormalTok{ pd.DataFrame(np.arange(}\FloatTok{9.}\NormalTok{).reshape((}\DecValTok{3}\NormalTok{, }\DecValTok{3}\NormalTok{)), columns}\OperatorTok{=}\BuiltInTok{list}\NormalTok{(}\StringTok{\textquotesingle{}bcd\textquotesingle{}}\NormalTok{), index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Texas\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Colorado\textquotesingle{}}\NormalTok{])}
\NormalTok{df2 }\OperatorTok{=}\NormalTok{ pd.DataFrame(np.arange(}\FloatTok{12.}\NormalTok{).reshape((}\DecValTok{4}\NormalTok{, }\DecValTok{3}\NormalTok{)), columns}\OperatorTok{=}\BuiltInTok{list}\NormalTok{(}\StringTok{\textquotesingle{}bde\textquotesingle{}}\NormalTok{), index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Utah\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Texas\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Oregon\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df1}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& b & c & d \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Ohio & 0.0000 & 1.0000 & 2.0000 \\
Texas & 3.0000 & 4.0000 & 5.0000 \\
Colorado & 6.0000 & 7.0000 & 8.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df2}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& b & d & e \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Utah & 0.0000 & 1.0000 & 2.0000 \\
Ohio & 3.0000 & 4.0000 & 5.0000 \\
Texas & 6.0000 & 7.0000 & 8.0000 \\
Oregon & 9.0000 & 10.0000 & 11.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df1 }\OperatorTok{+}\NormalTok{ df2}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& b & c & d & e \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Colorado & NaN & NaN & NaN & NaN \\
Ohio & 3.0000 & NaN & 6.0000 & NaN \\
Oregon & NaN & NaN & NaN & NaN \\
Texas & 9.0000 & NaN & 12.0000 & NaN \\
Utah & NaN & NaN & NaN & NaN \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df1 }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{: [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{]\})}
\NormalTok{df2 }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}\StringTok{\textquotesingle{}B\textquotesingle{}}\NormalTok{: [}\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{]\})}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df1}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}ll@{}}
\toprule\noalign{}
& A \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & 1 \\
1 & 2 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df2}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}ll@{}}
\toprule\noalign{}
& B \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & 3 \\
1 & 4 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df1 }\OperatorTok{{-}}\NormalTok{ df2}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lll@{}}
\toprule\noalign{}
& A & B \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & NaN & NaN \\
1 & NaN & NaN \\
\end{longtable}

\textbf{\emph{Always check your output!}}

\subsubsection{Arithmetic methods with fill
values}\label{arithmetic-methods-with-fill-values}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df1 }\OperatorTok{=}\NormalTok{ pd.DataFrame(np.arange(}\FloatTok{12.}\NormalTok{).reshape((}\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{)), columns}\OperatorTok{=}\BuiltInTok{list}\NormalTok{(}\StringTok{\textquotesingle{}abcd\textquotesingle{}}\NormalTok{))}
\NormalTok{df2 }\OperatorTok{=}\NormalTok{ pd.DataFrame(np.arange(}\FloatTok{20.}\NormalTok{).reshape((}\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{)), columns}\OperatorTok{=}\BuiltInTok{list}\NormalTok{(}\StringTok{\textquotesingle{}abcde\textquotesingle{}}\NormalTok{))}
\NormalTok{df2.loc[}\DecValTok{1}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ np.nan}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df1}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& a & b & c & d \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & 0.0000 & 1.0000 & 2.0000 & 3.0000 \\
1 & 4.0000 & 5.0000 & 6.0000 & 7.0000 \\
2 & 8.0000 & 9.0000 & 10.0000 & 11.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df2}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& a & b & c & d & e \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & 0.0000 & 1.0000 & 2.0000 & 3.0000 & 4.0000 \\
1 & 5.0000 & NaN & 7.0000 & 8.0000 & 9.0000 \\
2 & 10.0000 & 11.0000 & 12.0000 & 13.0000 & 14.0000 \\
3 & 15.0000 & 16.0000 & 17.0000 & 18.0000 & 19.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df1 }\OperatorTok{+}\NormalTok{ df2}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& a & b & c & d & e \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & 0.0000 & 2.0000 & 4.0000 & 6.0000 & NaN \\
1 & 9.0000 & NaN & 13.0000 & 15.0000 & NaN \\
2 & 18.0000 & 20.0000 & 22.0000 & 24.0000 & NaN \\
3 & NaN & NaN & NaN & NaN & NaN \\
\end{longtable}

We can specify a fill value for \texttt{NaN} values. Note that pandas
fills would-be \texttt{NaN} values in each data frame \emph{before} the
arithmetic operation.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df1.add(df2, fill\_value}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& a & b & c & d & e \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & 0.0000 & 2.0000 & 4.0000 & 6.0000 & 4.0000 \\
1 & 9.0000 & 5.0000 & 13.0000 & 15.0000 & 9.0000 \\
2 & 18.0000 & 20.0000 & 22.0000 & 24.0000 & 14.0000 \\
3 & 15.0000 & 16.0000 & 17.0000 & 18.0000 & 19.0000 \\
\end{longtable}

\subsubsection{Operations between DataFrame and
Series}\label{operations-between-dataframe-and-series}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr }\OperatorTok{=}\NormalTok{ np.arange(}\FloatTok{12.}\NormalTok{).reshape((}\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{))}
\NormalTok{arr}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.,  1.,  2.,  3.],
       [ 4.,  5.,  6.,  7.],
       [ 8.,  9., 10., 11.]])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0., 1., 2., 3.])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{arr }\OperatorTok{{-}}\NormalTok{ arr[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[0., 0., 0., 0.],
       [4., 4., 4., 4.],
       [8., 8., 8., 8.]])
\end{verbatim}

Arithmetic operations between series and data frames behave the same as
the example above.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame }\OperatorTok{=}\NormalTok{ pd.DataFrame(}
\NormalTok{    np.arange(}\FloatTok{12.}\NormalTok{).reshape((}\DecValTok{4}\NormalTok{, }\DecValTok{3}\NormalTok{)),}
\NormalTok{    columns}\OperatorTok{=}\BuiltInTok{list}\NormalTok{(}\StringTok{\textquotesingle{}bde\textquotesingle{}}\NormalTok{),}
\NormalTok{    index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Utah\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Texas\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Oregon\textquotesingle{}}\NormalTok{]}
\NormalTok{)}

\NormalTok{series }\OperatorTok{=}\NormalTok{ frame.iloc[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& b & d & e \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Utah & 0.0000 & 1.0000 & 2.0000 \\
Ohio & 3.0000 & 4.0000 & 5.0000 \\
Texas & 6.0000 & 7.0000 & 8.0000 \\
Oregon & 9.0000 & 10.0000 & 11.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{series}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
b   0.0000
d   1.0000
e   2.0000
Name: Utah, dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame }\OperatorTok{{-}}\NormalTok{ series}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& b & d & e \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Utah & 0.0000 & 0.0000 & 0.0000 \\
Ohio & 3.0000 & 3.0000 & 3.0000 \\
Texas & 6.0000 & 6.0000 & 6.0000 \\
Oregon & 9.0000 & 9.0000 & 9.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{series2 }\OperatorTok{=}\NormalTok{ pd.Series(}\BuiltInTok{range}\NormalTok{(}\DecValTok{3}\NormalTok{), index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}e\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}f\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& b & d & e \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Utah & 0.0000 & 1.0000 & 2.0000 \\
Ohio & 3.0000 & 4.0000 & 5.0000 \\
Texas & 6.0000 & 7.0000 & 8.0000 \\
Oregon & 9.0000 & 10.0000 & 11.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{series2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
b    0
e    1
f    2
dtype: int64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame }\OperatorTok{+}\NormalTok{ series2}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& b & d & e & f \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Utah & 0.0000 & NaN & 3.0000 & NaN \\
Ohio & 3.0000 & NaN & 6.0000 & NaN \\
Texas & 6.0000 & NaN & 9.0000 & NaN \\
Oregon & 9.0000 & NaN & 12.0000 & NaN \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{series3 }\OperatorTok{=}\NormalTok{ frame[}\StringTok{\textquotesingle{}d\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame.sub(series3, axis}\OperatorTok{=}\StringTok{\textquotesingle{}index\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& b & d & e \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Utah & -1.0000 & 0.0000 & 1.0000 \\
Ohio & -1.0000 & 0.0000 & 1.0000 \\
Texas & -1.0000 & 0.0000 & 1.0000 \\
Oregon & -1.0000 & 0.0000 & 1.0000 \\
\end{longtable}

\subsection{Function Application and
Mapping}\label{function-application-and-mapping}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{frame }\OperatorTok{=}\NormalTok{ pd.DataFrame(}
\NormalTok{    np.random.randn(}\DecValTok{4}\NormalTok{, }\DecValTok{3}\NormalTok{), }
\NormalTok{    columns}\OperatorTok{=}\BuiltInTok{list}\NormalTok{(}\StringTok{\textquotesingle{}bde\textquotesingle{}}\NormalTok{),}
\NormalTok{    index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Utah\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Texas\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Oregon\textquotesingle{}}\NormalTok{]}
\NormalTok{)}

\NormalTok{frame}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& b & d & e \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Utah & 0.4967 & -0.1383 & 0.6477 \\
Ohio & 1.5230 & -0.2342 & -0.2341 \\
Texas & 1.5792 & 0.7674 & -0.4695 \\
Oregon & 0.5426 & -0.4634 & -0.4657 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame.}\BuiltInTok{abs}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& b & d & e \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Utah & 0.4967 & 0.1383 & 0.6477 \\
Ohio & 1.5230 & 0.2342 & 0.2341 \\
Texas & 1.5792 & 0.7674 & 0.4695 \\
Oregon & 0.5426 & 0.4634 & 0.4657 \\
\end{longtable}

\begin{quote}
Another frequent operation is applying a function on one-dimensional
arrays to each column or row. DataFrame's apply method does exactly
this:
\end{quote}

Note that we can use anonymous (lambda) functions ``on the fly'':

\begin{Shaded}
\begin{Highlighting}[]
\FloatTok{1.5792} \OperatorTok{{-}} \FloatTok{0.4967}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.0825
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame.}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{max}\NormalTok{() }\OperatorTok{{-}}\NormalTok{ x.}\BuiltInTok{min}\NormalTok{()) }\CommentTok{\# implied axis=0}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
b   1.0825
d   1.2309
e   1.1172
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame.}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{max}\NormalTok{() }\OperatorTok{{-}}\NormalTok{ x.}\BuiltInTok{min}\NormalTok{(), axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Utah     0.7860
Ohio     1.7572
Texas    2.0487
Oregon   1.0083
dtype: float64
\end{verbatim}

However, under the hood, the \texttt{.apply()} is basically a
\texttt{for} loop and much slowly than optimized, built-in methods. Here
is an example of the speed costs of \texttt{.apply()}:

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{timeit frame[}\StringTok{\textquotesingle{}e\textquotesingle{}}\NormalTok{].}\BuiltInTok{abs}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
15.2 µs ± 4.5 µs per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{timeit frame[}\StringTok{\textquotesingle{}e\textquotesingle{}}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(np.}\BuiltInTok{abs}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
32.6 µs ± 9.67 µs per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
\end{verbatim}

\section{Summarizing and Computing Descriptive
Statistics}\label{summarizing-and-computing-descriptive-statistics}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\OperatorTok{=}\NormalTok{ pd.DataFrame(}
\NormalTok{    [[}\FloatTok{1.4}\NormalTok{, np.nan], [}\FloatTok{7.1}\NormalTok{, }\OperatorTok{{-}}\FloatTok{4.5}\NormalTok{], [np.nan, np.nan], [}\FloatTok{0.75}\NormalTok{, }\OperatorTok{{-}}\FloatTok{1.3}\NormalTok{]],}
\NormalTok{    index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}d\textquotesingle{}}\NormalTok{],}
\NormalTok{    columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}one\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}two\textquotesingle{}}\NormalTok{]}
\NormalTok{)}

\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lll@{}}
\toprule\noalign{}
& one & two \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
a & 1.4000 & NaN \\
b & 7.1000 & -4.5000 \\
c & NaN & NaN \\
d & 0.7500 & -1.3000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.}\BuiltInTok{sum}\NormalTok{() }\CommentTok{\# implied axis=0}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
one    9.2500
two   -5.8000
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.}\BuiltInTok{sum}\NormalTok{(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
a    1.4000
b    2.6000
c    0.0000
d   -0.5500
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.mean(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, skipna}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
a       NaN
b    1.3000
c       NaN
d   -0.2750
dtype: float64
\end{verbatim}

The \texttt{.idxmax()} method returns the label for the maximum
observation.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.idxmax()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
one    b
two    d
dtype: object
\end{verbatim}

The \texttt{.describe()} returns summary statistics for each numerical
column in a data frame.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.describe()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lll@{}}
\toprule\noalign{}
& one & two \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
count & 3.0000 & 2.0000 \\
mean & 3.0833 & -2.9000 \\
std & 3.4937 & 2.2627 \\
min & 0.7500 & -4.5000 \\
25\% & 1.0750 & -3.7000 \\
50\% & 1.4000 & -2.9000 \\
75\% & 4.2500 & -2.1000 \\
max & 7.1000 & -1.3000 \\
\end{longtable}

For non-numerical data, \texttt{.describe()} returns alternative summary
statistics.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{obj }\OperatorTok{=}\NormalTok{ pd.Series([}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{] }\OperatorTok{*} \DecValTok{4}\NormalTok{)}
\NormalTok{obj.describe()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
count     16
unique     3
top        a
freq       8
dtype: object
\end{verbatim}

\subsection{Correlation and
Covariance}\label{correlation-and-covariance}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tickers }\OperatorTok{=}\NormalTok{ yf.Tickers(}\StringTok{\textquotesingle{}AAPL IBM MSFT GOOG\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices }\OperatorTok{=}\NormalTok{ tickers.history(period}\OperatorTok{=}\StringTok{\textquotesingle{}max\textquotesingle{}}\NormalTok{, auto\_adjust}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  4 of 4 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
& \multicolumn{4}{l}{%
Adj Close} & \multicolumn{4}{l}{%
Close} & \multicolumn{2}{l}{%
Dividends} & ... & \multicolumn{2}{l}{%
Open} & \multicolumn{4}{l}{%
Stock Splits} & \multicolumn{4}{l@{}}{%
Volume} \\
& AAPL & GOOG & IBM & MSFT & AAPL & GOOG & IBM & MSFT & AAPL & GOOG &
... & IBM & MSFT & AAPL & GOOG & IBM & MSFT & AAPL & GOOG & IBM &
MSFT \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-01-19 & 191.5600 & 147.9700 & 171.4800 & 398.6700 & 191.5600 &
147.9700 & 171.4800 & 398.6700 & 0.0000 & 0.0000 & ... & 170.5900 &
395.7600 & 0.0000 & 0.0000 & 0.0000 & 0.0000 & 68741000.0000 &
27170900.0000 & 6925800 & 29272000.0000 \\
2024-01-22 & 193.8900 & 147.7100 & 172.8300 & 396.5100 & 193.8900 &
147.7100 & 172.8300 & 396.5100 & 0.0000 & 0.0000 & ... & 172.8200 &
400.0200 & 0.0000 & 0.0000 & 0.0000 & 0.0000 & 60133900.0000 &
21829200.0000 & 4926000 & 27016900.0000 \\
2024-01-23 & 195.1800 & 148.6800 & 173.9400 & 398.9000 & 195.1800 &
148.6800 & 173.9400 & 398.9000 & 0.0000 & 0.0000 & ... & 172.9000 &
395.7500 & 0.0000 & 0.0000 & 0.0000 & 0.0000 & 42355600.0000 &
14113600.0000 & 3983500 & 20525900.0000 \\
2024-01-24 & 194.5000 & 150.3500 & 173.9300 & 402.5600 & 194.5000 &
150.3500 & 173.9300 & 402.5600 & 0.0000 & 0.0000 & ... & 174.7600 &
401.5400 & 0.0000 & 0.0000 & 0.0000 & 0.0000 & 53631300.0000 &
19245000.0000 & 9097800 & 24867000.0000 \\
2024-01-25 & 194.1700 & 153.6400 & 190.4300 & 404.8700 & 194.1700 &
153.6400 & 190.4300 & 404.8700 & 0.0000 & 0.0000 & ... & 184.9600 &
404.3200 & 0.0000 & 0.0000 & 0.0000 & 0.0000 & 54460179.0000 &
21334519.0000 & 28357994 & 20529365.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& AAPL & GOOG & IBM & MSFT \\
Date & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-01-19 & 191.5600 & 147.9700 & 171.4800 & 398.6700 \\
2024-01-22 & 193.8900 & 147.7100 & 172.8300 & 396.5100 \\
2024-01-23 & 195.1800 & 148.6800 & 173.9400 & 398.9000 \\
2024-01-24 & 194.5000 & 150.3500 & 173.9300 & 402.5600 \\
2024-01-25 & 194.1700 & 153.6400 & 190.4300 & 404.8700 \\
\end{longtable}

The \texttt{prices} data frames contains daily data for AAPL, IBM, MSFT,
and GOOG. The \texttt{Adj\ Close} column provides a reverse-engineered
daily closing price that accounts for dividends paid and stock splits
(and reverse splits). As a result, the \texttt{.pct\_change()} in
\texttt{Adj\ Close} considers both price changes (i.e., capital gains)
and dividends, so
\(R_t = \frac{(P_t + D_t) - P_{t-1}}{P_{t-1}} = \frac{\text{Adj Close}_t - \text{Adj Close}_{t-1}}{\text{Adj Close}_{t-1}}.\)

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns }\OperatorTok{=}\NormalTok{ prices[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].pct\_change().dropna()}
\NormalTok{returns}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& AAPL & GOOG & IBM & MSFT \\
Date & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2004-08-20 & 0.0029 & 0.0794 & 0.0042 & 0.0029 \\
2004-08-23 & 0.0091 & 0.0101 & -0.0070 & 0.0044 \\
2004-08-24 & 0.0280 & -0.0414 & 0.0007 & 0.0000 \\
2004-08-25 & 0.0344 & 0.0108 & 0.0042 & 0.0114 \\
2004-08-26 & 0.0487 & 0.0180 & -0.0045 & -0.0040 \\
... & ... & ... & ... & ... \\
2024-01-19 & 0.0155 & 0.0206 & 0.0278 & 0.0122 \\
2024-01-22 & 0.0122 & -0.0018 & 0.0079 & -0.0054 \\
2024-01-23 & 0.0067 & 0.0066 & 0.0064 & 0.0060 \\
2024-01-24 & -0.0035 & 0.0112 & -0.0001 & 0.0092 \\
2024-01-25 & -0.0017 & 0.0219 & 0.0949 & 0.0057 \\
\end{longtable}

We multiply by 252 to annualize mean daily returns because means grow
linearly with time and there are (about) 252 trading days per year.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.mean().mul(}\DecValTok{252}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.3648
GOOG   0.2591
IBM    0.0990
MSFT   0.2005
dtype: float64
\end{verbatim}

We multiply by \(\sqrt{252}\) to annualize the standard deviation of
daily returns because variances grow linearly with time, there are
(about) 252 trading days per year, and the standard deviation is the
square root of the variance.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.std().mul(np.sqrt(}\DecValTok{252}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.3277
GOOG   0.3071
IBM    0.2272
MSFT   0.2722
dtype: float64
\end{verbatim}

\textbf{\emph{The best explanation I have found on why stock return
volatility (the standard deviation of stocks returns) grows with the
square root of time is at the bottom of page 7 of
\href{https://book.ivo-welch.info/read/source5.mba/08-invchoice.pdf}{chapter
8 of Ivo Welch's free corporate finance textbook}.}}

We can calculate pairwise correlations.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns[}\StringTok{\textquotesingle{}MSFT\textquotesingle{}}\NormalTok{].corr(returns[}\StringTok{\textquotesingle{}IBM\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.4926
\end{verbatim}

We can also calculate correlation matrices.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.corr()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& AAPL & GOOG & IBM & MSFT \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
AAPL & 1.0000 & 0.5189 & 0.4275 & 0.5235 \\
GOOG & 0.5189 & 1.0000 & 0.3953 & 0.5626 \\
IBM & 0.4275 & 0.3953 & 1.0000 & 0.4926 \\
MSFT & 0.5235 & 0.5626 & 0.4926 & 1.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.corr().loc[}\StringTok{\textquotesingle{}MSFT\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}IBM\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.4926
\end{verbatim}

\chapter{McKinney Chapter 5 - Practice for Section
02}\label{mckinney-chapter-5---practice-for-section-02}

\section{Announcements}\label{announcements-12}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  No DataCamp this week, but I suggest you keep working on it
\item
  Keep forming groups, and I will post our first project early next week
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-11}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

There are two pandas data structures:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Data frames are like worksheets in an Excel workbook (2-D, mixed data
  type)
\item
  Series are like a column in a worksheet (1-D, only one data type)
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{df }\OperatorTok{=}\NormalTok{ pd.DataFrame(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{np.random.randn(}\DecValTok{3}\NormalTok{, }\DecValTok{5}\NormalTok{),}
\NormalTok{    index}\OperatorTok{=}\BuiltInTok{list}\NormalTok{(}\StringTok{\textquotesingle{}ABC\textquotesingle{}}\NormalTok{),}
\NormalTok{    columns}\OperatorTok{=}\BuiltInTok{list}\NormalTok{(}\StringTok{\textquotesingle{}abcde\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& a & b & c & d & e \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
A & 0.4967 & -0.1383 & 0.6477 & 1.5230 & -0.2342 \\
B & -0.2341 & 1.5792 & 0.7674 & -0.4695 & 0.5426 \\
C & -0.4634 & -0.4657 & 0.2420 & -1.9133 & -1.7249 \\
\end{longtable}

We can slice data frames two ways!

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  By integer locations with the \texttt{.iloc{[}{]}} method
\item
  By row and column names with the \texttt{.loc{[}{]}} method
\end{enumerate}

How can we grab the first 2 rows and 3 columns?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.iloc[:}\DecValTok{2}\NormalTok{, :}\DecValTok{3}\NormalTok{] }\CommentTok{\# pandas .iloc[] uses j,k notation, like NumPy}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& a & b & c \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
A & 0.4967 & -0.1383 & 0.6477 \\
B & -0.2341 & 1.5792 & 0.7674 \\
\end{longtable}

\textbf{\emph{When we slice by names or string, pandas includes both
left and right edges!}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.loc[}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}B\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& a & b & c \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
A & 0.4967 & -0.1383 & 0.6477 \\
B & -0.2341 & 1.5792 & 0.7674 \\
\end{longtable}

How can we add a column?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df[}\StringTok{\textquotesingle{}f\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \DecValTok{2\_001}

\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& a & b & c & d & e & f \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
A & 0.4967 & -0.1383 & 0.6477 & 1.5230 & -0.2342 & 2001 \\
B & -0.2341 & 1.5792 & 0.7674 & -0.4695 & 0.5426 & 2001 \\
C & -0.4634 & -0.4657 & 0.2420 & -1.9133 & -1.7249 & 2001 \\
\end{longtable}

What if we want to insert a column between ``b'' and ``c''? We can use
the \texttt{.insert()} method! Note. I was surprised the
\texttt{.insert()} operates ``in place'' without an option to override!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.insert(}
\NormalTok{    loc}\OperatorTok{=}\DecValTok{2}\NormalTok{,}
\NormalTok{    column}\OperatorTok{=}\StringTok{\textquotesingle{}C\textquotesingle{}}\NormalTok{,}
\NormalTok{    value}\OperatorTok{=}\DecValTok{5}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.loc[:, }\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& a & b & C & c \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
A & 0.4967 & -0.1383 & 5 & 0.6477 \\
B & -0.2341 & 1.5792 & 5 & 0.7674 \\
C & -0.4634 & -0.4657 & 5 & 0.2420 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df[[}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}C\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{]]}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& a & b & C & c \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
A & 0.4967 & -0.1383 & 5 & 0.6477 \\
B & -0.2341 & 1.5792 & 5 & 0.7674 \\
C & -0.4634 & -0.4657 & 5 & 0.2420 \\
\end{longtable}

A series is the other data structure in pandas!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ser }\OperatorTok{=}\NormalTok{ pd.Series(data}\OperatorTok{=}\NormalTok{np.arange(}\FloatTok{2.}\NormalTok{), index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}B\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}C\textquotesingle{}}\NormalTok{])}

\NormalTok{ser}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
B   0.0000
C   1.0000
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df[}\StringTok{\textquotesingle{}g\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ ser}

\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllll@{}}
\toprule\noalign{}
& a & b & C & c & d & e & f & g \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
A & 0.4967 & -0.1383 & 5 & 0.6477 & 1.5230 & -0.2342 & 2001 & NaN \\
B & -0.2341 & 1.5792 & 5 & 0.7674 & -0.4695 & 0.5426 & 2001 & 0.0000 \\
C & -0.4634 & -0.4657 & 5 & 0.2420 & -1.9133 & -1.7249 & 2001 &
1.0000 \\
\end{longtable}

\section{Practice}\label{practice-12}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tickers }\OperatorTok{=} \StringTok{\textquotesingle{}AAPL IBM MSFT GOOG\textquotesingle{}}
\NormalTok{prices }\OperatorTok{=}\NormalTok{ yf.download(tickers}\OperatorTok{=}\NormalTok{tickers)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  4 of 4 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    prices[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{] }\CommentTok{\# slice adj close column}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\CommentTok{\# drop last row with intra day prices, which are sometimes missing}
\NormalTok{    .pct\_change() }\CommentTok{\# calculate returns}
\NormalTok{    .dropna() }\CommentTok{\# drop leading rows with at least one missing value}
\NormalTok{)}

\NormalTok{returns}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& AAPL & GOOG & IBM & MSFT \\
Date & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2004-08-20 & 0.0029 & 0.0794 & 0.0042 & 0.0029 \\
2004-08-23 & 0.0091 & 0.0101 & -0.0070 & 0.0044 \\
2004-08-24 & 0.0280 & -0.0414 & 0.0007 & 0.0000 \\
2004-08-25 & 0.0344 & 0.0108 & 0.0042 & 0.0114 \\
2004-08-26 & 0.0487 & 0.0180 & -0.0045 & -0.0040 \\
... & ... & ... & ... & ... \\
2024-01-26 & -0.0090 & 0.0010 & -0.0158 & -0.0023 \\
2024-01-29 & -0.0036 & 0.0068 & -0.0015 & 0.0143 \\
2024-01-30 & -0.0192 & -0.0116 & 0.0039 & -0.0028 \\
2024-01-31 & -0.0194 & -0.0735 & -0.0224 & -0.0269 \\
2024-02-01 & 0.0133 & 0.0064 & 0.0176 & 0.0156 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    prices[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    .pct\_change()}
\NormalTok{    .dropna()}
\NormalTok{)}
\NormalTok{returns}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& AAPL & GOOG & IBM & MSFT \\
Date & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2004-08-20 & 0.0029 & 0.0794 & 0.0042 & 0.0029 \\
2004-08-23 & 0.0091 & 0.0101 & -0.0070 & 0.0044 \\
2004-08-24 & 0.0280 & -0.0414 & 0.0007 & 0.0000 \\
2004-08-25 & 0.0344 & 0.0108 & 0.0042 & 0.0114 \\
2004-08-26 & 0.0487 & 0.0180 & -0.0045 & -0.0040 \\
... & ... & ... & ... & ... \\
2024-01-26 & -0.0090 & 0.0010 & -0.0158 & -0.0023 \\
2024-01-29 & -0.0036 & 0.0068 & -0.0015 & 0.0143 \\
2024-01-30 & -0.0192 & -0.0116 & 0.0039 & -0.0028 \\
2024-01-31 & -0.0194 & -0.0735 & -0.0224 & -0.0269 \\
2024-02-01 & 0.0133 & 0.0064 & 0.0176 & 0.0156 \\
\end{longtable}

\subsection{What are the mean daily returns for these four
stocks?}\label{what-are-the-mean-daily-returns-for-these-four-stocks}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.mean()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.0014
GOOG   0.0010
IBM    0.0004
MSFT   0.0008
dtype: float64
\end{verbatim}

We if want an equally-weighted portfolio return? We could take the mean
of each \emph{row} with \texttt{.mean(axis=1)}. The mean is the same as
the sum of 0.25 times each of the 4 columns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.mean(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Date
2004-08-20    0.0224
2004-08-23    0.0041
2004-08-24   -0.0032
2004-08-25    0.0152
2004-08-26    0.0146
               ...  
2024-01-26   -0.0065
2024-01-29    0.0040
2024-01-30   -0.0074
2024-01-31   -0.0356
2024-02-01    0.0132
Length: 4896, dtype: float64
\end{verbatim}

\subsection{What are the standard deviations of daily returns for these
four
stocks?}\label{what-are-the-standard-deviations-of-daily-returns-for-these-four-stocks}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.std()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.0206
GOOG   0.0194
IBM    0.0143
MSFT   0.0171
dtype: float64
\end{verbatim}

\subsection{\texorpdfstring{What are the \emph{annualized} means and
standard deviations of daily returns for these four
stocks?}{What are the annualized means and standard deviations of daily returns for these four stocks?}}\label{what-are-the-annualized-means-and-standard-deviations-of-daily-returns-for-these-four-stocks}

We multiply by \(T\) to annualize means, where \(T\) is the number of
observations per year.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.mean().mul(}\DecValTok{252}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.3625
GOOG   0.2552
IBM    0.0980
MSFT   0.2002
dtype: float64
\end{verbatim}

We multiply by \(\sqrt{T}\) to annualize volatilities, where \(T\) is
the number of observations per year.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.std().mul(np.sqrt(}\DecValTok{252}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.3276
GOOG   0.3074
IBM    0.2272
MSFT   0.2722
dtype: float64
\end{verbatim}

\subsection{\texorpdfstring{Plot \emph{annualized} means versus standard
deviations of daily returns for these four
stocks}{Plot annualized means versus standard deviations of daily returns for these four stocks}}\label{plot-annualized-means-versus-standard-deviations-of-daily-returns-for-these-four-stocks}

Use \texttt{plt.scatter()}, which expects arguments as \texttt{x}
(standard deviations) then \texttt{y} (means).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vols }\OperatorTok{=}\NormalTok{ returns.std().mul(np.sqrt(}\DecValTok{252}\NormalTok{) }\OperatorTok{*} \DecValTok{100}\NormalTok{)}
\NormalTok{means }\OperatorTok{=}\NormalTok{ returns.mean().mul(}\DecValTok{252} \OperatorTok{*} \DecValTok{100}\NormalTok{)}

\NormalTok{plt.scatter(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{vols,}
\NormalTok{    y}\OperatorTok{=}\NormalTok{means,}
\NormalTok{    c}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}red\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}blue\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}green\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}purple\textquotesingle{}}\NormalTok{]}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Annualized Volatility of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}

\CommentTok{\# plt.xlim((0, vols.max() + 5))}
\CommentTok{\# plt.ylim((0, means.max() + 5))}

\CommentTok{\# add tickers to each point}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ means.index: }\CommentTok{\# loop over ticker index}
\NormalTok{    plt.text( }\CommentTok{\# plots string s at coordinates x and y}
\NormalTok{        x}\OperatorTok{=}\NormalTok{vols[i], }\CommentTok{\# indexes volatility}
\NormalTok{        y}\OperatorTok{=}\NormalTok{means[i], }\CommentTok{\# indexes mean return}
\NormalTok{        s}\OperatorTok{=}\NormalTok{i }\CommentTok{\# ticker index}
\NormalTok{    )}

\NormalTok{plt.title(}\StringTok{\textquotesingle{}Returns versus Risk\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show() }\CommentTok{\# suppresses output of last function call}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_05_practice_02_files/figure-pdf/cell-21-output-1.png}

\subsection{Repeat the previous calculations and plot for the stocks in
the Dow-Jones Industrial Index
(DJIA)}\label{repeat-the-previous-calculations-and-plot-for-the-stocks-in-the-dow-jones-industrial-index-djia}

We can find the current DJIA stocks on
\href{https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average}{Wikipedia}.
We will need to download new data, into \texttt{tickers2},
\texttt{prices2}, and \texttt{returns2}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{url2 }\OperatorTok{=} \StringTok{\textquotesingle{}https://en.wikipedia.org/wiki/Dow\_Jones\_Industrial\_Average\textquotesingle{}}
\NormalTok{wiki2 }\OperatorTok{=}\NormalTok{ pd.read\_html(io}\OperatorTok{=}\NormalTok{url2)}
\NormalTok{tickers2 }\OperatorTok{=}\NormalTok{ wiki2[}\DecValTok{1}\NormalTok{][}\StringTok{\textquotesingle{}Symbol\textquotesingle{}}\NormalTok{].to\_list()}
\NormalTok{tickers2[:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['MMM', 'AXP', 'AMGN', 'AAPL', 'BA']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices2 }\OperatorTok{=}\NormalTok{ yf.download(tickers}\OperatorTok{=}\NormalTok{tickers2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  30 of 30 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns2 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    prices2[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{] }\CommentTok{\# slice the adj close columns for all 30 tickers}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\CommentTok{\# drop last row with incomplete prices because we are before the close}
\NormalTok{    .pct\_change() }\CommentTok{\# calculate returns}
\NormalTok{    .dropna() }\CommentTok{\# drops any row with incomplete data}
\NormalTok{)}

\NormalTok{returns2}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
& AAPL & AMGN & AXP & BA & CAT & CRM & CSCO & CVX & DIS & DOW & ... &
MRK & MSFT & NKE & PG & TRV & UNH & V & VZ & WBA & WMT \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2019-03-21 & 0.0368 & 0.0040 & 0.0095 & -0.0092 & 0.0079 & 0.0210 &
0.0128 & 0.0094 & -0.0121 & -0.0165 & ... & 0.0106 & 0.0230 & 0.0152 &
0.0076 & 0.0231 & 0.0061 & 0.0133 & 0.0108 & 0.0129 & 0.0043 \\
2019-03-22 & -0.0207 & -0.0270 & -0.0211 & -0.0283 & -0.0320 & -0.0326 &
-0.0222 & -0.0220 & -0.0040 & -0.0078 & ... & -0.0080 & -0.0264 &
-0.0661 & -0.0081 & 0.0039 & -0.0196 & -0.0175 & 0.0252 & -0.0187 &
-0.0079 \\
2019-03-25 & -0.0121 & -0.0006 & -0.0038 & 0.0229 & 0.0124 & -0.0038 &
-0.0002 & -0.0016 & -0.0041 & 0.0113 & ... & 0.0007 & 0.0052 & 0.0017 &
0.0030 & 0.0004 & -0.0009 & -0.0003 & 0.0054 & -0.0115 & -0.0011 \\
2019-03-26 & -0.0103 & 0.0090 & 0.0042 & -0.0002 & 0.0035 & -0.0092 &
0.0095 & 0.0101 & 0.0218 & -0.0061 & ... & 0.0069 & 0.0021 & 0.0128 &
0.0104 & 0.0002 & -0.0141 & 0.0148 & 0.0092 & 0.0037 & 0.0015 \\
2019-03-27 & 0.0090 & -0.0104 & -0.0047 & 0.0103 & -0.0049 & -0.0269 &
-0.0017 & -0.0108 & 0.0013 & 0.0256 & ... & -0.0076 & -0.0097 & -0.0035
& -0.0012 & 0.0101 & -0.0069 & -0.0070 & 0.0041 & 0.0050 & -0.0113 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2024-01-26 & -0.0090 & 0.0049 & 0.0710 & 0.0178 & -0.0045 & 0.0033 &
-0.0036 & 0.0038 & 0.0053 & -0.0160 & ... & 0.0057 & -0.0023 & 0.0196 &
0.0033 & -0.0004 & 0.0199 & -0.0171 & 0.0026 & -0.0113 & 0.0088 \\
2024-01-29 & -0.0036 & 0.0054 & -0.0028 & -0.0014 & 0.0128 & 0.0283 &
0.0029 & -0.0004 & 0.0223 & 0.0002 & ... & 0.0038 & 0.0143 & 0.0110 &
0.0001 & -0.0015 & 0.0027 & 0.0213 & -0.0083 & -0.0057 & 0.0047 \\
2024-01-30 & -0.0192 & 0.0037 & 0.0164 & -0.0231 & 0.0050 & -0.0005 &
-0.0010 & 0.0070 & -0.0056 & 0.0074 & ... & 0.0031 & -0.0028 & 0.0029 &
0.0085 & 0.0115 & -0.0018 & 0.0128 & 0.0100 & 0.0018 & 0.0033 \\
2024-01-31 & -0.0194 & -0.0011 & -0.0167 & 0.0529 & -0.0146 & -0.0231 &
-0.0394 & -0.0179 & -0.0092 & -0.0160 & ... & -0.0072 & -0.0269 &
-0.0254 & -0.0022 & -0.0102 & 0.0161 & -0.0140 & -0.0028 & -0.0083 &
-0.0021 \\
2024-02-01 & 0.0133 & 0.0328 & 0.0124 & -0.0058 & 0.0246 & 0.0096 &
0.0000 & 0.0031 & 0.0105 & -0.0011 & ... & 0.0464 & 0.0156 & 0.0023 &
0.0130 & 0.0031 & -0.0090 & 0.0139 & 0.0033 & 0.0301 & 0.0185 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vols2 }\OperatorTok{=}\NormalTok{ returns2.std().mul(np.sqrt(}\DecValTok{252}\NormalTok{) }\OperatorTok{*} \DecValTok{100}\NormalTok{)}
\NormalTok{means2 }\OperatorTok{=}\NormalTok{ returns2.mean().mul(}\DecValTok{252} \OperatorTok{*} \DecValTok{100}\NormalTok{)}

\NormalTok{plt.scatter(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{vols2,}
\NormalTok{    y}\OperatorTok{=}\NormalTok{means2}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Annualized Volatility of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}

\CommentTok{\# plt.xlim((0, vols2.max() + 5))}
\CommentTok{\# plt.ylim((0, means2.max() + 5))}

\CommentTok{\# add tickers to each point}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ means2.index: }\CommentTok{\# loop over ticker index}
\NormalTok{    plt.text( }\CommentTok{\# plots string s at coordinates x and y}
\NormalTok{        x}\OperatorTok{=}\NormalTok{vols2[i], }\CommentTok{\# indexes volatility}
\NormalTok{        y}\OperatorTok{=}\NormalTok{means2[i], }\CommentTok{\# indexes mean return}
\NormalTok{        s}\OperatorTok{=}\NormalTok{i }\CommentTok{\# ticker index}
\NormalTok{    )}

\NormalTok{plt.title(}\StringTok{\textquotesingle{}Returns versus Risk\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show() }\CommentTok{\# suppresses output of last function call}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_05_practice_02_files/figure-pdf/cell-25-output-1.png}

With 30 stocks we see there is no relation between returns and
volatility because most volatility is \emph{diversifiable} and
uncompensated.

\subsection{Calculate total returns for the stocks in the
DJIA}\label{calculate-total-returns-for-the-stocks-in-the-djia}

We can use the \texttt{.prod()} method to compound returns as
\(1 + R_T = \prod_{t=1}^T (1 + R_t)\). Technically, we should write
\(R_T\) as \(R_{0,T}\), but we typically omit the subscript \(0\).

I prefer to chain these operations, with \texttt{.add(1)}, then
\texttt{.prod()}, then \texttt{.sub(1)}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2 }\OperatorTok{=}\NormalTok{ returns2.add(}\DecValTok{1}\NormalTok{).prod().sub(}\DecValTok{1}\NormalTok{)}

\NormalTok{total\_returns2.iloc[:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL    3.1210
AMGN    0.9635
AXP     0.9687
BA     -0.4289
CAT     1.6083
dtype: float64
\end{verbatim}

\subsection{Plot the distribution of total returns for the stocks in the
DJIA}\label{plot-the-distribution-of-total-returns-for-the-stocks-in-the-djia}

We can plot a histogram, using either the \texttt{plt.hist()} function
or the \texttt{.plot(kind=\textquotesingle{}hist\textquotesingle{})}
method.

A histogram is a great way to visualize data!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    returns2}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .prod()}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}hist\textquotesingle{}}\NormalTok{, bins}\OperatorTok{=}\DecValTok{20}\NormalTok{)}
\NormalTok{)}

\NormalTok{start\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{min}\NormalTok{()}
\NormalTok{stop\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{max}\NormalTok{()}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Total Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Distribution of Total Returns for DJIA Stocks}\CharTok{\textbackslash{}n}\SpecialStringTok{ from }\SpecialCharTok{\{}\NormalTok{start\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ through }\SpecialCharTok{\{}\NormalTok{stop\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_05_practice_02_files/figure-pdf/cell-27-output-1.png}

With only 30 stocks, we can actually visualize each total return!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    returns2}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .prod()}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .sort\_values() }\CommentTok{\# sort by total returns}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}barh\textquotesingle{}}\NormalTok{) }\CommentTok{\# horizontal bar chart}
\NormalTok{)}

\NormalTok{start\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{min}\NormalTok{()}
\NormalTok{stop\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{max}\NormalTok{()}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Total Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Distribution of Total Returns for DJIA Stocks}\CharTok{\textbackslash{}n}\SpecialStringTok{ from }\SpecialCharTok{\{}\NormalTok{start\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ through }\SpecialCharTok{\{}\NormalTok{stop\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_05_practice_02_files/figure-pdf/cell-28-output-1.png}

\subsection{Which stocks have the minimum and maximum total
returns?}\label{which-stocks-have-the-minimum-and-maximum-total-returns}

If we want the \emph{values}, the \texttt{.min()} and \texttt{.max()}
methods are the way to go!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.}\BuiltInTok{min}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-0.5384
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.}\BuiltInTok{max}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
3.1210
\end{verbatim}

If we want the \emph{ticker}, the \texttt{.idxmin()} and
\texttt{.idxmax()} methods are the way to go!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.idxmin()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'WBA'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.idxmax()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'AAPL'
\end{verbatim}

If we want the smallest and the largest together, we can chain a few
methods!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.sort\_values().iloc[[}\DecValTok{0}\NormalTok{, }\OperatorTok{{-}}\DecValTok{1}\NormalTok{]]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
WBA    -0.5384
AAPL    3.1210
dtype: float64
\end{verbatim}

Not the exactly right tool here, but the
\texttt{.nsmallest()\textquotesingle{}\ and}.nlargest()` methods are
really useful!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.nsmallest(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
WBA   -0.5384
MMM   -0.4408
BA    -0.4289
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.nlargest(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   3.1210
MSFT   2.6028
CAT    1.6083
dtype: float64
\end{verbatim}

\subsection{Plot the cumulative returns for the stocks in the
DJIA}\label{plot-the-cumulative-returns-for-the-stocks-in-the-djia}

We can use the cumulative product method \texttt{.cumprod()} to
calculate the right hand side of the formula above.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    returns2}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .plot(legend}\OperatorTok{=}\VariableTok{False}\NormalTok{, linewidth}\OperatorTok{=}\FloatTok{0.5}\NormalTok{) }\CommentTok{\# with 30 stocks, this legend is too big to be useful}
\NormalTok{)}
\NormalTok{start\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{min}\NormalTok{()}
\NormalTok{stop\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{max}\NormalTok{()}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Cumulative Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Cumulative Returns for DJIA Stocks}\CharTok{\textbackslash{}n}\SpecialStringTok{ from }\SpecialCharTok{\{}\NormalTok{start\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ through }\SpecialCharTok{\{}\NormalTok{stop\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_05_practice_02_files/figure-pdf/cell-36-output-1.png}

\subsection{Repeat the plot above with only the minimum and maximum
total
returns}\label{repeat-the-plot-above-with-only-the-minimum-and-maximum-total-returns}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.sort\_values().iloc[[}\DecValTok{0}\NormalTok{, }\OperatorTok{{-}}\DecValTok{1}\NormalTok{]].index}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Index(['WBA', 'AAPL'], dtype='object')
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    returns2 }\CommentTok{\# all returns for all stocks}
\NormalTok{    [total\_returns2.sort\_values().iloc[[}\DecValTok{0}\NormalTok{, }\OperatorTok{{-}}\DecValTok{1}\NormalTok{]].index] }\CommentTok{\# slice min and max total return stocks}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .plot()}
\NormalTok{)}
\NormalTok{start\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{min}\NormalTok{()}
\NormalTok{stop\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{max}\NormalTok{()}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Cumulative Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Cumulative Returns for DJIA Stocks}\CharTok{\textbackslash{}n}\SpecialStringTok{ from }\SpecialCharTok{\{}\NormalTok{start\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ through }\SpecialCharTok{\{}\NormalTok{stop\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_05_practice_02_files/figure-pdf/cell-38-output-1.png}

\chapter{McKinney Chapter 5 - Practice for Section
03}\label{mckinney-chapter-5---practice-for-section-03}

\section{Announcements}\label{announcements-13}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  No DataCamp this week, but I suggest you keep working on it
\item
  Keep forming groups, and I will post our first project early next week
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-12}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

pandas provides two \emph{very useful} data structures:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Data frames are like a worksheet in an Excel workbook (2-D, mixed data
  type)
\item
  Series are like a column in a worksheet in an Excel workbook (1-D, one
  data type)
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{df }\OperatorTok{=}\NormalTok{ pd.DataFrame(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{np.random.randn(}\DecValTok{4}\NormalTok{, }\DecValTok{4}\NormalTok{),}
\NormalTok{    index}\OperatorTok{=}\BuiltInTok{list}\NormalTok{(}\StringTok{\textquotesingle{}ABCD\textquotesingle{}}\NormalTok{),}
\NormalTok{    columns}\OperatorTok{=}\BuiltInTok{list}\NormalTok{(}\StringTok{\textquotesingle{}abcd\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& a & b & c & d \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
A & 0.4967 & -0.1383 & 0.6477 & 1.5230 \\
B & -0.2342 & -0.2341 & 1.5792 & 0.7674 \\
C & -0.4695 & 0.5426 & -0.4634 & -0.4657 \\
D & 0.2420 & -1.9133 & -1.7249 & -0.5623 \\
\end{longtable}

How can we slice the first two rows and three columns? We can slice data
frames two ways:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Using integer locations and the \texttt{.iloc{[}{]}} method
\item
  Using row and column names with the \texttt{.loc{[}{]}} method
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.iloc[:}\DecValTok{2}\NormalTok{, :}\DecValTok{3}\NormalTok{] }\CommentTok{\# slice with j,k notation, like NumPy}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& a & b & c \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
A & 0.4967 & -0.1383 & 0.6477 \\
B & -0.2342 & -0.2341 & 1.5792 \\
\end{longtable}

\textbf{\emph{When we slice by names or labels, we get both left and
right edges included!}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.loc[}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}B\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& a & b & c \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
A & 0.4967 & -0.1383 & 0.6477 \\
B & -0.2342 & -0.2341 & 1.5792 \\
\end{longtable}

We can easily add columns!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df[}\StringTok{\textquotesingle{}e\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \DecValTok{5} \CommentTok{\# broadcasts to every row in df}

\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& a & b & c & d & e \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
A & 0.4967 & -0.1383 & 0.6477 & 1.5230 & 5 \\
B & -0.2342 & -0.2341 & 1.5792 & 0.7674 & 5 \\
C & -0.4695 & 0.5426 & -0.4634 & -0.4657 & 5 \\
D & 0.2420 & -1.9133 & -1.7249 & -0.5623 & 5 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df[}\StringTok{\textquotesingle{}e\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ np.random.randn(}\DecValTok{4}\NormalTok{)}

\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& a & b & c & d & e \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
A & 0.4967 & -0.1383 & 0.6477 & 1.5230 & -1.0128 \\
B & -0.2342 & -0.2341 & 1.5792 & 0.7674 & 0.3142 \\
C & -0.4695 & 0.5426 & -0.4634 & -0.4657 & -0.9080 \\
D & 0.2420 & -1.9133 & -1.7249 & -0.5623 & -1.4123 \\
\end{longtable}

A series is the other, 1-D data structure in pandas!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ser }\OperatorTok{=}\NormalTok{ pd.Series(data}\OperatorTok{=}\NormalTok{np.arange(}\FloatTok{2.}\NormalTok{), index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}C\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}D\textquotesingle{}}\NormalTok{]) }\CommentTok{\# the . in np.arange() makes the array floats}

\NormalTok{ser}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C   0.0000
D   1.0000
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df[}\StringTok{\textquotesingle{}f\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ ser}

\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& a & b & c & d & e & f \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
A & 0.4967 & -0.1383 & 0.6477 & 1.5230 & -1.0128 & NaN \\
B & -0.2342 & -0.2341 & 1.5792 & 0.7674 & 0.3142 & NaN \\
C & -0.4695 & 0.5426 & -0.4634 & -0.4657 & -0.9080 & 0.0000 \\
D & 0.2420 & -1.9133 & -1.7249 & -0.5623 & -1.4123 & 1.0000 \\
\end{longtable}

\section{Practice}\label{practice-13}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tickers }\OperatorTok{=} \StringTok{\textquotesingle{}AAPL IBM MSFT GOOG\textquotesingle{}}
\NormalTok{prices }\OperatorTok{=}\NormalTok{ yf.download(tickers}\OperatorTok{=}\NormalTok{tickers)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  4 of 4 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    prices[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{] }\CommentTok{\# slice adj close column}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\CommentTok{\# drop last row with intra day prices, which are sometimes missing}
\NormalTok{    .pct\_change() }\CommentTok{\# calculate returns}
\NormalTok{    .dropna() }\CommentTok{\# drop leading rows with at least one missing value}
\NormalTok{)}

\NormalTok{returns}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& AAPL & GOOG & IBM & MSFT \\
Date & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2004-08-20 & 0.0029 & 0.0794 & 0.0042 & 0.0030 \\
2004-08-23 & 0.0091 & 0.0101 & -0.0070 & 0.0044 \\
2004-08-24 & 0.0280 & -0.0414 & 0.0007 & 0.0000 \\
2004-08-25 & 0.0344 & 0.0108 & 0.0042 & 0.0114 \\
2004-08-26 & 0.0487 & 0.0180 & -0.0045 & -0.0040 \\
... & ... & ... & ... & ... \\
2024-01-26 & -0.0090 & 0.0010 & -0.0158 & -0.0023 \\
2024-01-29 & -0.0036 & 0.0068 & -0.0015 & 0.0143 \\
2024-01-30 & -0.0192 & -0.0116 & 0.0039 & -0.0028 \\
2024-01-31 & -0.0194 & -0.0735 & -0.0224 & -0.0269 \\
2024-02-01 & 0.0133 & 0.0064 & 0.0176 & 0.0156 \\
\end{longtable}

\subsection{What are the mean daily returns for these four
stocks?}\label{what-are-the-mean-daily-returns-for-these-four-stocks-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.mean() }\CommentTok{\# default axis=0 takes the mean of each column}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.0014
GOOG   0.0010
IBM    0.0004
MSFT   0.0008
dtype: float64
\end{verbatim}

If we pass \texttt{axis=1}, we get the mean return on each day. We can
this an ``equally-weighted portfolio return.''
\[r_{p,t} = \sum_{i=0}^4 \frac{1}{4} r_{i, t}\]

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.mean(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Date
2004-08-20    0.0224
2004-08-23    0.0041
2004-08-24   -0.0032
2004-08-25    0.0152
2004-08-26    0.0146
               ...  
2024-01-26   -0.0065
2024-01-29    0.0040
2024-01-30   -0.0074
2024-01-31   -0.0356
2024-02-01    0.0132
Length: 4896, dtype: float64
\end{verbatim}

\subsection{What are the standard deviations of daily returns for these
four
stocks?}\label{what-are-the-standard-deviations-of-daily-returns-for-these-four-stocks-1}

pandas calcualates sample statistics by default.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.std()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.0206
GOOG   0.0194
IBM    0.0143
MSFT   0.0171
dtype: float64
\end{verbatim}

\subsection{\texorpdfstring{What are the \emph{annualized} means and
standard deviations of daily returns for these four
stocks?}{What are the annualized means and standard deviations of daily returns for these four stocks?}}\label{what-are-the-annualized-means-and-standard-deviations-of-daily-returns-for-these-four-stocks-1}

We annualize mean returns by multiplying by \(T\) (\(T=252\) for daily
returns, \(T=12\) for month returns, and so on). We annualize standard
deviations by multiplying by \(\sqrt(T)\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.mean().mul(}\DecValTok{252}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.3625
GOOG   0.2552
IBM    0.0980
MSFT   0.2002
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.std().mul(np.sqrt(}\DecValTok{252}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.3276
GOOG   0.3074
IBM    0.2272
MSFT   0.2722
dtype: float64
\end{verbatim}

\subsection{\texorpdfstring{Plot \emph{annualized} means versus standard
deviations of daily returns for these four
stocks}{Plot annualized means versus standard deviations of daily returns for these four stocks}}\label{plot-annualized-means-versus-standard-deviations-of-daily-returns-for-these-four-stocks-1}

Use \texttt{plt.scatter()}, which expects arguments as \texttt{x}
(standard deviations) then \texttt{y} (means).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vols }\OperatorTok{=}\NormalTok{ returns.std().mul(np.sqrt(}\DecValTok{252}\NormalTok{) }\OperatorTok{*} \DecValTok{100}\NormalTok{)}
\NormalTok{means }\OperatorTok{=}\NormalTok{ returns.mean().mul(}\DecValTok{252} \OperatorTok{*} \DecValTok{100}\NormalTok{)}

\NormalTok{plt.scatter(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{vols,}
\NormalTok{    y}\OperatorTok{=}\NormalTok{means}
\NormalTok{)}

\CommentTok{\# add tickers to each point}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ means.index: }\CommentTok{\# loop over ticker index}
\NormalTok{    plt.text( }\CommentTok{\# plots string s at coordinates x and y}
\NormalTok{        x}\OperatorTok{=}\NormalTok{vols[i], }\CommentTok{\# indexes volatility}
\NormalTok{        y}\OperatorTok{=}\NormalTok{means[i], }\CommentTok{\# indexes mean return}
\NormalTok{        s}\OperatorTok{=}\NormalTok{i }\CommentTok{\# ticker index}
\NormalTok{    )}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Annualized Volatility of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}

\NormalTok{plt.title(}\StringTok{\textquotesingle{}Returns versus Risk\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_05_practice_03_files/figure-pdf/cell-18-output-1.png}

\subsection{Repeat the previous calculations and plot for the stocks in
the Dow-Jones Industrial Index
(DJIA)}\label{repeat-the-previous-calculations-and-plot-for-the-stocks-in-the-dow-jones-industrial-index-djia-1}

We can find the current DJIA stocks on
\href{https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average}{Wikipedia}.
We will need to download new data, into \texttt{tickers2},
\texttt{prices2}, and \texttt{returns2}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{url2 }\OperatorTok{=} \StringTok{\textquotesingle{}https://en.wikipedia.org/wiki/Dow\_Jones\_Industrial\_Average\textquotesingle{}}
\NormalTok{wiki2 }\OperatorTok{=}\NormalTok{ pd.read\_html(io}\OperatorTok{=}\NormalTok{url2)}
\NormalTok{tickers2 }\OperatorTok{=}\NormalTok{ wiki2[}\DecValTok{1}\NormalTok{][}\StringTok{\textquotesingle{}Symbol\textquotesingle{}}\NormalTok{].to\_list()}
\NormalTok{tickers2[:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['MMM', 'AXP', 'AMGN', 'AAPL', 'BA']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices2 }\OperatorTok{=}\NormalTok{ yf.download(tickers}\OperatorTok{=}\NormalTok{tickers2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  30 of 30 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns2 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    prices2[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{] }\CommentTok{\# slide adj close for all stocks}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\CommentTok{\# drop last day of adj close, which are intraday values before 4 PM}
\NormalTok{    .pct\_change() }\CommentTok{\# calculate returns}
\NormalTok{    .dropna() }\CommentTok{\# drop any dates with incomplete data}
\NormalTok{)}

\NormalTok{returns2}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
& AAPL & AMGN & AXP & BA & CAT & CRM & CSCO & CVX & DIS & DOW & ... &
MRK & MSFT & NKE & PG & TRV & UNH & V & VZ & WBA & WMT \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2019-03-21 & 0.0368 & 0.0040 & 0.0095 & -0.0092 & 0.0079 & 0.0210 &
0.0128 & 0.0094 & -0.0121 & -0.0165 & ... & 0.0106 & 0.0230 & 0.0152 &
0.0076 & 0.0231 & 0.0061 & 0.0133 & 0.0108 & 0.0129 & 0.0043 \\
2019-03-22 & -0.0207 & -0.0270 & -0.0211 & -0.0283 & -0.0320 & -0.0326 &
-0.0222 & -0.0220 & -0.0040 & -0.0078 & ... & -0.0080 & -0.0264 &
-0.0661 & -0.0081 & 0.0039 & -0.0196 & -0.0175 & 0.0252 & -0.0187 &
-0.0079 \\
2019-03-25 & -0.0121 & -0.0006 & -0.0038 & 0.0229 & 0.0124 & -0.0038 &
-0.0002 & -0.0016 & -0.0041 & 0.0113 & ... & 0.0007 & 0.0052 & 0.0017 &
0.0030 & 0.0004 & -0.0009 & -0.0003 & 0.0054 & -0.0115 & -0.0011 \\
2019-03-26 & -0.0103 & 0.0090 & 0.0042 & -0.0002 & 0.0035 & -0.0092 &
0.0095 & 0.0101 & 0.0218 & -0.0061 & ... & 0.0069 & 0.0021 & 0.0128 &
0.0104 & 0.0002 & -0.0141 & 0.0148 & 0.0092 & 0.0037 & 0.0015 \\
2019-03-27 & 0.0090 & -0.0104 & -0.0047 & 0.0103 & -0.0049 & -0.0269 &
-0.0017 & -0.0108 & 0.0013 & 0.0256 & ... & -0.0076 & -0.0097 & -0.0035
& -0.0012 & 0.0102 & -0.0069 & -0.0070 & 0.0041 & 0.0050 & -0.0113 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2024-01-26 & -0.0090 & 0.0049 & 0.0710 & 0.0178 & -0.0045 & 0.0033 &
-0.0036 & 0.0038 & 0.0053 & -0.0160 & ... & 0.0057 & -0.0023 & 0.0196 &
0.0033 & -0.0004 & 0.0199 & -0.0171 & 0.0026 & -0.0113 & 0.0088 \\
2024-01-29 & -0.0036 & 0.0054 & -0.0028 & -0.0014 & 0.0128 & 0.0283 &
0.0029 & -0.0004 & 0.0223 & 0.0002 & ... & 0.0038 & 0.0143 & 0.0110 &
0.0001 & -0.0015 & 0.0027 & 0.0213 & -0.0083 & -0.0057 & 0.0047 \\
2024-01-30 & -0.0192 & 0.0037 & 0.0164 & -0.0231 & 0.0050 & -0.0005 &
-0.0010 & 0.0070 & -0.0056 & 0.0074 & ... & 0.0031 & -0.0028 & 0.0029 &
0.0085 & 0.0115 & -0.0018 & 0.0128 & 0.0100 & 0.0018 & 0.0033 \\
2024-01-31 & -0.0194 & -0.0011 & -0.0167 & 0.0529 & -0.0146 & -0.0231 &
-0.0394 & -0.0179 & -0.0092 & -0.0160 & ... & -0.0072 & -0.0269 &
-0.0254 & -0.0022 & -0.0102 & 0.0161 & -0.0140 & -0.0028 & -0.0083 &
-0.0021 \\
2024-02-01 & 0.0133 & 0.0328 & 0.0124 & -0.0058 & 0.0246 & 0.0096 &
0.0000 & 0.0031 & 0.0105 & -0.0011 & ... & 0.0464 & 0.0156 & 0.0023 &
0.0130 & 0.0031 & -0.0090 & 0.0139 & 0.0033 & 0.0301 & 0.0185 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vols }\OperatorTok{=}\NormalTok{ returns2.std().mul(np.sqrt(}\DecValTok{252}\NormalTok{) }\OperatorTok{*} \DecValTok{100}\NormalTok{)}
\NormalTok{means }\OperatorTok{=}\NormalTok{ returns2.mean().mul(}\DecValTok{252} \OperatorTok{*} \DecValTok{100}\NormalTok{)}

\NormalTok{plt.scatter(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{vols,}
\NormalTok{    y}\OperatorTok{=}\NormalTok{means}
\NormalTok{)}

\CommentTok{\# add tickers to each point}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ means.index: }\CommentTok{\# loop over ticker index}
\NormalTok{    plt.text( }\CommentTok{\# plots string s at coordinates x and y}
\NormalTok{        x}\OperatorTok{=}\NormalTok{vols[i], }\CommentTok{\# indexes volatility}
\NormalTok{        y}\OperatorTok{=}\NormalTok{means[i], }\CommentTok{\# indexes mean return}
\NormalTok{        s}\OperatorTok{=}\NormalTok{i }\CommentTok{\# ticker index}
\NormalTok{    )}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Annualized Volatility of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}

\NormalTok{plt.title(}\StringTok{\textquotesingle{}Returns versus Risk\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_05_practice_03_files/figure-pdf/cell-22-output-1.png}

\subsection{Calculate total returns for the stocks in the
DJIA}\label{calculate-total-returns-for-the-stocks-in-the-djia-1}

We can use the \texttt{.prod()} method to compound returns as
\(1 + R_T = \prod_{t=1}^T (1 + R_t)\). Technically, we should write
\(R_T\) as \(R_{0,T}\), but we typically omit the subscript \(0\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2 }\OperatorTok{=}\NormalTok{ returns2.add(}\DecValTok{1}\NormalTok{).prod().sub(}\DecValTok{1}\NormalTok{)}

\NormalTok{total\_returns2.iloc[:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL    3.1210
AMGN    0.9635
AXP     0.9687
BA     -0.4289
CAT     1.6083
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(((returns2 }\OperatorTok{+} \DecValTok{1}\NormalTok{).prod() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{), total\_returns2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\subsection{Plot the distribution of total returns for the stocks in the
DJIA}\label{plot-the-distribution-of-total-returns-for-the-stocks-in-the-djia-1}

We can plot a histogram, using either the \texttt{plt.hist()} function
or the \texttt{.plot(kind=\textquotesingle{}hist\textquotesingle{})}
method.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{min}\NormalTok{()}
\NormalTok{stop\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{max}\NormalTok{()}

\NormalTok{(}
\NormalTok{    returns2}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .prod()}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}hist\textquotesingle{}}\NormalTok{, bins}\OperatorTok{=}\DecValTok{20}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Total Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Distribution of Total Returns for DJIA Stocks}\CharTok{\textbackslash{}n}\SpecialStringTok{ from }\SpecialCharTok{\{}\NormalTok{start\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{stop\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_05_practice_03_files/figure-pdf/cell-25-output-1.png}

With only 30 stocks, we can visualize and interpret each stock
separately!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{min}\NormalTok{()}
\NormalTok{stop\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{max}\NormalTok{()}

\NormalTok{(}
\NormalTok{    returns2}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .prod()}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .sort\_values()}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}barh\textquotesingle{}}\NormalTok{, grid}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Total Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Total Returns for DJIA Stocks}\CharTok{\textbackslash{}n}\SpecialStringTok{ from }\SpecialCharTok{\{}\NormalTok{start\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{stop\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_05_practice_03_files/figure-pdf/cell-26-output-1.png}

\subsection{Which stocks have the minimum and maximum total
returns?}\label{which-stocks-have-the-minimum-and-maximum-total-returns-1}

If we want the \emph{values}, the \texttt{.min()} and \texttt{.max()}
methods are the way to go!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.}\BuiltInTok{min}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-0.5384
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.}\BuiltInTok{max}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
3.1210
\end{verbatim}

The \texttt{.min()} and \texttt{.max()} methods give the values but not
the tickers (or index). We use the \texttt{.idxmin()} and
\texttt{.idxmax()} to get the tickers (or index).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.idxmin()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'WBA'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.idxmax()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'AAPL'
\end{verbatim}

Here is what I would use!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.sort\_values().iloc[[}\DecValTok{0}\NormalTok{, }\OperatorTok{{-}}\DecValTok{1}\NormalTok{]]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
WBA    -0.5384
AAPL    3.1210
dtype: float64
\end{verbatim}

Not the exactly right tool here, but the
\texttt{.nsmallest()\textquotesingle{}\ and}.nlargest()` methods are
really useful!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.nsmallest(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
WBA   -0.5384
MMM   -0.4408
BA    -0.4289
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.nlargest(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   3.1210
MSFT   2.6028
CAT    1.6083
dtype: float64
\end{verbatim}

\subsection{Plot the cumulative returns for the stocks in the
DJIA}\label{plot-the-cumulative-returns-for-the-stocks-in-the-djia-1}

We can use the cumulative product method \texttt{.cumprod()} to
calculate the right hand side of the formula above.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{min}\NormalTok{()}
\NormalTok{stop\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{max}\NormalTok{()}

\NormalTok{(}
\NormalTok{    returns2}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .plot(legend}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Cumulative Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Cumulative Returns for DJIA Stocks}\CharTok{\textbackslash{}n}\SpecialStringTok{ from }\SpecialCharTok{\{}\NormalTok{start\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{stop\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_05_practice_03_files/figure-pdf/cell-34-output-1.png}

\subsection{Repeat the plot above with only the minimum and maximum
total
returns}\label{repeat-the-plot-above-with-only-the-minimum-and-maximum-total-returns-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.sort\_values().iloc[[}\DecValTok{0}\NormalTok{, }\OperatorTok{{-}}\DecValTok{1}\NormalTok{]].index}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Index(['WBA', 'AAPL'], dtype='object')
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{min}\NormalTok{()}
\NormalTok{stop\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{max}\NormalTok{()}

\NormalTok{(}
\NormalTok{    returns2[total\_returns2.sort\_values().iloc[[}\DecValTok{0}\NormalTok{, }\OperatorTok{{-}}\DecValTok{1}\NormalTok{]].index]}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .plot()}
\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Cumulative Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Cumulative Returns for DJIA Stocks}\CharTok{\textbackslash{}n}\SpecialStringTok{ from }\SpecialCharTok{\{}\NormalTok{start\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{stop\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_05_practice_03_files/figure-pdf/cell-36-output-1.png}

\chapter{McKinney Chapter 5 - Practice for Section
04}\label{mckinney-chapter-5---practice-for-section-04}

\section{Announcements}\label{announcements-14}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  No DataCamp this week, but I suggest you keep working on it
\item
  Keep forming groups, and I will post our first project early next week
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-13}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

pandas provides two data structures:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Data frame is a 2-D, mixed data type structure, like a worksheet in an
  Excel workbook
\item
  Series is a 1-D, one data type structure, like a column in a worksheet
  (or data frame)
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{df }\OperatorTok{=}\NormalTok{ pd.DataFrame(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{np.random.randn(}\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{), }\CommentTok{\# 12 random numbers}
\NormalTok{    index}\OperatorTok{=}\BuiltInTok{list}\NormalTok{(}\StringTok{\textquotesingle{}ABC\textquotesingle{}}\NormalTok{), }\CommentTok{\# labels the rows for easy indexing and slicing}
\NormalTok{    columns}\OperatorTok{=}\BuiltInTok{list}\NormalTok{(}\StringTok{\textquotesingle{}abcd\textquotesingle{}}\NormalTok{) }\CommentTok{\# labels the columns for easy indexing and slicing}
\NormalTok{)}

\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& a & b & c & d \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
A & 0.4967 & -0.1383 & 0.6477 & 1.5230 \\
B & -0.2342 & -0.2341 & 1.5792 & 0.7674 \\
C & -0.4695 & 0.5426 & -0.4634 & -0.4657 \\
\end{longtable}

How do we index or slice data frames?

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  With integer locations and the \texttt{.iloc{[}{]}} method
\item
  With row and column names and the \texttt{.loc{[}{]}} method
\end{enumerate}

Say we want the first two rows and first three columns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.iloc[:}\DecValTok{2}\NormalTok{, :}\DecValTok{3}\NormalTok{] }\CommentTok{\# j,k slicing, as in NumPy}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& a & b & c \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
A & 0.4967 & -0.1383 & 0.6477 \\
B & -0.2342 & -0.2341 & 1.5792 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.loc[[}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}B\textquotesingle{}}\NormalTok{], [}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{]]}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& a & b & c \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
A & 0.4967 & -0.1383 & 0.6477 \\
B & -0.2342 & -0.2341 & 1.5792 \\
\end{longtable}

\textbf{\emph{Both left and right edges of named slices are included in
pandas!}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.loc[}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}B\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& a & b & c \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
A & 0.4967 & -0.1383 & 0.6477 \\
B & -0.2342 & -0.2341 & 1.5792 \\
\end{longtable}

How do I add a column?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df[}\StringTok{\textquotesingle{}e\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \DecValTok{5} \CommentTok{\# pandas broadcasts this 5 to all rows}

\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& a & b & c & d & e \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
A & 0.4967 & -0.1383 & 0.6477 & 1.5230 & 5 \\
B & -0.2342 & -0.2341 & 1.5792 & 0.7674 & 5 \\
C & -0.4695 & 0.5426 & -0.4634 & -0.4657 & 5 \\
\end{longtable}

A series is the other data structure.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ser }\OperatorTok{=}\NormalTok{ pd.Series(data}\OperatorTok{=}\NormalTok{np.arange(}\FloatTok{2.}\NormalTok{), index}\OperatorTok{=}\BuiltInTok{list}\NormalTok{(}\StringTok{\textquotesingle{}BC\textquotesingle{}}\NormalTok{))}

\NormalTok{ser}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
B   0.0000
C   1.0000
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df[}\StringTok{\textquotesingle{}f\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ ser}

\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& a & b & c & d & e & f \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
A & 0.4967 & -0.1383 & 0.6477 & 1.5230 & 5 & NaN \\
B & -0.2342 & -0.2341 & 1.5792 & 0.7674 & 5 & 0.0000 \\
C & -0.4695 & 0.5426 & -0.4634 & -0.4657 & 5 & 1.0000 \\
\end{longtable}

\section{Practice}\label{practice-14}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tickers }\OperatorTok{=} \StringTok{\textquotesingle{}AAPL IBM MSFT GOOG\textquotesingle{}}
\NormalTok{prices }\OperatorTok{=}\NormalTok{ yf.download(tickers}\OperatorTok{=}\NormalTok{tickers)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  4 of 4 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    prices[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{] }\CommentTok{\# slices the adj close columns}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\CommentTok{\# drop last date with intraday price}
\NormalTok{    .pct\_change() }\CommentTok{\# calculate returns}
\NormalTok{    .dropna() }\CommentTok{\# drop dates with incomplete returns data}
\NormalTok{)}

\NormalTok{returns}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& AAPL & GOOG & IBM & MSFT \\
Date & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2004-08-20 & 0.0029 & 0.0794 & 0.0042 & 0.0030 \\
2004-08-23 & 0.0091 & 0.0101 & -0.0070 & 0.0044 \\
2004-08-24 & 0.0280 & -0.0414 & 0.0007 & 0.0000 \\
2004-08-25 & 0.0344 & 0.0108 & 0.0042 & 0.0114 \\
2004-08-26 & 0.0487 & 0.0180 & -0.0045 & -0.0040 \\
... & ... & ... & ... & ... \\
2024-01-26 & -0.0090 & 0.0010 & -0.0158 & -0.0023 \\
2024-01-29 & -0.0036 & 0.0068 & -0.0015 & 0.0143 \\
2024-01-30 & -0.0192 & -0.0116 & 0.0039 & -0.0028 \\
2024-01-31 & -0.0194 & -0.0735 & -0.0224 & -0.0269 \\
2024-02-01 & 0.0133 & 0.0064 & 0.0176 & 0.0156 \\
\end{longtable}

\subsection{What are the mean daily returns for these four
stocks?}\label{what-are-the-mean-daily-returns-for-these-four-stocks-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.mean() }\CommentTok{\# default is axis=0}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.0014
GOOG   0.0010
IBM    0.0004
MSFT   0.0008
dtype: float64
\end{verbatim}

If we use \texttt{.mean(axis=1)} on stock returns, we get the
equallu-weighted portfolio returns on each day.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.mean(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Date
2004-08-20    0.0224
2004-08-23    0.0041
2004-08-24   -0.0032
2004-08-25    0.0152
2004-08-26    0.0146
               ...  
2024-01-26   -0.0065
2024-01-29    0.0040
2024-01-30   -0.0074
2024-01-31   -0.0356
2024-02-01    0.0132
Length: 4896, dtype: float64
\end{verbatim}

\subsection{What are the standard deviations of daily returns for these
four
stocks?}\label{what-are-the-standard-deviations-of-daily-returns-for-these-four-stocks-2}

pandas methods give us \emph{sample} statistics, instead of population
statistics in NumPy.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.std()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.0206
GOOG   0.0194
IBM    0.0143
MSFT   0.0171
dtype: float64
\end{verbatim}

\subsection{\texorpdfstring{What are the \emph{annualized} means and
standard deviations of daily returns for these four
stocks?}{What are the annualized means and standard deviations of daily returns for these four stocks?}}\label{what-are-the-annualized-means-and-standard-deviations-of-daily-returns-for-these-four-stocks-2}

We annualize mean returns by multiplying by \(T\) (\(T=252\) for daily
returns, \(T=12\) for month returns, and so on). We annualize standard
deviations by multiplying by \(\sqrt(T)\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.mean().mul(}\DecValTok{252}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.3625
GOOG   0.2552
IBM    0.0980
MSFT   0.2002
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.std().mul(np.sqrt(}\DecValTok{252}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.3276
GOOG   0.3074
IBM    0.2272
MSFT   0.2722
dtype: float64
\end{verbatim}

\subsection{\texorpdfstring{Plot \emph{annualized} means versus standard
deviations of daily returns for these four
stocks}{Plot annualized means versus standard deviations of daily returns for these four stocks}}\label{plot-annualized-means-versus-standard-deviations-of-daily-returns-for-these-four-stocks-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{means }\OperatorTok{=}\NormalTok{ returns.mean().mul(}\DecValTok{252} \OperatorTok{*} \DecValTok{100}\NormalTok{)}
\NormalTok{vols }\OperatorTok{=}\NormalTok{ returns.std().mul(np.sqrt(}\DecValTok{252}\NormalTok{) }\OperatorTok{*} \DecValTok{100}\NormalTok{)}

\NormalTok{plt.scatter(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{vols,}
\NormalTok{    y}\OperatorTok{=}\NormalTok{means}
\NormalTok{)}

\CommentTok{\# add tickers to each point}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ means.index: }\CommentTok{\# loop over ticker index}
\NormalTok{    plt.text( }\CommentTok{\# plots string s at coordinates x and y}
\NormalTok{        x}\OperatorTok{=}\NormalTok{vols[i], }\CommentTok{\# indexes volatility}
\NormalTok{        y}\OperatorTok{=}\NormalTok{means[i], }\CommentTok{\# indexes mean return}
\NormalTok{        s}\OperatorTok{=}\NormalTok{i }\CommentTok{\# ticker index}
\NormalTok{    )}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Annualized Volatility of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Means of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Returns versus Risk\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_05_practice_04_files/figure-pdf/cell-18-output-1.png}

Use \texttt{plt.scatter()}, which expects arguments as \texttt{x}
(standard deviations) then \texttt{y} (means).

\subsection{Repeat the previous calculations and plot for the stocks in
the Dow-Jones Industrial Index
(DJIA)}\label{repeat-the-previous-calculations-and-plot-for-the-stocks-in-the-dow-jones-industrial-index-djia-2}

We can find the current DJIA stocks on
\href{https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average}{Wikipedia}.
We will need to download new data, into \texttt{tickers2},
\texttt{prices2}, and \texttt{returns2}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{url2 }\OperatorTok{=} \StringTok{\textquotesingle{}https://en.wikipedia.org/wiki/Dow\_Jones\_Industrial\_Average\textquotesingle{}}
\NormalTok{wiki2 }\OperatorTok{=}\NormalTok{ pd.read\_html(url2)}
\NormalTok{tickers2 }\OperatorTok{=}\NormalTok{ wiki2[}\DecValTok{1}\NormalTok{][}\StringTok{\textquotesingle{}Symbol\textquotesingle{}}\NormalTok{].to\_list()}
\NormalTok{tickers2[:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['MMM', 'AXP', 'AMGN', 'AAPL', 'BA']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices2 }\OperatorTok{=}\NormalTok{ yf.download(tickers}\OperatorTok{=}\NormalTok{tickers2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  30 of 30 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns2 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    prices2[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    .pct\_change()}
\NormalTok{    .dropna()}
\NormalTok{)}

\NormalTok{returns2}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
& AAPL & AMGN & AXP & BA & CAT & CRM & CSCO & CVX & DIS & DOW & ... &
MRK & MSFT & NKE & PG & TRV & UNH & V & VZ & WBA & WMT \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2019-03-21 & 0.0368 & 0.0040 & 0.0095 & -0.0092 & 0.0079 & 0.0210 &
0.0128 & 0.0094 & -0.0121 & -0.0165 & ... & 0.0106 & 0.0230 & 0.0152 &
0.0076 & 0.0231 & 0.0061 & 0.0133 & 0.0108 & 0.0129 & 0.0043 \\
2019-03-22 & -0.0207 & -0.0270 & -0.0211 & -0.0283 & -0.0320 & -0.0326 &
-0.0222 & -0.0220 & -0.0040 & -0.0078 & ... & -0.0080 & -0.0264 &
-0.0661 & -0.0081 & 0.0039 & -0.0196 & -0.0175 & 0.0252 & -0.0187 &
-0.0079 \\
2019-03-25 & -0.0121 & -0.0006 & -0.0038 & 0.0229 & 0.0124 & -0.0038 &
-0.0002 & -0.0016 & -0.0041 & 0.0113 & ... & 0.0007 & 0.0052 & 0.0017 &
0.0030 & 0.0004 & -0.0009 & -0.0003 & 0.0054 & -0.0115 & -0.0011 \\
2019-03-26 & -0.0103 & 0.0090 & 0.0042 & -0.0002 & 0.0035 & -0.0092 &
0.0095 & 0.0101 & 0.0218 & -0.0061 & ... & 0.0069 & 0.0021 & 0.0128 &
0.0104 & 0.0002 & -0.0141 & 0.0148 & 0.0092 & 0.0037 & 0.0015 \\
2019-03-27 & 0.0090 & -0.0104 & -0.0047 & 0.0103 & -0.0049 & -0.0269 &
-0.0017 & -0.0108 & 0.0013 & 0.0256 & ... & -0.0076 & -0.0097 & -0.0035
& -0.0012 & 0.0101 & -0.0069 & -0.0070 & 0.0041 & 0.0050 & -0.0113 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2024-01-26 & -0.0090 & 0.0049 & 0.0710 & 0.0178 & -0.0045 & 0.0033 &
-0.0036 & 0.0038 & 0.0053 & -0.0160 & ... & 0.0057 & -0.0023 & 0.0196 &
0.0033 & -0.0004 & 0.0199 & -0.0171 & 0.0026 & -0.0113 & 0.0088 \\
2024-01-29 & -0.0036 & 0.0054 & -0.0028 & -0.0014 & 0.0128 & 0.0283 &
0.0029 & -0.0004 & 0.0223 & 0.0002 & ... & 0.0038 & 0.0143 & 0.0110 &
0.0001 & -0.0015 & 0.0027 & 0.0213 & -0.0083 & -0.0057 & 0.0047 \\
2024-01-30 & -0.0192 & 0.0037 & 0.0164 & -0.0231 & 0.0050 & -0.0005 &
-0.0010 & 0.0070 & -0.0056 & 0.0074 & ... & 0.0031 & -0.0028 & 0.0029 &
0.0085 & 0.0115 & -0.0018 & 0.0128 & 0.0100 & 0.0018 & 0.0033 \\
2024-01-31 & -0.0194 & -0.0011 & -0.0167 & 0.0529 & -0.0146 & -0.0231 &
-0.0394 & -0.0179 & -0.0092 & -0.0160 & ... & -0.0072 & -0.0269 &
-0.0254 & -0.0022 & -0.0102 & 0.0161 & -0.0140 & -0.0028 & -0.0083 &
-0.0021 \\
2024-02-01 & 0.0133 & 0.0328 & 0.0124 & -0.0058 & 0.0246 & 0.0096 &
0.0000 & 0.0031 & 0.0105 & -0.0011 & ... & 0.0464 & 0.0156 & 0.0023 &
0.0130 & 0.0031 & -0.0090 & 0.0139 & 0.0033 & 0.0301 & 0.0185 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{means }\OperatorTok{=}\NormalTok{ returns2.mean().mul(}\DecValTok{252} \OperatorTok{*} \DecValTok{100}\NormalTok{)}
\NormalTok{vols }\OperatorTok{=}\NormalTok{ returns2.std().mul(np.sqrt(}\DecValTok{252}\NormalTok{) }\OperatorTok{*} \DecValTok{100}\NormalTok{)}

\NormalTok{plt.scatter(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{vols,}
\NormalTok{    y}\OperatorTok{=}\NormalTok{means}
\NormalTok{)}

\CommentTok{\# add tickers to each point}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ means.index: }\CommentTok{\# loop over ticker index}
\NormalTok{    plt.text( }\CommentTok{\# plots string s at coordinates x and y}
\NormalTok{        x}\OperatorTok{=}\NormalTok{vols[i], }\CommentTok{\# indexes volatility}
\NormalTok{        y}\OperatorTok{=}\NormalTok{means[i], }\CommentTok{\# indexes mean return}
\NormalTok{        s}\OperatorTok{=}\NormalTok{i }\CommentTok{\# ticker index}
\NormalTok{    )}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Annualized Volatility of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Means of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Returns versus Risk\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_05_practice_04_files/figure-pdf/cell-22-output-1.png}

\subsection{Calculate total returns for the stocks in the
DJIA}\label{calculate-total-returns-for-the-stocks-in-the-djia-2}

We can use the \texttt{.prod()} method to compound returns as
\(1 + R_T = \prod_{t=1}^T (1 + R_t)\). Technically, we should write
\(R_T\) as \(R_{0,T}\), but we typically omit the subscript \(0\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2 }\OperatorTok{=}\NormalTok{ returns2.add(}\DecValTok{1}\NormalTok{).prod().sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{total\_returns2.iloc[:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL    3.1210
AMGN    0.9635
AXP     0.9687
BA     -0.4289
CAT     1.6083
dtype: float64
\end{verbatim}

\subsection{Plot the distribution of total returns for the stocks in the
DJIA}\label{plot-the-distribution-of-total-returns-for-the-stocks-in-the-djia-2}

We can plot a histogram, using either the \texttt{plt.hist()} function
or the \texttt{.plot(kind=\textquotesingle{}hist\textquotesingle{})}
method.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{min}\NormalTok{()}
\NormalTok{stop\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{max}\NormalTok{()}

\NormalTok{(}
\NormalTok{    returns2}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .prod()}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}hist\textquotesingle{}}\NormalTok{, bins}\OperatorTok{=}\DecValTok{20}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Total Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Distribution of Total Returns for DJIA Stocks}\CharTok{\textbackslash{}n}\SpecialStringTok{ from }\SpecialCharTok{\{}\NormalTok{start\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{stop\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_05_practice_04_files/figure-pdf/cell-24-output-1.png}

With only 30 stocks, we can visualize and interpret each stock
separately!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{min}\NormalTok{()}
\NormalTok{stop\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{max}\NormalTok{()}

\NormalTok{(}
\NormalTok{    returns2}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .prod()}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .sort\_values()}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}barh\textquotesingle{}}\NormalTok{, grid}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Total Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Total Returns for DJIA Stocks}\CharTok{\textbackslash{}n}\SpecialStringTok{ from }\SpecialCharTok{\{}\NormalTok{start\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{stop\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_05_practice_04_files/figure-pdf/cell-25-output-1.png}

\subsection{Which stocks have the minimum and maximum total
returns?}\label{which-stocks-have-the-minimum-and-maximum-total-returns-2}

If we want the \emph{values}, the \texttt{.min()} and \texttt{.max()}
methods are the way to go!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.}\BuiltInTok{min}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-0.5384
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.}\BuiltInTok{max}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
3.1210
\end{verbatim}

The \texttt{.min()} and \texttt{.max()} methods give the values but not
the tickers (or index). We use the \texttt{.idxmin()} and
\texttt{.idxmax()} to get the tickers (or index).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.idxmin()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'WBA'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.idxmax()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'AAPL'
\end{verbatim}

Here is what I would use!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.sort\_values().iloc[[}\DecValTok{0}\NormalTok{, }\OperatorTok{{-}}\DecValTok{1}\NormalTok{]]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
WBA    -0.5384
AAPL    3.1210
dtype: float64
\end{verbatim}

Not the exactly right tool here, but the
\texttt{.nsmallest()\textquotesingle{}\ and}.nlargest()` methods are
really useful!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.nsmallest(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
WBA   -0.5384
MMM   -0.4408
BA    -0.4289
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.nlargest(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   3.1210
MSFT   2.6028
CAT    1.6083
dtype: float64
\end{verbatim}

\subsection{Plot the cumulative returns for the stocks in the
DJIA}\label{plot-the-cumulative-returns-for-the-stocks-in-the-djia-2}

We can use the cumulative product method \texttt{.cumprod()} to
calculate the right hand side of the formula above.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{min}\NormalTok{()}
\NormalTok{stop\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{max}\NormalTok{()}

\NormalTok{(}
\NormalTok{    returns2}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .plot(legend}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Cumulative Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Cumulative Returns on DJIA Stocks}\CharTok{\textbackslash{}n}\SpecialStringTok{ from }\SpecialCharTok{\{}\NormalTok{start\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{stop\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_05_practice_04_files/figure-pdf/cell-33-output-1.png}

\subsection{Repeat the plot above with only the minimum and maximum
total
returns}\label{repeat-the-plot-above-with-only-the-minimum-and-maximum-total-returns-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.sort\_values().iloc[[}\DecValTok{0}\NormalTok{, }\OperatorTok{{-}}\DecValTok{1}\NormalTok{]].index}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Index(['WBA', 'AAPL'], dtype='object')
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{min}\NormalTok{()}
\NormalTok{stop\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{max}\NormalTok{()}

\NormalTok{(}
\NormalTok{    returns2[total\_returns2.sort\_values().iloc[[}\DecValTok{0}\NormalTok{, }\OperatorTok{{-}}\DecValTok{1}\NormalTok{]].index]}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .plot()}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Cumulative Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Cumulative Returns on DJIA Stocks}\CharTok{\textbackslash{}n}\SpecialStringTok{ from }\SpecialCharTok{\{}\NormalTok{start\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{stop\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_05_practice_04_files/figure-pdf/cell-35-output-1.png}

\chapter{McKinney Chapter 5 - Practice for Section
05}\label{mckinney-chapter-5---practice-for-section-05}

\section{Announcements}\label{announcements-15}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  No DataCamp this week, but I suggest you keep working on it
\item
  Keep forming groups, and I will post our first project early next week
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-14}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

pandas gives us two data structures:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Data Frames
\item
  Series
\end{enumerate}

A data frame is like a worksheet in an Excel workbook.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{df }\OperatorTok{=}\NormalTok{ pd.DataFrame(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{np.random.randn(}\DecValTok{3}\NormalTok{, }\DecValTok{5}\NormalTok{), }\CommentTok{\# 15 random numbers}
\NormalTok{    index}\OperatorTok{=}\BuiltInTok{list}\NormalTok{(}\StringTok{\textquotesingle{}ABC\textquotesingle{}}\NormalTok{), }\CommentTok{\# labels the rows for easy indexing and slicing}
\NormalTok{    columns}\OperatorTok{=}\BuiltInTok{list}\NormalTok{(}\StringTok{\textquotesingle{}abcde\textquotesingle{}}\NormalTok{) }\CommentTok{\# labels the columns for easy indexing and slicing}
\NormalTok{)}

\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& a & b & c & d & e \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
A & 0.4967 & -0.1383 & 0.6477 & 1.5230 & -0.2342 \\
B & -0.2341 & 1.5792 & 0.7674 & -0.4695 & 0.5426 \\
C & -0.4634 & -0.4657 & 0.2420 & -1.9133 & -1.7249 \\
\end{longtable}

How can we get the first two rows and first three columns?

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  We can slice by integer location with the \texttt{.iloc{[}{]}} method
\item
  We can slice by names with the \texttt{.loc{[}{]}} method
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.iloc[:}\DecValTok{2}\NormalTok{, :}\DecValTok{3}\NormalTok{] }\CommentTok{\# j,k slicing, as in NumPy}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& a & b & c \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
A & 0.4967 & -0.1383 & 0.6477 \\
B & -0.2341 & 1.5792 & 0.7674 \\
\end{longtable}

\textbf{\emph{When we slice by names, both left and right edges are
}included\emph{!}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.loc[}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}B\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& a & b & c \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
A & 0.4967 & -0.1383 & 0.6477 \\
B & -0.2341 & 1.5792 & 0.7674 \\
\end{longtable}

We can use the \texttt{.head()} method to show the first \texttt{n} rows
in \texttt{df}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.head(}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& a & b & c & d & e \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
A & 0.4967 & -0.1383 & 0.6477 & 1.5230 & -0.2342 \\
B & -0.2341 & 1.5792 & 0.7674 & -0.4695 & 0.5426 \\
\end{longtable}

How do I add a column?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df[}\StringTok{\textquotesingle{}f\textquotesingle{}}\NormalTok{] }\OperatorTok{=} \DecValTok{5} \CommentTok{\# as in NumPy, this 5 will broadcast to all the rows}

\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& a & b & c & d & e & f \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
A & 0.4967 & -0.1383 & 0.6477 & 1.5230 & -0.2342 & 5 \\
B & -0.2341 & 1.5792 & 0.7674 & -0.4695 & 0.5426 & 5 \\
C & -0.4634 & -0.4657 & 0.2420 & -1.9133 & -1.7249 & 5 \\
\end{longtable}

A series is like a single column in an Excel worksheet (or a pandas data
frame).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ser }\OperatorTok{=}\NormalTok{ pd.Series(data}\OperatorTok{=}\NormalTok{np.arange(}\FloatTok{2.}\NormalTok{), index}\OperatorTok{=}\BuiltInTok{list}\NormalTok{(}\StringTok{\textquotesingle{}BC\textquotesingle{}}\NormalTok{))}

\NormalTok{ser}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
B   0.0000
C   1.0000
dtype: float64
\end{verbatim}

pandas aligns operations on row and column names

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df[}\StringTok{\textquotesingle{}g\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ ser}

\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllll@{}}
\toprule\noalign{}
& a & b & c & d & e & f & g \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
A & 0.4967 & -0.1383 & 0.6477 & 1.5230 & -0.2342 & 5 & NaN \\
B & -0.2341 & 1.5792 & 0.7674 & -0.4695 & 0.5426 & 5 & 0.0000 \\
C & -0.4634 & -0.4657 & 0.2420 & -1.9133 & -1.7249 & 5 & 1.0000 \\
\end{longtable}

\section{Practice}\label{practice-15}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tickers }\OperatorTok{=} \StringTok{\textquotesingle{}AAPL IBM MSFT GOOG\textquotesingle{}}
\NormalTok{prices }\OperatorTok{=}\NormalTok{ yf.download(tickers}\OperatorTok{=}\NormalTok{tickers)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  4 of 4 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    prices[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{] }\CommentTok{\# slice adj close column}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\CommentTok{\# drop last row with intra day prices, which are sometimes missing}
\NormalTok{    .pct\_change() }\CommentTok{\# calculate returns}
\NormalTok{    .dropna() }\CommentTok{\# drop leading rows with at least one missing value}
\NormalTok{)}

\NormalTok{returns}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& AAPL & GOOG & IBM & MSFT \\
Date & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2004-08-20 & 0.0029 & 0.0794 & 0.0042 & 0.0029 \\
2004-08-23 & 0.0091 & 0.0101 & -0.0070 & 0.0044 \\
2004-08-24 & 0.0280 & -0.0414 & 0.0007 & 0.0000 \\
2004-08-25 & 0.0344 & 0.0108 & 0.0042 & 0.0114 \\
2004-08-26 & 0.0487 & 0.0180 & -0.0045 & -0.0040 \\
... & ... & ... & ... & ... \\
2024-01-26 & -0.0090 & 0.0010 & -0.0158 & -0.0023 \\
2024-01-29 & -0.0036 & 0.0068 & -0.0015 & 0.0143 \\
2024-01-30 & -0.0192 & -0.0116 & 0.0039 & -0.0028 \\
2024-01-31 & -0.0194 & -0.0735 & -0.0224 & -0.0269 \\
2024-02-01 & 0.0133 & 0.0064 & 0.0176 & 0.0156 \\
\end{longtable}

\subsection{What are the mean daily returns for these four
stocks?}\label{what-are-the-mean-daily-returns-for-these-four-stocks-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.mean() }\CommentTok{\# default is axis=0, so we get the mean of each column}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.0014
GOOG   0.0010
IBM    0.0004
MSFT   0.0008
dtype: float64
\end{verbatim}

We if want an equally-weighted portfolio return? We could take the mean
of each \emph{row} with \texttt{.mean(axis=1)}. The mean is the same as
the sum of 0.25 times each of the 4 columns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.mean(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Date
2004-08-20    0.0224
2004-08-23    0.0041
2004-08-24   -0.0032
2004-08-25    0.0152
2004-08-26    0.0146
               ...  
2024-01-26   -0.0065
2024-01-29    0.0040
2024-01-30   -0.0074
2024-01-31   -0.0356
2024-02-01    0.0132
Length: 4896, dtype: float64
\end{verbatim}

\subsection{What are the standard deviations of daily returns for these
four
stocks?}\label{what-are-the-standard-deviations-of-daily-returns-for-these-four-stocks-3}

We can use the \texttt{.std()} method to find the \emph{sample} standard
deviation of each column.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.std()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.0206
GOOG   0.0194
IBM    0.0143
MSFT   0.0171
dtype: float64
\end{verbatim}

\subsection{\texorpdfstring{What are the \emph{annualized} means and
standard deviations of daily returns for these four
stocks?}{What are the annualized means and standard deviations of daily returns for these four stocks?}}\label{what-are-the-annualized-means-and-standard-deviations-of-daily-returns-for-these-four-stocks-3}

We annualize mean returns by multiplying by \(T\) (\(T=252\) for daily
returns, \(T=12\) for month returns, and so on). We annualize standard
deviations by multiplying by \(\sqrt(T)\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.mean().mul(}\DecValTok{252}\NormalTok{) }\CommentTok{\# whenever I can, I use the .mul() method, so I can keep chaining!}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.3625
GOOG   0.2552
IBM    0.0980
MSFT   0.2002
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.std().mul(np.sqrt(}\DecValTok{252}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.3276
GOOG   0.3074
IBM    0.2272
MSFT   0.2722
dtype: float64
\end{verbatim}

\subsection{\texorpdfstring{Plot \emph{annualized} means versus standard
deviations of daily returns for these four
stocks}{Plot annualized means versus standard deviations of daily returns for these four stocks}}\label{plot-annualized-means-versus-standard-deviations-of-daily-returns-for-these-four-stocks-3}

Use \texttt{plt.scatter()}, which expects arguments as \texttt{x}
(standard deviations) then \texttt{y} (means).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vols }\OperatorTok{=}\NormalTok{ returns.std().mul(np.sqrt(}\DecValTok{252}\NormalTok{) }\OperatorTok{*} \DecValTok{100}\NormalTok{)}
\NormalTok{means }\OperatorTok{=}\NormalTok{ returns.mean().mul(}\DecValTok{252} \OperatorTok{*} \DecValTok{100}\NormalTok{)}

\NormalTok{plt.scatter(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{vols,}
\NormalTok{    y}\OperatorTok{=}\NormalTok{means}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Annualized Volatility of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}

\CommentTok{\# plt.xlim((0, vols.max() + 5))}
\CommentTok{\# plt.ylim((0, means.max() + 5))}

\CommentTok{\# add tickers to each point}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ means.index: }\CommentTok{\# loop over ticker index}
\NormalTok{    plt.text( }\CommentTok{\# plots string s at coordinates x and y}
\NormalTok{        x}\OperatorTok{=}\NormalTok{vols[i], }\CommentTok{\# indexes volatility}
\NormalTok{        y}\OperatorTok{=}\NormalTok{means[i], }\CommentTok{\# indexes mean return}
\NormalTok{        s}\OperatorTok{=}\NormalTok{i }\CommentTok{\# ticker index}
\NormalTok{    )}

\NormalTok{plt.title(}\StringTok{\textquotesingle{}Returns versus Risk\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show() }\CommentTok{\# suppresses output of last function call}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_05_practice_05_files/figure-pdf/cell-18-output-1.png}

\subsection{Repeat the previous calculations and plot for the stocks in
the Dow-Jones Industrial Index
(DJIA)}\label{repeat-the-previous-calculations-and-plot-for-the-stocks-in-the-dow-jones-industrial-index-djia-3}

We can find the current DJIA stocks on
\href{https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average}{Wikipedia}.
We will need to download new data, into \texttt{tickers2},
\texttt{prices2}, and \texttt{returns2}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{url2 }\OperatorTok{=} \StringTok{\textquotesingle{}https://en.wikipedia.org/wiki/Dow\_Jones\_Industrial\_Average\textquotesingle{}}
\NormalTok{wiki2 }\OperatorTok{=}\NormalTok{ pd.read\_html(io}\OperatorTok{=}\NormalTok{url2)}
\NormalTok{tickers2 }\OperatorTok{=}\NormalTok{ wiki2[}\DecValTok{1}\NormalTok{][}\StringTok{\textquotesingle{}Symbol\textquotesingle{}}\NormalTok{].to\_list()}
\NormalTok{tickers2[:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['MMM', 'AXP', 'AMGN', 'AAPL', 'BA']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices2 }\OperatorTok{=}\NormalTok{ yf.download(tickers}\OperatorTok{=}\NormalTok{tickers2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  30 of 30 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns2 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    prices2[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{] }\CommentTok{\# slices the adj close group of columns from prices}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\CommentTok{\# drop last row (which is intraday during class) to avoid fill\_method warning}
\NormalTok{    .pct\_change() }\CommentTok{\# calculate percent in adj closes (row[n] {-} row[n{-}1]) / row[n{-}1]}
\NormalTok{    .dropna() }\CommentTok{\# drops rows with any missing values}
\NormalTok{)}

\NormalTok{returns2}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
& AAPL & AMGN & AXP & BA & CAT & CRM & CSCO & CVX & DIS & DOW & ... &
MRK & MSFT & NKE & PG & TRV & UNH & V & VZ & WBA & WMT \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2019-03-21 & 0.0368 & 0.0040 & 0.0095 & -0.0092 & 0.0079 & 0.0210 &
0.0128 & 0.0094 & -0.0121 & -0.0165 & ... & 0.0106 & 0.0230 & 0.0152 &
0.0076 & 0.0231 & 0.0061 & 0.0133 & 0.0108 & 0.0129 & 0.0043 \\
2019-03-22 & -0.0207 & -0.0270 & -0.0211 & -0.0283 & -0.0320 & -0.0326 &
-0.0222 & -0.0220 & -0.0040 & -0.0078 & ... & -0.0080 & -0.0264 &
-0.0661 & -0.0081 & 0.0039 & -0.0196 & -0.0175 & 0.0252 & -0.0187 &
-0.0079 \\
2019-03-25 & -0.0121 & -0.0006 & -0.0038 & 0.0229 & 0.0124 & -0.0038 &
-0.0002 & -0.0016 & -0.0041 & 0.0113 & ... & 0.0007 & 0.0052 & 0.0017 &
0.0030 & 0.0004 & -0.0009 & -0.0003 & 0.0054 & -0.0115 & -0.0011 \\
2019-03-26 & -0.0103 & 0.0090 & 0.0042 & -0.0002 & 0.0035 & -0.0092 &
0.0095 & 0.0101 & 0.0218 & -0.0061 & ... & 0.0069 & 0.0021 & 0.0128 &
0.0104 & 0.0002 & -0.0141 & 0.0148 & 0.0092 & 0.0037 & 0.0015 \\
2019-03-27 & 0.0090 & -0.0104 & -0.0047 & 0.0103 & -0.0049 & -0.0269 &
-0.0017 & -0.0108 & 0.0013 & 0.0256 & ... & -0.0076 & -0.0097 & -0.0035
& -0.0012 & 0.0101 & -0.0069 & -0.0070 & 0.0041 & 0.0050 & -0.0113 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2024-01-26 & -0.0090 & 0.0049 & 0.0710 & 0.0178 & -0.0045 & 0.0033 &
-0.0036 & 0.0038 & 0.0053 & -0.0160 & ... & 0.0057 & -0.0023 & 0.0196 &
0.0033 & -0.0004 & 0.0199 & -0.0171 & 0.0026 & -0.0113 & 0.0088 \\
2024-01-29 & -0.0036 & 0.0054 & -0.0028 & -0.0014 & 0.0128 & 0.0283 &
0.0029 & -0.0004 & 0.0223 & 0.0002 & ... & 0.0038 & 0.0143 & 0.0110 &
0.0001 & -0.0015 & 0.0027 & 0.0213 & -0.0083 & -0.0057 & 0.0047 \\
2024-01-30 & -0.0192 & 0.0037 & 0.0164 & -0.0231 & 0.0050 & -0.0005 &
-0.0010 & 0.0070 & -0.0056 & 0.0074 & ... & 0.0031 & -0.0028 & 0.0029 &
0.0085 & 0.0115 & -0.0018 & 0.0128 & 0.0100 & 0.0018 & 0.0033 \\
2024-01-31 & -0.0194 & -0.0011 & -0.0167 & 0.0529 & -0.0146 & -0.0231 &
-0.0394 & -0.0179 & -0.0092 & -0.0160 & ... & -0.0072 & -0.0269 &
-0.0254 & -0.0022 & -0.0102 & 0.0161 & -0.0140 & -0.0028 & -0.0083 &
-0.0021 \\
2024-02-01 & 0.0133 & 0.0328 & 0.0124 & -0.0058 & 0.0246 & 0.0096 &
0.0000 & 0.0031 & 0.0105 & -0.0011 & ... & 0.0464 & 0.0156 & 0.0023 &
0.0130 & 0.0031 & -0.0090 & 0.0139 & 0.0033 & 0.0301 & 0.0185 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vols }\OperatorTok{=}\NormalTok{ returns2.std().mul(np.sqrt(}\DecValTok{252}\NormalTok{) }\OperatorTok{*} \DecValTok{100}\NormalTok{)}
\NormalTok{means }\OperatorTok{=}\NormalTok{ returns2.mean().mul(}\DecValTok{252} \OperatorTok{*} \DecValTok{100}\NormalTok{)}

\NormalTok{plt.scatter(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{vols,}
\NormalTok{    y}\OperatorTok{=}\NormalTok{means}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Annualized Volatility of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}

\CommentTok{\# plt.xlim((0, vols.max() + 5))}
\CommentTok{\# plt.ylim((0, means.max() + 5))}

\CommentTok{\# add tickers to each point}
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ means.index: }\CommentTok{\# loop over ticker index}
\NormalTok{    plt.text( }\CommentTok{\# plots string s at coordinates x and y}
\NormalTok{        x}\OperatorTok{=}\NormalTok{vols[i], }\CommentTok{\# indexes volatility}
\NormalTok{        y}\OperatorTok{=}\NormalTok{means[i], }\CommentTok{\# indexes mean return}
\NormalTok{        s}\OperatorTok{=}\NormalTok{i }\CommentTok{\# ticker index}
\NormalTok{    )}

\NormalTok{plt.title(}\StringTok{\textquotesingle{}Returns versus Risk\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show() }\CommentTok{\# suppresses output of last function call}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_05_practice_05_files/figure-pdf/cell-22-output-1.png}

With 30 stocks we see there is no relation between returns and
volatility because most volatility is \emph{diversifiable} and
uncompensated.

\subsection{Calculate total returns for the stocks in the
DJIA}\label{calculate-total-returns-for-the-stocks-in-the-djia-3}

We can use the \texttt{.prod()} method to compound returns as
\(1 + R_T = \prod_{t=1}^T (1 + R_t)\). Technically, we should write
\(R_T\) as \(R_{0,T}\), but we typically omit the subscript \(0\).

In general, I prefer to do simple math on pandas objects (data frames
and series) with methods instead of operators:

For example:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \texttt{.add(1)} instead of \texttt{+\ 1}
\item
  \texttt{.sub(1)} instead of \texttt{-\ 1}
\item
  \texttt{.div(1)} instead of \texttt{/\ 1}
\item
  \texttt{.mul(1)} instead of \texttt{*\ 1}
\end{enumerate}

The advantage of methods over operators, is that we can easily chain
methods without lots of parentheses.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2 }\OperatorTok{=}\NormalTok{ returns2.add(}\DecValTok{1}\NormalTok{).prod().sub(}\DecValTok{1}\NormalTok{)}

\NormalTok{total\_returns2.iloc[:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL    3.1210
AMGN    0.9635
AXP     0.9687
BA     -0.4289
CAT     1.6083
dtype: float64
\end{verbatim}

\subsection{Plot the distribution of total returns for the stocks in the
DJIA}\label{plot-the-distribution-of-total-returns-for-the-stocks-in-the-djia-3}

We can plot a histogram, using either the \texttt{plt.hist()} function
or the \texttt{.plot(kind=\textquotesingle{}hist\textquotesingle{})}
method.

A histogram is a great way to visualize data!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{min}\NormalTok{()}
\NormalTok{stop\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{max}\NormalTok{()}

\NormalTok{(}
\NormalTok{    returns2}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .prod()}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}hist\textquotesingle{}}\NormalTok{, bins}\OperatorTok{=}\DecValTok{20}\NormalTok{) }\CommentTok{\# grids=True to add grid lines}
\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Total Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Distribution of Total Returns for DJIA Stocks}\CharTok{\textbackslash{}n}\SpecialStringTok{ from }\SpecialCharTok{\{}\NormalTok{start\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{stop\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_05_practice_05_files/figure-pdf/cell-24-output-1.png}

With only 30 stocks, we can actually connect a stock to its return in a
plot!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{min}\NormalTok{()}
\NormalTok{stop\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{max}\NormalTok{()}

\NormalTok{(}
\NormalTok{    returns2}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .prod()}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .sort\_values() }\CommentTok{\# sort by total returns}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}barh\textquotesingle{}}\NormalTok{) }\CommentTok{\# horizontal bar chart}
\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Total Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Distribution of Total Returns for DJIA Stocks}\CharTok{\textbackslash{}n}\SpecialStringTok{ from }\SpecialCharTok{\{}\NormalTok{start\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{stop\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_05_practice_05_files/figure-pdf/cell-25-output-1.png}

\subsection{Which stocks have the minimum and maximum total
returns?}\label{which-stocks-have-the-minimum-and-maximum-total-returns-3}

If we want the \emph{values}, the \texttt{.min()} and \texttt{.max()}
methods are the way to go!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.}\BuiltInTok{min}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-0.5384
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.}\BuiltInTok{max}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
3.1210
\end{verbatim}

The \texttt{.min()} and \texttt{.max()} methods give the values but not
the tickers (or index). We use the \texttt{.idxmin()} and
\texttt{.idxmax()} to get the tickers (or index).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.idxmin()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'WBA'
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.idxmax()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
'AAPL'
\end{verbatim}

Here is what I would use!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.sort\_values().iloc[[}\DecValTok{0}\NormalTok{, }\OperatorTok{{-}}\DecValTok{1}\NormalTok{]]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
WBA    -0.5384
AAPL    3.1210
dtype: float64
\end{verbatim}

Not the exactly right tool here, but the
\texttt{.nsmallest()\textquotesingle{}\ and}.nlargest()` methods are
really useful!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.nsmallest(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
WBA   -0.5384
MMM   -0.4408
BA    -0.4289
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.nlargest(}\DecValTok{3}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   3.1210
MSFT   2.6028
CAT    1.6083
dtype: float64
\end{verbatim}

\subsection{Plot the cumulative returns for the stocks in the
DJIA}\label{plot-the-cumulative-returns-for-the-stocks-in-the-djia-3}

We can use the cumulative product method \texttt{.cumprod()} to
calculate the right hand side of the formula above.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{min}\NormalTok{()}
\NormalTok{stop\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{max}\NormalTok{()}

\NormalTok{(}
\NormalTok{    returns2}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .plot(legend}\OperatorTok{=}\VariableTok{False}\NormalTok{) }\CommentTok{\# with 30 stocks, this legend is too big to be useful}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Cumulative Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Cumulative Returns for DJIA Stocks}\CharTok{\textbackslash{}n}\SpecialStringTok{ from }\SpecialCharTok{\{}\NormalTok{start\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{stop\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_05_practice_05_files/figure-pdf/cell-33-output-1.png}

\subsection{Repeat the plot above with only the minimum and maximum
total
returns}\label{repeat-the-plot-above-with-only-the-minimum-and-maximum-total-returns-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{total\_returns2.sort\_values().iloc[[}\DecValTok{0}\NormalTok{, }\OperatorTok{{-}}\DecValTok{1}\NormalTok{]].index}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Index(['WBA', 'AAPL'], dtype='object')
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns2[total\_returns2.sort\_values().iloc[[}\DecValTok{0}\NormalTok{, }\OperatorTok{{-}}\DecValTok{1}\NormalTok{]].index]}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lll@{}}
\toprule\noalign{}
& WBA & AAPL \\
Date & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2019-03-21 & 0.0129 & 0.0368 \\
2019-03-22 & -0.0187 & -0.0207 \\
2019-03-25 & -0.0115 & -0.0121 \\
2019-03-26 & 0.0037 & -0.0103 \\
2019-03-27 & 0.0050 & 0.0090 \\
... & ... & ... \\
2024-01-26 & -0.0113 & -0.0090 \\
2024-01-29 & -0.0057 & -0.0036 \\
2024-01-30 & 0.0018 & -0.0192 \\
2024-01-31 & -0.0083 & -0.0194 \\
2024-02-01 & 0.0301 & 0.0133 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{min}\NormalTok{()}
\NormalTok{stop\_date }\OperatorTok{=}\NormalTok{ returns2.index.}\BuiltInTok{max}\NormalTok{()}

\NormalTok{(}
\NormalTok{    returns2 }\CommentTok{\# all returns for all stocks}
\NormalTok{    [total\_returns2.sort\_values().iloc[[}\DecValTok{0}\NormalTok{, }\OperatorTok{{-}}\DecValTok{1}\NormalTok{]].index] }\CommentTok{\# slice min and max total return stocks}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .plot()}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Cumulative Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Cumulative Returns for DJIA Stocks}\CharTok{\textbackslash{}n}\SpecialStringTok{ from }\SpecialCharTok{\{}\NormalTok{start\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{stop\_date}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_05_practice_05_files/figure-pdf/cell-36-output-1.png}

\part{Week 5}

\chapter{Herron Topic 1 - Web Data, Log and Simple Returns, and
Portfolio
Math}\label{herron-topic-1---web-data-log-and-simple-returns-and-portfolio-math}

This notebook covers three topics:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  How to download web data with the yfinance and pandas-datareader
  packages
\item
  How to calculate log and simple returns
\item
  How to calculate portfolio returns
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\section{Web Data}\label{web-data}

We will typically use the yfinance and pandas-datarader packages to
download data from the web. If you followed my instructions to install
Miniconda on your computer, you have already installed these packages.

\subsection{The yfinance Package}\label{the-yfinance-package}

The \href{https://github.com/ranaroussi/yfinance}{yfinance package}
provides ``a reliable, threaded, and Pythonic way to download historical
market data from Yahoo! finance.'' Other packages provide similar
functionality, but yfinance is best.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

We can download data for the MATANA stocks (Microsoft, Alphabet, Tesla,
Amazon, Nvidia, and Apple). We can pass tickers as either a
space-delimited string or a list of strings.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\OperatorTok{=}\NormalTok{ yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}MSFT GOOG TSLA AMZN NVDA AAPL\textquotesingle{}}\NormalTok{)}
\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  6 of 6 completed
\end{verbatim}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
& \multicolumn{6}{l}{%
Adj Close} & \multicolumn{4}{l}{%
Close} & ... & \multicolumn{4}{l}{%
Open} & \multicolumn{6}{l@{}}{%
Volume} \\
& AAPL & AMZN & GOOG & MSFT & NVDA & TSLA & AAPL & AMZN & GOOG & MSFT &
... & GOOG & MSFT & NVDA & TSLA & AAPL & AMZN & GOOG & MSFT & NVDA &
TSLA \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1980-12-12 & 0.0993 & NaN & NaN & NaN & NaN & NaN & 0.1283 & NaN & NaN &
NaN & ... & NaN & NaN & NaN & NaN & 469033600 & NaN & NaN & NaN & NaN &
NaN \\
1980-12-15 & 0.0941 & NaN & NaN & NaN & NaN & NaN & 0.1217 & NaN & NaN &
NaN & ... & NaN & NaN & NaN & NaN & 175884800 & NaN & NaN & NaN & NaN &
NaN \\
1980-12-16 & 0.0872 & NaN & NaN & NaN & NaN & NaN & 0.1127 & NaN & NaN &
NaN & ... & NaN & NaN & NaN & NaN & 105728000 & NaN & NaN & NaN & NaN &
NaN \\
1980-12-17 & 0.0894 & NaN & NaN & NaN & NaN & NaN & 0.1155 & NaN & NaN &
NaN & ... & NaN & NaN & NaN & NaN & 86441600 & NaN & NaN & NaN & NaN &
NaN \\
1980-12-18 & 0.0920 & NaN & NaN & NaN & NaN & NaN & 0.1189 & NaN & NaN &
NaN & ... & NaN & NaN & NaN & NaN & 73449600 & NaN & NaN & NaN & NaN &
NaN \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2024-01-26 & 192.4200 & 159.1200 & 153.7900 & 403.9300 & 610.3100 &
183.2500 & 192.4200 & 159.1200 & 153.7900 & 403.9300 & ... & 152.8700 &
404.3700 & 609.6000 & 185.5000 & 44553400 & 51001100.0000 &
19483600.0000 & 17786700.0000 & 38983800.0000 & 107063400.0000 \\
2024-01-29 & 191.7300 & 161.2600 & 154.8400 & 409.7200 & 624.6500 &
190.9300 & 191.7300 & 161.2600 & 154.8400 & 409.7200 & ... & 153.6400 &
406.0600 & 612.3200 & 185.6300 & 47145600 & 45270400.0000 &
20909300.0000 & 24510200.0000 & 34873300.0000 & 125013100.0000 \\
2024-01-30 & 188.0400 & 159.0000 & 153.0500 & 408.5900 & 627.7400 &
191.5900 & 188.0400 & 159.0000 & 153.0500 & 408.5900 & ... & 154.0100 &
412.2600 & 629.0000 & 195.3300 & 55859400 & 45207400.0000 &
26578900.0000 & 33477600.0000 & 41073500.0000 & 109982300.0000 \\
2024-01-31 & 184.4000 & 155.2000 & 141.8000 & 397.5800 & 615.2700 &
187.2900 & 184.4000 & 155.2000 & 141.8000 & 397.5800 & ... & 145.3900 &
406.9600 & 614.4000 & 187.0000 & 55467800 & 50284400.0000 &
43908600.0000 & 47871100.0000 & 45379500.0000 & 103221400.0000 \\
2024-02-01 & 186.8600 & 159.2800 & 142.7100 & 403.7800 & 630.2700 &
188.8600 & 186.8600 & 159.2800 & 142.7100 & 403.7800 & ... & 143.6900 &
401.8300 & 621.0000 & 188.5000 & 52672619 & 63406285.0000 &
24997783.0000 & 29155588.0000 & 35818376.0000 & 90546003.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    df}
\NormalTok{    [}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .pct\_change()}
\NormalTok{    .loc[}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{]}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .plot()}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Year{-}to{-}Date Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Year{-}to{-}Date Returns for MATANA Stocks in 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_01_lecture_files/figure-pdf/cell-6-output-1.png}

\subsection{The pandas-datareader
package}\label{the-pandas-datareader-package}

The
\href{https://pandas-datareader.readthedocs.io/en/latest/index.html}{pandas-datareader}
package provides easy access to various data sources, including
\href{https://mba.tuck.dartmouth.edu/pages/faculty/ken.french/data_library.html}{the
Kenneth French Data Library} and \href{https://fred.stlouisfed.org/}{the
Federal Reserve Economic Data (FRED)}. The pandas-datareader package
also downloads Yahoo! Finance data, but the yfinance package has better
documentation. We will use \texttt{pdr} as the abbreviated prefix for
pandas-datareader.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\end{Highlighting}
\end{Shaded}

Here we download the daily benchmark factors from Ken French's Data
Library.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pdr.famafrench.get\_available\_datasets()[:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['F-F_Research_Data_Factors',
 'F-F_Research_Data_Factors_weekly',
 'F-F_Research_Data_Factors_daily',
 'F-F_Research_Data_5_Factors_2x3',
 'F-F_Research_Data_5_Factors_2x3_daily']
\end{verbatim}

For Fama and French data, pandas-datareader returns the most recent five
years of data unless we specify a \texttt{start} date. French typically
provides data back through the second half of 1926. pandas-datareader
returns dictionaries of data frames, and the
\texttt{\textquotesingle{}DESCR\textquotesingle{}} value describes these
data frames.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_all }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_26796\2526882917.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_all = pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{type}\NormalTok{(ff\_all)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
dict
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(ff\_all[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
F-F Research Data Factors daily
-------------------------------

This file was created by CMPT_ME_BEME_RETS_DAILY using the 202312 CRSP database. The Tbill return is the simple daily rate that, over the number of trading days in the month, compounds to 1-month TBill rate from Ibbotson and Associates Inc. Copyright 2023 Kenneth R. French

  0 : (25649 rows x 4 cols)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_all[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& Mkt-RF & SMB & HML & RF \\
Date & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1926-07-01 & 0.1000 & -0.2500 & -0.2700 & 0.0090 \\
1926-07-02 & 0.4500 & -0.3300 & -0.0600 & 0.0090 \\
1926-07-06 & 0.1700 & 0.3000 & -0.3900 & 0.0090 \\
1926-07-07 & 0.0900 & -0.5800 & 0.0200 & 0.0090 \\
1926-07-08 & 0.2100 & -0.3800 & 0.1900 & 0.0090 \\
... & ... & ... & ... & ... \\
2023-12-22 & 0.2100 & 0.6400 & 0.0900 & 0.0210 \\
2023-12-26 & 0.4800 & 0.6900 & 0.4600 & 0.0210 \\
2023-12-27 & 0.1600 & 0.1400 & 0.1200 & 0.0210 \\
2023-12-28 & -0.0100 & -0.3600 & 0.0300 & 0.0210 \\
2023-12-29 & -0.4300 & -1.1200 & -0.3700 & 0.0210 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    ff\_all[}\DecValTok{0}\NormalTok{] }\CommentTok{\# slice factors}
\NormalTok{    .div(}\DecValTok{100}\NormalTok{) }\CommentTok{\# convert to decimal}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{) }\CommentTok{\# calculate cumulative returns}
\NormalTok{    .cumprod()}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{) }\CommentTok{\# convert to percent}
\NormalTok{    .plot() }\CommentTok{\# plot}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Cumulative Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Cumulative Returns for the Daily Benchmark Factors\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.gca().yaxis.set\_major\_formatter(plt.matplotlib.ticker.StrMethodFormatter(}\StringTok{\textquotesingle{}}\SpecialCharTok{\{x:,.0f\}}\StringTok{\textquotesingle{}}\NormalTok{))}
\CommentTok{\# plt.yscale(\textquotesingle{}log\textquotesingle{}) \# log scale impractical here with negative returns}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_01_lecture_files/figure-pdf/cell-13-output-1.png}

\section{Log and Simple Returns}\label{log-and-simple-returns}

We will typically use \emph{simple} returns, calculated as
\(R_{simple,t} = \frac{P_t + D_t - P_{t-1}}{P_{t-1}} = \frac{P_t + D_t}{P_{t-1}} - 1\).
The simple return is the return that investors receive on invested
dollars. We can calculate simple returns from Yahoo Finance data with
the \texttt{.pct\_change()} method on the adjusted close column (i.e.,
\texttt{Adj\ Close}), which adjusts for dividends and splits. The
adjusted close column is a reverse-engineered close price (i.e.,
end-of-trading-day price) that incorporates dividends and splits, making
simple return calculations easy.

However, we may see \emph{log} returns elsewhere, which are the
(natural) log of one plus simple returns:
\[R_{log,t} = \log(1 + R_{simple,t}) = \log\left(1 +  \frac{P_t + D_t}{P_{t-1}} - 1 \right) = \log\left(\frac{P_t + D_t}{P_{t-1}} \right) = \log(P_t + D_t) - \log(P_{t-1})\]
Therefore, we calculate log returns as either the log of one plus simple
returns or the difference of the logs of the adjusted close column. Log
returns are also known as \emph{continuously-compounded} returns.

We will typically use \emph{simple} returns instead of \emph{log}
returns. However, this section explains the differences between simple
and log returns and where each is appropriate.

\subsection{Simple and Log Returns are Similar for Small
Returns}\label{simple-and-log-returns-are-similar-for-small-returns}

\(\log(1 + x) \approx x\) for small values of \(x\), so simple returns
and log returns are similar for small returns. Returns are typically
small at daily and monthly horizons, so the difference between simple
and log returns is small at these horizons. The following figure shows
\(R_{simple,t} \approx R_{log,t}\) for small \(R\)s.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{R }\OperatorTok{=}\NormalTok{ np.linspace(}\OperatorTok{{-}}\FloatTok{0.75}\NormalTok{, }\FloatTok{0.75}\NormalTok{, }\DecValTok{100}\NormalTok{)}
\NormalTok{logR }\OperatorTok{=}\NormalTok{ np.log(}\DecValTok{1} \OperatorTok{+}\NormalTok{ R)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.plot(R, logR)}
\NormalTok{plt.plot([}\OperatorTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{], [}\OperatorTok{{-}}\DecValTok{1}\NormalTok{, }\DecValTok{1}\NormalTok{])}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Simple Return\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Log Return\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Log Versus Simple Returns\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.legend([}\StringTok{\textquotesingle{}Actual\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}If Log = Simple\textquotesingle{}}\NormalTok{])}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_01_lecture_files/figure-pdf/cell-15-output-1.png}

\subsection{Simple Return Advantage: Portfolio
Calculations}\label{simple-return-advantage-portfolio-calculations}

We can only perform portfolio calculations with simple returns. For a
portfolio of \(N\) assets with portfolio weights \(w_i\), the portfolio
return \(R_{p}\) is the weighted average of the returns of its assets,
\(R_{p} = \sum_{i=1}^N w_i R_{i}\). For two stocks with portfolio
weights of 50\%, our portfolio return is
\(R_{portfolio} = 0.5 R_1 + 0.5 R_2 = \frac{R_1 + R_2}{2}\). However, we
cannot calculate portfolio returns with log returns because the sum of
logs is the log of products.

\textbf{\emph{We cannot calculate portfolio returns as the weighted
average of log returns.}}

\subsection{Log Return Advantage: Log Returns are
Additive}\label{log-return-advantage-log-returns-are-additive}

The advantage of log returns is that we can compound log returns with
addition. The additive property of log returns makes code simple,
computations fast, and proofs easy when we compound returns over
multiple periods.

We compound returns from \(t=0\) to \(t=T\) as follows:
\[1 + R_{0, T} = (1 + R_1) \times (1 + R_2) \times \dots \times (1 + R_T)\]

Next, we take the log of both sides of the previous equation and use the
property that the log of products is the sum of logs:
\[\log(1 + R_{0, T}) = \log((1 + R_1) \times (1 + R_2) \times \dots \times (1 + R_T)) = \log(1 + R_1) + \log(1 + R_2) + \dots + \log(1 + R_T) = \sum_{t=1}^T \log(1 + R_t)\]

Next, we exponentiate both sides of the previous equation:
\[e^{\log(1 + R_{0, T})} = e^{\sum_{t=0}^T \log(1 + R_t)}\]

Next, we use the property that \(e^{\log(x)} = x\) to simplify the
previous equation: \[1 + R_{0,T} = e^{\sum_{t=0}^T \log(1 + R_t)}\]

Finally, we subtract 1 from both sides:
\[R_{0 ,T} = e^{\sum_{t=0}^T \log(1 + R_t)} - 1\]

So, the return \(R_{0,T}\) from \(t=0\) to \(t=T\) is the exponentiated
sum of log returns. The pandas developers assume users understand the
math above and focus on optimizing sums.

The following code generates 10,000 random log returns. The
\texttt{np.random.randn()} call generates normally distributed random
numbers. To generate equivalent simple returns, we exponentiate these
log returns, then subtract one.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{df2 }\OperatorTok{=}\NormalTok{ pd.DataFrame(data}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}R\textquotesingle{}}\NormalTok{: np.exp(np.random.randn(}\DecValTok{10000}\NormalTok{)) }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\})}
\NormalTok{df2}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}ll@{}}
\toprule\noalign{}
& R \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & 0.6433 \\
1 & -0.1291 \\
2 & 0.9111 \\
3 & 3.5861 \\
4 & -0.2088 \\
... & ... \\
9995 & 2.6733 \\
9996 & -0.8644 \\
9997 & -0.5060 \\
9998 & 0.6418 \\
9999 & 0.9048 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df2.describe()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}ll@{}}
\toprule\noalign{}
& R \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
count & 10000.0000 \\
mean & 0.6529 \\
std & 2.1918 \\
min & -0.9802 \\
25\% & -0.4896 \\
50\% & -0.0026 \\
75\% & 0.9564 \\
max & 49.7158 \\
\end{longtable}

We can time the calculation of 12-observation rolling returns. We use
\texttt{.apply()} for the simple return version because
\texttt{.rolling()} does not have a product method. We find that
\texttt{.rolling()} is slower with \texttt{.apply()} than with
\texttt{.sum()} by a factor of 2,000. \textbf{\emph{We will learn about
\texttt{.rolling()} and \texttt{.apply()} in a few weeks, but they
provide the best example of when to use log returns.}}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%\%}\NormalTok{timeit}
\NormalTok{df2[}\StringTok{\textquotesingle{}R12\_via\_simple\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    df2[}\StringTok{\textquotesingle{}R\textquotesingle{}}\NormalTok{]}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .rolling(}\DecValTok{12}\NormalTok{)}
\NormalTok{    .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: x.prod())}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
284 ms ± 80.7 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%\%}\NormalTok{timeit}
\NormalTok{df2[}\StringTok{\textquotesingle{}R12\_via\_log\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    df2[}\StringTok{\textquotesingle{}R\textquotesingle{}}\NormalTok{]}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .pipe(np.log)}
\NormalTok{    .rolling(}\DecValTok{12}\NormalTok{)}
\NormalTok{    .}\BuiltInTok{sum}\NormalTok{()}
\NormalTok{    .pipe(np.exp)}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
557 µs ± 60.6 µs per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df2.head(}\DecValTok{15}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& R & R12\_via\_simple & R12\_via\_log \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & 0.6433 & NaN & NaN \\
1 & -0.1291 & NaN & NaN \\
2 & 0.9111 & NaN & NaN \\
3 & 3.5861 & NaN & NaN \\
4 & -0.2088 & NaN & NaN \\
5 & -0.2087 & NaN & NaN \\
6 & 3.8511 & NaN & NaN \\
7 & 1.1542 & NaN & NaN \\
8 & -0.3747 & NaN & NaN \\
9 & 0.7204 & NaN & NaN \\
10 & -0.3709 & NaN & NaN \\
11 & -0.3723 & 33.8643 & 33.8643 \\
12 & 0.2737 & 26.0236 & 26.0236 \\
13 & -0.8524 & 3.5800 & 3.5800 \\
14 & -0.8218 & -0.5730 & -0.5730 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(df2[}\StringTok{\textquotesingle{}R12\_via\_simple\textquotesingle{}}\NormalTok{], df2[}\StringTok{\textquotesingle{}R12\_via\_log\textquotesingle{}}\NormalTok{], equal\_nan}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

These two approaches calculate the same return, but the simple-return
approach is 1,000 times slower than the log-return approach!

\textbf{\emph{We can use log returns to calculate total returns very
quickly!}}

\section{Portfolio Math}\label{portfolio-math}

Portfolio return \(R_{p}\) is the weighted average of its asset returns,
so \(R_{p} = \sum_{i=1}^N w_i R_{i}\). Here \(N\) is the number of
assets, and \(w_i\) is the weight on asset \(i\).

\subsection{The 1/N Portfolio}\label{the-1n-portfolio}

The \(\frac{1}{N}\) portfolio equally weights portfolio assets, so
\(w_1 = w_2 = \dots = w_N = \frac{1}{N}\). We typically rebalance the
\(\frac{1}{N}\) portfolio every period. If \(w_i = \frac{1}{N}\), then
\(R_{p} = \sum_{i=1}^N \frac{1}{N} R_{i} = \frac{\sum_{i=1}^N R_i}{N} = \bar{R}\).
Therefore, we can use \texttt{.mean()} to calculate \(\frac{1}{N}\)
portfolio returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns }\OperatorTok{=}\NormalTok{ df[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].pct\_change().loc[}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{]}

\NormalTok{returns}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& AAPL & AMZN & GOOG & MSFT & NVDA & TSLA \\
Date & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2023-01-03 & -0.0374 & 0.0217 & 0.0109 & -0.0010 & -0.0205 & -0.1224 \\
2023-01-04 & 0.0103 & -0.0079 & -0.0110 & -0.0437 & 0.0303 & 0.0512 \\
2023-01-05 & -0.0106 & -0.0237 & -0.0219 & -0.0296 & -0.0328 &
-0.0290 \\
2023-01-06 & 0.0368 & 0.0356 & 0.0160 & 0.0118 & 0.0416 & 0.0247 \\
2023-01-09 & 0.0041 & 0.0149 & 0.0073 & 0.0097 & 0.0518 & 0.0593 \\
... & ... & ... & ... & ... & ... & ... \\
2023-12-22 & -0.0055 & -0.0027 & 0.0065 & 0.0028 & -0.0033 & -0.0077 \\
2023-12-26 & -0.0028 & -0.0001 & 0.0007 & 0.0002 & 0.0092 & 0.0161 \\
2023-12-27 & 0.0005 & -0.0005 & -0.0097 & -0.0016 & 0.0028 & 0.0188 \\
2023-12-28 & 0.0022 & 0.0003 & -0.0011 & 0.0032 & 0.0021 & -0.0316 \\
2023-12-29 & -0.0054 & -0.0094 & -0.0025 & 0.0020 & 0.0000 & -0.0186 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.mean()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.0017
AMZN   0.0026
GOOG   0.0020
MSFT   0.0020
NVDA   0.0053
TSLA   0.0034
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rp\_1 }\OperatorTok{=}\NormalTok{ returns.mean(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\NormalTok{rp\_1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Date
2023-01-03   -0.0248
2023-01-04    0.0049
2023-01-05   -0.0246
2023-01-06    0.0278
2023-01-09    0.0245
               ...  
2023-12-22   -0.0017
2023-12-26    0.0039
2023-12-27    0.0017
2023-12-28   -0.0041
2023-12-29   -0.0056
Length: 250, dtype: float64
\end{verbatim}

\textbf{\emph{Note that when we apply the same portfolio weights every
period, we rebalance at the same frequency as the returns data.}} If we
have daily data, rebalance daily. If we have monthly data, we rebalance
monthly, and so on.

\subsection{A More General Solution}\label{a-more-general-solution}

If we combine weights into vector \(w\) and the time series of asset
returns into matrix \(\mathbf{R}\), then we can calculate the time
series of portfolio returns as \(R_p = w^T \mathbf{R}\). The pandas
version of this calculation is \texttt{R.dot(w)}, where \texttt{R} is a
data frame of asset returns and \texttt{w} is a series of portfolio
weights. We can use this approach to calculate \(\frac{1}{N}\) portfolio
returns, too.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weights }\OperatorTok{=}\NormalTok{ np.ones(returns.shape[}\DecValTok{1}\NormalTok{]) }\OperatorTok{/}\NormalTok{ returns.shape[}\DecValTok{1}\NormalTok{]}
\NormalTok{weights}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0.1667, 0.1667, 0.1667, 0.1667, 0.1667, 0.1667])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rp\_2 }\OperatorTok{=}\NormalTok{ returns.dot(weights)}
\NormalTok{rp\_2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Date
2023-01-03   -0.0248
2023-01-04    0.0049
2023-01-05   -0.0246
2023-01-06    0.0278
2023-01-09    0.0245
               ...  
2023-12-22   -0.0017
2023-12-26    0.0039
2023-12-27    0.0017
2023-12-28   -0.0041
2023-12-29   -0.0056
Length: 250, dtype: float64
\end{verbatim}

Both approaches give the same answer!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(rp\_1, rp\_2, equal\_nan}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\chapter{Herron Topic 1 - Practice for Section
02}\label{herron-topic-1---practice-for-section-02}

\section{Announcements}\label{announcements-16}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  DataCamp

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    \emph{Data Manipulation with pandas} due by Friday, 2/9, at 11:59 PM
  \item
    \emph{Joining Data with pandas} due by Friday, 2/16, at 11:59 PM
  \item
    \emph{Earn 10,000 XP} due by Friday, 3/15, at 11:59 PM
  \end{enumerate}
\item
  I posted Project 1 to Canvas

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Slides and notebook due by Friday, 2/23, at 11:59 PM
  \item
    Keep joining teams and let me know if you need help
  \end{enumerate}
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-15}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

First, we will use two packages to download data from the web:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \texttt{yfinance} for Yahoo! Finance data
\item
  \texttt{pandas-datareader} for Ken French data (and FRED data)
\end{enumerate}

Second, there are ``simple returns'' and ``log returns''

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Simple returns are the returns that investors receive that we learned
  in FINA 6331 and FINA 6333:
  \(r_t = \frac{p_t + d_t - p_{t-1}}{p_{t-1}}\)
\item
  Log returns are the log of one plus simple returns. Why do we use
  them?

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    \textbf{\emph{Log returns are additive}}, while simple returns are
    multiplicative. This additive property makes math really easy with
    log returns:
    \(\log(\prod_{t=0}^T (1 + r_t)) = \sum_{t=0}^T \log(1+r_t)\), so
    \(r_{0,T} = \prod_{t=0}^T (1 + r_t) - 1 = e^{\sum_{t=0}^T \log(1+r_t)} - 1\)
  \item
    \textbf{\emph{Log returns are almost normally distributed}}
  \end{enumerate}
\end{enumerate}

\textbf{\emph{We will almost always use simple returns.}} The exeception
is time-consuming calculations, which we will often do in log returns to
save us time.

Third, we can calculate portfolio returns a few ways

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  We can calculate equally-weighted returns with
  \texttt{returns.mean(axis=1)}, \textbf{\emph{rebalanced at the same
  frequency as returns}}
\item
  We can calculate any-weighted with \texttt{returns.dot(weights)},
  where \texttt{weights} is an array of portfolio weights that are not
  necessarily equally-weighted, still \textbf{\emph{rebalanced at the
  same frequency as returns}}
\end{enumerate}

\section{Practice}\label{practice-16}

\subsection{\texorpdfstring{Download all available daily price data for
tickers TSLA, F, AAPL, AMZN, and META to data frame
\texttt{prices}}{Download all available daily price data for tickers TSLA, F, AAPL, AMZN, and META to data frame prices}}\label{download-all-available-daily-price-data-for-tickers-tsla-f-aapl-amzn-and-meta-to-data-frame-prices}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tickers }\OperatorTok{=} \StringTok{\textquotesingle{}TSLA F AAPL AMZN META\textquotesingle{}}
\CommentTok{\# tickers = [\textquotesingle{}TSLA\textquotesingle{}, \textquotesingle{}F\textquotesingle{},  \textquotesingle{}AAPL\textquotesingle{}, \textquotesingle{}AMZN\textquotesingle{}, \textquotesingle{}META\textquotesingle{}]}
\NormalTok{prices }\OperatorTok{=}\NormalTok{ yf.download(tickers}\OperatorTok{=}\NormalTok{tickers)}

\NormalTok{prices}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  5 of 5 completed
\end{verbatim}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
& \multicolumn{5}{l}{%
Adj Close} & \multicolumn{5}{l}{%
Close} & ... & \multicolumn{5}{l}{%
Open} & \multicolumn{5}{l@{}}{%
Volume} \\
& AAPL & AMZN & F & META & TSLA & AAPL & AMZN & F & META & TSLA & ... &
AAPL & AMZN & F & META & TSLA & AAPL & AMZN & F & META & TSLA \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1972-06-01 & NaN & NaN & 0.2419 & NaN & NaN & NaN & NaN & 2.1532 & NaN &
NaN & ... & NaN & NaN & 0.0000 & NaN & NaN & NaN & NaN & 1091238 & NaN &
NaN \\
1972-06-02 & NaN & NaN & 0.2414 & NaN & NaN & NaN & NaN & 2.1492 & NaN &
NaN & ... & NaN & NaN & 2.1532 & NaN & NaN & NaN & NaN & 1174468 & NaN &
NaN \\
1972-06-05 & NaN & NaN & 0.2414 & NaN & NaN & NaN & NaN & 2.1492 & NaN &
NaN & ... & NaN & NaN & 2.1492 & NaN & NaN & NaN & NaN & 5209582 & NaN &
NaN \\
1972-06-06 & NaN & NaN & 0.2387 & NaN & NaN & NaN & NaN & 2.1248 & NaN &
NaN & ... & NaN & NaN & 2.1492 & NaN & NaN & NaN & NaN & 1424158 & NaN &
NaN \\
1972-06-07 & NaN & NaN & 0.2373 & NaN & NaN & NaN & NaN & 2.1127 & NaN &
NaN & ... & NaN & NaN & 2.1248 & NaN & NaN & NaN & NaN & 675088 & NaN &
NaN \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2024-02-05 & 187.6800 & 170.3100 & 11.5900 & 459.4100 & 181.0600 &
187.6800 & 170.3100 & 11.5900 & 459.4100 & 181.0600 & ... & 188.1500 &
170.2000 & 12.0100 & 469.8800 & 184.2600 & 69668800.0000 & 55081300.0000
& 81026800 & 40832400.0000 & 134294400.0000 \\
2024-02-06 & 189.3000 & 169.1500 & 12.0700 & 454.7200 & 185.1000 &
189.3000 & 169.1500 & 12.0700 & 454.7200 & 185.1000 & ... & 186.8600 &
169.3900 & 11.6400 & 464.0000 & 177.2100 & 43490800.0000 & 42505500.0000
& 98636800 & 21655200.0000 & 122676000.0000 \\
2024-02-07 & 189.4100 & 170.5300 & 12.8000 & 469.5900 & 187.5800 &
189.4100 & 170.5300 & 12.8000 & 469.5900 & 187.5800 & ... & 190.6400 &
169.4800 & 12.7300 & 458.0000 & 188.1800 & 53439000.0000 & 47174100.0000
& 137224000 & 23066000.0000 & 111535200.0000 \\
2024-02-08 & 188.3200 & 169.8400 & 12.8300 & 470.0000 & 189.5600 &
188.3200 & 169.8400 & 12.8300 & 470.0000 & 189.5600 & ... & 189.3900 &
169.6500 & 12.8700 & 468.3200 & 189.0000 & 40962000.0000 & 42316500.0000
& 68653900 & 18815100.0000 & 83034000.0000 \\
2024-02-09 & 188.8500 & 174.4500 & 12.6800 & 468.1100 & 193.5700 &
188.8500 & 174.4500 & 12.6800 & 468.1100 & 193.5700 & ... & 188.6500 &
170.9000 & 12.8100 & 472.9500 & 190.1800 & 43728065.0000 & 56886544.0000
& 46925766 & 18159624.0000 & 84009121.0000 \\
\end{longtable}

\subsection{\texorpdfstring{Calculate all available daily returns and
save to data frame
\texttt{returns}}{Calculate all available daily returns and save to data frame returns}}\label{calculate-all-available-daily-returns-and-save-to-data-frame-returns}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    prices[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{] }\CommentTok{\# slice adj close}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\CommentTok{\# drop the last price because it might be intraday (i.e., not a close)}
\NormalTok{    .pct\_change() }\CommentTok{\# calculate simple returns}
\NormalTok{)}

\NormalTok{returns}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& AAPL & AMZN & F & META & TSLA \\
Date & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1972-06-01 & NaN & NaN & NaN & NaN & NaN \\
1972-06-02 & NaN & NaN & -0.0019 & NaN & NaN \\
1972-06-05 & NaN & NaN & 0.0000 & NaN & NaN \\
1972-06-06 & NaN & NaN & -0.0113 & NaN & NaN \\
1972-06-07 & NaN & NaN & -0.0057 & NaN & NaN \\
... & ... & ... & ... & ... & ... \\
2024-02-02 & -0.0054 & 0.0787 & 0.0033 & 0.2032 & -0.0050 \\
2024-02-05 & 0.0098 & -0.0087 & -0.0453 & -0.0328 & -0.0365 \\
2024-02-06 & 0.0086 & -0.0068 & 0.0414 & -0.0102 & 0.0223 \\
2024-02-07 & 0.0006 & 0.0082 & 0.0605 & 0.0327 & 0.0134 \\
2024-02-08 & -0.0058 & -0.0040 & 0.0023 & 0.0009 & 0.0106 \\
\end{longtable}

\subsection{\texorpdfstring{Slices returns for the 2020s and assign to
\texttt{returns\_2020s}}{Slices returns for the 2020s and assign to returns\_2020s}}\label{slices-returns-for-the-2020s-and-assign-to-returns_2020s}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s }\OperatorTok{=}\NormalTok{ returns.loc[}\StringTok{\textquotesingle{}2020\textquotesingle{}}\NormalTok{:] }\CommentTok{\# always use an unambiguos date format, like YYYY{-}MM{-}DD}

\NormalTok{returns\_2020s}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& AAPL & AMZN & F & META & TSLA \\
Date & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2020-01-02 & 0.0228 & 0.0272 & 0.0129 & 0.0221 & 0.0285 \\
2020-01-03 & -0.0097 & -0.0121 & -0.0223 & -0.0053 & 0.0296 \\
2020-01-06 & 0.0080 & 0.0149 & -0.0054 & 0.0188 & 0.0193 \\
2020-01-07 & -0.0047 & 0.0021 & 0.0098 & 0.0022 & 0.0388 \\
2020-01-08 & 0.0161 & -0.0078 & 0.0000 & 0.0101 & 0.0492 \\
... & ... & ... & ... & ... & ... \\
2024-02-02 & -0.0054 & 0.0787 & 0.0033 & 0.2032 & -0.0050 \\
2024-02-05 & 0.0098 & -0.0087 & -0.0453 & -0.0328 & -0.0365 \\
2024-02-06 & 0.0086 & -0.0068 & 0.0414 & -0.0102 & 0.0223 \\
2024-02-07 & 0.0006 & 0.0082 & 0.0605 & 0.0327 & 0.0134 \\
2024-02-08 & -0.0058 & -0.0040 & 0.0023 & 0.0009 & 0.0106 \\
\end{longtable}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

What if we want a more complicated slice? We can combine
\texttt{.loc{[}{]}} and Boolean conditions!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.loc[}
\NormalTok{    (returns.index.year }\OperatorTok{==} \DecValTok{2020}\NormalTok{) }\OperatorTok{\&}
\NormalTok{    ((returns.index.month }\OperatorTok{==} \DecValTok{1}\NormalTok{) }\OperatorTok{|}\NormalTok{ (returns.index.month }\OperatorTok{==} \DecValTok{12}\NormalTok{))}
\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& AAPL & AMZN & F & META & TSLA \\
Date & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2020-01-02 & 0.0228 & 0.0272 & 0.0129 & 0.0221 & 0.0285 \\
2020-01-03 & -0.0097 & -0.0121 & -0.0223 & -0.0053 & 0.0296 \\
2020-01-06 & 0.0080 & 0.0149 & -0.0054 & 0.0188 & 0.0193 \\
2020-01-07 & -0.0047 & 0.0021 & 0.0098 & 0.0022 & 0.0388 \\
2020-01-08 & 0.0161 & -0.0078 & 0.0000 & 0.0101 & 0.0492 \\
2020-01-09 & 0.0212 & 0.0048 & 0.0011 & 0.0143 & -0.0219 \\
2020-01-10 & 0.0023 & -0.0094 & -0.0011 & -0.0011 & -0.0066 \\
2020-01-13 & 0.0214 & 0.0043 & -0.0011 & 0.0177 & 0.0977 \\
2020-01-14 & -0.0135 & -0.0116 & 0.0054 & -0.0128 & 0.0249 \\
2020-01-15 & -0.0043 & -0.0040 & -0.0108 & 0.0095 & -0.0361 \\
2020-01-16 & 0.0125 & 0.0085 & -0.0022 & 0.0028 & -0.0097 \\
2020-01-17 & 0.0111 & -0.0070 & -0.0011 & 0.0017 & -0.0058 \\
2020-01-21 & -0.0068 & 0.0146 & 0.0055 & -0.0032 & 0.0719 \\
2020-01-22 & 0.0036 & -0.0024 & -0.0054 & -0.0005 & 0.0409 \\
2020-01-23 & 0.0048 & -0.0015 & -0.0022 & -0.0070 & 0.0046 \\
2020-01-24 & -0.0029 & -0.0122 & -0.0153 & -0.0083 & -0.0129 \\
2020-01-27 & -0.0294 & -0.0179 & -0.0122 & -0.0141 & -0.0120 \\
2020-01-28 & 0.0283 & 0.0136 & 0.0090 & 0.0136 & 0.0159 \\
2020-01-29 & 0.0209 & 0.0026 & 0.0045 & 0.0250 & 0.0249 \\
2020-01-30 & -0.0014 & 0.0068 & -0.0023 & -0.0614 & 0.1030 \\
2020-01-31 & -0.0443 & 0.0738 & -0.0023 & -0.0364 & 0.0152 \\
2020-12-01 & 0.0308 & 0.0164 & 0.0176 & 0.0346 & 0.0302 \\
2020-12-02 & 0.0029 & -0.0051 & -0.0043 & 0.0034 & -0.0273 \\
2020-12-03 & -0.0011 & -0.0052 & 0.0011 & -0.0197 & 0.0432 \\
2020-12-04 & -0.0056 & -0.0076 & 0.0141 & -0.0076 & 0.0095 \\
2020-12-07 & 0.0123 & -0.0014 & -0.0128 & 0.0210 & 0.0713 \\
2020-12-08 & 0.0051 & 0.0061 & 0.0033 & -0.0076 & 0.0127 \\
2020-12-09 & -0.0209 & -0.0230 & 0.0216 & -0.0193 & -0.0699 \\
2020-12-10 & 0.0120 & -0.0009 & -0.0349 & -0.0029 & 0.0374 \\
2020-12-11 & -0.0067 & 0.0048 & -0.0110 & -0.0129 & -0.0272 \\
2020-12-14 & -0.0051 & 0.0130 & -0.0122 & 0.0023 & 0.0489 \\
2020-12-15 & 0.0501 & 0.0026 & 0.0269 & 0.0050 & -0.0103 \\
2020-12-16 & -0.0005 & 0.0240 & -0.0120 & 0.0004 & -0.0165 \\
2020-12-17 & 0.0070 & -0.0015 & 0.0044 & -0.0043 & 0.0532 \\
2020-12-18 & -0.0159 & -0.0106 & -0.0143 & 0.0070 & 0.0596 \\
2020-12-21 & 0.0124 & 0.0014 & -0.0022 & -0.0131 & -0.0649 \\
2020-12-22 & 0.0285 & 0.0001 & -0.0157 & -0.0209 & -0.0146 \\
2020-12-23 & -0.0070 & -0.0066 & 0.0228 & 0.0038 & 0.0088 \\
2020-12-24 & 0.0077 & -0.0039 & -0.0145 & -0.0026 & 0.0244 \\
2020-12-28 & 0.0358 & 0.0351 & 0.0034 & 0.0359 & 0.0029 \\
2020-12-29 & -0.0133 & 0.0116 & -0.0079 & -0.0008 & 0.0035 \\
2020-12-30 & -0.0085 & -0.0109 & 0.0045 & -0.0177 & 0.0432 \\
2020-12-31 & -0.0077 & -0.0088 & -0.0079 & 0.0047 & 0.0157 \\
\end{longtable}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\subsection{\texorpdfstring{Download all available data for the Fama and
French daily benchmark factors to dictionary
\texttt{ff\_all}}{Download all available data for the Fama and French daily benchmark factors to dictionary ff\_all}}\label{download-all-available-data-for-the-fama-and-french-daily-benchmark-factors-to-dictionary-ff_all}

I often use the following code snippet to find the exact name for the
the daily benchmark factors file.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pdr.famafrench.get\_available\_datasets()[:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['F-F_Research_Data_Factors',
 'F-F_Research_Data_Factors_weekly',
 'F-F_Research_Data_Factors_daily',
 'F-F_Research_Data_5_Factors_2x3',
 'F-F_Research_Data_5_Factors_2x3_daily']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_all }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_28696\2526882917.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_all = pdr.DataReader(
\end{verbatim}

The \texttt{DESCR} key in the dictionary tells us about the data frames
that \texttt{pandas-datareader} returns.

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(ff\_all[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
F-F Research Data Factors daily
-------------------------------

This file was created by CMPT_ME_BEME_RETS_DAILY using the 202312 CRSP database. The Tbill return is the simple daily rate that, over the number of trading days in the month, compounds to 1-month TBill rate from Ibbotson and Associates Inc. Copyright 2023 Kenneth R. French

  0 : (25649 rows x 4 cols)
\end{verbatim}

\subsection{\texorpdfstring{Slice the daily benchmark factors, convert
them to decimal returns, and assign to
\texttt{ff}}{Slice the daily benchmark factors, convert them to decimal returns, and assign to ff}}\label{slice-the-daily-benchmark-factors-convert-them-to-decimal-returns-and-assign-to-ff}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff }\OperatorTok{=}\NormalTok{ ff\_all[}\DecValTok{0}\NormalTok{].div(}\DecValTok{100}\NormalTok{)}

\NormalTok{ff}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& Mkt-RF & SMB & HML & RF \\
Date & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1926-07-01 & 0.0010 & -0.0025 & -0.0027 & 0.0001 \\
1926-07-02 & 0.0045 & -0.0033 & -0.0006 & 0.0001 \\
1926-07-06 & 0.0017 & 0.0030 & -0.0039 & 0.0001 \\
1926-07-07 & 0.0009 & -0.0058 & 0.0002 & 0.0001 \\
1926-07-08 & 0.0021 & -0.0038 & 0.0019 & 0.0001 \\
... & ... & ... & ... & ... \\
2023-12-22 & 0.0021 & 0.0064 & 0.0009 & 0.0002 \\
2023-12-26 & 0.0048 & 0.0069 & 0.0046 & 0.0002 \\
2023-12-27 & 0.0016 & 0.0014 & 0.0012 & 0.0002 \\
2023-12-28 & -0.0001 & -0.0036 & 0.0003 & 0.0002 \\
2023-12-29 & -0.0043 & -0.0112 & -0.0037 & 0.0002 \\
\end{longtable}

\subsection{\texorpdfstring{Use the \texttt{.cumprod()} method to plot
cumulative returns for these stocks in the
2020s}{Use the .cumprod() method to plot cumulative returns for these stocks in the 2020s}}\label{use-the-.cumprod-method-to-plot-cumulative-returns-for-these-stocks-in-the-2020s}

We use the \texttt{.prod()} method to calculate \emph{total} returns,
because
\(r_{total} = r_{0,T} = \left[ \prod_{t=0}^T (1 + r_t) \right] -1\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{totret }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    returns\_2020s }\CommentTok{\# returns during the 2020s}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{) }\CommentTok{\# add 1 before we compound}
\NormalTok{    .prod() }\CommentTok{\# compound all returns}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{) }\CommentTok{\# subtract 1 to recover total returns}
\NormalTok{)}

\NormalTok{totret}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   1.6331
AMZN   0.8383
F      0.6090
META   1.2899
TSLA   5.7970
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cumret\_cumprod }\OperatorTok{=}\NormalTok{ returns\_2020s.add(}\DecValTok{1}\NormalTok{).cumprod().sub(}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The last row in the cumulative returns data frame
\texttt{cumret\_cumprod} is the same as the total returns series
\texttt{totret}!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(totret, cumret\_cumprod.iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

We can use the \texttt{.plot()} method to plot these cumulative returns!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cumret\_cumprod.mul(}\DecValTok{100}\NormalTok{).plot()}

\CommentTok{\# https://stackoverflow.com/questions/25973581/how{-}to{-}format{-}axis{-}number{-}format{-}to{-}thousands{-}with{-}a{-}comma}
\ImportTok{from}\NormalTok{ matplotlib }\ImportTok{import}\NormalTok{ ticker}
\NormalTok{plt.gca().get\_yaxis().set\_major\_formatter(ticker.FuncFormatter(}\KeywordTok{lambda}\NormalTok{ x, p: }\BuiltInTok{format}\NormalTok{(}\BuiltInTok{int}\NormalTok{(x), }\StringTok{\textquotesingle{},\textquotesingle{}}\NormalTok{)))}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Cumulative Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Cumulative Returns}\CharTok{\textbackslash{}n}\SpecialStringTok{ from }\SpecialCharTok{\{}\NormalTok{cumret\_cumprod}\SpecialCharTok{.}\NormalTok{index}\SpecialCharTok{.}\BuiltInTok{min}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{cumret\_cumprod}\SpecialCharTok{.}\NormalTok{index}\SpecialCharTok{.}\BuiltInTok{max}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_01_practice_02_files/figure-pdf/cell-15-output-1.png}

We can also \texttt{plt.plot()}, but lose a few of the formatting
defaults built into the pandas method \texttt{.plot()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.plot(cumret\_cumprod.mul(}\DecValTok{100}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_01_practice_02_files/figure-pdf/cell-16-output-1.png}

\subsection{\texorpdfstring{Use the \texttt{.cumsum()} method with log
returns to plot cumulative returns for these stocks in the
2020s}{Use the .cumsum() method with log returns to plot cumulative returns for these stocks in the 2020s}}\label{use-the-.cumsum-method-with-log-returns-to-plot-cumulative-returns-for-these-stocks-in-the-2020s}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cumret\_cumsum }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    returns\_2020s}
\NormalTok{    .pipe(np.log1p) }\CommentTok{\# converts simple returns to log returns}
\NormalTok{    .cumsum() }\CommentTok{\# log returns are additive}
\NormalTok{    .pipe(np.expm1) }\CommentTok{\# converts log returns to simple returns}
\NormalTok{)}
\CommentTok{\# cumret\_cumsum = returns\_2020s.add(1).pipe(np.log).cumsum().pipe(np.exp).sub(1)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(totret, cumret\_cumsum.iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cumret\_cumsum.mul(}\DecValTok{100}\NormalTok{).plot()}

\CommentTok{\# https://stackoverflow.com/questions/25973581/how{-}to{-}format{-}axis{-}number{-}format{-}to{-}thousands{-}with{-}a{-}comma}
\ImportTok{from}\NormalTok{ matplotlib }\ImportTok{import}\NormalTok{ ticker}
\NormalTok{plt.gca().get\_yaxis().set\_major\_formatter(ticker.FuncFormatter(}\KeywordTok{lambda}\NormalTok{ x, p: }\BuiltInTok{format}\NormalTok{(}\BuiltInTok{int}\NormalTok{(x), }\StringTok{\textquotesingle{},\textquotesingle{}}\NormalTok{)))}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Cumulative Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Cumulative Returns}\CharTok{\textbackslash{}n}\SpecialStringTok{ from }\SpecialCharTok{\{}\NormalTok{cumret\_cumsum}\SpecialCharTok{.}\NormalTok{index}\SpecialCharTok{.}\BuiltInTok{min}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{cumret\_cumsum}\SpecialCharTok{.}\NormalTok{index}\SpecialCharTok{.}\BuiltInTok{max}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_01_practice_02_files/figure-pdf/cell-19-output-1.png}

\subsection{Use price data only to plot cumulative returns for these
stocks in the
2020s}\label{use-price-data-only-to-plot-cumulative-returns-for-these-stocks-in-the-2020s}

We can also calculate cumulative returns as the ratio of adjusted
closes. That is \(R_{0,T} = \frac{AC_T}{AC_0} - 1\). The trick here is
that \(FV_t = PV (1+r)^t\), so \((1+r)^t = \frac{FV_t}{PV}\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s.iloc[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.0228
AMZN   0.0272
F      0.0129
META   0.0221
TSLA   0.0285
Name: 2020-01-02 00:00:00, dtype: float64
\end{verbatim}

\textbf{\emph{Note:}} We drop the last row in
\texttt{prices{[}\textquotesingle{}Adj\ Close\textquotesingle{}{]}} with
\texttt{.iloc{[}:-1{]}}. We drop this last row here here because we did
the same above when we calculated \texttt{returns} to exclude possible
intraday returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cumret\_prices }\OperatorTok{=}\NormalTok{ prices[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].loc[}\StringTok{\textquotesingle{}2020\textquotesingle{}}\NormalTok{:].iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{/}\NormalTok{ prices[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].loc[}\StringTok{\textquotesingle{}2019\textquotesingle{}}\NormalTok{].iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{{-}} \DecValTok{1}

\NormalTok{cumret\_prices.iloc[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.0228
AMZN   0.0272
F      0.0129
META   0.0221
TSLA   0.0285
Name: 2020-01-02 00:00:00, dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(cumret\_cumprod, cumret\_prices)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cumret\_prices.mul(}\DecValTok{100}\NormalTok{).plot()}

\CommentTok{\# https://stackoverflow.com/questions/25973581/how{-}to{-}format{-}axis{-}number{-}format{-}to{-}thousands{-}with{-}a{-}comma}
\ImportTok{from}\NormalTok{ matplotlib }\ImportTok{import}\NormalTok{ ticker}
\NormalTok{plt.gca().get\_yaxis().set\_major\_formatter(ticker.FuncFormatter(}\KeywordTok{lambda}\NormalTok{ x, p: }\BuiltInTok{format}\NormalTok{(}\BuiltInTok{int}\NormalTok{(x), }\StringTok{\textquotesingle{},\textquotesingle{}}\NormalTok{)))}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Cumulative Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Cumulative Returns}\CharTok{\textbackslash{}n}\SpecialStringTok{ from }\SpecialCharTok{\{}\NormalTok{cumret\_prices}\SpecialCharTok{.}\NormalTok{index}\SpecialCharTok{.}\BuiltInTok{min}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{cumret\_prices}\SpecialCharTok{.}\NormalTok{index}\SpecialCharTok{.}\BuiltInTok{max}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_01_practice_02_files/figure-pdf/cell-23-output-1.png}

\subsection{Calculate the Sharpe Ratio for
TSLA}\label{calculate-the-sharpe-ratio-for-tsla}

Calculate the Sharpe Ratio with all available returns and 2020s returns.
Recall the Sharpe Ratio is \(\frac{\overline{r_i - r_f}}{\sigma_i}\),
where \(\sigma_i\) is the volatility of \emph{excess} returns.

\textbf{\emph{I suggest you write a function named
\texttt{calc\_sharpe()} to use for the rest of this notebook.}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_sharpe(ri, rf}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], ppy}\OperatorTok{=}\DecValTok{252}\NormalTok{):}
\NormalTok{    ri\_rf }\OperatorTok{=}\NormalTok{ ri.sub(rf).dropna()}
    \ControlFlowTok{return}\NormalTok{ np.sqrt(ppy) }\OperatorTok{*}\NormalTok{ ri\_rf.mean() }\OperatorTok{/}\NormalTok{ ri\_rf.std()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(ri}\OperatorTok{=}\NormalTok{returns[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.9261
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(ri}\OperatorTok{=}\NormalTok{returns\_2020s[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.1212
\end{verbatim}

We can use the \texttt{.pipe()} method here, too, since \texttt{ri} is
the first argument to \texttt{calc\_sharpe()}!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{].pipe(calc\_sharpe)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.9261
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{].pipe(calc\_sharpe)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.1212
\end{verbatim}

\subsection{Calculate the market beta for
TSLA}\label{calculate-the-market-beta-for-tsla}

Calculate the market beta with all available returns and 2020s returns.
Recall we estimate market beta with the ordinary least squares (OLS)
regression \(R_i-R_f = \alpha + \beta (R_m-R_f) + \epsilon\). We can
estimate market beta with the covariance formula (i.e.,
\(\beta_i = \frac{Cov(R_i - R_f, R_m - R_f)}{Var(R_m-R_f)}\)) above for
a univariate regression if we do not need goodness of fit statistics.

\textbf{\emph{I suggest you write a function named \texttt{calc\_beta()}
to use for the rest of this notebook.}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_beta(ri, rf}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], rm\_rf}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{]):}
\NormalTok{    ri\_rf }\OperatorTok{=}\NormalTok{ ri.sub(rf).dropna()}
\NormalTok{    rm\_rf }\OperatorTok{=}\NormalTok{ rm\_rf.loc[ri\_rf.index]}
    \ControlFlowTok{return}\NormalTok{ ri\_rf.cov(rm\_rf) }\OperatorTok{/}\NormalTok{ rm\_rf.var()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_beta(ri}\OperatorTok{=}\NormalTok{returns[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.4417
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_beta(ri}\OperatorTok{=}\NormalTok{returns\_2020s[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.5780
\end{verbatim}

We can use the \texttt{.pipe()} method here, too, since \texttt{ri} is
the first argument to \texttt{calc\_beta()}!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{].pipe(calc\_beta)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.4417
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{].pipe(calc\_beta)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.5780
\end{verbatim}

\subsection{Guess the Sharpe Ratios for these stocks in the
2020s}\label{guess-the-sharpe-ratios-for-these-stocks-in-the-2020s}

\subsection{Guess the market betas for these stocks in the
2020s}\label{guess-the-market-betas-for-these-stocks-in-the-2020s}

\subsection{Calculate the Sharpe Ratios for these stocks in the
2020s}\label{calculate-the-sharpe-ratios-for-these-stocks-in-the-2020s}

How good were your guesses?

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ returns\_2020s:}
\NormalTok{    sharpe\_i }\OperatorTok{=}\NormalTok{ returns\_2020s[i].pipe(calc\_sharpe)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}Sharpe Ratio for }\SpecialCharTok{\{}\NormalTok{i}\SpecialCharTok{\}}\SpecialStringTok{:}\CharTok{\textbackslash{}t}\SpecialStringTok{ }\SpecialCharTok{\{}\NormalTok{sharpe\_i}\SpecialCharTok{:0.2f\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Sharpe Ratio for AAPL:   0.86
Sharpe Ratio for AMZN:   0.48
Sharpe Ratio for F:  0.42
Sharpe Ratio for META:   0.49
Sharpe Ratio for TSLA:   1.12
\end{verbatim}

We can also use pandas notation to vectorize this calculation. First
calculate \emph{excess} returns as \(r_i - r_f\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s\_excess }\OperatorTok{=}\NormalTok{ returns\_2020s.sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{).dropna()}
\end{Highlighting}
\end{Shaded}

Then use pandas notation to calculate means, standard deviations, and
annualize.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    returns\_2020s\_excess}
\NormalTok{    .mean()}
\NormalTok{    .div(returns\_2020s\_excess.std())}
\NormalTok{    .mul(np.sqrt(}\DecValTok{252}\NormalTok{))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.8576
AMZN   0.4750
F      0.4240
META   0.4949
TSLA   1.1212
dtype: float64
\end{verbatim}

\textbf{\emph{Note:}} In a few weeks we will learn the \texttt{.apply()}
method, which avoids the loop syntax.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s.}\BuiltInTok{apply}\NormalTok{(calc\_sharpe)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.8576
AMZN   0.4750
F      0.4240
META   0.4949
TSLA   1.1212
dtype: float64
\end{verbatim}

\subsection{Calculate the market betas for these stocks in the
2020s}\label{calculate-the-market-betas-for-these-stocks-in-the-2020s}

How good were your guesses?

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ returns\_2020s:}
\NormalTok{    beta\_i }\OperatorTok{=}\NormalTok{ returns\_2020s[i].pipe(calc\_beta)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}Beta for }\SpecialCharTok{\{}\NormalTok{i}\SpecialCharTok{\}}\SpecialStringTok{:}\CharTok{\textbackslash{}t}\SpecialStringTok{ }\SpecialCharTok{\{}\NormalTok{beta\_i}\SpecialCharTok{:0.2f\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Beta for AAPL:   1.15
Beta for AMZN:   1.04
Beta for F:  1.22
Beta for META:   1.27
Beta for TSLA:   1.58
\end{verbatim}

Or we can follow out approach above to vectorize this calculation.
First, we need to add a market excess return column to
\texttt{returns\_2020s\_excess}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s\_excess[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ ff[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{]}
\NormalTok{returns\_2020s\_excess.head()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& AAPL & AMZN & F & META & TSLA & Mkt-RF \\
Date & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2020-01-02 & 0.0228 & 0.0271 & 0.0128 & 0.0220 & 0.0285 & 0.0086 \\
2020-01-03 & -0.0098 & -0.0122 & -0.0224 & -0.0054 & 0.0296 & -0.0067 \\
2020-01-06 & 0.0079 & 0.0148 & -0.0055 & 0.0188 & 0.0192 & 0.0036 \\
2020-01-07 & -0.0048 & 0.0020 & 0.0098 & 0.0021 & 0.0387 & -0.0019 \\
2020-01-08 & 0.0160 & -0.0079 & -0.0001 & 0.0101 & 0.0491 & 0.0047 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vcv }\OperatorTok{=}\NormalTok{ returns\_2020s\_excess.cov()}
\NormalTok{vcv}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& AAPL & AMZN & F & META & TSLA & Mkt-RF \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
AAPL & 0.0004 & 0.0003 & 0.0002 & 0.0004 & 0.0005 & 0.0003 \\
AMZN & 0.0003 & 0.0006 & 0.0002 & 0.0004 & 0.0005 & 0.0002 \\
F & 0.0002 & 0.0002 & 0.0009 & 0.0003 & 0.0005 & 0.0003 \\
META & 0.0004 & 0.0004 & 0.0003 & 0.0009 & 0.0005 & 0.0003 \\
TSLA & 0.0005 & 0.0005 & 0.0005 & 0.0005 & 0.0018 & 0.0003 \\
Mkt-RF & 0.0003 & 0.0002 & 0.0003 & 0.0003 & 0.0003 & 0.0002 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vcv[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{].div(vcv.loc[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{]).plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}CAPM Beta\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}CAPM Betas\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_01_practice_02_files/figure-pdf/cell-41-output-1.png}

\textbf{\emph{Note:}} In a few weeks we will learn the \texttt{.apply()}
method, which avoids the loop syntax.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s.}\BuiltInTok{apply}\NormalTok{(calc\_beta)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   1.1541
AMZN   1.0429
F      1.2231
META   1.2710
TSLA   1.5780
dtype: float64
\end{verbatim}

\subsection{\texorpdfstring{Calculate the Sharpe Ratio for an
\emph{equally weighted} portfolio of these stocks in the
2020s}{Calculate the Sharpe Ratio for an equally weighted portfolio of these stocks in the 2020s}}\label{calculate-the-sharpe-ratio-for-an-equally-weighted-portfolio-of-these-stocks-in-the-2020s}

What do you notice?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s.mean(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{).pipe(calc\_sharpe)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.9573
\end{verbatim}

Because diversification reduces portfolio standard deviation less than
the sum of its parts, the Sharpe Ratio of the equally weighted portfolio
is less than the equally weighted mean of the single-stock Sharpe
Ratios.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s.}\BuiltInTok{apply}\NormalTok{(calc\_sharpe).mean()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.6745
\end{verbatim}

\subsection{\texorpdfstring{Calculate the market beta for an
\emph{equally weighted} portfolio of these stocks in the
2020s}{Calculate the market beta for an equally weighted portfolio of these stocks in the 2020s}}\label{calculate-the-market-beta-for-an-equally-weighted-portfolio-of-these-stocks-in-the-2020s}

What do you notice?

Beta measures \emph{non}diversifiable risk, so
\(\beta_P = \sum w_i \beta_i\)!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s.mean(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{).pipe(calc\_beta)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.2538
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s.}\BuiltInTok{apply}\NormalTok{(calc\_beta).mean()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.2538
\end{verbatim}

\subsection{Calculate the market betas for these stocks every calendar
year for every possible
year}\label{calculate-the-market-betas-for-these-stocks-every-calendar-year-for-every-possible-year}

Save these market betas to data frame \texttt{betas}. Our current Python
knowledge limits us to a for-loop, but we will learn easier and faster
approaches soon!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{betas }\OperatorTok{=}\NormalTok{ pd.DataFrame(}
\NormalTok{    index}\OperatorTok{=}\BuiltInTok{range}\NormalTok{(}\DecValTok{1972}\NormalTok{, }\DecValTok{2024}\NormalTok{),}
\NormalTok{    columns}\OperatorTok{=}\NormalTok{returns.columns}
\NormalTok{)}

\NormalTok{betas.columns.name }\OperatorTok{=} \StringTok{\textquotesingle{}Ticker\textquotesingle{}}
\NormalTok{betas.index.name }\OperatorTok{=} \StringTok{\textquotesingle{}Year\textquotesingle{}}

\NormalTok{betas.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
Ticker & AAPL & AMZN & F & META & TSLA \\
Year & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2019 & NaN & NaN & NaN & NaN & NaN \\
2020 & NaN & NaN & NaN & NaN & NaN \\
2021 & NaN & NaN & NaN & NaN & NaN \\
2022 & NaN & NaN & NaN & NaN & NaN \\
2023 & NaN & NaN & NaN & NaN & NaN \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ betas.index: }
    \ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ betas.columns:}
\NormalTok{        betas.at[i, c] }\OperatorTok{=}\NormalTok{ returns.loc[}\BuiltInTok{str}\NormalTok{(i), c].pipe(calc\_beta)}

\NormalTok{betas.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
Ticker & AAPL & AMZN & F & META & TSLA \\
Year & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2019 & 1.4751 & 1.2752 & 1.0733 & 1.2094 & 1.3262 \\
2020 & 1.1174 & 0.6866 & 1.1052 & 0.9913 & 1.3041 \\
2021 & 1.1957 & 0.9822 & 1.2396 & 1.2014 & 1.9891 \\
2022 & 1.2386 & 1.5922 & 1.3824 & 1.6843 & 1.7414 \\
2023 & 1.0369 & 1.4649 & 1.3947 & 1.6630 & 2.2218 \\
\end{longtable}

\subsection{Plot the time series of market
betas}\label{plot-the-time-series-of-market-betas}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{betas.plot()}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}CAPM Beta\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}CAPM Betas\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_01_practice_02_files/figure-pdf/cell-49-output-1.png}

\chapter{Herron Topic 1 - Practice for Section
03}\label{herron-topic-1---practice-for-section-03}

\section{Announcements}\label{announcements-17}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  DataCamp

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    \emph{Data Manipulation with pandas} due by Friday, 2/9, at 11:59 PM
  \item
    \emph{Joining Data with pandas} due by Friday, 2/16, at 11:59 PM
  \item
    \emph{Earn 10,000 XP} due by Friday, 3/15, at 11:59 PM
  \end{enumerate}
\item
  I posted Project 1 to Canvas

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Slides and notebook due by Friday, 2/23, at 11:59 PM
  \item
    Keep joining teams and let me know if you need help
  \end{enumerate}
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-16}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

First, we can easily download data in Python with two packages:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \texttt{yfinance} to download data from Yahoo! Finance
\item
  \texttt{pandas-datareader} to download data from Ken French (and FRED
  and others)
\end{enumerate}

Second, there are ``simple returns'' and ``log returns''

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Simple returns are the returns that investors receive that we learned
  in FINA 6331 and FINA 6333:
  \(r_t = \frac{p_t + d_t - p_{t-1}}{p_{t-1}}\)
\item
  Log returns are the log of one plus simple returns. Why do we use
  them?

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    \textbf{\emph{Log returns are additive}}, while simple returns are
    multiplicative. This additive property makes math really easy with
    log returns:
    \(\log(\prod_{t=0}^T (1 + r_t)) = \sum_{t=0}^T \log(1+r_t)\), so
    \(r_{0,T} = \prod_{t=0}^T (1 + r_t) - 1 = e^{\sum_{t=0}^T \log(1+r_t)} - 1\)
  \item
    \textbf{\emph{Log returns are almost normally distributed}}
  \end{enumerate}
\end{enumerate}

\textbf{\emph{We will almost always use simple returns.}} The exeception
is time-consuming calculations, which we will often do in log returns to
save us time.

Third, we can easily calculate portfolio returns in pandas!

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \texttt{returns.mean(axis=1)} is the equally-weighted portfolio return
  for the stocks in \texttt{returns}, \textbf{\emph{rebalanced at the
  same frequency as the returns in \texttt{returns}!}}
\item
  \texttt{returns.dot(weights)} lets us use weights in array
  \texttt{weights} instead of equally-weighted, but is still
  \textbf{\emph{rebalanced at the same frequency as the returns in
  \texttt{returns}!}}
\end{enumerate}

\section{Practice}\label{practice-17}

\subsection{\texorpdfstring{Download all available daily price data for
tickers TSLA, F, AAPL, AMZN, and META to data frame
\texttt{prices}}{Download all available daily price data for tickers TSLA, F, AAPL, AMZN, and META to data frame prices}}\label{download-all-available-daily-price-data-for-tickers-tsla-f-aapl-amzn-and-meta-to-data-frame-prices-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tickers }\OperatorTok{=} \StringTok{\textquotesingle{}TSLA F AAPL AMZN META\textquotesingle{}}
\NormalTok{prices }\OperatorTok{=}\NormalTok{ yf.download(tickers}\OperatorTok{=}\NormalTok{tickers)}

\NormalTok{prices}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  5 of 5 completed
\end{verbatim}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
& \multicolumn{5}{l}{%
Adj Close} & \multicolumn{5}{l}{%
Close} & ... & \multicolumn{5}{l}{%
Open} & \multicolumn{5}{l@{}}{%
Volume} \\
& AAPL & AMZN & F & META & TSLA & AAPL & AMZN & F & META & TSLA & ... &
AAPL & AMZN & F & META & TSLA & AAPL & AMZN & F & META & TSLA \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1972-06-01 & NaN & NaN & 0.2419 & NaN & NaN & NaN & NaN & 2.1532 & NaN &
NaN & ... & NaN & NaN & 0.0000 & NaN & NaN & NaN & NaN & 1091238 & NaN &
NaN \\
1972-06-02 & NaN & NaN & 0.2414 & NaN & NaN & NaN & NaN & 2.1492 & NaN &
NaN & ... & NaN & NaN & 2.1532 & NaN & NaN & NaN & NaN & 1174468 & NaN &
NaN \\
1972-06-05 & NaN & NaN & 0.2414 & NaN & NaN & NaN & NaN & 2.1492 & NaN &
NaN & ... & NaN & NaN & 2.1492 & NaN & NaN & NaN & NaN & 5209582 & NaN &
NaN \\
1972-06-06 & NaN & NaN & 0.2387 & NaN & NaN & NaN & NaN & 2.1248 & NaN &
NaN & ... & NaN & NaN & 2.1492 & NaN & NaN & NaN & NaN & 1424158 & NaN &
NaN \\
1972-06-07 & NaN & NaN & 0.2373 & NaN & NaN & NaN & NaN & 2.1127 & NaN &
NaN & ... & NaN & NaN & 2.1248 & NaN & NaN & NaN & NaN & 675088 & NaN &
NaN \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2024-02-05 & 187.6800 & 170.3100 & 11.5900 & 459.4100 & 181.0600 &
187.6800 & 170.3100 & 11.5900 & 459.4100 & 181.0600 & ... & 188.1500 &
170.2000 & 12.0100 & 469.8800 & 184.2600 & 69668800.0000 & 55081300.0000
& 81026800 & 40832400.0000 & 134294400.0000 \\
2024-02-06 & 189.3000 & 169.1500 & 12.0700 & 454.7200 & 185.1000 &
189.3000 & 169.1500 & 12.0700 & 454.7200 & 185.1000 & ... & 186.8600 &
169.3900 & 11.6400 & 464.0000 & 177.2100 & 43490800.0000 & 42505500.0000
& 98636800 & 21655200.0000 & 122676000.0000 \\
2024-02-07 & 189.4100 & 170.5300 & 12.8000 & 469.5900 & 187.5800 &
189.4100 & 170.5300 & 12.8000 & 469.5900 & 187.5800 & ... & 190.6400 &
169.4800 & 12.7300 & 458.0000 & 188.1800 & 53439000.0000 & 47174100.0000
& 137224000 & 23066000.0000 & 111535200.0000 \\
2024-02-08 & 188.3200 & 169.8400 & 12.8300 & 470.0000 & 189.5600 &
188.3200 & 169.8400 & 12.8300 & 470.0000 & 189.5600 & ... & 189.3900 &
169.6500 & 12.8700 & 468.3200 & 189.0000 & 40962000.0000 & 42316500.0000
& 68653900 & 18815100.0000 & 83034000.0000 \\
2024-02-09 & 188.8500 & 174.4500 & 12.6800 & 468.1100 & 193.5700 &
188.8500 & 174.4500 & 12.6800 & 468.1100 & 193.5700 & ... & 188.6500 &
170.9000 & 12.8100 & 472.9500 & 190.1800 & 43728065.0000 & 56886544.0000
& 46925766 & 18159624.0000 & 84009121.0000 \\
\end{longtable}

\subsection{\texorpdfstring{Calculate all available daily returns and
save to data frame
\texttt{returns}}{Calculate all available daily returns and save to data frame returns}}\label{calculate-all-available-daily-returns-and-save-to-data-frame-returns-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    prices[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{] }\CommentTok{\# slice adj close}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\CommentTok{\# drop the last price because it might be intraday (i.e., not a close)}
\NormalTok{    .pct\_change() }\CommentTok{\# calculate simple returns}
\NormalTok{)}

\NormalTok{returns}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& AAPL & AMZN & F & META & TSLA \\
Date & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1972-06-01 & NaN & NaN & NaN & NaN & NaN \\
1972-06-02 & NaN & NaN & -0.0019 & NaN & NaN \\
1972-06-05 & NaN & NaN & 0.0000 & NaN & NaN \\
1972-06-06 & NaN & NaN & -0.0113 & NaN & NaN \\
1972-06-07 & NaN & NaN & -0.0057 & NaN & NaN \\
... & ... & ... & ... & ... & ... \\
2024-02-02 & -0.0054 & 0.0787 & 0.0033 & 0.2032 & -0.0050 \\
2024-02-05 & 0.0098 & -0.0087 & -0.0453 & -0.0328 & -0.0365 \\
2024-02-06 & 0.0086 & -0.0068 & 0.0414 & -0.0102 & 0.0223 \\
2024-02-07 & 0.0006 & 0.0082 & 0.0605 & 0.0327 & 0.0134 \\
2024-02-08 & -0.0058 & -0.0040 & 0.0023 & 0.0009 & 0.0106 \\
\end{longtable}

\subsection{\texorpdfstring{Slices returns for the 2020s and assign to
\texttt{returns\_2020s}}{Slices returns for the 2020s and assign to returns\_2020s}}\label{slices-returns-for-the-2020s-and-assign-to-returns_2020s-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s }\OperatorTok{=}\NormalTok{ returns.loc[}\StringTok{\textquotesingle{}2020\textquotesingle{}}\NormalTok{:] }\CommentTok{\# always use an unambiguos date format, like YYYY{-}MM{-}DD}

\NormalTok{returns\_2020s}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& AAPL & AMZN & F & META & TSLA \\
Date & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2020-01-02 & 0.0228 & 0.0272 & 0.0129 & 0.0221 & 0.0285 \\
2020-01-03 & -0.0097 & -0.0121 & -0.0223 & -0.0053 & 0.0296 \\
2020-01-06 & 0.0080 & 0.0149 & -0.0054 & 0.0188 & 0.0193 \\
2020-01-07 & -0.0047 & 0.0021 & 0.0098 & 0.0022 & 0.0388 \\
2020-01-08 & 0.0161 & -0.0078 & 0.0000 & 0.0101 & 0.0492 \\
... & ... & ... & ... & ... & ... \\
2024-02-02 & -0.0054 & 0.0787 & 0.0033 & 0.2032 & -0.0050 \\
2024-02-05 & 0.0098 & -0.0087 & -0.0453 & -0.0328 & -0.0365 \\
2024-02-06 & 0.0086 & -0.0068 & 0.0414 & -0.0102 & 0.0223 \\
2024-02-07 & 0.0006 & 0.0082 & 0.0605 & 0.0327 & 0.0134 \\
2024-02-08 & -0.0058 & -0.0040 & 0.0023 & 0.0009 & 0.0106 \\
\end{longtable}

\subsection{\texorpdfstring{Download all available data for the Fama and
French daily benchmark factors to dictionary
\texttt{ff\_all}}{Download all available data for the Fama and French daily benchmark factors to dictionary ff\_all}}\label{download-all-available-data-for-the-fama-and-french-daily-benchmark-factors-to-dictionary-ff_all-1}

I often use the following code snippet to find the exact name for the
the daily benchmark factors file.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pdr.famafrench.get\_available\_datasets()[:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['F-F_Research_Data_Factors',
 'F-F_Research_Data_Factors_weekly',
 'F-F_Research_Data_Factors_daily',
 'F-F_Research_Data_5_Factors_2x3',
 'F-F_Research_Data_5_Factors_2x3_daily']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_all }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27592\2526882917.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_all = pdr.DataReader(
\end{verbatim}

The \texttt{DESCR} key in the dictionary tells us about the data frames
that \texttt{pandas-datareader} returns.

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(ff\_all[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
F-F Research Data Factors daily
-------------------------------

This file was created by CMPT_ME_BEME_RETS_DAILY using the 202312 CRSP database. The Tbill return is the simple daily rate that, over the number of trading days in the month, compounds to 1-month TBill rate from Ibbotson and Associates Inc. Copyright 2023 Kenneth R. French

  0 : (25649 rows x 4 cols)
\end{verbatim}

\subsection{\texorpdfstring{Slice the daily benchmark factors, convert
them to decimal returns, and assign to
\texttt{ff}}{Slice the daily benchmark factors, convert them to decimal returns, and assign to ff}}\label{slice-the-daily-benchmark-factors-convert-them-to-decimal-returns-and-assign-to-ff-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff }\OperatorTok{=}\NormalTok{ ff\_all[}\DecValTok{0}\NormalTok{].div(}\DecValTok{100}\NormalTok{)}

\NormalTok{ff}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& Mkt-RF & SMB & HML & RF \\
Date & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1926-07-01 & 0.0010 & -0.0025 & -0.0027 & 0.0001 \\
1926-07-02 & 0.0045 & -0.0033 & -0.0006 & 0.0001 \\
1926-07-06 & 0.0017 & 0.0030 & -0.0039 & 0.0001 \\
1926-07-07 & 0.0009 & -0.0058 & 0.0002 & 0.0001 \\
1926-07-08 & 0.0021 & -0.0038 & 0.0019 & 0.0001 \\
... & ... & ... & ... & ... \\
2023-12-22 & 0.0021 & 0.0064 & 0.0009 & 0.0002 \\
2023-12-26 & 0.0048 & 0.0069 & 0.0046 & 0.0002 \\
2023-12-27 & 0.0016 & 0.0014 & 0.0012 & 0.0002 \\
2023-12-28 & -0.0001 & -0.0036 & 0.0003 & 0.0002 \\
2023-12-29 & -0.0043 & -0.0112 & -0.0037 & 0.0002 \\
\end{longtable}

\subsection{\texorpdfstring{Use the \texttt{.cumprod()} method to plot
cumulative returns for these stocks in the
2020s}{Use the .cumprod() method to plot cumulative returns for these stocks in the 2020s}}\label{use-the-.cumprod-method-to-plot-cumulative-returns-for-these-stocks-in-the-2020s-1}

We use the \texttt{.prod()} method to calculate \emph{total} returns,
because
\(r_{total} = r_{0,T} = \left[ \prod_{t=0}^T (1 + r_t) \right] -1\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    returns\_2020s }\CommentTok{\# returns during the 2020s}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{) }\CommentTok{\# add 1 before we compound}
\NormalTok{    .prod() }\CommentTok{\# compound all returns}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{) }\CommentTok{\# subtract 1 to recover total returns}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   1.6331
AMZN   0.8383
F      0.6090
META   1.2899
TSLA   5.7970
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cumret\_cumprod }\OperatorTok{=}\NormalTok{  (}
\NormalTok{    returns\_2020s}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cumret\_cumprod.mul(}\DecValTok{100}\NormalTok{).plot()}

\CommentTok{\# https://stackoverflow.com/questions/25973581/how{-}to{-}format{-}axis{-}number{-}format{-}to{-}thousands{-}with{-}a{-}comma}
\ImportTok{from}\NormalTok{ matplotlib }\ImportTok{import}\NormalTok{ ticker}
\NormalTok{plt.gca().get\_yaxis().set\_major\_formatter(ticker.FuncFormatter(}\KeywordTok{lambda}\NormalTok{ x, p: }\BuiltInTok{format}\NormalTok{(}\BuiltInTok{int}\NormalTok{(x), }\StringTok{\textquotesingle{},\textquotesingle{}}\NormalTok{)))}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Cumulative Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Cumulative Returns}\CharTok{\textbackslash{}n}\SpecialStringTok{ from }\SpecialCharTok{\{}\NormalTok{returns\_2020s}\SpecialCharTok{.}\NormalTok{index}\SpecialCharTok{.}\BuiltInTok{min}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{returns\_2020s}\SpecialCharTok{.}\NormalTok{index}\SpecialCharTok{.}\BuiltInTok{max}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_01_practice_03_files/figure-pdf/cell-13-output-1.png}

\subsection{\texorpdfstring{Use the \texttt{.cumsum()} method with log
returns to plot cumulative returns for these stocks in the
2020s}{Use the .cumsum() method with log returns to plot cumulative returns for these stocks in the 2020s}}\label{use-the-.cumsum-method-with-log-returns-to-plot-cumulative-returns-for-these-stocks-in-the-2020s-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cumret\_cumsum }\OperatorTok{=}\NormalTok{  (}
\NormalTok{    returns\_2020s }\CommentTok{\# start with simple returns}
\NormalTok{    .pipe(np.log1p) }\CommentTok{\# convert to log returns}
\NormalTok{    .cumsum() }\CommentTok{\# log returns are additive}
\NormalTok{    .pipe(np.expm1) }\CommentTok{\# convert back to simple returns}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(cumret\_cumsum, cumret\_cumprod)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(}\DecValTok{1}\OperatorTok{*}\DecValTok{10}\OperatorTok{**{-}}\DecValTok{9}\NormalTok{, }\FloatTok{1.1}\OperatorTok{*}\DecValTok{10}\OperatorTok{**{-}}\DecValTok{9}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cumret\_cumsum.mul(}\DecValTok{100}\NormalTok{).plot()}

\CommentTok{\# https://stackoverflow.com/questions/25973581/how{-}to{-}format{-}axis{-}number{-}format{-}to{-}thousands{-}with{-}a{-}comma}
\ImportTok{from}\NormalTok{ matplotlib }\ImportTok{import}\NormalTok{ ticker}
\NormalTok{plt.gca().get\_yaxis().set\_major\_formatter(ticker.FuncFormatter(}\KeywordTok{lambda}\NormalTok{ x, p: }\BuiltInTok{format}\NormalTok{(}\BuiltInTok{int}\NormalTok{(x), }\StringTok{\textquotesingle{},\textquotesingle{}}\NormalTok{)))}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Cumulative Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Cumulative Returns}\CharTok{\textbackslash{}n}\SpecialStringTok{ from }\SpecialCharTok{\{}\NormalTok{returns\_2020s}\SpecialCharTok{.}\NormalTok{index}\SpecialCharTok{.}\BuiltInTok{min}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{returns\_2020s}\SpecialCharTok{.}\NormalTok{index}\SpecialCharTok{.}\BuiltInTok{max}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_01_practice_03_files/figure-pdf/cell-17-output-1.png}

\subsection{Use price data only to plot cumulative returns for these
stocks in the
2020s}\label{use-price-data-only-to-plot-cumulative-returns-for-these-stocks-in-the-2020s-1}

We can also calculate cumulative returns as the ratio of adjusted
closes. That is \(R_{0,T} = \frac{AC_T}{AC_0} - 1\). The trick here is
that \(FV_t = PV (1+r)^t\), so \((1+r)^t = \frac{FV_t}{PV}\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s.iloc[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.0228
AMZN   0.0272
F      0.0129
META   0.0221
TSLA   0.0285
Name: 2020-01-02 00:00:00, dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cumret\_prices }\OperatorTok{=}\NormalTok{ prices[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].loc[}\StringTok{\textquotesingle{}2020\textquotesingle{}}\NormalTok{:].iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{/}\NormalTok{ prices[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].loc[}\StringTok{\textquotesingle{}2019\textquotesingle{}}\NormalTok{].iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{{-}} \DecValTok{1}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(cumret\_prices, cumret\_cumprod)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cumret\_prices.mul(}\DecValTok{100}\NormalTok{).plot()}

\CommentTok{\# https://stackoverflow.com/questions/25973581/how{-}to{-}format{-}axis{-}number{-}format{-}to{-}thousands{-}with{-}a{-}comma}
\ImportTok{from}\NormalTok{ matplotlib }\ImportTok{import}\NormalTok{ ticker}
\NormalTok{plt.gca().get\_yaxis().set\_major\_formatter(ticker.FuncFormatter(}\KeywordTok{lambda}\NormalTok{ x, p: }\BuiltInTok{format}\NormalTok{(}\BuiltInTok{int}\NormalTok{(x), }\StringTok{\textquotesingle{},\textquotesingle{}}\NormalTok{)))}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Cumulative Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Cumulative Returns}\CharTok{\textbackslash{}n}\SpecialStringTok{ from }\SpecialCharTok{\{}\NormalTok{returns\_2020s}\SpecialCharTok{.}\NormalTok{index}\SpecialCharTok{.}\BuiltInTok{min}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{returns\_2020s}\SpecialCharTok{.}\NormalTok{index}\SpecialCharTok{.}\BuiltInTok{max}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_01_practice_03_files/figure-pdf/cell-21-output-1.png}

\subsection{Calculate the Sharpe Ratio for
TSLA}\label{calculate-the-sharpe-ratio-for-tsla-1}

Calculate the Sharpe Ratio with all available returns and 2020s returns.
Recall the Sharpe Ratio is \(\frac{\overline{r_i - r_f}}{\sigma_i}\),
where \(\sigma_i\) is the volatility of \emph{excess} returns.

\textbf{\emph{I suggest you write a function named
\texttt{calc\_sharpe()} to use for the rest of this notebook.}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_sharpe(ri, rf}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], ppy}\OperatorTok{=}\DecValTok{252}\NormalTok{):}
\NormalTok{    ri\_rf }\OperatorTok{=}\NormalTok{ ri.sub(rf).dropna()}
    \ControlFlowTok{return}\NormalTok{ np.sqrt(ppy) }\OperatorTok{*}\NormalTok{ ri\_rf.mean() }\OperatorTok{/}\NormalTok{ ri\_rf.std()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(ri}\OperatorTok{=}\NormalTok{returns[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.9261
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(ri}\OperatorTok{=}\NormalTok{returns\_2020s[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.1212
\end{verbatim}

\textbf{\emph{Or, we can use the \texttt{.pipe()} method because
\texttt{ri} is the first argument to \texttt{calc\_sharpe()}!}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{].pipe(calc\_sharpe)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.9261
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{].pipe(calc\_sharpe)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.1212
\end{verbatim}

\subsection{Calculate the market beta for
TSLA}\label{calculate-the-market-beta-for-tsla-1}

Calculate the market beta with all available returns and 2020s returns.
Recall we estimate market beta with the ordinary least squares (OLS)
regression \(R_i-R_f = \alpha + \beta (R_m-R_f) + \epsilon\). We can
estimate market beta with the covariance formula (i.e.,
\(\beta_i = \frac{Cov(R_i - R_f, R_m - R_f)}{Var(R_m-R_f)}\)) above for
a univariate regression if we do not need goodness of fit statistics.

\textbf{\emph{I suggest you write a function named \texttt{calc\_beta()}
to use for the rest of this notebook.}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_beta(ri, rf}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], rm\_rf}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{]):}
\NormalTok{    ri\_rf }\OperatorTok{=}\NormalTok{ ri.sub(rf).dropna()}
    \ControlFlowTok{return}\NormalTok{ ri\_rf.cov(rm\_rf) }\OperatorTok{/}\NormalTok{ rm\_rf.loc[ri\_rf.index].var()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_beta(ri}\OperatorTok{=}\NormalTok{returns[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.4417
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_beta(ri}\OperatorTok{=}\NormalTok{returns\_2020s[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.5780
\end{verbatim}

\textbf{\emph{Or, we can use the \texttt{.pipe()} method because
\texttt{ri} is the first argument to \texttt{calc\_sharpe()}!}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{].pipe(calc\_beta)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.4417
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{].pipe(calc\_beta)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.5780
\end{verbatim}

\subsection{Guess the Sharpe Ratios for these stocks in the
2020s}\label{guess-the-sharpe-ratios-for-these-stocks-in-the-2020s-1}

\subsection{Guess the market betas for these stocks in the
2020s}\label{guess-the-market-betas-for-these-stocks-in-the-2020s-1}

\subsection{Calculate the Sharpe Ratios for these stocks in the
2020s}\label{calculate-the-sharpe-ratios-for-these-stocks-in-the-2020s-1}

How good were your guesses?

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ returns\_2020s:}
\NormalTok{    sharpe\_i }\OperatorTok{=}\NormalTok{ returns\_2020s[i].pipe(calc\_sharpe)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}Sharpe Ratio for }\SpecialCharTok{\{}\NormalTok{i}\SpecialCharTok{\}}\SpecialStringTok{:}\CharTok{\textbackslash{}t}\SpecialStringTok{ }\SpecialCharTok{\{}\NormalTok{sharpe\_i}\SpecialCharTok{:0.2f\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Sharpe Ratio for AAPL:   0.86
Sharpe Ratio for AMZN:   0.48
Sharpe Ratio for F:  0.42
Sharpe Ratio for META:   0.49
Sharpe Ratio for TSLA:   1.12
\end{verbatim}

We can also use pandas notation to vectorize this calculation. First
calculate \emph{excess} returns as \(r_i - r_f\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s\_excess }\OperatorTok{=}\NormalTok{ returns\_2020s.sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{).dropna()}
\end{Highlighting}
\end{Shaded}

Then use pandas notation to calculate means, standard deviations, and
annualize.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    returns\_2020s\_excess}
\NormalTok{    .mean()}
\NormalTok{    .div(returns\_2020s\_excess.std())}
\NormalTok{    .mul(np.sqrt(}\DecValTok{252}\NormalTok{))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.8576
AMZN   0.4750
F      0.4240
META   0.4949
TSLA   1.1212
dtype: float64
\end{verbatim}

\textbf{\emph{Note:}} In a few weeks we will learn the \texttt{.apply()}
method, which avoids the loop syntax.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s.}\BuiltInTok{apply}\NormalTok{(calc\_sharpe)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.8576
AMZN   0.4750
F      0.4240
META   0.4949
TSLA   1.1212
dtype: float64
\end{verbatim}

\subsection{Calculate the market betas for these stocks in the
2020s}\label{calculate-the-market-betas-for-these-stocks-in-the-2020s-1}

How good were your guesses?

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ returns\_2020s:}
\NormalTok{    beta\_i }\OperatorTok{=}\NormalTok{ returns\_2020s[i].pipe(calc\_beta)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}Beta for }\SpecialCharTok{\{}\NormalTok{i}\SpecialCharTok{\}}\SpecialStringTok{:}\CharTok{\textbackslash{}t}\SpecialStringTok{ }\SpecialCharTok{\{}\NormalTok{beta\_i}\SpecialCharTok{:0.2f\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Beta for AAPL:   1.15
Beta for AMZN:   1.04
Beta for F:  1.22
Beta for META:   1.27
Beta for TSLA:   1.58
\end{verbatim}

Or we can follow out approach above to vectorize this calculation.
First, we need to add a market excess return column to
\texttt{returns\_2020s\_excess}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s\_excess[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ ff[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{]}
\NormalTok{returns\_2020s\_excess.head()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& AAPL & AMZN & F & META & TSLA & Mkt-RF \\
Date & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2020-01-02 & 0.0228 & 0.0271 & 0.0128 & 0.0220 & 0.0285 & 0.0086 \\
2020-01-03 & -0.0098 & -0.0122 & -0.0224 & -0.0054 & 0.0296 & -0.0067 \\
2020-01-06 & 0.0079 & 0.0148 & -0.0055 & 0.0188 & 0.0192 & 0.0036 \\
2020-01-07 & -0.0048 & 0.0020 & 0.0098 & 0.0021 & 0.0387 & -0.0019 \\
2020-01-08 & 0.0160 & -0.0079 & -0.0001 & 0.0101 & 0.0491 & 0.0047 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vcv }\OperatorTok{=}\NormalTok{ returns\_2020s\_excess.cov()}
\NormalTok{vcv}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& AAPL & AMZN & F & META & TSLA & Mkt-RF \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
AAPL & 0.0004 & 0.0003 & 0.0002 & 0.0004 & 0.0005 & 0.0003 \\
AMZN & 0.0003 & 0.0006 & 0.0002 & 0.0004 & 0.0005 & 0.0002 \\
F & 0.0002 & 0.0002 & 0.0009 & 0.0003 & 0.0005 & 0.0003 \\
META & 0.0004 & 0.0004 & 0.0003 & 0.0009 & 0.0005 & 0.0003 \\
TSLA & 0.0005 & 0.0005 & 0.0005 & 0.0005 & 0.0018 & 0.0003 \\
Mkt-RF & 0.0003 & 0.0002 & 0.0003 & 0.0003 & 0.0003 & 0.0002 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vcv[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{].div(vcv.loc[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{]).plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}CAPM Beta\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}CAPM Betas\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_01_practice_03_files/figure-pdf/cell-39-output-1.png}

\textbf{\emph{Note:}} In a few weeks we will learn the \texttt{.apply()}
method, which avoids the loop syntax.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s.}\BuiltInTok{apply}\NormalTok{(calc\_beta)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   1.1541
AMZN   1.0429
F      1.2231
META   1.2710
TSLA   1.5780
dtype: float64
\end{verbatim}

\subsection{\texorpdfstring{Calculate the Sharpe Ratio for an
\emph{equally weighted} portfolio of these stocks in the
2020s}{Calculate the Sharpe Ratio for an equally weighted portfolio of these stocks in the 2020s}}\label{calculate-the-sharpe-ratio-for-an-equally-weighted-portfolio-of-these-stocks-in-the-2020s-1}

What do you notice?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s.mean(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{).pipe(calc\_sharpe)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.9573
\end{verbatim}

Because diversification reduces portfolio standard deviation less than
the sum of its parts, the Sharpe Ratio of the equally weighted portfolio
is less than the equally weighted mean of the single-stock Sharpe
Ratios.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s.}\BuiltInTok{apply}\NormalTok{(calc\_sharpe).mean()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.6745
\end{verbatim}

\subsection{\texorpdfstring{Calculate the market beta for an
\emph{equally weighted} portfolio of these stocks in the
2020s}{Calculate the market beta for an equally weighted portfolio of these stocks in the 2020s}}\label{calculate-the-market-beta-for-an-equally-weighted-portfolio-of-these-stocks-in-the-2020s-1}

What do you notice?

Beta measures \emph{non}diversifiable risk, so
\(\beta_P = \sum w_i \beta_i\)!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s.mean(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{).pipe(calc\_beta)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.2538
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s.}\BuiltInTok{apply}\NormalTok{(calc\_beta).mean()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.2538
\end{verbatim}

\subsection{Calculate the market betas for these stocks every calendar
year for every possible
year}\label{calculate-the-market-betas-for-these-stocks-every-calendar-year-for-every-possible-year-1}

Save these market betas to data frame \texttt{betas}. Our current Python
knowledge limits us to a for-loop, but we will learn easier and faster
approaches soon!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{betas }\OperatorTok{=}\NormalTok{ pd.DataFrame(}
\NormalTok{    index}\OperatorTok{=}\BuiltInTok{range}\NormalTok{(}\DecValTok{1972}\NormalTok{, }\DecValTok{2024}\NormalTok{),}
\NormalTok{    columns}\OperatorTok{=}\NormalTok{returns.columns}
\NormalTok{)}

\NormalTok{betas.columns.name }\OperatorTok{=} \StringTok{\textquotesingle{}Ticker\textquotesingle{}}
\NormalTok{betas.index.name }\OperatorTok{=} \StringTok{\textquotesingle{}Year\textquotesingle{}}

\NormalTok{betas.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
Ticker & AAPL & AMZN & F & META & TSLA \\
Year & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2019 & NaN & NaN & NaN & NaN & NaN \\
2020 & NaN & NaN & NaN & NaN & NaN \\
2021 & NaN & NaN & NaN & NaN & NaN \\
2022 & NaN & NaN & NaN & NaN & NaN \\
2023 & NaN & NaN & NaN & NaN & NaN \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ betas.index: }
    \ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ betas.columns:}
\NormalTok{        betas.at[i, c] }\OperatorTok{=}\NormalTok{ returns.loc[}\BuiltInTok{str}\NormalTok{(i), c].pipe(calc\_beta)}

\NormalTok{betas.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
Ticker & AAPL & AMZN & F & META & TSLA \\
Year & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2019 & 1.4751 & 1.2752 & 1.0733 & 1.2094 & 1.3262 \\
2020 & 1.1174 & 0.6866 & 1.1052 & 0.9913 & 1.3041 \\
2021 & 1.1957 & 0.9822 & 1.2396 & 1.2014 & 1.9891 \\
2022 & 1.2386 & 1.5922 & 1.3824 & 1.6843 & 1.7414 \\
2023 & 1.0369 & 1.4649 & 1.3947 & 1.6630 & 2.2218 \\
\end{longtable}

\subsection{Plot the time series of market
betas}\label{plot-the-time-series-of-market-betas-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{betas.plot()}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}CAPM Beta\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}CAPM Betas\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_01_practice_03_files/figure-pdf/cell-47-output-1.png}

\chapter{Herron Topic 1 - Practice for Section
04}\label{herron-topic-1---practice-for-section-04}

\section{Announcements}\label{announcements-18}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  DataCamp

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    \emph{Data Manipulation with pandas} due by Friday, 2/9, at 11:59 PM
  \item
    \emph{Joining Data with pandas} due by Friday, 2/16, at 11:59 PM
  \item
    \emph{Earn 10,000 XP} due by Friday, 3/15, at 11:59 PM
  \end{enumerate}
\item
  I posted Project 1 to Canvas

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Slides and notebook due by Friday, 2/23, at 11:59 PM
  \item
    Keep joining teams and let me know if you need help
  \end{enumerate}
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-17}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.expm1(np.log1p(}\FloatTok{0.1}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.1000
\end{verbatim}

First, we will use two packages to download data from the web:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \texttt{yfinance} for Yahoo! Finance data
\item
  \texttt{pandas-datareader} for Ken French data (or FRED data to
  others)
\end{enumerate}

Second, there are ``simple returns'' and ``log returns''

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Simple returns are the returns that investors receive that we learned
  in FINA 6331 and FINA 6333:
  \(r_t = \frac{p_t + d_t - p_{t-1}}{p_{t-1}}\)
\item
  Log returns are the log of one plus simple returns. Why do we use
  them?

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    \textbf{\emph{Log returns are additive}}, while simple returns are
    multiplicative. This additive property makes math really easy with
    log returns:
    \(\log(\prod_{t=0}^T (1 + r_t)) = \sum_{t=0}^T \log(1+r_t)\), so
    \(r_{0,T} = \prod_{t=0}^T (1 + r_t) - 1 = e^{\sum_{t=0}^T \log(1+r_t)} - 1\)
  \item
    \textbf{\emph{Log returns are almost normally distributed}}
  \end{enumerate}
\end{enumerate}

\textbf{\emph{We will almost always use simple returns.}} The exeception
is time-consuming calculations, which we will often do in log returns to
save us time.

Third, we can calculate portfolio returns easily in pandas!

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \texttt{returns.mean(axis=1)} is the return on an equally-weighted
  portfolio, \textbf{\emph{rebalanced at the same frequency as the
  returns in \texttt{returns}!}}
\item
  \texttt{returns.dot(weights)} is the return on a portfolio weighted
  according to the weights in the \texttt{weights} array,
  \textbf{\emph{still rebalanced at the same frequency as the returns in
  \texttt{returns}!}}
\end{enumerate}

\section{Practice}\label{practice-18}

\subsection{\texorpdfstring{Download all available daily price data for
tickers TSLA, F, AAPL, AMZN, and META to data frame
\texttt{prices}}{Download all available daily price data for tickers TSLA, F, AAPL, AMZN, and META to data frame prices}}\label{download-all-available-daily-price-data-for-tickers-tsla-f-aapl-amzn-and-meta-to-data-frame-prices-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tickers }\OperatorTok{=} \StringTok{\textquotesingle{}TSLA F AAPL AMZN META\textquotesingle{}}
\NormalTok{prices }\OperatorTok{=}\NormalTok{ yf.download(tickers}\OperatorTok{=}\NormalTok{tickers)}

\NormalTok{prices}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  5 of 5 completed
\end{verbatim}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
& \multicolumn{5}{l}{%
Adj Close} & \multicolumn{5}{l}{%
Close} & ... & \multicolumn{5}{l}{%
Open} & \multicolumn{5}{l@{}}{%
Volume} \\
& AAPL & AMZN & F & META & TSLA & AAPL & AMZN & F & META & TSLA & ... &
AAPL & AMZN & F & META & TSLA & AAPL & AMZN & F & META & TSLA \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1972-06-01 & NaN & NaN & 0.2419 & NaN & NaN & NaN & NaN & 2.1532 & NaN &
NaN & ... & NaN & NaN & 0.0000 & NaN & NaN & NaN & NaN & 1091238 & NaN &
NaN \\
1972-06-02 & NaN & NaN & 0.2414 & NaN & NaN & NaN & NaN & 2.1492 & NaN &
NaN & ... & NaN & NaN & 2.1532 & NaN & NaN & NaN & NaN & 1174468 & NaN &
NaN \\
1972-06-05 & NaN & NaN & 0.2414 & NaN & NaN & NaN & NaN & 2.1492 & NaN &
NaN & ... & NaN & NaN & 2.1492 & NaN & NaN & NaN & NaN & 5209582 & NaN &
NaN \\
1972-06-06 & NaN & NaN & 0.2387 & NaN & NaN & NaN & NaN & 2.1248 & NaN &
NaN & ... & NaN & NaN & 2.1492 & NaN & NaN & NaN & NaN & 1424158 & NaN &
NaN \\
1972-06-07 & NaN & NaN & 0.2373 & NaN & NaN & NaN & NaN & 2.1127 & NaN &
NaN & ... & NaN & NaN & 2.1248 & NaN & NaN & NaN & NaN & 675088 & NaN &
NaN \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2024-02-05 & 187.6800 & 170.3100 & 11.5900 & 459.4100 & 181.0600 &
187.6800 & 170.3100 & 11.5900 & 459.4100 & 181.0600 & ... & 188.1500 &
170.2000 & 12.0100 & 469.8800 & 184.2600 & 69668800.0000 & 55081300.0000
& 81026800 & 40832400.0000 & 134294400.0000 \\
2024-02-06 & 189.3000 & 169.1500 & 12.0700 & 454.7200 & 185.1000 &
189.3000 & 169.1500 & 12.0700 & 454.7200 & 185.1000 & ... & 186.8600 &
169.3900 & 11.6400 & 464.0000 & 177.2100 & 43490800.0000 & 42505500.0000
& 98636800 & 21655200.0000 & 122676000.0000 \\
2024-02-07 & 189.4100 & 170.5300 & 12.8000 & 469.5900 & 187.5800 &
189.4100 & 170.5300 & 12.8000 & 469.5900 & 187.5800 & ... & 190.6400 &
169.4800 & 12.7300 & 458.0000 & 188.1800 & 53439000.0000 & 47174100.0000
& 137224000 & 23066000.0000 & 111535200.0000 \\
2024-02-08 & 188.3200 & 169.8400 & 12.8300 & 470.0000 & 189.5600 &
188.3200 & 169.8400 & 12.8300 & 470.0000 & 189.5600 & ... & 189.3900 &
169.6500 & 12.8700 & 468.3200 & 189.0000 & 40962000.0000 & 42316500.0000
& 68653900 & 18815100.0000 & 83034000.0000 \\
2024-02-09 & 188.8500 & 174.4500 & 12.6800 & 468.1100 & 193.5700 &
188.8500 & 174.4500 & 12.6800 & 468.1100 & 193.5700 & ... & 188.6500 &
170.9000 & 12.8100 & 472.9500 & 190.1800 & 43728065.0000 & 56886544.0000
& 46925766 & 18159624.0000 & 84009121.0000 \\
\end{longtable}

\subsection{\texorpdfstring{Calculate all available daily returns and
save to data frame
\texttt{returns}}{Calculate all available daily returns and save to data frame returns}}\label{calculate-all-available-daily-returns-and-save-to-data-frame-returns-2}

\subsection{\texorpdfstring{Calculate all available daily returns and
save to data frame
\texttt{returns}}{Calculate all available daily returns and save to data frame returns}}\label{calculate-all-available-daily-returns-and-save-to-data-frame-returns-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    prices[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{] }\CommentTok{\# slice adj close}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\CommentTok{\# drop the last price because it might be intraday (i.e., not a close)}
\NormalTok{    .pct\_change() }\CommentTok{\# calculate simple returns}
\NormalTok{)}

\NormalTok{returns}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& AAPL & AMZN & F & META & TSLA \\
Date & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1972-06-01 & NaN & NaN & NaN & NaN & NaN \\
1972-06-02 & NaN & NaN & -0.0019 & NaN & NaN \\
1972-06-05 & NaN & NaN & 0.0000 & NaN & NaN \\
1972-06-06 & NaN & NaN & -0.0113 & NaN & NaN \\
1972-06-07 & NaN & NaN & -0.0057 & NaN & NaN \\
... & ... & ... & ... & ... & ... \\
2024-02-02 & -0.0054 & 0.0787 & 0.0033 & 0.2032 & -0.0050 \\
2024-02-05 & 0.0098 & -0.0087 & -0.0453 & -0.0328 & -0.0365 \\
2024-02-06 & 0.0086 & -0.0068 & 0.0414 & -0.0102 & 0.0223 \\
2024-02-07 & 0.0006 & 0.0082 & 0.0605 & 0.0327 & 0.0134 \\
2024-02-08 & -0.0058 & -0.0040 & 0.0023 & 0.0009 & 0.0106 \\
\end{longtable}

\subsection{\texorpdfstring{Slices returns for the 2020s and assign to
\texttt{returns\_2020s}}{Slices returns for the 2020s and assign to returns\_2020s}}\label{slices-returns-for-the-2020s-and-assign-to-returns_2020s-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s }\OperatorTok{=}\NormalTok{ returns.loc[}\StringTok{\textquotesingle{}2020\textquotesingle{}}\NormalTok{:] }\CommentTok{\# always use an unambiguos date format, like YYYY{-}MM{-}DD}

\NormalTok{returns\_2020s}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& AAPL & AMZN & F & META & TSLA \\
Date & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2020-01-02 & 0.0228 & 0.0272 & 0.0129 & 0.0221 & 0.0285 \\
2020-01-03 & -0.0097 & -0.0121 & -0.0223 & -0.0053 & 0.0296 \\
2020-01-06 & 0.0080 & 0.0149 & -0.0054 & 0.0188 & 0.0193 \\
2020-01-07 & -0.0047 & 0.0021 & 0.0098 & 0.0022 & 0.0388 \\
2020-01-08 & 0.0161 & -0.0078 & 0.0000 & 0.0101 & 0.0492 \\
... & ... & ... & ... & ... & ... \\
2024-02-02 & -0.0054 & 0.0787 & 0.0033 & 0.2032 & -0.0050 \\
2024-02-05 & 0.0098 & -0.0087 & -0.0453 & -0.0328 & -0.0365 \\
2024-02-06 & 0.0086 & -0.0068 & 0.0414 & -0.0102 & 0.0223 \\
2024-02-07 & 0.0006 & 0.0082 & 0.0605 & 0.0327 & 0.0134 \\
2024-02-08 & -0.0058 & -0.0040 & 0.0023 & 0.0009 & 0.0106 \\
\end{longtable}

\subsection{\texorpdfstring{Download all available data for the Fama and
French daily benchmark factors to dictionary
\texttt{ff\_all}}{Download all available data for the Fama and French daily benchmark factors to dictionary ff\_all}}\label{download-all-available-data-for-the-fama-and-french-daily-benchmark-factors-to-dictionary-ff_all-2}

I often use the following code snippet to find the exact name for the
the daily benchmark factors file.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pdr.famafrench.get\_available\_datasets()[:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['F-F_Research_Data_Factors',
 'F-F_Research_Data_Factors_weekly',
 'F-F_Research_Data_Factors_daily',
 'F-F_Research_Data_5_Factors_2x3',
 'F-F_Research_Data_5_Factors_2x3_daily']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_all }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_22508\2526882917.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_all = pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{type}\NormalTok{(ff\_all)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
dict
\end{verbatim}

The \texttt{DESCR} key in the dictionary tells us about the data frames
that \texttt{pandas-datareader} returns.

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(ff\_all[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
F-F Research Data Factors daily
-------------------------------

This file was created by CMPT_ME_BEME_RETS_DAILY using the 202312 CRSP database. The Tbill return is the simple daily rate that, over the number of trading days in the month, compounds to 1-month TBill rate from Ibbotson and Associates Inc. Copyright 2023 Kenneth R. French

  0 : (25649 rows x 4 cols)
\end{verbatim}

\subsection{\texorpdfstring{Slice the daily benchmark factors, convert
them to decimal returns, and assign to
\texttt{ff}}{Slice the daily benchmark factors, convert them to decimal returns, and assign to ff}}\label{slice-the-daily-benchmark-factors-convert-them-to-decimal-returns-and-assign-to-ff-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff }\OperatorTok{=}\NormalTok{ ff\_all[}\DecValTok{0}\NormalTok{].div(}\DecValTok{100}\NormalTok{)}

\NormalTok{ff}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& Mkt-RF & SMB & HML & RF \\
Date & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1926-07-01 & 0.0010 & -0.0025 & -0.0027 & 0.0001 \\
1926-07-02 & 0.0045 & -0.0033 & -0.0006 & 0.0001 \\
1926-07-06 & 0.0017 & 0.0030 & -0.0039 & 0.0001 \\
1926-07-07 & 0.0009 & -0.0058 & 0.0002 & 0.0001 \\
1926-07-08 & 0.0021 & -0.0038 & 0.0019 & 0.0001 \\
... & ... & ... & ... & ... \\
2023-12-22 & 0.0021 & 0.0064 & 0.0009 & 0.0002 \\
2023-12-26 & 0.0048 & 0.0069 & 0.0046 & 0.0002 \\
2023-12-27 & 0.0016 & 0.0014 & 0.0012 & 0.0002 \\
2023-12-28 & -0.0001 & -0.0036 & 0.0003 & 0.0002 \\
2023-12-29 & -0.0043 & -0.0112 & -0.0037 & 0.0002 \\
\end{longtable}

\subsection{\texorpdfstring{Use the \texttt{.cumprod()} method to plot
cumulative returns for these stocks in the
2020s}{Use the .cumprod() method to plot cumulative returns for these stocks in the 2020s}}\label{use-the-.cumprod-method-to-plot-cumulative-returns-for-these-stocks-in-the-2020s-2}

We use the \texttt{.prod()} method to calculate \emph{total} returns,
because
\(r_{total} = r_{0,T} = \left[ \prod_{t=0}^T (1 + r_t) \right] -1\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{totret }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    returns\_2020s }\CommentTok{\# returns during the 2020s}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{) }\CommentTok{\# add 1 before we compound}
\NormalTok{    .prod() }\CommentTok{\# compound all returns}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{) }\CommentTok{\# subtract 1 to recover total returns}
\NormalTok{)}

\NormalTok{totret}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   1.6331
AMZN   0.8383
F      0.6090
META   1.2899
TSLA   5.7970
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cumret\_cumprod }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    returns\_2020s }\CommentTok{\# returns during the 2020s}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{) }\CommentTok{\# add 1 before we compound}
\NormalTok{    .cumprod() }\CommentTok{\# compound all returns}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{) }\CommentTok{\# subtract 1 to recover total returns}
\NormalTok{)}

\NormalTok{cumret\_cumprod.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& AAPL & AMZN & F & META & TSLA \\
Date & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-02-02 & 1.5985 & 0.8596 & 0.5224 & 1.3142 & 5.7379 \\
2024-02-05 & 1.6241 & 0.8433 & 0.4535 & 1.2383 & 5.4922 \\
2024-02-06 & 1.6468 & 0.8308 & 0.5136 & 1.2154 & 5.6371 \\
2024-02-07 & 1.6483 & 0.8457 & 0.6052 & 1.2879 & 5.7260 \\
2024-02-08 & 1.6331 & 0.8383 & 0.6090 & 1.2899 & 5.7970 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(}
\NormalTok{    totret, }\CommentTok{\# total returns from 2020 through 2023 }
\NormalTok{    cumret\_cumprod.iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\CommentTok{\# cumulative returns on last day of 2023}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cumret\_cumprod.mul(}\DecValTok{100}\NormalTok{).plot()}

\CommentTok{\# https://stackoverflow.com/questions/25973581/how{-}to{-}format{-}axis{-}number{-}format{-}to{-}thousands{-}with{-}a{-}comma}
\ImportTok{from}\NormalTok{ matplotlib }\ImportTok{import}\NormalTok{ ticker}
\NormalTok{plt.gca().get\_yaxis().set\_major\_formatter(ticker.FuncFormatter(}\KeywordTok{lambda}\NormalTok{ x, p: }\BuiltInTok{format}\NormalTok{(}\BuiltInTok{int}\NormalTok{(x), }\StringTok{\textquotesingle{},\textquotesingle{}}\NormalTok{)))}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Cumulative Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Cumulative Returns}\CharTok{\textbackslash{}n}\SpecialStringTok{ from }\SpecialCharTok{\{}\NormalTok{returns\_2020s}\SpecialCharTok{.}\NormalTok{index}\SpecialCharTok{.}\BuiltInTok{min}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{returns\_2020s}\SpecialCharTok{.}\NormalTok{index}\SpecialCharTok{.}\BuiltInTok{max}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_01_practice_04_files/figure-pdf/cell-16-output-1.png}

\subsection{\texorpdfstring{Use the \texttt{.cumsum()} method with log
returns to plot cumulative returns for these stocks in the
2020s}{Use the .cumsum() method with log returns to plot cumulative returns for these stocks in the 2020s}}\label{use-the-.cumsum-method-with-log-returns-to-plot-cumulative-returns-for-these-stocks-in-the-2020s-2}

\textbf{\emph{The log of products is the sum of logs!}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cumret\_cumsum }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    returns\_2020s }\CommentTok{\# returns during the 2020s}
\NormalTok{    .pipe(np.log1p) }\CommentTok{\# convert simple returns to log returns}
\NormalTok{    .cumsum() }\CommentTok{\# compound all returns}
\NormalTok{    .pipe(np.expm1) }\CommentTok{\# convert log returns to simple returns}
\NormalTok{)}

\NormalTok{cumret\_cumsum.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& AAPL & AMZN & F & META & TSLA \\
Date & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-02-02 & 1.5985 & 0.8596 & 0.5224 & 1.3142 & 5.7379 \\
2024-02-05 & 1.6241 & 0.8433 & 0.4535 & 1.2383 & 5.4922 \\
2024-02-06 & 1.6468 & 0.8308 & 0.5136 & 1.2154 & 5.6371 \\
2024-02-07 & 1.6483 & 0.8457 & 0.6052 & 1.2879 & 5.7260 \\
2024-02-08 & 1.6331 & 0.8383 & 0.6090 & 1.2899 & 5.7970 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(cumret\_cumprod, cumret\_cumsum)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cumret\_cumsum.mul(}\DecValTok{100}\NormalTok{).plot()}

\CommentTok{\# https://stackoverflow.com/questions/25973581/how{-}to{-}format{-}axis{-}number{-}format{-}to{-}thousands{-}with{-}a{-}comma}
\ImportTok{from}\NormalTok{ matplotlib }\ImportTok{import}\NormalTok{ ticker}
\NormalTok{plt.gca().get\_yaxis().set\_major\_formatter(ticker.FuncFormatter(}\KeywordTok{lambda}\NormalTok{ x, p: }\BuiltInTok{format}\NormalTok{(}\BuiltInTok{int}\NormalTok{(x), }\StringTok{\textquotesingle{},\textquotesingle{}}\NormalTok{)))}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Cumulative Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Cumulative Returns}\CharTok{\textbackslash{}n}\SpecialStringTok{ from }\SpecialCharTok{\{}\NormalTok{returns\_2020s}\SpecialCharTok{.}\NormalTok{index}\SpecialCharTok{.}\BuiltInTok{min}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{returns\_2020s}\SpecialCharTok{.}\NormalTok{index}\SpecialCharTok{.}\BuiltInTok{max}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_01_practice_04_files/figure-pdf/cell-19-output-1.png}

\subsection{Use price data only to plot cumulative returns for these
stocks in the
2020s}\label{use-price-data-only-to-plot-cumulative-returns-for-these-stocks-in-the-2020s-2}

We can also calculate cumulative returns as the ratio of adjusted
closes. That is \(R_{0,T} = \frac{AC_T}{AC_0} - 1\). The trick here is
that \(FV_t = PV (1+r)^t\), so \((1+r)^t = \frac{FV_t}{PV}\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s.iloc[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.0228
AMZN   0.0272
F      0.0129
META   0.0221
TSLA   0.0285
Name: 2020-01-02 00:00:00, dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cumret\_prices }\OperatorTok{=}\NormalTok{ prices[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].loc[}\StringTok{\textquotesingle{}2020\textquotesingle{}}\NormalTok{:].iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{/}\NormalTok{ prices[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].loc[}\StringTok{\textquotesingle{}2019\textquotesingle{}}\NormalTok{].iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{{-}} \DecValTok{1}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(cumret\_prices, cumret\_cumprod)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\subsection{Calculate the Sharpe Ratio for
TSLA}\label{calculate-the-sharpe-ratio-for-tsla-2}

Calculate the Sharpe Ratio with all available returns and 2020s returns.
Recall the Sharpe Ratio is \(\frac{\overline{r_i - r_f}}{\sigma_i}\),
where \(\sigma_i\) is the volatility of \emph{excess} returns.

\textbf{\emph{I suggest you write a function named
\texttt{calc\_sharpe()} to use for the rest of this notebook.}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_sharpe(ri, rf}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], ppy}\OperatorTok{=}\DecValTok{252}\NormalTok{):}
\NormalTok{    ri\_rf }\OperatorTok{=}\NormalTok{ ri.sub(rf).dropna()}
    \ControlFlowTok{return}\NormalTok{ np.sqrt(ppy) }\OperatorTok{*}\NormalTok{ ri\_rf.mean() }\OperatorTok{/}\NormalTok{ ri\_rf.std()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(ri}\OperatorTok{=}\NormalTok{returns[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.9261
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(ri}\OperatorTok{=}\NormalTok{returns\_2020s[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.1212
\end{verbatim}

\textbf{\emph{Now we know about the \texttt{.pipe()} method, which lets
us ``convert'' functions into methods!}} We can use \texttt{.pipe()}
because \texttt{ri} is the first argument in \texttt{calc\_sharpe()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{].pipe(calc\_sharpe)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.9261
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{].pipe(calc\_sharpe)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.1212
\end{verbatim}

\subsection{Calculate the market beta for
TSLA}\label{calculate-the-market-beta-for-tsla-2}

Calculate the market beta with all available returns and 2020s returns.
Recall we estimate market beta with the ordinary least squares (OLS)
regression \(R_i-R_f = \alpha + \beta (R_m-R_f) + \epsilon\). We can
estimate market beta with the covariance formula (i.e.,
\(\beta_i = \frac{Cov(R_i - R_f, R_m - R_f)}{Var(R_m-R_f)}\)) above for
a univariate regression if we do not need goodness of fit statistics.

\textbf{\emph{I suggest you write a function named \texttt{calc\_beta()}
to use for the rest of this notebook.}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_beta(ri, rf}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], rm\_rf}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{]):}
\NormalTok{    ri\_rf }\OperatorTok{=}\NormalTok{ ri.sub(rf).dropna()}
    \ControlFlowTok{return}\NormalTok{ ri\_rf.cov(rm\_rf) }\OperatorTok{/}\NormalTok{ rm\_rf.loc[ri\_rf.index].var()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_beta(ri}\OperatorTok{=}\NormalTok{returns[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.4417
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_beta(ri}\OperatorTok{=}\NormalTok{returns\_2020s[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.5780
\end{verbatim}

\subsection{Guess the Sharpe Ratios for these stocks in the
2020s}\label{guess-the-sharpe-ratios-for-these-stocks-in-the-2020s-2}

\subsection{Guess the market betas for these stocks in the
2020s}\label{guess-the-market-betas-for-these-stocks-in-the-2020s-2}

\subsection{Calculate the Sharpe Ratios for these stocks in the
2020s}\label{calculate-the-sharpe-ratios-for-these-stocks-in-the-2020s-2}

How good were your guesses?

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ returns\_2020s:}
\NormalTok{    sharpe\_i }\OperatorTok{=}\NormalTok{ returns\_2020s[i].pipe(calc\_sharpe)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}Sharpe Ratio for }\SpecialCharTok{\{}\NormalTok{i}\SpecialCharTok{\}}\SpecialStringTok{:}\CharTok{\textbackslash{}t}\SpecialStringTok{ }\SpecialCharTok{\{}\NormalTok{sharpe\_i}\SpecialCharTok{:0.2f\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Sharpe Ratio for AAPL:   0.86
Sharpe Ratio for AMZN:   0.48
Sharpe Ratio for F:  0.42
Sharpe Ratio for META:   0.49
Sharpe Ratio for TSLA:   1.12
\end{verbatim}

We can also use pandas notation to vectorize this calculation. First
calculate \emph{excess} returns as \(r_i - r_f\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s\_excess }\OperatorTok{=}\NormalTok{ returns\_2020s.sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{).dropna()}
\end{Highlighting}
\end{Shaded}

Then use pandas notation to calculate means, standard deviations, and
annualize.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    returns\_2020s\_excess}
\NormalTok{    .mean()}
\NormalTok{    .div(returns\_2020s\_excess.std())}
\NormalTok{    .mul(np.sqrt(}\DecValTok{252}\NormalTok{))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.8576
AMZN   0.4750
F      0.4240
META   0.4949
TSLA   1.1212
dtype: float64
\end{verbatim}

\textbf{\emph{Note:}} In a few weeks we will learn the \texttt{.apply()}
method, which avoids the loop syntax.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s.}\BuiltInTok{apply}\NormalTok{(calc\_sharpe)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.8576
AMZN   0.4750
F      0.4240
META   0.4949
TSLA   1.1212
dtype: float64
\end{verbatim}

\subsection{Calculate the market betas for these stocks in the
2020s}\label{calculate-the-market-betas-for-these-stocks-in-the-2020s-2}

How good were your guesses?

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ returns\_2020s:}
\NormalTok{    beta\_i }\OperatorTok{=}\NormalTok{ returns\_2020s[i].pipe(calc\_beta)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}Beta for }\SpecialCharTok{\{}\NormalTok{i}\SpecialCharTok{\}}\SpecialStringTok{:}\CharTok{\textbackslash{}t}\SpecialStringTok{ }\SpecialCharTok{\{}\NormalTok{beta\_i}\SpecialCharTok{:0.2f\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Beta for AAPL:   1.15
Beta for AMZN:   1.04
Beta for F:  1.22
Beta for META:   1.27
Beta for TSLA:   1.58
\end{verbatim}

Or we can follow out approach above to vectorize this calculation.
First, we need to add a market excess return column to
\texttt{returns\_2020s\_excess}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s\_excess[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ ff[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{]}
\NormalTok{returns\_2020s\_excess.head()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& AAPL & AMZN & F & META & TSLA & Mkt-RF \\
Date & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2020-01-02 & 0.0228 & 0.0271 & 0.0128 & 0.0220 & 0.0285 & 0.0086 \\
2020-01-03 & -0.0098 & -0.0122 & -0.0224 & -0.0054 & 0.0296 & -0.0067 \\
2020-01-06 & 0.0079 & 0.0148 & -0.0055 & 0.0188 & 0.0192 & 0.0036 \\
2020-01-07 & -0.0048 & 0.0020 & 0.0098 & 0.0021 & 0.0387 & -0.0019 \\
2020-01-08 & 0.0160 & -0.0079 & -0.0001 & 0.0101 & 0.0491 & 0.0047 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vcv }\OperatorTok{=}\NormalTok{ returns\_2020s\_excess.cov()}
\NormalTok{vcv}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& AAPL & AMZN & F & META & TSLA & Mkt-RF \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
AAPL & 0.0004 & 0.0003 & 0.0002 & 0.0004 & 0.0005 & 0.0003 \\
AMZN & 0.0003 & 0.0006 & 0.0002 & 0.0004 & 0.0005 & 0.0002 \\
F & 0.0002 & 0.0002 & 0.0009 & 0.0003 & 0.0005 & 0.0003 \\
META & 0.0004 & 0.0004 & 0.0003 & 0.0009 & 0.0005 & 0.0003 \\
TSLA & 0.0005 & 0.0005 & 0.0005 & 0.0005 & 0.0018 & 0.0003 \\
Mkt-RF & 0.0003 & 0.0002 & 0.0003 & 0.0003 & 0.0003 & 0.0002 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vcv[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{].div(vcv.loc[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{]).plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}CAPM Beta\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}CAPM Betas\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_01_practice_04_files/figure-pdf/cell-39-output-1.png}

\textbf{\emph{Note:}} In a few weeks we will learn the \texttt{.apply()}
method, which avoids the loop syntax.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s.}\BuiltInTok{apply}\NormalTok{(calc\_beta)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   1.1541
AMZN   1.0429
F      1.2231
META   1.2710
TSLA   1.5780
dtype: float64
\end{verbatim}

\subsection{\texorpdfstring{Calculate the Sharpe Ratio for an
\emph{equally weighted} portfolio of these stocks in the
2020s}{Calculate the Sharpe Ratio for an equally weighted portfolio of these stocks in the 2020s}}\label{calculate-the-sharpe-ratio-for-an-equally-weighted-portfolio-of-these-stocks-in-the-2020s-2}

What do you notice?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s.mean(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{).pipe(calc\_sharpe)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.9573
\end{verbatim}

Because diversification reduces portfolio standard deviation less than
the sum of its parts, the Sharpe Ratio of the equally weighted portfolio
is less than the equally weighted mean of the single-stock Sharpe
Ratios.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s.}\BuiltInTok{apply}\NormalTok{(calc\_sharpe).mean()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.6745
\end{verbatim}

\subsection{\texorpdfstring{Calculate the market beta for an
\emph{equally weighted} portfolio of these stocks in the
2020s}{Calculate the market beta for an equally weighted portfolio of these stocks in the 2020s}}\label{calculate-the-market-beta-for-an-equally-weighted-portfolio-of-these-stocks-in-the-2020s-2}

What do you notice?

Beta measures \emph{non}diversifiable risk, so
\(\beta_P = \sum w_i \beta_i\)!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s.mean(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{).pipe(calc\_beta)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.2538
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s.}\BuiltInTok{apply}\NormalTok{(calc\_beta).mean()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.2538
\end{verbatim}

\subsection{Calculate the market betas for these stocks every calendar
year for every possible
year}\label{calculate-the-market-betas-for-these-stocks-every-calendar-year-for-every-possible-year-2}

Save these market betas to data frame \texttt{betas}. Our current Python
knowledge limits us to a for-loop, but we will learn easier and faster
approaches soon!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{betas }\OperatorTok{=}\NormalTok{ pd.DataFrame(}
\NormalTok{    index}\OperatorTok{=}\BuiltInTok{range}\NormalTok{(}\DecValTok{1972}\NormalTok{, }\DecValTok{2024}\NormalTok{),}
\NormalTok{    columns}\OperatorTok{=}\NormalTok{returns.columns}
\NormalTok{)}

\NormalTok{betas.columns.name }\OperatorTok{=} \StringTok{\textquotesingle{}Ticker\textquotesingle{}}
\NormalTok{betas.index.name }\OperatorTok{=} \StringTok{\textquotesingle{}Year\textquotesingle{}}

\NormalTok{betas.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
Ticker & AAPL & AMZN & F & META & TSLA \\
Year & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2019 & NaN & NaN & NaN & NaN & NaN \\
2020 & NaN & NaN & NaN & NaN & NaN \\
2021 & NaN & NaN & NaN & NaN & NaN \\
2022 & NaN & NaN & NaN & NaN & NaN \\
2023 & NaN & NaN & NaN & NaN & NaN \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ betas.index: }
    \ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ betas.columns:}
\NormalTok{        betas.at[i, c] }\OperatorTok{=}\NormalTok{ returns.loc[}\BuiltInTok{str}\NormalTok{(i), c].pipe(calc\_beta)}

\NormalTok{betas.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
Ticker & AAPL & AMZN & F & META & TSLA \\
Year & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2019 & 1.4751 & 1.2752 & 1.0733 & 1.2094 & 1.3262 \\
2020 & 1.1174 & 0.6866 & 1.1052 & 0.9913 & 1.3041 \\
2021 & 1.1957 & 0.9822 & 1.2396 & 1.2014 & 1.9891 \\
2022 & 1.2386 & 1.5922 & 1.3824 & 1.6843 & 1.7414 \\
2023 & 1.0369 & 1.4649 & 1.3947 & 1.6630 & 2.2218 \\
\end{longtable}

\subsection{Plot the time series of market
betas}\label{plot-the-time-series-of-market-betas-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{betas.plot()}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}CAPM Beta\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}CAPM Betas\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_01_practice_04_files/figure-pdf/cell-47-output-1.png}

\chapter{Herron Topic 1 - Practice for Section
05}\label{herron-topic-1---practice-for-section-05}

\section{Announcements}\label{announcements-19}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  DataCamp

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    \emph{Data Manipulation with pandas} due by Friday, 2/9, at 11:59 PM
  \item
    \emph{Joining Data with pandas} due by Friday, 2/16, at 11:59 PM
  \item
    \emph{Earn 10,000 XP} due by Friday, 3/15, at 11:59 PM
  \end{enumerate}
\item
  I posted Project 1 to Canvas

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Slides and notebook due by Friday, 2/23, at 11:59 PM
  \item
    Keep joining teams and let me know if you need help
  \end{enumerate}
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-18}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

First, we will use two packages to download data from the Web:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \texttt{yfinance} for Yahoo! Finance
\item
  \texttt{pandas-datareader} for Ken French (and FRED and many others)
\end{enumerate}

Second, there are ``simple returns'' and ``log returns''

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Simple returns are the returns that investors receive that we learned
  in FINA 6331 and FINA 6333:
  \(r_t = \frac{p_t + d_t - p_{t-1}}{p_{t-1}}\)
\item
  Log returns are the log of one plus simple returns. Why do we use
  them?

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    \textbf{\emph{Log returns are additive}}, while simple returns are
    multiplicative. This additive property makes math really easy with
    log returns:
    \(\log(\prod_{t=0}^T (1 + r_t)) = \sum_{t=0}^T \log(1+r_t)\), so
    \(r_{0,T} = \prod_{t=0}^T (1 + r_t) - 1 = e^{\sum_{t=0}^T \log(1+r_t)} - 1\)
  \item
    \textbf{\emph{Log returns are almost normally distributed}}
  \end{enumerate}
\end{enumerate}

\textbf{\emph{We will almost always use simple returns.}} The exeception
is time-consuming calculations, which we will often do in log returns to
save us time.

Third, we can calculate portfolio returns a few ways!

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \texttt{returns.mean(axis=1)} is \emph{equally-weighted} portfolio
  returns, rebalanced at the same frequency as the returns (i.e.,
  rebalanced every return period)
\item
  \texttt{returns.dot(weights)} lets us use any weights in the
  \texttt{weights} array, rebalanced at the same frequency as the
  returns
\end{enumerate}

\section{Practice}\label{practice-19}

\subsection{\texorpdfstring{Download all available daily price data for
tickers TSLA, F, AAPL, AMZN, and META to data frame
\texttt{prices}}{Download all available daily price data for tickers TSLA, F, AAPL, AMZN, and META to data frame prices}}\label{download-all-available-daily-price-data-for-tickers-tsla-f-aapl-amzn-and-meta-to-data-frame-prices-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tickers }\OperatorTok{=} \StringTok{\textquotesingle{}TSLA F AAPL AMZN META\textquotesingle{}}
\NormalTok{prices }\OperatorTok{=}\NormalTok{ yf.download(tickers}\OperatorTok{=}\NormalTok{tickers)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  5 of 5 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices.head()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
& \multicolumn{5}{l}{%
Adj Close} & \multicolumn{5}{l}{%
Close} & ... & \multicolumn{5}{l}{%
Open} & \multicolumn{5}{l@{}}{%
Volume} \\
& AAPL & AMZN & F & META & TSLA & AAPL & AMZN & F & META & TSLA & ... &
AAPL & AMZN & F & META & TSLA & AAPL & AMZN & F & META & TSLA \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1972-06-01 & NaN & NaN & 0.2419 & NaN & NaN & NaN & NaN & 2.1532 & NaN &
NaN & ... & NaN & NaN & 0.0000 & NaN & NaN & NaN & NaN & 1091238 & NaN &
NaN \\
1972-06-02 & NaN & NaN & 0.2414 & NaN & NaN & NaN & NaN & 2.1492 & NaN &
NaN & ... & NaN & NaN & 2.1532 & NaN & NaN & NaN & NaN & 1174468 & NaN &
NaN \\
1972-06-05 & NaN & NaN & 0.2414 & NaN & NaN & NaN & NaN & 2.1492 & NaN &
NaN & ... & NaN & NaN & 2.1492 & NaN & NaN & NaN & NaN & 5209582 & NaN &
NaN \\
1972-06-06 & NaN & NaN & 0.2387 & NaN & NaN & NaN & NaN & 2.1248 & NaN &
NaN & ... & NaN & NaN & 2.1492 & NaN & NaN & NaN & NaN & 1424158 & NaN &
NaN \\
1972-06-07 & NaN & NaN & 0.2373 & NaN & NaN & NaN & NaN & 2.1127 & NaN &
NaN & ... & NaN & NaN & 2.1248 & NaN & NaN & NaN & NaN & 675088 & NaN &
NaN \\
\end{longtable}

\subsection{\texorpdfstring{Calculate all available daily returns and
save to data frame
\texttt{returns}}{Calculate all available daily returns and save to data frame returns}}\label{calculate-all-available-daily-returns-and-save-to-data-frame-returns-4}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    prices[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{] }\CommentTok{\# slice adj close}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\CommentTok{\# drop the last price because it might be intraday (i.e., not a close)}
\NormalTok{    .pct\_change() }\CommentTok{\# calculate simple returns}
\NormalTok{)}

\NormalTok{returns}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& AAPL & AMZN & F & META & TSLA \\
Date & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1972-06-01 & NaN & NaN & NaN & NaN & NaN \\
1972-06-02 & NaN & NaN & -0.0019 & NaN & NaN \\
1972-06-05 & NaN & NaN & 0.0000 & NaN & NaN \\
1972-06-06 & NaN & NaN & -0.0113 & NaN & NaN \\
1972-06-07 & NaN & NaN & -0.0057 & NaN & NaN \\
... & ... & ... & ... & ... & ... \\
2024-02-02 & -0.0054 & 0.0787 & 0.0033 & 0.2032 & -0.0050 \\
2024-02-05 & 0.0098 & -0.0087 & -0.0453 & -0.0328 & -0.0365 \\
2024-02-06 & 0.0086 & -0.0068 & 0.0414 & -0.0102 & 0.0223 \\
2024-02-07 & 0.0006 & 0.0082 & 0.0605 & 0.0327 & 0.0134 \\
2024-02-08 & -0.0058 & -0.0040 & 0.0023 & 0.0009 & 0.0106 \\
\end{longtable}

\subsection{\texorpdfstring{Slices returns for the 2020s and assign to
\texttt{returns\_2020s}}{Slices returns for the 2020s and assign to returns\_2020s}}\label{slices-returns-for-the-2020s-and-assign-to-returns_2020s-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s }\OperatorTok{=}\NormalTok{ returns.loc[}\StringTok{\textquotesingle{}2020\textquotesingle{}}\NormalTok{:] }\CommentTok{\# always use an unambiguos date format, like YYYY{-}MM{-}DD}

\NormalTok{returns\_2020s}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& AAPL & AMZN & F & META & TSLA \\
Date & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2020-01-02 & 0.0228 & 0.0272 & 0.0129 & 0.0221 & 0.0285 \\
2020-01-03 & -0.0097 & -0.0121 & -0.0223 & -0.0053 & 0.0296 \\
2020-01-06 & 0.0080 & 0.0149 & -0.0054 & 0.0188 & 0.0193 \\
2020-01-07 & -0.0047 & 0.0021 & 0.0098 & 0.0022 & 0.0388 \\
2020-01-08 & 0.0161 & -0.0078 & 0.0000 & 0.0101 & 0.0492 \\
... & ... & ... & ... & ... & ... \\
2024-02-02 & -0.0054 & 0.0787 & 0.0033 & 0.2032 & -0.0050 \\
2024-02-05 & 0.0098 & -0.0087 & -0.0453 & -0.0328 & -0.0365 \\
2024-02-06 & 0.0086 & -0.0068 & 0.0414 & -0.0102 & 0.0223 \\
2024-02-07 & 0.0006 & 0.0082 & 0.0605 & 0.0327 & 0.0134 \\
2024-02-08 & -0.0058 & -0.0040 & 0.0023 & 0.0009 & 0.0106 \\
\end{longtable}

\subsection{\texorpdfstring{Download all available data for the Fama and
French daily benchmark factors to dictionary
\texttt{ff\_all}}{Download all available data for the Fama and French daily benchmark factors to dictionary ff\_all}}\label{download-all-available-data-for-the-fama-and-french-daily-benchmark-factors-to-dictionary-ff_all-3}

I often use the following code snippet to find the exact name for the
the daily benchmark factors file.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pdr.famafrench.get\_available\_datasets()[:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['F-F_Research_Data_Factors',
 'F-F_Research_Data_Factors_weekly',
 'F-F_Research_Data_Factors_daily',
 'F-F_Research_Data_5_Factors_2x3',
 'F-F_Research_Data_5_Factors_2x3_daily']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_all }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}} \CommentTok{\# most data start in 1926{-}07{-}01, but 1900 is easier to remember and type}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27720\4231759426.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_all = pdr.DataReader(
\end{verbatim}

The \texttt{DESCR} key in the dictionary tells us about the data frames
that \texttt{pandas-datareader} returns.

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(ff\_all[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
F-F Research Data Factors daily
-------------------------------

This file was created by CMPT_ME_BEME_RETS_DAILY using the 202312 CRSP database. The Tbill return is the simple daily rate that, over the number of trading days in the month, compounds to 1-month TBill rate from Ibbotson and Associates Inc. Copyright 2023 Kenneth R. French

  0 : (25649 rows x 4 cols)
\end{verbatim}

\subsection{\texorpdfstring{Slice the daily benchmark factors, convert
them to decimal returns, and assign to
\texttt{ff}}{Slice the daily benchmark factors, convert them to decimal returns, and assign to ff}}\label{slice-the-daily-benchmark-factors-convert-them-to-decimal-returns-and-assign-to-ff-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff }\OperatorTok{=}\NormalTok{ ff\_all[}\DecValTok{0}\NormalTok{].div(}\DecValTok{100}\NormalTok{)}

\NormalTok{ff}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& Mkt-RF & SMB & HML & RF \\
Date & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1926-07-01 & 0.0010 & -0.0025 & -0.0027 & 0.0001 \\
1926-07-02 & 0.0045 & -0.0033 & -0.0006 & 0.0001 \\
1926-07-06 & 0.0017 & 0.0030 & -0.0039 & 0.0001 \\
1926-07-07 & 0.0009 & -0.0058 & 0.0002 & 0.0001 \\
1926-07-08 & 0.0021 & -0.0038 & 0.0019 & 0.0001 \\
... & ... & ... & ... & ... \\
2023-12-22 & 0.0021 & 0.0064 & 0.0009 & 0.0002 \\
2023-12-26 & 0.0048 & 0.0069 & 0.0046 & 0.0002 \\
2023-12-27 & 0.0016 & 0.0014 & 0.0012 & 0.0002 \\
2023-12-28 & -0.0001 & -0.0036 & 0.0003 & 0.0002 \\
2023-12-29 & -0.0043 & -0.0112 & -0.0037 & 0.0002 \\
\end{longtable}

\subsection{\texorpdfstring{Use the \texttt{.cumprod()} method to plot
cumulative returns for these stocks in the
2020s}{Use the .cumprod() method to plot cumulative returns for these stocks in the 2020s}}\label{use-the-.cumprod-method-to-plot-cumulative-returns-for-these-stocks-in-the-2020s-3}

We use the \texttt{.prod()} method to calculate \emph{total} returns,
because
\(r_{total} = r_{0,T} = \left[ \prod_{t=0}^T (1 + r_t) \right] -1\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    returns\_2020s }\CommentTok{\# returns during the 2020s}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{) }\CommentTok{\# add 1 before we compound}
\NormalTok{    .prod() }\CommentTok{\# compound all returns}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{) }\CommentTok{\# subtract 1 to recover total returns}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   1.6331
AMZN   0.8383
F      0.6090
META   1.2899
TSLA   5.7970
dtype: float64
\end{verbatim}

We use the \texttt{.cumprod()} to calculate \emph{cumulative} returns,
which are the total returns for every date between \(0\) and \(T\)
(i.e., \(r_{0,t} \forall t \in {0, 1, \ldots T}\))

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cumret\_cumprod }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    returns\_2020s }\CommentTok{\# returns during the 2020s}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{) }\CommentTok{\# add 1 before we compound}
\NormalTok{    .cumprod() }\CommentTok{\# compound returns up to time t}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{) }\CommentTok{\# subtract 1 to recover cumulative return at time t}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cumret\_cumprod}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& AAPL & AMZN & F & META & TSLA \\
Date & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2020-01-02 & 0.0228 & 0.0272 & 0.0129 & 0.0221 & 0.0285 \\
2020-01-03 & 0.0129 & 0.0147 & -0.0097 & 0.0167 & 0.0590 \\
2020-01-06 & 0.0209 & 0.0298 & -0.0151 & 0.0358 & 0.0794 \\
2020-01-07 & 0.0161 & 0.0319 & -0.0054 & 0.0381 & 0.1213 \\
2020-01-08 & 0.0325 & 0.0239 & -0.0054 & 0.0486 & 0.1764 \\
... & ... & ... & ... & ... & ... \\
2024-02-02 & 1.5985 & 0.8596 & 0.5224 & 1.3142 & 5.7379 \\
2024-02-05 & 1.6241 & 0.8433 & 0.4535 & 1.2383 & 5.4922 \\
2024-02-06 & 1.6468 & 0.8308 & 0.5136 & 1.2154 & 5.6371 \\
2024-02-07 & 1.6483 & 0.8457 & 0.6052 & 1.2879 & 5.7260 \\
2024-02-08 & 1.6331 & 0.8383 & 0.6090 & 1.2899 & 5.7970 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cumret\_cumprod.mul(}\DecValTok{100}\NormalTok{).plot()}

\CommentTok{\# https://stackoverflow.com/questions/25973581/how{-}to{-}format{-}axis{-}number{-}format{-}to{-}thousands{-}with{-}a{-}comma}
\ImportTok{from}\NormalTok{ matplotlib }\ImportTok{import}\NormalTok{ ticker}
\NormalTok{plt.gca().get\_yaxis().set\_major\_formatter(ticker.FuncFormatter(}\KeywordTok{lambda}\NormalTok{ x, p: }\BuiltInTok{format}\NormalTok{(}\BuiltInTok{int}\NormalTok{(x), }\StringTok{\textquotesingle{},\textquotesingle{}}\NormalTok{)))}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Cumulative Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Cumulative Returns}\CharTok{\textbackslash{}n}\SpecialStringTok{ from }\SpecialCharTok{\{}\NormalTok{returns\_2020s}\SpecialCharTok{.}\NormalTok{index}\SpecialCharTok{.}\BuiltInTok{min}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{returns\_2020s}\SpecialCharTok{.}\NormalTok{index}\SpecialCharTok{.}\BuiltInTok{max}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_01_practice_05_files/figure-pdf/cell-15-output-1.png}

\subsection{\texorpdfstring{Use the \texttt{.cumsum()} method with log
returns to plot cumulative returns for these stocks in the
2020s}{Use the .cumsum() method with log returns to plot cumulative returns for these stocks in the 2020s}}\label{use-the-.cumsum-method-with-log-returns-to-plot-cumulative-returns-for-these-stocks-in-the-2020s-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cumret\_cumsum }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    returns\_2020s }\CommentTok{\# returns during the 2020s}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{) }\CommentTok{\# add 1 before we compound}
\NormalTok{    .pipe(np.log)}
\NormalTok{    .cumsum() }\CommentTok{\# log returns are additive!}
\NormalTok{    .pipe(np.exp)}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{) }\CommentTok{\# subtract 1 to recover cumulative return at time t}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(cumret\_cumprod, cumret\_cumsum)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cumret\_cumsum.mul(}\DecValTok{100}\NormalTok{).plot()}

\CommentTok{\# https://stackoverflow.com/questions/25973581/how{-}to{-}format{-}axis{-}number{-}format{-}to{-}thousands{-}with{-}a{-}comma}
\ImportTok{from}\NormalTok{ matplotlib }\ImportTok{import}\NormalTok{ ticker}
\NormalTok{plt.gca().get\_yaxis().set\_major\_formatter(ticker.FuncFormatter(}\KeywordTok{lambda}\NormalTok{ x, p: }\BuiltInTok{format}\NormalTok{(}\BuiltInTok{int}\NormalTok{(x), }\StringTok{\textquotesingle{},\textquotesingle{}}\NormalTok{)))}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Cumulative Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Cumulative Returns}\CharTok{\textbackslash{}n}\SpecialStringTok{ from }\SpecialCharTok{\{}\NormalTok{returns\_2020s}\SpecialCharTok{.}\NormalTok{index}\SpecialCharTok{.}\BuiltInTok{min}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{returns\_2020s}\SpecialCharTok{.}\NormalTok{index}\SpecialCharTok{.}\BuiltInTok{max}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_01_practice_05_files/figure-pdf/cell-18-output-1.png}

\subsection{Use price data only to plot cumulative returns for these
stocks in the
2020s}\label{use-price-data-only-to-plot-cumulative-returns-for-these-stocks-in-the-2020s-3}

We can also calculate cumulative returns as the ratio of adjusted
closes. That is \(R_{0,T} = \frac{AC_T}{AC_0} - 1\). The trick here is
that \(FV_t = PV (1+r)^t\), so \((1+r)^t = \frac{FV_t}{PV}\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s.iloc[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.0228
AMZN   0.0272
F      0.0129
META   0.0221
TSLA   0.0285
Name: 2020-01-02 00:00:00, dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].loc[}\StringTok{\textquotesingle{}2020\textquotesingle{}}\NormalTok{].iloc[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL    73.1526
AMZN    94.9005
F        8.0770
META   209.7800
TSLA    28.6840
Name: 2020-01-02 00:00:00, dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].loc[}\StringTok{\textquotesingle{}2019\textquotesingle{}}\NormalTok{].iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL    71.5208
AMZN    92.3920
F        7.9741
META   205.2500
TSLA    27.8887
Name: 2019-12-31 00:00:00, dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{prices[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].loc[}\StringTok{\textquotesingle{}2020\textquotesingle{}}\NormalTok{].iloc[}\DecValTok{0}\NormalTok{] }\OperatorTok{/}\NormalTok{ prices[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].loc[}\StringTok{\textquotesingle{}2019\textquotesingle{}}\NormalTok{].iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{{-}} \DecValTok{1}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.0228
AMZN   0.0272
F      0.0129
META   0.0221
TSLA   0.0285
dtype: float64
\end{verbatim}

\textbf{\emph{Note:}} We drop the last row in
\texttt{prices{[}\textquotesingle{}Adj\ Close\textquotesingle{}{]}} with
\texttt{.iloc{[}:-1{]}}. We drop this last row here here because we did
the same above when we calculated \texttt{returns} to exclude possible
intraday returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cumret\_prices }\OperatorTok{=}\NormalTok{ prices[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].loc[}\StringTok{\textquotesingle{}2020\textquotesingle{}}\NormalTok{:].iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{/}\NormalTok{ prices[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].loc[}\StringTok{\textquotesingle{}2019\textquotesingle{}}\NormalTok{].iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{{-}} \DecValTok{1}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(cumret\_prices, cumret\_cumprod)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cumret\_prices.mul(}\DecValTok{100}\NormalTok{).plot()}

\CommentTok{\# https://stackoverflow.com/questions/25973581/how{-}to{-}format{-}axis{-}number{-}format{-}to{-}thousands{-}with{-}a{-}comma}
\ImportTok{from}\NormalTok{ matplotlib }\ImportTok{import}\NormalTok{ ticker}
\NormalTok{plt.gca().get\_yaxis().set\_major\_formatter(ticker.FuncFormatter(}\KeywordTok{lambda}\NormalTok{ x, p: }\BuiltInTok{format}\NormalTok{(}\BuiltInTok{int}\NormalTok{(x), }\StringTok{\textquotesingle{},\textquotesingle{}}\NormalTok{)))}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Cumulative Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Cumulative Returns}\CharTok{\textbackslash{}n}\SpecialStringTok{ from }\SpecialCharTok{\{}\NormalTok{returns\_2020s}\SpecialCharTok{.}\NormalTok{index}\SpecialCharTok{.}\BuiltInTok{min}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{returns\_2020s}\SpecialCharTok{.}\NormalTok{index}\SpecialCharTok{.}\BuiltInTok{max}\NormalTok{()}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_01_practice_05_files/figure-pdf/cell-25-output-1.png}

\subsection{Calculate the Sharpe Ratio for
TSLA}\label{calculate-the-sharpe-ratio-for-tsla-3}

Calculate the Sharpe Ratio with all available returns and 2020s returns.
Recall the Sharpe Ratio is \(\frac{\overline{r_i - r_f}}{\sigma_i}\),
where \(\sigma_i\) is the volatility of \emph{excess} returns.

\textbf{\emph{I suggest you write a function named
\texttt{calc\_sharpe()} to use for the rest of this notebook.}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_sharpe(ri, rf}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], ppy}\OperatorTok{=}\DecValTok{252}\NormalTok{):}
\NormalTok{    ri\_rf }\OperatorTok{=}\NormalTok{ ri.sub(rf).dropna()}
    \ControlFlowTok{return}\NormalTok{ np.sqrt(ppy) }\OperatorTok{*}\NormalTok{ ri\_rf.mean() }\OperatorTok{/}\NormalTok{ ri\_rf.std()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(ri}\OperatorTok{=}\NormalTok{returns[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.9261
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(ri}\OperatorTok{=}\NormalTok{returns\_2020s[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.1212
\end{verbatim}

We can use the \texttt{.pipe()} method here, too, since \texttt{ri} is
the first argument to \texttt{calc\_sharpe()}!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{].pipe(calc\_sharpe)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.9261
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{].pipe(calc\_sharpe)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.1212
\end{verbatim}

\subsection{Calculate the market beta for
TSLA}\label{calculate-the-market-beta-for-tsla-3}

Calculate the market beta with all available returns and 2020s returns.
Recall we estimate market beta with the ordinary least squares (OLS)
regression \(R_i-R_f = \alpha + \beta (R_m-R_f) + \epsilon\). We can
estimate market beta with the covariance formula (i.e.,
\(\beta_i = \frac{Cov(R_i - R_f, R_m - R_f)}{Var(R_m-R_f)}\)) above for
a univariate regression if we do not need goodness of fit statistics.

\textbf{\emph{I suggest you write a function named \texttt{calc\_beta()}
to use for the rest of this notebook.}}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_beta(ri, rf}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], rm\_rf}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{]):}
\NormalTok{    ri\_rf }\OperatorTok{=}\NormalTok{ ri.sub(rf).dropna()}
    \ControlFlowTok{return}\NormalTok{ ri\_rf.cov(rm\_rf) }\OperatorTok{/}\NormalTok{ rm\_rf.loc[ri\_rf.index].var()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_beta(ri}\OperatorTok{=}\NormalTok{returns[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.4417
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_beta(ri}\OperatorTok{=}\NormalTok{returns\_2020s[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.5780
\end{verbatim}

We can use the \texttt{.pipe()} method here, too, since \texttt{ri} is
the first argument to \texttt{calc\_beta()}!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{].pipe(calc\_beta)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.4417
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s[}\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{].pipe(calc\_beta)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.5780
\end{verbatim}

\subsection{Guess the Sharpe Ratios for these stocks in the
2020s}\label{guess-the-sharpe-ratios-for-these-stocks-in-the-2020s-3}

\subsection{Guess the market betas for these stocks in the
2020s}\label{guess-the-market-betas-for-these-stocks-in-the-2020s-3}

\subsection{Calculate the Sharpe Ratios for these stocks in the
2020s}\label{calculate-the-sharpe-ratios-for-these-stocks-in-the-2020s-3}

How good were your guesses?

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ returns\_2020s:}
\NormalTok{    sharpe\_i }\OperatorTok{=}\NormalTok{ returns\_2020s[i].pipe(calc\_sharpe)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}Sharpe Ratio for }\SpecialCharTok{\{}\NormalTok{i}\SpecialCharTok{\}}\SpecialStringTok{:}\CharTok{\textbackslash{}t}\SpecialStringTok{ }\SpecialCharTok{\{}\NormalTok{sharpe\_i}\SpecialCharTok{:0.2f\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Sharpe Ratio for AAPL:   0.86
Sharpe Ratio for AMZN:   0.48
Sharpe Ratio for F:  0.42
Sharpe Ratio for META:   0.49
Sharpe Ratio for TSLA:   1.12
\end{verbatim}

We can also use pandas notation to vectorize this calculation. First
calculate \emph{excess} returns as \(r_i - r_f\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s\_excess }\OperatorTok{=}\NormalTok{ returns\_2020s.sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{).dropna()}
\end{Highlighting}
\end{Shaded}

Then use pandas notation to calculate means, standard deviations, and
annualize.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    returns\_2020s\_excess}
\NormalTok{    .mean()}
\NormalTok{    .div(returns\_2020s\_excess.std())}
\NormalTok{    .mul(np.sqrt(}\DecValTok{252}\NormalTok{))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.8576
AMZN   0.4750
F      0.4240
META   0.4949
TSLA   1.1212
dtype: float64
\end{verbatim}

\textbf{\emph{Note:}} In a few weeks we will learn the \texttt{.apply()}
method, which avoids the loop syntax.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s.}\BuiltInTok{apply}\NormalTok{(calc\_sharpe)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   0.8576
AMZN   0.4750
F      0.4240
META   0.4949
TSLA   1.1212
dtype: float64
\end{verbatim}

\subsection{Calculate the market betas for these stocks in the
2020s}\label{calculate-the-market-betas-for-these-stocks-in-the-2020s-3}

How good were your guesses?

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ returns\_2020s:}
\NormalTok{    beta\_i }\OperatorTok{=}\NormalTok{ returns\_2020s[i].pipe(calc\_beta)}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}Beta for }\SpecialCharTok{\{}\NormalTok{i}\SpecialCharTok{\}}\SpecialStringTok{:}\CharTok{\textbackslash{}t}\SpecialStringTok{ }\SpecialCharTok{\{}\NormalTok{beta\_i}\SpecialCharTok{:0.2f\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Beta for AAPL:   1.15
Beta for AMZN:   1.04
Beta for F:  1.22
Beta for META:   1.27
Beta for TSLA:   1.58
\end{verbatim}

Or we can follow out approach above to vectorize this calculation.
First, we need to add a market excess return column to
\texttt{returns\_2020s\_excess}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s\_excess[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{] }\OperatorTok{=}\NormalTok{ ff[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{]}
\NormalTok{returns\_2020s\_excess.head()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& AAPL & AMZN & F & META & TSLA & Mkt-RF \\
Date & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2020-01-02 & 0.0228 & 0.0271 & 0.0128 & 0.0220 & 0.0285 & 0.0086 \\
2020-01-03 & -0.0098 & -0.0122 & -0.0224 & -0.0054 & 0.0296 & -0.0067 \\
2020-01-06 & 0.0079 & 0.0148 & -0.0055 & 0.0188 & 0.0192 & 0.0036 \\
2020-01-07 & -0.0048 & 0.0020 & 0.0098 & 0.0021 & 0.0387 & -0.0019 \\
2020-01-08 & 0.0160 & -0.0079 & -0.0001 & 0.0101 & 0.0491 & 0.0047 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vcv }\OperatorTok{=}\NormalTok{ returns\_2020s\_excess.cov()}
\NormalTok{vcv}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& AAPL & AMZN & F & META & TSLA & Mkt-RF \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
AAPL & 0.0004 & 0.0003 & 0.0002 & 0.0004 & 0.0005 & 0.0003 \\
AMZN & 0.0003 & 0.0006 & 0.0002 & 0.0004 & 0.0005 & 0.0002 \\
F & 0.0002 & 0.0002 & 0.0009 & 0.0003 & 0.0005 & 0.0003 \\
META & 0.0004 & 0.0004 & 0.0003 & 0.0009 & 0.0005 & 0.0003 \\
TSLA & 0.0005 & 0.0005 & 0.0005 & 0.0005 & 0.0018 & 0.0003 \\
Mkt-RF & 0.0003 & 0.0002 & 0.0003 & 0.0003 & 0.0003 & 0.0002 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vcv[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{].div(vcv.loc[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{]).plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}CAPM Beta\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}CAPM Betas\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_01_practice_05_files/figure-pdf/cell-43-output-1.png}

\textbf{\emph{Note:}} In a few weeks we will learn the \texttt{.apply()}
method, which avoids the loop syntax.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s.}\BuiltInTok{apply}\NormalTok{(calc\_beta)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
AAPL   1.1541
AMZN   1.0429
F      1.2231
META   1.2710
TSLA   1.5780
dtype: float64
\end{verbatim}

\subsection{\texorpdfstring{Calculate the Sharpe Ratio for an
\emph{equally weighted} portfolio of these stocks in the
2020s}{Calculate the Sharpe Ratio for an equally weighted portfolio of these stocks in the 2020s}}\label{calculate-the-sharpe-ratio-for-an-equally-weighted-portfolio-of-these-stocks-in-the-2020s-3}

What do you notice?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s.mean(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{).pipe(calc\_sharpe)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.9573
\end{verbatim}

Because diversification reduces portfolio standard deviation less than
the sum of its parts, the Sharpe Ratio of the equally weighted portfolio
is less than the equally weighted mean of the single-stock Sharpe
Ratios.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s.}\BuiltInTok{apply}\NormalTok{(calc\_sharpe).mean()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.6745
\end{verbatim}

\subsection{\texorpdfstring{Calculate the market beta for an
\emph{equally weighted} portfolio of these stocks in the
2020s}{Calculate the market beta for an equally weighted portfolio of these stocks in the 2020s}}\label{calculate-the-market-beta-for-an-equally-weighted-portfolio-of-these-stocks-in-the-2020s-3}

What do you notice?

Beta measures \emph{non}diversifiable risk, so
\(\beta_P = \sum w_i \beta_i\)!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s.mean(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{).pipe(calc\_beta)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.2538
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2020s.}\BuiltInTok{apply}\NormalTok{(calc\_beta).mean()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.2538
\end{verbatim}

\subsection{Calculate the market betas for these stocks every calendar
year for every possible
year}\label{calculate-the-market-betas-for-these-stocks-every-calendar-year-for-every-possible-year-3}

Save these market betas to data frame \texttt{betas}. Our current Python
knowledge limits us to a for-loop, but we will learn easier and faster
approaches soon!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{betas }\OperatorTok{=}\NormalTok{ pd.DataFrame(}
\NormalTok{    index}\OperatorTok{=}\BuiltInTok{range}\NormalTok{(}\DecValTok{1972}\NormalTok{, }\DecValTok{2024}\NormalTok{),}
\NormalTok{    columns}\OperatorTok{=}\NormalTok{returns.columns}
\NormalTok{)}

\NormalTok{betas.columns.name }\OperatorTok{=} \StringTok{\textquotesingle{}Ticker\textquotesingle{}}
\NormalTok{betas.index.name }\OperatorTok{=} \StringTok{\textquotesingle{}Year\textquotesingle{}}

\NormalTok{betas.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
Ticker & AAPL & AMZN & F & META & TSLA \\
Year & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2019 & NaN & NaN & NaN & NaN & NaN \\
2020 & NaN & NaN & NaN & NaN & NaN \\
2021 & NaN & NaN & NaN & NaN & NaN \\
2022 & NaN & NaN & NaN & NaN & NaN \\
2023 & NaN & NaN & NaN & NaN & NaN \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in}\NormalTok{ betas.index: }
    \ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ betas.columns:}
\NormalTok{        betas.at[i, c] }\OperatorTok{=}\NormalTok{ returns.loc[}\BuiltInTok{str}\NormalTok{(i), c].pipe(calc\_beta)}

\NormalTok{betas.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
Ticker & AAPL & AMZN & F & META & TSLA \\
Year & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2019 & 1.4751 & 1.2752 & 1.0733 & 1.2094 & 1.3262 \\
2020 & 1.1174 & 0.6866 & 1.1052 & 0.9913 & 1.3041 \\
2021 & 1.1957 & 0.9822 & 1.2396 & 1.2014 & 1.9891 \\
2022 & 1.2386 & 1.5922 & 1.3824 & 1.6843 & 1.7414 \\
2023 & 1.0369 & 1.4649 & 1.3947 & 1.6630 & 2.2218 \\
\end{longtable}

\subsection{Plot the time series of market
betas}\label{plot-the-time-series-of-market-betas-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{betas.plot()}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}CAPM Beta\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}CAPM Betas\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_01_practice_05_files/figure-pdf/cell-51-output-1.png}

\part{Week 6}

\chapter{McKinney Chapter 8 - Data Wrangling: Join, Combine, and
Reshape}\label{mckinney-chapter-8---data-wrangling-join-combine-and-reshape}

\section{Introduction}\label{introduction-4}

Chapter 8 of Wes McKinney's
\href{https://wesmckinney.com/book/}{\emph{Python for Data Analysis}}
introduces a few important pandas concepts:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Joining or merging is combining 2+ data frames on 1+ indexes or
  columns into 1 data frame
\item
  Reshaping is rearranging data frames so it has fewer columns and more
  rows (wide to long) or more columns and fewer rows (long to wide); we
  can also reshape a series to a data frame and vice versa
\end{enumerate}

\textbf{\emph{Note:}} Indented block quotes are from McKinney unless
otherwise indicated. The section numbers here differ from McKinney
because we will only discuss some topics.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\section{Hierarchical Indexing}\label{hierarchical-indexing}

We need to learn about hierarchical indexing before we learn about
combining and reshaping data. A hierarchical index gives two or more
index levels to an axis. For example, we could index rows by ticker and
date. Or we could index columns by variable and ticker. Hierarchical
indexing helps us work with high-dimensional data in a low-dimensional
form.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{data }\OperatorTok{=}\NormalTok{ pd.Series(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{np.random.randn(}\DecValTok{9}\NormalTok{),}
\NormalTok{    index}\OperatorTok{=}\NormalTok{[}
\NormalTok{        [}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}d\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}d\textquotesingle{}}\NormalTok{],}
\NormalTok{        [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{]}
\NormalTok{    ]}
\NormalTok{)}

\NormalTok{data}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
a  1    0.4967
   2   -0.1383
   3    0.6477
b  1    1.5230
   3   -0.2342
c  1   -0.2341
   2    1.5792
d  2    0.7674
   3   -0.4695
dtype: float64
\end{verbatim}

We can partially index this series to concisely subset data.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data[}\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1    1.5230
3   -0.2342
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data[}\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
b  1    1.5230
   3   -0.2342
c  1   -0.2341
   2    1.5792
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.loc[[}\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}d\textquotesingle{}}\NormalTok{]]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
b  1    1.5230
   3   -0.2342
d  2    0.7674
   3   -0.4695
dtype: float64
\end{verbatim}

We can subset on the index inner level, too. Here the first \texttt{:}
slices all values in the outer index.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.loc[:, }\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
a   -0.1383
c    1.5792
d    0.7674
dtype: float64
\end{verbatim}

Here \texttt{data} has a stacked format. For each outer index level (the
letters), we have multiple observations based on the inner index level
(the numbers). We can un-stack \texttt{data} to convert the inner index
level to columns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.unstack()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& 1 & 2 & 3 \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
a & 0.4967 & -0.1383 & 0.6477 \\
b & 1.5230 & NaN & -0.2342 \\
c & -0.2341 & 1.5792 & NaN \\
d & NaN & 0.7674 & -0.4695 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data.unstack().stack()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
a  1    0.4967
   2   -0.1383
   3    0.6477
b  1    1.5230
   3   -0.2342
c  1   -0.2341
   2    1.5792
d  2    0.7674
   3   -0.4695
dtype: float64
\end{verbatim}

We can create a data frame with hieracrhical indexes or multi-indexes on
rows \emph{and} columns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame }\OperatorTok{=}\NormalTok{ pd.DataFrame(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{np.arange(}\DecValTok{12}\NormalTok{).reshape((}\DecValTok{4}\NormalTok{, }\DecValTok{3}\NormalTok{)),}
\NormalTok{    index}\OperatorTok{=}\NormalTok{[[}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{], [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{]],}
\NormalTok{    columns}\OperatorTok{=}\NormalTok{[[}\StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Colorado\textquotesingle{}}\NormalTok{], [}\StringTok{\textquotesingle{}Green\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Red\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Green\textquotesingle{}}\NormalTok{]]}
\NormalTok{)}

\NormalTok{frame}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& & \multicolumn{2}{l}{%
Ohio} & Colorado \\
& & Green & Red & Green \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{2}{=}{a} & 1 & 0 & 1 & 2 \\
& 2 & 3 & 4 & 5 \\
\multirow{2}{=}{b} & 1 & 6 & 7 & 8 \\
& 2 & 9 & 10 & 11 \\
\end{longtable}

We can name these multi-indexes but names are not required.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame.index.names }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}key2\textquotesingle{}}\NormalTok{]}
\NormalTok{frame.columns.names }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}state\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}color\textquotesingle{}}\NormalTok{]}
\NormalTok{frame}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& state & \multicolumn{2}{l}{%
Ohio} & Colorado \\
& color & Green & Red & Green \\
key1 & key2 & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{2}{=}{a} & 1 & 0 & 1 & 2 \\
& 2 & 3 & 4 & 5 \\
\multirow{2}{=}{b} & 1 & 6 & 7 & 8 \\
& 2 & 9 & 10 & 11 \\
\end{longtable}

Recall that \texttt{df{[}val{]}} selects the \texttt{val} column. Here
\texttt{frame} has a multi-index for the columns, so
\texttt{frame{[}\textquotesingle{}Ohio\textquotesingle{}{]}} selects all
columns with Ohio as the outer index level.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame[}\StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& color & Green & Red \\
key1 & key2 & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{2}{=}{a} & 1 & 0 & 1 \\
& 2 & 3 & 4 \\
\multirow{2}{=}{b} & 1 & 6 & 7 \\
& 2 & 9 & 10 \\
\end{longtable}

We can pass a tuple if we only want one column.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame[[(}\StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Green\textquotesingle{}}\NormalTok{)]]}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lll@{}}
\toprule\noalign{}
& state & Ohio \\
& color & Green \\
key1 & key2 & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{2}{=}{a} & 1 & 0 \\
& 2 & 3 \\
\multirow{2}{=}{b} & 1 & 6 \\
& 2 & 9 \\
\end{longtable}

We have to do a more work to slice the inner level of the column index.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame.loc[:, (}\BuiltInTok{slice}\NormalTok{(}\VariableTok{None}\NormalTok{), }\StringTok{\textquotesingle{}Green\textquotesingle{}}\NormalTok{)]}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& state & Ohio & Colorado \\
& color & Green & Green \\
key1 & key2 & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{2}{=}{a} & 1 & 0 & 2 \\
& 2 & 3 & 5 \\
\multirow{2}{=}{b} & 1 & 6 & 8 \\
& 2 & 9 & 11 \\
\end{longtable}

We can use
\texttt{pd.IndexSlice{[}:,\ \textquotesingle{}Green\textquotesingle{}{]}}
an alternative to
\texttt{(slice(None),\ \textquotesingle{}Green\textquotesingle{})}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame.loc[:, pd.IndexSlice[:, }\StringTok{\textquotesingle{}Green\textquotesingle{}}\NormalTok{]]}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& state & Ohio & Colorado \\
& color & Green & Green \\
key1 & key2 & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{2}{=}{a} & 1 & 0 & 2 \\
& 2 & 3 & 5 \\
\multirow{2}{=}{b} & 1 & 6 & 8 \\
& 2 & 9 & 11 \\
\end{longtable}

\subsection{Reordering and Sorting
Levels}\label{reordering-and-sorting-levels}

We can swap index levels with the \texttt{.swaplevel()} method. The
default arguments are \texttt{i=-2} and \texttt{j=-1}, which swap the
two innermost index levels.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& state & \multicolumn{2}{l}{%
Ohio} & Colorado \\
& color & Green & Red & Green \\
key1 & key2 & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{2}{=}{a} & 1 & 0 & 1 & 2 \\
& 2 & 3 & 4 & 5 \\
\multirow{2}{=}{b} & 1 & 6 & 7 & 8 \\
& 2 & 9 & 10 & 11 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame.swaplevel()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& state & \multicolumn{2}{l}{%
Ohio} & Colorado \\
& color & Green & Red & Green \\
key2 & key1 & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1 & a & 0 & 1 & 2 \\
2 & a & 3 & 4 & 5 \\
1 & b & 6 & 7 & 8 \\
2 & b & 9 & 10 & 11 \\
\end{longtable}

We can use index \emph{names}, too.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame.swaplevel(}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}key2\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& state & \multicolumn{2}{l}{%
Ohio} & Colorado \\
& color & Green & Red & Green \\
key2 & key1 & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1 & a & 0 & 1 & 2 \\
2 & a & 3 & 4 & 5 \\
1 & b & 6 & 7 & 8 \\
2 & b & 9 & 10 & 11 \\
\end{longtable}

We can also sort on an index (or list of indexes). After we swap levels,
we may want to sort our data.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& state & \multicolumn{2}{l}{%
Ohio} & Colorado \\
& color & Green & Red & Green \\
key1 & key2 & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{2}{=}{a} & 1 & 0 & 1 & 2 \\
& 2 & 3 & 4 & 5 \\
\multirow{2}{=}{b} & 1 & 6 & 7 & 8 \\
& 2 & 9 & 10 & 11 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame.sort\_index(level}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& state & \multicolumn{2}{l}{%
Ohio} & Colorado \\
& color & Green & Red & Green \\
key1 & key2 & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
a & 1 & 0 & 1 & 2 \\
b & 1 & 6 & 7 & 8 \\
a & 2 & 3 & 4 & 5 \\
b & 2 & 9 & 10 & 11 \\
\end{longtable}

Again, we can give index \emph{names}, too.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame.sort\_index(level}\OperatorTok{=}\StringTok{\textquotesingle{}key2\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& state & \multicolumn{2}{l}{%
Ohio} & Colorado \\
& color & Green & Red & Green \\
key1 & key2 & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
a & 1 & 0 & 1 & 2 \\
b & 1 & 6 & 7 & 8 \\
a & 2 & 3 & 4 & 5 \\
b & 2 & 9 & 10 & 11 \\
\end{longtable}

We can sort by two or more index levels by passing a list of index
levels or names.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame.sort\_index(level}\OperatorTok{=}\NormalTok{[}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& state & \multicolumn{2}{l}{%
Ohio} & Colorado \\
& color & Green & Red & Green \\
key1 & key2 & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{2}{=}{a} & 1 & 0 & 1 & 2 \\
& 2 & 3 & 4 & 5 \\
\multirow{2}{=}{b} & 1 & 6 & 7 & 8 \\
& 2 & 9 & 10 & 11 \\
\end{longtable}

We can chain these methods, too.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame.swaplevel(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{).sort\_index(level}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& state & \multicolumn{2}{l}{%
Ohio} & Colorado \\
& color & Green & Red & Green \\
key2 & key1 & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{2}{=}{1} & a & 0 & 1 & 2 \\
& b & 6 & 7 & 8 \\
\multirow{2}{=}{2} & a & 3 & 4 & 5 \\
& b & 9 & 10 & 11 \\
\end{longtable}

\subsection{Indexing with a DataFrame's
columns}\label{indexing-with-a-dataframes-columns}

We can convert a column into an index and an index into a column with
the \texttt{.set\_index()} and \texttt{.reset\_index()} methods.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}
    \StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{: }\BuiltInTok{range}\NormalTok{(}\DecValTok{7}\NormalTok{), }
    \StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{: }\BuiltInTok{range}\NormalTok{(}\DecValTok{7}\NormalTok{, }\DecValTok{0}\NormalTok{, }\OperatorTok{{-}}\DecValTok{1}\NormalTok{),}
    \StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}one\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}one\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}one\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}two\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}two\textquotesingle{}}\NormalTok{,}\StringTok{\textquotesingle{}two\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}two\textquotesingle{}}\NormalTok{],}
    \StringTok{\textquotesingle{}d\textquotesingle{}}\NormalTok{: [}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{]}
\NormalTok{\})}

\NormalTok{frame}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& a & b & c & d \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & 0 & 7 & one & 0 \\
1 & 1 & 6 & one & 1 \\
2 & 2 & 5 & one & 2 \\
3 & 3 & 4 & two & 0 \\
4 & 4 & 3 & two & 1 \\
5 & 5 & 2 & two & 2 \\
6 & 6 & 1 & two & 3 \\
\end{longtable}

The \texttt{.set\_index()} method converts columns to indexes, and
removes the columns from the data frame by default.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame2 }\OperatorTok{=}\NormalTok{ frame.set\_index([}\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}d\textquotesingle{}}\NormalTok{])}
\NormalTok{frame2}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& & a & b \\
c & d & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{3}{=}{one} & 0 & 0 & 7 \\
& 1 & 1 & 6 \\
& 2 & 2 & 5 \\
\multirow{4}{=}{two} & 0 & 3 & 4 \\
& 1 & 4 & 3 \\
& 2 & 5 & 2 \\
& 3 & 6 & 1 \\
\end{longtable}

The \texttt{.reset\_index()} method removes the indexes, adds them as
columns, and sets in integer index.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame2.reset\_index()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& c & d & a & b \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & one & 0 & 0 & 7 \\
1 & one & 1 & 1 & 6 \\
2 & one & 2 & 2 & 5 \\
3 & two & 0 & 3 & 4 \\
4 & two & 1 & 4 & 3 \\
5 & two & 2 & 5 & 2 \\
6 & two & 3 & 6 & 1 \\
\end{longtable}

\section{Combining and Merging
Datasets}\label{combining-and-merging-datasets}

pandas provides several methods and functions to combine and merge data.
We can typically create the same output with any of these methods or
functions, but one may be more efficient than the others. If I want to
combine data frames with similar indexes, I try the \texttt{.join()}
method first. The \texttt{.join()} also lets use can combine more than
two data frames at once. Otherwise, I try the \texttt{.merge()} method,
which has a function \texttt{pd.merge()}, too. The \texttt{pd.merge()}
function is more general than the \texttt{.join()} method, so we will
start with \texttt{pd.merge()}.

The
\href{https://pandas.pydata.org/pandas-docs/stable/user_guide/merging.html\#}{pandas
website} provides helpful visualizations.

\subsection{Database-Style DataFrame
Joins}\label{database-style-dataframe-joins}

\begin{quote}
Merge or join operations combine datasets by linking rows using one or
more keys. These operations are central to relational databases (e.g.,
SQL-based). The merge function in pandas is the main entry point for
using these algorithms on your data.
\end{quote}

We will start with the \texttt{pd.merge()} syntax, but pandas also has
\texttt{.merge()} and \texttt{.join()} methods. Learning these other
syntaxes is easy once we understand the \texttt{pd.merge()} syntax.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df1 }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}\StringTok{\textquotesingle{}key\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{], }\StringTok{\textquotesingle{}data1\textquotesingle{}}\NormalTok{: }\BuiltInTok{range}\NormalTok{(}\DecValTok{7}\NormalTok{)\})}
\NormalTok{df2 }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}\StringTok{\textquotesingle{}key\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}d\textquotesingle{}}\NormalTok{], }\StringTok{\textquotesingle{}data2\textquotesingle{}}\NormalTok{: }\BuiltInTok{range}\NormalTok{(}\DecValTok{3}\NormalTok{)\})}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df1}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lll@{}}
\toprule\noalign{}
& key & data1 \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & b & 0 \\
1 & b & 1 \\
2 & a & 2 \\
3 & c & 3 \\
4 & a & 4 \\
5 & a & 5 \\
6 & b & 6 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df2}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lll@{}}
\toprule\noalign{}
& key & data2 \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & a & 0 \\
1 & b & 1 \\
2 & d & 2 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pd.merge(df1, df2)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& key & data1 & data2 \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & b & 0 & 1 \\
1 & b & 1 & 1 \\
2 & b & 6 & 1 \\
3 & a & 2 & 0 \\
4 & a & 4 & 0 \\
5 & a & 5 & 0 \\
\end{longtable}

The default \texttt{how} is
\texttt{how=\textquotesingle{}inner\textquotesingle{}}, so
\texttt{pd.merge()} inner joins left and right data frames by default,
keeping only rows that appear in both. We can specify
\texttt{how=\textquotesingle{}outer\textquotesingle{}}, so
\texttt{pd.merge()} outer joins left and right data frames, keeping all
rows that appear in either.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pd.merge(df1, df2, how}\OperatorTok{=}\StringTok{\textquotesingle{}outer\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& key & data1 & data2 \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & b & 0.0000 & 1.0000 \\
1 & b & 1.0000 & 1.0000 \\
2 & b & 6.0000 & 1.0000 \\
3 & a & 2.0000 & 0.0000 \\
4 & a & 4.0000 & 0.0000 \\
5 & a & 5.0000 & 0.0000 \\
6 & c & 3.0000 & NaN \\
7 & d & NaN & 2.0000 \\
\end{longtable}

A left merge keeps only rows that appear in the left data frame.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pd.merge(df1, df2, how}\OperatorTok{=}\StringTok{\textquotesingle{}left\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& key & data1 & data2 \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & b & 0 & 1.0000 \\
1 & b & 1 & 1.0000 \\
2 & a & 2 & 0.0000 \\
3 & c & 3 & NaN \\
4 & a & 4 & 0.0000 \\
5 & a & 5 & 0.0000 \\
6 & b & 6 & 1.0000 \\
\end{longtable}

A rights merge keeps only rows that appear in the right data frame.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pd.merge(df1, df2, how}\OperatorTok{=}\StringTok{\textquotesingle{}right\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& key & data1 & data2 \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & a & 2.0000 & 0 \\
1 & a & 4.0000 & 0 \\
2 & a & 5.0000 & 0 \\
3 & b & 0.0000 & 1 \\
4 & b & 1.0000 & 1 \\
5 & b & 6.0000 & 1 \\
6 & d & NaN & 2 \\
\end{longtable}

By default, \texttt{pd.merge()} merges on all columns that appear in
both data frames.

\begin{quote}
\texttt{on} : label or list Column or index level names to join on.
These must be found in both DataFrames. If \texttt{on} is None and not
merging on indexes then this defaults to the intersection of the columns
in both DataFrames.
\end{quote}

Here \texttt{key} is the only common column between \texttt{df1} and
\texttt{df2}. We \emph{should} specify \texttt{on} to avoid unexpected
results.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pd.merge(df1, df2, on}\OperatorTok{=}\StringTok{\textquotesingle{}key\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& key & data1 & data2 \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & b & 0 & 1 \\
1 & b & 1 & 1 \\
2 & b & 6 & 1 \\
3 & a & 2 & 0 \\
4 & a & 4 & 0 \\
5 & a & 5 & 0 \\
\end{longtable}

We \emph{must} specify \texttt{left\_on} and \texttt{right\_on} if our
left and right data frames do not have a common column.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df3 }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}\StringTok{\textquotesingle{}lkey\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{], }\StringTok{\textquotesingle{}data1\textquotesingle{}}\NormalTok{: }\BuiltInTok{range}\NormalTok{(}\DecValTok{7}\NormalTok{)\})}
\NormalTok{df4 }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}\StringTok{\textquotesingle{}rkey\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}d\textquotesingle{}}\NormalTok{], }\StringTok{\textquotesingle{}data2\textquotesingle{}}\NormalTok{: }\BuiltInTok{range}\NormalTok{(}\DecValTok{3}\NormalTok{)\})}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df3}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lll@{}}
\toprule\noalign{}
& lkey & data1 \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & b & 0 \\
1 & b & 1 \\
2 & a & 2 \\
3 & c & 3 \\
4 & a & 4 \\
5 & a & 5 \\
6 & b & 6 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df4}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lll@{}}
\toprule\noalign{}
& rkey & data2 \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & a & 0 \\
1 & b & 1 \\
2 & d & 2 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# pd.merge(df3, df4) \# this code fails/errors because there are not common columns}
\CommentTok{\# MergeError: No common columns to perform merge on. Merge options: left\_on=None, right\_on=None, left\_index=False, right\_index=False}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pd.merge(df3, df4, left\_on}\OperatorTok{=}\StringTok{\textquotesingle{}lkey\textquotesingle{}}\NormalTok{, right\_on}\OperatorTok{=}\StringTok{\textquotesingle{}rkey\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& lkey & data1 & rkey & data2 \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & b & 0 & b & 1 \\
1 & b & 1 & b & 1 \\
2 & b & 6 & b & 1 \\
3 & a & 2 & a & 0 \\
4 & a & 4 & a & 0 \\
5 & a & 5 & a & 0 \\
\end{longtable}

Here \texttt{pd.merge()} dropped row \texttt{c} from \texttt{df3} and
row \texttt{d} from \texttt{df4}. Rows \texttt{c} and \texttt{d} dropped
because \texttt{pd.merge()} \emph{inner} joins be default. An inner join
keeps the intersection of the left and right data frame keys. Further,
rows \texttt{a} and \texttt{b} from \texttt{df4} appear three times to
match \texttt{df3}. If we want to keep rows \texttt{c} and \texttt{d},
we can \emph{outer} join \texttt{df3} and \texttt{df4} with
\texttt{how=\textquotesingle{}outer\textquotesingle{}}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pd.merge(df1, df2, how}\OperatorTok{=}\StringTok{\textquotesingle{}outer\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& key & data1 & data2 \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & b & 0.0000 & 1.0000 \\
1 & b & 1.0000 & 1.0000 \\
2 & b & 6.0000 & 1.0000 \\
3 & a & 2.0000 & 0.0000 \\
4 & a & 4.0000 & 0.0000 \\
5 & a & 5.0000 & 0.0000 \\
6 & c & 3.0000 & NaN \\
7 & d & NaN & 2.0000 \\
\end{longtable}

\begin{quote}
Many-to-many merges have well-defined, though not necessarily intuitive,
behavior.
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df1 }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}\StringTok{\textquotesingle{}key\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{], }\StringTok{\textquotesingle{}data1\textquotesingle{}}\NormalTok{: }\BuiltInTok{range}\NormalTok{(}\DecValTok{6}\NormalTok{)\})}
\NormalTok{df2 }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}\StringTok{\textquotesingle{}key\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}d\textquotesingle{}}\NormalTok{], }\StringTok{\textquotesingle{}data2\textquotesingle{}}\NormalTok{: }\BuiltInTok{range}\NormalTok{(}\DecValTok{5}\NormalTok{)\})}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df1}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lll@{}}
\toprule\noalign{}
& key & data1 \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & b & 0 \\
1 & b & 1 \\
2 & a & 2 \\
3 & c & 3 \\
4 & a & 4 \\
5 & b & 5 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df2}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lll@{}}
\toprule\noalign{}
& key & data2 \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & a & 0 \\
1 & b & 1 \\
2 & a & 2 \\
3 & b & 3 \\
4 & d & 4 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pd.merge(df1, df2, on}\OperatorTok{=}\StringTok{\textquotesingle{}key\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& key & data1 & data2 \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & b & 0 & 1 \\
1 & b & 0 & 3 \\
2 & b & 1 & 1 \\
3 & b & 1 & 3 \\
4 & b & 5 & 1 \\
5 & b & 5 & 3 \\
6 & a & 2 & 0 \\
7 & a & 2 & 2 \\
8 & a & 4 & 0 \\
9 & a & 4 & 2 \\
\end{longtable}

\begin{quote}
Many-to-many joins form the Cartesian product of the rows. Since there
were three \texttt{b} rows in the left DataFrame and two in the right
one, there are six \texttt{b} rows in the result. The join method only
affects the distinct key values appearing in the result.
\end{quote}

Be careful with many-to-many joins! In finance, we do not expect
many-to-many joins because we expect at least one of the data frames to
have unique observations. \textbf{\emph{pandas will not warn us if we
accidentally perform a many-to-many join instead of a one-to-one or
many-to-one join.}}

We can merge on more than one key. For example, we may merge two data
sets on ticker-date pairs or industry-date pairs.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{left }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}foo\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}foo\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{],}
                     \StringTok{\textquotesingle{}key2\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}one\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}two\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}one\textquotesingle{}}\NormalTok{],}
                     \StringTok{\textquotesingle{}lval\textquotesingle{}}\NormalTok{: [}\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{]\})}
\NormalTok{right }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}foo\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}foo\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{],}
                      \StringTok{\textquotesingle{}key2\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}one\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}one\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}one\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}two\textquotesingle{}}\NormalTok{],}
                      \StringTok{\textquotesingle{}rval\textquotesingle{}}\NormalTok{: [}\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{6}\NormalTok{, }\DecValTok{7}\NormalTok{]\})}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{left}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& key1 & key2 & lval \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & foo & one & 1 \\
1 & foo & two & 2 \\
2 & bar & one & 3 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{right}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& key1 & key2 & rval \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & foo & one & 4 \\
1 & foo & one & 5 \\
2 & bar & one & 6 \\
3 & bar & two & 7 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pd.merge(left, right, on}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}key2\textquotesingle{}}\NormalTok{], how}\OperatorTok{=}\StringTok{\textquotesingle{}outer\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& key1 & key2 & lval & rval \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & foo & one & 1.0000 & 4.0000 \\
1 & foo & one & 1.0000 & 5.0000 \\
2 & foo & two & 2.0000 & NaN \\
3 & bar & one & 3.0000 & 6.0000 \\
4 & bar & two & NaN & 7.0000 \\
\end{longtable}

When column names overlap between the left and right data frames,
\texttt{pd.merge()} appends \texttt{\_x} and \texttt{\_y} to the left
and right versions of the overlapping column names.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pd.merge(left, right, on}\OperatorTok{=}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& key1 & key2\_x & lval & key2\_y & rval \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & foo & one & 1 & one & 4 \\
1 & foo & one & 1 & one & 5 \\
2 & foo & two & 2 & one & 4 \\
3 & foo & two & 2 & one & 5 \\
4 & bar & one & 3 & one & 6 \\
5 & bar & one & 3 & two & 7 \\
\end{longtable}

I typically specify suffixes to avoid later confusion.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pd.merge(left, right, on}\OperatorTok{=}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{, suffixes}\OperatorTok{=}\NormalTok{(}\StringTok{\textquotesingle{}\_left\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}\_right\textquotesingle{}}\NormalTok{))}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& key1 & key2\_left & lval & key2\_right & rval \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & foo & one & 1 & one & 4 \\
1 & foo & one & 1 & one & 5 \\
2 & foo & two & 2 & one & 4 \\
3 & foo & two & 2 & one & 5 \\
4 & bar & one & 3 & one & 6 \\
5 & bar & one & 3 & two & 7 \\
\end{longtable}

I read the \texttt{pd.merge()} docstring whenever I am in doubt.
\textbf{\emph{Table 8-2}} lists the most commonly used arguments for
\texttt{pd.merge()}.

\begin{quote}
\begin{itemize}
\tightlist
\item
  \texttt{left}: DataFrame to be merged on the left side.
\item
  \texttt{right}: DataFrame to be merged on the right side.
\item
  \texttt{how}: One of `inner', `outer', `left', or `right'; defaults to
  `inner'.
\item
  \texttt{on}: Column names to join on. Must be found in both DataFrame
  objects. If not specified and no other join keys given will use the
  intersection of the column names in left and right as the join keys.
\item
  \texttt{left\_on}: Columns in left DataFrame to use as join keys.
\item
  \texttt{right\_on}: Analogous to left\_on for left DataFrame.
\item
  \texttt{left\_index}: Use row index in left as its join key (or keys,
  if a MultiIndex).
\item
  \texttt{right\_index}: Analogous to left\_index.
\item
  \texttt{sort}: Sort merged data lexicographically by join keys; True
  by default (disable to get better performance in some cases on large
  datasets).
\item
  \texttt{suffixes}: Tuple of string values to append to column names in
  case of overlap; defaults to ('\_x', '\_y') (e.g., if `data' in both
  DataFrame objects, would appear as `data\_x' and `data\_y' in result).
\item
  \texttt{copy}: If False, avoid copying data into resulting data
  structure in some exceptional cases; by default always copies.
\item
  \texttt{indicator}: Adds a special column \_merge that indicates the
  source of each row; values will be `left\_only', `right\_only', or
  `both' based on the origin of the joined data in each row.
\end{itemize}
\end{quote}

\subsection{Merging on Index}\label{merging-on-index}

If we want to use \texttt{pd.merge()} to join on row indexes, we can use
the \texttt{left\_index} and \texttt{right\_index} arguments.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{left1 }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}\StringTok{\textquotesingle{}key\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{], }\StringTok{\textquotesingle{}value\textquotesingle{}}\NormalTok{: }\BuiltInTok{range}\NormalTok{(}\DecValTok{6}\NormalTok{)\})}
\NormalTok{right1 }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}\StringTok{\textquotesingle{}group\_val\textquotesingle{}}\NormalTok{: [}\FloatTok{3.5}\NormalTok{, }\DecValTok{7}\NormalTok{]\}, index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{left1}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lll@{}}
\toprule\noalign{}
& key & value \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & a & 0 \\
1 & b & 1 \\
2 & a & 2 \\
3 & a & 3 \\
4 & b & 4 \\
5 & c & 5 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{right1}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}ll@{}}
\toprule\noalign{}
& group\_val \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
a & 3.5000 \\
b & 7.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pd.merge(left1, right1, left\_on}\OperatorTok{=}\StringTok{\textquotesingle{}key\textquotesingle{}}\NormalTok{, right\_index}\OperatorTok{=}\VariableTok{True}\NormalTok{, how}\OperatorTok{=}\StringTok{\textquotesingle{}outer\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& key & value & group\_val \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & a & 0 & 3.5000 \\
2 & a & 2 & 3.5000 \\
3 & a & 3 & 3.5000 \\
1 & b & 1 & 7.0000 \\
4 & b & 4 & 7.0000 \\
5 & c & 5 & NaN \\
\end{longtable}

The index arguments work for hierarchical indexes (multi indexes), too.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{lefth }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Nevada\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Nevada\textquotesingle{}}\NormalTok{],}
                      \StringTok{\textquotesingle{}key2\textquotesingle{}}\NormalTok{: [}\DecValTok{2000}\NormalTok{, }\DecValTok{2001}\NormalTok{, }\DecValTok{2002}\NormalTok{, }\DecValTok{2001}\NormalTok{, }\DecValTok{2002}\NormalTok{],}
                      \StringTok{\textquotesingle{}data\textquotesingle{}}\NormalTok{: np.arange(}\FloatTok{5.}\NormalTok{)\})}
\NormalTok{righth }\OperatorTok{=}\NormalTok{ pd.DataFrame(np.arange(}\DecValTok{12}\NormalTok{).reshape((}\DecValTok{6}\NormalTok{, }\DecValTok{2}\NormalTok{)),}
\NormalTok{                      index}\OperatorTok{=}\NormalTok{[[}\StringTok{\textquotesingle{}Nevada\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Nevada\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{],}
\NormalTok{                             [}\DecValTok{2001}\NormalTok{, }\DecValTok{2000}\NormalTok{, }\DecValTok{2000}\NormalTok{, }\DecValTok{2000}\NormalTok{, }\DecValTok{2001}\NormalTok{, }\DecValTok{2002}\NormalTok{]],}
\NormalTok{                      columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}event1\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}event2\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pd.merge(lefth, righth, left\_on}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}key2\textquotesingle{}}\NormalTok{], right\_index}\OperatorTok{=}\VariableTok{True}\NormalTok{, how}\OperatorTok{=}\StringTok{\textquotesingle{}outer\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& key1 & key2 & data & event1 & event2 \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & Ohio & 2000 & 0.0000 & 4.0000 & 5.0000 \\
0 & Ohio & 2000 & 0.0000 & 6.0000 & 7.0000 \\
1 & Ohio & 2001 & 1.0000 & 8.0000 & 9.0000 \\
2 & Ohio & 2002 & 2.0000 & 10.0000 & 11.0000 \\
3 & Nevada & 2001 & 3.0000 & 0.0000 & 1.0000 \\
4 & Nevada & 2002 & 4.0000 & NaN & NaN \\
4 & Nevada & 2000 & NaN & 2.0000 & 3.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{left2 }\OperatorTok{=}\NormalTok{ pd.DataFrame([[}\FloatTok{1.}\NormalTok{, }\FloatTok{2.}\NormalTok{], [}\FloatTok{3.}\NormalTok{, }\FloatTok{4.}\NormalTok{], [}\FloatTok{5.}\NormalTok{, }\FloatTok{6.}\NormalTok{]],}
\NormalTok{                     index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}e\textquotesingle{}}\NormalTok{],}
\NormalTok{                     columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Nevada\textquotesingle{}}\NormalTok{])}
\NormalTok{right2 }\OperatorTok{=}\NormalTok{ pd.DataFrame([[}\FloatTok{7.}\NormalTok{, }\FloatTok{8.}\NormalTok{], [}\FloatTok{9.}\NormalTok{, }\FloatTok{10.}\NormalTok{], [}\FloatTok{11.}\NormalTok{, }\FloatTok{12.}\NormalTok{], [}\DecValTok{13}\NormalTok{, }\DecValTok{14}\NormalTok{]],}
\NormalTok{                      index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}d\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}e\textquotesingle{}}\NormalTok{],}
\NormalTok{                      columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Missouri\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Alabama\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

If we use both left and right indexes, \texttt{pd.merge()} will keep the
index.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pd.merge(left2, right2, how}\OperatorTok{=}\StringTok{\textquotesingle{}outer\textquotesingle{}}\NormalTok{, left\_index}\OperatorTok{=}\VariableTok{True}\NormalTok{, right\_index}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& Ohio & Nevada & Missouri & Alabama \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
a & 1.0000 & 2.0000 & NaN & NaN \\
b & NaN & NaN & 7.0000 & 8.0000 \\
c & 3.0000 & 4.0000 & 9.0000 & 10.0000 \\
d & NaN & NaN & 11.0000 & 12.0000 \\
e & 5.0000 & 6.0000 & 13.0000 & 14.0000 \\
\end{longtable}

\begin{quote}
DataFrame has a convenient join instance for merging by index. It can
also be used to combine together many DataFrame objects having the same
or similar indexes but non-overlapping columns.
\end{quote}

If we have matching indexes on left and right, we can use
\texttt{.join()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{left2}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lll@{}}
\toprule\noalign{}
& Ohio & Nevada \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
a & 1.0000 & 2.0000 \\
c & 3.0000 & 4.0000 \\
e & 5.0000 & 6.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{right2}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lll@{}}
\toprule\noalign{}
& Missouri & Alabama \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
b & 7.0000 & 8.0000 \\
c & 9.0000 & 10.0000 \\
d & 11.0000 & 12.0000 \\
e & 13.0000 & 14.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{left2.join(right2, how}\OperatorTok{=}\StringTok{\textquotesingle{}outer\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& Ohio & Nevada & Missouri & Alabama \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
a & 1.0000 & 2.0000 & NaN & NaN \\
b & NaN & NaN & 7.0000 & 8.0000 \\
c & 3.0000 & 4.0000 & 9.0000 & 10.0000 \\
d & NaN & NaN & 11.0000 & 12.0000 \\
e & 5.0000 & 6.0000 & 13.0000 & 14.0000 \\
\end{longtable}

The \texttt{.join()} method left joins by default. The \texttt{.join()}
method uses indexes, so it requires few arguments and accepts a list of
data frames.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{another }\OperatorTok{=}\NormalTok{ pd.DataFrame(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{[[}\FloatTok{7.}\NormalTok{, }\FloatTok{8.}\NormalTok{], [}\FloatTok{9.}\NormalTok{, }\FloatTok{10.}\NormalTok{], [}\FloatTok{11.}\NormalTok{, }\FloatTok{12.}\NormalTok{], [}\FloatTok{16.}\NormalTok{, }\FloatTok{17.}\NormalTok{]],}
\NormalTok{    index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}e\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}f\textquotesingle{}}\NormalTok{],}
\NormalTok{    columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}New York\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Oregon\textquotesingle{}}\NormalTok{]}
\NormalTok{)}

\NormalTok{another}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lll@{}}
\toprule\noalign{}
& New York & Oregon \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
a & 7.0000 & 8.0000 \\
c & 9.0000 & 10.0000 \\
e & 11.0000 & 12.0000 \\
f & 16.0000 & 17.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{left2.join([right2, another])}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& Ohio & Nevada & Missouri & Alabama & New York & Oregon \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
a & 1.0000 & 2.0000 & NaN & NaN & 7.0000 & 8.0000 \\
c & 3.0000 & 4.0000 & 9.0000 & 10.0000 & 9.0000 & 10.0000 \\
e & 5.0000 & 6.0000 & 13.0000 & 14.0000 & 11.0000 & 12.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{left2.join([right2, another], how}\OperatorTok{=}\StringTok{\textquotesingle{}outer\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& Ohio & Nevada & Missouri & Alabama & New York & Oregon \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
a & 1.0000 & 2.0000 & NaN & NaN & 7.0000 & 8.0000 \\
c & 3.0000 & 4.0000 & 9.0000 & 10.0000 & 9.0000 & 10.0000 \\
e & 5.0000 & 6.0000 & 13.0000 & 14.0000 & 11.0000 & 12.0000 \\
b & NaN & NaN & 7.0000 & 8.0000 & NaN & NaN \\
d & NaN & NaN & 11.0000 & 12.0000 & NaN & NaN \\
f & NaN & NaN & NaN & NaN & 16.0000 & 17.0000 \\
\end{longtable}

\subsection{Concatenating Along an
Axis}\label{concatenating-along-an-axis}

The \texttt{pd.concat()} function provides a flexible way to combine
data frames and series along either axis. I typically use
\texttt{pd.concat()} to combine:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  A list of data frames with similar layouts
\item
  A list of series because series do not have \texttt{.join()} or
  \texttt{.merge()} methods
\end{enumerate}

The first is handy if we have to read and combine a directory of .csv
files.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{s1 }\OperatorTok{=}\NormalTok{ pd.Series([}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{], index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{])}
\NormalTok{s2 }\OperatorTok{=}\NormalTok{ pd.Series([}\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{4}\NormalTok{], index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}d\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}e\textquotesingle{}}\NormalTok{])}
\NormalTok{s3 }\OperatorTok{=}\NormalTok{ pd.Series([}\DecValTok{5}\NormalTok{, }\DecValTok{6}\NormalTok{], index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}f\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}g\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pd.concat([s1, s2, s3])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
a    0
b    1
c    2
d    3
e    4
f    5
g    6
dtype: int64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pd.concat([s1, s2, s3], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& 0 & 1 & 2 \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
a & 0.0000 & NaN & NaN \\
b & 1.0000 & NaN & NaN \\
c & NaN & 2.0000 & NaN \\
d & NaN & 3.0000 & NaN \\
e & NaN & 4.0000 & NaN \\
f & NaN & NaN & 5.0000 \\
g & NaN & NaN & 6.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{result }\OperatorTok{=}\NormalTok{ pd.concat([s1, s2, s3], keys}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}one\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}two\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}three\textquotesingle{}}\NormalTok{])}

\NormalTok{result}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
one    a    0
       b    1
two    c    2
       d    3
       e    4
three  f    5
       g    6
dtype: int64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{result.unstack()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllll@{}}
\toprule\noalign{}
& a & b & c & d & e & f & g \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
one & 0.0000 & 1.0000 & NaN & NaN & NaN & NaN & NaN \\
two & NaN & NaN & 2.0000 & 3.0000 & 4.0000 & NaN & NaN \\
three & NaN & NaN & NaN & NaN & NaN & 5.0000 & 6.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pd.concat([s1, s2, s3], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}one\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}two\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}three\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& one & two & three \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
a & 0.0000 & NaN & NaN \\
b & 1.0000 & NaN & NaN \\
c & NaN & 2.0000 & NaN \\
d & NaN & 3.0000 & NaN \\
e & NaN & 4.0000 & NaN \\
f & NaN & NaN & 5.0000 \\
g & NaN & NaN & 6.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df1 }\OperatorTok{=}\NormalTok{ pd.DataFrame(np.arange(}\DecValTok{6}\NormalTok{).reshape(}\DecValTok{3}\NormalTok{, }\DecValTok{2}\NormalTok{), index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{], columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}one\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}two\textquotesingle{}}\NormalTok{])}
\NormalTok{df2 }\OperatorTok{=}\NormalTok{ pd.DataFrame(}\DecValTok{5} \OperatorTok{+}\NormalTok{ np.arange(}\DecValTok{4}\NormalTok{).reshape(}\DecValTok{2}\NormalTok{, }\DecValTok{2}\NormalTok{), index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{], columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}three\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}four\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pd.concat([df1, df2], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}level1\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}level2\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& \multicolumn{2}{l}{%
level1} & \multicolumn{2}{l@{}}{%
level2} \\
& one & two & three & four \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
a & 0 & 1 & 5.0000 & 6.0000 \\
b & 2 & 3 & NaN & NaN \\
c & 4 & 5 & 7.0000 & 8.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pd.concat([df1, df2], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}level1\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}level2\textquotesingle{}}\NormalTok{], names}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}upper\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}lower\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
upper & \multicolumn{2}{l}{%
level1} & \multicolumn{2}{l@{}}{%
level2} \\
lower & one & two & three & four \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
a & 0 & 1 & 5.0000 & 6.0000 \\
b & 2 & 3 & NaN & NaN \\
c & 4 & 5 & 7.0000 & 8.0000 \\
\end{longtable}

\section{Reshaping and Pivoting}\label{reshaping-and-pivoting}

Above, we briefly explore reshaping data with \texttt{.stack()} and
\texttt{.unstack()}. Here we explore reshaping data more deeply.

\subsection{Reshaping with Hierarchical
Indexing}\label{reshaping-with-hierarchical-indexing}

Hierarchical indexes (multi-indexes) help reshape data.

\begin{quote}
There are two primary actions: - stack: This ``rotates'' or pivots from
the columns in the data to the rows - unstack: This pivots from the rows
into the columns
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data }\OperatorTok{=}\NormalTok{ pd.DataFrame(np.arange(}\DecValTok{6}\NormalTok{).reshape((}\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{)),}
\NormalTok{                    index}\OperatorTok{=}\NormalTok{pd.Index([}\StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Colorado\textquotesingle{}}\NormalTok{], name}\OperatorTok{=}\StringTok{\textquotesingle{}state\textquotesingle{}}\NormalTok{),}
\NormalTok{                    columns}\OperatorTok{=}\NormalTok{pd.Index([}\StringTok{\textquotesingle{}one\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}two\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}three\textquotesingle{}}\NormalTok{],}
\NormalTok{                    name}\OperatorTok{=}\StringTok{\textquotesingle{}number\textquotesingle{}}\NormalTok{))}

\NormalTok{data}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
number & one & two & three \\
state & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Ohio & 0 & 1 & 2 \\
Colorado & 3 & 4 & 5 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{result }\OperatorTok{=}\NormalTok{ data.stack()}
\NormalTok{result}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
state     number
Ohio      one       0
          two       1
          three     2
Colorado  one       3
          two       4
          three     5
dtype: int32
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{result.unstack()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
number & one & two & three \\
state & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Ohio & 0 & 1 & 2 \\
Colorado & 3 & 4 & 5 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{s1 }\OperatorTok{=}\NormalTok{ pd.Series([}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{, }\DecValTok{3}\NormalTok{], index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}d\textquotesingle{}}\NormalTok{])}
\NormalTok{s2 }\OperatorTok{=}\NormalTok{ pd.Series([}\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{6}\NormalTok{], index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}d\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}e\textquotesingle{}}\NormalTok{])}
\NormalTok{data2 }\OperatorTok{=}\NormalTok{ pd.concat([s1, s2], keys}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}one\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}two\textquotesingle{}}\NormalTok{])}
\NormalTok{data2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
one  a    0
     b    1
     c    2
     d    3
two  c    4
     d    5
     e    6
dtype: int64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data2.unstack()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& a & b & c & d & e \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
one & 0.0000 & 1.0000 & 2.0000 & 3.0000 & NaN \\
two & NaN & NaN & 4.0000 & 5.0000 & 6.0000 \\
\end{longtable}

Un-stacking may introduce missing values because data frames are
rectangular. By default, stacking drops these missing values.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data2.unstack().stack()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
one  a   0.0000
     b   1.0000
     c   2.0000
     d   3.0000
two  c   4.0000
     d   5.0000
     e   6.0000
dtype: float64
\end{verbatim}

However, we can keep missing values with \texttt{dropna=False}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{data2.unstack().stack(dropna}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
one  a   0.0000
     b   1.0000
     c   2.0000
     d   3.0000
     e      NaN
two  a      NaN
     b      NaN
     c   4.0000
     d   5.0000
     e   6.0000
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}
    \StringTok{\textquotesingle{}left\textquotesingle{}}\NormalTok{: result, }
    \StringTok{\textquotesingle{}right\textquotesingle{}}\NormalTok{: result }\OperatorTok{+} \DecValTok{5}
\NormalTok{    \},}
\NormalTok{    columns}\OperatorTok{=}\NormalTok{pd.Index([}\StringTok{\textquotesingle{}left\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}right\textquotesingle{}}\NormalTok{], name}\OperatorTok{=}\StringTok{\textquotesingle{}side\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& side & left & right \\
state & number & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{3}{=}{Ohio} & one & 0 & 5 \\
& two & 1 & 6 \\
& three & 2 & 7 \\
\multirow{3}{=}{Colorado} & one & 3 & 8 \\
& two & 4 & 9 \\
& three & 5 & 10 \\
\end{longtable}

If we un-stack a data frame, the un-stacked level becomes the innermost
level in the resulting index.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.unstack(}\StringTok{\textquotesingle{}state\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
side & \multicolumn{2}{l}{%
left} & \multicolumn{2}{l@{}}{%
right} \\
state & Ohio & Colorado & Ohio & Colorado \\
number & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
one & 0 & 3 & 5 & 8 \\
two & 1 & 4 & 6 & 9 \\
three & 2 & 5 & 7 & 10 \\
\end{longtable}

We can chain \texttt{.stack()} and \texttt{.unstack()} to rearrange our
data.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.unstack(}\StringTok{\textquotesingle{}state\textquotesingle{}}\NormalTok{).stack(}\StringTok{\textquotesingle{}side\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& state & Ohio & Colorado \\
number & side & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{2}{=}{one} & left & 0 & 3 \\
& right & 5 & 8 \\
\multirow{2}{=}{two} & left & 1 & 4 \\
& right & 6 & 9 \\
\multirow{2}{=}{three} & left & 2 & 5 \\
& right & 7 & 10 \\
\end{longtable}

McKinney provides two more subsections on reshaping data with the
\texttt{.pivot()} and \texttt{.melt()} methods. Unlike, the stacking
methods, the pivoting methods can aggregate data and do not require an
index. We will skip these additional aggregation methods for now.

\chapter{McKinney Chapter 8 - Practice for Section
02}\label{mckinney-chapter-8---practice-for-section-02}

\section{Announcements}\label{announcements-20}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \emph{Joining Data with pandas}, our fourth and final DataCamp course,
  is due by Friday, 2/16, at 11:59 PM
\item
  We will use class next week, from 2/19 through 2/23, for group work on
  Project 1, so there is no lecture video or pre-class quiz
\item
  Project 1 is due by Tuesday, 2/27, at 8:25 AM
\item
  Please complete the
  \href{https://northeastern.instructure.com/courses/171271/quizzes/586970}{anonymous
  ungraded survey on Canvas} to help me help you learn better:
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-19}

Chapter 8 of McKinney covers 3 topics.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \emph{Hierarchical Indexing:} Hierarchical indexing helps us organize
  data at multiple levels, rather than just a flat, two-dimensional
  structure. It helps is work with high-dimensional data in a
  low-dimensional form. For example, we can index rows by multiple
  levels like ``ticker'' and ``date'', or columns by ``variable'' and
  ``ticker''.
\item
  \emph{Combining Data:} We can combine datasets on one or more keys.

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    We will use the \texttt{pd.merge()} function for database-style
    joins, which can be \texttt{inner}, \texttt{outer}, \texttt{left},
    or \texttt{right} joins.
  \item
    We will use the \texttt{.join()} method to combine data frames with
    similar indexes.
  \item
    We will use the \texttt{pd.concat()} to combine similarly-shaped
    series and data frames.
  \end{enumerate}
\item
  \emph{Reshaping Data:} We can reshape data to change its structure,
  such as pivoting from wide to long format or vice versa. We will most
  often use the \texttt{.stack()} and \texttt{.unstack()} methods, which
  pivot columns to rows and rows to columns, respectively. Laster in the
  course we will learn about the \texttt{.pivot()} method for
  aggregating data and the \texttt{.melt()} method for more advanced
  reshaping.
\end{enumerate}

\section{Practice}\label{practice-20}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{\texorpdfstring{Download data from Yahoo! Finance for BAC,
C, GS, JPM, MS, and PNC and assign to data frame
\texttt{stocks}.}{Download data from Yahoo! Finance for BAC, C, GS, JPM, MS, and PNC and assign to data frame stocks.}}\label{download-data-from-yahoo-finance-for-bac-c-gs-jpm-ms-and-pnc-and-assign-to-data-frame-stocks.}

Use
\texttt{.rename\_axis(columns=stocks.columns.names\ =\ {[}\textquotesingle{}Variable\textquotesingle{},\ \textquotesingle{}Ticker\textquotesingle{}{]})}
to assign the names \texttt{Variable} and \texttt{Ticker} to the column
multi index. We could instead use
\texttt{stocks.columns.names\ =\ {[}\textquotesingle{}Variable\textquotesingle{},\ \textquotesingle{}Ticker\textquotesingle{}{]}},
but we can chain the \texttt{.rename\_axis()} method.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}BAC C GS JPM MS PNC\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  6 of 6 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
Variable & \multicolumn{6}{l}{%
Adj Close} & \multicolumn{4}{l}{%
Close} & ... & \multicolumn{4}{l}{%
Open} & \multicolumn{6}{l@{}}{%
Volume} \\
Ticker & BAC & C & GS & JPM & MS & PNC & BAC & C & GS & JPM & ... & GS &
JPM & MS & PNC & BAC & C & GS & JPM & MS & PNC \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-02-12 & 33.6200 & 53.9200 & 392.6400 & 175.7900 & 86.8700 &
149.1400 & 33.6200 & 53.9200 & 392.6400 & 175.7900 & ... & 385.0000 &
174.7800 & 85.8600 & 147.7700 & 34160400 & 17162300.0000 & 2797200.0000
& 8539300.0000 & 7888000.0000 & 1612700.0000 \\
2024-02-13 & 32.7500 & 52.7600 & 378.7500 & 174.2600 & 83.9700 &
145.2600 & 32.7500 & 52.7600 & 378.7500 & 174.2600 & ... & 387.5900 &
175.3200 & 85.8600 & 146.7800 & 43801500 & 17672100.0000 & 3030800.0000
& 8397600.0000 & 11339400.0000 & 2121400.0000 \\
2024-02-14 & 33.1300 & 53.9800 & 378.0400 & 176.0300 & 84.0000 &
147.8700 & 33.1300 & 53.9800 & 378.0400 & 176.0300 & ... & 380.8800 &
175.0700 & 84.5400 & 146.6300 & 27833900 & 14891900.0000 & 2041300.0000
& 7056700.0000 & 5973700.0000 & 1265300.0000 \\
2024-02-15 & 34.0700 & 55.2100 & 385.4200 & 179.8700 & 85.6700 &
149.6300 & 34.0700 & 55.2100 & 385.4200 & 179.8700 & ... & 379.4200 &
176.1500 & 84.4500 & 148.7500 & 41683100 & 16865000.0000 & 2218900.0000
& 8723400.0000 & 7993500.0000 & 1991800.0000 \\
2024-02-16 & 34.0900 & 54.8500 & 384.4400 & 179.0300 & 86.5000 &
148.8500 & 34.0900 & 54.8500 & 384.4400 & 179.0300 & ... & 383.2400 &
179.6100 & 85.5200 & 148.4200 & 33146357 & 11419637.0000 & 2302099.0000
& 6234328.0000 & 8369968.0000 & 1465354.0000 \\
\end{longtable}

\subsection{\texorpdfstring{Reshape \texttt{stocks} from wide to long
with dates and tickers as row indexes and assign to data frame
\texttt{stocks\_long}.}{Reshape stocks from wide to long with dates and tickers as row indexes and assign to data frame stocks\_long.}}\label{reshape-stocks-from-wide-to-long-with-dates-and-tickers-as-row-indexes-and-assign-to-data-frame-stocks_long.}

By default, \texttt{.stack()} stacks the inner column index to the inner
row index.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks\_long }\OperatorTok{=}\NormalTok{ stocks.stack()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks\_long.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllll@{}}
\toprule\noalign{}
& Variable & Adj Close & Close & High & Low & Open & Volume \\
Date & Ticker & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{5}{=}{2024-02-16} & C & 54.8500 & 54.8500 & 55.1950 & 54.5500
& 54.9600 & 11419637.0000 \\
& GS & 384.4400 & 384.4400 & 387.5800 & 380.9450 & 383.2400 &
2302099.0000 \\
& JPM & 179.0300 & 179.0300 & 179.9800 & 178.1602 & 179.6100 &
6234328.0000 \\
& MS & 86.5000 & 86.5000 & 86.7900 & 85.0800 & 85.5200 & 8369968.0000 \\
& PNC & 148.8500 & 148.8500 & 149.9100 & 147.7700 & 148.4200 &
1465354.0000 \\
\end{longtable}

\subsection{\texorpdfstring{Add daily returns for each stock to data
frames \texttt{stocks} and
\texttt{stocks\_long}.}{Add daily returns for each stock to data frames stocks and stocks\_long.}}\label{add-daily-returns-for-each-stock-to-data-frames-stocks-and-stocks_long.}

Name the returns variable \texttt{Returns}, and maintain all multi
indexes. \emph{Hint:} Use \texttt{pd.MultiIndex()} to create a multi
index for the the wide data frame \texttt{stocks}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].columns}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Index(['BAC', 'C', 'GS', 'JPM', 'MS', 'PNC'], dtype='object', name='Ticker')
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{], stocks[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].columns]) }\CommentTok{\# I use \_ as a temporary variable}
\NormalTok{stocks[\_] }\OperatorTok{=}\NormalTok{ stocks[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].pct\_change()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
Variable & \multicolumn{6}{l}{%
Adj Close} & \multicolumn{4}{l}{%
Close} & ... & \multicolumn{4}{l}{%
Volume} & \multicolumn{6}{l@{}}{%
Returns} \\
Ticker & BAC & C & GS & JPM & MS & PNC & BAC & C & GS & JPM & ... & GS &
JPM & MS & PNC & BAC & C & GS & JPM & MS & PNC \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-02-12 & 33.6200 & 53.9200 & 392.6400 & 175.7900 & 86.8700 &
149.1400 & 33.6200 & 53.9200 & 392.6400 & 175.7900 & ... & 2797200.0000
& 8539300.0000 & 7888000.0000 & 1612700.0000 & 0.0166 & -0.0013 & 0.0218
& 0.0045 & 0.0114 & 0.0093 \\
2024-02-13 & 32.7500 & 52.7600 & 378.7500 & 174.2600 & 83.9700 &
145.2600 & 32.7500 & 52.7600 & 378.7500 & 174.2600 & ... & 3030800.0000
& 8397600.0000 & 11339400.0000 & 2121400.0000 & -0.0259 & -0.0215 &
-0.0354 & -0.0087 & -0.0334 & -0.0260 \\
2024-02-14 & 33.1300 & 53.9800 & 378.0400 & 176.0300 & 84.0000 &
147.8700 & 33.1300 & 53.9800 & 378.0400 & 176.0300 & ... & 2041300.0000
& 7056700.0000 & 5973700.0000 & 1265300.0000 & 0.0116 & 0.0231 & -0.0019
& 0.0102 & 0.0004 & 0.0180 \\
2024-02-15 & 34.0700 & 55.2100 & 385.4200 & 179.8700 & 85.6700 &
149.6300 & 34.0700 & 55.2100 & 385.4200 & 179.8700 & ... & 2218900.0000
& 8723400.0000 & 7993500.0000 & 1991800.0000 & 0.0284 & 0.0228 & 0.0195
& 0.0218 & 0.0199 & 0.0119 \\
2024-02-16 & 34.0900 & 54.8500 & 384.4400 & 179.0300 & 86.5000 &
148.8500 & 34.0900 & 54.8500 & 384.4400 & 179.0300 & ... & 2302099.0000
& 6234328.0000 & 8369968.0000 & 1465354.0000 & NaN & NaN & NaN & NaN &
NaN & NaN \\
\end{longtable}

The easiest way to add returns to long data frame \texttt{stocks\_long}
is to \texttt{.stack()} the wide data frame \texttt{stocks}! We could
sort \texttt{stocks\_long} by ticker and date (to sort chronologically
within each ticker), then use \texttt{.pct\_change()}. However, this
approach miscalculates the first return for every ticker except for the
first ticker. The easiest and safest solution is to \texttt{.stack()}
the wide data frame \texttt{stocks}!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks\_long }\OperatorTok{=}\NormalTok{ stocks.stack()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks\_long.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllll@{}}
\toprule\noalign{}
& Variable & Adj Close & Close & High & Low & Open & Volume & Returns \\
Date & Ticker & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{5}{=}{2024-02-16} & C & 54.8500 & 54.8500 & 55.1950 & 54.5500
& 54.9600 & 11419637.0000 & NaN \\
& GS & 384.4400 & 384.4400 & 387.5800 & 380.9450 & 383.2400 &
2302099.0000 & NaN \\
& JPM & 179.0300 & 179.0300 & 179.9800 & 178.1602 & 179.6100 &
6234328.0000 & NaN \\
& MS & 86.5000 & 86.5000 & 86.7900 & 85.0800 & 85.5200 & 8369968.0000 &
NaN \\
& PNC & 148.8500 & 148.8500 & 149.9100 & 147.7700 & 148.4200 &
1465354.0000 & NaN \\
\end{longtable}

\subsection{Download the daily benchmark return factors from Ken
French's data
library.}\label{download-the-daily-benchmark-return-factors-from-ken-frenchs-data-library.}

I rarely remember the exact combination of uppercase and lowercase
letters, dashes, and underscores, so I use
\texttt{pdr.famafrench.get\_available\_datasets()} to display the list
of available names for data from Ken French's website.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pdr.famafrench.get\_available\_datasets()[:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['F-F_Research_Data_Factors',
 'F-F_Research_Data_Factors_weekly',
 'F-F_Research_Data_Factors_daily',
 'F-F_Research_Data_5_Factors_2x3',
 'F-F_Research_Data_5_Factors_2x3_daily']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pdr.DataReader(}
\NormalTok{        name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{        data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{        start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}} \CommentTok{\# otherwise, pdr.DataReader defaults to the last five years of data}
\NormalTok{    )}
\NormalTok{    [}\DecValTok{0}\NormalTok{] }\CommentTok{\# pdr.DataReader returns a dictionary of data frames}
\NormalTok{    .div(}\DecValTok{100}\NormalTok{) }\CommentTok{\# French stores returns as percents, but our stock returns are decimals}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_11480\1909726130.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& Mkt-RF & SMB & HML & RF \\
Date & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2023-12-22 & 0.0021 & 0.0064 & 0.0009 & 0.0002 \\
2023-12-26 & 0.0048 & 0.0069 & 0.0046 & 0.0002 \\
2023-12-27 & 0.0016 & 0.0014 & 0.0012 & 0.0002 \\
2023-12-28 & -0.0001 & -0.0036 & 0.0003 & 0.0002 \\
2023-12-29 & -0.0043 & -0.0112 & -0.0037 & 0.0002 \\
\end{longtable}

\subsection{\texorpdfstring{Add the daily benchmark return factors to
\texttt{stocks} and
\texttt{stocks\_long}.}{Add the daily benchmark return factors to stocks and stocks\_long.}}\label{add-the-daily-benchmark-return-factors-to-stocks-and-stocks_long.}

For the wide data frame \texttt{stocks}, use the outer index name
\texttt{Factors}.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# stocks.join(ff)}
\CommentTok{\# MergeError: Not allowed to merge between different levels. (2 levels on the left, 1 on the right)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Factors\textquotesingle{}}\NormalTok{], ff.columns]) }\CommentTok{\# I use \_ as a temporary variable}
\NormalTok{stocks[\_] }\OperatorTok{=}\NormalTok{ ff}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
Variable & \multicolumn{6}{l}{%
Adj Close} & \multicolumn{4}{l}{%
Close} & ... & \multicolumn{6}{l}{%
Returns} & \multicolumn{4}{l@{}}{%
Factors} \\
Ticker & BAC & C & GS & JPM & MS & PNC & BAC & C & GS & JPM & ... & BAC
& C & GS & JPM & MS & PNC & Mkt-RF & SMB & HML & RF \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-02-12 & 33.6200 & 53.9200 & 392.6400 & 175.7900 & 86.8700 &
149.1400 & 33.6200 & 53.9200 & 392.6400 & 175.7900 & ... & 0.0166 &
-0.0013 & 0.0218 & 0.0045 & 0.0114 & 0.0093 & NaN & NaN & NaN & NaN \\
2024-02-13 & 32.7500 & 52.7600 & 378.7500 & 174.2600 & 83.9700 &
145.2600 & 32.7500 & 52.7600 & 378.7500 & 174.2600 & ... & -0.0259 &
-0.0215 & -0.0354 & -0.0087 & -0.0334 & -0.0260 & NaN & NaN & NaN &
NaN \\
2024-02-14 & 33.1300 & 53.9800 & 378.0400 & 176.0300 & 84.0000 &
147.8700 & 33.1300 & 53.9800 & 378.0400 & 176.0300 & ... & 0.0116 &
0.0231 & -0.0019 & 0.0102 & 0.0004 & 0.0180 & NaN & NaN & NaN & NaN \\
2024-02-15 & 34.0700 & 55.2100 & 385.4200 & 179.8700 & 85.6700 &
149.6300 & 34.0700 & 55.2100 & 385.4200 & 179.8700 & ... & 0.0284 &
0.0228 & 0.0195 & 0.0218 & 0.0199 & 0.0119 & NaN & NaN & NaN & NaN \\
2024-02-16 & 34.0900 & 54.8500 & 384.4400 & 179.0300 & 86.5000 &
148.8500 & 34.0900 & 54.8500 & 384.4400 & 179.0300 & ... & NaN & NaN &
NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks\_long }\OperatorTok{=}\NormalTok{ stocks\_long.join(ff)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks\_long.head()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllll@{}}
\toprule\noalign{}
& & Adj Close & Close & High & Low & Open & Volume & Returns & Mkt-RF &
SMB & HML & RF \\
Date & Ticker & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1973-02-21 & BAC & 1.5818 & 4.6250 & 4.6250 & 4.6250 & 4.6250 &
99200.0000 & NaN & -0.0074 & -0.0039 & 0.0054 & 0.0002 \\
1973-02-22 & BAC & 1.5872 & 4.6406 & 4.6406 & 4.6406 & 4.6406 &
47200.0000 & 0.0034 & -0.0030 & -0.0037 & 0.0022 & 0.0002 \\
1973-02-23 & BAC & 1.5818 & 4.6250 & 4.6250 & 4.6250 & 4.6250 &
133600.0000 & -0.0034 & -0.0108 & -0.0019 & 0.0054 & 0.0002 \\
1973-02-26 & BAC & 1.5818 & 4.6250 & 4.6250 & 4.6250 & 4.6250 &
24000.0000 & 0.0000 & -0.0088 & -0.0050 & 0.0054 & 0.0002 \\
1973-02-27 & BAC & 1.5818 & 4.6250 & 4.6250 & 4.6250 & 4.6250 &
41600.0000 & 0.0000 & -0.0115 & -0.0018 & 0.0064 & 0.0002 \\
\end{longtable}

We can check that \texttt{.join()} used the same factor returns on the
same days.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks\_long.loc[}\StringTok{\textquotesingle{}2023{-}12\textquotesingle{}}\NormalTok{].tail(}\DecValTok{12}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllll@{}}
\toprule\noalign{}
& & Adj Close & Close & High & Low & Open & Volume & Returns & Mkt-RF &
SMB & HML & RF \\
Date & Ticker & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{6}{=}{2023-12-28} & BAC & 33.8800 & 33.8800 & 33.9700 &
33.7700 & 33.8200 & 21799600.0000 & 0.0012 & -0.0001 & -0.0036 & 0.0003
& 0.0002 \\
& C & 51.0329 & 51.5200 & 51.8000 & 51.4000 & 51.4000 & 10218500.0000 &
0.0012 & -0.0001 & -0.0036 & 0.0003 & 0.0002 \\
& GS & 386.4100 & 386.4100 & 387.7600 & 383.6300 & 384.5200 &
1024700.0000 & 0.0050 & -0.0001 & -0.0036 & 0.0003 & 0.0002 \\
& JPM & 169.2563 & 170.3000 & 170.6600 & 169.0000 & 169.3500 &
6320100.0000 & 0.0053 & -0.0001 & -0.0036 & 0.0003 & 0.0002 \\
& MS & 92.7316 & 93.6400 & 93.9500 & 93.2400 & 93.3100 & 4089500.0000 &
-0.0002 & -0.0001 & -0.0036 & 0.0003 & 0.0002 \\
& PNC & 154.0486 & 155.6300 & 156.2100 & 154.9500 & 155.4400 &
1153300.0000 & 0.0041 & -0.0001 & -0.0036 & 0.0003 & 0.0002 \\
\multirow{6}{=}{2023-12-29} & BAC & 33.6700 & 33.6700 & 33.9900 &
33.5500 & 33.9400 & 28037800.0000 & -0.0062 & -0.0043 & -0.0112 &
-0.0037 & 0.0002 \\
& C & 50.9537 & 51.4400 & 51.6100 & 51.2200 & 51.5600 & 13147900.0000 &
-0.0016 & -0.0043 & -0.0112 & -0.0037 & 0.0002 \\
& GS & 385.7700 & 385.7700 & 386.6400 & 383.5700 & 385.5700 &
881300.0000 & -0.0017 & -0.0043 & -0.0112 & -0.0037 & 0.0002 \\
& JPM & 169.0575 & 170.1000 & 170.6900 & 169.6300 & 170.0000 &
6431800.0000 & -0.0012 & -0.0043 & -0.0112 & -0.0037 & 0.0002 \\
& MS & 92.3454 & 93.2500 & 93.7700 & 93.0600 & 93.4900 & 4772100.0000 &
-0.0042 & -0.0043 & -0.0112 & -0.0037 & 0.0002 \\
& PNC & 153.2765 & 154.8500 & 156.1100 & 154.5200 & 155.2700 &
1572600.0000 & -0.0050 & -0.0043 & -0.0112 & -0.0037 & 0.0002 \\
\end{longtable}

\subsection{\texorpdfstring{Write a function \texttt{download()} that
accepts tickers and returns a wide data frame of returns with the daily
benchmark return
factors.}{Write a function download() that accepts tickers and returns a wide data frame of returns with the daily benchmark return factors.}}\label{write-a-function-download-that-accepts-tickers-and-returns-a-wide-data-frame-of-returns-with-the-daily-benchmark-return-factors.}

We can even add a \texttt{shape} argument to return a wide or long data
frame!

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ download(tickers, shape}\OperatorTok{=}\StringTok{\textquotesingle{}wide\textquotesingle{}}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ shape.lower() }\KeywordTok{not} \KeywordTok{in}\NormalTok{ [}\StringTok{\textquotesingle{}wide\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}long\textquotesingle{}}\NormalTok{]:}
        \ControlFlowTok{raise} \PreprocessorTok{ValueError}\NormalTok{(}\StringTok{\textquotesingle{}Invalid shape: must be "wide" or "long".\textquotesingle{}}\NormalTok{)}

\NormalTok{    stocks }\OperatorTok{=}\NormalTok{ yf.download(tickers)}

\NormalTok{    factors\_all }\OperatorTok{=}\NormalTok{ (}
\NormalTok{        pdr.DataReader(}
\NormalTok{            name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{            data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{            start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{        )}
\NormalTok{    )}
    
\NormalTok{    factors }\OperatorTok{=}\NormalTok{ factors\_all[}\DecValTok{0}\NormalTok{].div(}\DecValTok{100}\NormalTok{)}
    
    \CommentTok{\# if stocks has a multi index on the columns because we asked for more than one ticker}
    \CommentTok{\# then we have more work to do}
    \ControlFlowTok{if} \BuiltInTok{type}\NormalTok{(stocks.columns) }\KeywordTok{is}\NormalTok{ pd.MultiIndex:}
        
        \CommentTok{\# whether we want a wide or long data frame, it is easier to add returns to a wide data frame}
\NormalTok{        \_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{], stocks[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].columns])}
\NormalTok{        stocks[\_] }\OperatorTok{=}\NormalTok{ stocks[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].pct\_change()}

        \CommentTok{\# if we want a wide data frame, then we need a factors multi index}
        \ControlFlowTok{if}\NormalTok{ shape.lower() }\OperatorTok{==} \StringTok{\textquotesingle{}wide\textquotesingle{}}\NormalTok{:}
\NormalTok{            \_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Factors\textquotesingle{}}\NormalTok{], factors.columns])}
\NormalTok{            stocks[\_] }\OperatorTok{=}\NormalTok{ factors}
            \ControlFlowTok{return}\NormalTok{ stocks.rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}

        \CommentTok{\# if we want a long data frame, then we need to stack stocks and join factors}
        \CommentTok{\# because we tested for wide and long above, we know that here shape must be long}
        \ControlFlowTok{else}\NormalTok{:}
            \ControlFlowTok{return}\NormalTok{ stocks.stack().join(factors).rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{], index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
            
    \CommentTok{\# if stocks does not have a multi index on the columns}
    \CommentTok{\# then we only have join factors}
    \ControlFlowTok{else}\NormalTok{:}
        \ControlFlowTok{return}\NormalTok{ stocks.join(ff).rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{download(tickers}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}AAPL\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{], shape}\OperatorTok{=}\StringTok{\textquotesingle{}long\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  2 of 2 completed
C:\Users\r.herron\AppData\Local\Temp\ipykernel_11480\3667605341.py:8: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{longtable}[]{@{}lllllllllllll@{}}
\toprule\noalign{}
& Variable & Adj Close & Close & High & Low & Open & Volume & Returns &
Mkt-RF & SMB & HML & RF \\
Date & Ticker & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1980-12-12 & AAPL & 0.0992 & 0.1283 & 0.1289 & 0.1283 & 0.1283 &
469033600.0000 & NaN & 0.0138 & -0.0001 & -0.0105 & 0.0006 \\
1980-12-15 & AAPL & 0.0940 & 0.1217 & 0.1222 & 0.1217 & 0.1222 &
175884800.0000 & -0.0522 & 0.0011 & 0.0025 & -0.0046 & 0.0006 \\
1980-12-16 & AAPL & 0.0871 & 0.1127 & 0.1133 & 0.1127 & 0.1133 &
105728000.0000 & -0.0734 & 0.0071 & -0.0075 & -0.0047 & 0.0006 \\
1980-12-17 & AAPL & 0.0893 & 0.1155 & 0.1161 & 0.1155 & 0.1155 &
86441600.0000 & 0.0248 & 0.0152 & -0.0086 & -0.0034 & 0.0006 \\
1980-12-18 & AAPL & 0.0919 & 0.1189 & 0.1194 & 0.1189 & 0.1189 &
73449600.0000 & 0.0290 & 0.0041 & 0.0022 & 0.0126 & 0.0006 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... \\
2024-02-14 & TSLA & 188.7100 & 188.7100 & 188.8900 & 183.3500 & 185.3000
& 81203000.0000 & 0.0255 & NaN & NaN & NaN & NaN \\
\multirow{2}{=}{2024-02-15} & AAPL & 183.8600 & 183.8600 & 184.4900 &
181.3500 & 183.5500 & 65434500.0000 & -0.0016 & NaN & NaN & NaN & NaN \\
& TSLA & 200.4500 & 200.4500 & 200.8800 & 188.8600 & 189.1600 &
120831800.0000 & 0.0622 & NaN & NaN & NaN & NaN \\
\multirow{2}{=}{2024-02-16} & AAPL & 182.3100 & 182.3100 & 184.8500 &
181.6650 & 183.4200 & 48627624.0000 & -0.0084 & NaN & NaN & NaN & NaN \\
& TSLA & 199.9500 & 199.9500 & 203.1700 & 197.4000 & 202.0600 &
110528448.0000 & -0.0025 & NaN & NaN & NaN & NaN \\
\end{longtable}

\subsection{\texorpdfstring{Download earnings per share for the stocks
in \texttt{stocks} and combine to a long data frame
\texttt{earnings}.}{Download earnings per share for the stocks in stocks and combine to a long data frame earnings.}}\label{download-earnings-per-share-for-the-stocks-in-stocks-and-combine-to-a-long-data-frame-earnings.}

Use the \texttt{.earnings\_dates} method described
\href{https://pypi.org/project/yfinance/}{here}. Use
\texttt{pd.concat()} to combine the result of each the
\texttt{.earnings\_date} data frames and assign them to a new data frame
\texttt{earnings}. Name the row indexes \texttt{Ticker} and
\texttt{Date} and swap to match the order of the row index in
\texttt{stocks\_long}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tickers }\OperatorTok{=}\NormalTok{ yf.Tickers(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}BAC C GS JPM MS PNC\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{earnings  }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat(}
\NormalTok{        objs}\OperatorTok{=}\NormalTok{[tickers.tickers[t].earnings\_dates }\ControlFlowTok{for}\NormalTok{ t }\KeywordTok{in}\NormalTok{ tickers.tickers],}
\NormalTok{        keys}\OperatorTok{=}\NormalTok{tickers.tickers,}
\NormalTok{        names}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{]}
\NormalTok{    )}
\NormalTok{    .reset\_index()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{earnings.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& Ticker & Date & EPS Estimate & Reported EPS & Surprise(\%) \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
67 & PNC & 2024-04-16 08:00:00-04:00 & 3.0800 & NaN & NaN \\
68 & PNC & 2024-01-16 06:00:00-05:00 & 2.9400 & 3.1600 & 0.0737 \\
69 & PNC & 2023-10-13 06:00:00-04:00 & 3.1100 & 3.6000 & 0.1586 \\
70 & PNC & 2023-07-18 07:00:00-04:00 & 3.2800 & 3.3600 & 0.0230 \\
71 & PNC & 2023-04-14 06:00:00-04:00 & 3.6700 & 3.9800 & 0.0847 \\
\end{longtable}

\subsection{\texorpdfstring{Combine \texttt{earnings} with the returns
from
\texttt{stocks\_long}.}{Combine earnings with the returns from stocks\_long.}}\label{combine-earnings-with-the-returns-from-stocks_long.}

Use the
\texttt{tz\_localize(\textquotesingle{}America/New\_York\textquotesingle{})}
method add time zone information back to \texttt{returns.index} and use
\texttt{pd.to\_timedelta(16,\ unit=\textquotesingle{}h\textquotesingle{})}
to set time to the market close in New York City. Use
\href{https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.merge_asof.html}{\texttt{pd.merge\_asof()}}
to match earnings announcement dates and times to appropriate return
periods. For example, if a firm announces earnings after the close at 5
PM on February 7, we want to match the return period from 4 PM on
February 7 to 4 PM on February 8.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    stocks\_long}
\NormalTok{    .reset\_index()}
\NormalTok{    [[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .assign(}
\NormalTok{        Date}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{].dt.tz\_localize(}\StringTok{\textquotesingle{}America/New\_York\textquotesingle{}}\NormalTok{) }\OperatorTok{+}\NormalTok{ pd.to\_timedelta(}\DecValTok{16}\NormalTok{, unit}\OperatorTok{=}\StringTok{\textquotesingle{}H\textquotesingle{}}\NormalTok{)}
\NormalTok{    )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& Date & Ticker & Returns \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
62021 & 2024-02-16 16:00:00-05:00 & C & NaN \\
62022 & 2024-02-16 16:00:00-05:00 & GS & NaN \\
62023 & 2024-02-16 16:00:00-05:00 & JPM & NaN \\
62024 & 2024-02-16 16:00:00-05:00 & MS & NaN \\
62025 & 2024-02-16 16:00:00-05:00 & PNC & NaN \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{surprises }\OperatorTok{=}\NormalTok{ pd.merge\_asof(}
\NormalTok{    left}\OperatorTok{=}\NormalTok{earnings.sort\_values([}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{]),}
\NormalTok{    right}\OperatorTok{=}\NormalTok{returns.sort\_values([}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{]),}
\NormalTok{    on}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{,}
\NormalTok{    by}\OperatorTok{=}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{,}
\NormalTok{    direction}\OperatorTok{=}\StringTok{\textquotesingle{}forward\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{surprises.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& Ticker & Date & EPS Estimate & Reported EPS & Surprise(\%) &
Returns \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
67 & JPM & 2025-01-15 08:00:00-05:00 & NaN & NaN & NaN & NaN \\
68 & JPM & 2025-01-15 08:00:00-05:00 & NaN & NaN & NaN & NaN \\
69 & C & 2025-01-15 11:00:00-05:00 & NaN & NaN & NaN & NaN \\
70 & PNC & 2025-01-16 08:00:00-05:00 & NaN & NaN & NaN & NaN \\
71 & PNC & 2025-01-16 10:00:00-05:00 & NaN & NaN & NaN & NaN \\
\end{longtable}

\subsection{Plot the relation between daily returns and earnings
surprises}\label{plot-the-relation-between-daily-returns-and-earnings-surprises}

Three options in increasing difficulty:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Scatter plot
\item
  Scatter plot with a best-fit line using \texttt{regplot()} from the
  seaborn package
\item
  Bar plot using \texttt{barplot()} from the seaborn package after using
  \texttt{pd.qcut()} to form five groups on earnings surprises
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    surprises}
\NormalTok{    [[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}scatter\textquotesingle{}}\NormalTok{, x}\OperatorTok{=}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, y}\OperatorTok{=}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Earnings Surprise (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Day Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Earnings Surprise Analysis}\CharTok{\textbackslash{}n}\SpecialStringTok{ }\SpecialCharTok{\{}\StringTok{\textquotesingle{}, \textquotesingle{}}\SpecialCharTok{.}\NormalTok{join(tickers.tickers)}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_08_practice_02_files/figure-pdf/cell-31-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ seaborn }\ImportTok{as}\NormalTok{ sns}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.regplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{surprises[[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]].mul(}\DecValTok{100}\NormalTok{),}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Returns\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Earnings Surprise (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Day Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Earnings Surprise Analysis}\CharTok{\textbackslash{}n}\SpecialStringTok{ }\SpecialCharTok{\{}\StringTok{\textquotesingle{}, \textquotesingle{}}\SpecialCharTok{.}\NormalTok{join(tickers.tickers)}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_08_practice_02_files/figure-pdf/cell-33-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.catplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{(}
\NormalTok{        surprises[[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]]}
\NormalTok{        .dropna()}
\NormalTok{        .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{        .assign(}
\NormalTok{            surprise\_bin}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: pd.qcut(x[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{], q}\OperatorTok{=}\DecValTok{5}\NormalTok{, labels}\OperatorTok{=}\VariableTok{False}\NormalTok{)}\OperatorTok{+}\DecValTok{1}
\NormalTok{        )}
\NormalTok{    ),}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}surprise\_bin\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{,}
\NormalTok{    kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Earnings Surprise Bin (1=Lowest, 5=Highest)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Day Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Earnings Surprise Analysis}\CharTok{\textbackslash{}n}\SpecialStringTok{ }\SpecialCharTok{\{}\StringTok{\textquotesingle{}, \textquotesingle{}}\SpecialCharTok{.}\NormalTok{join(tickers.tickers)}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_08_practice_02_files/figure-pdf/cell-34-output-1.png}

\subsection{Repeat the earnings exercise with the S\&P 100
stocks}\label{repeat-the-earnings-exercise-with-the-sp-100-stocks}

With more data, we can more clearly see the positive relation between
earnings surprises and returns!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ pd.read\_html(}\StringTok{\textquotesingle{}https://en.wikipedia.org/wiki/S\%26P\_100\textquotesingle{}}\NormalTok{)[}\DecValTok{2}\NormalTok{][}\StringTok{\textquotesingle{}Symbol\textquotesingle{}}\NormalTok{].to\_list()}
\NormalTok{tickers\_2 }\OperatorTok{=}\NormalTok{ yf.Tickers(tickers}\OperatorTok{=}\NormalTok{[t.replace(}\StringTok{\textquotesingle{}.\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}{-}\textquotesingle{}}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ t }\KeywordTok{in}\NormalTok{ \_]) }\CommentTok{\# Yahoo! Finance uses "{-}" to indicate share classes instead of "."}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{earnings\_2  }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat(}
\NormalTok{        objs}\OperatorTok{=}\NormalTok{[tickers\_2.tickers[t].earnings\_dates }\ControlFlowTok{for}\NormalTok{ t }\KeywordTok{in}\NormalTok{ tickers\_2.tickers],}
\NormalTok{        keys}\OperatorTok{=}\NormalTok{tickers\_2.tickers,}
\NormalTok{        names}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{]}
\NormalTok{    )}
\NormalTok{    .reset\_index()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{earnings\_2.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& Ticker & Date & EPS Estimate & Reported EPS & Surprise(\%) \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1207 & XOM & 2023-04-28 06:00:00-04:00 & 2.5900 & 2.8300 & 0.0943 \\
1208 & XOM & 2023-01-31 06:00:00-05:00 & 3.2900 & 3.4000 & 0.0319 \\
1209 & XOM & 2022-10-28 06:00:00-04:00 & 3.7900 & 4.4500 & 0.1733 \\
1210 & XOM & 2022-07-29 06:00:00-04:00 & 3.7400 & 4.1400 & 0.1077 \\
1211 & XOM & 2022-04-29 06:00:00-04:00 & 2.1200 & 2.0700 & -0.0247 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\NormalTok{[t }\ControlFlowTok{for}\NormalTok{ t }\KeywordTok{in}\NormalTok{ tickers\_2.tickers])}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
\NormalTok{    [}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .pct\_change()}
\NormalTok{    .stack()}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{)}
\NormalTok{    .reset\_index()}
\NormalTok{    [[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .assign(}
\NormalTok{        Date}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{].dt.tz\_localize(}\StringTok{\textquotesingle{}America/New\_York\textquotesingle{}}\NormalTok{) }\OperatorTok{+}\NormalTok{ pd.to\_timedelta(}\DecValTok{16}\NormalTok{, unit}\OperatorTok{=}\StringTok{\textquotesingle{}H\textquotesingle{}}\NormalTok{)}
\NormalTok{    )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  101 of 101 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& Date & Ticker & Returns \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1018569 & 2024-02-16 16:00:00-05:00 & V & -0.0086 \\
1018570 & 2024-02-16 16:00:00-05:00 & VZ & -0.0025 \\
1018571 & 2024-02-16 16:00:00-05:00 & WFC & -0.0025 \\
1018572 & 2024-02-16 16:00:00-05:00 & WMT & 0.0063 \\
1018573 & 2024-02-16 16:00:00-05:00 & XOM & 0.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{surprises\_2 }\OperatorTok{=}\NormalTok{ pd.merge\_asof(}
\NormalTok{    left}\OperatorTok{=}\NormalTok{earnings\_2.sort\_values([}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{]),}
\NormalTok{    right}\OperatorTok{=}\NormalTok{returns\_2.sort\_values([}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{]),}
\NormalTok{    on}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{,}
\NormalTok{    by}\OperatorTok{=}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{,}
\NormalTok{    direction}\OperatorTok{=}\StringTok{\textquotesingle{}forward\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{surprises\_2.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& Ticker & Date & EPS Estimate & Reported EPS & Surprise(\%) &
Returns \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1207 & USB & 2025-10-16 09:00:00-04:00 & NaN & NaN & NaN & NaN \\
1208 & USB & 2025-10-16 09:00:00-04:00 & NaN & NaN & NaN & NaN \\
1209 & RTX & 2025-10-20 06:00:00-04:00 & NaN & NaN & NaN & NaN \\
1210 & USB & 2026-01-20 09:00:00-05:00 & NaN & NaN & NaN & NaN \\
1211 & USB & 2026-01-20 09:00:00-05:00 & NaN & NaN & NaN & NaN \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    surprises\_2}
\NormalTok{    [[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}scatter\textquotesingle{}}\NormalTok{, x}\OperatorTok{=}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, y}\OperatorTok{=}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Earnings Surprise (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Day Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Earnings Surprise Analysis}\CharTok{\textbackslash{}n}\StringTok{ S\&P 100 Stocks\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_08_practice_02_files/figure-pdf/cell-42-output-1.png}

\textbf{\emph{There are a few large negative and positive earnings
surprises that make our plot difficult to interpret!}} We have these
huge outliers because surprises are defined as the percent change
relative to the expected. If expected is a very small number, then the
surprise can be a very large number! We would use different surprise
definitions for a more rigorous analysis. Here we can drop observations
less than the 0.01 quantile and greater than the 0.99 quantile.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{low\_2 }\OperatorTok{=}\NormalTok{ surprises\_2[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{].quantile(}\FloatTok{0.01}\NormalTok{)}
\NormalTok{high\_2 }\OperatorTok{=}\NormalTok{ surprises\_2[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{].quantile(}\FloatTok{0.91}\NormalTok{)}

\NormalTok{cond\_2 }\OperatorTok{=}\NormalTok{ surprises\_2[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{].between(low\_2, high\_2)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    surprises\_2}
\NormalTok{    .loc[cond\_2, [}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}scatter\textquotesingle{}}\NormalTok{, x}\OperatorTok{=}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, y}\OperatorTok{=}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.5}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Earnings Surprise (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Day Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Earnings Surprise Analysis}\CharTok{\textbackslash{}n}\StringTok{ S\&P 100 Stocks\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_08_practice_02_files/figure-pdf/cell-44-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.regplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{surprises\_2.loc[cond\_2, [}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]].mul(}\DecValTok{100}\NormalTok{),}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Returns\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Earnings Surprise (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Day Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Earnings Surprise Analysis}\CharTok{\textbackslash{}n}\StringTok{ S\&P 100 Stocks\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_08_practice_02_files/figure-pdf/cell-45-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.catplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{(}
\NormalTok{        surprises\_2}
\NormalTok{        .loc[cond\_2, [}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]]}
\NormalTok{        .dropna()}
\NormalTok{        .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{        .assign(surprise\_bin}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: pd.qcut(x[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{], q}\OperatorTok{=}\DecValTok{5}\NormalTok{, labels}\OperatorTok{=}\VariableTok{False}\NormalTok{) }\OperatorTok{+} \DecValTok{1}\NormalTok{)}
\NormalTok{    ),}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}surprise\_bin\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{,}
\NormalTok{    kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Earnings Surprise Bin (1=Lowest, 5=Highest)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Day Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Earnings Surprise Analysis}\CharTok{\textbackslash{}n}\StringTok{ S\&P 100 Stocks\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_08_practice_02_files/figure-pdf/cell-46-output-1.png}

\chapter{McKinney Chapter 8 - Practice for Section
03}\label{mckinney-chapter-8---practice-for-section-03}

\section{Announcements}\label{announcements-21}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \emph{Joining Data with pandas}, our fourth and final DataCamp course,
  is due by Friday, 2/16, at 11:59 PM
\item
  We will use class next week, from 2/19 through 2/23, for group work on
  Project 1, so there is no lecture video or pre-class quiz
\item
  Project 1 is due by Tuesday, 2/27, at 8:25 AM
\item
  Please complete the
  \href{https://northeastern.instructure.com/courses/171271/quizzes/586970}{anonymous
  ungraded survey on Canvas} to help me help you learn better:
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-20}

Chapter 8 of McKinney covers 3 topics.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \emph{Hierarchical Indexing:} Hierarchical indexing helps us organize
  data at multiple levels, rather than just a flat, two-dimensional
  structure. It helps is work with high-dimensional data in a
  low-dimensional form. For example, we can index rows by multiple
  levels like ``ticker'' and ``date'', or columns by ``variable'' and
  ``ticker''.
\item
  \emph{Combining Data:} We can combine datasets on one or more keys.

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    We will use the \texttt{pd.merge()} function for database-style
    joins, which can be \texttt{inner}, \texttt{outer}, \texttt{left},
    or \texttt{right} joins.
  \item
    We will use the \texttt{.join()} method to combine data frames with
    similar indexes.
  \item
    We will use the \texttt{pd.concat()} to combine similarly-shaped
    series and data frames.
  \end{enumerate}
\item
  \emph{Reshaping Data:} We can reshape data to change its structure,
  such as pivoting from wide to long format or vice versa. We will most
  often use the \texttt{.stack()} and \texttt{.unstack()} methods, which
  pivot columns to rows and rows to columns, respectively. Laster in the
  course we will learn about the \texttt{.pivot()} method for
  aggregating data and the \texttt{.melt()} method for more advanced
  reshaping.
\end{enumerate}

\section{Practice}\label{practice-21}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{\texorpdfstring{Download data from Yahoo! Finance for BAC,
C, GS, JPM, MS, and PNC and assign to data frame
\texttt{stocks}.}{Download data from Yahoo! Finance for BAC, C, GS, JPM, MS, and PNC and assign to data frame stocks.}}\label{download-data-from-yahoo-finance-for-bac-c-gs-jpm-ms-and-pnc-and-assign-to-data-frame-stocks.-1}

Use
\texttt{.rename\_axis(columns=stocks.columns.names\ =\ {[}\textquotesingle{}Variable\textquotesingle{},\ \textquotesingle{}Ticker\textquotesingle{}{]})}
to assign the names \texttt{Variable} and \texttt{Ticker} to the column
multi index. We could instead use
\texttt{stocks.columns.names\ =\ {[}\textquotesingle{}Variable\textquotesingle{},\ \textquotesingle{}Ticker\textquotesingle{}{]}},
but we can chain the \texttt{.rename\_axis()} method.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}BAC C GS JPM MS PNC\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  6 of 6 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
Variable & \multicolumn{6}{l}{%
Adj Close} & \multicolumn{4}{l}{%
Close} & ... & \multicolumn{4}{l}{%
Open} & \multicolumn{6}{l@{}}{%
Volume} \\
Ticker & BAC & C & GS & JPM & MS & PNC & BAC & C & GS & JPM & ... & GS &
JPM & MS & PNC & BAC & C & GS & JPM & MS & PNC \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-02-12 & 33.6200 & 53.9200 & 392.6400 & 175.7900 & 86.8700 &
149.1400 & 33.6200 & 53.9200 & 392.6400 & 175.7900 & ... & 385.0000 &
174.7800 & 85.8600 & 147.7700 & 34160400 & 17162300.0000 & 2797200.0000
& 8539300.0000 & 7888000.0000 & 1612700.0000 \\
2024-02-13 & 32.7500 & 52.7600 & 378.7500 & 174.2600 & 83.9700 &
145.2600 & 32.7500 & 52.7600 & 378.7500 & 174.2600 & ... & 387.5900 &
175.3200 & 85.8600 & 146.7800 & 43801500 & 17672100.0000 & 3030800.0000
& 8397600.0000 & 11339400.0000 & 2121400.0000 \\
2024-02-14 & 33.1300 & 53.9800 & 378.0400 & 176.0300 & 84.0000 &
147.8700 & 33.1300 & 53.9800 & 378.0400 & 176.0300 & ... & 380.8800 &
175.0700 & 84.5400 & 146.6300 & 27833900 & 14891900.0000 & 2041300.0000
& 7056700.0000 & 5973700.0000 & 1265300.0000 \\
2024-02-15 & 34.0700 & 55.2100 & 385.4200 & 179.8700 & 85.6700 &
149.6300 & 34.0700 & 55.2100 & 385.4200 & 179.8700 & ... & 379.4200 &
176.1500 & 84.4500 & 148.7500 & 41683100 & 16865000.0000 & 2218900.0000
& 8723400.0000 & 7993500.0000 & 1991800.0000 \\
2024-02-16 & 34.0900 & 54.8500 & 384.4400 & 179.0300 & 86.5000 &
148.8500 & 34.0900 & 54.8500 & 384.4400 & 179.0300 & ... & 383.2400 &
179.6100 & 85.5200 & 148.4200 & 33146357 & 11419637.0000 & 2302099.0000
& 7927785.0000 & 9628557.0000 & 1362728.0000 \\
\end{longtable}

\subsection{\texorpdfstring{Reshape \texttt{stocks} from wide to long
with dates and tickers as row indexes and assign to data frame
\texttt{stocks\_long}.}{Reshape stocks from wide to long with dates and tickers as row indexes and assign to data frame stocks\_long.}}\label{reshape-stocks-from-wide-to-long-with-dates-and-tickers-as-row-indexes-and-assign-to-data-frame-stocks_long.-1}

By default, \texttt{.stack()} stacks the inner column index to the inner
row index.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks\_long }\OperatorTok{=}\NormalTok{ stocks.stack()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks\_long.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllll@{}}
\toprule\noalign{}
& Variable & Adj Close & Close & High & Low & Open & Volume \\
Date & Ticker & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{5}{=}{2024-02-16} & C & 54.8500 & 54.8500 & 55.1950 & 54.5500
& 54.9600 & 11419637.0000 \\
& GS & 384.4400 & 384.4400 & 387.5800 & 380.9450 & 383.2400 &
2302099.0000 \\
& JPM & 179.0300 & 179.0300 & 179.9800 & 178.1600 & 179.6100 &
7927785.0000 \\
& MS & 86.5000 & 86.5000 & 86.7900 & 85.0700 & 85.5200 & 9628557.0000 \\
& PNC & 148.8500 & 148.8500 & 149.9100 & 147.6900 & 148.4200 &
1362728.0000 \\
\end{longtable}

\subsection{\texorpdfstring{Add daily returns for each stock to data
frames \texttt{stocks} and
\texttt{stocks\_long}.}{Add daily returns for each stock to data frames stocks and stocks\_long.}}\label{add-daily-returns-for-each-stock-to-data-frames-stocks-and-stocks_long.-1}

Name the returns variable \texttt{Returns}, and maintain all multi
indexes. \emph{Hint:} Use \texttt{pd.MultiIndex()} to create a multi
index for the the wide data frame \texttt{stocks}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].columns}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Index(['BAC', 'C', 'GS', 'JPM', 'MS', 'PNC'], dtype='object', name='Ticker')
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{], stocks[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].columns])}
\NormalTok{stocks[\_] }\OperatorTok{=}\NormalTok{ stocks[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].pct\_change()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
Variable & \multicolumn{6}{l}{%
Adj Close} & \multicolumn{4}{l}{%
Close} & ... & \multicolumn{4}{l}{%
Volume} & \multicolumn{6}{l@{}}{%
Returns} \\
Ticker & BAC & C & GS & JPM & MS & PNC & BAC & C & GS & JPM & ... & GS &
JPM & MS & PNC & BAC & C & GS & JPM & MS & PNC \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-02-12 & 33.6200 & 53.9200 & 392.6400 & 175.7900 & 86.8700 &
149.1400 & 33.6200 & 53.9200 & 392.6400 & 175.7900 & ... & 2797200.0000
& 8539300.0000 & 7888000.0000 & 1612700.0000 & 0.0166 & -0.0013 & 0.0218
& 0.0045 & 0.0114 & 0.0093 \\
2024-02-13 & 32.7500 & 52.7600 & 378.7500 & 174.2600 & 83.9700 &
145.2600 & 32.7500 & 52.7600 & 378.7500 & 174.2600 & ... & 3030800.0000
& 8397600.0000 & 11339400.0000 & 2121400.0000 & -0.0259 & -0.0215 &
-0.0354 & -0.0087 & -0.0334 & -0.0260 \\
2024-02-14 & 33.1300 & 53.9800 & 378.0400 & 176.0300 & 84.0000 &
147.8700 & 33.1300 & 53.9800 & 378.0400 & 176.0300 & ... & 2041300.0000
& 7056700.0000 & 5973700.0000 & 1265300.0000 & 0.0116 & 0.0231 & -0.0019
& 0.0102 & 0.0004 & 0.0180 \\
2024-02-15 & 34.0700 & 55.2100 & 385.4200 & 179.8700 & 85.6700 &
149.6300 & 34.0700 & 55.2100 & 385.4200 & 179.8700 & ... & 2218900.0000
& 8723400.0000 & 7993500.0000 & 1991800.0000 & 0.0284 & 0.0228 & 0.0195
& 0.0218 & 0.0199 & 0.0119 \\
2024-02-16 & 34.0900 & 54.8500 & 384.4400 & 179.0300 & 86.5000 &
148.8500 & 34.0900 & 54.8500 & 384.4400 & 179.0300 & ... & 2302099.0000
& 7927785.0000 & 9628557.0000 & 1362728.0000 & NaN & NaN & NaN & NaN &
NaN & NaN \\
\end{longtable}

The easiest way to add returns to long data frame \texttt{stocks\_long}
is to \texttt{.stack()} the wide data frame \texttt{stocks}! We could
sort \texttt{stocks\_long} by ticker and date (to sort chronologically
within each ticker), then use \texttt{.pct\_change()}. However, this
approach miscalculates the first return for every ticker except for the
first ticker. The easiest and safest solution is to \texttt{.stack()}
the wide data frame \texttt{stocks}!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks\_long }\OperatorTok{=}\NormalTok{ stocks.stack()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks\_long.tail(}\DecValTok{12}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllll@{}}
\toprule\noalign{}
& Variable & Adj Close & Close & High & Low & Open & Volume & Returns \\
Date & Ticker & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{6}{=}{2024-02-15} & BAC & 34.0700 & 34.0700 & 34.2400 &
33.3200 & 33.3200 & 41683100.0000 & 0.0284 \\
& C & 55.2100 & 55.2100 & 55.4800 & 54.1400 & 54.2200 & 16865000.0000 &
0.0228 \\
& GS & 385.4200 & 385.4200 & 387.2100 & 379.1400 & 379.4200 &
2218900.0000 & 0.0195 \\
& JPM & 179.8700 & 179.8700 & 180.2100 & 176.1500 & 176.1500 &
8723400.0000 & 0.0218 \\
& MS & 85.6700 & 85.6700 & 86.2300 & 84.4100 & 84.4500 & 7993500.0000 &
0.0199 \\
& PNC & 149.6300 & 149.6300 & 150.2600 & 147.3700 & 148.7500 &
1991800.0000 & 0.0119 \\
\multirow{6}{=}{2024-02-16} & BAC & 34.0900 & 34.0900 & 34.1500 &
32.4900 & 33.9200 & 33146357.0000 & NaN \\
& C & 54.8500 & 54.8500 & 55.1950 & 54.5500 & 54.9600 & 11419637.0000 &
NaN \\
& GS & 384.4400 & 384.4400 & 387.5800 & 380.9450 & 383.2400 &
2302099.0000 & NaN \\
& JPM & 179.0300 & 179.0300 & 179.9800 & 178.1600 & 179.6100 &
7927785.0000 & NaN \\
& MS & 86.5000 & 86.5000 & 86.7900 & 85.0700 & 85.5200 & 9628557.0000 &
NaN \\
& PNC & 148.8500 & 148.8500 & 149.9100 & 147.6900 & 148.4200 &
1362728.0000 & NaN \\
\end{longtable}

\subsection{Download the daily benchmark return factors from Ken
French's data
library.}\label{download-the-daily-benchmark-return-factors-from-ken-frenchs-data-library.-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pdr.famafrench.get\_available\_datasets()[:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['F-F_Research_Data_Factors',
 'F-F_Research_Data_Factors_weekly',
 'F-F_Research_Data_Factors_daily',
 'F-F_Research_Data_5_Factors_2x3',
 'F-F_Research_Data_5_Factors_2x3_daily']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pdr.DataReader(}
\NormalTok{        name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{        data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{        start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{    )}
\NormalTok{    [}\DecValTok{0}\NormalTok{]}
\NormalTok{    .div(}\DecValTok{100}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_13756\2049483829.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& Mkt-RF & SMB & HML & RF \\
Date & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2023-12-22 & 0.0021 & 0.0064 & 0.0009 & 0.0002 \\
2023-12-26 & 0.0048 & 0.0069 & 0.0046 & 0.0002 \\
2023-12-27 & 0.0016 & 0.0014 & 0.0012 & 0.0002 \\
2023-12-28 & -0.0001 & -0.0036 & 0.0003 & 0.0002 \\
2023-12-29 & -0.0043 & -0.0112 & -0.0037 & 0.0002 \\
\end{longtable}

\subsection{\texorpdfstring{Add the daily benchmark return factors to
\texttt{stocks} and
\texttt{stocks\_long}.}{Add the daily benchmark return factors to stocks and stocks\_long.}}\label{add-the-daily-benchmark-return-factors-to-stocks-and-stocks_long.-1}

For the wide data frame \texttt{stocks}, use the outer index name
\texttt{Factors}.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# stocks.join(ff)}
\CommentTok{\# MergeError: Not allowed to merge between different levels. (2 levels on the left, 1 on the right)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Factors\textquotesingle{}}\NormalTok{], ff.columns])}
\NormalTok{stocks[\_] }\OperatorTok{=}\NormalTok{ ff}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
Variable & \multicolumn{6}{l}{%
Adj Close} & \multicolumn{4}{l}{%
Close} & ... & \multicolumn{6}{l}{%
Returns} & \multicolumn{4}{l@{}}{%
Factors} \\
Ticker & BAC & C & GS & JPM & MS & PNC & BAC & C & GS & JPM & ... & BAC
& C & GS & JPM & MS & PNC & Mkt-RF & SMB & HML & RF \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1973-02-21 & 1.5818 & NaN & NaN & NaN & NaN & NaN & 4.6250 & NaN & NaN &
NaN & ... & NaN & NaN & NaN & NaN & NaN & NaN & -0.0074 & -0.0039 &
0.0054 & 0.0002 \\
1973-02-22 & 1.5872 & NaN & NaN & NaN & NaN & NaN & 4.6406 & NaN & NaN &
NaN & ... & 0.0034 & NaN & NaN & NaN & NaN & NaN & -0.0030 & -0.0037 &
0.0022 & 0.0002 \\
1973-02-23 & 1.5818 & NaN & NaN & NaN & NaN & NaN & 4.6250 & NaN & NaN &
NaN & ... & -0.0034 & NaN & NaN & NaN & NaN & NaN & -0.0108 & -0.0019 &
0.0054 & 0.0002 \\
1973-02-26 & 1.5818 & NaN & NaN & NaN & NaN & NaN & 4.6250 & NaN & NaN &
NaN & ... & 0.0000 & NaN & NaN & NaN & NaN & NaN & -0.0088 & -0.0050 &
0.0054 & 0.0002 \\
1973-02-27 & 1.5818 & NaN & NaN & NaN & NaN & NaN & 4.6250 & NaN & NaN &
NaN & ... & 0.0000 & NaN & NaN & NaN & NaN & NaN & -0.0115 & -0.0018 &
0.0064 & 0.0002 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2024-02-12 & 33.6200 & 53.9200 & 392.6400 & 175.7900 & 86.8700 &
149.1400 & 33.6200 & 53.9200 & 392.6400 & 175.7900 & ... & 0.0166 &
-0.0013 & 0.0218 & 0.0045 & 0.0114 & 0.0093 & NaN & NaN & NaN & NaN \\
2024-02-13 & 32.7500 & 52.7600 & 378.7500 & 174.2600 & 83.9700 &
145.2600 & 32.7500 & 52.7600 & 378.7500 & 174.2600 & ... & -0.0259 &
-0.0215 & -0.0354 & -0.0087 & -0.0334 & -0.0260 & NaN & NaN & NaN &
NaN \\
2024-02-14 & 33.1300 & 53.9800 & 378.0400 & 176.0300 & 84.0000 &
147.8700 & 33.1300 & 53.9800 & 378.0400 & 176.0300 & ... & 0.0116 &
0.0231 & -0.0019 & 0.0102 & 0.0004 & 0.0180 & NaN & NaN & NaN & NaN \\
2024-02-15 & 34.0700 & 55.2100 & 385.4200 & 179.8700 & 85.6700 &
149.6300 & 34.0700 & 55.2100 & 385.4200 & 179.8700 & ... & 0.0284 &
0.0228 & 0.0195 & 0.0218 & 0.0199 & 0.0119 & NaN & NaN & NaN & NaN \\
2024-02-16 & 34.0900 & 54.8500 & 384.4400 & 179.0300 & 86.5000 &
148.8500 & 34.0900 & 54.8500 & 384.4400 & 179.0300 & ... & NaN & NaN &
NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks\_long }\OperatorTok{=}\NormalTok{ stocks\_long.join(ff)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks\_long.loc[}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{].tail(}\DecValTok{12}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllll@{}}
\toprule\noalign{}
& & Adj Close & Close & High & Low & Open & Volume & Returns & Mkt-RF &
SMB & HML & RF \\
Date & Ticker & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{6}{=}{2023-12-28} & BAC & 33.8800 & 33.8800 & 33.9700 &
33.7700 & 33.8200 & 21799600.0000 & 0.0012 & -0.0001 & -0.0036 & 0.0003
& 0.0002 \\
& C & 51.0329 & 51.5200 & 51.8000 & 51.4000 & 51.4000 & 10218500.0000 &
0.0012 & -0.0001 & -0.0036 & 0.0003 & 0.0002 \\
& GS & 386.4100 & 386.4100 & 387.7600 & 383.6300 & 384.5200 &
1024700.0000 & 0.0050 & -0.0001 & -0.0036 & 0.0003 & 0.0002 \\
& JPM & 169.2563 & 170.3000 & 170.6600 & 169.0000 & 169.3500 &
6320100.0000 & 0.0053 & -0.0001 & -0.0036 & 0.0003 & 0.0002 \\
& MS & 92.7316 & 93.6400 & 93.9500 & 93.2400 & 93.3100 & 4089500.0000 &
-0.0002 & -0.0001 & -0.0036 & 0.0003 & 0.0002 \\
& PNC & 154.0486 & 155.6300 & 156.2100 & 154.9500 & 155.4400 &
1153300.0000 & 0.0041 & -0.0001 & -0.0036 & 0.0003 & 0.0002 \\
\multirow{6}{=}{2023-12-29} & BAC & 33.6700 & 33.6700 & 33.9900 &
33.5500 & 33.9400 & 28037800.0000 & -0.0062 & -0.0043 & -0.0112 &
-0.0037 & 0.0002 \\
& C & 50.9537 & 51.4400 & 51.6100 & 51.2200 & 51.5600 & 13147900.0000 &
-0.0016 & -0.0043 & -0.0112 & -0.0037 & 0.0002 \\
& GS & 385.7700 & 385.7700 & 386.6400 & 383.5700 & 385.5700 &
881300.0000 & -0.0017 & -0.0043 & -0.0112 & -0.0037 & 0.0002 \\
& JPM & 169.0575 & 170.1000 & 170.6900 & 169.6300 & 170.0000 &
6431800.0000 & -0.0012 & -0.0043 & -0.0112 & -0.0037 & 0.0002 \\
& MS & 92.3454 & 93.2500 & 93.7700 & 93.0600 & 93.4900 & 4772100.0000 &
-0.0042 & -0.0043 & -0.0112 & -0.0037 & 0.0002 \\
& PNC & 153.2765 & 154.8500 & 156.1100 & 154.5200 & 155.2700 &
1572600.0000 & -0.0050 & -0.0043 & -0.0112 & -0.0037 & 0.0002 \\
\end{longtable}

\subsection{\texorpdfstring{Write a function \texttt{download()} that
accepts tickers and returns a wide data frame of returns with the daily
benchmark return
factors.}{Write a function download() that accepts tickers and returns a wide data frame of returns with the daily benchmark return factors.}}\label{write-a-function-download-that-accepts-tickers-and-returns-a-wide-data-frame-of-returns-with-the-daily-benchmark-return-factors.-1}

We can even add a \texttt{shape} argument to return a wide or long data
frame!

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ download(tickers, shape}\OperatorTok{=}\StringTok{\textquotesingle{}wide\textquotesingle{}}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ shape.lower() }\KeywordTok{not} \KeywordTok{in}\NormalTok{ [}\StringTok{\textquotesingle{}wide\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}long\textquotesingle{}}\NormalTok{]:}
        \ControlFlowTok{raise} \PreprocessorTok{ValueError}\NormalTok{(}\StringTok{\textquotesingle{}Invalid shape: must be "wide" or "long".\textquotesingle{}}\NormalTok{)}

\NormalTok{    stocks }\OperatorTok{=}\NormalTok{ yf.download(tickers)}

\NormalTok{    factors\_all }\OperatorTok{=}\NormalTok{ (}
\NormalTok{        pdr.DataReader(}
\NormalTok{            name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{            data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{            start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{        )}
\NormalTok{    )}
    
\NormalTok{    factors }\OperatorTok{=}\NormalTok{ factors\_all[}\DecValTok{0}\NormalTok{].div(}\DecValTok{100}\NormalTok{)}
    
    \CommentTok{\# if stocks has a multi index on the columns because we asked for more than one ticker}
    \CommentTok{\# then we have more work to do}
    \ControlFlowTok{if} \BuiltInTok{type}\NormalTok{(stocks.columns) }\KeywordTok{is}\NormalTok{ pd.MultiIndex:}
        
        \CommentTok{\# whether we want a wide or long data frame, it is easier to add returns to a wide data frame}
\NormalTok{        \_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{], stocks[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].columns])}
\NormalTok{        stocks[\_] }\OperatorTok{=}\NormalTok{ stocks[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].pct\_change()}

        \CommentTok{\# if we want a wide data frame, then we need a factors multi index}
        \ControlFlowTok{if}\NormalTok{ shape.lower() }\OperatorTok{==} \StringTok{\textquotesingle{}wide\textquotesingle{}}\NormalTok{:}
\NormalTok{            \_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Factors\textquotesingle{}}\NormalTok{], factors.columns])}
\NormalTok{            stocks[\_] }\OperatorTok{=}\NormalTok{ factors}
            \ControlFlowTok{return}\NormalTok{ stocks.rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}

        \CommentTok{\# if we want a long data frame, then we need to stack stocks and join factors}
        \CommentTok{\# because we tested for wide and long above, we know that here shape must be long}
        \ControlFlowTok{else}\NormalTok{:}
            \ControlFlowTok{return}\NormalTok{ stocks.stack().join(factors).rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{], index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
            
    \CommentTok{\# if stocks does not have a multi index on the columns}
    \CommentTok{\# then we only have join factors}
    \ControlFlowTok{else}\NormalTok{:}
        \ControlFlowTok{return}\NormalTok{ stocks.join(ff).rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{download(tickers}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}AAPL\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{], shape}\OperatorTok{=}\StringTok{\textquotesingle{}long\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  2 of 2 completed
C:\Users\r.herron\AppData\Local\Temp\ipykernel_13756\3667605341.py:8: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{longtable}[]{@{}lllllllllllll@{}}
\toprule\noalign{}
& Variable & Adj Close & Close & High & Low & Open & Volume & Returns &
Mkt-RF & SMB & HML & RF \\
Date & Ticker & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1980-12-12 & AAPL & 0.0992 & 0.1283 & 0.1289 & 0.1283 & 0.1283 &
469033600.0000 & NaN & 0.0138 & -0.0001 & -0.0105 & 0.0006 \\
1980-12-15 & AAPL & 0.0940 & 0.1217 & 0.1222 & 0.1217 & 0.1222 &
175884800.0000 & -0.0522 & 0.0011 & 0.0025 & -0.0046 & 0.0006 \\
1980-12-16 & AAPL & 0.0871 & 0.1127 & 0.1133 & 0.1127 & 0.1133 &
105728000.0000 & -0.0734 & 0.0071 & -0.0075 & -0.0047 & 0.0006 \\
1980-12-17 & AAPL & 0.0893 & 0.1155 & 0.1161 & 0.1155 & 0.1155 &
86441600.0000 & 0.0248 & 0.0152 & -0.0086 & -0.0034 & 0.0006 \\
1980-12-18 & AAPL & 0.0919 & 0.1189 & 0.1194 & 0.1189 & 0.1189 &
73449600.0000 & 0.0290 & 0.0041 & 0.0022 & 0.0126 & 0.0006 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... \\
2024-02-14 & TSLA & 188.7100 & 188.7100 & 188.8900 & 183.3500 & 185.3000
& 81203000.0000 & 0.0255 & NaN & NaN & NaN & NaN \\
\multirow{2}{=}{2024-02-15} & AAPL & 183.8600 & 183.8600 & 184.4900 &
181.3500 & 183.5500 & 65434500.0000 & -0.0016 & NaN & NaN & NaN & NaN \\
& TSLA & 200.4500 & 200.4500 & 200.8800 & 188.8600 & 189.1600 &
120831800.0000 & 0.0622 & NaN & NaN & NaN & NaN \\
\multirow{2}{=}{2024-02-16} & AAPL & 182.3100 & 182.3100 & 184.8500 &
181.6650 & 183.4200 & 48627624.0000 & -0.0084 & NaN & NaN & NaN & NaN \\
& TSLA & 199.9500 & 199.9500 & 203.1700 & 197.4000 & 202.0600 &
110528448.0000 & -0.0025 & NaN & NaN & NaN & NaN \\
\end{longtable}

\subsection{\texorpdfstring{Download earnings per share for the stocks
in \texttt{stocks} and combine to a long data frame
\texttt{earnings}.}{Download earnings per share for the stocks in stocks and combine to a long data frame earnings.}}\label{download-earnings-per-share-for-the-stocks-in-stocks-and-combine-to-a-long-data-frame-earnings.-1}

Use the \texttt{.earnings\_dates} method described
\href{https://pypi.org/project/yfinance/}{here}. Use
\texttt{pd.concat()} to combine the result of each the
\texttt{.earnings\_date} data frames and assign them to a new data frame
\texttt{earnings}. Name the row indexes \texttt{Ticker} and
\texttt{Date} and swap to match the order of the row index in
\texttt{stocks\_long}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tickers }\OperatorTok{=}\NormalTok{ yf.Tickers(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}BAC C GS JPM MS PNC\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{earnings  }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat(}
\NormalTok{        objs}\OperatorTok{=}\NormalTok{[tickers.tickers[t].earnings\_dates }\ControlFlowTok{for}\NormalTok{ t }\KeywordTok{in}\NormalTok{ tickers.tickers],}
\NormalTok{        keys}\OperatorTok{=}\NormalTok{tickers.tickers,}
\NormalTok{        names}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{]}
\NormalTok{    )}
\NormalTok{    .reset\_index()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{earnings.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& Ticker & Date & EPS Estimate & Reported EPS & Surprise(\%) \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
67 & PNC & 2024-04-16 08:00:00-04:00 & 3.0800 & NaN & NaN \\
68 & PNC & 2024-01-16 06:00:00-05:00 & 2.9400 & 3.1600 & 0.0737 \\
69 & PNC & 2023-10-13 06:00:00-04:00 & 3.1100 & 3.6000 & 0.1586 \\
70 & PNC & 2023-07-18 07:00:00-04:00 & 3.2800 & 3.3600 & 0.0230 \\
71 & PNC & 2023-04-14 06:00:00-04:00 & 3.6700 & 3.9800 & 0.0847 \\
\end{longtable}

\subsection{\texorpdfstring{Combine \texttt{earnings} with the returns
from
\texttt{stocks\_long}.}{Combine earnings with the returns from stocks\_long.}}\label{combine-earnings-with-the-returns-from-stocks_long.-1}

Use the
\texttt{tz\_localize(\textquotesingle{}America/New\_York\textquotesingle{})}
method add time zone information back to \texttt{returns.index} and use
\texttt{pd.to\_timedelta(16,\ unit=\textquotesingle{}h\textquotesingle{})}
to set time to the market close in New York City. Use
\href{https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.merge_asof.html}{\texttt{pd.merge\_asof()}}
to match earnings announcement dates and times to appropriate return
periods. For example, if a firm announces earnings after the close at 5
PM on February 7, we want to match the return period from 4 PM on
February 7 to 4 PM on February 8.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    stocks\_long}
\NormalTok{    .reset\_index()}
\NormalTok{    [[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .assign(}
\NormalTok{        Date}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{].dt.tz\_localize(}\StringTok{\textquotesingle{}America/New\_York\textquotesingle{}}\NormalTok{) }\OperatorTok{+}\NormalTok{ pd.to\_timedelta(}\DecValTok{16}\NormalTok{, unit}\OperatorTok{=}\StringTok{\textquotesingle{}H\textquotesingle{}}\NormalTok{)}
\NormalTok{    )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& Date & Ticker & Returns \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
62021 & 2024-02-16 16:00:00-05:00 & C & NaN \\
62022 & 2024-02-16 16:00:00-05:00 & GS & NaN \\
62023 & 2024-02-16 16:00:00-05:00 & JPM & NaN \\
62024 & 2024-02-16 16:00:00-05:00 & MS & NaN \\
62025 & 2024-02-16 16:00:00-05:00 & PNC & NaN \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{surprises }\OperatorTok{=}\NormalTok{ pd.merge\_asof(}
\NormalTok{    left}\OperatorTok{=}\NormalTok{earnings.sort\_values([}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{]),}
\NormalTok{    right}\OperatorTok{=}\NormalTok{returns.sort\_values([}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{]),}
\NormalTok{    on}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{,}
\NormalTok{    by}\OperatorTok{=}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{,}
\NormalTok{    direction}\OperatorTok{=}\StringTok{\textquotesingle{}forward\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{surprises.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& Ticker & Date & EPS Estimate & Reported EPS & Surprise(\%) &
Returns \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
67 & JPM & 2025-01-15 08:00:00-05:00 & NaN & NaN & NaN & NaN \\
68 & JPM & 2025-01-15 08:00:00-05:00 & NaN & NaN & NaN & NaN \\
69 & C & 2025-01-15 11:00:00-05:00 & NaN & NaN & NaN & NaN \\
70 & PNC & 2025-01-16 08:00:00-05:00 & NaN & NaN & NaN & NaN \\
71 & PNC & 2025-01-16 10:00:00-05:00 & NaN & NaN & NaN & NaN \\
\end{longtable}

\subsection{Plot the relation between daily returns and earnings
surprises}\label{plot-the-relation-between-daily-returns-and-earnings-surprises-1}

Three options in increasing difficulty:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Scatter plot
\item
  Scatter plot with a best-fit line using \texttt{regplot()} from the
  seaborn package
\item
  Bar plot using \texttt{barplot()} from the seaborn package after using
  \texttt{pd.qcut()} to form five groups on earnings surprises
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    surprises}
\NormalTok{    [[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}scatter\textquotesingle{}}\NormalTok{, x}\OperatorTok{=}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, y}\OperatorTok{=}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Earnings Surprise (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Day Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Earnings Surprise Analysis}\CharTok{\textbackslash{}n}\SpecialStringTok{ }\SpecialCharTok{\{}\StringTok{\textquotesingle{}, \textquotesingle{}}\SpecialCharTok{.}\NormalTok{join(tickers.tickers)}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_08_practice_03_files/figure-pdf/cell-30-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ seaborn }\ImportTok{as}\NormalTok{ sns}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.regplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{surprises[[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]].mul(}\DecValTok{100}\NormalTok{),}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Returns\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Earnings Surprise (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Day Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Earnings Surprise Analysis}\CharTok{\textbackslash{}n}\SpecialStringTok{ }\SpecialCharTok{\{}\StringTok{\textquotesingle{}, \textquotesingle{}}\SpecialCharTok{.}\NormalTok{join(tickers.tickers)}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_08_practice_03_files/figure-pdf/cell-32-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.catplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{(}
\NormalTok{        surprises[[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]]}
\NormalTok{        .dropna()}
\NormalTok{        .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{        .assign(}
\NormalTok{            surprise\_bin}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: pd.qcut(x[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{], q}\OperatorTok{=}\DecValTok{5}\NormalTok{, labels}\OperatorTok{=}\VariableTok{False}\NormalTok{)}\OperatorTok{+}\DecValTok{1}
\NormalTok{        )}
\NormalTok{    ),}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}surprise\_bin\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{,}
\NormalTok{    kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Earnings Surprise Bin (1=Lowest, 5=Highest)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Day Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Earnings Surprise Analysis}\CharTok{\textbackslash{}n}\SpecialStringTok{ }\SpecialCharTok{\{}\StringTok{\textquotesingle{}, \textquotesingle{}}\SpecialCharTok{.}\NormalTok{join(tickers.tickers)}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_08_practice_03_files/figure-pdf/cell-33-output-1.png}

\subsection{Repeat the earnings exercise with the S\&P 100
stocks}\label{repeat-the-earnings-exercise-with-the-sp-100-stocks-1}

With more data, we can more clearly see the positive relation between
earnings surprises and returns!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ pd.read\_html(}\StringTok{\textquotesingle{}https://en.wikipedia.org/wiki/S\%26P\_100\textquotesingle{}}\NormalTok{)[}\DecValTok{2}\NormalTok{][}\StringTok{\textquotesingle{}Symbol\textquotesingle{}}\NormalTok{].to\_list()}
\NormalTok{tickers\_2 }\OperatorTok{=}\NormalTok{ yf.Tickers(tickers}\OperatorTok{=}\NormalTok{[t.replace(}\StringTok{\textquotesingle{}.\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}{-}\textquotesingle{}}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ t }\KeywordTok{in}\NormalTok{ \_]) }\CommentTok{\# Yahoo! Finance uses "{-}" to indicate share classes instead of "."}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{earnings\_2  }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat(}
\NormalTok{        objs}\OperatorTok{=}\NormalTok{[tickers\_2.tickers[t].earnings\_dates }\ControlFlowTok{for}\NormalTok{ t }\KeywordTok{in}\NormalTok{ tickers\_2.tickers],}
\NormalTok{        keys}\OperatorTok{=}\NormalTok{tickers\_2.tickers,}
\NormalTok{        names}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{]}
\NormalTok{    )}
\NormalTok{    .reset\_index()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{earnings\_2.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& Ticker & Date & EPS Estimate & Reported EPS & Surprise(\%) \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1207 & XOM & 2023-04-28 06:00:00-04:00 & 2.5900 & 2.8300 & 0.0943 \\
1208 & XOM & 2023-01-31 06:00:00-05:00 & 3.2900 & 3.4000 & 0.0319 \\
1209 & XOM & 2022-10-28 06:00:00-04:00 & 3.7900 & 4.4500 & 0.1733 \\
1210 & XOM & 2022-07-29 06:00:00-04:00 & 3.7400 & 4.1400 & 0.1077 \\
1211 & XOM & 2022-04-29 06:00:00-04:00 & 2.1200 & 2.0700 & -0.0247 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\NormalTok{[t }\ControlFlowTok{for}\NormalTok{ t }\KeywordTok{in}\NormalTok{ tickers\_2.tickers])}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
\NormalTok{    [}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .pct\_change()}
\NormalTok{    .stack()}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{)}
\NormalTok{    .reset\_index()}
\NormalTok{    [[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .assign(}
\NormalTok{        Date}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{].dt.tz\_localize(}\StringTok{\textquotesingle{}America/New\_York\textquotesingle{}}\NormalTok{) }\OperatorTok{+}\NormalTok{ pd.to\_timedelta(}\DecValTok{16}\NormalTok{, unit}\OperatorTok{=}\StringTok{\textquotesingle{}H\textquotesingle{}}\NormalTok{)}
\NormalTok{    )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  101 of 101 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& Date & Ticker & Returns \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1018569 & 2024-02-16 16:00:00-05:00 & V & -0.0086 \\
1018570 & 2024-02-16 16:00:00-05:00 & VZ & -0.0025 \\
1018571 & 2024-02-16 16:00:00-05:00 & WFC & -0.0025 \\
1018572 & 2024-02-16 16:00:00-05:00 & WMT & 0.0063 \\
1018573 & 2024-02-16 16:00:00-05:00 & XOM & 0.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{surprises\_2 }\OperatorTok{=}\NormalTok{ pd.merge\_asof(}
\NormalTok{    left}\OperatorTok{=}\NormalTok{earnings\_2.sort\_values([}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{]),}
\NormalTok{    right}\OperatorTok{=}\NormalTok{returns\_2.sort\_values([}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{]),}
\NormalTok{    on}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{,}
\NormalTok{    by}\OperatorTok{=}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{,}
\NormalTok{    direction}\OperatorTok{=}\StringTok{\textquotesingle{}forward\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{surprises\_2.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& Ticker & Date & EPS Estimate & Reported EPS & Surprise(\%) &
Returns \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1207 & USB & 2025-10-16 09:00:00-04:00 & NaN & NaN & NaN & NaN \\
1208 & USB & 2025-10-16 09:00:00-04:00 & NaN & NaN & NaN & NaN \\
1209 & RTX & 2025-10-20 06:00:00-04:00 & NaN & NaN & NaN & NaN \\
1210 & USB & 2026-01-20 09:00:00-05:00 & NaN & NaN & NaN & NaN \\
1211 & USB & 2026-01-20 09:00:00-05:00 & NaN & NaN & NaN & NaN \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    surprises\_2}
\NormalTok{    [[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}scatter\textquotesingle{}}\NormalTok{, x}\OperatorTok{=}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, y}\OperatorTok{=}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Earnings Surprise (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Day Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Earnings Surprise Analysis}\CharTok{\textbackslash{}n}\StringTok{ S\&P 100 Stocks\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_08_practice_03_files/figure-pdf/cell-41-output-1.png}

\textbf{\emph{There are a few large negative and positive earnings
surprises that make our plot difficult to interpret!}} We have these
huge outliers because surprises are defined as the percent change
relative to the expected. If expected is a very small number, then the
surprise can be a very large number! We would use different surprise
definitions for a more rigorous analysis. Here we can drop observations
less than the 0.01 quantile and greater than the 0.99 quantile.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{low\_2 }\OperatorTok{=}\NormalTok{ surprises\_2[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{].quantile(}\FloatTok{0.01}\NormalTok{)}
\NormalTok{high\_2 }\OperatorTok{=}\NormalTok{ surprises\_2[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{].quantile(}\FloatTok{0.91}\NormalTok{)}

\NormalTok{cond\_2 }\OperatorTok{=}\NormalTok{ surprises\_2[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{].between(low\_2, high\_2)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    surprises\_2}
\NormalTok{    .loc[cond\_2, [}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}scatter\textquotesingle{}}\NormalTok{, x}\OperatorTok{=}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, y}\OperatorTok{=}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.5}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Earnings Surprise (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Day Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Earnings Surprise Analysis}\CharTok{\textbackslash{}n}\StringTok{ S\&P 100 Stocks\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_08_practice_03_files/figure-pdf/cell-43-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.regplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{surprises\_2.loc[cond\_2, [}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]].mul(}\DecValTok{100}\NormalTok{),}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Returns\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Earnings Surprise (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Day Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Earnings Surprise Analysis}\CharTok{\textbackslash{}n}\StringTok{ S\&P 100 Stocks\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_08_practice_03_files/figure-pdf/cell-44-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.catplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{(}
\NormalTok{        surprises\_2}
\NormalTok{        .loc[cond\_2, [}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]]}
\NormalTok{        .dropna()}
\NormalTok{        .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{        .assign(surprise\_bin}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: pd.qcut(x[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{], q}\OperatorTok{=}\DecValTok{5}\NormalTok{, labels}\OperatorTok{=}\VariableTok{False}\NormalTok{) }\OperatorTok{+} \DecValTok{1}\NormalTok{)}
\NormalTok{    ),}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}surprise\_bin\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{,}
\NormalTok{    kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Earnings Surprise Bin (1=Lowest, 5=Highest)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Day Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Earnings Surprise Analysis}\CharTok{\textbackslash{}n}\StringTok{ S\&P 100 Stocks\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_08_practice_03_files/figure-pdf/cell-45-output-1.png}

\chapter{McKinney Chapter 8 - Practice for Section
04}\label{mckinney-chapter-8---practice-for-section-04}

\section{Announcements}\label{announcements-22}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \emph{Joining Data with pandas}, our fourth and final DataCamp course,
  is due by Friday, 2/16, at 11:59 PM
\item
  We will use class next week, from 2/19 through 2/23, for group work on
  Project 1, so there is no lecture video or pre-class quiz
\item
  Project 1 is due by Tuesday, 2/27, at 8:25 AM
\item
  Please complete the
  \href{https://northeastern.instructure.com/courses/171271/quizzes/586970}{anonymous
  ungraded survey on Canvas} to help me help you learn better:
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-21}

Chapter 8 of McKinney covers 3 topics.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \emph{Hierarchical Indexing:} Hierarchical indexing helps us organize
  data at multiple levels, rather than just a flat, two-dimensional
  structure. It helps is work with high-dimensional data in a
  low-dimensional form. For example, we can index rows by multiple
  levels like ``ticker'' and ``date'', or columns by ``variable'' and
  ``ticker''.
\item
  \emph{Combining Data:} We can combine datasets on one or more keys.

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    We will use the \texttt{pd.merge()} function for database-style
    joins, which can be \texttt{inner}, \texttt{outer}, \texttt{left},
    or \texttt{right} joins.
  \item
    We will use the \texttt{.join()} method to combine data frames with
    similar indexes.
  \item
    We will use the \texttt{pd.concat()} to combine similarly-shaped
    series and data frames.
  \end{enumerate}
\item
  \emph{Reshaping Data:} We can reshape data to change its structure,
  such as pivoting from wide to long format or vice versa. We will most
  often use the \texttt{.stack()} and \texttt{.unstack()} methods, which
  pivot columns to rows and rows to columns, respectively. Laster in the
  course we will learn about the \texttt{.pivot()} method for
  aggregating data and the \texttt{.melt()} method for more advanced
  reshaping.
\end{enumerate}

\section{Practice}\label{practice-22}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{\texorpdfstring{Download data from Yahoo! Finance for BAC,
C, GS, JPM, MS, and PNC and assign to data frame
\texttt{stocks}.}{Download data from Yahoo! Finance for BAC, C, GS, JPM, MS, and PNC and assign to data frame stocks.}}\label{download-data-from-yahoo-finance-for-bac-c-gs-jpm-ms-and-pnc-and-assign-to-data-frame-stocks.-2}

Use
\texttt{.rename\_axis(columns=stocks.columns.names\ =\ {[}\textquotesingle{}Variable\textquotesingle{},\ \textquotesingle{}Ticker\textquotesingle{}{]})}
to assign the names \texttt{Variable} and \texttt{Ticker} to the column
multi index. We could instead use
\texttt{stocks.columns.names\ =\ {[}\textquotesingle{}Variable\textquotesingle{},\ \textquotesingle{}Ticker\textquotesingle{}{]}},
but we can chain the \texttt{.rename\_axis()} method.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}BAC C GS JPM MS PNC\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  6 of 6 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
Variable & \multicolumn{6}{l}{%
Adj Close} & \multicolumn{4}{l}{%
Close} & ... & \multicolumn{4}{l}{%
Open} & \multicolumn{6}{l@{}}{%
Volume} \\
Ticker & BAC & C & GS & JPM & MS & PNC & BAC & C & GS & JPM & ... & GS &
JPM & MS & PNC & BAC & C & GS & JPM & MS & PNC \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-02-12 & 33.6200 & 53.9200 & 392.6400 & 175.7900 & 86.8700 &
149.1400 & 33.6200 & 53.9200 & 392.6400 & 175.7900 & ... & 385.0000 &
174.7800 & 85.8600 & 147.7700 & 34160400 & 17162300.0000 & 2797200.0000
& 8539300.0000 & 7888000.0000 & 1612700.0000 \\
2024-02-13 & 32.7500 & 52.7600 & 378.7500 & 174.2600 & 83.9700 &
145.2600 & 32.7500 & 52.7600 & 378.7500 & 174.2600 & ... & 387.5900 &
175.3200 & 85.8600 & 146.7800 & 43801500 & 17672100.0000 & 3030800.0000
& 8397600.0000 & 11339400.0000 & 2121400.0000 \\
2024-02-14 & 33.1300 & 53.9800 & 378.0400 & 176.0300 & 84.0000 &
147.8700 & 33.1300 & 53.9800 & 378.0400 & 176.0300 & ... & 380.8800 &
175.0700 & 84.5400 & 146.6300 & 27833900 & 14891900.0000 & 2041300.0000
& 7056700.0000 & 5973700.0000 & 1265300.0000 \\
2024-02-15 & 34.0700 & 55.2100 & 385.4200 & 179.8700 & 85.6700 &
149.6300 & 34.0700 & 55.2100 & 385.4200 & 179.8700 & ... & 379.4200 &
176.1500 & 84.4500 & 148.7500 & 41683100 & 16865000.0000 & 2218900.0000
& 8723400.0000 & 7993500.0000 & 1991800.0000 \\
2024-02-16 & 34.0900 & 54.8500 & 384.4400 & 179.0300 & 86.5000 &
148.8500 & 34.0900 & 54.8500 & 384.4400 & 179.0300 & ... & 383.2400 &
179.6100 & 85.5200 & 148.4200 & 33146357 & 11419637.0000 & 2302099.0000
& 7927785.0000 & 9628557.0000 & 1362728.0000 \\
\end{longtable}

\subsection{\texorpdfstring{Reshape \texttt{stocks} from wide to long
with dates and tickers as row indexes and assign to data frame
\texttt{stocks\_long}.}{Reshape stocks from wide to long with dates and tickers as row indexes and assign to data frame stocks\_long.}}\label{reshape-stocks-from-wide-to-long-with-dates-and-tickers-as-row-indexes-and-assign-to-data-frame-stocks_long.-2}

By default, \texttt{.stack()} stacks the inner column index to the inner
row index.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks\_long }\OperatorTok{=}\NormalTok{ stocks.stack()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks\_long.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllll@{}}
\toprule\noalign{}
& Variable & Adj Close & Close & High & Low & Open & Volume \\
Date & Ticker & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{5}{=}{2024-02-16} & C & 54.8500 & 54.8500 & 55.1950 & 54.5500
& 54.9600 & 11419637.0000 \\
& GS & 384.4400 & 384.4400 & 387.5800 & 380.9450 & 383.2400 &
2302099.0000 \\
& JPM & 179.0300 & 179.0300 & 179.9800 & 178.1600 & 179.6100 &
7927785.0000 \\
& MS & 86.5000 & 86.5000 & 86.7900 & 85.0700 & 85.5200 & 9628557.0000 \\
& PNC & 148.8500 & 148.8500 & 149.9100 & 147.6900 & 148.4200 &
1362728.0000 \\
\end{longtable}

\subsection{\texorpdfstring{Add daily returns for each stock to data
frames \texttt{stocks} and
\texttt{stocks\_long}.}{Add daily returns for each stock to data frames stocks and stocks\_long.}}\label{add-daily-returns-for-each-stock-to-data-frames-stocks-and-stocks_long.-2}

Name the returns variable \texttt{Returns}, and maintain all multi
indexes. \emph{Hint:} Use \texttt{pd.MultiIndex()} to create a multi
index for the the wide data frame \texttt{stocks}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].columns}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Index(['BAC', 'C', 'GS', 'JPM', 'MS', 'PNC'], dtype='object', name='Ticker')
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{], stocks[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].columns])}
\NormalTok{stocks[\_] }\OperatorTok{=}\NormalTok{ stocks[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].pct\_change()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
Variable & \multicolumn{6}{l}{%
Adj Close} & \multicolumn{4}{l}{%
Close} & ... & \multicolumn{4}{l}{%
Volume} & \multicolumn{6}{l@{}}{%
Returns} \\
Ticker & BAC & C & GS & JPM & MS & PNC & BAC & C & GS & JPM & ... & GS &
JPM & MS & PNC & BAC & C & GS & JPM & MS & PNC \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-02-12 & 33.6200 & 53.9200 & 392.6400 & 175.7900 & 86.8700 &
149.1400 & 33.6200 & 53.9200 & 392.6400 & 175.7900 & ... & 2797200.0000
& 8539300.0000 & 7888000.0000 & 1612700.0000 & 0.0166 & -0.0013 & 0.0218
& 0.0045 & 0.0114 & 0.0093 \\
2024-02-13 & 32.7500 & 52.7600 & 378.7500 & 174.2600 & 83.9700 &
145.2600 & 32.7500 & 52.7600 & 378.7500 & 174.2600 & ... & 3030800.0000
& 8397600.0000 & 11339400.0000 & 2121400.0000 & -0.0259 & -0.0215 &
-0.0354 & -0.0087 & -0.0334 & -0.0260 \\
2024-02-14 & 33.1300 & 53.9800 & 378.0400 & 176.0300 & 84.0000 &
147.8700 & 33.1300 & 53.9800 & 378.0400 & 176.0300 & ... & 2041300.0000
& 7056700.0000 & 5973700.0000 & 1265300.0000 & 0.0116 & 0.0231 & -0.0019
& 0.0102 & 0.0004 & 0.0180 \\
2024-02-15 & 34.0700 & 55.2100 & 385.4200 & 179.8700 & 85.6700 &
149.6300 & 34.0700 & 55.2100 & 385.4200 & 179.8700 & ... & 2218900.0000
& 8723400.0000 & 7993500.0000 & 1991800.0000 & 0.0284 & 0.0228 & 0.0195
& 0.0218 & 0.0199 & 0.0119 \\
2024-02-16 & 34.0900 & 54.8500 & 384.4400 & 179.0300 & 86.5000 &
148.8500 & 34.0900 & 54.8500 & 384.4400 & 179.0300 & ... & 2302099.0000
& 7927785.0000 & 9628557.0000 & 1362728.0000 & NaN & NaN & NaN & NaN &
NaN & NaN \\
\end{longtable}

The easiest way to add returns to long data frame \texttt{stocks\_long}
is to \texttt{.stack()} the wide data frame \texttt{stocks}! We could
sort \texttt{stocks\_long} by ticker and date (to sort chronologically
within each ticker), then use \texttt{.pct\_change()}. However, this
approach miscalculates the first return for every ticker except for the
first ticker. The easiest and safest solution is to \texttt{.stack()}
the wide data frame \texttt{stocks}!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks\_long }\OperatorTok{=}\NormalTok{ stocks.stack()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks\_long.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllll@{}}
\toprule\noalign{}
& Variable & Adj Close & Close & High & Low & Open & Volume & Returns \\
Date & Ticker & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{5}{=}{2024-02-16} & C & 54.8500 & 54.8500 & 55.1950 & 54.5500
& 54.9600 & 11419637.0000 & NaN \\
& GS & 384.4400 & 384.4400 & 387.5800 & 380.9450 & 383.2400 &
2302099.0000 & NaN \\
& JPM & 179.0300 & 179.0300 & 179.9800 & 178.1600 & 179.6100 &
7927785.0000 & NaN \\
& MS & 86.5000 & 86.5000 & 86.7900 & 85.0700 & 85.5200 & 9628557.0000 &
NaN \\
& PNC & 148.8500 & 148.8500 & 149.9100 & 147.6900 & 148.4200 &
1362728.0000 & NaN \\
\end{longtable}

\subsection{Download the daily benchmark return factors from Ken
French's data
library.}\label{download-the-daily-benchmark-return-factors-from-ken-frenchs-data-library.-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pdr.famafrench.get\_available\_datasets()[:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['F-F_Research_Data_Factors',
 'F-F_Research_Data_Factors_weekly',
 'F-F_Research_Data_Factors_daily',
 'F-F_Research_Data_5_Factors_2x3',
 'F-F_Research_Data_5_Factors_2x3_daily']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pdr.DataReader(}
\NormalTok{        name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{        data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{        start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{    )}
\NormalTok{    [}\DecValTok{0}\NormalTok{]}
\NormalTok{    .div(}\DecValTok{100}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_4188\2049483829.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& Mkt-RF & SMB & HML & RF \\
Date & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2023-12-22 & 0.0021 & 0.0064 & 0.0009 & 0.0002 \\
2023-12-26 & 0.0048 & 0.0069 & 0.0046 & 0.0002 \\
2023-12-27 & 0.0016 & 0.0014 & 0.0012 & 0.0002 \\
2023-12-28 & -0.0001 & -0.0036 & 0.0003 & 0.0002 \\
2023-12-29 & -0.0043 & -0.0112 & -0.0037 & 0.0002 \\
\end{longtable}

\subsection{\texorpdfstring{Add the daily benchmark return factors to
\texttt{stocks} and
\texttt{stocks\_long}.}{Add the daily benchmark return factors to stocks and stocks\_long.}}\label{add-the-daily-benchmark-return-factors-to-stocks-and-stocks_long.-2}

For the wide data frame \texttt{stocks}, use the outer index name
\texttt{Factors}.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# stocks.join(ff)}
\CommentTok{\# MergeError: Not allowed to merge between different levels. (2 levels on the left, 1 on the right)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Factors\textquotesingle{}}\NormalTok{], ff.columns])}
\NormalTok{stocks[\_] }\OperatorTok{=}\NormalTok{ ff}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
Variable & \multicolumn{6}{l}{%
Adj Close} & \multicolumn{4}{l}{%
Close} & ... & \multicolumn{6}{l}{%
Returns} & \multicolumn{4}{l@{}}{%
Factors} \\
Ticker & BAC & C & GS & JPM & MS & PNC & BAC & C & GS & JPM & ... & BAC
& C & GS & JPM & MS & PNC & Mkt-RF & SMB & HML & RF \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1973-02-21 & 1.5818 & NaN & NaN & NaN & NaN & NaN & 4.6250 & NaN & NaN &
NaN & ... & NaN & NaN & NaN & NaN & NaN & NaN & -0.0074 & -0.0039 &
0.0054 & 0.0002 \\
1973-02-22 & 1.5872 & NaN & NaN & NaN & NaN & NaN & 4.6406 & NaN & NaN &
NaN & ... & 0.0034 & NaN & NaN & NaN & NaN & NaN & -0.0030 & -0.0037 &
0.0022 & 0.0002 \\
1973-02-23 & 1.5818 & NaN & NaN & NaN & NaN & NaN & 4.6250 & NaN & NaN &
NaN & ... & -0.0034 & NaN & NaN & NaN & NaN & NaN & -0.0108 & -0.0019 &
0.0054 & 0.0002 \\
1973-02-26 & 1.5818 & NaN & NaN & NaN & NaN & NaN & 4.6250 & NaN & NaN &
NaN & ... & 0.0000 & NaN & NaN & NaN & NaN & NaN & -0.0088 & -0.0050 &
0.0054 & 0.0002 \\
1973-02-27 & 1.5818 & NaN & NaN & NaN & NaN & NaN & 4.6250 & NaN & NaN &
NaN & ... & 0.0000 & NaN & NaN & NaN & NaN & NaN & -0.0115 & -0.0018 &
0.0064 & 0.0002 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2024-02-12 & 33.6200 & 53.9200 & 392.6400 & 175.7900 & 86.8700 &
149.1400 & 33.6200 & 53.9200 & 392.6400 & 175.7900 & ... & 0.0166 &
-0.0013 & 0.0218 & 0.0045 & 0.0114 & 0.0093 & NaN & NaN & NaN & NaN \\
2024-02-13 & 32.7500 & 52.7600 & 378.7500 & 174.2600 & 83.9700 &
145.2600 & 32.7500 & 52.7600 & 378.7500 & 174.2600 & ... & -0.0259 &
-0.0215 & -0.0354 & -0.0087 & -0.0334 & -0.0260 & NaN & NaN & NaN &
NaN \\
2024-02-14 & 33.1300 & 53.9800 & 378.0400 & 176.0300 & 84.0000 &
147.8700 & 33.1300 & 53.9800 & 378.0400 & 176.0300 & ... & 0.0116 &
0.0231 & -0.0019 & 0.0102 & 0.0004 & 0.0180 & NaN & NaN & NaN & NaN \\
2024-02-15 & 34.0700 & 55.2100 & 385.4200 & 179.8700 & 85.6700 &
149.6300 & 34.0700 & 55.2100 & 385.4200 & 179.8700 & ... & 0.0284 &
0.0228 & 0.0195 & 0.0218 & 0.0199 & 0.0119 & NaN & NaN & NaN & NaN \\
2024-02-16 & 34.0900 & 54.8500 & 384.4400 & 179.0300 & 86.5000 &
148.8500 & 34.0900 & 54.8500 & 384.4400 & 179.0300 & ... & NaN & NaN &
NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks\_long }\OperatorTok{=}\NormalTok{ stocks\_long.join(ff)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks\_long.loc[}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{].tail(}\DecValTok{12}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllll@{}}
\toprule\noalign{}
& & Adj Close & Close & High & Low & Open & Volume & Returns & Mkt-RF &
SMB & HML & RF \\
Date & Ticker & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{6}{=}{2023-12-28} & BAC & 33.8800 & 33.8800 & 33.9700 &
33.7700 & 33.8200 & 21799600.0000 & 0.0012 & -0.0001 & -0.0036 & 0.0003
& 0.0002 \\
& C & 51.0329 & 51.5200 & 51.8000 & 51.4000 & 51.4000 & 10218500.0000 &
0.0012 & -0.0001 & -0.0036 & 0.0003 & 0.0002 \\
& GS & 386.4100 & 386.4100 & 387.7600 & 383.6300 & 384.5200 &
1024700.0000 & 0.0050 & -0.0001 & -0.0036 & 0.0003 & 0.0002 \\
& JPM & 169.2563 & 170.3000 & 170.6600 & 169.0000 & 169.3500 &
6320100.0000 & 0.0053 & -0.0001 & -0.0036 & 0.0003 & 0.0002 \\
& MS & 92.7316 & 93.6400 & 93.9500 & 93.2400 & 93.3100 & 4089500.0000 &
-0.0002 & -0.0001 & -0.0036 & 0.0003 & 0.0002 \\
& PNC & 154.0486 & 155.6300 & 156.2100 & 154.9500 & 155.4400 &
1153300.0000 & 0.0041 & -0.0001 & -0.0036 & 0.0003 & 0.0002 \\
\multirow{6}{=}{2023-12-29} & BAC & 33.6700 & 33.6700 & 33.9900 &
33.5500 & 33.9400 & 28037800.0000 & -0.0062 & -0.0043 & -0.0112 &
-0.0037 & 0.0002 \\
& C & 50.9537 & 51.4400 & 51.6100 & 51.2200 & 51.5600 & 13147900.0000 &
-0.0016 & -0.0043 & -0.0112 & -0.0037 & 0.0002 \\
& GS & 385.7700 & 385.7700 & 386.6400 & 383.5700 & 385.5700 &
881300.0000 & -0.0017 & -0.0043 & -0.0112 & -0.0037 & 0.0002 \\
& JPM & 169.0575 & 170.1000 & 170.6900 & 169.6300 & 170.0000 &
6431800.0000 & -0.0012 & -0.0043 & -0.0112 & -0.0037 & 0.0002 \\
& MS & 92.3454 & 93.2500 & 93.7700 & 93.0600 & 93.4900 & 4772100.0000 &
-0.0042 & -0.0043 & -0.0112 & -0.0037 & 0.0002 \\
& PNC & 153.2765 & 154.8500 & 156.1100 & 154.5200 & 155.2700 &
1572600.0000 & -0.0050 & -0.0043 & -0.0112 & -0.0037 & 0.0002 \\
\end{longtable}

\subsection{\texorpdfstring{Write a function \texttt{download()} that
accepts tickers and returns a wide data frame of returns with the daily
benchmark return
factors.}{Write a function download() that accepts tickers and returns a wide data frame of returns with the daily benchmark return factors.}}\label{write-a-function-download-that-accepts-tickers-and-returns-a-wide-data-frame-of-returns-with-the-daily-benchmark-return-factors.-2}

We can even add a \texttt{shape} argument to return a wide or long data
frame!

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ download(tickers, shape}\OperatorTok{=}\StringTok{\textquotesingle{}wide\textquotesingle{}}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ shape.lower() }\KeywordTok{not} \KeywordTok{in}\NormalTok{ [}\StringTok{\textquotesingle{}wide\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}long\textquotesingle{}}\NormalTok{]:}
        \ControlFlowTok{raise} \PreprocessorTok{ValueError}\NormalTok{(}\StringTok{\textquotesingle{}Invalid shape: must be "wide" or "long".\textquotesingle{}}\NormalTok{)}

\NormalTok{    stocks }\OperatorTok{=}\NormalTok{ yf.download(tickers)}

\NormalTok{    factors\_all }\OperatorTok{=}\NormalTok{ (}
\NormalTok{        pdr.DataReader(}
\NormalTok{            name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{            data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{            start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{        )}
\NormalTok{    )}
    
\NormalTok{    factors }\OperatorTok{=}\NormalTok{ factors\_all[}\DecValTok{0}\NormalTok{].div(}\DecValTok{100}\NormalTok{)}
    
    \CommentTok{\# if stocks has a multi index on the columns because we asked for more than one ticker}
    \CommentTok{\# then we have more work to do}
    \ControlFlowTok{if} \BuiltInTok{type}\NormalTok{(stocks.columns) }\KeywordTok{is}\NormalTok{ pd.MultiIndex:}
        
        \CommentTok{\# whether we want a wide or long data frame, it is easier to add returns to a wide data frame}
\NormalTok{        \_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{], stocks[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].columns])}
\NormalTok{        stocks[\_] }\OperatorTok{=}\NormalTok{ stocks[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].pct\_change()}

        \CommentTok{\# if we want a wide data frame, then we need a factors multi index}
        \ControlFlowTok{if}\NormalTok{ shape.lower() }\OperatorTok{==} \StringTok{\textquotesingle{}wide\textquotesingle{}}\NormalTok{:}
\NormalTok{            \_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Factors\textquotesingle{}}\NormalTok{], factors.columns])}
\NormalTok{            stocks[\_] }\OperatorTok{=}\NormalTok{ factors}
            \ControlFlowTok{return}\NormalTok{ stocks.rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}

        \CommentTok{\# if we want a long data frame, then we need to stack stocks and join factors}
        \CommentTok{\# because we tested for wide and long above, we know that here shape must be long}
        \ControlFlowTok{else}\NormalTok{:}
            \ControlFlowTok{return}\NormalTok{ stocks.stack().join(factors).rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{], index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
            
    \CommentTok{\# if stocks does not have a multi index on the columns}
    \CommentTok{\# then we only have join factors}
    \ControlFlowTok{else}\NormalTok{:}
        \ControlFlowTok{return}\NormalTok{ stocks.join(ff).rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{download(tickers}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}AAPL\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{], shape}\OperatorTok{=}\StringTok{\textquotesingle{}long\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  2 of 2 completed
C:\Users\r.herron\AppData\Local\Temp\ipykernel_4188\3667605341.py:8: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{longtable}[]{@{}lllllllllllll@{}}
\toprule\noalign{}
& Variable & Adj Close & Close & High & Low & Open & Volume & Returns &
Mkt-RF & SMB & HML & RF \\
Date & Ticker & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1980-12-12 & AAPL & 0.0992 & 0.1283 & 0.1289 & 0.1283 & 0.1283 &
469033600.0000 & NaN & 0.0138 & -0.0001 & -0.0105 & 0.0006 \\
1980-12-15 & AAPL & 0.0940 & 0.1217 & 0.1222 & 0.1217 & 0.1222 &
175884800.0000 & -0.0522 & 0.0011 & 0.0025 & -0.0046 & 0.0006 \\
1980-12-16 & AAPL & 0.0871 & 0.1127 & 0.1133 & 0.1127 & 0.1133 &
105728000.0000 & -0.0734 & 0.0071 & -0.0075 & -0.0047 & 0.0006 \\
1980-12-17 & AAPL & 0.0893 & 0.1155 & 0.1161 & 0.1155 & 0.1155 &
86441600.0000 & 0.0248 & 0.0152 & -0.0086 & -0.0034 & 0.0006 \\
1980-12-18 & AAPL & 0.0919 & 0.1189 & 0.1194 & 0.1189 & 0.1189 &
73449600.0000 & 0.0290 & 0.0041 & 0.0022 & 0.0126 & 0.0006 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... \\
2024-02-14 & TSLA & 188.7100 & 188.7100 & 188.8900 & 183.3500 & 185.3000
& 81203000.0000 & 0.0255 & NaN & NaN & NaN & NaN \\
\multirow{2}{=}{2024-02-15} & AAPL & 183.8600 & 183.8600 & 184.4900 &
181.3500 & 183.5500 & 65434500.0000 & -0.0016 & NaN & NaN & NaN & NaN \\
& TSLA & 200.4500 & 200.4500 & 200.8800 & 188.8600 & 189.1600 &
120831800.0000 & 0.0622 & NaN & NaN & NaN & NaN \\
\multirow{2}{=}{2024-02-16} & AAPL & 182.3100 & 182.3100 & 184.8500 &
181.6650 & 183.4200 & 48627624.0000 & -0.0084 & NaN & NaN & NaN & NaN \\
& TSLA & 199.9500 & 199.9500 & 203.1700 & 197.4000 & 202.0600 &
110528448.0000 & -0.0025 & NaN & NaN & NaN & NaN \\
\end{longtable}

\subsection{\texorpdfstring{Download earnings per share for the stocks
in \texttt{stocks} and combine to a long data frame
\texttt{earnings}.}{Download earnings per share for the stocks in stocks and combine to a long data frame earnings.}}\label{download-earnings-per-share-for-the-stocks-in-stocks-and-combine-to-a-long-data-frame-earnings.-2}

Use the \texttt{.earnings\_dates} method described
\href{https://pypi.org/project/yfinance/}{here}. Use
\texttt{pd.concat()} to combine the result of each the
\texttt{.earnings\_date} data frames and assign them to a new data frame
\texttt{earnings}. Name the row indexes \texttt{Ticker} and
\texttt{Date} and swap to match the order of the row index in
\texttt{stocks\_long}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tickers }\OperatorTok{=}\NormalTok{ yf.Tickers(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}BAC C GS JPM MS PNC\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{earnings  }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat(}
\NormalTok{        objs}\OperatorTok{=}\NormalTok{[tickers.tickers[t].earnings\_dates }\ControlFlowTok{for}\NormalTok{ t }\KeywordTok{in}\NormalTok{ tickers.tickers],}
\NormalTok{        keys}\OperatorTok{=}\NormalTok{tickers.tickers,}
\NormalTok{        names}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{]}
\NormalTok{    )}
\NormalTok{    .reset\_index()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{earnings.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& Ticker & Date & EPS Estimate & Reported EPS & Surprise(\%) \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
67 & PNC & 2024-04-16 08:00:00-04:00 & 3.0800 & NaN & NaN \\
68 & PNC & 2024-01-16 06:00:00-05:00 & 2.9400 & 3.1600 & 0.0737 \\
69 & PNC & 2023-10-13 06:00:00-04:00 & 3.1100 & 3.6000 & 0.1586 \\
70 & PNC & 2023-07-18 07:00:00-04:00 & 3.2800 & 3.3600 & 0.0230 \\
71 & PNC & 2023-04-14 06:00:00-04:00 & 3.6700 & 3.9800 & 0.0847 \\
\end{longtable}

\subsection{\texorpdfstring{Combine \texttt{earnings} with the returns
from
\texttt{stocks\_long}.}{Combine earnings with the returns from stocks\_long.}}\label{combine-earnings-with-the-returns-from-stocks_long.-2}

Use the
\texttt{tz\_localize(\textquotesingle{}America/New\_York\textquotesingle{})}
method add time zone information back to \texttt{returns.index} and use
\texttt{pd.to\_timedelta(16,\ unit=\textquotesingle{}h\textquotesingle{})}
to set time to the market close in New York City. Use
\href{https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.merge_asof.html}{\texttt{pd.merge\_asof()}}
to match earnings announcement dates and times to appropriate return
periods. For example, if a firm announces earnings after the close at 5
PM on February 7, we want to match the return period from 4 PM on
February 7 to 4 PM on February 8.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    stocks\_long}
\NormalTok{    .reset\_index()}
\NormalTok{    [[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .assign(}
\NormalTok{        Date}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{].dt.tz\_localize(}\StringTok{\textquotesingle{}America/New\_York\textquotesingle{}}\NormalTok{) }\OperatorTok{+}\NormalTok{ pd.to\_timedelta(}\DecValTok{16}\NormalTok{, unit}\OperatorTok{=}\StringTok{\textquotesingle{}H\textquotesingle{}}\NormalTok{)}
\NormalTok{    )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& Date & Ticker & Returns \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
62021 & 2024-02-16 16:00:00-05:00 & C & NaN \\
62022 & 2024-02-16 16:00:00-05:00 & GS & NaN \\
62023 & 2024-02-16 16:00:00-05:00 & JPM & NaN \\
62024 & 2024-02-16 16:00:00-05:00 & MS & NaN \\
62025 & 2024-02-16 16:00:00-05:00 & PNC & NaN \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{surprises }\OperatorTok{=}\NormalTok{ pd.merge\_asof(}
\NormalTok{    left}\OperatorTok{=}\NormalTok{earnings.sort\_values([}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{]),}
\NormalTok{    right}\OperatorTok{=}\NormalTok{returns.sort\_values([}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{]),}
\NormalTok{    on}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{,}
\NormalTok{    by}\OperatorTok{=}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{,}
\NormalTok{    direction}\OperatorTok{=}\StringTok{\textquotesingle{}forward\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{surprises.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& Ticker & Date & EPS Estimate & Reported EPS & Surprise(\%) &
Returns \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
67 & JPM & 2025-01-15 08:00:00-05:00 & NaN & NaN & NaN & NaN \\
68 & JPM & 2025-01-15 08:00:00-05:00 & NaN & NaN & NaN & NaN \\
69 & C & 2025-01-15 11:00:00-05:00 & NaN & NaN & NaN & NaN \\
70 & PNC & 2025-01-16 08:00:00-05:00 & NaN & NaN & NaN & NaN \\
71 & PNC & 2025-01-16 10:00:00-05:00 & NaN & NaN & NaN & NaN \\
\end{longtable}

\subsection{Plot the relation between daily returns and earnings
surprises}\label{plot-the-relation-between-daily-returns-and-earnings-surprises-2}

Three options in increasing difficulty:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Scatter plot
\item
  Scatter plot with a best-fit line using \texttt{regplot()} from the
  seaborn package
\item
  Bar plot using \texttt{barplot()} from the seaborn package after using
  \texttt{pd.qcut()} to form five groups on earnings surprises
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    surprises}
\NormalTok{    [[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}scatter\textquotesingle{}}\NormalTok{, x}\OperatorTok{=}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, y}\OperatorTok{=}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Earnings Surprise (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Day Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Earnings Surprise Analysis}\CharTok{\textbackslash{}n}\SpecialStringTok{ }\SpecialCharTok{\{}\StringTok{\textquotesingle{}, \textquotesingle{}}\SpecialCharTok{.}\NormalTok{join(tickers.tickers)}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_08_practice_04_files/figure-pdf/cell-30-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ seaborn }\ImportTok{as}\NormalTok{ sns}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.regplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{surprises[[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]].mul(}\DecValTok{100}\NormalTok{),}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Returns\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Earnings Surprise (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Day Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Earnings Surprise Analysis}\CharTok{\textbackslash{}n}\SpecialStringTok{ }\SpecialCharTok{\{}\StringTok{\textquotesingle{}, \textquotesingle{}}\SpecialCharTok{.}\NormalTok{join(tickers.tickers)}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_08_practice_04_files/figure-pdf/cell-32-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.catplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{(}
\NormalTok{        surprises[[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]]}
\NormalTok{        .dropna()}
\NormalTok{        .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{        .assign(}
\NormalTok{            surprise\_bin}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: pd.qcut(x[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{], q}\OperatorTok{=}\DecValTok{5}\NormalTok{, labels}\OperatorTok{=}\VariableTok{False}\NormalTok{)}\OperatorTok{+}\DecValTok{1}
\NormalTok{        )}
\NormalTok{    ),}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}surprise\_bin\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{,}
\NormalTok{    kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Earnings Surprise Bin (1=Lowest, 5=Highest)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Day Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Earnings Surprise Analysis}\CharTok{\textbackslash{}n}\SpecialStringTok{ }\SpecialCharTok{\{}\StringTok{\textquotesingle{}, \textquotesingle{}}\SpecialCharTok{.}\NormalTok{join(tickers.tickers)}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_08_practice_04_files/figure-pdf/cell-33-output-1.png}

\subsection{Repeat the earnings exercise with the S\&P 100
stocks}\label{repeat-the-earnings-exercise-with-the-sp-100-stocks-2}

With more data, we can more clearly see the positive relation between
earnings surprises and returns!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ pd.read\_html(}\StringTok{\textquotesingle{}https://en.wikipedia.org/wiki/S\%26P\_100\textquotesingle{}}\NormalTok{)[}\DecValTok{2}\NormalTok{][}\StringTok{\textquotesingle{}Symbol\textquotesingle{}}\NormalTok{].to\_list()}
\NormalTok{tickers\_2 }\OperatorTok{=}\NormalTok{ yf.Tickers(tickers}\OperatorTok{=}\NormalTok{[t.replace(}\StringTok{\textquotesingle{}.\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}{-}\textquotesingle{}}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ t }\KeywordTok{in}\NormalTok{ \_]) }\CommentTok{\# Yahoo! Finance uses "{-}" to indicate share classes instead of "."}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{earnings\_2  }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat(}
\NormalTok{        objs}\OperatorTok{=}\NormalTok{[tickers\_2.tickers[t].earnings\_dates }\ControlFlowTok{for}\NormalTok{ t }\KeywordTok{in}\NormalTok{ tickers\_2.tickers],}
\NormalTok{        keys}\OperatorTok{=}\NormalTok{tickers\_2.tickers,}
\NormalTok{        names}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{]}
\NormalTok{    )}
\NormalTok{    .reset\_index()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{earnings\_2.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& Ticker & Date & EPS Estimate & Reported EPS & Surprise(\%) \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1207 & XOM & 2023-04-28 06:00:00-04:00 & 2.5900 & 2.8300 & 0.0943 \\
1208 & XOM & 2023-01-31 06:00:00-05:00 & 3.2900 & 3.4000 & 0.0319 \\
1209 & XOM & 2022-10-28 06:00:00-04:00 & 3.7900 & 4.4500 & 0.1733 \\
1210 & XOM & 2022-07-29 06:00:00-04:00 & 3.7400 & 4.1400 & 0.1077 \\
1211 & XOM & 2022-04-29 06:00:00-04:00 & 2.1200 & 2.0700 & -0.0247 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\NormalTok{[t }\ControlFlowTok{for}\NormalTok{ t }\KeywordTok{in}\NormalTok{ tickers\_2.tickers])}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
\NormalTok{    [}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .pct\_change()}
\NormalTok{    .stack()}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{)}
\NormalTok{    .reset\_index()}
\NormalTok{    [[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .assign(}
\NormalTok{        Date}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{].dt.tz\_localize(}\StringTok{\textquotesingle{}America/New\_York\textquotesingle{}}\NormalTok{) }\OperatorTok{+}\NormalTok{ pd.to\_timedelta(}\DecValTok{16}\NormalTok{, unit}\OperatorTok{=}\StringTok{\textquotesingle{}H\textquotesingle{}}\NormalTok{)}
\NormalTok{    )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  101 of 101 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& Date & Ticker & Returns \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1018569 & 2024-02-16 16:00:00-05:00 & V & -0.0086 \\
1018570 & 2024-02-16 16:00:00-05:00 & VZ & -0.0025 \\
1018571 & 2024-02-16 16:00:00-05:00 & WFC & -0.0025 \\
1018572 & 2024-02-16 16:00:00-05:00 & WMT & 0.0063 \\
1018573 & 2024-02-16 16:00:00-05:00 & XOM & 0.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{surprises\_2 }\OperatorTok{=}\NormalTok{ pd.merge\_asof(}
\NormalTok{    left}\OperatorTok{=}\NormalTok{earnings\_2.sort\_values([}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{]),}
\NormalTok{    right}\OperatorTok{=}\NormalTok{returns\_2.sort\_values([}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{]),}
\NormalTok{    on}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{,}
\NormalTok{    by}\OperatorTok{=}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{,}
\NormalTok{    direction}\OperatorTok{=}\StringTok{\textquotesingle{}forward\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{surprises\_2.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& Ticker & Date & EPS Estimate & Reported EPS & Surprise(\%) &
Returns \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1207 & USB & 2025-10-16 09:00:00-04:00 & NaN & NaN & NaN & NaN \\
1208 & USB & 2025-10-16 09:00:00-04:00 & NaN & NaN & NaN & NaN \\
1209 & RTX & 2025-10-20 06:00:00-04:00 & NaN & NaN & NaN & NaN \\
1210 & USB & 2026-01-20 09:00:00-05:00 & NaN & NaN & NaN & NaN \\
1211 & USB & 2026-01-20 09:00:00-05:00 & NaN & NaN & NaN & NaN \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    surprises\_2}
\NormalTok{    [[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}scatter\textquotesingle{}}\NormalTok{, x}\OperatorTok{=}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, y}\OperatorTok{=}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Earnings Surprise (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Day Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Earnings Surprise Analysis}\CharTok{\textbackslash{}n}\StringTok{ S\&P 100 Stocks\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_08_practice_04_files/figure-pdf/cell-41-output-1.png}

\textbf{\emph{There are a few large negative and positive earnings
surprises that make our plot difficult to interpret!}} We have these
huge outliers because surprises are defined as the percent change
relative to the expected. If expected is a very small number, then the
surprise can be a very large number! We would use different surprise
definitions for a more rigorous analysis. Here we can drop observations
less than the 0.01 quantile and greater than the 0.99 quantile.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{low\_2 }\OperatorTok{=}\NormalTok{ surprises\_2[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{].quantile(}\FloatTok{0.01}\NormalTok{)}
\NormalTok{high\_2 }\OperatorTok{=}\NormalTok{ surprises\_2[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{].quantile(}\FloatTok{0.91}\NormalTok{)}

\NormalTok{cond\_2 }\OperatorTok{=}\NormalTok{ surprises\_2[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{].between(low\_2, high\_2)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    surprises\_2}
\NormalTok{    .loc[cond\_2, [}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}scatter\textquotesingle{}}\NormalTok{, x}\OperatorTok{=}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, y}\OperatorTok{=}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.5}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Earnings Surprise (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Day Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Earnings Surprise Analysis}\CharTok{\textbackslash{}n}\StringTok{ S\&P 100 Stocks\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_08_practice_04_files/figure-pdf/cell-43-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.regplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{surprises\_2.loc[cond\_2, [}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]].mul(}\DecValTok{100}\NormalTok{),}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Returns\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Earnings Surprise (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Day Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Earnings Surprise Analysis}\CharTok{\textbackslash{}n}\StringTok{ S\&P 100 Stocks\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_08_practice_04_files/figure-pdf/cell-44-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.catplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{(}
\NormalTok{        surprises\_2}
\NormalTok{        .loc[cond\_2, [}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]]}
\NormalTok{        .dropna()}
\NormalTok{        .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{        .assign(surprise\_bin}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: pd.qcut(x[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{], q}\OperatorTok{=}\DecValTok{5}\NormalTok{, labels}\OperatorTok{=}\VariableTok{False}\NormalTok{) }\OperatorTok{+} \DecValTok{1}\NormalTok{)}
\NormalTok{    ),}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}surprise\_bin\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{,}
\NormalTok{    kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Earnings Surprise Bin (1=Lowest, 5=Highest)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Day Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Earnings Surprise Analysis}\CharTok{\textbackslash{}n}\StringTok{ S\&P 100 Stocks\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_08_practice_04_files/figure-pdf/cell-45-output-1.png}

\chapter{McKinney Chapter 8 - Practice for Section
05}\label{mckinney-chapter-8---practice-for-section-05}

\section{Announcements}\label{announcements-23}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \emph{Joining Data with pandas}, our fourth and final DataCamp course,
  is due by Friday, 2/16, at 11:59 PM
\item
  We will use class next week, from 2/19 through 2/23, for group work on
  Project 1, so there is no lecture video or pre-class quiz
\item
  Project 1 is due by Tuesday, 2/27, at 8:25 AM
\item
  Please complete the
  \href{https://northeastern.instructure.com/courses/171271/quizzes/586970}{anonymous
  ungraded survey on Canvas} to help me help you learn better:
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-22}

Chapter 8 of McKinney covers 3 topics.

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \emph{Hierarchical Indexing:} Hierarchical indexing helps us organize
  data at multiple levels, rather than just a flat, two-dimensional
  structure. It helps is work with high-dimensional data in a
  low-dimensional form. For example, we can index rows by multiple
  levels like ``ticker'' and ``date'', or columns by ``variable'' and
  ``ticker''.
\item
  \emph{Combining Data:} We can combine datasets on one or more keys.

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    We will use the \texttt{pd.merge()} function for database-style
    joins, which can be \texttt{inner}, \texttt{outer}, \texttt{left},
    or \texttt{right} joins.
  \item
    We will use the \texttt{.join()} method to combine data frames with
    similar indexes.
  \item
    We will use the \texttt{pd.concat()} to combine similarly-shaped
    series and data frames.
  \end{enumerate}
\item
  \emph{Reshaping Data:} We can reshape data to change its structure,
  such as pivoting from wide to long format or vice versa. We will most
  often use the \texttt{.stack()} and \texttt{.unstack()} methods, which
  pivot columns to rows and rows to columns, respectively. Laster in the
  course we will learn about the \texttt{.pivot()} method for
  aggregating data and the \texttt{.melt()} method for more advanced
  reshaping.
\end{enumerate}

\section{Practice}\label{practice-23}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{\texorpdfstring{Download data from Yahoo! Finance for BAC,
C, GS, JPM, MS, and PNC and assign to data frame
\texttt{stocks}.}{Download data from Yahoo! Finance for BAC, C, GS, JPM, MS, and PNC and assign to data frame stocks.}}\label{download-data-from-yahoo-finance-for-bac-c-gs-jpm-ms-and-pnc-and-assign-to-data-frame-stocks.-3}

Use
\texttt{.rename\_axis(columns=stocks.columns.names\ =\ {[}\textquotesingle{}Variable\textquotesingle{},\ \textquotesingle{}Ticker\textquotesingle{}{]})}
to assign the names \texttt{Variable} and \texttt{Ticker} to the column
multi index. We could instead use
\texttt{stocks.columns.names\ =\ {[}\textquotesingle{}Variable\textquotesingle{},\ \textquotesingle{}Ticker\textquotesingle{}{]}},
but we can chain the \texttt{.rename\_axis()} method.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}BAC C GS JPM MS PNC\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  6 of 6 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
Variable & \multicolumn{6}{l}{%
Adj Close} & \multicolumn{4}{l}{%
Close} & ... & \multicolumn{4}{l}{%
Open} & \multicolumn{6}{l@{}}{%
Volume} \\
Ticker & BAC & C & GS & JPM & MS & PNC & BAC & C & GS & JPM & ... & GS &
JPM & MS & PNC & BAC & C & GS & JPM & MS & PNC \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-02-12 & 33.6200 & 53.9200 & 392.6400 & 175.7900 & 86.8700 &
149.1400 & 33.6200 & 53.9200 & 392.6400 & 175.7900 & ... & 385.0000 &
174.7800 & 85.8600 & 147.7700 & 34160400 & 17162300.0000 & 2797200.0000
& 8539300.0000 & 7888000.0000 & 1612700.0000 \\
2024-02-13 & 32.7500 & 52.7600 & 378.7500 & 174.2600 & 83.9700 &
145.2600 & 32.7500 & 52.7600 & 378.7500 & 174.2600 & ... & 387.5900 &
175.3200 & 85.8600 & 146.7800 & 43801500 & 17672100.0000 & 3030800.0000
& 8397600.0000 & 11339400.0000 & 2121400.0000 \\
2024-02-14 & 33.1300 & 53.9800 & 378.0400 & 176.0300 & 84.0000 &
147.8700 & 33.1300 & 53.9800 & 378.0400 & 176.0300 & ... & 380.8800 &
175.0700 & 84.5400 & 146.6300 & 27833900 & 14891900.0000 & 2041300.0000
& 7056700.0000 & 5973700.0000 & 1265300.0000 \\
2024-02-15 & 34.0700 & 55.2100 & 385.4200 & 179.8700 & 85.6700 &
149.6300 & 34.0700 & 55.2100 & 385.4200 & 179.8700 & ... & 379.4200 &
176.1500 & 84.4500 & 148.7500 & 41683100 & 16865000.0000 & 2218900.0000
& 8723400.0000 & 7993500.0000 & 1991800.0000 \\
2024-02-16 & 34.0900 & 54.8500 & 384.4400 & 179.0300 & 86.5000 &
148.8500 & 34.0900 & 54.8500 & 384.4400 & 179.0300 & ... & 383.2400 &
179.6100 & 85.5200 & 148.4200 & 33146357 & 11419637.0000 & 2302099.0000
& 7927785.0000 & 9628557.0000 & 1362728.0000 \\
\end{longtable}

\subsection{\texorpdfstring{Reshape \texttt{stocks} from wide to long
with dates and tickers as row indexes and assign to data frame
\texttt{stocks\_long}.}{Reshape stocks from wide to long with dates and tickers as row indexes and assign to data frame stocks\_long.}}\label{reshape-stocks-from-wide-to-long-with-dates-and-tickers-as-row-indexes-and-assign-to-data-frame-stocks_long.-3}

By default, \texttt{.stack()} stacks the inner column index to the inner
row index.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks\_long }\OperatorTok{=}\NormalTok{ stocks.stack()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks\_long.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllll@{}}
\toprule\noalign{}
& Variable & Adj Close & Close & High & Low & Open & Volume \\
Date & Ticker & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{5}{=}{2024-02-16} & C & 54.8500 & 54.8500 & 55.1950 & 54.5500
& 54.9600 & 11419637.0000 \\
& GS & 384.4400 & 384.4400 & 387.5800 & 380.9450 & 383.2400 &
2302099.0000 \\
& JPM & 179.0300 & 179.0300 & 179.9800 & 178.1600 & 179.6100 &
7927785.0000 \\
& MS & 86.5000 & 86.5000 & 86.7900 & 85.0700 & 85.5200 & 9628557.0000 \\
& PNC & 148.8500 & 148.8500 & 149.9100 & 147.6900 & 148.4200 &
1362728.0000 \\
\end{longtable}

\subsection{\texorpdfstring{Add daily returns for each stock to data
frames \texttt{stocks} and
\texttt{stocks\_long}.}{Add daily returns for each stock to data frames stocks and stocks\_long.}}\label{add-daily-returns-for-each-stock-to-data-frames-stocks-and-stocks_long.-3}

Name the returns variable \texttt{Returns}, and maintain all multi
indexes. \emph{Hint:} Use \texttt{pd.MultiIndex()} to create a multi
index for the the wide data frame \texttt{stocks}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].columns}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Index(['BAC', 'C', 'GS', 'JPM', 'MS', 'PNC'], dtype='object', name='Ticker')
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{], stocks[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].columns])}
\NormalTok{stocks[\_] }\OperatorTok{=}\NormalTok{ stocks[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].pct\_change()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
Variable & \multicolumn{6}{l}{%
Adj Close} & \multicolumn{4}{l}{%
Close} & ... & \multicolumn{4}{l}{%
Volume} & \multicolumn{6}{l@{}}{%
Returns} \\
Ticker & BAC & C & GS & JPM & MS & PNC & BAC & C & GS & JPM & ... & GS &
JPM & MS & PNC & BAC & C & GS & JPM & MS & PNC \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-02-12 & 33.6200 & 53.9200 & 392.6400 & 175.7900 & 86.8700 &
149.1400 & 33.6200 & 53.9200 & 392.6400 & 175.7900 & ... & 2797200.0000
& 8539300.0000 & 7888000.0000 & 1612700.0000 & 0.0166 & -0.0013 & 0.0218
& 0.0045 & 0.0114 & 0.0093 \\
2024-02-13 & 32.7500 & 52.7600 & 378.7500 & 174.2600 & 83.9700 &
145.2600 & 32.7500 & 52.7600 & 378.7500 & 174.2600 & ... & 3030800.0000
& 8397600.0000 & 11339400.0000 & 2121400.0000 & -0.0259 & -0.0215 &
-0.0354 & -0.0087 & -0.0334 & -0.0260 \\
2024-02-14 & 33.1300 & 53.9800 & 378.0400 & 176.0300 & 84.0000 &
147.8700 & 33.1300 & 53.9800 & 378.0400 & 176.0300 & ... & 2041300.0000
& 7056700.0000 & 5973700.0000 & 1265300.0000 & 0.0116 & 0.0231 & -0.0019
& 0.0102 & 0.0004 & 0.0180 \\
2024-02-15 & 34.0700 & 55.2100 & 385.4200 & 179.8700 & 85.6700 &
149.6300 & 34.0700 & 55.2100 & 385.4200 & 179.8700 & ... & 2218900.0000
& 8723400.0000 & 7993500.0000 & 1991800.0000 & 0.0284 & 0.0228 & 0.0195
& 0.0218 & 0.0199 & 0.0119 \\
2024-02-16 & 34.0900 & 54.8500 & 384.4400 & 179.0300 & 86.5000 &
148.8500 & 34.0900 & 54.8500 & 384.4400 & 179.0300 & ... & 2302099.0000
& 7927785.0000 & 9628557.0000 & 1362728.0000 & NaN & NaN & NaN & NaN &
NaN & NaN \\
\end{longtable}

The easiest way to add returns to long data frame \texttt{stocks\_long}
is to \texttt{.stack()} the wide data frame \texttt{stocks}! We could
sort \texttt{stocks\_long} by ticker and date (to sort chronologically
within each ticker), then use \texttt{.pct\_change()}. However, this
approach miscalculates the first return for every ticker except for the
first ticker. The easiest and safest solution is to \texttt{.stack()}
the wide data frame \texttt{stocks}!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks\_long }\OperatorTok{=}\NormalTok{ stocks.stack()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks\_long.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllll@{}}
\toprule\noalign{}
& Variable & Adj Close & Close & High & Low & Open & Volume & Returns \\
Date & Ticker & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{5}{=}{2024-02-16} & C & 54.8500 & 54.8500 & 55.1950 & 54.5500
& 54.9600 & 11419637.0000 & NaN \\
& GS & 384.4400 & 384.4400 & 387.5800 & 380.9450 & 383.2400 &
2302099.0000 & NaN \\
& JPM & 179.0300 & 179.0300 & 179.9800 & 178.1600 & 179.6100 &
7927785.0000 & NaN \\
& MS & 86.5000 & 86.5000 & 86.7900 & 85.0700 & 85.5200 & 9628557.0000 &
NaN \\
& PNC & 148.8500 & 148.8500 & 149.9100 & 147.6900 & 148.4200 &
1362728.0000 & NaN \\
\end{longtable}

\subsection{Download the daily benchmark return factors from Ken
French's data
library.}\label{download-the-daily-benchmark-return-factors-from-ken-frenchs-data-library.-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pdr.famafrench.get\_available\_datasets()[:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['F-F_Research_Data_Factors',
 'F-F_Research_Data_Factors_weekly',
 'F-F_Research_Data_Factors_daily',
 'F-F_Research_Data_5_Factors_2x3',
 'F-F_Research_Data_5_Factors_2x3_daily']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pdr.DataReader(}
\NormalTok{        name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{        data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{        start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{    )}
\NormalTok{    [}\DecValTok{0}\NormalTok{]}
\NormalTok{    .div(}\DecValTok{100}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_28096\2049483829.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& Mkt-RF & SMB & HML & RF \\
Date & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2023-12-22 & 0.0021 & 0.0064 & 0.0009 & 0.0002 \\
2023-12-26 & 0.0048 & 0.0069 & 0.0046 & 0.0002 \\
2023-12-27 & 0.0016 & 0.0014 & 0.0012 & 0.0002 \\
2023-12-28 & -0.0001 & -0.0036 & 0.0003 & 0.0002 \\
2023-12-29 & -0.0043 & -0.0112 & -0.0037 & 0.0002 \\
\end{longtable}

\subsection{\texorpdfstring{Add the daily benchmark return factors to
\texttt{stocks} and
\texttt{stocks\_long}.}{Add the daily benchmark return factors to stocks and stocks\_long.}}\label{add-the-daily-benchmark-return-factors-to-stocks-and-stocks_long.-3}

For the wide data frame \texttt{stocks}, use the outer index name
\texttt{Factors}.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# stocks.join(ff)}
\CommentTok{\# MergeError: Not allowed to merge between different levels. (2 levels on the left, 1 on the right)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Factors\textquotesingle{}}\NormalTok{], ff.columns])}
\NormalTok{stocks[\_] }\OperatorTok{=}\NormalTok{ ff.iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].pct\_change()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
Variable & \multicolumn{6}{l}{%
Adj Close} & \multicolumn{4}{l}{%
Close} & ... & \multicolumn{6}{l}{%
Returns} & \multicolumn{4}{l@{}}{%
Factors} \\
Ticker & BAC & C & GS & JPM & MS & PNC & BAC & C & GS & JPM & ... & BAC
& C & GS & JPM & MS & PNC & Mkt-RF & SMB & HML & RF \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-02-12 & 33.6200 & 53.9200 & 392.6400 & 175.7900 & 86.8700 &
149.1400 & 33.6200 & 53.9200 & 392.6400 & 175.7900 & ... & 0.0166 &
-0.0013 & 0.0218 & 0.0045 & 0.0114 & 0.0093 & NaN & NaN & NaN & NaN \\
2024-02-13 & 32.7500 & 52.7600 & 378.7500 & 174.2600 & 83.9700 &
145.2600 & 32.7500 & 52.7600 & 378.7500 & 174.2600 & ... & -0.0259 &
-0.0215 & -0.0354 & -0.0087 & -0.0334 & -0.0260 & NaN & NaN & NaN &
NaN \\
2024-02-14 & 33.1300 & 53.9800 & 378.0400 & 176.0300 & 84.0000 &
147.8700 & 33.1300 & 53.9800 & 378.0400 & 176.0300 & ... & 0.0116 &
0.0231 & -0.0019 & 0.0102 & 0.0004 & 0.0180 & NaN & NaN & NaN & NaN \\
2024-02-15 & 34.0700 & 55.2100 & 385.4200 & 179.8700 & 85.6700 &
149.6300 & 34.0700 & 55.2100 & 385.4200 & 179.8700 & ... & 0.0284 &
0.0228 & 0.0195 & 0.0218 & 0.0199 & 0.0119 & NaN & NaN & NaN & NaN \\
2024-02-16 & 34.0900 & 54.8500 & 384.4400 & 179.0300 & 86.5000 &
148.8500 & 34.0900 & 54.8500 & 384.4400 & 179.0300 & ... & NaN & NaN &
NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks\_long }\OperatorTok{=}\NormalTok{ stocks\_long.join(ff)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{stocks\_long.loc[}\StringTok{\textquotesingle{}2023{-}12\textquotesingle{}}\NormalTok{].tail(}\DecValTok{12}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllll@{}}
\toprule\noalign{}
& & Adj Close & Close & High & Low & Open & Volume & Returns & Mkt-RF &
SMB & HML & RF \\
Date & Ticker & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{6}{=}{2023-12-28} & BAC & 33.8800 & 33.8800 & 33.9700 &
33.7700 & 33.8200 & 21799600.0000 & 0.0012 & -0.0001 & -0.0036 & 0.0003
& 0.0002 \\
& C & 51.0329 & 51.5200 & 51.8000 & 51.4000 & 51.4000 & 10218500.0000 &
0.0012 & -0.0001 & -0.0036 & 0.0003 & 0.0002 \\
& GS & 386.4100 & 386.4100 & 387.7600 & 383.6300 & 384.5200 &
1024700.0000 & 0.0050 & -0.0001 & -0.0036 & 0.0003 & 0.0002 \\
& JPM & 169.2563 & 170.3000 & 170.6600 & 169.0000 & 169.3500 &
6320100.0000 & 0.0053 & -0.0001 & -0.0036 & 0.0003 & 0.0002 \\
& MS & 92.7316 & 93.6400 & 93.9500 & 93.2400 & 93.3100 & 4089500.0000 &
-0.0002 & -0.0001 & -0.0036 & 0.0003 & 0.0002 \\
& PNC & 154.0486 & 155.6300 & 156.2100 & 154.9500 & 155.4400 &
1153300.0000 & 0.0041 & -0.0001 & -0.0036 & 0.0003 & 0.0002 \\
\multirow{6}{=}{2023-12-29} & BAC & 33.6700 & 33.6700 & 33.9900 &
33.5500 & 33.9400 & 28037800.0000 & -0.0062 & -0.0043 & -0.0112 &
-0.0037 & 0.0002 \\
& C & 50.9537 & 51.4400 & 51.6100 & 51.2200 & 51.5600 & 13147900.0000 &
-0.0016 & -0.0043 & -0.0112 & -0.0037 & 0.0002 \\
& GS & 385.7700 & 385.7700 & 386.6400 & 383.5700 & 385.5700 &
881300.0000 & -0.0017 & -0.0043 & -0.0112 & -0.0037 & 0.0002 \\
& JPM & 169.0575 & 170.1000 & 170.6900 & 169.6300 & 170.0000 &
6431800.0000 & -0.0012 & -0.0043 & -0.0112 & -0.0037 & 0.0002 \\
& MS & 92.3454 & 93.2500 & 93.7700 & 93.0600 & 93.4900 & 4772100.0000 &
-0.0042 & -0.0043 & -0.0112 & -0.0037 & 0.0002 \\
& PNC & 153.2765 & 154.8500 & 156.1100 & 154.5200 & 155.2700 &
1572600.0000 & -0.0050 & -0.0043 & -0.0112 & -0.0037 & 0.0002 \\
\end{longtable}

\subsection{\texorpdfstring{Write a function \texttt{download()} that
accepts tickers and returns a wide data frame of returns with the daily
benchmark return
factors.}{Write a function download() that accepts tickers and returns a wide data frame of returns with the daily benchmark return factors.}}\label{write-a-function-download-that-accepts-tickers-and-returns-a-wide-data-frame-of-returns-with-the-daily-benchmark-return-factors.-3}

We can even add a \texttt{shape} argument to return a wide or long data
frame!

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ download(tickers, shape}\OperatorTok{=}\StringTok{\textquotesingle{}wide\textquotesingle{}}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ shape.lower() }\KeywordTok{not} \KeywordTok{in}\NormalTok{ [}\StringTok{\textquotesingle{}wide\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}long\textquotesingle{}}\NormalTok{]:}
        \ControlFlowTok{raise} \PreprocessorTok{ValueError}\NormalTok{(}\StringTok{\textquotesingle{}Invalid shape: must be "wide" or "long".\textquotesingle{}}\NormalTok{)}

\NormalTok{    stocks }\OperatorTok{=}\NormalTok{ yf.download(tickers)}

\NormalTok{    factors\_all }\OperatorTok{=}\NormalTok{ (}
\NormalTok{        pdr.DataReader(}
\NormalTok{            name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{            data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{            start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{        )}
\NormalTok{    )}
    
\NormalTok{    factors }\OperatorTok{=}\NormalTok{ factors\_all[}\DecValTok{0}\NormalTok{].div(}\DecValTok{100}\NormalTok{)}
    
    \CommentTok{\# if stocks has a multi index on the columns because we asked for more than one ticker}
    \CommentTok{\# then we have more work to do}
    \ControlFlowTok{if} \BuiltInTok{type}\NormalTok{(stocks.columns) }\KeywordTok{is}\NormalTok{ pd.MultiIndex:}
        
        \CommentTok{\# whether we want a wide or long data frame, it is easier to add returns to a wide data frame}
\NormalTok{        \_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{], stocks[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].columns])}
\NormalTok{        stocks[\_] }\OperatorTok{=}\NormalTok{ stocks[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].pct\_change()}

        \CommentTok{\# if we want a wide data frame, then we need a factors multi index}
        \ControlFlowTok{if}\NormalTok{ shape.lower() }\OperatorTok{==} \StringTok{\textquotesingle{}wide\textquotesingle{}}\NormalTok{:}
\NormalTok{            \_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Factors\textquotesingle{}}\NormalTok{], factors.columns])}
\NormalTok{            stocks[\_] }\OperatorTok{=}\NormalTok{ factors}
            \ControlFlowTok{return}\NormalTok{ stocks.rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}

        \CommentTok{\# if we want a long data frame, then we need to stack stocks and join factors}
        \CommentTok{\# because we tested for wide and long above, we know that here shape must be long}
        \ControlFlowTok{else}\NormalTok{:}
            \ControlFlowTok{return}\NormalTok{ stocks.stack().join(factors).rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{], index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
            
    \CommentTok{\# if stocks does not have a multi index on the columns}
    \CommentTok{\# then we only have join factors}
    \ControlFlowTok{else}\NormalTok{:}
        \ControlFlowTok{return}\NormalTok{ stocks.join(ff).rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{download(tickers}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}AAPL\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}TSLA\textquotesingle{}}\NormalTok{], shape}\OperatorTok{=}\StringTok{\textquotesingle{}long\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  2 of 2 completed
C:\Users\r.herron\AppData\Local\Temp\ipykernel_28096\3667605341.py:8: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{longtable}[]{@{}lllllllllllll@{}}
\toprule\noalign{}
& Variable & Adj Close & Close & High & Low & Open & Volume & Returns &
Mkt-RF & SMB & HML & RF \\
Date & Ticker & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1980-12-12 & AAPL & 0.0992 & 0.1283 & 0.1289 & 0.1283 & 0.1283 &
469033600.0000 & NaN & 0.0138 & -0.0001 & -0.0105 & 0.0006 \\
1980-12-15 & AAPL & 0.0940 & 0.1217 & 0.1222 & 0.1217 & 0.1222 &
175884800.0000 & -0.0522 & 0.0011 & 0.0025 & -0.0046 & 0.0006 \\
1980-12-16 & AAPL & 0.0871 & 0.1127 & 0.1133 & 0.1127 & 0.1133 &
105728000.0000 & -0.0734 & 0.0071 & -0.0075 & -0.0047 & 0.0006 \\
1980-12-17 & AAPL & 0.0893 & 0.1155 & 0.1161 & 0.1155 & 0.1155 &
86441600.0000 & 0.0248 & 0.0152 & -0.0086 & -0.0034 & 0.0006 \\
1980-12-18 & AAPL & 0.0919 & 0.1189 & 0.1194 & 0.1189 & 0.1189 &
73449600.0000 & 0.0290 & 0.0041 & 0.0022 & 0.0126 & 0.0006 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... \\
2024-02-14 & TSLA & 188.7100 & 188.7100 & 188.8900 & 183.3500 & 185.3000
& 81203000.0000 & 0.0255 & NaN & NaN & NaN & NaN \\
\multirow{2}{=}{2024-02-15} & AAPL & 183.8600 & 183.8600 & 184.4900 &
181.3500 & 183.5500 & 65434500.0000 & -0.0016 & NaN & NaN & NaN & NaN \\
& TSLA & 200.4500 & 200.4500 & 200.8800 & 188.8600 & 189.1600 &
120831800.0000 & 0.0622 & NaN & NaN & NaN & NaN \\
\multirow{2}{=}{2024-02-16} & AAPL & 182.3100 & 182.3100 & 184.8500 &
181.6650 & 183.4200 & 48627624.0000 & -0.0084 & NaN & NaN & NaN & NaN \\
& TSLA & 199.9500 & 199.9500 & 203.1700 & 197.4000 & 202.0600 &
110528448.0000 & -0.0025 & NaN & NaN & NaN & NaN \\
\end{longtable}

\subsection{\texorpdfstring{Download earnings per share for the stocks
in \texttt{stocks} and combine to a long data frame
\texttt{earnings}.}{Download earnings per share for the stocks in stocks and combine to a long data frame earnings.}}\label{download-earnings-per-share-for-the-stocks-in-stocks-and-combine-to-a-long-data-frame-earnings.-3}

Use the \texttt{.earnings\_dates} method described
\href{https://pypi.org/project/yfinance/}{here}. Use
\texttt{pd.concat()} to combine the result of each the
\texttt{.earnings\_date} data frames and assign them to a new data frame
\texttt{earnings}. Name the row indexes \texttt{Ticker} and
\texttt{Date} and swap to match the order of the row index in
\texttt{stocks\_long}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tickers }\OperatorTok{=}\NormalTok{ yf.Tickers(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}BAC C GS JPM MS PNC\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{earnings  }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat(}
\NormalTok{        objs}\OperatorTok{=}\NormalTok{[tickers.tickers[t].earnings\_dates }\ControlFlowTok{for}\NormalTok{ t }\KeywordTok{in}\NormalTok{ tickers.tickers],}
\NormalTok{        keys}\OperatorTok{=}\NormalTok{tickers.tickers,}
\NormalTok{        names}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{]}
\NormalTok{    )}
\NormalTok{    .reset\_index()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{earnings.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& Ticker & Date & EPS Estimate & Reported EPS & Surprise(\%) \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
67 & PNC & 2024-04-16 08:00:00-04:00 & 3.0800 & NaN & NaN \\
68 & PNC & 2024-01-16 06:00:00-05:00 & 2.9400 & 3.1600 & 0.0737 \\
69 & PNC & 2023-10-13 06:00:00-04:00 & 3.1100 & 3.6000 & 0.1586 \\
70 & PNC & 2023-07-18 07:00:00-04:00 & 3.2800 & 3.3600 & 0.0230 \\
71 & PNC & 2023-04-14 06:00:00-04:00 & 3.6700 & 3.9800 & 0.0847 \\
\end{longtable}

\subsection{\texorpdfstring{Combine \texttt{earnings} with the returns
from
\texttt{stocks\_long}.}{Combine earnings with the returns from stocks\_long.}}\label{combine-earnings-with-the-returns-from-stocks_long.-3}

Use the
\texttt{tz\_localize(\textquotesingle{}America/New\_York\textquotesingle{})}
method add time zone information back to \texttt{returns.index} and use
\texttt{pd.to\_timedelta(16,\ unit=\textquotesingle{}h\textquotesingle{})}
to set time to the market close in New York City. Use
\href{https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.merge_asof.html}{\texttt{pd.merge\_asof()}}
to match earnings announcement dates and times to appropriate return
periods. For example, if a firm announces earnings after the close at 5
PM on February 7, we want to match the return period from 4 PM on
February 7 to 4 PM on February 8.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    stocks\_long}
\NormalTok{    .reset\_index()}
\NormalTok{    [[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .assign(}
\NormalTok{        Date}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{].dt.tz\_localize(}\StringTok{\textquotesingle{}America/New\_York\textquotesingle{}}\NormalTok{) }\OperatorTok{+}\NormalTok{ pd.to\_timedelta(}\DecValTok{16}\NormalTok{, unit}\OperatorTok{=}\StringTok{\textquotesingle{}H\textquotesingle{}}\NormalTok{)}
\NormalTok{    )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& Date & Ticker & Returns \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
62021 & 2024-02-16 16:00:00-05:00 & C & NaN \\
62022 & 2024-02-16 16:00:00-05:00 & GS & NaN \\
62023 & 2024-02-16 16:00:00-05:00 & JPM & NaN \\
62024 & 2024-02-16 16:00:00-05:00 & MS & NaN \\
62025 & 2024-02-16 16:00:00-05:00 & PNC & NaN \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{surprises }\OperatorTok{=}\NormalTok{ pd.merge\_asof(}
\NormalTok{    left}\OperatorTok{=}\NormalTok{earnings.sort\_values([}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{]),}
\NormalTok{    right}\OperatorTok{=}\NormalTok{returns.sort\_values([}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{]),}
\NormalTok{    on}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{,}
\NormalTok{    by}\OperatorTok{=}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{,}
\NormalTok{    direction}\OperatorTok{=}\StringTok{\textquotesingle{}forward\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{surprises.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& Ticker & Date & EPS Estimate & Reported EPS & Surprise(\%) &
Returns \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
67 & JPM & 2025-01-15 08:00:00-05:00 & NaN & NaN & NaN & NaN \\
68 & JPM & 2025-01-15 08:00:00-05:00 & NaN & NaN & NaN & NaN \\
69 & C & 2025-01-15 11:00:00-05:00 & NaN & NaN & NaN & NaN \\
70 & PNC & 2025-01-16 08:00:00-05:00 & NaN & NaN & NaN & NaN \\
71 & PNC & 2025-01-16 10:00:00-05:00 & NaN & NaN & NaN & NaN \\
\end{longtable}

\subsection{Plot the relation between daily returns and earnings
surprises}\label{plot-the-relation-between-daily-returns-and-earnings-surprises-3}

Three options in increasing difficulty:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Scatter plot
\item
  Scatter plot with a best-fit line using \texttt{regplot()} from the
  seaborn package
\item
  Bar plot using \texttt{barplot()} from the seaborn package after using
  \texttt{pd.qcut()} to form five groups on earnings surprises
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    surprises}
\NormalTok{    [[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}scatter\textquotesingle{}}\NormalTok{, x}\OperatorTok{=}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, y}\OperatorTok{=}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Earnings Surprise (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Day Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Earnings Surprise Analysis}\CharTok{\textbackslash{}n}\SpecialStringTok{ }\SpecialCharTok{\{}\StringTok{\textquotesingle{}, \textquotesingle{}}\SpecialCharTok{.}\NormalTok{join(tickers.tickers)}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_08_practice_05_files/figure-pdf/cell-30-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ seaborn }\ImportTok{as}\NormalTok{ sns}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.regplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{surprises[[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]].mul(}\DecValTok{100}\NormalTok{),}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Returns\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Earnings Surprise (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Day Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Earnings Surprise Analysis}\CharTok{\textbackslash{}n}\SpecialStringTok{ }\SpecialCharTok{\{}\StringTok{\textquotesingle{}, \textquotesingle{}}\SpecialCharTok{.}\NormalTok{join(tickers.tickers)}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_08_practice_05_files/figure-pdf/cell-32-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.catplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{(}
\NormalTok{        surprises[[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]]}
\NormalTok{        .dropna()}
\NormalTok{        .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{        .assign(}
\NormalTok{            surprise\_bin}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: pd.qcut(x[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{], q}\OperatorTok{=}\DecValTok{5}\NormalTok{, labels}\OperatorTok{=}\VariableTok{False}\NormalTok{)}\OperatorTok{+}\DecValTok{1}
\NormalTok{        )}
\NormalTok{    ),}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}surprise\_bin\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{,}
\NormalTok{    kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Earnings Surprise Bin (1=Lowest, 5=Highest)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Day Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Earnings Surprise Analysis}\CharTok{\textbackslash{}n}\SpecialStringTok{ }\SpecialCharTok{\{}\StringTok{\textquotesingle{}, \textquotesingle{}}\SpecialCharTok{.}\NormalTok{join(tickers.tickers)}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_08_practice_05_files/figure-pdf/cell-33-output-1.png}

\subsection{Repeat the earnings exercise with the S\&P 100
stocks}\label{repeat-the-earnings-exercise-with-the-sp-100-stocks-3}

With more data, we can more clearly see the positive relation between
earnings surprises and returns!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ pd.read\_html(}\StringTok{\textquotesingle{}https://en.wikipedia.org/wiki/S\%26P\_100\textquotesingle{}}\NormalTok{)[}\DecValTok{2}\NormalTok{][}\StringTok{\textquotesingle{}Symbol\textquotesingle{}}\NormalTok{].to\_list()}
\NormalTok{tickers\_2 }\OperatorTok{=}\NormalTok{ yf.Tickers(tickers}\OperatorTok{=}\NormalTok{[t.replace(}\StringTok{\textquotesingle{}.\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}{-}\textquotesingle{}}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ t }\KeywordTok{in}\NormalTok{ \_]) }\CommentTok{\# Yahoo! Finance uses "{-}" to indicate share classes instead of "."}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{earnings\_2  }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat(}
\NormalTok{        objs}\OperatorTok{=}\NormalTok{[tickers\_2.tickers[t].earnings\_dates }\ControlFlowTok{for}\NormalTok{ t }\KeywordTok{in}\NormalTok{ tickers\_2.tickers],}
\NormalTok{        keys}\OperatorTok{=}\NormalTok{tickers\_2.tickers,}
\NormalTok{        names}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{]}
\NormalTok{    )}
\NormalTok{    .reset\_index()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{earnings\_2.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& Ticker & Date & EPS Estimate & Reported EPS & Surprise(\%) \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1207 & XOM & 2023-04-28 06:00:00-04:00 & 2.5900 & 2.8300 & 0.0943 \\
1208 & XOM & 2023-01-31 06:00:00-05:00 & 3.2900 & 3.4000 & 0.0319 \\
1209 & XOM & 2022-10-28 06:00:00-04:00 & 3.7900 & 4.4500 & 0.1733 \\
1210 & XOM & 2022-07-29 06:00:00-04:00 & 3.7400 & 4.1400 & 0.1077 \\
1211 & XOM & 2022-04-29 06:00:00-04:00 & 2.1200 & 2.0700 & -0.0247 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\NormalTok{[t }\ControlFlowTok{for}\NormalTok{ t }\KeywordTok{in}\NormalTok{ tickers\_2.tickers])}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
\NormalTok{    [}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .pct\_change()}
\NormalTok{    .stack()}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{)}
\NormalTok{    .reset\_index()}
\NormalTok{    [[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .assign(}
\NormalTok{        Date}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{].dt.tz\_localize(}\StringTok{\textquotesingle{}America/New\_York\textquotesingle{}}\NormalTok{) }\OperatorTok{+}\NormalTok{ pd.to\_timedelta(}\DecValTok{16}\NormalTok{, unit}\OperatorTok{=}\StringTok{\textquotesingle{}H\textquotesingle{}}\NormalTok{)}
\NormalTok{    )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  101 of 101 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns\_2.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& Date & Ticker & Returns \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1018569 & 2024-02-16 16:00:00-05:00 & V & -0.0086 \\
1018570 & 2024-02-16 16:00:00-05:00 & VZ & -0.0025 \\
1018571 & 2024-02-16 16:00:00-05:00 & WFC & -0.0025 \\
1018572 & 2024-02-16 16:00:00-05:00 & WMT & 0.0063 \\
1018573 & 2024-02-16 16:00:00-05:00 & XOM & 0.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{surprises\_2 }\OperatorTok{=}\NormalTok{ pd.merge\_asof(}
\NormalTok{    left}\OperatorTok{=}\NormalTok{earnings\_2.sort\_values([}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{]),}
\NormalTok{    right}\OperatorTok{=}\NormalTok{returns\_2.sort\_values([}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{]),}
\NormalTok{    on}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{,}
\NormalTok{    by}\OperatorTok{=}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{,}
\NormalTok{    direction}\OperatorTok{=}\StringTok{\textquotesingle{}forward\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{surprises\_2.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& Ticker & Date & EPS Estimate & Reported EPS & Surprise(\%) &
Returns \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1207 & USB & 2025-10-16 09:00:00-04:00 & NaN & NaN & NaN & NaN \\
1208 & USB & 2025-10-16 09:00:00-04:00 & NaN & NaN & NaN & NaN \\
1209 & RTX & 2025-10-20 06:00:00-04:00 & NaN & NaN & NaN & NaN \\
1210 & USB & 2026-01-20 09:00:00-05:00 & NaN & NaN & NaN & NaN \\
1211 & USB & 2026-01-20 09:00:00-05:00 & NaN & NaN & NaN & NaN \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    surprises\_2}
\NormalTok{    [[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}scatter\textquotesingle{}}\NormalTok{, x}\OperatorTok{=}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, y}\OperatorTok{=}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Earnings Surprise (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Day Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Earnings Surprise Analysis}\CharTok{\textbackslash{}n}\StringTok{ S\&P 100 Stocks\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_08_practice_05_files/figure-pdf/cell-41-output-1.png}

\textbf{\emph{There are a few large negative and positive earnings
surprises that make our plot difficult to interpret!}} We have these
huge outliers because surprises are defined as the percent change
relative to the expected. If expected is a very small number, then the
surprise can be a very large number! We would use different surprise
definitions for a more rigorous analysis. Here we can drop observations
less than the 0.01 quantile and greater than the 0.99 quantile.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{low\_2 }\OperatorTok{=}\NormalTok{ surprises\_2[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{].quantile(}\FloatTok{0.01}\NormalTok{)}
\NormalTok{high\_2 }\OperatorTok{=}\NormalTok{ surprises\_2[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{].quantile(}\FloatTok{0.91}\NormalTok{)}

\NormalTok{cond\_2 }\OperatorTok{=}\NormalTok{ surprises\_2[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{].between(low\_2, high\_2)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    surprises\_2}
\NormalTok{    .loc[cond\_2, [}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}scatter\textquotesingle{}}\NormalTok{, x}\OperatorTok{=}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, y}\OperatorTok{=}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.5}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Earnings Surprise (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Day Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Earnings Surprise Analysis}\CharTok{\textbackslash{}n}\StringTok{ S\&P 100 Stocks\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_08_practice_05_files/figure-pdf/cell-43-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.regplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{surprises\_2.loc[cond\_2, [}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]].mul(}\DecValTok{100}\NormalTok{),}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Returns\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Earnings Surprise (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Day Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Earnings Surprise Analysis}\CharTok{\textbackslash{}n}\StringTok{ S\&P 100 Stocks\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_08_practice_05_files/figure-pdf/cell-44-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.catplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{(}
\NormalTok{        surprises\_2}
\NormalTok{        .loc[cond\_2, [}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{]]}
\NormalTok{        .dropna()}
\NormalTok{        .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{        .assign(surprise\_bin}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: pd.qcut(x[}\StringTok{\textquotesingle{}Surprise(\%)\textquotesingle{}}\NormalTok{], q}\OperatorTok{=}\DecValTok{5}\NormalTok{, labels}\OperatorTok{=}\VariableTok{False}\NormalTok{) }\OperatorTok{+} \DecValTok{1}\NormalTok{)}
\NormalTok{    ),}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}surprise\_bin\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Returns\textquotesingle{}}\NormalTok{,}
\NormalTok{    kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Earnings Surprise Bin (1=Lowest, 5=Highest)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Day Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Earnings Surprise Analysis}\CharTok{\textbackslash{}n}\StringTok{ S\&P 100 Stocks\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_08_practice_05_files/figure-pdf/cell-45-output-1.png}

\part{Week 7}

\chapter{Project 1}\label{project-1}

FINA 6333 -- Spring 2023

\hfill\break

To be determined

\part{Week 8}

\chapter{McKinney Chapter 10 - Data Aggregation and Group
Operations}\label{mckinney-chapter-10---data-aggregation-and-group-operations}

\section{Introduction}\label{introduction-5}

Chapter 10 of Wes McKinney's
\href{https://wesmckinney.com/book/}{\emph{Python for Data Analysis}}
discusses groupby operations, which are the pandas equivalent of Excel
pivot tables. Pivot tables help us calculate statistics (e.g., sum,
mean, and median) for one set of variables by groups of other variables
(e.g., weekday or ticker). For example, we could use a pivot table to
calculate mean daily stock returns by weekday.

We will focus on:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Using \texttt{.groupby()} to group by columns, indexes, and functions
\item
  Using \texttt{.agg()} to aggregate multiple functions
\item
  Using pivot tables as an alternative to \texttt{.groupby()}
\end{enumerate}

\textbf{\emph{Note:}} Indented block quotes are from McKinney unless
otherwise indicated. The section numbers here differ from McKinney
because we will only discuss some topics.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\section{GroupBy Mechanics}\label{groupby-mechanics}

``Split-apply-combine'' is an excellent way to describe and visualize
pandas groupby operations.

\begin{quote}
Hadley Wickham, an author of many popular packages for the R programming
language, coined the term split-apply-combine for describing group
operations. In the first stage of the process, data contained in a
pandas object, whether a Series, DataFrame, or otherwise, is split into
groups based on one or more keys that you provide. The splitting is
performed on a particular axis of an object. For example, a DataFrame
can be grouped on its rows (axis=0) or its columns (axis=1). Once this
is done, a function is applied to each group, producing a new value.
Finally, the results of all those function applications are combined
into a result object. The form of the resulting object will usually
depend on what's being done to the data. See Figure 10-1 for a mockup of
a simple group aggregation.
\end{quote}

Figure 10-1 visualizes a split-apply-combine operation that:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Splits by the \texttt{key} column (i.e., ``groups by \texttt{key}'')
\item
  Applies the sum operation to the \texttt{data} column (i.e., ``and
  sums \texttt{data}'')
\item
  Combines the grouped sums
\end{enumerate}

I describe this operation as ``sum the \texttt{data} column by groups
formed on the \texttt{key} column.''

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{df }\OperatorTok{=}\NormalTok{ pd.DataFrame(\{}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{ : [}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{],}
                   \StringTok{\textquotesingle{}key2\textquotesingle{}}\NormalTok{ : [}\StringTok{\textquotesingle{}one\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}two\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}one\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}two\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}one\textquotesingle{}}\NormalTok{],}
                   \StringTok{\textquotesingle{}data1\textquotesingle{}}\NormalTok{ : np.random.randn(}\DecValTok{5}\NormalTok{),}
                   \StringTok{\textquotesingle{}data2\textquotesingle{}}\NormalTok{ : np.random.randn(}\DecValTok{5}\NormalTok{)\})}

\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& key1 & key2 & data1 & data2 \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & a & one & 0.4967 & -0.2341 \\
1 & a & two & -0.1383 & 1.5792 \\
2 & b & one & 0.6477 & 0.7674 \\
3 & b & two & 1.5230 & -0.4695 \\
4 & a & one & -0.2342 & 0.5426 \\
\end{longtable}

Here is one way to calculate the means of \texttt{data1} by groups
formed on \texttt{key1}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.loc[df[}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{] }\OperatorTok{==} \StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}data1\textquotesingle{}}\NormalTok{].mean()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.0414
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.loc[df[}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{] }\OperatorTok{==} \StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}data1\textquotesingle{}}\NormalTok{].mean()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.0854
\end{verbatim}

We can do this calculation more quickly!

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Use the \texttt{.groupby()} method to group by \texttt{key1}
\item
  Use the \texttt{.mean()} method to sum \texttt{data1} within each
  value of \texttt{key1}
\end{enumerate}

Note that without the \texttt{.mean()} method, pandas only sets up the
grouped object, which can accept the \texttt{.mean()} method.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{grouped }\OperatorTok{=}\NormalTok{ df[}\StringTok{\textquotesingle{}data1\textquotesingle{}}\NormalTok{].groupby(df[}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{])}
\NormalTok{grouped}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
<pandas.core.groupby.generic.SeriesGroupBy object at 0x000001B3D7023290>
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{grouped.mean()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
key1
a   0.0414
b   1.0854
Name: data1, dtype: float64
\end{verbatim}

We can can chain the \texttt{.groupby()} and \texttt{.mean()} methods!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df[}\StringTok{\textquotesingle{}data1\textquotesingle{}}\NormalTok{].groupby(df[}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{]).mean()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
key1
a   0.0414
b   1.0854
Name: data1, dtype: float64
\end{verbatim}

If we prefer our result as a dataframe instead of a series, we can wrap
\texttt{data1} with two sets of square brackets.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df[[}\StringTok{\textquotesingle{}data1\textquotesingle{}}\NormalTok{]].groupby(df[}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{]).mean()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}ll@{}}
\toprule\noalign{}
& data1 \\
key1 & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
a & 0.0414 \\
b & 1.0854 \\
\end{longtable}

We can group by more than one variable. We get a hierarchical row index
(or row multi-index) when we group by more than one variable.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{means }\OperatorTok{=}\NormalTok{ df[}\StringTok{\textquotesingle{}data1\textquotesingle{}}\NormalTok{].groupby([df[}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{], df[}\StringTok{\textquotesingle{}key2\textquotesingle{}}\NormalTok{]]).mean()}
\NormalTok{means}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
key1  key2
a     one     0.1313
      two    -0.1383
b     one     0.6477
      two     1.5230
Name: data1, dtype: float64
\end{verbatim}

We can use the \texttt{.unstack()} method if we want to use both rows
and columns to organize data. Recall the \texttt{.unstack()} method
un-stacks the inner index level (i.e., \texttt{level\ =\ -1}) by default
so that \texttt{key2} values become the columns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{means.unstack()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lll@{}}
\toprule\noalign{}
key2 & one & two \\
key1 & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
a & 0.1313 & -0.1383 \\
b & 0.6477 & 1.5230 \\
\end{longtable}

The grouping variables can be columns in the data frame we want to group
with the \texttt{.groupby()} method. Our grouping variables are
typically columns in the data frame we want to group, so this syntax is
more compact and easier to understand.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& key1 & key2 & data1 & data2 \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & a & one & 0.4967 & -0.2341 \\
1 & a & two & -0.1383 & 1.5792 \\
2 & b & one & 0.6477 & 0.7674 \\
3 & b & two & 1.5230 & -0.4695 \\
4 & a & one & -0.2342 & 0.5426 \\
\end{longtable}

\textbf{\emph{However, we need to make sure that all the columns we pass
to the aggregation method (e.g., \texttt{.mean()}) are numerical.}}
Otherwise, pandas will give us a difficult to decipher error about
methods and data types. For example, in the following code, pandas tries
to calculate the mean of column \texttt{key2}, which is a string.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# df.groupby(\textquotesingle{}key1\textquotesingle{}).mean() \# TypeError: agg function failed [how{-}\textgreater{}mean,dtype{-}\textgreater{}object]}
\end{Highlighting}
\end{Shaded}

To avoid this error, we need to either:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Slice the numerical columns (e.g.,
  \texttt{{[}\textquotesingle{}data1\textquotesingle{},\ \textquotesingle{}data2\textquotesingle{}{]}})
\item
  Group on all the non-numerical columns so pandas does not pass them to
  the aggregation function (e.g.,
  \texttt{df.groupby({[}\textquotesingle{}key1\textquotesingle{},\ \textquotesingle{}key2\textquotesingle{}{]})})
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.groupby(}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{)[[}\StringTok{\textquotesingle{}data1\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}data2\textquotesingle{}}\NormalTok{]].mean()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lll@{}}
\toprule\noalign{}
& data1 & data2 \\
key1 & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
a & 0.0414 & 0.6292 \\
b & 1.0854 & 0.1490 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.groupby([}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}key2\textquotesingle{}}\NormalTok{]).mean()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& & data1 & data2 \\
key1 & key2 & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{2}{=}{a} & one & 0.1313 & 0.1542 \\
& two & -0.1383 & 1.5792 \\
\multirow{2}{=}{b} & one & 0.6477 & 0.7674 \\
& two & 1.5230 & -0.4695 \\
\end{longtable}

We can use tab completion to reminder ourselves of methods we can apply
to grouped series and data frames.

\subsection{Iterating Over Groups}\label{iterating-over-groups}

We can iterate over groups, too, because the \texttt{.groupby()} method
generates a sequence of tuples. Each tuples contains the value(s) of the
grouping variable(s) and its chunk of the dataframe. McKinney provides
two loops to show how to iterate over groups.

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ k1, group }\KeywordTok{in}\NormalTok{ df.groupby(}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{):}
    \BuiltInTok{print}\NormalTok{(k1, group, sep}\OperatorTok{=}\StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
a
  key1 key2   data1   data2
0    a  one  0.4967 -0.2341
1    a  two -0.1383  1.5792
4    a  one -0.2342  0.5426
b
  key1 key2  data1   data2
2    b  one 0.6477  0.7674
3    b  two 1.5230 -0.4695
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ (k1, k2), group }\KeywordTok{in}\NormalTok{ df.groupby([}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}key2\textquotesingle{}}\NormalTok{]):}
    \BuiltInTok{print}\NormalTok{((k1, k2), group, sep}\OperatorTok{=}\StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
('a', 'one')
  key1 key2   data1   data2
0    a  one  0.4967 -0.2341
4    a  one -0.2342  0.5426
('a', 'two')
  key1 key2   data1  data2
1    a  two -0.1383 1.5792
('b', 'one')
  key1 key2  data1  data2
2    b  one 0.6477 0.7674
('b', 'two')
  key1 key2  data1   data2
3    b  two 1.5230 -0.4695
\end{verbatim}

\subsection{Grouping with Functions}\label{grouping-with-functions}

We can also group with functions. Below, we group with the \texttt{len}
function, which calculates the length of the first names in the row
index. We could instead add a helper column to \texttt{people}, but it
is easier to pass a function to \texttt{.groupby()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{people }\OperatorTok{=}\NormalTok{ pd.DataFrame(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{np.random.randn(}\DecValTok{5}\NormalTok{, }\DecValTok{5}\NormalTok{), }
\NormalTok{    columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}c\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}d\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}e\textquotesingle{}}\NormalTok{], }
\NormalTok{    index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Joe\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Steve\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Wes\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Jim\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Travis\textquotesingle{}}\NormalTok{]}
\NormalTok{)}

\NormalTok{people}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& a & b & c & d & e \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Joe & 0.4967 & -0.1383 & 0.6477 & 1.5230 & -0.2342 \\
Steve & -0.2341 & 1.5792 & 0.7674 & -0.4695 & 0.5426 \\
Wes & -0.4634 & -0.4657 & 0.2420 & -1.9133 & -1.7249 \\
Jim & -0.5623 & -1.0128 & 0.3142 & -0.9080 & -1.4123 \\
Travis & 1.4656 & -0.2258 & 0.0675 & -1.4247 & -0.5444 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{people.groupby(}\BuiltInTok{len}\NormalTok{).}\BuiltInTok{sum}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& a & b & c & d & e \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
3 & -0.5290 & -1.6168 & 1.2039 & -1.2983 & -3.3714 \\
5 & -0.2341 & 1.5792 & 0.7674 & -0.4695 & 0.5426 \\
6 & 1.4656 & -0.2258 & 0.0675 & -1.4247 & -0.5444 \\
\end{longtable}

We can mix functions, lists, dictionaries, etc. that we pass to
\texttt{.groupby()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{key\_list }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}one\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}one\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}one\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}two\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}two\textquotesingle{}}\NormalTok{]}
\NormalTok{people.groupby([}\BuiltInTok{len}\NormalTok{, key\_list]).}\BuiltInTok{min}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& & a & b & c & d & e \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{2}{=}{3} & one & -0.4634 & -0.4657 & 0.2420 & -1.9133 &
-1.7249 \\
& two & -0.5623 & -1.0128 & 0.3142 & -0.9080 & -1.4123 \\
5 & one & -0.2341 & 1.5792 & 0.7674 & -0.4695 & 0.5426 \\
6 & two & 1.4656 & -0.2258 & 0.0675 & -1.4247 & -0.5444 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d }\OperatorTok{=}\NormalTok{ \{}\StringTok{\textquotesingle{}Joe\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}a\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Jim\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}b\textquotesingle{}}\NormalTok{\}}
\NormalTok{people.groupby([}\BuiltInTok{len}\NormalTok{, d]).}\BuiltInTok{min}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& & a & b & c & d & e \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{2}{=}{3} & a & 0.4967 & -0.1383 & 0.6477 & 1.5230 & -0.2342 \\
& b & -0.5623 & -1.0128 & 0.3142 & -0.9080 & -1.4123 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{d\_2 }\OperatorTok{=}\NormalTok{ \{}\StringTok{\textquotesingle{}Joe\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Cool\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Jim\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Nerd\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Travis\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Cool\textquotesingle{}}\NormalTok{\}}
\NormalTok{people.groupby([}\BuiltInTok{len}\NormalTok{, d\_2]).}\BuiltInTok{min}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
& & a & b & c & d & e \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{2}{=}{3} & Cool & 0.4967 & -0.1383 & 0.6477 & 1.5230 &
-0.2342 \\
& Nerd & -0.5623 & -1.0128 & 0.3142 & -0.9080 & -1.4123 \\
6 & Cool & 1.4656 & -0.2258 & 0.0675 & -1.4247 & -0.5444 \\
\end{longtable}

\subsection{Grouping by Index Levels}\label{grouping-by-index-levels}

We can also group by index levels. We can specify index levels by either
level number or name.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{columns }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_arrays([[}\StringTok{\textquotesingle{}US\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}US\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}US\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}JP\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}JP\textquotesingle{}}\NormalTok{],}
\NormalTok{                                    [}\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{, }\DecValTok{5}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{3}\NormalTok{]],}
\NormalTok{                                    names}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}cty\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}tenor\textquotesingle{}}\NormalTok{])}
\NormalTok{hier\_df }\OperatorTok{=}\NormalTok{ pd.DataFrame(np.random.randn(}\DecValTok{4}\NormalTok{, }\DecValTok{5}\NormalTok{), columns}\OperatorTok{=}\NormalTok{columns)}

\NormalTok{hier\_df.T}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& & 0 & 1 & 2 & 3 \\
cty & tenor & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{3}{=}{US} & 1 & 0.1109 & -0.6017 & -1.2208 & 0.7385 \\
& 3 & -1.1510 & 1.8523 & 0.2089 & 0.1714 \\
& 5 & 0.3757 & -0.0135 & -1.9597 & -0.1156 \\
\multirow{2}{=}{JP} & 1 & -0.6006 & -1.0577 & -1.3282 & -0.3011 \\
& 3 & -0.2917 & 0.8225 & 0.1969 & -1.4785 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hier\_df.T.groupby(level}\OperatorTok{=}\StringTok{\textquotesingle{}cty\textquotesingle{}}\NormalTok{).count()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& 0 & 1 & 2 & 3 \\
cty & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
JP & 2 & 2 & 2 & 2 \\
US & 3 & 3 & 3 & 3 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{hier\_df.T.groupby(level}\OperatorTok{=}\StringTok{\textquotesingle{}tenor\textquotesingle{}}\NormalTok{).count()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& 0 & 1 & 2 & 3 \\
tenor & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1 & 2 & 2 & 2 & 2 \\
3 & 2 & 2 & 2 & 2 \\
5 & 1 & 1 & 1 & 1 \\
\end{longtable}

\section{Data Aggregation}\label{data-aggregation}

Table 10-1 provides the optimized groupby methods:

\begin{itemize}
\tightlist
\item
  \texttt{count}: Number of non-NA values in the group
\item
  \texttt{sum}: Sum of non-NA values
\item
  \texttt{mean}: Mean of non-NA values
\item
  \texttt{median}: Arithmetic median of non-NA values
\item
  \texttt{std}, \texttt{var}: Unbiased (n -- 1 denominator) standard
  deviation and variance
\item
  \texttt{min}, \texttt{max}: Minimum and maximum of non-NA values
\item
  \texttt{prod}: Product of non-NA values
\item
  \texttt{first}, \texttt{last}: First and last non-NA values
\end{itemize}

These optimized methods are fast and efficient, but pandas lets us use
other, non-optimized methods. First, any series method is available.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& key1 & key2 & data1 & data2 \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & a & one & 0.4967 & -0.2341 \\
1 & a & two & -0.1383 & 1.5792 \\
2 & b & one & 0.6477 & 0.7674 \\
3 & b & two & 1.5230 & -0.4695 \\
4 & a & one & -0.2342 & 0.5426 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.groupby(}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}data1\textquotesingle{}}\NormalTok{].quantile(}\FloatTok{0.9}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
key1
a   0.3697
b   1.4355
Name: data1, dtype: float64
\end{verbatim}

Second, we can write our own functions and pass them to the
\texttt{.agg()} method. These functions should accept an array and
returns a single value.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ max\_minus\_min(arr):}
    \ControlFlowTok{return}\NormalTok{ arr.}\BuiltInTok{max}\NormalTok{() }\OperatorTok{{-}}\NormalTok{ arr.}\BuiltInTok{min}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.sort\_values(by}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}data1\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& key1 & key2 & data1 & data2 \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
4 & a & one & -0.2342 & 0.5426 \\
1 & a & two & -0.1383 & 1.5792 \\
0 & a & one & 0.4967 & -0.2341 \\
2 & b & one & 0.6477 & 0.7674 \\
3 & b & two & 1.5230 & -0.4695 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.groupby(}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}data1\textquotesingle{}}\NormalTok{].agg(max\_minus\_min)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
key1
a   0.7309
b   0.8753
Name: data1, dtype: float64
\end{verbatim}

Some other methods work, too, even if they are do not aggregate an array
to a single value.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.groupby(}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}data1\textquotesingle{}}\NormalTok{].describe()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllll@{}}
\toprule\noalign{}
& count & mean & std & min & 25\% & 50\% & 75\% & max \\
key1 & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
a & 3.0000 & 0.0414 & 0.3972 & -0.2342 & -0.1862 & -0.1383 & 0.1792 &
0.4967 \\
b & 2.0000 & 1.0854 & 0.6190 & 0.6477 & 0.8665 & 1.0854 & 1.3042 &
1.5230 \\
\end{longtable}

\subsection{Column-Wise and Multiple Function
Application}\label{column-wise-and-multiple-function-application}

The \texttt{.agg()} methods provides two more handy features:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  We can pass multiple functions to operate on all of the columns
\item
  We can pass specific functions to operate on specific columns
\end{enumerate}

Here is an example with multiple functions:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.groupby(}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{)[}\StringTok{\textquotesingle{}data1\textquotesingle{}}\NormalTok{].agg([}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}median\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}min\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}max\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& mean & median & min & max \\
key1 & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
a & 0.0414 & -0.1383 & -0.2342 & 0.4967 \\
b & 1.0854 & 1.0854 & 0.6477 & 1.5230 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.groupby(}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{)[[}\StringTok{\textquotesingle{}data1\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}data2\textquotesingle{}}\NormalTok{]].agg([}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}median\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}min\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}max\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllll@{}}
\toprule\noalign{}
& \multicolumn{4}{l}{%
data1} & \multicolumn{4}{l@{}}{%
data2} \\
& mean & median & min & max & mean & median & min & max \\
key1 & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
a & 0.0414 & -0.1383 & -0.2342 & 0.4967 & 0.6292 & 0.5426 & -0.2341 &
1.5792 \\
b & 1.0854 & 1.0854 & 0.6477 & 1.5230 & 0.1490 & 0.1490 & -0.4695 &
0.7674 \\
\end{longtable}

What if I wanted to calculate the mean of \texttt{data1} and the median
of \texttt{data2} by \texttt{key1}?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.groupby(}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{).agg(\{}\StringTok{\textquotesingle{}data1\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}data2\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}median\textquotesingle{}}\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lll@{}}
\toprule\noalign{}
& data1 & data2 \\
key1 & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
a & 0.0414 & 0.5426 \\
b & 1.0854 & 0.1490 \\
\end{longtable}

What if I wanted to calculate the mean \emph{and standard deviation} of
\texttt{data1} and the median of \texttt{data2} by \texttt{key1}?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.groupby(}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{).agg(\{}\StringTok{\textquotesingle{}data1\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{], }\StringTok{\textquotesingle{}data2\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}median\textquotesingle{}}\NormalTok{\})}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& \multicolumn{2}{l}{%
data1} & data2 \\
& mean & std & median \\
key1 & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
a & 0.0414 & 0.3972 & 0.5426 \\
b & 1.0854 & 0.6190 & 0.1490 \\
\end{longtable}

\section{Apply: General
split-apply-combine}\label{apply-general-split-apply-combine}

The \texttt{.agg()} method aggrates an array to a single value. We can
use the \texttt{.apply()} method for more general calculations.

We can combine the \texttt{.groupby()} and \texttt{.apply()} methods to:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Split a dataframe by grouping variables
\item
  Call the applied function on each chunk of the original dataframe
\item
  Recombine the output of the applied function
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ top(x, col, n}\OperatorTok{=}\DecValTok{1}\NormalTok{):}
    \ControlFlowTok{return}\NormalTok{ x.sort\_values(col).head(n)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& key1 & key2 & data1 & data2 \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & a & one & 0.4967 & -0.2341 \\
1 & a & two & -0.1383 & 1.5792 \\
2 & b & one & 0.6477 & 0.7674 \\
3 & b & two & 1.5230 & -0.4695 \\
4 & a & one & -0.2342 & 0.5426 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.groupby(}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{).}\BuiltInTok{apply}\NormalTok{(top, col}\OperatorTok{=}\StringTok{\textquotesingle{}data1\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& & key1 & key2 & data1 & data2 \\
key1 & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
a & 4 & a & one & -0.2342 & 0.5426 \\
b & 2 & b & one & 0.6477 & 0.7674 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df.groupby(}\StringTok{\textquotesingle{}key1\textquotesingle{}}\NormalTok{).}\BuiltInTok{apply}\NormalTok{(top, col}\OperatorTok{=}\StringTok{\textquotesingle{}data1\textquotesingle{}}\NormalTok{, n}\OperatorTok{=}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& & key1 & key2 & data1 & data2 \\
key1 & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{2}{=}{a} & 4 & a & one & -0.2342 & 0.5426 \\
& 1 & a & two & -0.1383 & 1.5792 \\
\multirow{2}{=}{b} & 2 & b & one & 0.6477 & 0.7674 \\
& 3 & b & two & 1.5230 & -0.4695 \\
\end{longtable}

\section{Pivot Tables and
Cross-Tabulation}\label{pivot-tables-and-cross-tabulation}

Above we manually made pivot tables with the \texttt{groupby()},
\texttt{.agg()}, \texttt{.apply()} and \texttt{.unstack()} methods.
pandas provides a literal interpreation of Excel-style pivot tables with
the \texttt{.pivot\_table()} method and the
\texttt{pandas.pivot\_table()} function. These also provide row and
column totals via ``margins''. It is worthwhile to read-through the
\texttt{.pivot\_table()} docstring several times.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ind }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}\^{}GSPC \^{}DJI \^{}IXIC \^{}FTSE \^{}N225 \^{}HSI\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Index\textquotesingle{}}\NormalTok{])}
\NormalTok{    .stack()}
\NormalTok{)}

\NormalTok{ind.head()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  6 of 6 completed
\end{verbatim}

\begin{longtable}[]{@{}llllllll@{}}
\toprule\noalign{}
& Variable & Adj Close & Close & High & Low & Open & Volume \\
Date & Index & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1927-12-30 & \^{}GSPC & 17.6600 & 17.6600 & 17.6600 & 17.6600 & 17.6600
& 0.0000 \\
1928-01-03 & \^{}GSPC & 17.7600 & 17.7600 & 17.7600 & 17.7600 & 17.7600
& 0.0000 \\
1928-01-04 & \^{}GSPC & 17.7200 & 17.7200 & 17.7200 & 17.7200 & 17.7200
& 0.0000 \\
1928-01-05 & \^{}GSPC & 17.5500 & 17.5500 & 17.5500 & 17.5500 & 17.5500
& 0.0000 \\
1928-01-06 & \^{}GSPC & 17.6600 & 17.6600 & 17.6600 & 17.6600 & 17.6600
& 0.0000 \\
\end{longtable}

The default aggregation function for \texttt{.pivot\_table()} is
\texttt{mean}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ind.loc[}\StringTok{\textquotesingle{}2015\textquotesingle{}}\NormalTok{:].pivot\_table(index}\OperatorTok{=}\StringTok{\textquotesingle{}Index\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
Variable & Adj Close & Close & High & Low & Open & Volume \\
Index & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\^{}DJI & 26474.0396 & 26474.0396 & 26614.0050 & 26317.6183 & 26469.7020
& 290895360.8696 \\
\^{}FTSE & 7045.8903 & 7045.8903 & 7087.2046 & 7003.6069 & 7045.3863 &
804146245.6710 \\
\^{}GSPC & 3152.9679 & 3152.9679 & 3169.6184 & 3133.9186 & 3152.3787 &
4016121530.4348 \\
\^{}HSI & 24334.1870 & 24334.1870 & 24498.6004 & 24164.3352 & 24350.3348
& 2026656088.8050 \\
\^{}IXIC & 9133.9826 & 9133.9826 & 9194.6083 & 9064.2100 & 9132.1387 &
3273306814.4285 \\
\^{}N225 & 23519.0408 & 23519.0408 & 23642.2996 & 23385.7755 &
23518.4156 & 95240957.9230 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ind.loc[}\StringTok{\textquotesingle{}2015\textquotesingle{}}\NormalTok{:].pivot\_table(index}\OperatorTok{=}\StringTok{\textquotesingle{}Index\textquotesingle{}}\NormalTok{, aggfunc}\OperatorTok{=}\StringTok{\textquotesingle{}median\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
Variable & Adj Close & Close & High & Low & Open & Volume \\
Index & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\^{}DJI & 26065.6494 & 26065.6494 & 26199.2002 & 25921.8994 & 26083.4893
& 297655000.0000 \\
\^{}FTSE & 7190.5000 & 7190.5000 & 7226.2000 & 7148.0000 & 7190.0000 &
757404150.0000 \\
\^{}GSPC & 2902.8950 & 2902.8950 & 2912.7450 & 2891.8750 & 2906.6550 &
3821900000.0000 \\
\^{}HSI & 24615.1309 & 24615.1309 & 24771.5996 & 24476.1992 & 24645.1992
& 1868937800.0000 \\
\^{}IXIC & 8000.2300 & 8000.2300 & 8048.5801 & 7953.6699 & 8011.6802 &
2447750000.0000 \\
\^{}N225 & 22470.3242 & 22470.3242 & 22555.8008 & 22338.5400 &
22460.9902 & 82750000.0000 \\
\end{longtable}

We can use \texttt{values} to select specific variables,
\texttt{pd.Grouper()} to sample different date windows, and
\texttt{aggfunc} to select specific aggregation functions.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    ind}
\NormalTok{    .loc[}\StringTok{\textquotesingle{}2015\textquotesingle{}}\NormalTok{:]}
\NormalTok{    .reset\_index()}
\NormalTok{    .pivot\_table(}
\NormalTok{        values}\OperatorTok{=}\StringTok{\textquotesingle{}Close\textquotesingle{}}\NormalTok{,}
\NormalTok{        index}\OperatorTok{=}\NormalTok{pd.Grouper(key}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, freq}\OperatorTok{=}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{),}
\NormalTok{        columns}\OperatorTok{=}\StringTok{\textquotesingle{}Index\textquotesingle{}}\NormalTok{,}
\NormalTok{        aggfunc}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}min\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}max\textquotesingle{}}\NormalTok{]}
\NormalTok{    )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllll@{}}
\toprule\noalign{}
& \multicolumn{6}{l}{%
min} & \multicolumn{6}{l@{}}{%
max} \\
Index & \^{}DJI & \^{}FTSE & \^{}GSPC & \^{}HSI & \^{}IXIC & \^{}N225 &
\^{}DJI & \^{}FTSE & \^{}GSPC & \^{}HSI & \^{}IXIC & \^{}N225 \\
Date & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2015-12-31 & 15666.4404 & 5874.1001 & 1867.6100 & 20556.5996 & 4506.4902
& 16795.9609 & 18312.3906 & 7104.0000 & 2130.8201 & 28442.7500 &
5218.8599 & 20868.0293 \\
2016-12-31 & 15660.1797 & 5537.0000 & 1829.0800 & 18319.5801 & 4266.8398
& 14952.0195 & 19974.6191 & 7142.7998 & 2271.7200 & 24099.6992 &
5487.4399 & 19494.5293 \\
2017-12-31 & 19732.4004 & 7099.2002 & 2257.8301 & 22134.4707 & 5429.0801
& 18335.6309 & 24837.5098 & 7687.7998 & 2690.1599 & 30003.4902 &
6994.7598 & 22939.1797 \\
2018-12-31 & 21792.1992 & 6584.7002 & 2351.1001 & 24585.5293 & 6192.9199
& 19155.7402 & 26828.3906 & 7877.5000 & 2930.7500 & 33154.1211 &
8109.6899 & 24270.6191 \\
2019-12-31 & 22686.2207 & 6692.7002 & 2447.8899 & 25064.3594 & 6463.5000
& 19561.9609 & 28645.2598 & 7686.6001 & 3240.0200 & 30157.4902 &
9022.3896 & 24066.1191 \\
2020-12-31 & 18591.9297 & 4993.8999 & 2237.3999 & 21696.1309 & 6860.6699
& 16552.8301 & 30606.4805 & 7674.6001 & 3756.0701 & 29056.4199 &
12899.4199 & 27568.1504 \\
2021-12-31 & 29982.6191 & 6407.5000 & 3700.6499 & 22744.8594 &
12609.1602 & 27013.2500 & 36488.6289 & 7420.7002 & 4793.0601 &
31084.9395 & 16057.4404 & 30670.0996 \\
2022-12-31 & 28725.5098 & 6826.2002 & 3577.0300 & 14687.0195 &
10213.2900 & 24717.5293 & 36799.6484 & 7672.3999 & 4796.5601 &
24965.5508 & 15832.7998 & 29332.1602 \\
2023-12-31 & 31819.1406 & 7256.8999 & 3808.1001 & 16201.4902 &
10305.2402 & 25716.8594 & 37710.1016 & 8014.2998 & 4783.3501 &
22688.9004 & 15099.1797 & 33753.3281 \\
2024-12-31 & 37266.6719 & 7446.2998 & 4688.6802 & 14961.1797 &
14510.2998 & 33288.2891 & 39069.1094 & 7728.5000 & 5087.0298 &
16788.5508 & 16041.6201 & 39098.6797 \\
\end{longtable}

\chapter{McKinney Chapter 10 - Practice for Section
02}\label{mckinney-chapter-10---practice-for-section-02}

\section{Announcements}\label{announcements-24}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  I will grade your projects over spring break
\item
  Please complete your peer reviews on Teammates by midnight on Tuesday,
  2/27
\item
  I will record the week 9 lecture video on Thursday
\item
  Enjoy your spring breaks!
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-23}

We will focus on 3 topics from chapter 10 of McKinney:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \emph{GroupBy Mechanics:} We will use the \texttt{.groupby()} method
  to perform ``split-apply-combine'' calculations in pandas, which let
  us aggregate data by one of more columns or indexes.
\item
  \emph{Data Aggregation:} We will combine optimized methods, like
  \texttt{.count()}, \texttt{.sum()}, \texttt{.mean()}, etc., with
  \texttt{.groupby()} to quickly aggregate data. We will combine the
  \texttt{.agg()} or \texttt{.aggregate()} method with
  \texttt{.groupby()} when we want to apply more than one aggregation
  function.
\item
  \emph{Pivot Tables:} We can use the \texttt{.pivot\_table()} method to
  aggregate data with a syntax similar to Excel's pivot tables. We can
  almost always get the same output with the \texttt{.groupby()},
  \texttt{.agg()}, and \texttt{.unstack()} methods.
\end{enumerate}

\section{Practice}\label{practice-24}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{\texorpdfstring{Replicate the following
\texttt{.pivot\_table()} output with
\texttt{.groupby()}}{Replicate the following .pivot\_table() output with .groupby()}}\label{replicate-the-following-.pivot_table-output-with-.groupby}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ind }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}\^{}GSPC \^{}DJI \^{}IXIC \^{}FTSE \^{}N225 \^{}HSI\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Index\textquotesingle{}}\NormalTok{])}
\NormalTok{    .stack()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  6 of 6 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(}
\NormalTok{    ind[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{],}
\NormalTok{    ind[}\StringTok{\textquotesingle{}Close\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ind}
\NormalTok{    .loc[}\StringTok{\textquotesingle{}2015\textquotesingle{}}\NormalTok{:]}
\NormalTok{    .reset\_index()}
\NormalTok{    .pivot\_table(}
\NormalTok{        values}\OperatorTok{=}\StringTok{\textquotesingle{}Close\textquotesingle{}}\NormalTok{,}
\NormalTok{        index}\OperatorTok{=}\NormalTok{pd.Grouper(key}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, freq}\OperatorTok{=}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{),}
\NormalTok{        columns}\OperatorTok{=}\StringTok{\textquotesingle{}Index\textquotesingle{}}\NormalTok{,}
\NormalTok{        aggfunc}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}min\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}max\textquotesingle{}}\NormalTok{]}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllll@{}}
\toprule\noalign{}
& \multicolumn{6}{l}{%
min} & \multicolumn{6}{l@{}}{%
max} \\
Index & \^{}DJI & \^{}FTSE & \^{}GSPC & \^{}HSI & \^{}IXIC & \^{}N225 &
\^{}DJI & \^{}FTSE & \^{}GSPC & \^{}HSI & \^{}IXIC & \^{}N225 \\
Date & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2015-12-31 & 15666.4404 & 5874.1001 & 1867.6100 & 20556.5996 & 4506.4902
& 16795.9609 & 18312.3906 & 7104.0000 & 2130.8201 & 28442.7500 &
5218.8599 & 20868.0293 \\
2016-12-31 & 15660.1797 & 5537.0000 & 1829.0800 & 18319.5801 & 4266.8398
& 14952.0195 & 19974.6191 & 7142.7998 & 2271.7200 & 24099.6992 &
5487.4399 & 19494.5293 \\
2017-12-31 & 19732.4004 & 7099.2002 & 2257.8301 & 22134.4707 & 5429.0801
& 18335.6309 & 24837.5098 & 7687.7998 & 2690.1599 & 30003.4902 &
6994.7598 & 22939.1797 \\
2018-12-31 & 21792.1992 & 6584.7002 & 2351.1001 & 24585.5293 & 6192.9199
& 19155.7402 & 26828.3906 & 7877.5000 & 2930.7500 & 33154.1211 &
8109.6899 & 24270.6191 \\
2019-12-31 & 22686.2207 & 6692.7002 & 2447.8899 & 25064.3594 & 6463.5000
& 19561.9609 & 28645.2598 & 7686.6001 & 3240.0200 & 30157.4902 &
9022.3896 & 24066.1191 \\
2020-12-31 & 18591.9297 & 4993.8999 & 2237.3999 & 21696.1309 & 6860.6699
& 16552.8301 & 30606.4805 & 7674.6001 & 3756.0701 & 29056.4199 &
12899.4199 & 27568.1504 \\
2021-12-31 & 29982.6191 & 6407.5000 & 3700.6499 & 22744.8594 &
12609.1602 & 27013.2500 & 36488.6289 & 7420.7002 & 4793.0601 &
31084.9395 & 16057.4404 & 30670.0996 \\
2022-12-31 & 28725.5098 & 6826.2002 & 3577.0300 & 14687.0195 &
10213.2900 & 24717.5293 & 36799.6484 & 7672.3999 & 4796.5601 &
24965.5508 & 15832.7998 & 29332.1602 \\
2023-12-31 & 31819.1406 & 7256.8999 & 3808.1001 & 16201.4902 &
10305.2402 & 25716.8594 & 37710.1016 & 8014.2998 & 4783.3501 &
22688.9004 & 15099.1797 & 33753.3281 \\
2024-12-31 & 37266.6719 & 7446.2998 & 4688.6802 & 14961.1797 &
14510.2998 & 33288.2891 & 39131.5312 & 7728.5000 & 5137.0801 &
16790.8008 & 16274.9414 & 39910.8203 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ind}
\NormalTok{    .loc[}\StringTok{\textquotesingle{}2015\textquotesingle{}}\NormalTok{:]}
\NormalTok{    .reset\_index()}
\NormalTok{    .groupby([pd.Grouper(key}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, freq}\OperatorTok{=}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{), }\StringTok{\textquotesingle{}Index\textquotesingle{}}\NormalTok{])}
\NormalTok{    [}\StringTok{\textquotesingle{}Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .agg([}\StringTok{\textquotesingle{}min\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}max\textquotesingle{}}\NormalTok{])}
\NormalTok{    .unstack()}
\NormalTok{)}

\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllll@{}}
\toprule\noalign{}
& \multicolumn{6}{l}{%
min} & \multicolumn{6}{l@{}}{%
max} \\
Index & \^{}DJI & \^{}FTSE & \^{}GSPC & \^{}HSI & \^{}IXIC & \^{}N225 &
\^{}DJI & \^{}FTSE & \^{}GSPC & \^{}HSI & \^{}IXIC & \^{}N225 \\
Date & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2015-12-31 & 15666.4404 & 5874.1001 & 1867.6100 & 20556.5996 & 4506.4902
& 16795.9609 & 18312.3906 & 7104.0000 & 2130.8201 & 28442.7500 &
5218.8599 & 20868.0293 \\
2016-12-31 & 15660.1797 & 5537.0000 & 1829.0800 & 18319.5801 & 4266.8398
& 14952.0195 & 19974.6191 & 7142.7998 & 2271.7200 & 24099.6992 &
5487.4399 & 19494.5293 \\
2017-12-31 & 19732.4004 & 7099.2002 & 2257.8301 & 22134.4707 & 5429.0801
& 18335.6309 & 24837.5098 & 7687.7998 & 2690.1599 & 30003.4902 &
6994.7598 & 22939.1797 \\
2018-12-31 & 21792.1992 & 6584.7002 & 2351.1001 & 24585.5293 & 6192.9199
& 19155.7402 & 26828.3906 & 7877.5000 & 2930.7500 & 33154.1211 &
8109.6899 & 24270.6191 \\
2019-12-31 & 22686.2207 & 6692.7002 & 2447.8899 & 25064.3594 & 6463.5000
& 19561.9609 & 28645.2598 & 7686.6001 & 3240.0200 & 30157.4902 &
9022.3896 & 24066.1191 \\
2020-12-31 & 18591.9297 & 4993.8999 & 2237.3999 & 21696.1309 & 6860.6699
& 16552.8301 & 30606.4805 & 7674.6001 & 3756.0701 & 29056.4199 &
12899.4199 & 27568.1504 \\
2021-12-31 & 29982.6191 & 6407.5000 & 3700.6499 & 22744.8594 &
12609.1602 & 27013.2500 & 36488.6289 & 7420.7002 & 4793.0601 &
31084.9395 & 16057.4404 & 30670.0996 \\
2022-12-31 & 28725.5098 & 6826.2002 & 3577.0300 & 14687.0195 &
10213.2900 & 24717.5293 & 36799.6484 & 7672.3999 & 4796.5601 &
24965.5508 & 15832.7998 & 29332.1602 \\
2023-12-31 & 31819.1406 & 7256.8999 & 3808.1001 & 16201.4902 &
10305.2402 & 25716.8594 & 37710.1016 & 8014.2998 & 4783.3501 &
22688.9004 & 15099.1797 & 33753.3281 \\
2024-12-31 & 37266.6719 & 7446.2998 & 4688.6802 & 14961.1797 &
14510.2998 & 33288.2891 & 39131.5312 & 7728.5000 & 5137.0801 &
16790.8008 & 16274.9414 & 39910.8203 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(a, b)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\subsection{Calulate the mean and standard deviation of returns by
ticker for the MATANA (MSFT, AAPL, TSLA, AMZN, NVDA, and GOOG)
stocks}\label{calulate-the-mean-and-standard-deviation-of-returns-by-ticker-for-the-matana-msft-aapl-tsla-amzn-nvda-and-goog-stocks}

Consider only dates with complete returns data. Try this calculation
with wide and long data frames, and confirm your results are the same.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{matana }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}MSFT AAPL TSLA AMZN NVDA GOOG\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  6 of 6 completed
\end{verbatim}

We can add the returns columns first, using the \texttt{pd.MultiIndex}
trick from a few weeks ago.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{], matana[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].columns])}
\NormalTok{matana[\_] }\OperatorTok{=}\NormalTok{ matana[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].pct\_change()}
\end{Highlighting}
\end{Shaded}

We can use \texttt{.agg()} without \texttt{.pivot\_table()} or
\texttt{.groupby()}! We have wide data, so the tickers will be in the
columns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    matana[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{    .dropna()}
\NormalTok{    .aggregate([}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{])}
\NormalTok{)}

\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
Ticker & AAPL & AMZN & GOOG & MSFT & NVDA & TSLA \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
mean & 0.0011 & 0.0012 & 0.0009 & 0.0010 & 0.0021 & 0.0020 \\
std & 0.0176 & 0.0207 & 0.0172 & 0.0163 & 0.0283 & 0.0358 \\
\end{longtable}

We need a long data frame to use \texttt{.pivot\_table()} and
\texttt{.groupby()} methods. Here is the \texttt{.pivot\_table()}
solution.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    matana[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{    .dropna()}
\NormalTok{    .stack()}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{)}
\NormalTok{    .pivot\_table(}
\NormalTok{        values}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{,}
\NormalTok{        index}\OperatorTok{=}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{,}
\NormalTok{        aggfunc}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{]}
\NormalTok{    )}
\NormalTok{    .transpose()}
\NormalTok{)}

\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllll@{}}
\toprule\noalign{}
& Ticker & AAPL & AMZN & GOOG & MSFT & NVDA & TSLA \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
mean & Return & 0.0011 & 0.0012 & 0.0009 & 0.0010 & 0.0021 & 0.0020 \\
std & Return & 0.0176 & 0.0207 & 0.0172 & 0.0163 & 0.0283 & 0.0358 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(a, b)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

Here is the \texttt{.groupby()} solution.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{c }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    matana[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{    .dropna()}
\NormalTok{    .stack()}
\NormalTok{    .groupby(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{    .agg([}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{])}
\NormalTok{    .transpose()}
\NormalTok{)}

\NormalTok{c}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
Ticker & AAPL & AMZN & GOOG & MSFT & NVDA & TSLA \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
mean & 0.0011 & 0.0012 & 0.0009 & 0.0010 & 0.0021 & 0.0020 \\
std & 0.0176 & 0.0207 & 0.0172 & 0.0163 & 0.0283 & 0.0358 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(a, c)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\subsection{Calculate the mean and standard deviation of returns and the
maximum of closing prices by ticker for the MATANA
stocks}\label{calculate-the-mean-and-standard-deviation-of-returns-and-the-maximum-of-closing-prices-by-ticker-for-the-matana-stocks}

Again, consider only dates with complete returns data. Try this
calculation with wide and long data frames, and confirm your results are
the same.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    matana}
\NormalTok{    .dropna()}
\NormalTok{    .stack()}
\NormalTok{    .pivot\_table(}
\NormalTok{        index}\OperatorTok{=}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{,}
\NormalTok{        aggfunc}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{], }\StringTok{\textquotesingle{}Close\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}max\textquotesingle{}}\NormalTok{\}}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
Variable & Close & \multicolumn{2}{l@{}}{%
Return} \\
& max & mean & std \\
Ticker & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
AAPL & 198.1100 & 0.0011 & 0.0176 \\
AMZN & 186.5705 & 0.0012 & 0.0207 \\
GOOG & 154.8400 & 0.0009 & 0.0172 \\
MSFT & 420.5500 & 0.0010 & 0.0163 \\
NVDA & 791.1200 & 0.0021 & 0.0283 \\
TSLA & 409.9700 & 0.0020 & 0.0358 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    matana}
\NormalTok{    .dropna()}
\NormalTok{    .stack()}
\NormalTok{    .groupby(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{    .agg(\{}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{], }\StringTok{\textquotesingle{}Close\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}max\textquotesingle{}}\NormalTok{\})}
\NormalTok{)}

\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
Variable & \multicolumn{2}{l}{%
Return} & Close \\
& mean & std & max \\
Ticker & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
AAPL & 0.0011 & 0.0176 & 198.1100 \\
AMZN & 0.0012 & 0.0207 & 186.5705 \\
GOOG & 0.0009 & 0.0172 & 154.8400 \\
MSFT & 0.0010 & 0.0163 & 420.5500 \\
NVDA & 0.0021 & 0.0283 & 791.1200 \\
TSLA & 0.0020 & 0.0358 & 409.9700 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(a, b)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
False
\end{verbatim}

The \texttt{.pivot\_table()} method sorts it columns, but
\texttt{groupby()} method does not! We need to sort columns with
\texttt{.sort\_index(axis=1)} to make sure our output is the same!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(}
\NormalTok{    a.sort\_index(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{),}
\NormalTok{    b.sort\_index(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

We can use the following code to display all index levels for all rows
and columns.

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{with}\NormalTok{ pd.option\_context(}\StringTok{\textquotesingle{}display.multi\_sparse\textquotesingle{}}\NormalTok{, }\VariableTok{False}\NormalTok{):}
\NormalTok{    display(b)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
Variable & Return & Return & Close \\
& mean & std & max \\
Ticker & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
AAPL & 0.0011 & 0.0176 & 198.1100 \\
AMZN & 0.0012 & 0.0207 & 186.5705 \\
GOOG & 0.0009 & 0.0172 & 154.8400 \\
MSFT & 0.0010 & 0.0163 & 420.5500 \\
NVDA & 0.0021 & 0.0283 & 791.1200 \\
TSLA & 0.0020 & 0.0358 & 409.9700 \\
\end{longtable}

If we prefer to see all index levels all the time, we can set the
following setting at the top of our notebook:

\begin{verbatim}
pd.options.display.multi_sparse = False
\end{verbatim}

We can also copy our output to our clipboaerd then paste it into Excel
if we want to convince ourelves of the column multi index arrangement.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b.to\_clipboard()}
\end{Highlighting}
\end{Shaded}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\subsection{Calculate monthly means and volatilities for SPY and GOOG
returns}\label{calculate-monthly-means-and-volatilities-for-spy-and-goog-returns}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{spy\_goog }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}SPY GOOG\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
\NormalTok{)}

\NormalTok{spy\_goog}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  2 of 2 completed
\end{verbatim}

\begin{longtable}[]{@{}lllllllllllll@{}}
\toprule\noalign{}
Variable & \multicolumn{2}{l}{%
Adj Close} & \multicolumn{2}{l}{%
Close} & \multicolumn{2}{l}{%
High} & \multicolumn{2}{l}{%
Low} & \multicolumn{2}{l}{%
Open} & \multicolumn{2}{l@{}}{%
Volume} \\
Ticker & GOOG & SPY & GOOG & SPY & GOOG & SPY & GOOG & SPY & GOOG & SPY
& GOOG & SPY \\
Date & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1993-01-29 & NaN & 24.8407 & NaN & 43.9375 & NaN & 43.9688 & NaN &
43.7500 & NaN & 43.9688 & NaN & 1003200 \\
1993-02-01 & NaN & 25.0174 & NaN & 44.2500 & NaN & 44.2500 & NaN &
43.9688 & NaN & 43.9688 & NaN & 480500 \\
1993-02-02 & NaN & 25.0704 & NaN & 44.3438 & NaN & 44.3750 & NaN &
44.1250 & NaN & 44.2188 & NaN & 201300 \\
1993-02-03 & NaN & 25.3354 & NaN & 44.8125 & NaN & 44.8438 & NaN &
44.3750 & NaN & 44.4062 & NaN & 529400 \\
1993-02-04 & NaN & 25.4414 & NaN & 45.0000 & NaN & 45.0938 & NaN &
44.4688 & NaN & 44.9688 & NaN & 531500 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... \\
2024-02-26 & 138.7500 & 505.9900 & 138.7500 & 505.9900 & 143.8400 &
508.7500 & 138.7400 & 505.8600 & 143.4500 & 508.3000 & 33513000.0000 &
50386700 \\
2024-02-27 & 140.1000 & 506.9300 & 140.1000 & 506.9300 & 140.4900 &
507.1600 & 138.5000 & 504.7500 & 139.4100 & 506.7000 & 22364000.0000 &
48854500 \\
2024-02-28 & 137.4300 & 506.2600 & 137.4300 & 506.2600 & 139.2800 &
506.8600 & 136.6400 & 504.9600 & 139.1000 & 505.3300 & 30628700.0000 &
56506600 \\
2024-02-29 & 139.7800 & 508.0800 & 139.7800 & 508.0800 & 139.9500 &
509.7400 & 137.5700 & 505.3500 & 138.3500 & 508.0700 & 35485000.0000 &
83824300 \\
2024-03-01 & 138.0800 & 512.8500 & 138.0800 & 512.8500 & 140.0000 &
513.2900 & 137.9750 & 508.5600 & 139.5000 & 508.9800 & 28445474.0000 &
76610613 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{spy\_goog\_m }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    spy\_goog[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{] }\CommentTok{\# select adj close columns}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\CommentTok{\# drop last row, which may have missing intraday adj close}
\NormalTok{    .pct\_change() }\CommentTok{\# calculate daily returns}
\NormalTok{    .stack() }\CommentTok{\# stack to long data}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{) }\CommentTok{\# convert to data frame and name column}
\NormalTok{    .reset\_index() }\CommentTok{\# convert date and ticker to columns}
\NormalTok{    .groupby([pd.Grouper(key}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, freq}\OperatorTok{=}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{), }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{]) }\CommentTok{\# group by month{-}ticker}
\NormalTok{    .agg([}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{]) }\CommentTok{\# calculate mean and volatility}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Statistic\textquotesingle{}}\NormalTok{]) }\CommentTok{\# name columns}
\NormalTok{)}

\NormalTok{spy\_goog\_m}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& Variable & \multicolumn{2}{l@{}}{%
Return} \\
& Statistic & mean & std \\
Date & Ticker & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1993-02-28 & SPY & 0.0006 & 0.0080 \\
1993-03-31 & SPY & 0.0010 & 0.0071 \\
1993-04-30 & SPY & -0.0012 & 0.0074 \\
1993-05-31 & SPY & 0.0014 & 0.0071 \\
1993-06-30 & SPY & 0.0002 & 0.0060 \\
... & ... & ... & ... \\
2023-12-31 & SPY & 0.0023 & 0.0060 \\
\multirow{2}{=}{2024-01-31} & GOOG & 0.0005 & 0.0202 \\
& SPY & 0.0008 & 0.0070 \\
\multirow{2}{=}{2024-02-29} & GOOG & -0.0006 & 0.0159 \\
& SPY & 0.0026 & 0.0076 \\
\end{longtable}

\subsection{Plot the monthly means and volatilities from the previous
exercise}\label{plot-the-monthly-means-and-volatilities-from-the-previous-exercise}

We can create decent \emph{ad hoc} plots with the \texttt{.plot()}
method. We can add a little flexibility with the \texttt{.unstack()}
methods to separately plot these four series, and the
\texttt{subplots=True} argument to plot them on separate axes.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{spy\_goog\_m.plot()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_10_practice_02_files/figure-pdf/cell-24-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{spy\_goog\_m.unstack().plot()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_10_practice_02_files/figure-pdf/cell-25-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{spy\_goog\_m.unstack().plot(subplots}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([<Axes: xlabel='Date'>, <Axes: xlabel='Date'>,
       <Axes: xlabel='Date'>, <Axes: xlabel='Date'>], dtype=object)
\end{verbatim}

\includegraphics{mckinney_10_practice_02_files/figure-pdf/cell-26-output-2.png}

\textbf{\emph{However, we have another excellent plotting tool in the
\texttt{seaborn} package!}}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ seaborn }\ImportTok{as}\NormalTok{ sns}
\end{Highlighting}
\end{Shaded}

The \texttt{seaborn} makes excellent multi-panel plots, including plots
with statistics. \textbf{\emph{But, it requires very long data frames.}}
A \emph{very} long data frame has all of the y values in one column and
all other useful dimensions as columns instead of indexes!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.relplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{spy\_goog\_m.stack().reset\_index(),}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{,}
\NormalTok{    kind}\OperatorTok{=}\StringTok{\textquotesingle{}line\textquotesingle{}}\NormalTok{,}
\NormalTok{    hue}\OperatorTok{=}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{,}
\NormalTok{    col}\OperatorTok{=}\StringTok{\textquotesingle{}Statistic\textquotesingle{}}\NormalTok{,}
\NormalTok{    height}\OperatorTok{=}\DecValTok{3}\NormalTok{,}
\NormalTok{    alpha}\OperatorTok{=}\FloatTok{0.75}
\NormalTok{)}

\NormalTok{plt.gcf().autofmt\_xdate()}
\NormalTok{plt.suptitle(}\StringTok{\textquotesingle{}Monthly Mean and Volatility of Daily Returns\textquotesingle{}}\NormalTok{, y}\OperatorTok{=}\FloatTok{1.05}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_10_practice_02_files/figure-pdf/cell-28-output-1.png}

\subsection{Assign the Dow Jones stocks to five portfolios based on
their monthly
volatility}\label{assign-the-dow-jones-stocks-to-five-portfolios-based-on-their-monthly-volatility}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{wiki }\OperatorTok{=}\NormalTok{ pd.read\_html(}\StringTok{\textquotesingle{}https://en.wikipedia.org/wiki/Dow\_Jones\_Industrial\_Average\textquotesingle{}}\NormalTok{)}
\NormalTok{wiki[}\DecValTok{1}\NormalTok{][}\StringTok{\textquotesingle{}Symbol\textquotesingle{}}\NormalTok{].to\_list()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['MMM',
 'AXP',
 'AMGN',
 'AMZN',
 'AAPL',
 'BA',
 'CAT',
 'CVX',
 'CSCO',
 'KO',
 'DIS',
 'DOW',
 'GS',
 'HD',
 'HON',
 'IBM',
 'INTC',
 'JNJ',
 'JPM',
 'MCD',
 'MRK',
 'MSFT',
 'NKE',
 'PG',
 'CRM',
 'TRV',
 'UNH',
 'VZ',
 'V',
 'WMT']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{djia }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\NormalTok{wiki[}\DecValTok{1}\NormalTok{][}\StringTok{\textquotesingle{}Symbol\textquotesingle{}}\NormalTok{].to\_list())}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
\NormalTok{)}

\NormalTok{djia}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  30 of 30 completed
\end{verbatim}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
Variable & \multicolumn{10}{l}{%
Adj Close} & ... & \multicolumn{10}{l@{}}{%
Volume} \\
Ticker & AAPL & AMGN & AMZN & AXP & BA & CAT & CRM & CSCO & CVX & DIS &
... & MMM & MRK & MSFT & NKE & PG & TRV & UNH & V & VZ & WMT \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1962-01-02 & NaN & NaN & NaN & NaN & 0.1909 & 0.4767 & NaN & NaN &
0.3358 & 0.0582 & ... & 212800 & 633830 & NaN & NaN & 192000 & NaN & NaN
& NaN & NaN & NaN \\
1962-01-03 & NaN & NaN & NaN & NaN & 0.1947 & 0.4813 & NaN & NaN &
0.3350 & 0.0590 & ... & 422400 & 6564672 & NaN & NaN & 428800 & NaN &
NaN & NaN & NaN & NaN \\
1962-01-04 & NaN & NaN & NaN & NaN & 0.1928 & 0.4937 & NaN & NaN &
0.3320 & 0.0590 & ... & 212800 & 1199750 & NaN & NaN & 326400 & NaN &
NaN & NaN & NaN & NaN \\
1962-01-05 & NaN & NaN & NaN & NaN & 0.1890 & 0.4983 & NaN & NaN &
0.3236 & 0.0592 & ... & 315200 & 520646 & NaN & NaN & 544000 & NaN & NaN
& NaN & NaN & NaN \\
1962-01-08 & NaN & NaN & NaN & NaN & 0.1895 & 0.5014 & NaN & NaN &
0.3221 & 0.0590 & ... & 334400 & 1380845 & NaN & NaN & 1523200 & NaN &
NaN & NaN & NaN & NaN \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2024-02-26 & 181.1600 & 286.3700 & 174.7300 & 216.9600 & 200.5400 &
325.3800 & 300.3900 & 48.4000 & 154.4500 & 107.6800 & ... & 3272900 &
5158400 & 16193500.0000 & 5831500.0000 & 4531900 & 1119800.0000 &
2308900.0000 & 3856900.0000 & 25108400.0000 & 32154800.0000 \\
2024-02-27 & 182.6300 & 278.4900 & 173.5400 & 217.9800 & 201.4000 &
327.6300 & 299.5000 & 48.3100 & 152.1600 & 109.4200 & ... & 2288300 &
4780200 & 14835800.0000 & 5317400.0000 & 3868200 & 1245800.0000 &
3780600.0000 & 4145200.0000 & 17074100.0000 & 18012700.0000 \\
2024-02-28 & 181.4200 & 277.4600 & 173.1600 & 218.0300 & 207.0000 &
329.5600 & 299.7700 & 48.0600 & 152.3400 & 110.8000 & ... & 2962400 &
5697200 & 13183100.0000 & 4219800.0000 & 3802900 & 965200.0000 &
9558600.0000 & 4358800.0000 & 12437000.0000 & 14803300.0000 \\
2024-02-29 & 180.7500 & 273.8300 & 176.7600 & 219.4200 & 203.7200 &
333.9600 & 308.8200 & 48.3700 & 152.0100 & 111.5800 & ... & 5157700 &
11245800 & 31910700.0000 & 10810900.0000 & 8348100 & 1996600.0000 &
6832100.0000 & 6633700.0000 & 20485200.0000 & 29220100.0000 \\
2024-03-01 & 179.6600 & 280.3300 & 178.2200 & 219.6600 & 200.0000 &
336.7000 & 316.8800 & 48.4000 & 152.8100 & 111.9500 & ... & 3390922 &
5990626 & 17596713.0000 & 7312382.0000 & 4814999 & 920132.0000 &
7107380.0000 & 3905662.0000 & 12084134.0000 & 18957132.0000 \\
\end{longtable}

First, we add daily returns to \texttt{djia}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{], djia[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]])}
\NormalTok{djia[\_] }\OperatorTok{=}\NormalTok{ djia[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].pct\_change()}
\end{Highlighting}
\end{Shaded}

Second, we add monthly volatility of daily returns to each day. The
\texttt{.transform()} methods lets us add monthly volatility to the
original daily data.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Volatility\textquotesingle{}}\NormalTok{], djia[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]])}
\NormalTok{djia[\_] }\OperatorTok{=}\NormalTok{ djia[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{].groupby(pd.Grouper(freq}\OperatorTok{=}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{)).transform(}\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Third, we use \texttt{pd.qcut()} to assign stocks to portfolios based on
volatility. Here is an example of how to use \texttt{pd.qcut()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.arange(}\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pd.qcut(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{np.arange(}\DecValTok{10}\NormalTok{),}
\NormalTok{    q}\OperatorTok{=}\DecValTok{2}\NormalTok{,}
\NormalTok{    labels}\OperatorTok{=}\VariableTok{False}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0, 0, 0, 0, 0, 1, 1, 1, 1, 1], dtype=int64)
\end{verbatim}

We use the \texttt{.apply()} with \texttt{axis=1} to apply
\texttt{pd.qcut} to every row in
\texttt{djia{[}\textquotesingle{}Volatility\textquotesingle{}{]}}
without writing a for loop. We can also pass \texttt{q=5} and
\texttt{labels=False} after we give the \texttt{pd.qcut} function name.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{], djia[}\StringTok{\textquotesingle{}Volatility\textquotesingle{}}\NormalTok{]])}
\NormalTok{djia[\_] }\OperatorTok{=}\NormalTok{ djia[}\StringTok{\textquotesingle{}Volatility\textquotesingle{}}\NormalTok{].iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(pd.qcut, q}\OperatorTok{=}\DecValTok{5}\NormalTok{, labels}\OperatorTok{=}\VariableTok{False}\NormalTok{, axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\subsection{Plot the time-series volatilities of these five
portfolios}\label{plot-the-time-series-volatilities-of-these-five-portfolios}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{djia.stack()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
& Variable & Adj Close & Close & High & Low & Open & Volume & Return &
Volatility & Portfolio \\
Date & Ticker & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{5}{=}{1962-01-02} & BA & 0.1909 & 0.8230 & 0.8374 & 0.8230 &
0.8374 & 352350.0000 & NaN & 0.0156 & 3.0000 \\
& CAT & 0.4767 & 1.6042 & 1.6198 & 1.5885 & 1.6042 & 163200.0000 & NaN &
0.0121 & 1.0000 \\
& CVX & 0.3358 & 3.2961 & 3.2961 & 3.2440 & 0.0000 & 105840.0000 & NaN &
0.0108 & 0.0000 \\
& DIS & 0.0582 & 0.0929 & 0.0960 & 0.0929 & 0.0929 & 841958.0000 & NaN &
0.0170 & 3.0000 \\
& HON & 1.0740 & 8.3100 & 8.3287 & 8.2726 & 0.0000 & 40740.0000 & NaN &
0.0097 & 0.0000 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
\multirow{5}{=}{2024-03-01} & TRV & 218.8200 & 218.8200 & 221.0900 &
218.3900 & 220.7600 & 920132.0000 & NaN & NaN & NaN \\
& UNH & 489.5300 & 489.5300 & 490.0200 & 477.2500 & 489.4200 &
7107380.0000 & NaN & NaN & NaN \\
& V & 283.1600 & 283.1600 & 284.9100 & 282.1100 & 283.2000 &
3905662.0000 & NaN & NaN & NaN \\
& VZ & 40.2000 & 40.2000 & 40.2900 & 39.7700 & 39.9900 & 12084134.0000 &
NaN & NaN & NaN \\
& WMT & 58.7600 & 58.7600 & 58.8500 & 58.2000 & 58.8000 & 18957132.0000
& NaN & NaN & NaN \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    djia}
\NormalTok{    .stack()}
\NormalTok{    .groupby([}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{])}
\NormalTok{    [}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{    .mean()}
\NormalTok{    .reset\_index()}
\NormalTok{    .dropna()}
\NormalTok{    .assign(Portfolio}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{].astype(}\BuiltInTok{int}\NormalTok{))}
\NormalTok{    .groupby([pd.Grouper(key}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, freq}\OperatorTok{=}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{), }\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{])}
\NormalTok{    .std()}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Volatility\textquotesingle{}}\NormalTok{\})}
\NormalTok{    .unstack()}
\NormalTok{    [}\StringTok{\textquotesingle{}Volatility\textquotesingle{}}\NormalTok{]}
\NormalTok{    .plot()}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Volatility of Daily Returns\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Volatility of Daily Returns}\CharTok{\textbackslash{}n}\StringTok{ for Five Portfolios Formed Monthly on Volatility\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_10_practice_02_files/figure-pdf/cell-37-output-1.png}

\subsection{\texorpdfstring{Calculate the \emph{mean} monthly
correlation between the Dow Jones
stocks}{Calculate the mean monthly correlation between the Dow Jones stocks}}\label{calculate-the-mean-monthly-correlation-between-the-dow-jones-stocks}

\emph{I may build Project 2 on this exercise, so I will leave it blank,
for now.}

\subsection{Is market volatility higher during
wars?}\label{is-market-volatility-higher-during-wars}

Here is some guidance:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Download the daily factor data from Ken French's website
\item
  Calculate daily market returns by summing the market risk premium and
  risk-free rates (\texttt{Mkt-RF} and \texttt{RF}, respectively)
\item
  Calculate the volatility (standard deviation) of daily returns
  \emph{every month} by combining \texttt{pd.Grouper()} and
  \texttt{.groupby()})
\item
  Multiply by \(\sqrt{252}\) to annualize these volatilities of daily
  returns
\item
  Plot these annualized volatilities
\end{enumerate}

Is market volatility higher during wars? Consider the following dates:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  WWII: December 1941 to September 1945
\item
  Korean War: 1950 to 1953
\item
  Viet Nam War: 1959 to 1975
\item
  Gulf War: 1990 to 1991
\item
  War in Afghanistan: 2001 to 2021
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pdr.famafrench.get\_available\_datasets()[:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['F-F_Research_Data_Factors',
 'F-F_Research_Data_Factors_weekly',
 'F-F_Research_Data_Factors_daily',
 'F-F_Research_Data_5_Factors_2x3',
 'F-F_Research_Data_5_Factors_2x3_daily']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_all }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_23660\2526882917.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_all = pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    ff\_all[}\DecValTok{0}\NormalTok{]}
\NormalTok{    .assign(Mkt }\OperatorTok{=} \KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ x[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{])}
\NormalTok{    [}\StringTok{\textquotesingle{}Mkt\textquotesingle{}}\NormalTok{]}
\NormalTok{    .groupby(pd.Grouper(freq}\OperatorTok{=}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{))}
\NormalTok{    .std()}
\NormalTok{    .mul(np.sqrt(}\DecValTok{252}\NormalTok{))}
\NormalTok{    .plot()}
\NormalTok{)}

\CommentTok{\# adds vertical bands for U.S. wars}
\NormalTok{plt.axvspan(}\StringTok{\textquotesingle{}1941{-}12\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}1945{-}09\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.25}\NormalTok{)}
\NormalTok{plt.annotate(}\StringTok{\textquotesingle{}WWII\textquotesingle{}}\NormalTok{, (}\StringTok{\textquotesingle{}1941{-}12\textquotesingle{}}\NormalTok{, }\DecValTok{90}\NormalTok{))}
\NormalTok{plt.axvspan(}\StringTok{\textquotesingle{}1950\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}1953\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.25}\NormalTok{)}
\NormalTok{plt.annotate(}\StringTok{\textquotesingle{}Korean\textquotesingle{}}\NormalTok{, (}\StringTok{\textquotesingle{}1950\textquotesingle{}}\NormalTok{, }\DecValTok{80}\NormalTok{))}
\NormalTok{plt.axvspan(}\StringTok{\textquotesingle{}1959\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}1975\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.25}\NormalTok{)}
\NormalTok{plt.annotate(}\StringTok{\textquotesingle{}Vietnam\textquotesingle{}}\NormalTok{, (}\StringTok{\textquotesingle{}1959\textquotesingle{}}\NormalTok{, }\DecValTok{90}\NormalTok{))}
\NormalTok{plt.axvspan(}\StringTok{\textquotesingle{}1990\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}1991\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.25}\NormalTok{)}
\NormalTok{plt.annotate(}\StringTok{\textquotesingle{}Gulf I\textquotesingle{}}\NormalTok{, (}\StringTok{\textquotesingle{}1990\textquotesingle{}}\NormalTok{, }\DecValTok{80}\NormalTok{))}
\NormalTok{plt.axvspan(}\StringTok{\textquotesingle{}2001\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.25}\NormalTok{)}
\NormalTok{plt.annotate(}\StringTok{\textquotesingle{}Afghanistan\textquotesingle{}}\NormalTok{, (}\StringTok{\textquotesingle{}2001\textquotesingle{}}\NormalTok{, }\DecValTok{90}\NormalTok{))}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Volatility of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Annualized Volatility of U.S. Market}\CharTok{\textbackslash{}n}\StringTok{ Vertical Blue Bands Indicate Wars\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_10_practice_02_files/figure-pdf/cell-40-output-1.png}

\chapter{McKinney Chapter 10 - Practice for Section
03}\label{mckinney-chapter-10---practice-for-section-03}

\section{Announcements}\label{announcements-25}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  I will grade your projects over spring break
\item
  Please complete your peer reviews on Teammates by midnight on Tuesday,
  2/27
\item
  I will record the week 9 lecture video on Thursday
\item
  Enjoy your spring breaks!
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-24}

We will focus on 3 topics from chapter 10 of McKinney:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \emph{GroupBy Mechanics:} We will use the \texttt{.groupby()} method
  to perform ``split-apply-combine'' calculations in pandas, which let
  us aggregate data by one of more columns or indexes.
\item
  \emph{Data Aggregation:} We will combine optimized methods, like
  \texttt{.count()}, \texttt{.sum()}, \texttt{.mean()}, etc., with
  \texttt{.groupby()} to quickly aggregate data. We will combine the
  \texttt{.agg()} or \texttt{.aggregate()} method with
  \texttt{.groupby()} when we want to apply more than one aggregation
  function.
\item
  \emph{Pivot Tables:} We can use the \texttt{.pivot\_table()} method to
  aggregate data with a syntax similar to Excel's pivot tables. We can
  almost always get the same output with the \texttt{.groupby()},
  \texttt{.agg()}, and \texttt{.unstack()} methods.
\end{enumerate}

\section{Practice}\label{practice-25}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{\texorpdfstring{Replicate the following
\texttt{.pivot\_table()} output with
\texttt{.groupby()}}{Replicate the following .pivot\_table() output with .groupby()}}\label{replicate-the-following-.pivot_table-output-with-.groupby-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ind }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}\^{}GSPC \^{}DJI \^{}IXIC \^{}FTSE \^{}N225 \^{}HSI\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Index\textquotesingle{}}\NormalTok{])}
\NormalTok{    .stack()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  6 of 6 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(}
\NormalTok{    ind[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{],}
\NormalTok{    ind[}\StringTok{\textquotesingle{}Close\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ind}
\NormalTok{    .loc[}\StringTok{\textquotesingle{}2015\textquotesingle{}}\NormalTok{:]}
\NormalTok{    .reset\_index()}
\NormalTok{    .pivot\_table(}
\NormalTok{        values}\OperatorTok{=}\StringTok{\textquotesingle{}Close\textquotesingle{}}\NormalTok{,}
\NormalTok{        index}\OperatorTok{=}\NormalTok{pd.Grouper(key}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, freq}\OperatorTok{=}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{),}
\NormalTok{        columns}\OperatorTok{=}\StringTok{\textquotesingle{}Index\textquotesingle{}}\NormalTok{,}
\NormalTok{        aggfunc}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}min\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}max\textquotesingle{}}\NormalTok{]}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllll@{}}
\toprule\noalign{}
& \multicolumn{6}{l}{%
min} & \multicolumn{6}{l@{}}{%
max} \\
Index & \^{}DJI & \^{}FTSE & \^{}GSPC & \^{}HSI & \^{}IXIC & \^{}N225 &
\^{}DJI & \^{}FTSE & \^{}GSPC & \^{}HSI & \^{}IXIC & \^{}N225 \\
Date & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2015-12-31 & 15666.4404 & 5874.1001 & 1867.6100 & 20556.5996 & 4506.4902
& 16795.9609 & 18312.3906 & 7104.0000 & 2130.8201 & 28442.7500 &
5218.8599 & 20868.0293 \\
2016-12-31 & 15660.1797 & 5537.0000 & 1829.0800 & 18319.5801 & 4266.8398
& 14952.0195 & 19974.6191 & 7142.7998 & 2271.7200 & 24099.6992 &
5487.4399 & 19494.5293 \\
2017-12-31 & 19732.4004 & 7099.2002 & 2257.8301 & 22134.4707 & 5429.0801
& 18335.6309 & 24837.5098 & 7687.7998 & 2690.1599 & 30003.4902 &
6994.7598 & 22939.1797 \\
2018-12-31 & 21792.1992 & 6584.7002 & 2351.1001 & 24585.5293 & 6192.9199
& 19155.7402 & 26828.3906 & 7877.5000 & 2930.7500 & 33154.1211 &
8109.6899 & 24270.6191 \\
2019-12-31 & 22686.2207 & 6692.7002 & 2447.8899 & 25064.3594 & 6463.5000
& 19561.9609 & 28645.2598 & 7686.6001 & 3240.0200 & 30157.4902 &
9022.3896 & 24066.1191 \\
2020-12-31 & 18591.9297 & 4993.8999 & 2237.3999 & 21696.1309 & 6860.6699
& 16552.8301 & 30606.4805 & 7674.6001 & 3756.0701 & 29056.4199 &
12899.4199 & 27568.1504 \\
2021-12-31 & 29982.6191 & 6407.5000 & 3700.6499 & 22744.8594 &
12609.1602 & 27013.2500 & 36488.6289 & 7420.7002 & 4793.0601 &
31084.9395 & 16057.4404 & 30670.0996 \\
2022-12-31 & 28725.5098 & 6826.2002 & 3577.0300 & 14687.0195 &
10213.2900 & 24717.5293 & 36799.6484 & 7672.3999 & 4796.5601 &
24965.5508 & 15832.7998 & 29332.1602 \\
2023-12-31 & 31819.1406 & 7256.8999 & 3808.1001 & 16201.4902 &
10305.2402 & 25716.8594 & 37710.1016 & 8014.2998 & 4783.3501 &
22688.9004 & 15099.1797 & 33753.3281 \\
2024-12-31 & 37266.6719 & 7446.2998 & 4688.6802 & 14961.1797 &
14510.2998 & 33288.2891 & 39131.5312 & 7728.5000 & 5137.0801 &
16790.8008 & 16274.9414 & 39910.8203 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ind}
\NormalTok{    .loc[}\StringTok{\textquotesingle{}2015\textquotesingle{}}\NormalTok{:]}
\NormalTok{    .reset\_index()}
\NormalTok{    .groupby([pd.Grouper(key}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, freq}\OperatorTok{=}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{), }\StringTok{\textquotesingle{}Index\textquotesingle{}}\NormalTok{])}
\NormalTok{    [}\StringTok{\textquotesingle{}Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .agg([}\StringTok{\textquotesingle{}min\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}max\textquotesingle{}}\NormalTok{])}
\NormalTok{    .unstack()}
\NormalTok{)}

\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllll@{}}
\toprule\noalign{}
& \multicolumn{6}{l}{%
min} & \multicolumn{6}{l@{}}{%
max} \\
Index & \^{}DJI & \^{}FTSE & \^{}GSPC & \^{}HSI & \^{}IXIC & \^{}N225 &
\^{}DJI & \^{}FTSE & \^{}GSPC & \^{}HSI & \^{}IXIC & \^{}N225 \\
Date & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2015-12-31 & 15666.4404 & 5874.1001 & 1867.6100 & 20556.5996 & 4506.4902
& 16795.9609 & 18312.3906 & 7104.0000 & 2130.8201 & 28442.7500 &
5218.8599 & 20868.0293 \\
2016-12-31 & 15660.1797 & 5537.0000 & 1829.0800 & 18319.5801 & 4266.8398
& 14952.0195 & 19974.6191 & 7142.7998 & 2271.7200 & 24099.6992 &
5487.4399 & 19494.5293 \\
2017-12-31 & 19732.4004 & 7099.2002 & 2257.8301 & 22134.4707 & 5429.0801
& 18335.6309 & 24837.5098 & 7687.7998 & 2690.1599 & 30003.4902 &
6994.7598 & 22939.1797 \\
2018-12-31 & 21792.1992 & 6584.7002 & 2351.1001 & 24585.5293 & 6192.9199
& 19155.7402 & 26828.3906 & 7877.5000 & 2930.7500 & 33154.1211 &
8109.6899 & 24270.6191 \\
2019-12-31 & 22686.2207 & 6692.7002 & 2447.8899 & 25064.3594 & 6463.5000
& 19561.9609 & 28645.2598 & 7686.6001 & 3240.0200 & 30157.4902 &
9022.3896 & 24066.1191 \\
2020-12-31 & 18591.9297 & 4993.8999 & 2237.3999 & 21696.1309 & 6860.6699
& 16552.8301 & 30606.4805 & 7674.6001 & 3756.0701 & 29056.4199 &
12899.4199 & 27568.1504 \\
2021-12-31 & 29982.6191 & 6407.5000 & 3700.6499 & 22744.8594 &
12609.1602 & 27013.2500 & 36488.6289 & 7420.7002 & 4793.0601 &
31084.9395 & 16057.4404 & 30670.0996 \\
2022-12-31 & 28725.5098 & 6826.2002 & 3577.0300 & 14687.0195 &
10213.2900 & 24717.5293 & 36799.6484 & 7672.3999 & 4796.5601 &
24965.5508 & 15832.7998 & 29332.1602 \\
2023-12-31 & 31819.1406 & 7256.8999 & 3808.1001 & 16201.4902 &
10305.2402 & 25716.8594 & 37710.1016 & 8014.2998 & 4783.3501 &
22688.9004 & 15099.1797 & 33753.3281 \\
2024-12-31 & 37266.6719 & 7446.2998 & 4688.6802 & 14961.1797 &
14510.2998 & 33288.2891 & 39131.5312 & 7728.5000 & 5137.0801 &
16790.8008 & 16274.9414 & 39910.8203 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(a, b)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\textbf{\emph{Detour!}} How do we grab the largest 3 values for each
ticker, each year?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    ind}
\NormalTok{    .loc[}\StringTok{\textquotesingle{}2015\textquotesingle{}}\NormalTok{:]}
\NormalTok{    .reset\_index()}
\NormalTok{    .groupby([pd.Grouper(key}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, freq}\OperatorTok{=}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{), }\StringTok{\textquotesingle{}Index\textquotesingle{}}\NormalTok{])}
\NormalTok{    [}\StringTok{\textquotesingle{}Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: x.nlargest(n}\OperatorTok{=}\DecValTok{3}\NormalTok{))}
\NormalTok{    .reset\_index(level}\OperatorTok{={-}}\DecValTok{1}\NormalTok{, drop}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Close\textquotesingle{}}\NormalTok{)}
\NormalTok{    .assign(Rank}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x.groupby([}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Index\textquotesingle{}}\NormalTok{]).cumcount())}
\NormalTok{    .set\_index(}\StringTok{\textquotesingle{}Rank\textquotesingle{}}\NormalTok{, append}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{    .unstack(}\StringTok{\textquotesingle{}Index\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Index\textquotesingle{}}\NormalTok{])}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllll@{}}
\toprule\noalign{}
& Variable & \multicolumn{6}{l@{}}{%
Close} \\
& Index & \^{}DJI & \^{}FTSE & \^{}GSPC & \^{}HSI & \^{}IXIC &
\^{}N225 \\
Date & Rank & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{3}{=}{2015-12-31} & 0 & 18312.3906 & 7104.0000 & 2130.8201 &
28442.7500 & 5218.8599 & 20868.0293 \\
& 1 & 18298.8809 & 7096.7998 & 2129.2000 & 28433.5898 & 5210.1401 &
20841.9707 \\
& 2 & 18288.6309 & 7089.7998 & 2128.2800 & 28400.3398 & 5208.1201 &
20809.4199 \\
\multirow{3}{=}{2016-12-31} & 0 & 19974.6191 & 7142.7998 & 2271.7200 &
24099.6992 & 5487.4399 & 19494.5293 \\
& 1 & 19945.0391 & 7120.2998 & 2270.7600 & 23952.5000 & 5483.9399 &
19444.4902 \\
& 2 & 19941.9609 & 7106.1001 & 2268.8799 & 23919.3398 & 5471.4302 &
19427.6699 \\
\multirow{3}{=}{2017-12-31} & 0 & 24837.5098 & 7687.7998 & 2690.1599 &
30003.4902 & 6994.7598 & 22939.1797 \\
& 1 & 24792.1992 & 7622.8999 & 2687.5400 & 29919.1504 & 6965.3599 &
22938.7305 \\
& 2 & 24782.2891 & 7620.7002 & 2684.5701 & 29866.3203 & 6963.8501 &
22937.5996 \\
\multirow{3}{=}{2018-12-31} & 0 & 26828.3906 & 7877.5000 & 2930.7500 &
33154.1211 & 8109.6899 & 24270.6191 \\
& 1 & 26773.9395 & 7859.2002 & 2929.6699 & 32966.8906 & 8109.5400 &
24245.7598 \\
& 2 & 26743.5000 & 7788.3999 & 2925.5100 & 32958.6914 & 8091.2500 &
24124.1504 \\
\multirow{3}{=}{2019-12-31} & 0 & 28645.2598 & 7686.6001 & 3240.0200 &
30157.4902 & 9022.3896 & 24066.1191 \\
& 1 & 28621.3906 & 7646.7998 & 3239.9099 & 30129.8691 & 9006.6201 &
24023.0996 \\
& 2 & 28551.5293 & 7644.8999 & 3230.7800 & 30124.6797 & 8972.5996 &
23952.3496 \\
\multirow{3}{=}{2020-12-31} & 0 & 30606.4805 & 7674.6001 & 3756.0701 &
29056.4199 & 12899.4199 & 27568.1504 \\
& 1 & 30409.5605 & 7651.3999 & 3735.3601 & 28954.9395 & 12888.2803 &
27444.1699 \\
& 2 & 30403.9707 & 7642.7998 & 3732.0400 & 28885.1406 & 12870.0000 &
26854.0293 \\
\multirow{3}{=}{2021-12-31} & 0 & 36488.6289 & 7420.7002 & 4793.0601 &
31084.9395 & 16057.4404 & 30670.0996 \\
& 1 & 36432.2188 & 7403.0000 & 4791.1899 & 30746.6602 & 15993.7100 &
30511.7109 \\
& 2 & 36398.2109 & 7384.5000 & 4786.3501 & 30644.7305 & 15982.3604 &
30500.0508 \\
\multirow{3}{=}{2022-12-31} & 0 & 36799.6484 & 7672.3999 & 4796.5601 &
24965.5508 & 15832.7998 & 29332.1602 \\
& 1 & 36585.0586 & 7669.6001 & 4793.5400 & 24952.3496 & 15622.7197 &
29301.7891 \\
& 2 & 36407.1094 & 7661.0000 & 4726.3501 & 24924.3496 & 15188.3896 &
29222.7695 \\
\multirow{3}{=}{2023-12-31} & 0 & 37710.1016 & 8014.2998 & 4783.3501 &
22688.9004 & 15099.1797 & 33753.3281 \\
& 1 & 37689.5391 & 8012.5000 & 4781.5801 & 22566.7793 & 15095.1396 &
33706.0781 \\
& 2 & 37656.5195 & 8004.3999 & 4774.7500 & 22072.1797 & 15074.5703 &
33681.2383 \\
\multirow{3}{=}{2024-12-31} & 0 & 39131.5312 & 7728.5000 & 5137.0801 &
16790.8008 & 16274.9414 & 39910.8203 \\
& 1 & 39087.3789 & 7723.1001 & 5096.2700 & 16788.5508 & 16091.9199 &
39239.5195 \\
& 2 & 39069.2305 & 7721.5000 & 5088.7998 & 16742.9492 & 16041.6201 &
39233.7109 \\
\end{longtable}

Adding the \texttt{Rank} that we need to get this data frame back to
wide without the duplicate index error took some after-class tinkering!
Please let me know if you have any questions!

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\subsection{Calulate the mean and standard deviation of returns by
ticker for the MATANA (MSFT, AAPL, TSLA, AMZN, NVDA, and GOOG)
stocks}\label{calulate-the-mean-and-standard-deviation-of-returns-by-ticker-for-the-matana-msft-aapl-tsla-amzn-nvda-and-goog-stocks-1}

Consider only dates with complete returns data. Try this calculation
with wide and long data frames, and confirm your results are the same.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{matana }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}MSFT AAPL TSLA AMZN NVDA GOOG\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  6 of 6 completed
\end{verbatim}

We can add the returns columns first, using the \texttt{pd.MultiIndex}
trick from a few weeks ago.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{], matana[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].columns])}
\NormalTok{matana[\_] }\OperatorTok{=}\NormalTok{ matana[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].pct\_change()}
\end{Highlighting}
\end{Shaded}

We can use \texttt{.agg()} without \texttt{.pivot\_table()} or
\texttt{.groupby()}! We have wide data, so the tickers will be in the
columns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    matana[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{    .dropna()}
\NormalTok{    .agg([}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{])}
\NormalTok{)}

\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
Ticker & AAPL & AMZN & GOOG & MSFT & NVDA & TSLA \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
mean & 0.0011 & 0.0012 & 0.0009 & 0.0010 & 0.0021 & 0.0020 \\
std & 0.0176 & 0.0207 & 0.0172 & 0.0163 & 0.0283 & 0.0358 \\
\end{longtable}

We need a long data frame to use \texttt{.pivot\_table()} and
\texttt{.groupby()} methods. Here is the \texttt{.pivot\_table()}
solution.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    matana[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{    .dropna()}
\NormalTok{    .stack()}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{)}
\NormalTok{    .pivot\_table(}
\NormalTok{        values}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{,}
\NormalTok{        index}\OperatorTok{=}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{,}
\NormalTok{        aggfunc}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{]}
\NormalTok{    )}
\NormalTok{    .transpose()}
\NormalTok{)}

\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllll@{}}
\toprule\noalign{}
& Ticker & AAPL & AMZN & GOOG & MSFT & NVDA & TSLA \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
mean & Return & 0.0011 & 0.0012 & 0.0009 & 0.0010 & 0.0021 & 0.0020 \\
std & Return & 0.0176 & 0.0207 & 0.0172 & 0.0163 & 0.0283 & 0.0358 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(a, b)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

Here is the \texttt{.groupby()} solution.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{c }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    matana[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{    .dropna()}
\NormalTok{    .stack()}
\NormalTok{    .groupby(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{    .agg([}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{])}
\NormalTok{    .transpose()}
\NormalTok{)}

\NormalTok{c}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
Ticker & AAPL & AMZN & GOOG & MSFT & NVDA & TSLA \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
mean & 0.0011 & 0.0012 & 0.0009 & 0.0010 & 0.0021 & 0.0020 \\
std & 0.0176 & 0.0207 & 0.0172 & 0.0163 & 0.0283 & 0.0358 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(a, c)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\subsection{Calculate the mean and standard deviation of returns and the
maximum of closing prices by ticker for the MATANA
stocks}\label{calculate-the-mean-and-standard-deviation-of-returns-and-the-maximum-of-closing-prices-by-ticker-for-the-matana-stocks-1}

Again, consider only dates with complete returns data. Try this
calculation with wide and long data frames, and confirm your results are
the same.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    matana}
\NormalTok{    .dropna()}
\NormalTok{    .stack()}
\NormalTok{    .pivot\_table(}
\NormalTok{        index}\OperatorTok{=}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{,}
\NormalTok{        aggfunc}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{], }\StringTok{\textquotesingle{}Close\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}max\textquotesingle{}}\NormalTok{\}}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
Variable & Close & \multicolumn{2}{l@{}}{%
Return} \\
& max & mean & std \\
Ticker & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
AAPL & 198.1100 & 0.0011 & 0.0176 \\
AMZN & 186.5705 & 0.0012 & 0.0207 \\
GOOG & 154.8400 & 0.0009 & 0.0172 \\
MSFT & 420.5500 & 0.0010 & 0.0163 \\
NVDA & 791.1200 & 0.0021 & 0.0283 \\
TSLA & 409.9700 & 0.0020 & 0.0358 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    matana}
\NormalTok{    .dropna()}
\NormalTok{    .stack()}
\NormalTok{    .groupby(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{    .agg(\{}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{], }\StringTok{\textquotesingle{}Close\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}max\textquotesingle{}}\NormalTok{\})}
\NormalTok{)}

\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
Variable & \multicolumn{2}{l}{%
Return} & Close \\
& mean & std & max \\
Ticker & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
AAPL & 0.0011 & 0.0176 & 198.1100 \\
AMZN & 0.0012 & 0.0207 & 186.5705 \\
GOOG & 0.0009 & 0.0172 & 154.8400 \\
MSFT & 0.0010 & 0.0163 & 420.5500 \\
NVDA & 0.0021 & 0.0283 & 791.1200 \\
TSLA & 0.0020 & 0.0358 & 409.9700 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(a, b)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
False
\end{verbatim}

The \texttt{.pivot\_table()} method sorts it columns, but
\texttt{groupby()} method does not! We need to sort columns with
\texttt{.sort\_index(axis=1)} to make sure our output is the same!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(}
\NormalTok{    a.sort\_index(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{),}
\NormalTok{    b.sort\_index(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

We can use the following code to display all index levels for all rows
and columns.

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{with}\NormalTok{ pd.option\_context(}\StringTok{\textquotesingle{}display.multi\_sparse\textquotesingle{}}\NormalTok{, }\VariableTok{False}\NormalTok{):}
\NormalTok{    display(b)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
Variable & Return & Return & Close \\
& mean & std & max \\
Ticker & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
AAPL & 0.0011 & 0.0176 & 198.1100 \\
AMZN & 0.0012 & 0.0207 & 186.5705 \\
GOOG & 0.0009 & 0.0172 & 154.8400 \\
MSFT & 0.0010 & 0.0163 & 420.5500 \\
NVDA & 0.0021 & 0.0283 & 791.1200 \\
TSLA & 0.0020 & 0.0358 & 409.9700 \\
\end{longtable}

If we prefer to see all index levels all the time, we can set the
following setting at the top of our notebook:

\begin{verbatim}
pd.options.display.multi_sparse = False
\end{verbatim}

We can also copy our output to our clipboaerd then paste it into Excel
if we want to convince ourelves of the column multi index arrangement.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b.to\_clipboard()}
\end{Highlighting}
\end{Shaded}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\subsection{Calculate monthly means and volatilities for SPY and GOOG
returns}\label{calculate-monthly-means-and-volatilities-for-spy-and-goog-returns-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{spy\_goog }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}SPY GOOG\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
\NormalTok{)}

\NormalTok{spy\_goog}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  2 of 2 completed
\end{verbatim}

\begin{longtable}[]{@{}lllllllllllll@{}}
\toprule\noalign{}
Variable & \multicolumn{2}{l}{%
Adj Close} & \multicolumn{2}{l}{%
Close} & \multicolumn{2}{l}{%
High} & \multicolumn{2}{l}{%
Low} & \multicolumn{2}{l}{%
Open} & \multicolumn{2}{l@{}}{%
Volume} \\
Ticker & GOOG & SPY & GOOG & SPY & GOOG & SPY & GOOG & SPY & GOOG & SPY
& GOOG & SPY \\
Date & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1993-01-29 & NaN & 24.8407 & NaN & 43.9375 & NaN & 43.9688 & NaN &
43.7500 & NaN & 43.9688 & NaN & 1003200 \\
1993-02-01 & NaN & 25.0174 & NaN & 44.2500 & NaN & 44.2500 & NaN &
43.9688 & NaN & 43.9688 & NaN & 480500 \\
1993-02-02 & NaN & 25.0704 & NaN & 44.3438 & NaN & 44.3750 & NaN &
44.1250 & NaN & 44.2188 & NaN & 201300 \\
1993-02-03 & NaN & 25.3354 & NaN & 44.8125 & NaN & 44.8438 & NaN &
44.3750 & NaN & 44.4062 & NaN & 529400 \\
1993-02-04 & NaN & 25.4414 & NaN & 45.0000 & NaN & 45.0938 & NaN &
44.4688 & NaN & 44.9688 & NaN & 531500 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... \\
2024-02-26 & 138.7500 & 505.9900 & 138.7500 & 505.9900 & 143.8400 &
508.7500 & 138.7400 & 505.8600 & 143.4500 & 508.3000 & 33513000.0000 &
50386700 \\
2024-02-27 & 140.1000 & 506.9300 & 140.1000 & 506.9300 & 140.4900 &
507.1600 & 138.5000 & 504.7500 & 139.4100 & 506.7000 & 22364000.0000 &
48854500 \\
2024-02-28 & 137.4300 & 506.2600 & 137.4300 & 506.2600 & 139.2800 &
506.8600 & 136.6400 & 504.9600 & 139.1000 & 505.3300 & 30628700.0000 &
56506600 \\
2024-02-29 & 139.7800 & 508.0800 & 139.7800 & 508.0800 & 139.9500 &
509.7400 & 137.5700 & 505.3500 & 138.3500 & 508.0700 & 35485000.0000 &
83824300 \\
2024-03-01 & 138.0800 & 512.8500 & 138.0800 & 512.8500 & 140.0000 &
513.2900 & 137.9750 & 508.5600 & 139.5000 & 508.9800 & 28445474.0000 &
76610613 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{spy\_goog\_m }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    spy\_goog[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{] }\CommentTok{\# select adj close columns}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\CommentTok{\# drop possibly missing intraday prices in last row}
\NormalTok{    .pct\_change() }\CommentTok{\# calculate daily returns}
\NormalTok{    .stack() }\CommentTok{\# converts to long with returns in one column}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{) }\CommentTok{\# converts to data frame with named returns}
\NormalTok{    .reset\_index() }\CommentTok{\# adds date and ticker to data frame for grouping}
\NormalTok{    .groupby([pd.Grouper(key}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, freq}\OperatorTok{=}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{), }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{]) }\CommentTok{\# group by month and ticker}
\NormalTok{    .agg([}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{]) }\CommentTok{\# calculate mean and volatility of returns}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Statistic\textquotesingle{}}\NormalTok{])}
\NormalTok{)}

\NormalTok{spy\_goog\_m}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& Variable & \multicolumn{2}{l@{}}{%
Return} \\
& Statistic & mean & std \\
Date & Ticker & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1993-02-28 & SPY & 0.0006 & 0.0080 \\
1993-03-31 & SPY & 0.0010 & 0.0071 \\
1993-04-30 & SPY & -0.0012 & 0.0074 \\
1993-05-31 & SPY & 0.0014 & 0.0071 \\
1993-06-30 & SPY & 0.0002 & 0.0060 \\
... & ... & ... & ... \\
2023-12-31 & SPY & 0.0023 & 0.0060 \\
\multirow{2}{=}{2024-01-31} & GOOG & 0.0005 & 0.0202 \\
& SPY & 0.0008 & 0.0070 \\
\multirow{2}{=}{2024-02-29} & GOOG & -0.0006 & 0.0159 \\
& SPY & 0.0026 & 0.0076 \\
\end{longtable}

\subsection{Plot the monthly means and volatilities from the previous
exercise}\label{plot-the-monthly-means-and-volatilities-from-the-previous-exercise-1}

We can create decent \emph{ad hoc} plots with the \texttt{.plot()}
method. We can add a little flexibility with the \texttt{.unstack()}
methods to separately plot these four series, and the
\texttt{subplots=True} argument to plot them on separate axes.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{spy\_goog\_m.plot()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_10_practice_03_files/figure-pdf/cell-25-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{spy\_goog\_m.unstack().plot()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_10_practice_03_files/figure-pdf/cell-26-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{spy\_goog\_m.unstack().plot(subplots}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([<Axes: xlabel='Date'>, <Axes: xlabel='Date'>,
       <Axes: xlabel='Date'>, <Axes: xlabel='Date'>], dtype=object)
\end{verbatim}

\includegraphics{mckinney_10_practice_03_files/figure-pdf/cell-27-output-2.png}

We can more easily plot panel data using the \texttt{seaborn} package!

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ seaborn }\ImportTok{as}\NormalTok{ sns}
\end{Highlighting}
\end{Shaded}

The \texttt{seaborn} makes excellent multi-panel plots, including plots
with statistics. \textbf{\emph{But, it requires very long data frames.}}
A \emph{very} long data frame has all of the y values in one column and
all other useful dimensions as columns instead of indexes!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.relplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{spy\_goog\_m.stack().reset\_index(),}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{,}
\NormalTok{    height}\OperatorTok{=}\DecValTok{3}\NormalTok{,}
\NormalTok{    hue}\OperatorTok{=}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{,}
\NormalTok{    col}\OperatorTok{=}\StringTok{\textquotesingle{}Statistic\textquotesingle{}}\NormalTok{,}
\NormalTok{    kind}\OperatorTok{=}\StringTok{\textquotesingle{}line\textquotesingle{}}\NormalTok{,}
\NormalTok{    alpha}\OperatorTok{=}\FloatTok{0.75}
\NormalTok{)}

\NormalTok{plt.gcf().autofmt\_xdate()}
\NormalTok{plt.suptitle(}\StringTok{\textquotesingle{}Monthly Mean and Volatility of Daily Returns\textquotesingle{}}\NormalTok{, y}\OperatorTok{=}\FloatTok{1.05}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_10_practice_03_files/figure-pdf/cell-29-output-1.png}

\subsection{Assign the Dow Jones stocks to five portfolios based on
their monthly
volatility}\label{assign-the-dow-jones-stocks-to-five-portfolios-based-on-their-monthly-volatility-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{wiki }\OperatorTok{=}\NormalTok{ pd.read\_html(}\StringTok{\textquotesingle{}https://en.wikipedia.org/wiki/Dow\_Jones\_Industrial\_Average\textquotesingle{}}\NormalTok{)}
\NormalTok{wiki[}\DecValTok{1}\NormalTok{][}\StringTok{\textquotesingle{}Symbol\textquotesingle{}}\NormalTok{].to\_list()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['MMM',
 'AXP',
 'AMGN',
 'AMZN',
 'AAPL',
 'BA',
 'CAT',
 'CVX',
 'CSCO',
 'KO',
 'DIS',
 'DOW',
 'GS',
 'HD',
 'HON',
 'IBM',
 'INTC',
 'JNJ',
 'JPM',
 'MCD',
 'MRK',
 'MSFT',
 'NKE',
 'PG',
 'CRM',
 'TRV',
 'UNH',
 'VZ',
 'V',
 'WMT']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{djia }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\NormalTok{wiki[}\DecValTok{1}\NormalTok{][}\StringTok{\textquotesingle{}Symbol\textquotesingle{}}\NormalTok{].to\_list())}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
\NormalTok{)}

\NormalTok{djia}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  30 of 30 completed
\end{verbatim}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
Variable & \multicolumn{10}{l}{%
Adj Close} & ... & \multicolumn{10}{l@{}}{%
Volume} \\
Ticker & AAPL & AMGN & AMZN & AXP & BA & CAT & CRM & CSCO & CVX & DIS &
... & MMM & MRK & MSFT & NKE & PG & TRV & UNH & V & VZ & WMT \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1962-01-02 & NaN & NaN & NaN & NaN & 0.1909 & 0.4767 & NaN & NaN &
0.3358 & 0.0582 & ... & 212800 & 633830 & NaN & NaN & 192000 & NaN & NaN
& NaN & NaN & NaN \\
1962-01-03 & NaN & NaN & NaN & NaN & 0.1947 & 0.4813 & NaN & NaN &
0.3350 & 0.0590 & ... & 422400 & 6564672 & NaN & NaN & 428800 & NaN &
NaN & NaN & NaN & NaN \\
1962-01-04 & NaN & NaN & NaN & NaN & 0.1928 & 0.4937 & NaN & NaN &
0.3320 & 0.0590 & ... & 212800 & 1199750 & NaN & NaN & 326400 & NaN &
NaN & NaN & NaN & NaN \\
1962-01-05 & NaN & NaN & NaN & NaN & 0.1890 & 0.4983 & NaN & NaN &
0.3236 & 0.0592 & ... & 315200 & 520646 & NaN & NaN & 544000 & NaN & NaN
& NaN & NaN & NaN \\
1962-01-08 & NaN & NaN & NaN & NaN & 0.1895 & 0.5014 & NaN & NaN &
0.3221 & 0.0590 & ... & 334400 & 1380845 & NaN & NaN & 1523200 & NaN &
NaN & NaN & NaN & NaN \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2024-02-26 & 181.1600 & 286.3700 & 174.7300 & 216.9600 & 200.5400 &
325.3800 & 300.3900 & 48.4000 & 154.4500 & 107.6800 & ... & 3272900 &
5158400 & 16193500.0000 & 5831500.0000 & 4531900 & 1119800.0000 &
2308900.0000 & 3856900.0000 & 25108400.0000 & 32154800.0000 \\
2024-02-27 & 182.6300 & 278.4900 & 173.5400 & 217.9800 & 201.4000 &
327.6300 & 299.5000 & 48.3100 & 152.1600 & 109.4200 & ... & 2288300 &
4780200 & 14835800.0000 & 5317400.0000 & 3868200 & 1245800.0000 &
3780600.0000 & 4145200.0000 & 17074100.0000 & 18012700.0000 \\
2024-02-28 & 181.4200 & 277.4600 & 173.1600 & 218.0300 & 207.0000 &
329.5600 & 299.7700 & 48.0600 & 152.3400 & 110.8000 & ... & 2962400 &
5697200 & 13183100.0000 & 4219800.0000 & 3802900 & 965200.0000 &
9558600.0000 & 4358800.0000 & 12437000.0000 & 14803300.0000 \\
2024-02-29 & 180.7500 & 273.8300 & 176.7600 & 219.4200 & 203.7200 &
333.9600 & 308.8200 & 48.3700 & 152.0100 & 111.5800 & ... & 5157700 &
11245800 & 31910700.0000 & 10810900.0000 & 8348100 & 1996600.0000 &
6832100.0000 & 6633700.0000 & 20485200.0000 & 29220100.0000 \\
2024-03-01 & 179.6600 & 280.3300 & 178.2200 & 219.6600 & 200.0000 &
336.7000 & 316.8800 & 48.4000 & 152.8100 & 111.9500 & ... & 3395512 &
4210903 & 17596713.0000 & 6336704.0000 & 4814999 & 920132.0000 &
7120380.0000 & 3955213.0000 & 9855322.0000 & 16384863.0000 \\
\end{longtable}

First, we add daily returns to \texttt{djia}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{], djia[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]])}
\NormalTok{djia[\_] }\OperatorTok{=}\NormalTok{ djia[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].pct\_change()}
\end{Highlighting}
\end{Shaded}

Second, we add monthly volatility of daily returns to each day. The
\texttt{.transform()} methods lets us add monthly volatility to the
original daily data.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Volatility\textquotesingle{}}\NormalTok{], djia[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]])}
\NormalTok{djia[\_] }\OperatorTok{=}\NormalTok{ djia[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{].groupby(pd.Grouper(freq}\OperatorTok{=}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{)).transform(}\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Third, we use \texttt{pd.qcut()} to assign stocks to portfolios based on
volatility. Here is an example of how to use \texttt{pd.qcut()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.arange(}\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pd.qcut(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{np.arange(}\DecValTok{10}\NormalTok{),}
\NormalTok{    q}\OperatorTok{=}\DecValTok{2}\NormalTok{,}
\NormalTok{    labels}\OperatorTok{=}\VariableTok{False}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0, 0, 0, 0, 0, 1, 1, 1, 1, 1], dtype=int64)
\end{verbatim}

We use the \texttt{.apply()} with \texttt{axis=1} to apply
\texttt{pd.qcut} to every row in
\texttt{djia{[}\textquotesingle{}Volatility\textquotesingle{}{]}}
without writing a for loop. We can also pass \texttt{q=5} and
\texttt{labels=False} after we give the \texttt{pd.qcut} function name.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{], djia[}\StringTok{\textquotesingle{}Volatility\textquotesingle{}}\NormalTok{]])}
\NormalTok{djia[\_] }\OperatorTok{=}\NormalTok{ djia[}\StringTok{\textquotesingle{}Volatility\textquotesingle{}}\NormalTok{].iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(pd.qcut, q}\OperatorTok{=}\DecValTok{5}\NormalTok{, labels}\OperatorTok{=}\VariableTok{False}\NormalTok{, axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\subsection{Plot the time-series volatilities of these five
portfolios}\label{plot-the-time-series-volatilities-of-these-five-portfolios-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{djia.stack()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
& Variable & Adj Close & Close & High & Low & Open & Volume & Return &
Volatility & Portfolio \\
Date & Ticker & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{5}{=}{1962-01-02} & BA & 0.1909 & 0.8230 & 0.8374 & 0.8230 &
0.8374 & 352350.0000 & NaN & 0.0156 & 3.0000 \\
& CAT & 0.4767 & 1.6042 & 1.6198 & 1.5885 & 1.6042 & 163200.0000 & NaN &
0.0121 & 1.0000 \\
& CVX & 0.3358 & 3.2961 & 3.2961 & 3.2440 & 0.0000 & 105840.0000 & NaN &
0.0108 & 0.0000 \\
& DIS & 0.0582 & 0.0929 & 0.0960 & 0.0929 & 0.0929 & 841958.0000 & NaN &
0.0170 & 3.0000 \\
& HON & 1.0740 & 8.3100 & 8.3287 & 8.2726 & 0.0000 & 40740.0000 & NaN &
0.0097 & 0.0000 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
\multirow{5}{=}{2024-03-01} & TRV & 218.8200 & 218.8200 & 221.0900 &
218.3900 & 220.7600 & 920132.0000 & NaN & NaN & NaN \\
& UNH & 489.5300 & 489.5300 & 490.0200 & 477.2500 & 489.4200 &
7120380.0000 & NaN & NaN & NaN \\
& V & 283.1600 & 283.1600 & 284.9100 & 282.1200 & 283.2000 &
3955213.0000 & NaN & NaN & NaN \\
& VZ & 40.2000 & 40.2000 & 40.2900 & 39.7700 & 39.9900 & 9855322.0000 &
NaN & NaN & NaN \\
& WMT & 58.7600 & 58.7600 & 58.8500 & 58.2000 & 58.8000 & 16384863.0000
& NaN & NaN & NaN \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    djia}
\NormalTok{    .stack()}
\NormalTok{    .groupby([}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{])}
\NormalTok{    [}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{    .mean()}
\NormalTok{    .reset\_index()}
\NormalTok{    .dropna()}
\NormalTok{    .assign(Portfolio}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{].astype(}\BuiltInTok{int}\NormalTok{))}
\NormalTok{    .groupby([pd.Grouper(key}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, freq}\OperatorTok{=}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{), }\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{])}
\NormalTok{    .std()}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Volatility\textquotesingle{}}\NormalTok{\})}
\NormalTok{    .unstack()}
\NormalTok{    [}\StringTok{\textquotesingle{}Volatility\textquotesingle{}}\NormalTok{]}
\NormalTok{    .plot()}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Volatility of Daily Returns\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Volatility of Daily Returns}\CharTok{\textbackslash{}n}\StringTok{ for Five Portfolios Formed Monthly on Volatility\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_10_practice_03_files/figure-pdf/cell-38-output-1.png}

\subsection{\texorpdfstring{Calculate the \emph{mean} monthly
correlation between the Dow Jones
stocks}{Calculate the mean monthly correlation between the Dow Jones stocks}}\label{calculate-the-mean-monthly-correlation-between-the-dow-jones-stocks-1}

\emph{I may build Project 2 on this exercise, so I will leave it blank,
for now.}

\subsection{Is market volatility higher during
wars?}\label{is-market-volatility-higher-during-wars-1}

Here is some guidance:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Download the daily factor data from Ken French's website
\item
  Calculate daily market returns by summing the market risk premium and
  risk-free rates (\texttt{Mkt-RF} and \texttt{RF}, respectively)
\item
  Calculate the volatility (standard deviation) of daily returns
  \emph{every month} by combining \texttt{pd.Grouper()} and
  \texttt{.groupby()})
\item
  Multiply by \(\sqrt{252}\) to annualize these volatilities of daily
  returns
\item
  Plot these annualized volatilities
\end{enumerate}

Is market volatility higher during wars? Consider the following dates:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  WWII: December 1941 to September 1945
\item
  Korean War: 1950 to 1953
\item
  Viet Nam War: 1959 to 1975
\item
  Gulf War: 1990 to 1991
\item
  War in Afghanistan: 2001 to 2021
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pdr.famafrench.get\_available\_datasets()[:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['F-F_Research_Data_Factors',
 'F-F_Research_Data_Factors_weekly',
 'F-F_Research_Data_Factors_daily',
 'F-F_Research_Data_5_Factors_2x3',
 'F-F_Research_Data_5_Factors_2x3_daily']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_all }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27768\2526882917.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_all = pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    ff\_all[}\DecValTok{0}\NormalTok{]}
\NormalTok{    .assign(Mkt }\OperatorTok{=} \KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ x[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{])}
\NormalTok{    [}\StringTok{\textquotesingle{}Mkt\textquotesingle{}}\NormalTok{]}
\NormalTok{    .groupby(pd.Grouper(freq}\OperatorTok{=}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{))}
\NormalTok{    .std()}
\NormalTok{    .mul(np.sqrt(}\DecValTok{252}\NormalTok{))}
\NormalTok{    .plot()}
\NormalTok{)}

\CommentTok{\# adds vertical bands for U.S. wars}
\NormalTok{plt.axvspan(}\StringTok{\textquotesingle{}1941{-}12\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}1945{-}09\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.25}\NormalTok{)}
\NormalTok{plt.annotate(}\StringTok{\textquotesingle{}WWII\textquotesingle{}}\NormalTok{, (}\StringTok{\textquotesingle{}1941{-}12\textquotesingle{}}\NormalTok{, }\DecValTok{90}\NormalTok{))}
\NormalTok{plt.axvspan(}\StringTok{\textquotesingle{}1950\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}1953\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.25}\NormalTok{)}
\NormalTok{plt.annotate(}\StringTok{\textquotesingle{}Korean\textquotesingle{}}\NormalTok{, (}\StringTok{\textquotesingle{}1950\textquotesingle{}}\NormalTok{, }\DecValTok{80}\NormalTok{))}
\NormalTok{plt.axvspan(}\StringTok{\textquotesingle{}1959\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}1975\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.25}\NormalTok{)}
\NormalTok{plt.annotate(}\StringTok{\textquotesingle{}Vietnam\textquotesingle{}}\NormalTok{, (}\StringTok{\textquotesingle{}1959\textquotesingle{}}\NormalTok{, }\DecValTok{90}\NormalTok{))}
\NormalTok{plt.axvspan(}\StringTok{\textquotesingle{}1990\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}1991\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.25}\NormalTok{)}
\NormalTok{plt.annotate(}\StringTok{\textquotesingle{}Gulf I\textquotesingle{}}\NormalTok{, (}\StringTok{\textquotesingle{}1990\textquotesingle{}}\NormalTok{, }\DecValTok{80}\NormalTok{))}
\NormalTok{plt.axvspan(}\StringTok{\textquotesingle{}2001\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.25}\NormalTok{)}
\NormalTok{plt.annotate(}\StringTok{\textquotesingle{}Afghanistan\textquotesingle{}}\NormalTok{, (}\StringTok{\textquotesingle{}2001\textquotesingle{}}\NormalTok{, }\DecValTok{90}\NormalTok{))}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Volatility of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Annualized Volatility of U.S. Market}\CharTok{\textbackslash{}n}\StringTok{ Vertical Blue Bands Indicate Wars\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_10_practice_03_files/figure-pdf/cell-41-output-1.png}

\chapter{McKinney Chapter 10 - Practice for Section
04}\label{mckinney-chapter-10---practice-for-section-04}

\section{Announcements}\label{announcements-26}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  I will grade your projects over spring break
\item
  Please complete your peer reviews on Teammates by midnight on Tuesday,
  2/27
\item
  I will record the week 9 lecture video on Thursday
\item
  Enjoy your spring breaks!
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-25}

We will focus on 3 topics from chapter 10 of McKinney:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \emph{GroupBy Mechanics:} We will use the \texttt{.groupby()} method
  to perform ``split-apply-combine'' calculations in pandas, which let
  us aggregate data by one of more columns or indexes.
\item
  \emph{Data Aggregation:} We will combine optimized methods, like
  \texttt{.count()}, \texttt{.sum()}, \texttt{.mean()}, etc., with
  \texttt{.groupby()} to quickly aggregate data. We will combine the
  \texttt{.agg()} or \texttt{.aggregate()} method with
  \texttt{.groupby()} when we want to apply more than one aggregation
  function.
\item
  \emph{Pivot Tables:} We can use the \texttt{.pivot\_table()} method to
  aggregate data with a syntax similar to Excel's pivot tables. We can
  almost always get the same output with the \texttt{.groupby()},
  \texttt{.agg()}, and \texttt{.unstack()} methods.
\end{enumerate}

\section{Practice}\label{practice-26}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{\texorpdfstring{Replicate the following
\texttt{.pivot\_table()} output with
\texttt{.groupby()}}{Replicate the following .pivot\_table() output with .groupby()}}\label{replicate-the-following-.pivot_table-output-with-.groupby-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ind }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}\^{}GSPC \^{}DJI \^{}IXIC \^{}FTSE \^{}N225 \^{}HSI\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Index\textquotesingle{}}\NormalTok{])}
\NormalTok{    .stack()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  6 of 6 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(}
\NormalTok{    ind[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{],}
\NormalTok{    ind[}\StringTok{\textquotesingle{}Close\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ind}
\NormalTok{    .loc[}\StringTok{\textquotesingle{}2015\textquotesingle{}}\NormalTok{:]}
\NormalTok{    .reset\_index()}
\NormalTok{    .pivot\_table(}
\NormalTok{        values}\OperatorTok{=}\StringTok{\textquotesingle{}Close\textquotesingle{}}\NormalTok{,}
\NormalTok{        index}\OperatorTok{=}\NormalTok{pd.Grouper(key}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, freq}\OperatorTok{=}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{),}
\NormalTok{        columns}\OperatorTok{=}\StringTok{\textquotesingle{}Index\textquotesingle{}}\NormalTok{,}
\NormalTok{        aggfunc}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}min\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}max\textquotesingle{}}\NormalTok{]}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllll@{}}
\toprule\noalign{}
& \multicolumn{6}{l}{%
min} & \multicolumn{6}{l@{}}{%
max} \\
Index & \^{}DJI & \^{}FTSE & \^{}GSPC & \^{}HSI & \^{}IXIC & \^{}N225 &
\^{}DJI & \^{}FTSE & \^{}GSPC & \^{}HSI & \^{}IXIC & \^{}N225 \\
Date & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2015-12-31 & 15666.4404 & 5874.1001 & 1867.6100 & 20556.5996 & 4506.4902
& 16795.9609 & 18312.3906 & 7104.0000 & 2130.8201 & 28442.7500 &
5218.8599 & 20868.0293 \\
2016-12-31 & 15660.1797 & 5537.0000 & 1829.0800 & 18319.5801 & 4266.8398
& 14952.0195 & 19974.6191 & 7142.7998 & 2271.7200 & 24099.6992 &
5487.4399 & 19494.5293 \\
2017-12-31 & 19732.4004 & 7099.2002 & 2257.8301 & 22134.4707 & 5429.0801
& 18335.6309 & 24837.5098 & 7687.7998 & 2690.1599 & 30003.4902 &
6994.7598 & 22939.1797 \\
2018-12-31 & 21792.1992 & 6584.7002 & 2351.1001 & 24585.5293 & 6192.9199
& 19155.7402 & 26828.3906 & 7877.5000 & 2930.7500 & 33154.1211 &
8109.6899 & 24270.6191 \\
2019-12-31 & 22686.2207 & 6692.7002 & 2447.8899 & 25064.3594 & 6463.5000
& 19561.9609 & 28645.2598 & 7686.6001 & 3240.0200 & 30157.4902 &
9022.3896 & 24066.1191 \\
2020-12-31 & 18591.9297 & 4993.8999 & 2237.3999 & 21696.1309 & 6860.6699
& 16552.8301 & 30606.4805 & 7674.6001 & 3756.0701 & 29056.4199 &
12899.4199 & 27568.1504 \\
2021-12-31 & 29982.6191 & 6407.5000 & 3700.6499 & 22744.8594 &
12609.1602 & 27013.2500 & 36488.6289 & 7420.7002 & 4793.0601 &
31084.9395 & 16057.4404 & 30670.0996 \\
2022-12-31 & 28725.5098 & 6826.2002 & 3577.0300 & 14687.0195 &
10213.2900 & 24717.5293 & 36799.6484 & 7672.3999 & 4796.5601 &
24965.5508 & 15832.7998 & 29332.1602 \\
2023-12-31 & 31819.1406 & 7256.8999 & 3808.1001 & 16201.4902 &
10305.2402 & 25716.8594 & 37710.1016 & 8014.2998 & 4783.3501 &
22688.9004 & 15099.1797 & 33753.3281 \\
2024-12-31 & 37266.6719 & 7446.2998 & 4688.6802 & 14961.1797 &
14510.2998 & 33288.2891 & 39131.5312 & 7728.5000 & 5137.0801 &
16790.8008 & 16274.9414 & 39910.8203 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ind}
\NormalTok{    .loc[}\StringTok{\textquotesingle{}2015\textquotesingle{}}\NormalTok{:]}
\NormalTok{    .reset\_index()}
\NormalTok{    .groupby([pd.Grouper(key}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, freq}\OperatorTok{=}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{), }\StringTok{\textquotesingle{}Index\textquotesingle{}}\NormalTok{])}
\NormalTok{    [}\StringTok{\textquotesingle{}Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .agg([}\StringTok{\textquotesingle{}min\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}max\textquotesingle{}}\NormalTok{])}
\NormalTok{    .unstack()}
\NormalTok{)}

\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllll@{}}
\toprule\noalign{}
& \multicolumn{6}{l}{%
min} & \multicolumn{6}{l@{}}{%
max} \\
Index & \^{}DJI & \^{}FTSE & \^{}GSPC & \^{}HSI & \^{}IXIC & \^{}N225 &
\^{}DJI & \^{}FTSE & \^{}GSPC & \^{}HSI & \^{}IXIC & \^{}N225 \\
Date & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2015-12-31 & 15666.4404 & 5874.1001 & 1867.6100 & 20556.5996 & 4506.4902
& 16795.9609 & 18312.3906 & 7104.0000 & 2130.8201 & 28442.7500 &
5218.8599 & 20868.0293 \\
2016-12-31 & 15660.1797 & 5537.0000 & 1829.0800 & 18319.5801 & 4266.8398
& 14952.0195 & 19974.6191 & 7142.7998 & 2271.7200 & 24099.6992 &
5487.4399 & 19494.5293 \\
2017-12-31 & 19732.4004 & 7099.2002 & 2257.8301 & 22134.4707 & 5429.0801
& 18335.6309 & 24837.5098 & 7687.7998 & 2690.1599 & 30003.4902 &
6994.7598 & 22939.1797 \\
2018-12-31 & 21792.1992 & 6584.7002 & 2351.1001 & 24585.5293 & 6192.9199
& 19155.7402 & 26828.3906 & 7877.5000 & 2930.7500 & 33154.1211 &
8109.6899 & 24270.6191 \\
2019-12-31 & 22686.2207 & 6692.7002 & 2447.8899 & 25064.3594 & 6463.5000
& 19561.9609 & 28645.2598 & 7686.6001 & 3240.0200 & 30157.4902 &
9022.3896 & 24066.1191 \\
2020-12-31 & 18591.9297 & 4993.8999 & 2237.3999 & 21696.1309 & 6860.6699
& 16552.8301 & 30606.4805 & 7674.6001 & 3756.0701 & 29056.4199 &
12899.4199 & 27568.1504 \\
2021-12-31 & 29982.6191 & 6407.5000 & 3700.6499 & 22744.8594 &
12609.1602 & 27013.2500 & 36488.6289 & 7420.7002 & 4793.0601 &
31084.9395 & 16057.4404 & 30670.0996 \\
2022-12-31 & 28725.5098 & 6826.2002 & 3577.0300 & 14687.0195 &
10213.2900 & 24717.5293 & 36799.6484 & 7672.3999 & 4796.5601 &
24965.5508 & 15832.7998 & 29332.1602 \\
2023-12-31 & 31819.1406 & 7256.8999 & 3808.1001 & 16201.4902 &
10305.2402 & 25716.8594 & 37710.1016 & 8014.2998 & 4783.3501 &
22688.9004 & 15099.1797 & 33753.3281 \\
2024-12-31 & 37266.6719 & 7446.2998 & 4688.6802 & 14961.1797 &
14510.2998 & 33288.2891 & 39131.5312 & 7728.5000 & 5137.0801 &
16790.8008 & 16274.9414 & 39910.8203 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(a, b)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\subsection{Calulate the mean and standard deviation of returns by
ticker for the MATANA (MSFT, AAPL, TSLA, AMZN, NVDA, and GOOG)
stocks}\label{calulate-the-mean-and-standard-deviation-of-returns-by-ticker-for-the-matana-msft-aapl-tsla-amzn-nvda-and-goog-stocks-2}

Consider only dates with complete returns data. Try this calculation
with wide and long data frames, and confirm your results are the same.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{matana }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}MSFT AAPL TSLA AMZN NVDA GOOG\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  6 of 6 completed
\end{verbatim}

We can add the returns columns first, using the \texttt{pd.MultiIndex}
trick from a few weeks ago.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{], matana[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].columns])}
\NormalTok{matana[\_] }\OperatorTok{=}\NormalTok{ matana[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].pct\_change()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    matana[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{    .dropna()}
\NormalTok{    .describe()}
\NormalTok{    .loc[[}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{]]}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
Ticker & AAPL & AMZN & GOOG & MSFT & NVDA & TSLA \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
mean & 0.0011 & 0.0012 & 0.0009 & 0.0010 & 0.0021 & 0.0020 \\
std & 0.0176 & 0.0207 & 0.0172 & 0.0163 & 0.0283 & 0.0358 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    matana[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{    .dropna()}
\NormalTok{    .agg([}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{])}
\NormalTok{)}

\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
Ticker & AAPL & AMZN & GOOG & MSFT & NVDA & TSLA \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
mean & 0.0011 & 0.0012 & 0.0009 & 0.0010 & 0.0021 & 0.0020 \\
std & 0.0176 & 0.0207 & 0.0172 & 0.0163 & 0.0283 & 0.0358 \\
\end{longtable}

Here is the \texttt{.pivot\_table()} solution!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    matana}
\NormalTok{    .dropna()}
\NormalTok{    .stack()}
\NormalTok{    .pivot\_table(}
\NormalTok{        values}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{,}
\NormalTok{        index}\OperatorTok{=}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{,}
\NormalTok{        aggfunc}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{]}
\NormalTok{    )}
\NormalTok{    .transpose()}
\NormalTok{)}

\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllll@{}}
\toprule\noalign{}
& Ticker & AAPL & AMZN & GOOG & MSFT & NVDA & TSLA \\
& Variable & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
mean & Return & 0.0011 & 0.0012 & 0.0009 & 0.0010 & 0.0021 & 0.0020 \\
std & Return & 0.0176 & 0.0207 & 0.0172 & 0.0163 & 0.0283 & 0.0358 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(a, b)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

What if we want to add skewness and kurtosis? There a skewness method
built-in, but we have to write a lambda function for kurtosis.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    matana}
\NormalTok{    .dropna()}
\NormalTok{    .stack()}
\NormalTok{    .pivot\_table(}
\NormalTok{        values}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{,}
\NormalTok{        index}\OperatorTok{=}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{,}
\NormalTok{        aggfunc}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}skew\textquotesingle{}}\NormalTok{, }\KeywordTok{lambda}\NormalTok{ x: x.kurt()]}
\NormalTok{    )}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}\textless{}lambda\textgreater{}\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}kurt\textquotesingle{}}\NormalTok{\})}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& mean & std & skew & kurt \\
Variable & Return & Return & Return & Return \\
Ticker & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
AAPL & 0.0011 & 0.0176 & -0.0679 & 5.3890 \\
AMZN & 0.0012 & 0.0207 & 0.3098 & 6.5446 \\
GOOG & 0.0009 & 0.0172 & 0.4022 & 8.5696 \\
MSFT & 0.0010 & 0.0163 & 0.0564 & 7.8516 \\
NVDA & 0.0021 & 0.0283 & 0.7116 & 9.1072 \\
TSLA & 0.0020 & 0.0358 & 0.3091 & 4.9438 \\
\end{longtable}

Here is the \texttt{.groupby()} solution!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{c }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    matana}
\NormalTok{    .dropna()}
\NormalTok{    .stack()}
\NormalTok{    .groupby(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{    [}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{    .agg([}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{])}
\NormalTok{    .transpose()}
\NormalTok{)}

\NormalTok{c}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
Ticker & AAPL & AMZN & GOOG & MSFT & NVDA & TSLA \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
mean & 0.0011 & 0.0012 & 0.0009 & 0.0010 & 0.0021 & 0.0020 \\
std & 0.0176 & 0.0207 & 0.0172 & 0.0163 & 0.0283 & 0.0358 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(a, c)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\subsection{Calculate the mean and standard deviation of returns and the
maximum of closing prices by ticker for the MATANA
stocks}\label{calculate-the-mean-and-standard-deviation-of-returns-and-the-maximum-of-closing-prices-by-ticker-for-the-matana-stocks-2}

Again, consider only dates with complete returns data. Try this
calculation with wide and long data frames, and confirm your results are
the same.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    matana}
\NormalTok{    .dropna()}
\NormalTok{    .stack()}
\NormalTok{    .pivot\_table(}
\NormalTok{        index}\OperatorTok{=}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{,}
\NormalTok{        aggfunc}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{], }\StringTok{\textquotesingle{}Close\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}max\textquotesingle{}}\NormalTok{\}}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
Variable & Close & \multicolumn{2}{l@{}}{%
Return} \\
& max & mean & std \\
Ticker & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
AAPL & 198.1100 & 0.0011 & 0.0176 \\
AMZN & 186.5705 & 0.0012 & 0.0207 \\
GOOG & 154.8400 & 0.0009 & 0.0172 \\
MSFT & 420.5500 & 0.0010 & 0.0163 \\
NVDA & 791.1200 & 0.0021 & 0.0283 \\
TSLA & 409.9700 & 0.0020 & 0.0358 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    matana}
\NormalTok{    .dropna()}
\NormalTok{    .stack()}
\NormalTok{    .groupby(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{    .agg(\{}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{], }\StringTok{\textquotesingle{}Close\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}max\textquotesingle{}}\NormalTok{\})}
\NormalTok{)}

\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
Variable & \multicolumn{2}{l}{%
Return} & Close \\
& mean & std & max \\
Ticker & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
AAPL & 0.0011 & 0.0176 & 198.1100 \\
AMZN & 0.0012 & 0.0207 & 186.5705 \\
GOOG & 0.0009 & 0.0172 & 154.8400 \\
MSFT & 0.0010 & 0.0163 & 420.5500 \\
NVDA & 0.0021 & 0.0283 & 791.1200 \\
TSLA & 0.0020 & 0.0358 & 409.9700 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(a, b)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
False
\end{verbatim}

The \texttt{.pivot\_table()} method sorts it columns, but
\texttt{groupby()} method does not! We need to sort columns with
\texttt{.sort\_index(axis=1)} to make sure our output is the same!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(}
\NormalTok{    a.sort\_index(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{),}
\NormalTok{    b.sort\_index(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

We can use the following code to display all index levels for all rows
and columns.

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{with}\NormalTok{ pd.option\_context(}\StringTok{\textquotesingle{}display.multi\_sparse\textquotesingle{}}\NormalTok{, }\VariableTok{False}\NormalTok{):}
\NormalTok{    display(b)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
Variable & Return & Return & Close \\
& mean & std & max \\
Ticker & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
AAPL & 0.0011 & 0.0176 & 198.1100 \\
AMZN & 0.0012 & 0.0207 & 186.5705 \\
GOOG & 0.0009 & 0.0172 & 154.8400 \\
MSFT & 0.0010 & 0.0163 & 420.5500 \\
NVDA & 0.0021 & 0.0283 & 791.1200 \\
TSLA & 0.0020 & 0.0358 & 409.9700 \\
\end{longtable}

If we prefer to see all index levels all the time, we can set the
following setting at the top of our notebook:

\begin{verbatim}
pd.options.display.multi_sparse = False
\end{verbatim}

We can also copy our output to our clipboaerd then paste it into Excel
if we want to convince ourelves of the column multi index arrangement.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b.to\_clipboard()}
\end{Highlighting}
\end{Shaded}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\subsection{Calculate monthly means and volatilities for SPY and GOOG
returns}\label{calculate-monthly-means-and-volatilities-for-spy-and-goog-returns-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{spy\_goog }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}SPY GOOG\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
\NormalTok{)}

\NormalTok{spy\_goog}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  2 of 2 completed
\end{verbatim}

\begin{longtable}[]{@{}lllllllllllll@{}}
\toprule\noalign{}
Variable & \multicolumn{2}{l}{%
Adj Close} & \multicolumn{2}{l}{%
Close} & \multicolumn{2}{l}{%
High} & \multicolumn{2}{l}{%
Low} & \multicolumn{2}{l}{%
Open} & \multicolumn{2}{l@{}}{%
Volume} \\
Ticker & GOOG & SPY & GOOG & SPY & GOOG & SPY & GOOG & SPY & GOOG & SPY
& GOOG & SPY \\
Date & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1993-01-29 & NaN & 24.8407 & NaN & 43.9375 & NaN & 43.9688 & NaN &
43.7500 & NaN & 43.9688 & NaN & 1003200 \\
1993-02-01 & NaN & 25.0174 & NaN & 44.2500 & NaN & 44.2500 & NaN &
43.9688 & NaN & 43.9688 & NaN & 480500 \\
1993-02-02 & NaN & 25.0704 & NaN & 44.3438 & NaN & 44.3750 & NaN &
44.1250 & NaN & 44.2188 & NaN & 201300 \\
1993-02-03 & NaN & 25.3354 & NaN & 44.8125 & NaN & 44.8438 & NaN &
44.3750 & NaN & 44.4062 & NaN & 529400 \\
1993-02-04 & NaN & 25.4414 & NaN & 45.0000 & NaN & 45.0938 & NaN &
44.4688 & NaN & 44.9688 & NaN & 531500 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... \\
2024-02-26 & 138.7500 & 505.9900 & 138.7500 & 505.9900 & 143.8400 &
508.7500 & 138.7400 & 505.8600 & 143.4500 & 508.3000 & 33513000.0000 &
50386700 \\
2024-02-27 & 140.1000 & 506.9300 & 140.1000 & 506.9300 & 140.4900 &
507.1600 & 138.5000 & 504.7500 & 139.4100 & 506.7000 & 22364000.0000 &
48854500 \\
2024-02-28 & 137.4300 & 506.2600 & 137.4300 & 506.2600 & 139.2800 &
506.8600 & 136.6400 & 504.9600 & 139.1000 & 505.3300 & 30628700.0000 &
56506600 \\
2024-02-29 & 139.7800 & 508.0800 & 139.7800 & 508.0800 & 139.9500 &
509.7400 & 137.5700 & 505.3500 & 138.3500 & 508.0700 & 35485000.0000 &
83824300 \\
2024-03-01 & 138.0800 & 512.8500 & 138.0800 & 512.8500 & 140.0000 &
513.2900 & 137.9750 & 508.5600 & 139.5000 & 508.9800 & 28445474.0000 &
76610613 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{spy\_goog\_m }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    spy\_goog[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{] }\CommentTok{\# select adj close columns}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\CommentTok{\# drop last row, with possible missing intraday prices}
\NormalTok{    .pct\_change()}
\NormalTok{    .stack()}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{)}
\NormalTok{    .reset\_index()}
\NormalTok{    .groupby([pd.Grouper(key}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, freq}\OperatorTok{=}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{), }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
\NormalTok{    .agg([}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{])}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Statistic\textquotesingle{}}\NormalTok{])}
\NormalTok{)}

\NormalTok{spy\_goog\_m}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& Variable & \multicolumn{2}{l@{}}{%
Return} \\
& Statistic & mean & std \\
Date & Ticker & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1993-02-28 & SPY & 0.0006 & 0.0080 \\
1993-03-31 & SPY & 0.0010 & 0.0071 \\
1993-04-30 & SPY & -0.0012 & 0.0074 \\
1993-05-31 & SPY & 0.0014 & 0.0071 \\
1993-06-30 & SPY & 0.0002 & 0.0060 \\
... & ... & ... & ... \\
2023-12-31 & SPY & 0.0023 & 0.0060 \\
\multirow{2}{=}{2024-01-31} & GOOG & 0.0005 & 0.0202 \\
& SPY & 0.0008 & 0.0070 \\
\multirow{2}{=}{2024-02-29} & GOOG & -0.0006 & 0.0159 \\
& SPY & 0.0026 & 0.0076 \\
\end{longtable}

\subsection{Plot the monthly means and volatilities from the previous
exercise}\label{plot-the-monthly-means-and-volatilities-from-the-previous-exercise-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{spy\_goog\_m.plot()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_10_practice_04_files/figure-pdf/cell-26-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{spy\_goog\_m.unstack().plot()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_10_practice_04_files/figure-pdf/cell-27-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{spy\_goog\_m.unstack().plot(subplots}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([<Axes: xlabel='Date'>, <Axes: xlabel='Date'>,
       <Axes: xlabel='Date'>, <Axes: xlabel='Date'>], dtype=object)
\end{verbatim}

\includegraphics{mckinney_10_practice_04_files/figure-pdf/cell-28-output-2.png}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ seaborn }\ImportTok{as}\NormalTok{ sns}
\end{Highlighting}
\end{Shaded}

The \texttt{seaborn} makes excellent multi-panel plots, including plots
with statistics. \textbf{\emph{But, it requires very long data frames.}}
A \emph{very} long data frame has all of the y values in one column and
all other useful dimensions as columns instead of indexes!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.relplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{spy\_goog\_m.stack().reset\_index(),}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{,}
\NormalTok{    col}\OperatorTok{=}\StringTok{\textquotesingle{}Statistic\textquotesingle{}}\NormalTok{,}
\NormalTok{    hue}\OperatorTok{=}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{,}
\NormalTok{    height}\OperatorTok{=}\DecValTok{3}\NormalTok{,}
\NormalTok{    kind}\OperatorTok{=}\StringTok{\textquotesingle{}line\textquotesingle{}}\NormalTok{,}
\NormalTok{    alpha}\OperatorTok{=}\FloatTok{0.75}
\NormalTok{)}

\NormalTok{plt.gcf().autofmt\_xdate()}
\NormalTok{plt.suptitle(}\StringTok{\textquotesingle{}Monthly Mean and Volatility of Daily Returns\textquotesingle{}}\NormalTok{, y}\OperatorTok{=}\FloatTok{1.05}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_10_practice_04_files/figure-pdf/cell-30-output-1.png}

\subsection{Assign the Dow Jones stocks to five portfolios based on
their monthly
volatility}\label{assign-the-dow-jones-stocks-to-five-portfolios-based-on-their-monthly-volatility-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{wiki }\OperatorTok{=}\NormalTok{ pd.read\_html(}\StringTok{\textquotesingle{}https://en.wikipedia.org/wiki/Dow\_Jones\_Industrial\_Average\textquotesingle{}}\NormalTok{)}
\NormalTok{wiki[}\DecValTok{1}\NormalTok{][}\StringTok{\textquotesingle{}Symbol\textquotesingle{}}\NormalTok{].to\_list()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['MMM',
 'AXP',
 'AMGN',
 'AMZN',
 'AAPL',
 'BA',
 'CAT',
 'CVX',
 'CSCO',
 'KO',
 'DIS',
 'DOW',
 'GS',
 'HD',
 'HON',
 'IBM',
 'INTC',
 'JNJ',
 'JPM',
 'MCD',
 'MRK',
 'MSFT',
 'NKE',
 'PG',
 'CRM',
 'TRV',
 'UNH',
 'VZ',
 'V',
 'WMT']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{djia }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\NormalTok{wiki[}\DecValTok{1}\NormalTok{][}\StringTok{\textquotesingle{}Symbol\textquotesingle{}}\NormalTok{].to\_list())}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
\NormalTok{)}

\NormalTok{djia}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  30 of 30 completed
\end{verbatim}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
Variable & \multicolumn{10}{l}{%
Adj Close} & ... & \multicolumn{10}{l@{}}{%
Volume} \\
Ticker & AAPL & AMGN & AMZN & AXP & BA & CAT & CRM & CSCO & CVX & DIS &
... & MMM & MRK & MSFT & NKE & PG & TRV & UNH & V & VZ & WMT \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1962-01-02 & NaN & NaN & NaN & NaN & 0.1909 & 0.4767 & NaN & NaN &
0.3358 & 0.0582 & ... & 212800 & 633830 & NaN & NaN & 192000 & NaN & NaN
& NaN & NaN & NaN \\
1962-01-03 & NaN & NaN & NaN & NaN & 0.1947 & 0.4813 & NaN & NaN &
0.3350 & 0.0590 & ... & 422400 & 6564672 & NaN & NaN & 428800 & NaN &
NaN & NaN & NaN & NaN \\
1962-01-04 & NaN & NaN & NaN & NaN & 0.1928 & 0.4937 & NaN & NaN &
0.3320 & 0.0590 & ... & 212800 & 1199750 & NaN & NaN & 326400 & NaN &
NaN & NaN & NaN & NaN \\
1962-01-05 & NaN & NaN & NaN & NaN & 0.1890 & 0.4983 & NaN & NaN &
0.3236 & 0.0592 & ... & 315200 & 520646 & NaN & NaN & 544000 & NaN & NaN
& NaN & NaN & NaN \\
1962-01-08 & NaN & NaN & NaN & NaN & 0.1895 & 0.5014 & NaN & NaN &
0.3221 & 0.0590 & ... & 334400 & 1380845 & NaN & NaN & 1523200 & NaN &
NaN & NaN & NaN & NaN \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2024-02-26 & 181.1600 & 286.3700 & 174.7300 & 216.9600 & 200.5400 &
325.3800 & 300.3900 & 48.4000 & 154.4500 & 107.6800 & ... & 3272900 &
5158400 & 16193500.0000 & 5831500.0000 & 4531900 & 1119800.0000 &
2308900.0000 & 3856900.0000 & 25108400.0000 & 32154800.0000 \\
2024-02-27 & 182.6300 & 278.4900 & 173.5400 & 217.9800 & 201.4000 &
327.6300 & 299.5000 & 48.3100 & 152.1600 & 109.4200 & ... & 2288300 &
4780200 & 14835800.0000 & 5317400.0000 & 3868200 & 1245800.0000 &
3780600.0000 & 4145200.0000 & 17074100.0000 & 18012700.0000 \\
2024-02-28 & 181.4200 & 277.4600 & 173.1600 & 218.0300 & 207.0000 &
329.5600 & 299.7700 & 48.0600 & 152.3400 & 110.8000 & ... & 2962400 &
5697200 & 13183100.0000 & 4219800.0000 & 3802900 & 965200.0000 &
9558600.0000 & 4358800.0000 & 12437000.0000 & 14803300.0000 \\
2024-02-29 & 180.7500 & 273.8300 & 176.7600 & 219.4200 & 203.7200 &
333.9600 & 308.8200 & 48.3700 & 152.0100 & 111.5800 & ... & 5157700 &
11245800 & 31910700.0000 & 10810900.0000 & 8348100 & 1996600.0000 &
6832100.0000 & 6633700.0000 & 20485200.0000 & 29220100.0000 \\
2024-03-01 & 179.6600 & 280.3300 & 178.2200 & 219.6600 & 200.0000 &
336.7000 & 316.8800 & 48.4000 & 152.8100 & 111.9500 & ... & 3395512 &
4210903 & 17596713.0000 & 6336704.0000 & 4816258 & 1110924.0000 &
7120380.0000 & 3955213.0000 & 9855322.0000 & 16384863.0000 \\
\end{longtable}

First, we add daily returns to \texttt{djia}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{], djia[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]])}
\NormalTok{djia[\_] }\OperatorTok{=}\NormalTok{ djia[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].pct\_change()}
\end{Highlighting}
\end{Shaded}

Second, we add monthly volatility of daily returns to each day. The
\texttt{.transform()} methods lets us add monthly volatility to the
original daily data.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Volatility\textquotesingle{}}\NormalTok{], djia[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]])}
\NormalTok{djia[\_] }\OperatorTok{=}\NormalTok{ djia[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{].groupby(pd.Grouper(freq}\OperatorTok{=}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{)).transform(}\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Third, we use \texttt{pd.qcut()} to assign stocks to portfolios based on
volatility. Here is an example of how to use \texttt{pd.qcut()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.arange(}\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pd.qcut(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{np.arange(}\DecValTok{10}\NormalTok{),}
\NormalTok{    q}\OperatorTok{=}\DecValTok{2}\NormalTok{,}
\NormalTok{    labels}\OperatorTok{=}\VariableTok{False}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0, 0, 0, 0, 0, 1, 1, 1, 1, 1], dtype=int64)
\end{verbatim}

We use the \texttt{.apply()} with \texttt{axis=1} to apply
\texttt{pd.qcut} to every row in
\texttt{djia{[}\textquotesingle{}Volatility\textquotesingle{}{]}}
without writing a for loop. We can also pass \texttt{q=5} and
\texttt{labels=False} after we give the \texttt{pd.qcut} function name.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{], djia[}\StringTok{\textquotesingle{}Volatility\textquotesingle{}}\NormalTok{]])}
\NormalTok{djia[\_] }\OperatorTok{=}\NormalTok{ djia[}\StringTok{\textquotesingle{}Volatility\textquotesingle{}}\NormalTok{].iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(pd.qcut, q}\OperatorTok{=}\DecValTok{5}\NormalTok{, labels}\OperatorTok{=}\VariableTok{False}\NormalTok{, axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\subsection{Plot the time-series volatilities of these five
portfolios}\label{plot-the-time-series-volatilities-of-these-five-portfolios-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{djia.stack()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
& Variable & Adj Close & Close & High & Low & Open & Volume & Return &
Volatility & Portfolio \\
Date & Ticker & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{5}{=}{1962-01-02} & BA & 0.1909 & 0.8230 & 0.8374 & 0.8230 &
0.8374 & 352350.0000 & NaN & 0.0156 & 3.0000 \\
& CAT & 0.4767 & 1.6042 & 1.6198 & 1.5885 & 1.6042 & 163200.0000 & NaN &
0.0121 & 1.0000 \\
& CVX & 0.3358 & 3.2961 & 3.2961 & 3.2440 & 0.0000 & 105840.0000 & NaN &
0.0108 & 0.0000 \\
& DIS & 0.0582 & 0.0929 & 0.0960 & 0.0929 & 0.0929 & 841958.0000 & NaN &
0.0170 & 3.0000 \\
& HON & 1.0740 & 8.3100 & 8.3287 & 8.2726 & 0.0000 & 40740.0000 & NaN &
0.0097 & 0.0000 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
\multirow{5}{=}{2024-03-01} & TRV & 218.8200 & 218.8200 & 221.0850 &
218.3900 & 220.7600 & 1110924.0000 & NaN & NaN & NaN \\
& UNH & 489.5300 & 489.5300 & 490.0200 & 477.2500 & 489.4200 &
7120380.0000 & NaN & NaN & NaN \\
& V & 283.1600 & 283.1600 & 284.9100 & 282.1200 & 283.2000 &
3955213.0000 & NaN & NaN & NaN \\
& VZ & 40.2000 & 40.2000 & 40.2900 & 39.7700 & 39.9900 & 9855322.0000 &
NaN & NaN & NaN \\
& WMT & 58.7600 & 58.7600 & 58.8500 & 58.2000 & 58.8000 & 16384863.0000
& NaN & NaN & NaN \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    djia}
\NormalTok{    .stack()}
\NormalTok{    .groupby([}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{])}
\NormalTok{    [}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{    .mean()}
\NormalTok{    .reset\_index()}
\NormalTok{    .dropna()}
\NormalTok{    .assign(Portfolio}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{].astype(}\BuiltInTok{int}\NormalTok{))}
\NormalTok{    .groupby([pd.Grouper(key}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, freq}\OperatorTok{=}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{), }\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{])}
\NormalTok{    .std()}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Volatility\textquotesingle{}}\NormalTok{\})}
\NormalTok{    .unstack()}
\NormalTok{    [}\StringTok{\textquotesingle{}Volatility\textquotesingle{}}\NormalTok{]}
\NormalTok{    .plot()}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Volatility of Daily Returns\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Volatility of Daily Returns}\CharTok{\textbackslash{}n}\StringTok{ for Five Portfolios Formed Monthly on Volatility\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_10_practice_04_files/figure-pdf/cell-39-output-1.png}

\subsection{\texorpdfstring{Calculate the \emph{mean} monthly
correlation between the Dow Jones
stocks}{Calculate the mean monthly correlation between the Dow Jones stocks}}\label{calculate-the-mean-monthly-correlation-between-the-dow-jones-stocks-2}

\emph{I may build Project 2 on this exercise, so I will leave it blank,
for now.}

\subsection{Is market volatility higher during
wars?}\label{is-market-volatility-higher-during-wars-2}

Here is some guidance:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Download the daily factor data from Ken French's website
\item
  Calculate daily market returns by summing the market risk premium and
  risk-free rates (\texttt{Mkt-RF} and \texttt{RF}, respectively)
\item
  Calculate the volatility (standard deviation) of daily returns
  \emph{every month} by combining \texttt{pd.Grouper()} and
  \texttt{.groupby()})
\item
  Multiply by \(\sqrt{252}\) to annualize these volatilities of daily
  returns
\item
  Plot these annualized volatilities
\end{enumerate}

Is market volatility higher during wars? Consider the following dates:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  WWII: December 1941 to September 1945
\item
  Korean War: 1950 to 1953
\item
  Viet Nam War: 1959 to 1975
\item
  Gulf War: 1990 to 1991
\item
  War in Afghanistan: 2001 to 2021
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pdr.famafrench.get\_available\_datasets()[:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['F-F_Research_Data_Factors',
 'F-F_Research_Data_Factors_weekly',
 'F-F_Research_Data_Factors_daily',
 'F-F_Research_Data_5_Factors_2x3',
 'F-F_Research_Data_5_Factors_2x3_daily']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_all }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20696\2526882917.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_all = pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    ff\_all[}\DecValTok{0}\NormalTok{]}
\NormalTok{    .assign(Mkt }\OperatorTok{=} \KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ x[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{])}
\NormalTok{    [}\StringTok{\textquotesingle{}Mkt\textquotesingle{}}\NormalTok{]}
\NormalTok{    .groupby(pd.Grouper(freq}\OperatorTok{=}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{))}
\NormalTok{    .std()}
\NormalTok{    .mul(np.sqrt(}\DecValTok{252}\NormalTok{))}
\NormalTok{    .plot()}
\NormalTok{)}

\CommentTok{\# adds vertical bands for U.S. wars}
\NormalTok{plt.axvspan(}\StringTok{\textquotesingle{}1941{-}12\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}1945{-}09\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.25}\NormalTok{)}
\NormalTok{plt.annotate(}\StringTok{\textquotesingle{}WWII\textquotesingle{}}\NormalTok{, (}\StringTok{\textquotesingle{}1941{-}12\textquotesingle{}}\NormalTok{, }\DecValTok{90}\NormalTok{))}
\NormalTok{plt.axvspan(}\StringTok{\textquotesingle{}1950\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}1953\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.25}\NormalTok{)}
\NormalTok{plt.annotate(}\StringTok{\textquotesingle{}Korean\textquotesingle{}}\NormalTok{, (}\StringTok{\textquotesingle{}1950\textquotesingle{}}\NormalTok{, }\DecValTok{80}\NormalTok{))}
\NormalTok{plt.axvspan(}\StringTok{\textquotesingle{}1959\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}1975\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.25}\NormalTok{)}
\NormalTok{plt.annotate(}\StringTok{\textquotesingle{}Vietnam\textquotesingle{}}\NormalTok{, (}\StringTok{\textquotesingle{}1959\textquotesingle{}}\NormalTok{, }\DecValTok{90}\NormalTok{))}
\NormalTok{plt.axvspan(}\StringTok{\textquotesingle{}1990\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}1991\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.25}\NormalTok{)}
\NormalTok{plt.annotate(}\StringTok{\textquotesingle{}Gulf I\textquotesingle{}}\NormalTok{, (}\StringTok{\textquotesingle{}1990\textquotesingle{}}\NormalTok{, }\DecValTok{80}\NormalTok{))}
\NormalTok{plt.axvspan(}\StringTok{\textquotesingle{}2001\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.25}\NormalTok{)}
\NormalTok{plt.annotate(}\StringTok{\textquotesingle{}Afghanistan\textquotesingle{}}\NormalTok{, (}\StringTok{\textquotesingle{}2001\textquotesingle{}}\NormalTok{, }\DecValTok{90}\NormalTok{))}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Volatility of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Annualized Volatility of U.S. Market}\CharTok{\textbackslash{}n}\StringTok{ Vertical Blue Bands Indicate Wars\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_10_practice_04_files/figure-pdf/cell-42-output-1.png}

\chapter{McKinney Chapter 10 - Practice for Section
05}\label{mckinney-chapter-10---practice-for-section-05}

\section{Announcements}\label{announcements-27}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  I will grade your projects over spring break
\item
  Please complete your peer reviews on Teammates by midnight on Tuesday,
  2/27
\item
  I will record the week 9 lecture video on Thursday
\item
  Enjoy your spring breaks!
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-26}

We will focus on 3 topics from chapter 10 of McKinney:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \emph{GroupBy Mechanics:} We will use the \texttt{.groupby()} method
  to perform ``split-apply-combine'' calculations in pandas, which let
  us aggregate data by one of more columns or indexes.
\item
  \emph{Data Aggregation:} We will combine optimized methods, like
  \texttt{.count()}, \texttt{.sum()}, \texttt{.mean()}, etc., with
  \texttt{.groupby()} to quickly aggregate data. We will combine the
  \texttt{.agg()} or \texttt{.aggregate()} method with
  \texttt{.groupby()} when we want to apply more than one aggregation
  function.
\item
  \emph{Pivot Tables:} We can use the \texttt{.pivot\_table()} method to
  aggregate data with a syntax similar to Excel's pivot tables. We can
  almost always get the same output with the \texttt{.groupby()},
  \texttt{.agg()}, and \texttt{.unstack()} methods.
\end{enumerate}

\section{Practice}\label{practice-27}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{\texorpdfstring{Replicate the following
\texttt{.pivot\_table()} output with
\texttt{.groupby()}}{Replicate the following .pivot\_table() output with .groupby()}}\label{replicate-the-following-.pivot_table-output-with-.groupby-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ind }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}\^{}GSPC \^{}DJI \^{}IXIC \^{}FTSE \^{}N225 \^{}HSI\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Index\textquotesingle{}}\NormalTok{])}
\NormalTok{    .stack()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  6 of 6 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(}
\NormalTok{    ind[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{],}
\NormalTok{    ind[}\StringTok{\textquotesingle{}Close\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

Here is the \texttt{.pivot\_table()} solution. In most cases, the
\texttt{.pivot\_table()} is easier to interpret because it explicitly
selects rows and columns (i.e., the \texttt{index} and \texttt{columns}
arguments).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ind}
\NormalTok{    .loc[}\StringTok{\textquotesingle{}2015\textquotesingle{}}\NormalTok{:]}
\NormalTok{    .reset\_index()}
\NormalTok{    .pivot\_table(}
\NormalTok{        values}\OperatorTok{=}\StringTok{\textquotesingle{}Close\textquotesingle{}}\NormalTok{,}
\NormalTok{        index}\OperatorTok{=}\NormalTok{pd.Grouper(key}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, freq}\OperatorTok{=}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{),}
\NormalTok{        columns}\OperatorTok{=}\StringTok{\textquotesingle{}Index\textquotesingle{}}\NormalTok{,}
\NormalTok{        aggfunc}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}min\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}max\textquotesingle{}}\NormalTok{]}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllll@{}}
\toprule\noalign{}
& \multicolumn{6}{l}{%
min} & \multicolumn{6}{l@{}}{%
max} \\
Index & \^{}DJI & \^{}FTSE & \^{}GSPC & \^{}HSI & \^{}IXIC & \^{}N225 &
\^{}DJI & \^{}FTSE & \^{}GSPC & \^{}HSI & \^{}IXIC & \^{}N225 \\
Date & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2015-12-31 & 15666.4404 & 5874.1001 & 1867.6100 & 20556.5996 & 4506.4902
& 16795.9609 & 18312.3906 & 7104.0000 & 2130.8201 & 28442.7500 &
5218.8599 & 20868.0293 \\
2016-12-31 & 15660.1797 & 5537.0000 & 1829.0800 & 18319.5801 & 4266.8398
& 14952.0195 & 19974.6191 & 7142.7998 & 2271.7200 & 24099.6992 &
5487.4399 & 19494.5293 \\
2017-12-31 & 19732.4004 & 7099.2002 & 2257.8301 & 22134.4707 & 5429.0801
& 18335.6309 & 24837.5098 & 7687.7998 & 2690.1599 & 30003.4902 &
6994.7598 & 22939.1797 \\
2018-12-31 & 21792.1992 & 6584.7002 & 2351.1001 & 24585.5293 & 6192.9199
& 19155.7402 & 26828.3906 & 7877.5000 & 2930.7500 & 33154.1211 &
8109.6899 & 24270.6191 \\
2019-12-31 & 22686.2207 & 6692.7002 & 2447.8899 & 25064.3594 & 6463.5000
& 19561.9609 & 28645.2598 & 7686.6001 & 3240.0200 & 30157.4902 &
9022.3896 & 24066.1191 \\
2020-12-31 & 18591.9297 & 4993.8999 & 2237.3999 & 21696.1309 & 6860.6699
& 16552.8301 & 30606.4805 & 7674.6001 & 3756.0701 & 29056.4199 &
12899.4199 & 27568.1504 \\
2021-12-31 & 29982.6191 & 6407.5000 & 3700.6499 & 22744.8594 &
12609.1602 & 27013.2500 & 36488.6289 & 7420.7002 & 4793.0601 &
31084.9395 & 16057.4404 & 30670.0996 \\
2022-12-31 & 28725.5098 & 6826.2002 & 3577.0300 & 14687.0195 &
10213.2900 & 24717.5293 & 36799.6484 & 7672.3999 & 4796.5601 &
24965.5508 & 15832.7998 & 29332.1602 \\
2023-12-31 & 31819.1406 & 7256.8999 & 3808.1001 & 16201.4902 &
10305.2402 & 25716.8594 & 37710.1016 & 8014.2998 & 4783.3501 &
22688.9004 & 15099.1797 & 33753.3281 \\
2024-12-31 & 37266.6719 & 7446.2998 & 4688.6802 & 14961.1797 &
14510.2998 & 33288.2891 & 39131.5312 & 7728.5000 & 5096.2700 &
16790.8008 & 16091.9199 & 39910.8203 \\
\end{longtable}

Here is the \texttt{.groupby()} equivalent!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ind}
\NormalTok{    .loc[}\StringTok{\textquotesingle{}2015\textquotesingle{}}\NormalTok{:]}
\NormalTok{    .reset\_index()}
\NormalTok{    .groupby([pd.Grouper(key}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, freq}\OperatorTok{=}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{), }\StringTok{\textquotesingle{}Index\textquotesingle{}}\NormalTok{])}
\NormalTok{    [}\StringTok{\textquotesingle{}Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .agg([}\StringTok{\textquotesingle{}min\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}max\textquotesingle{}}\NormalTok{])}
\NormalTok{    .unstack()}
\NormalTok{)}

\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllll@{}}
\toprule\noalign{}
& \multicolumn{6}{l}{%
min} & \multicolumn{6}{l@{}}{%
max} \\
Index & \^{}DJI & \^{}FTSE & \^{}GSPC & \^{}HSI & \^{}IXIC & \^{}N225 &
\^{}DJI & \^{}FTSE & \^{}GSPC & \^{}HSI & \^{}IXIC & \^{}N225 \\
Date & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2015-12-31 & 15666.4404 & 5874.1001 & 1867.6100 & 20556.5996 & 4506.4902
& 16795.9609 & 18312.3906 & 7104.0000 & 2130.8201 & 28442.7500 &
5218.8599 & 20868.0293 \\
2016-12-31 & 15660.1797 & 5537.0000 & 1829.0800 & 18319.5801 & 4266.8398
& 14952.0195 & 19974.6191 & 7142.7998 & 2271.7200 & 24099.6992 &
5487.4399 & 19494.5293 \\
2017-12-31 & 19732.4004 & 7099.2002 & 2257.8301 & 22134.4707 & 5429.0801
& 18335.6309 & 24837.5098 & 7687.7998 & 2690.1599 & 30003.4902 &
6994.7598 & 22939.1797 \\
2018-12-31 & 21792.1992 & 6584.7002 & 2351.1001 & 24585.5293 & 6192.9199
& 19155.7402 & 26828.3906 & 7877.5000 & 2930.7500 & 33154.1211 &
8109.6899 & 24270.6191 \\
2019-12-31 & 22686.2207 & 6692.7002 & 2447.8899 & 25064.3594 & 6463.5000
& 19561.9609 & 28645.2598 & 7686.6001 & 3240.0200 & 30157.4902 &
9022.3896 & 24066.1191 \\
2020-12-31 & 18591.9297 & 4993.8999 & 2237.3999 & 21696.1309 & 6860.6699
& 16552.8301 & 30606.4805 & 7674.6001 & 3756.0701 & 29056.4199 &
12899.4199 & 27568.1504 \\
2021-12-31 & 29982.6191 & 6407.5000 & 3700.6499 & 22744.8594 &
12609.1602 & 27013.2500 & 36488.6289 & 7420.7002 & 4793.0601 &
31084.9395 & 16057.4404 & 30670.0996 \\
2022-12-31 & 28725.5098 & 6826.2002 & 3577.0300 & 14687.0195 &
10213.2900 & 24717.5293 & 36799.6484 & 7672.3999 & 4796.5601 &
24965.5508 & 15832.7998 & 29332.1602 \\
2023-12-31 & 31819.1406 & 7256.8999 & 3808.1001 & 16201.4902 &
10305.2402 & 25716.8594 & 37710.1016 & 8014.2998 & 4783.3501 &
22688.9004 & 15099.1797 & 33753.3281 \\
2024-12-31 & 37266.6719 & 7446.2998 & 4688.6802 & 14961.1797 &
14510.2998 & 33288.2891 & 39131.5312 & 7728.5000 & 5096.2700 &
16790.8008 & 16091.9199 & 39910.8203 \\
\end{longtable}

The \texttt{.pivot\_table()} and \texttt{.groupby()} results have the
same values!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(a, b)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\subsection{Calulate the mean and standard deviation of returns by
ticker for the MATANA (MSFT, AAPL, TSLA, AMZN, NVDA, and GOOG)
stocks}\label{calulate-the-mean-and-standard-deviation-of-returns-by-ticker-for-the-matana-msft-aapl-tsla-amzn-nvda-and-goog-stocks-3}

Consider only dates with complete returns data. Try this calculation
with wide and long data frames, and confirm your results are the same.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{matana }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}MSFT AAPL TSLA AMZN NVDA GOOG\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  6 of 6 completed
\end{verbatim}

We can add the returns columns first, using the \texttt{pd.MultiIndex}
trick from a few weeks ago.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{], matana[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].columns])}
\NormalTok{matana[\_] }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    matana[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{] }\CommentTok{\# select adjusted close prices}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\CommentTok{\# drop the last price to avoid using intraday prices}
\NormalTok{    .pct\_change() }\CommentTok{\# calculate returns}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

We can use \texttt{.agg()} without \texttt{.pivot\_table()} or
\texttt{.groupby()}! We have wide data, so the tickers will be in the
columns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    matana}
\NormalTok{    .dropna()}
\NormalTok{    [}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{    .agg([}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{])}
\NormalTok{)}

\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
Ticker & AAPL & AMZN & GOOG & MSFT & NVDA & TSLA \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
mean & 0.0011 & 0.0012 & 0.0009 & 0.0010 & 0.0021 & 0.0020 \\
std & 0.0176 & 0.0207 & 0.0172 & 0.0163 & 0.0283 & 0.0358 \\
\end{longtable}

We need a long data frame to use \texttt{.pivot\_table()} and
\texttt{.groupby()} methods. Here is the \texttt{.pivot\_table()}
solution.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    matana}
\NormalTok{    .dropna()}
\NormalTok{    [}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{    .stack() }\CommentTok{\# create long data}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{) }\CommentTok{\# .pivot\_table() requires a data frame}
\NormalTok{    .pivot\_table(}
\NormalTok{        values}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{,}
\NormalTok{        index}\OperatorTok{=}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{,}
\NormalTok{        aggfunc}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{]}
\NormalTok{    )}
\NormalTok{    .transpose() }\CommentTok{\# transpose to put tickers in columns}
\NormalTok{)}

\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllll@{}}
\toprule\noalign{}
& Ticker & AAPL & AMZN & GOOG & MSFT & NVDA & TSLA \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
mean & Return & 0.0011 & 0.0012 & 0.0009 & 0.0010 & 0.0021 & 0.0020 \\
std & Return & 0.0176 & 0.0207 & 0.0172 & 0.0163 & 0.0283 & 0.0358 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(a, b)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

Here is the \texttt{.groupby()} solution.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{c }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    matana}
\NormalTok{    .dropna()}
\NormalTok{    [}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{    .stack() }\CommentTok{\# create long data}
\NormalTok{    .groupby(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{    .agg([}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{])}
\NormalTok{    .transpose() }\CommentTok{\# transpose to put tickers in columns}
\NormalTok{)}

\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllll@{}}
\toprule\noalign{}
& Ticker & AAPL & AMZN & GOOG & MSFT & NVDA & TSLA \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
mean & Return & 0.0011 & 0.0012 & 0.0009 & 0.0010 & 0.0021 & 0.0020 \\
std & Return & 0.0176 & 0.0207 & 0.0172 & 0.0163 & 0.0283 & 0.0358 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(a, c)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\subsection{Calculate the mean and standard deviation of returns and the
maximum of closing prices by ticker for the MATANA
stocks}\label{calculate-the-mean-and-standard-deviation-of-returns-and-the-maximum-of-closing-prices-by-ticker-for-the-matana-stocks-3}

Again, consider only dates with complete returns data. Try this
calculation with wide and long data frames, and confirm your results are
the same.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{a }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    matana}
\NormalTok{    .dropna()}
\NormalTok{    .stack()}
\NormalTok{    .pivot\_table(}
\NormalTok{        index}\OperatorTok{=}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{,}
\NormalTok{        aggfunc}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}Close\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}max\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{]\}}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{a}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
Variable & Close & \multicolumn{2}{l@{}}{%
Return} \\
& max & mean & std \\
Ticker & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
AAPL & 198.1100 & 0.0011 & 0.0176 \\
AMZN & 186.5705 & 0.0012 & 0.0207 \\
GOOG & 154.8400 & 0.0009 & 0.0172 \\
MSFT & 420.5500 & 0.0010 & 0.0163 \\
NVDA & 790.9200 & 0.0021 & 0.0283 \\
TSLA & 409.9700 & 0.0020 & 0.0358 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    matana}
\NormalTok{    .dropna()}
\NormalTok{    .stack()}
\NormalTok{    .groupby(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{    .agg(\{}\StringTok{\textquotesingle{}Close\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}max\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: [}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{]\})}
\NormalTok{)}

\NormalTok{b}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
Variable & Close & \multicolumn{2}{l@{}}{%
Return} \\
& max & mean & std \\
Ticker & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
AAPL & 198.1100 & 0.0011 & 0.0176 \\
AMZN & 186.5705 & 0.0012 & 0.0207 \\
GOOG & 154.8400 & 0.0009 & 0.0172 \\
MSFT & 420.5500 & 0.0010 & 0.0163 \\
NVDA & 790.9200 & 0.0021 & 0.0283 \\
TSLA & 409.9700 & 0.0020 & 0.0358 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(a, b)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

We can use the following code to display all index levels for all rows
and columns.

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{with}\NormalTok{ pd.option\_context(}\StringTok{\textquotesingle{}display.multi\_sparse\textquotesingle{}}\NormalTok{, }\VariableTok{False}\NormalTok{):}
\NormalTok{    display(b)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
Variable & Close & Return & Return \\
& max & mean & std \\
Ticker & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
AAPL & 198.1100 & 0.0011 & 0.0176 \\
AMZN & 186.5705 & 0.0012 & 0.0207 \\
GOOG & 154.8400 & 0.0009 & 0.0172 \\
MSFT & 420.5500 & 0.0010 & 0.0163 \\
NVDA & 790.9200 & 0.0021 & 0.0283 \\
TSLA & 409.9700 & 0.0020 & 0.0358 \\
\end{longtable}

If we prefer to see all index levels all the time, we can set the
following setting at the top of our notebook:

\begin{verbatim}
pd.options.display.multi_sparse = False
\end{verbatim}

We can also copy our output to our clipboaerd then paste it into Excel
if we want to convince ourelves of the column multi index arrangement.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{b.to\_clipboard()}
\end{Highlighting}
\end{Shaded}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\subsection{Calculate monthly means and volatilities for SPY and GOOG
returns}\label{calculate-monthly-means-and-volatilities-for-spy-and-goog-returns-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{spy\_goog }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}SPY GOOG\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
\NormalTok{)}

\NormalTok{spy\_goog}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  2 of 2 completed
\end{verbatim}

\begin{longtable}[]{@{}lllllllllllll@{}}
\toprule\noalign{}
Variable & \multicolumn{2}{l}{%
Adj Close} & \multicolumn{2}{l}{%
Close} & \multicolumn{2}{l}{%
High} & \multicolumn{2}{l}{%
Low} & \multicolumn{2}{l}{%
Open} & \multicolumn{2}{l@{}}{%
Volume} \\
Ticker & GOOG & SPY & GOOG & SPY & GOOG & SPY & GOOG & SPY & GOOG & SPY
& GOOG & SPY \\
Date & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1993-01-29 & NaN & 24.8407 & NaN & 43.9375 & NaN & 43.9688 & NaN &
43.7500 & NaN & 43.9688 & NaN & 1003200 \\
1993-02-01 & NaN & 25.0173 & NaN & 44.2500 & NaN & 44.2500 & NaN &
43.9688 & NaN & 43.9688 & NaN & 480500 \\
1993-02-02 & NaN & 25.0704 & NaN & 44.3438 & NaN & 44.3750 & NaN &
44.1250 & NaN & 44.2188 & NaN & 201300 \\
1993-02-03 & NaN & 25.3354 & NaN & 44.8125 & NaN & 44.8438 & NaN &
44.3750 & NaN & 44.4062 & NaN & 529400 \\
1993-02-04 & NaN & 25.4414 & NaN & 45.0000 & NaN & 45.0938 & NaN &
44.4688 & NaN & 44.9688 & NaN & 531500 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... \\
2024-02-23 & 145.2900 & 507.8500 & 145.2900 & 507.8500 & 145.9550 &
510.1300 & 144.7900 & 507.1000 & 144.9700 & 509.2700 & 14508400.0000 &
61284200 \\
2024-02-26 & 138.7500 & 505.9900 & 138.7500 & 505.9900 & 143.8400 &
508.7500 & 138.7400 & 505.8600 & 143.4500 & 508.3000 & 33513000.0000 &
50386700 \\
2024-02-27 & 140.1000 & 506.9300 & 140.1000 & 506.9300 & 140.4900 &
507.1600 & 138.5000 & 504.7500 & 139.4100 & 506.7000 & 22364000.0000 &
48854500 \\
2024-02-28 & 137.4300 & 506.2600 & 137.4300 & 506.2600 & 139.2800 &
506.8600 & 136.6400 & 504.9600 & 139.1000 & 505.3300 & 30628700.0000 &
56506600 \\
2024-02-29 & 139.7800 & 508.0800 & 139.7800 & 508.0800 & 139.9500 &
509.7400 & 137.5700 & 505.3500 & 138.3500 & 508.0700 & 35447100.0000 &
83824300 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{spy\_goog\_m }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    spy\_goog[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{] }\CommentTok{\# select adj close columns}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\CommentTok{\# drop last row, which is often intraday or missing}
\NormalTok{    .pct\_change() }\CommentTok{\# calculate daily returns}
\NormalTok{    .stack() }\CommentTok{\# stack to long}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{) }\CommentTok{\# name returns column}
\NormalTok{    .reset\_index() }\CommentTok{\# add date and ticker as columns}
\NormalTok{    .groupby([pd.Grouper(key}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, freq}\OperatorTok{=}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{), }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{]) }\CommentTok{\# group by month and ticker}
\NormalTok{    .agg([}\StringTok{\textquotesingle{}mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{]) }\CommentTok{\# calulate mean and std}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Statistic\textquotesingle{}}\NormalTok{])}
\NormalTok{)}

\NormalTok{spy\_goog\_m}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& Variable & \multicolumn{2}{l@{}}{%
Return} \\
& Statistic & mean & std \\
Date & Ticker & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1993-02-28 & SPY & 0.0006 & 0.0080 \\
1993-03-31 & SPY & 0.0010 & 0.0071 \\
1993-04-30 & SPY & -0.0012 & 0.0074 \\
1993-05-31 & SPY & 0.0014 & 0.0071 \\
1993-06-30 & SPY & 0.0002 & 0.0060 \\
... & ... & ... & ... \\
2023-12-31 & SPY & 0.0023 & 0.0060 \\
\multirow{2}{=}{2024-01-31} & GOOG & 0.0005 & 0.0202 \\
& SPY & 0.0008 & 0.0070 \\
\multirow{2}{=}{2024-02-29} & GOOG & -0.0015 & 0.0157 \\
& SPY & 0.0025 & 0.0079 \\
\end{longtable}

\subsection{Plot the monthly means and volatilities from the previous
exercise}\label{plot-the-monthly-means-and-volatilities-from-the-previous-exercise-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{spy\_goog\_m.plot()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_10_practice_05_files/figure-pdf/cell-23-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{spy\_goog\_m.unstack().plot()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_10_practice_05_files/figure-pdf/cell-24-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{spy\_goog\_m.unstack().plot(subplots}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([<Axes: xlabel='Date'>, <Axes: xlabel='Date'>,
       <Axes: xlabel='Date'>, <Axes: xlabel='Date'>], dtype=object)
\end{verbatim}

\includegraphics{mckinney_10_practice_05_files/figure-pdf/cell-25-output-2.png}

\textbf{\emph{We can make this plot better with the \texttt{seaborn}
plotting package!}}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ seaborn }\ImportTok{as}\NormalTok{ sns}
\end{Highlighting}
\end{Shaded}

The \texttt{seaborn} makes excellent multi-panel plots, including plots
with statistics. \textbf{\emph{But, it requires very long data frames.}}
A \emph{very} long data frame has all of the y values in one column and
all other useful dimensions as columns instead of indexes!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{spy\_goog\_m.stack().reset\_index().head()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
Variable & Date & Ticker & Statistic & Return \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & 1993-02-28 & SPY & mean & 0.0006 \\
1 & 1993-02-28 & SPY & std & 0.0080 \\
2 & 1993-03-31 & SPY & mean & 0.0010 \\
3 & 1993-03-31 & SPY & std & 0.0071 \\
4 & 1993-04-30 & SPY & mean & -0.0012 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.relplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{spy\_goog\_m.stack().reset\_index(),}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{,}
\NormalTok{    hue}\OperatorTok{=}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{,}
\NormalTok{    col}\OperatorTok{=}\StringTok{\textquotesingle{}Statistic\textquotesingle{}}\NormalTok{,}
\NormalTok{    height}\OperatorTok{=}\DecValTok{3}\NormalTok{,}
\NormalTok{    kind}\OperatorTok{=}\StringTok{\textquotesingle{}line\textquotesingle{}}\NormalTok{,}
\NormalTok{    alpha}\OperatorTok{=}\FloatTok{0.75}
\NormalTok{)}

\NormalTok{plt.gcf().autofmt\_xdate()}
\NormalTok{plt.suptitle(}\StringTok{\textquotesingle{}Monthly Mean and Volatility of Daily Returns\textquotesingle{}}\NormalTok{, y}\OperatorTok{=}\FloatTok{1.05}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_10_practice_05_files/figure-pdf/cell-28-output-1.png}

\subsection{Assign the Dow Jones stocks to five portfolios based on
their monthly
volatility}\label{assign-the-dow-jones-stocks-to-five-portfolios-based-on-their-monthly-volatility-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{wiki }\OperatorTok{=}\NormalTok{ pd.read\_html(}\StringTok{\textquotesingle{}https://en.wikipedia.org/wiki/Dow\_Jones\_Industrial\_Average\textquotesingle{}}\NormalTok{)}
\NormalTok{wiki[}\DecValTok{1}\NormalTok{][}\StringTok{\textquotesingle{}Symbol\textquotesingle{}}\NormalTok{].to\_list()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['MMM',
 'AXP',
 'AMGN',
 'AMZN',
 'AAPL',
 'BA',
 'CAT',
 'CVX',
 'CSCO',
 'KO',
 'DIS',
 'DOW',
 'GS',
 'HD',
 'HON',
 'IBM',
 'INTC',
 'JNJ',
 'JPM',
 'MCD',
 'MRK',
 'MSFT',
 'NKE',
 'PG',
 'CRM',
 'TRV',
 'UNH',
 'VZ',
 'V',
 'WMT']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{djia }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\NormalTok{wiki[}\DecValTok{1}\NormalTok{][}\StringTok{\textquotesingle{}Symbol\textquotesingle{}}\NormalTok{].to\_list())}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
\NormalTok{)}

\NormalTok{djia}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  30 of 30 completed
\end{verbatim}

First, we add daily returns to \texttt{djia}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{], djia[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]])}
\NormalTok{djia[\_] }\OperatorTok{=}\NormalTok{ djia[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].pct\_change()}
\end{Highlighting}
\end{Shaded}

Second, we add monthly volatility of daily returns to each day. The
\texttt{.transform()} methods lets us add monthly volatility to the
original daily data.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Volatility\textquotesingle{}}\NormalTok{], djia[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]])}
\NormalTok{djia[\_] }\OperatorTok{=}\NormalTok{ djia[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{].groupby(pd.Grouper(freq}\OperatorTok{=}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{)).transform(}\StringTok{\textquotesingle{}std\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Third, we use \texttt{pd.qcut()} to assign stocks to portfolios based on
volatility. Here is an example of how to use \texttt{pd.qcut()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.arange(}\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pd.qcut(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{np.arange(}\DecValTok{10}\NormalTok{),}
\NormalTok{    q}\OperatorTok{=}\DecValTok{2}\NormalTok{,}
\NormalTok{    labels}\OperatorTok{=}\VariableTok{False}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0, 0, 0, 0, 0, 1, 1, 1, 1, 1], dtype=int64)
\end{verbatim}

We use the \texttt{.apply()} with \texttt{axis=1} to apply
\texttt{pd.qcut} to every row in
\texttt{djia{[}\textquotesingle{}Volatility\textquotesingle{}{]}}
without writing a for loop. We can also pass \texttt{q=5} and
\texttt{labels=False} after we give the \texttt{pd.qcut} function name.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ pd.MultiIndex.from\_product([[}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{], djia[}\StringTok{\textquotesingle{}Volatility\textquotesingle{}}\NormalTok{]])}
\NormalTok{djia[\_] }\OperatorTok{=}\NormalTok{ djia[}\StringTok{\textquotesingle{}Volatility\textquotesingle{}}\NormalTok{].iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].}\BuiltInTok{apply}\NormalTok{(pd.qcut, q}\OperatorTok{=}\DecValTok{5}\NormalTok{, labels}\OperatorTok{=}\VariableTok{False}\NormalTok{, axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\subsection{Plot the time-series volatilities of these five
portfolios}\label{plot-the-time-series-volatilities-of-these-five-portfolios-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{djia.stack()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
& Variable & Adj Close & Close & High & Low & Open & Volume & Return &
Volatility & Portfolio \\
Date & Ticker & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{5}{=}{1962-01-02} & BA & 0.1909 & 0.8230 & 0.8374 & 0.8230 &
0.8374 & 352350.0000 & NaN & 0.0156 & 3.0000 \\
& CAT & 0.4767 & 1.6042 & 1.6198 & 1.5885 & 1.6042 & 163200.0000 & NaN &
0.0121 & 1.0000 \\
& CVX & 0.3358 & 3.2961 & 3.2961 & 3.2440 & 0.0000 & 105840.0000 & NaN &
0.0108 & 0.0000 \\
& DIS & 0.0582 & 0.0929 & 0.0960 & 0.0929 & 0.0929 & 841958.0000 & NaN &
0.0170 & 3.0000 \\
& HON & 1.0740 & 8.3100 & 8.3287 & 8.2726 & 0.0000 & 40740.0000 & NaN &
0.0097 & 0.0000 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
\multirow{5}{=}{2024-03-01} & TRV & 220.2450 & 220.2450 & 221.0850 &
219.9000 & 220.9000 & 28335.0000 & NaN & NaN & NaN \\
& UNH & 482.1600 & 482.1600 & 490.0200 & 481.5365 & 498.5000 &
982334.0000 & NaN & NaN & NaN \\
& V & 283.9000 & 283.9000 & 284.9100 & 282.7200 & 283.2000 & 378060.0000
& NaN & NaN & NaN \\
& VZ & 39.9750 & 39.9750 & 40.0500 & 39.7700 & 39.9900 & 1042012.0000 &
NaN & NaN & NaN \\
& WMT & 58.5250 & 58.5250 & 58.8090 & 58.5200 & 58.8000 & 1206478.0000 &
NaN & NaN & NaN \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    djia}
\NormalTok{    .stack()}
\NormalTok{    .groupby([}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{])}
\NormalTok{    [}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{    .mean()}
\NormalTok{    .reset\_index()}
\NormalTok{    .dropna()}
\NormalTok{    .assign(Portfolio}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{].astype(}\BuiltInTok{int}\NormalTok{))}
\NormalTok{    .groupby([pd.Grouper(key}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, freq}\OperatorTok{=}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{), }\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{])}
\NormalTok{    .std()}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Volatility\textquotesingle{}}\NormalTok{\})}
\NormalTok{    .unstack()}
\NormalTok{    [}\StringTok{\textquotesingle{}Volatility\textquotesingle{}}\NormalTok{]}
\NormalTok{    .plot()}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Volatility of Daily Returns\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Volatility of Daily Returns}\CharTok{\textbackslash{}n}\StringTok{ for Five Portfolios Formed Monthly on Volatility\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_10_practice_05_files/figure-pdf/cell-37-output-1.png}

\subsection{\texorpdfstring{Calculate the \emph{mean} monthly
correlation between the Dow Jones
stocks}{Calculate the mean monthly correlation between the Dow Jones stocks}}\label{calculate-the-mean-monthly-correlation-between-the-dow-jones-stocks-3}

\emph{I may build Project 2 on this exercise, so I will leave it blank,
for now.}

\subsection{Is market volatility higher during
wars?}\label{is-market-volatility-higher-during-wars-3}

Here is some guidance:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Download the daily factor data from Ken French's website
\item
  Calculate daily market returns by summing the market risk premium and
  risk-free rates (\texttt{Mkt-RF} and \texttt{RF}, respectively)
\item
  Calculate the volatility (standard deviation) of daily returns
  \emph{every month} by combining \texttt{pd.Grouper()} and
  \texttt{.groupby()})
\item
  Multiply by \(\sqrt{252}\) to annualize these volatilities of daily
  returns
\item
  Plot these annualized volatilities
\end{enumerate}

Is market volatility higher during wars? Consider the following dates:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  WWII: December 1941 to September 1945
\item
  Korean War: 1950 to 1953
\item
  Viet Nam War: 1959 to 1975
\item
  Gulf War: 1990 to 1991
\item
  War in Afghanistan: 2001 to 2021
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pdr.famafrench.get\_available\_datasets()[:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['F-F_Research_Data_Factors',
 'F-F_Research_Data_Factors_weekly',
 'F-F_Research_Data_Factors_daily',
 'F-F_Research_Data_5_Factors_2x3',
 'F-F_Research_Data_5_Factors_2x3_daily']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_all }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24320\2526882917.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_all = pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    ff\_all[}\DecValTok{0}\NormalTok{]}
\NormalTok{    .assign(Mkt }\OperatorTok{=} \KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ x[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{])}
\NormalTok{    [}\StringTok{\textquotesingle{}Mkt\textquotesingle{}}\NormalTok{]}
\NormalTok{    .groupby(pd.Grouper(freq}\OperatorTok{=}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{))}
\NormalTok{    .std()}
\NormalTok{    .mul(np.sqrt(}\DecValTok{252}\NormalTok{))}
\NormalTok{    .plot()}
\NormalTok{)}

\CommentTok{\# adds vertical bands for U.S. wars}
\NormalTok{plt.axvspan(}\StringTok{\textquotesingle{}1941{-}12\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}1945{-}09\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.25}\NormalTok{)}
\NormalTok{plt.annotate(}\StringTok{\textquotesingle{}WWII\textquotesingle{}}\NormalTok{, (}\StringTok{\textquotesingle{}1941{-}12\textquotesingle{}}\NormalTok{, }\DecValTok{90}\NormalTok{))}
\NormalTok{plt.axvspan(}\StringTok{\textquotesingle{}1950\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}1953\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.25}\NormalTok{)}
\NormalTok{plt.annotate(}\StringTok{\textquotesingle{}Korean\textquotesingle{}}\NormalTok{, (}\StringTok{\textquotesingle{}1950\textquotesingle{}}\NormalTok{, }\DecValTok{80}\NormalTok{))}
\NormalTok{plt.axvspan(}\StringTok{\textquotesingle{}1959\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}1975\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.25}\NormalTok{)}
\NormalTok{plt.annotate(}\StringTok{\textquotesingle{}Vietnam\textquotesingle{}}\NormalTok{, (}\StringTok{\textquotesingle{}1959\textquotesingle{}}\NormalTok{, }\DecValTok{90}\NormalTok{))}
\NormalTok{plt.axvspan(}\StringTok{\textquotesingle{}1990\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}1991\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.25}\NormalTok{)}
\NormalTok{plt.annotate(}\StringTok{\textquotesingle{}Gulf I\textquotesingle{}}\NormalTok{, (}\StringTok{\textquotesingle{}1990\textquotesingle{}}\NormalTok{, }\DecValTok{80}\NormalTok{))}
\NormalTok{plt.axvspan(}\StringTok{\textquotesingle{}2001\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{, alpha}\OperatorTok{=}\FloatTok{0.25}\NormalTok{)}
\NormalTok{plt.annotate(}\StringTok{\textquotesingle{}Afghanistan\textquotesingle{}}\NormalTok{, (}\StringTok{\textquotesingle{}2001\textquotesingle{}}\NormalTok{, }\DecValTok{90}\NormalTok{))}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Volatility of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Annualized Volatility of U.S. Market}\CharTok{\textbackslash{}n}\StringTok{ Vertical Blue Bands Indicate Wars\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_10_practice_05_files/figure-pdf/cell-40-output-1.png}

\part{Week 9}

\chapter{McKinney Chapter 11 - Time
Series}\label{mckinney-chapter-11---time-series}

\section{Introduction}\label{introduction-6}

Chapter 11 of Wes McKinney's
\href{https://wesmckinney.com/book/}{\emph{Python for Data Analysis}}
discusses time series and panel data, which is where pandas
\textbf{\emph{shines.}} We will use these time series and panel tools
every day for the rest of the course.

We will focus on:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Slicing a data frame or series by date or date range
\item
  Using \texttt{.shift()} to create leads and lags of variables
\item
  Using \texttt{.resample()} to change the frequency of variables
\item
  Using \texttt{.rolling()} to aggregate data over rolling windows
\end{enumerate}

\textbf{\emph{Note:}} Indented block quotes are from McKinney unless
otherwise indicated. The section numbers here differ from McKinney
because we will only discuss some topics.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

McKinney provides an excellent introduction to the concept of time
series and panel data:

\begin{quote}
Time series data is an important form of structured data in many
different fields, such as finance, economics, ecology, neuroscience, and
physics. Anything that is observed or measured at many points in time
forms a time series. Many time series are fixed frequency, which is to
say that data points occur at regular intervals according to some rule,
such as every 15 seconds, every 5 minutes, or once per month. Time
series can also be irregular without a fixed unit of time or offset
between units. How you mark and refer to time series data depends on the
application, and you may have one of the following: - Timestamps,
specific instants in time - Fixed periods, such as the month January
2007 or the full year 2010 - Intervals of time, indicated by a start and
end timestamp. Periods can be thought of as special cases of intervals -
Experiment or elapsed time; each timestamp is a measure of time relative
to a particular start time (e.g., the diameter of a cookie baking each
second since being placed in the oven)

In this chapter, I am mainly concerned with time series in the first
three categories, though many of the techniques can be applied to
experimental time series where the index may be an integer or
floating-point number indicating elapsed time from the start of the
experiment. The simplest and most widely used kind of time series are
those indexed by timestamp. 323

pandas provides many built-in time series tools and data algorithms. You
can effi‐ ciently work with very large time series and easily slice and
dice, aggregate, and resample irregular- and fixed-frequency time
series. Some of these tools are especially useful for financial and
economics applications, but you could certainly use them to analyze
server log data, too.
\end{quote}

\section{Time Series Basics}\label{time-series-basics}

Let us create a time series to play with.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{from}\NormalTok{ datetime }\ImportTok{import}\NormalTok{ datetime}
\NormalTok{dates }\OperatorTok{=}\NormalTok{ [}
\NormalTok{    datetime(}\DecValTok{2011}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{2}\NormalTok{), }
\NormalTok{    datetime(}\DecValTok{2011}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{5}\NormalTok{),}
\NormalTok{    datetime(}\DecValTok{2011}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{7}\NormalTok{), }
\NormalTok{    datetime(}\DecValTok{2011}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{8}\NormalTok{),}
\NormalTok{    datetime(}\DecValTok{2011}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{10}\NormalTok{), }
\NormalTok{    datetime(}\DecValTok{2011}\NormalTok{, }\DecValTok{1}\NormalTok{, }\DecValTok{12}\NormalTok{)}
\NormalTok{]}
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{ts }\OperatorTok{=}\NormalTok{ pd.Series(np.random.randn(}\DecValTok{6}\NormalTok{), index}\OperatorTok{=}\NormalTok{dates)}

\NormalTok{ts}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2011-01-02    0.4967
2011-01-05   -0.1383
2011-01-07    0.6477
2011-01-08    1.5230
2011-01-10   -0.2342
2011-01-12   -0.2341
dtype: float64
\end{verbatim}

Note that pandas converts the \texttt{datetime} objects to a pandas
\texttt{DatetimeIndex} object and a single index value is a
\texttt{Timestamp} object.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts.index}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
DatetimeIndex(['2011-01-02', '2011-01-05', '2011-01-07', '2011-01-08',
               '2011-01-10', '2011-01-12'],
              dtype='datetime64[ns]', freq=None)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts.index[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Timestamp('2011-01-02 00:00:00')
\end{verbatim}

Recall that arithmetic operations between pandas objects automatically
align on indexes.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2011-01-02    0.4967
2011-01-05   -0.1383
2011-01-07    0.6477
2011-01-08    1.5230
2011-01-10   -0.2342
2011-01-12   -0.2341
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts.iloc[::}\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2011-01-02    0.4967
2011-01-07    0.6477
2011-01-10   -0.2342
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts }\OperatorTok{+}\NormalTok{ ts.iloc[::}\DecValTok{2}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2011-01-02    0.9934
2011-01-05       NaN
2011-01-07    1.2954
2011-01-08       NaN
2011-01-10   -0.4683
2011-01-12       NaN
dtype: float64
\end{verbatim}

\subsection{Indexing, Selection,
Subsetting}\label{indexing-selection-subsetting}

pandas uses U.S.-style date strings (e.g., ``M/D/Y'') or unambiguous
date strings (e.g., ``YYYY-MM-DD'') to select data.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts[}\StringTok{\textquotesingle{}1/10/2011\textquotesingle{}}\NormalTok{] }\CommentTok{\# M/D/YYYY}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-0.2342
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts[}\StringTok{\textquotesingle{}2011{-}01{-}10\textquotesingle{}}\NormalTok{] }\CommentTok{\# YYYY{-}MM{-}DD}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-0.2342
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts[}\StringTok{\textquotesingle{}20110110\textquotesingle{}}\NormalTok{] }\CommentTok{\# YYYYMMDD}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-0.2342
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts[}\StringTok{\textquotesingle{}10{-}Jan{-}2011\textquotesingle{}}\NormalTok{] }\CommentTok{\# D{-}Mon{-}YYYY}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-0.2342
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts[}\StringTok{\textquotesingle{}Jan{-}10{-}2011\textquotesingle{}}\NormalTok{] }\CommentTok{\# Mon{-}D{-}YYYY}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-0.2342
\end{verbatim}

But pandas does not use U.K.-style dates.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# \# KeyError: \textquotesingle{}10/1/2011\textquotesingle{}}
\CommentTok{\# ts[\textquotesingle{}10/1/2011\textquotesingle{}] \# D/M/YYYY}
\end{Highlighting}
\end{Shaded}

Here is a longer time series we can use to learn about longer slices.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{longer\_ts }\OperatorTok{=}\NormalTok{ pd.Series(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{np.random.randn(}\DecValTok{1000}\NormalTok{),}
\NormalTok{    index}\OperatorTok{=}\NormalTok{pd.date\_range(}\StringTok{\textquotesingle{}1/1/2000\textquotesingle{}}\NormalTok{, periods}\OperatorTok{=}\DecValTok{1000}\NormalTok{)}
\NormalTok{)}

\NormalTok{longer\_ts}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2000-01-01    0.4967
2000-01-02   -0.1383
2000-01-03    0.6477
2000-01-04    1.5230
2000-01-05   -0.2342
               ...  
2002-09-22   -0.2811
2002-09-23    1.7977
2002-09-24    0.6408
2002-09-25   -0.5712
2002-09-26    0.5726
Freq: D, Length: 1000, dtype: float64
\end{verbatim}

We can pass a year-month to slice all of the observations in May of
2001.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{longer\_ts[}\StringTok{\textquotesingle{}2001{-}05\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2001-05-01   -0.6466
2001-05-02   -1.0815
2001-05-03    1.6871
2001-05-04    0.8816
2001-05-05   -0.0080
2001-05-06    1.4799
2001-05-07    0.0774
2001-05-08   -0.8613
2001-05-09    1.5231
2001-05-10    0.5389
2001-05-11   -1.0372
2001-05-12   -0.1903
2001-05-13   -0.8756
2001-05-14   -1.3828
2001-05-15    0.9262
2001-05-16    1.9094
2001-05-17   -1.3986
2001-05-18    0.5630
2001-05-19   -0.6506
2001-05-20   -0.4871
2001-05-21   -0.5924
2001-05-22   -0.8640
2001-05-23    0.0485
2001-05-24   -0.8310
2001-05-25    0.2705
2001-05-26   -0.0502
2001-05-27   -0.2389
2001-05-28   -0.9076
2001-05-29   -0.5768
2001-05-30    0.7554
2001-05-31    0.5009
Freq: D, dtype: float64
\end{verbatim}

We can also pass a year to slice all observations in 2001.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{longer\_ts[}\StringTok{\textquotesingle{}2001\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2001-01-01    0.2241
2001-01-02    0.0126
2001-01-03    0.0977
2001-01-04   -0.7730
2001-01-05    0.0245
               ...  
2001-12-27    0.0184
2001-12-28    0.3476
2001-12-29   -0.5398
2001-12-30   -0.7783
2001-12-31    0.1958
Freq: D, Length: 365, dtype: float64
\end{verbatim}

If we sort our data chronologically, we can also slice with a range of
date strings.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts[}\StringTok{\textquotesingle{}1/6/2011\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}1/10/2011\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2011-01-07    0.6477
2011-01-08    1.5230
2011-01-10   -0.2342
dtype: float64
\end{verbatim}

However, we cannot date slice if our data are not sorted
chronologically.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts2 }\OperatorTok{=}\NormalTok{ ts.sort\_values()}

\NormalTok{ts2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2011-01-10   -0.2342
2011-01-12   -0.2341
2011-01-05   -0.1383
2011-01-02    0.4967
2011-01-07    0.6477
2011-01-08    1.5230
dtype: float64
\end{verbatim}

For example, the following date slice fails because \texttt{ts2} is not
sorted chronologically.

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# \# KeyError: \textquotesingle{}Value based partial slicing on non{-}monotonic DatetimeIndexes with non{-}existing keys is not allowed.\textquotesingle{}}
\CommentTok{\# ts2[\textquotesingle{}1/6/2011\textquotesingle{}:\textquotesingle{}1/11/2011\textquotesingle{}]}
\end{Highlighting}
\end{Shaded}

We can use the \texttt{.sort\_index()} method first to allow date
slices.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts2.sort\_index()[}\StringTok{\textquotesingle{}1/6/2011\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}1/11/2011\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2011-01-07    0.6477
2011-01-08    1.5230
2011-01-10   -0.2342
dtype: float64
\end{verbatim}

\textbf{\emph{To be clear, a range of date strings is inclusive on both
ends.}}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{longer\_ts[}\StringTok{\textquotesingle{}1/6/2001\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}1/11/2001\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2001-01-06    0.4980
2001-01-07    1.4511
2001-01-08    0.9593
2001-01-09    2.1532
2001-01-10   -0.7673
2001-01-11    0.8723
Freq: D, dtype: float64
\end{verbatim}

\textbf{\emph{Recall, if we modify a slice, we modify the original
series or dataframe.}}

\begin{quote}
Remember that slicing in this manner produces views on the source time
series like slicing NumPy arrays. This means that no data is copied and
modifications on the slice will be reflected in the original data.
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts3 }\OperatorTok{=}\NormalTok{ ts.copy()}
\NormalTok{ts3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2011-01-02    0.4967
2011-01-05   -0.1383
2011-01-07    0.6477
2011-01-08    1.5230
2011-01-10   -0.2342
2011-01-12   -0.2341
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts4 }\OperatorTok{=}\NormalTok{ ts3.iloc[:}\DecValTok{3}\NormalTok{]}
\NormalTok{ts4}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2011-01-02    0.4967
2011-01-05   -0.1383
2011-01-07    0.6477
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts4.iloc[:] }\OperatorTok{=} \DecValTok{2001}
\NormalTok{ts4}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2011-01-02   2001.0000
2011-01-05   2001.0000
2011-01-07   2001.0000
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2011-01-02   2001.0000
2011-01-05   2001.0000
2011-01-07   2001.0000
2011-01-08      1.5230
2011-01-10     -0.2342
2011-01-12     -0.2341
dtype: float64
\end{verbatim}

Series \texttt{ts} is unchanged because \texttt{ts3} is an explicit copy
of \texttt{ts}!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2011-01-02    0.4967
2011-01-05   -0.1383
2011-01-07    0.6477
2011-01-08    1.5230
2011-01-10   -0.2342
2011-01-12   -0.2341
dtype: float64
\end{verbatim}

\subsection{Time Series with Duplicate
Indices}\label{time-series-with-duplicate-indices}

Most data in this course will be well-formed with one observation per
datetime for series or one observation per individual per datetime for
dataframes. However, you may later receive poorly-formed data with
duplicate observations. The toy data in series \texttt{dup\_ts} has
three observations on February 2nd.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dates }\OperatorTok{=}\NormalTok{ pd.DatetimeIndex([}\StringTok{\textquotesingle{}1/1/2000\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}1/2/2000\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}1/2/2000\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}1/2/2000\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}1/3/2000\textquotesingle{}}\NormalTok{])}
\NormalTok{dup\_ts }\OperatorTok{=}\NormalTok{ pd.Series(data}\OperatorTok{=}\NormalTok{np.arange(}\DecValTok{5}\NormalTok{), index}\OperatorTok{=}\NormalTok{dates)}

\NormalTok{dup\_ts}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2000-01-01    0
2000-01-02    1
2000-01-02    2
2000-01-02    3
2000-01-03    4
dtype: int32
\end{verbatim}

The \texttt{.is\_unique} property tells us if an index is unique.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dup\_ts.index.is\_unique}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
False
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dup\_ts[}\StringTok{\textquotesingle{}1/3/2000\textquotesingle{}}\NormalTok{]  }\CommentTok{\# not duplicated}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
4
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{dup\_ts[}\StringTok{\textquotesingle{}1/2/2000\textquotesingle{}}\NormalTok{]  }\CommentTok{\# duplicated}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2000-01-02    1
2000-01-02    2
2000-01-02    3
dtype: int32
\end{verbatim}

The solution to duplicate data depends on the context. For example, we
may want the mean of all observations on a given date. The
\texttt{.groupby()} method can help us here.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{grouped }\OperatorTok{=}\NormalTok{ dup\_ts.groupby(level}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{grouped.mean()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2000-01-01   0.0000
2000-01-02   2.0000
2000-01-03   4.0000
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{grouped.last()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2000-01-01    0
2000-01-02    3
2000-01-03    4
dtype: int32
\end{verbatim}

Or we may want the number of observations on each date.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{grouped.count()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2000-01-01    1
2000-01-02    3
2000-01-03    1
dtype: int64
\end{verbatim}

\section{Date Ranges, Frequencies, and
Shifting}\label{date-ranges-frequencies-and-shifting}

\begin{quote}
Generic time series in pandas are assumed to be irregular; that is, they
have no fixed frequency. For many applications this is sufficient.
However, it's often desirable to work relative to a fixed frequency,
such as daily, monthly, or every 15 minutes, even if that means
introducing missing values into a time series. Fortunately pandas has a
full suite of standard time series frequencies and tools for resampling,
inferring frequencies, and generating fixed-frequency date ranges.
\end{quote}

We will skip the sections on creating date ranges or different
frequencies so we can focus on shifting data.

\subsection{Shifting (Leading and Lagging)
Data}\label{shifting-leading-and-lagging-data}

\textbf{\emph{Shifting is an important feature!}} Shifting is moving
data backward (or forward) through time.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{ts }\OperatorTok{=}\NormalTok{ pd.Series(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{np.random.randn(}\DecValTok{4}\NormalTok{),}
\NormalTok{    index}\OperatorTok{=}\NormalTok{pd.date\_range(}\StringTok{\textquotesingle{}1/1/2000\textquotesingle{}}\NormalTok{, periods}\OperatorTok{=}\DecValTok{4}\NormalTok{, freq}\OperatorTok{=}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{ts}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2000-01-31    0.4967
2000-02-29   -0.1383
2000-03-31    0.6477
2000-04-30    1.5230
Freq: M, dtype: float64
\end{verbatim}

If we pass a positive integer \(N\) to the \texttt{.shift()} method:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The date index remains the same
\item
  Values are shifted down \(N\) observations
\end{enumerate}

``Lag'' might be a better name than ``shift'' since a postive 2 makes
the value at any timestamp the value from 2 timestamps above (earlier,
since most time-series data are chronological).

The \texttt{.shift()} method assumes \(N=1\) if we do not specify the
\texttt{periods} argument.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts.shift()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2000-01-31       NaN
2000-02-29    0.4967
2000-03-31   -0.1383
2000-04-30    0.6477
Freq: M, dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts.shift(}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2000-01-31       NaN
2000-02-29    0.4967
2000-03-31   -0.1383
2000-04-30    0.6477
Freq: M, dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts.shift(}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2000-01-31       NaN
2000-02-29       NaN
2000-03-31    0.4967
2000-04-30   -0.1383
Freq: M, dtype: float64
\end{verbatim}

If we pass a \emph{negative} integer \(N\) to the \texttt{.shift()}
method, values are shifted \emph{up} \(N\) observations.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts.shift(}\OperatorTok{{-}}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2000-01-31   0.6477
2000-02-29   1.5230
2000-03-31      NaN
2000-04-30      NaN
Freq: M, dtype: float64
\end{verbatim}

We will almost never shift with negative values (i.e., we will almost
never bring forward values from the future) to prevent a look-ahead
bias. We do not want to assume that financial market participants have
access to future data. Our most common shift will be to compute the
percent change from one period to the next. We can calculate the percent
change two ways.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts.pct\_change()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2000-01-31       NaN
2000-02-29   -1.2784
2000-03-31   -5.6844
2000-04-30    1.3515
Freq: M, dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(ts }\OperatorTok{{-}}\NormalTok{ ts.shift()) }\OperatorTok{/}\NormalTok{ ts.shift()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2000-01-31       NaN
2000-02-29   -1.2784
2000-03-31   -5.6844
2000-04-30    1.3515
Freq: M, dtype: float64
\end{verbatim}

We can use \texttt{np.allclose()} to test that the two return
calculations above are the same.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(}
\NormalTok{    a}\OperatorTok{=}\NormalTok{ts.pct\_change(),}
\NormalTok{    b}\OperatorTok{=}\NormalTok{(ts }\OperatorTok{{-}}\NormalTok{ ts.shift()) }\OperatorTok{/}\NormalTok{ ts.shift(),}
\NormalTok{    equal\_nan}\OperatorTok{=}\VariableTok{True}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

Two observations on the percent change calculations above:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The first percent change is \texttt{NaN} (not a number of missing)
  because there is no previous value to change from
\item
  The default \texttt{periods} argument for \texttt{.shift()} and
  \texttt{.pct\_change()} is 1
\end{enumerate}

The naive shift examples above shift by a number of observations,
without considering timestamps or their frequencies. As a result,
timestamps are unchanged and values shift down (positive
\texttt{periods} argument) or up (negative \texttt{periods} argument).
However, we can also pass the \texttt{freq} argument to respect the
timestamps. With the \texttt{freq} argument, timestamps shift by a
multiple (specified by the \texttt{periods} argument) of datetime
intervals (specified by the \texttt{freq} argument). Note that the
examples below generate new datetime indexes.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2000-01-31    0.4967
2000-02-29   -0.1383
2000-03-31    0.6477
2000-04-30    1.5230
Freq: M, dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts.shift(}\DecValTok{2}\NormalTok{, freq}\OperatorTok{=}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2000-03-31    0.4967
2000-04-30   -0.1383
2000-05-31    0.6477
2000-06-30    1.5230
Freq: M, dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts.shift(}\DecValTok{3}\NormalTok{, freq}\OperatorTok{=}\StringTok{\textquotesingle{}D\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2000-02-03    0.4967
2000-03-03   -0.1383
2000-04-03    0.6477
2000-05-03    1.5230
dtype: float64
\end{verbatim}

\texttt{M} is already months, so \texttt{T} is minutes.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts.shift(}\DecValTok{1}\NormalTok{, freq}\OperatorTok{=}\StringTok{\textquotesingle{}90T\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2000-01-31 01:30:00    0.4967
2000-02-29 01:30:00   -0.1383
2000-03-31 01:30:00    0.6477
2000-04-30 01:30:00    1.5230
dtype: float64
\end{verbatim}

\subsection{Shifting dates with
offsets}\label{shifting-dates-with-offsets}

We can also shift timestamps to the beginning or end of a period or
interval.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{from}\NormalTok{ pandas.tseries.offsets }\ImportTok{import}\NormalTok{ Day, MonthEnd}
\NormalTok{now }\OperatorTok{=}\NormalTok{ datetime(}\DecValTok{2011}\NormalTok{, }\DecValTok{11}\NormalTok{, }\DecValTok{17}\NormalTok{)}

\NormalTok{now}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
datetime.datetime(2011, 11, 17, 0, 0)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{now }\OperatorTok{+} \DecValTok{3} \OperatorTok{*}\NormalTok{ Day()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Timestamp('2011-11-20 00:00:00')
\end{verbatim}

Below, \texttt{MonthEnd(0)} moves to the end of the month, \emph{but
never leaves the month.}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{now }\OperatorTok{+}\NormalTok{ MonthEnd(}\DecValTok{0}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Timestamp('2011-11-30 00:00:00')
\end{verbatim}

Next, \texttt{MonthEnd(1)} moves to the end of the month, unless already
at the end, then moves to the next end of the month.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{now }\OperatorTok{+}\NormalTok{ MonthEnd(}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Timestamp('2011-11-30 00:00:00')
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{now }\OperatorTok{+}\NormalTok{ MonthEnd(}\DecValTok{1}\NormalTok{) }\OperatorTok{+}\NormalTok{ MonthEnd(}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Timestamp('2011-12-31 00:00:00')
\end{verbatim}

So, \texttt{MonthEnd(2)} uses 1 step to move to the end of the current
month, then 1 step to move to the end of the next month.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{now }\OperatorTok{+}\NormalTok{ MonthEnd(}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Timestamp('2011-12-31 00:00:00')
\end{verbatim}

Date offsets can help us align data for presentation or merging.
\textbf{\emph{But, be careful!}} The default argument is 1, but we
typically want 0.

Here, \texttt{MonthEnd(0)} moves to the end of the current month, never
leaving it.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{datetime(}\DecValTok{2021}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{30}\NormalTok{) }\OperatorTok{+}\NormalTok{ MonthEnd(}\DecValTok{0}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Timestamp('2021-10-31 00:00:00')
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{datetime(}\DecValTok{2021}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{31}\NormalTok{) }\OperatorTok{+}\NormalTok{ MonthEnd(}\DecValTok{0}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Timestamp('2021-10-31 00:00:00')
\end{verbatim}

Here, \texttt{MonthEnd(1)} moves to the end of the current month,
leaving it only if already at the end of the month.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{datetime(}\DecValTok{2021}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{30}\NormalTok{) }\OperatorTok{+}\NormalTok{ MonthEnd(}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Timestamp('2021-10-31 00:00:00')
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{datetime(}\DecValTok{2021}\NormalTok{, }\DecValTok{10}\NormalTok{, }\DecValTok{31}\NormalTok{) }\OperatorTok{+}\NormalTok{ MonthEnd(}\DecValTok{1}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Timestamp('2021-11-30 00:00:00')
\end{verbatim}

\textbf{\emph{Always check your output!}}

\section{Resampling and Frequency
Conversion}\label{resampling-and-frequency-conversion}

\textbf{\emph{Resampling is an important feature!}}

\begin{quote}
Resampling refers to the process of converting a time series from one
frequency to another. Aggregating higher frequency data to lower
frequency is called downsampling, while converting lower frequency to
higher frequency is called upsampling. Not all resampling falls into
either of these categories; for example, converting W-WED (weekly on
Wednesday) to W-FRI is neither upsampling nor downsampling.
\end{quote}

We can resample both series and data frames. The \texttt{.resample()}
method syntax is similar to the \texttt{.groupby()} method syntax. This
similarity is because \texttt{.resample()} is syntactic sugar for
\texttt{.groupby()}.

\subsection{Downsampling}\label{downsampling}

\begin{quote}
Aggregating data to a regular, lower frequency is a pretty normal time
series task. The data you're aggregating doesn't need to be fixed
frequently; the desired frequency defines bin edges that are used to
slice the time series into pieces to aggregate. For example, to convert
to monthly, `M' or `BM', you need to chop up the data into one-month
intervals. Each interval is said to be half-open; a data point can only
belong to one interval, and the union of the intervals must make up the
whole time frame. There are a couple things to think about when using
resample to downsample data:

\begin{itemize}
\tightlist
\item
  Which side of each interval is closed
\item
  How to label each aggregated bin, either with the start of the
  interval or the end
\end{itemize}
\end{quote}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rng }\OperatorTok{=}\NormalTok{ pd.date\_range(start}\OperatorTok{=}\StringTok{\textquotesingle{}2000{-}01{-}01\textquotesingle{}}\NormalTok{, periods}\OperatorTok{=}\DecValTok{12}\NormalTok{, freq}\OperatorTok{=}\StringTok{\textquotesingle{}T\textquotesingle{}}\NormalTok{)}
\NormalTok{ts }\OperatorTok{=}\NormalTok{ pd.Series(np.arange(}\DecValTok{12}\NormalTok{), index}\OperatorTok{=}\NormalTok{rng)}

\NormalTok{ts}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2000-01-01 00:00:00     0
2000-01-01 00:01:00     1
2000-01-01 00:02:00     2
2000-01-01 00:03:00     3
2000-01-01 00:04:00     4
2000-01-01 00:05:00     5
2000-01-01 00:06:00     6
2000-01-01 00:07:00     7
2000-01-01 00:08:00     8
2000-01-01 00:09:00     9
2000-01-01 00:10:00    10
2000-01-01 00:11:00    11
Freq: T, dtype: int32
\end{verbatim}

We can aggregate the one-minute frequency data above to a five-minute
frequency. Resampling requires and aggregation method, and here McKinney
chooses the \texttt{.sum()} method.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts.resample(}\StringTok{\textquotesingle{}5min\textquotesingle{}}\NormalTok{).}\BuiltInTok{sum}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2000-01-01 00:00:00    10
2000-01-01 00:05:00    35
2000-01-01 00:10:00    21
Freq: 5T, dtype: int32
\end{verbatim}

Two observations about the previous resampling example:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  For minute-frequency resampling, the default is that the new data are
  labeled by the left edge of the resampling interval
\item
  For minute-frequency resampling, the default is that the left edge is
  closed (included) and the right edge is open (excluded)
\end{enumerate}

As a result, the first value of 10 at midnight is the sum of values at
midnight and to the right of midnight, excluding the value at 00:05
(i.e., \(10 = 0+1+2+3+4\) at 00:00 and \(35 = 5+6+7+8+9\) at 00:05). We
can use the \texttt{closed} and \texttt{label} arguments to change this
behavior.

In finance, we generally prefer
\texttt{closed=\textquotesingle{}right\textquotesingle{}} and
\texttt{label=\textquotesingle{}right\textquotesingle{}} to avoid a
lookahead bias.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts.resample(}\StringTok{\textquotesingle{}5min\textquotesingle{}}\NormalTok{, closed}\OperatorTok{=}\StringTok{\textquotesingle{}right\textquotesingle{}}\NormalTok{, label}\OperatorTok{=}\StringTok{\textquotesingle{}right\textquotesingle{}}\NormalTok{).}\BuiltInTok{sum}\NormalTok{() }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
2000-01-01 00:00:00     0
2000-01-01 00:05:00    15
2000-01-01 00:10:00    40
2000-01-01 00:15:00    11
Freq: 5T, dtype: int32
\end{verbatim}

Mixed combinations of \texttt{closed} and \texttt{label} are possible
but confusing.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ts.resample(}\StringTok{\textquotesingle{}5min\textquotesingle{}}\NormalTok{, closed}\OperatorTok{=}\StringTok{\textquotesingle{}right\textquotesingle{}}\NormalTok{, label}\OperatorTok{=}\StringTok{\textquotesingle{}left\textquotesingle{}}\NormalTok{).}\BuiltInTok{sum}\NormalTok{() }
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1999-12-31 23:55:00     0
2000-01-01 00:00:00    15
2000-01-01 00:05:00    40
2000-01-01 00:10:00    11
Freq: 5T, dtype: int32
\end{verbatim}

These defaults for minute-frequency data may seem odd, but any choice is
arbitrary. I suggest you do the following when you use the
\texttt{.resample()} method:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Read the docstring
\item
  Check your output
\end{enumerate}

pandas and its \texttt{.resample()} method are mature and widely used,
so the defaults are typically reasonable.

\subsection{Upsampling and
Interpolation}\label{upsampling-and-interpolation}

To downsample (i.e., resample from higher frequency to lower frequency),
we aggregate data with an aggregation method (e.g., \texttt{.mean()},
\texttt{.sum()}, \texttt{.first()}, or \texttt{.last()}). To upsample
(i.e., resample from lower frequency to higher frequency), we do not
aggregate data.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.random.seed(}\DecValTok{42}\NormalTok{)}
\NormalTok{frame }\OperatorTok{=}\NormalTok{ pd.DataFrame(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{np.random.randn(}\DecValTok{2}\NormalTok{, }\DecValTok{4}\NormalTok{),}
\NormalTok{    index}\OperatorTok{=}\NormalTok{pd.date\_range(}\StringTok{\textquotesingle{}1/1/2000\textquotesingle{}}\NormalTok{, periods}\OperatorTok{=}\DecValTok{2}\NormalTok{, freq}\OperatorTok{=}\StringTok{\textquotesingle{}W{-}WED\textquotesingle{}}\NormalTok{),}
\NormalTok{    columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Colorado\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Texas\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}New York\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ohio\textquotesingle{}}\NormalTok{]}
\NormalTok{)}

\NormalTok{frame}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& Colorado & Texas & New York & Ohio \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2000-01-05 & 0.4967 & -0.1383 & 0.6477 & 1.5230 \\
2000-01-12 & -0.2342 & -0.2341 & 1.5792 & 0.7674 \\
\end{longtable}

We can use the \texttt{.asfreq()} method to convert to the new frequency
and leave the new times as missing.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_daily }\OperatorTok{=}\NormalTok{ frame.resample(}\StringTok{\textquotesingle{}D\textquotesingle{}}\NormalTok{).asfreq()}

\NormalTok{df\_daily}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& Colorado & Texas & New York & Ohio \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2000-01-05 & 0.4967 & -0.1383 & 0.6477 & 1.5230 \\
2000-01-06 & NaN & NaN & NaN & NaN \\
2000-01-07 & NaN & NaN & NaN & NaN \\
2000-01-08 & NaN & NaN & NaN & NaN \\
2000-01-09 & NaN & NaN & NaN & NaN \\
2000-01-10 & NaN & NaN & NaN & NaN \\
2000-01-11 & NaN & NaN & NaN & NaN \\
2000-01-12 & -0.2342 & -0.2341 & 1.5792 & 0.7674 \\
\end{longtable}

We can use the \texttt{.ffill()} method to forward fill values to
replace missing values.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame.resample(}\StringTok{\textquotesingle{}D\textquotesingle{}}\NormalTok{).ffill()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& Colorado & Texas & New York & Ohio \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2000-01-05 & 0.4967 & -0.1383 & 0.6477 & 1.5230 \\
2000-01-06 & 0.4967 & -0.1383 & 0.6477 & 1.5230 \\
2000-01-07 & 0.4967 & -0.1383 & 0.6477 & 1.5230 \\
2000-01-08 & 0.4967 & -0.1383 & 0.6477 & 1.5230 \\
2000-01-09 & 0.4967 & -0.1383 & 0.6477 & 1.5230 \\
2000-01-10 & 0.4967 & -0.1383 & 0.6477 & 1.5230 \\
2000-01-11 & 0.4967 & -0.1383 & 0.6477 & 1.5230 \\
2000-01-12 & -0.2342 & -0.2341 & 1.5792 & 0.7674 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame.resample(}\StringTok{\textquotesingle{}D\textquotesingle{}}\NormalTok{).ffill(limit}\OperatorTok{=}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& Colorado & Texas & New York & Ohio \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2000-01-05 & 0.4967 & -0.1383 & 0.6477 & 1.5230 \\
2000-01-06 & 0.4967 & -0.1383 & 0.6477 & 1.5230 \\
2000-01-07 & 0.4967 & -0.1383 & 0.6477 & 1.5230 \\
2000-01-08 & NaN & NaN & NaN & NaN \\
2000-01-09 & NaN & NaN & NaN & NaN \\
2000-01-10 & NaN & NaN & NaN & NaN \\
2000-01-11 & NaN & NaN & NaN & NaN \\
2000-01-12 & -0.2342 & -0.2341 & 1.5792 & 0.7674 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{frame.resample(}\StringTok{\textquotesingle{}W{-}THU\textquotesingle{}}\NormalTok{).ffill()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& Colorado & Texas & New York & Ohio \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2000-01-06 & 0.4967 & -0.1383 & 0.6477 & 1.5230 \\
2000-01-13 & -0.2342 & -0.2341 & 1.5792 & 0.7674 \\
\end{longtable}

\section{Moving Window Functions}\label{moving-window-functions}

\textbf{\emph{Moving window (or rolling window) functions are one of the
neatest features of pandas, and we will frequently use moving window
functions.}} We will use data similar, but not identical, to the book
data.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}AAPL\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}MSFT\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}SPY\textquotesingle{}}\NormalTok{])}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
\NormalTok{)}

\NormalTok{df.head()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  3 of 3 completed
\end{verbatim}

\begin{longtable}[]{@{}lllllllllllllllllll@{}}
\toprule\noalign{}
Variable & \multicolumn{3}{l}{%
Adj Close} & \multicolumn{3}{l}{%
Close} & \multicolumn{3}{l}{%
High} & \multicolumn{3}{l}{%
Low} & \multicolumn{3}{l}{%
Open} & \multicolumn{3}{l@{}}{%
Volume} \\
Ticker & AAPL & MSFT & SPY & AAPL & MSFT & SPY & AAPL & MSFT & SPY &
AAPL & MSFT & SPY & AAPL & MSFT & SPY & AAPL & MSFT & SPY \\
Date & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1980-12-12 & 0.0992 & NaN & NaN & 0.1283 & NaN & NaN & 0.1289 & NaN &
NaN & 0.1283 & NaN & NaN & 0.1283 & NaN & NaN & 469033600.0000 & NaN &
NaN \\
1980-12-15 & 0.0940 & NaN & NaN & 0.1217 & NaN & NaN & 0.1222 & NaN &
NaN & 0.1217 & NaN & NaN & 0.1222 & NaN & NaN & 175884800.0000 & NaN &
NaN \\
1980-12-16 & 0.0871 & NaN & NaN & 0.1127 & NaN & NaN & 0.1133 & NaN &
NaN & 0.1127 & NaN & NaN & 0.1133 & NaN & NaN & 105728000.0000 & NaN &
NaN \\
1980-12-17 & 0.0893 & NaN & NaN & 0.1155 & NaN & NaN & 0.1161 & NaN &
NaN & 0.1155 & NaN & NaN & 0.1155 & NaN & NaN & 86441600.0000 & NaN &
NaN \\
1980-12-18 & 0.0919 & NaN & NaN & 0.1189 & NaN & NaN & 0.1194 & NaN &
NaN & 0.1189 & NaN & NaN & 0.1189 & NaN & NaN & 73449600.0000 & NaN &
NaN \\
\end{longtable}

The \texttt{.rolling()} method is similar to the \texttt{.groupby()} and
\texttt{.resample()} methods. The \texttt{.rolling()} method accepts a
window-width and requires an aggregation method. The next example
calculates and plots the 252-trading day moving average of AAPL's price
alongside the daily price.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{aapl }\OperatorTok{=}\NormalTok{ df.loc[}\StringTok{\textquotesingle{}2012\textquotesingle{}}\NormalTok{:, (}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}AAPL\textquotesingle{}}\NormalTok{)]}
\NormalTok{aapl.plot(label}\OperatorTok{=}\StringTok{\textquotesingle{}Observed\textquotesingle{}}\NormalTok{)}
\NormalTok{aapl.rolling(}\DecValTok{252}\NormalTok{).mean().plot(label}\OperatorTok{=}\StringTok{\textquotesingle{}252 Trading Day Mean\textquotesingle{}}\NormalTok{) }\CommentTok{\# min\_periods defaults to 252}
\NormalTok{aapl.rolling(}\StringTok{\textquotesingle{}365D\textquotesingle{}}\NormalTok{).mean().plot(label}\OperatorTok{=}\StringTok{\textquotesingle{}365 Calendar Day Mean\textquotesingle{}}\NormalTok{) }\CommentTok{\# min\_periods defaults to 1}
\NormalTok{aapl.resample(}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{).mean().plot(style}\OperatorTok{=}\StringTok{\textquotesingle{}.\textquotesingle{}}\NormalTok{, label}\OperatorTok{=}\StringTok{\textquotesingle{}Calendar Year Mean\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.legend()}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}AAPL Adjusted Close ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Comparison of Rolling and Resampling Means\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_lecture_files/figure-pdf/cell-69-output-1.png}

Two observations:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  If we pass the window-width as an integer, the window-width is based
  on the number of observations and ignores time stamps
\item
  If we pass the window-width as an integer, the \texttt{.rolling()}
  method requires that number of observations for all windows (i.e.,
  note that the moving average starts 251 trading days after the first
  daily price
\end{enumerate}

We can use the \texttt{min\_periods} argument to allow incomplete
windows. For integer window widths, \texttt{min\_periods\ defaults} to
the given integer window width. For string date offsets,
\texttt{min\_periods\ defaults} to \texttt{1}.

\subsection{Binary Moving Window
Functions}\label{binary-moving-window-functions}

Binary moving window functions accept two inputs. The most common
example is the rolling correlation between two returns series.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns }\OperatorTok{=}\NormalTok{ df[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].pct\_change()}

\NormalTok{returns}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
Ticker & AAPL & MSFT & SPY \\
Date & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1980-12-12 & NaN & NaN & NaN \\
1980-12-15 & -0.0522 & NaN & NaN \\
1980-12-16 & -0.0734 & NaN & NaN \\
1980-12-17 & 0.0248 & NaN & NaN \\
1980-12-18 & 0.0290 & NaN & NaN \\
... & ... & ... & ... \\
2024-02-23 & -0.0100 & -0.0032 & 0.0007 \\
2024-02-26 & -0.0075 & -0.0068 & -0.0037 \\
2024-02-27 & 0.0081 & -0.0001 & 0.0019 \\
2024-02-28 & -0.0066 & 0.0006 & -0.0013 \\
2024-02-29 & -0.0037 & 0.0145 & 0.0036 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    returns[}\StringTok{\textquotesingle{}AAPL\textquotesingle{}}\NormalTok{]}
\NormalTok{    .rolling(}\DecValTok{126}\NormalTok{, min\_periods}\OperatorTok{=}\DecValTok{100}\NormalTok{)}
\NormalTok{    .corr(returns[}\StringTok{\textquotesingle{}SPY\textquotesingle{}}\NormalTok{])}
\NormalTok{    .plot()}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Correlation between AAPL and SPY\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Rolling Correlation between AAPL and SPY}\CharTok{\textbackslash{}n}\StringTok{ (126{-}Day Window w/ 100{-}Day Minimum)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_lecture_files/figure-pdf/cell-71-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    returns[[}\StringTok{\textquotesingle{}AAPL\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}MSFT\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .rolling(}\DecValTok{126}\NormalTok{, min\_periods}\OperatorTok{=}\DecValTok{100}\NormalTok{)}
\NormalTok{    .corr(returns[}\StringTok{\textquotesingle{}SPY\textquotesingle{}}\NormalTok{])}
\NormalTok{    .plot()}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Correlation with SPY\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Rolling Correlation with SPY}\CharTok{\textbackslash{}n}\StringTok{ (126{-}Day Window w/ 100{-}Day Minimum)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_lecture_files/figure-pdf/cell-72-output-1.png}

\subsection{User-Defined Moving Window
Functions}\label{user-defined-moving-window-functions}

Finally, we can define our own moving window functions and use the
\texttt{.apply()} method to apply them However, note that
\texttt{.apply()} will be much slower than the the optimized moving
window functions (e.g., \texttt{.mean()}, \texttt{.std()}, etc.).

McKinney provides an abstract example here, but we will discuss a
simpler example that calculates rolling volatility. Also, calculating
rolling volatility with the \texttt{.apply()} method provides us a
chance to benchmark it against the optimized version.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    returns[}\StringTok{\textquotesingle{}AAPL\textquotesingle{}}\NormalTok{]}
\NormalTok{    .rolling(}\DecValTok{252}\NormalTok{)}
\NormalTok{    .}\BuiltInTok{apply}\NormalTok{(np.std)}
\NormalTok{    .mul(np.sqrt(}\DecValTok{252}\NormalTok{) }\OperatorTok{*} \DecValTok{100}\NormalTok{)}
\NormalTok{    .plot()}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Volatility (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Rolling Volatility}\CharTok{\textbackslash{}n}\StringTok{ (252{-}Day Window w/ 252{-}Day Minimum)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_lecture_files/figure-pdf/cell-73-output-1.png}

Do not be afraid to use \texttt{.apply()}, but realize that
\texttt{.apply()} is typically 1000-times slower than the pre-built
method.

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{timeit returns[}\StringTok{\textquotesingle{}AAPL\textquotesingle{}}\NormalTok{].rolling(}\DecValTok{252}\NormalTok{).}\BuiltInTok{apply}\NormalTok{(np.std)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
902 ms ± 148 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{timeit returns[}\StringTok{\textquotesingle{}AAPL\textquotesingle{}}\NormalTok{].rolling(}\DecValTok{252}\NormalTok{).std()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
244 µs ± 11.8 µs per loop (mean ± std. dev. of 7 runs, 1,000 loops each)
\end{verbatim}

\chapter{McKinney Chapter 11 - Practice for Section
02}\label{mckinney-chapter-11---practice-for-section-02}

\section{Announcements}\label{announcements-28}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  I finished grading Project 1

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Before peer reviews, the median grade is 84\% (mean is 84.4\%)
  \item
    Assuming perfect peer reviews, the median grade is 87\% (mean is
    87.1\%)
  \item
    Peer review scores on Canvas are the median peer review scores on
    Teammates because medians ignore outliers
  \item
    97.1\% of students received perfect peer review scores
  \item
    Only 1.2\% of students received peer review scores less than 90\%
  \item
    I posted a barebones solution to the Project 1 assignment page on
    Canvas
  \end{enumerate}
\item
  10,000 XP on DataCamp

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Due by Fri5ay, 3/16, at 11:59 PM
  \item
    Upload a screenshot of your DataCamp profile page with XP to Canvas
  \end{enumerate}
\item
  I will post Project 2 by Thursday morning and we will discuss it on
  Thursday and Friday
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-27}

The time-series functionality in pandas is fantastic! Here are the three
main tools we will use:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \texttt{.shift()} method

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    The \texttt{.shift()} method is used to shift the index of a
    DataFrame by a specified number of periods.
  \item
    It is useful for calculating percentage changes, differences between
    time periods, and other time series calculations.
  \item
    The method can be used to shift both forward and backward in time.
  \end{enumerate}
\item
  \texttt{.resample()} method

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    The \texttt{.resample()} method is used to resample time-series
    data.
  \item
    It is used to convert time series data from one frequency to
    another.
  \item
    The method can be used to upsample (increase the frequency of the
    data) or downsample (decrease the frequency of the data).
  \end{enumerate}
\item
  \texttt{.rolling()} method

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    The \texttt{.rolling()} method is used to perform rolling window
    calculations on sequential data.
  \item
    A rolling window is a fixed-size interval or subset of data that
    moves sequentially through a larger dataset.
  \item
    The method is useful for calculating moving averages, standard
    deviations, and other rolling window calculations.
  \end{enumerate}
\end{enumerate}

\section{Practice}\label{practice-28}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{Download daily returns for ten portfolios formed on
book-to-market
ratios}\label{download-daily-returns-for-ten-portfolios-formed-on-book-to-market-ratios}

We can use a list comprehension with an \texttt{if} statement to find
the name of the file with portfolios formed on book-to-market ratios.
Book-to-market ratios are also called B/M ratios, and French includes
``Portfolios'' and ``BE-ME'' in the files with these portfolio returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{[x }\ControlFlowTok{for}\NormalTok{ x }\KeywordTok{in}\NormalTok{ pdr.famafrench.get\_available\_datasets() }\ControlFlowTok{if}\NormalTok{ (}\StringTok{\textquotesingle{}Portfolios\textquotesingle{}} \KeywordTok{in}\NormalTok{ x) }\KeywordTok{and}\NormalTok{ (}\StringTok{\textquotesingle{}BE{-}ME\textquotesingle{}} \KeywordTok{in}\NormalTok{ x)][:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['Portfolios_Formed_on_BE-ME',
 'Portfolios_Formed_on_BE-ME_Wout_Div',
 'Portfolios_Formed_on_BE-ME_Daily',
 'Developed_6_Portfolios_ME_BE-ME',
 'Developed_6_Portfolios_ME_BE-ME_daily']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{be\_me\_all }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolios\_Formed\_on\_BE{-}ME\_Daily\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24516\616375102.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  be_me_all = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24516\616375102.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  be_me_all = pdr.DataReader(
\end{verbatim}

The value for the ``DESCR'' key shows how French creates these data
(i.e., he forms portfolios at the end of every June) and what each data
frame contains. The 0 key selects returns on value-weighted portfolios,
and the 1 key selects returns on equal-weighted portfolios.

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(be\_me\_all[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Portfolios Formed on BE-ME Daily
--------------------------------

This file was created by CMPT_BEME_RETS_DAILY using the 202401 CRSP database. It contains value- and equal-weighted returns for portfolios formed on BE/ME. The portfolios are constructed at the end of June. BE/ME is book equity at the last fiscal year end of the prior calendar year divided by ME at the end of December of the prior year. The annual returns are from January to December. Missing data are indicated by -99.99 or -999. The break points use Compustat firms plus the firms hand-collected from the Moodys Industrial, Utilities, Transportation, and Financial Manuals. The break points include utilities. The portfolios use Compustat firms plus the firms hand-collected from the Moodys Industrial, Utilities, Transportation, and Financial Manuals. The portfolios include utilities.

  0 : Value Weighted Returns -- Daily (25670 rows x 19 cols)
  1 : Equal Weighted Returns -- Daily (25670 rows x 19 cols)
\end{verbatim}

Each data frame has several groups of portfolios:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The first column provides the returns on a portfolio of negative book
  equity stocks. The next 18 columns split the positive book equity
  stocks into 3, 5, and 10 portfolios based on their B/M ranks.
\item
  The next 3 columns provide 3 portfolios split on the 30th and 70th
  percentiles of B/M.
\item
  The next 5 columns provide 5 portfolios split on the 20th, 40th, 60th,
  and 80th percentiles of B/M (i.e., quintiles).
\item
  The last 10 columns provide 10 portfolios split on the 10th, 20th,
  \ldots, and 90th percentiles of B/M (i.e., deciles).
\end{enumerate}

We can assign the value-weighted B/M-decile portfolio returns to data
frame \texttt{be\_me\_vw}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{be\_me\_vw }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    be\_me\_all }\CommentTok{\# all data frames}
\NormalTok{    [}\DecValTok{0}\NormalTok{] }\CommentTok{\# select the value{-}weighted portfolio returns}
\NormalTok{    .iloc[:, }\OperatorTok{{-}}\DecValTok{10}\NormalTok{:] }\CommentTok{\# slice the rightmost ten columns}
\NormalTok{    .div(}\DecValTok{100}\NormalTok{) }\CommentTok{\# convert from percent to decimal}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}B/M Portfolio\textquotesingle{}}\NormalTok{) }\CommentTok{\# label colums for easy plots}
\NormalTok{)}

\NormalTok{be\_me\_vw}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
B/M Portfolio & Lo 10 & Dec 2 & Dec 3 & Dec 4 & Dec 5 & Dec 6 & Dec 7 &
Dec 8 & Dec 9 & Hi 10 \\
Date & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1926-07-01 & 0.0014 & 0.0044 & -0.0012 & 0.0009 & 0.0019 & 0.0038 &
-0.0032 & -0.0011 & 0.0028 & -0.0044 \\
1926-07-02 & 0.0044 & 0.0043 & 0.0066 & 0.0044 & 0.0061 & 0.0015 &
0.0061 & 0.0019 & 0.0044 & -0.0011 \\
1926-07-06 & 0.0037 & 0.0000 & 0.0054 & 0.0027 & 0.0007 & 0.0004 &
-0.0002 & -0.0043 & 0.0016 & 0.0012 \\
1926-07-07 & -0.0004 & -0.0003 & 0.0032 & 0.0032 & 0.0001 & 0.0020 &
-0.0023 & 0.0059 & 0.0053 & -0.0030 \\
1926-07-08 & 0.0067 & -0.0003 & 0.0030 & 0.0038 & -0.0009 & 0.0027 &
-0.0003 & 0.0057 & 0.0025 & 0.0073 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2024-01-25 & -0.0023 & 0.0071 & 0.0120 & 0.0082 & 0.0100 & 0.0115 &
0.0117 & 0.0095 & 0.0092 & 0.0146 \\
2024-01-26 & -0.0031 & 0.0044 & 0.0016 & -0.0003 & 0.0026 & 0.0023 &
0.0039 & 0.0073 & -0.0148 & 0.0067 \\
2024-01-29 & 0.0110 & 0.0078 & 0.0094 & 0.0088 & 0.0095 & 0.0048 &
0.0029 & 0.0079 & 0.0076 & 0.0085 \\
2024-01-30 & -0.0025 & -0.0051 & -0.0034 & -0.0014 & 0.0030 & 0.0014 &
0.0070 & 0.0007 & 0.0049 & 0.0105 \\
2024-01-31 & -0.0169 & -0.0134 & -0.0383 & -0.0142 & -0.0158 & -0.0127 &
-0.0121 & -0.0189 & -0.0182 & -0.0197 \\
\end{longtable}

We can easily visualize these portfolio returns with the arithmetic and
geometric means of these portfolio returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .mean() }\CommentTok{\# arithmetic mean}
\NormalTok{    .mul(}\DecValTok{252}\NormalTok{) }\CommentTok{\# annualize}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{) }\CommentTok{\# convert to percent}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Arithmetic Means of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_02_files/figure-pdf/cell-8-output-1.png}

In finance, we often call the annualized geometric mean the ``compounded
annualized growth rate'' or ``CAGR''. The geoemetric mean of daily
returns is
\(1 + r_{geom} = \left[ \prod_{t}^T (1+r_t) \right]^{\frac{1}{T}}\),
where \(r_t\) is the return on day \(t\). The CAGR is the annualized
geometric mean of daily returns, so \(1 + CAGR = (1 + r_{geom})^{252}\)
and \(CAGR = \left[ \prod_{t}^T (1+r_t) \right]^{\frac{252}{T}} - 1\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: (}\DecValTok{1} \OperatorTok{+}\NormalTok{ x).prod()}\OperatorTok{**}\NormalTok{(}\DecValTok{252} \OperatorTok{/}\NormalTok{ x.count()) }\OperatorTok{{-}} \DecValTok{1}\NormalTok{) }\CommentTok{\# annualized geometric mean or CAGR}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{) }\CommentTok{\# convert to percent}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}CAGR of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Geometric Means of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_02_files/figure-pdf/cell-9-output-1.png}

\subsection{Calculate cumulative returns with all available
data}\label{calculate-cumulative-returns-with-all-available-data}

We have done calculations and plots of cumulative returns for several
weeks, and these do not use the \texttt{.shift()}, \texttt{.resample()},
or \texttt{.rolling()} methods.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod() }\CommentTok{\# compound cumulative returns}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{) }\CommentTok{\# convert to percent}
\NormalTok{    .plot()}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Cumulative Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Cumulative Returns of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_02_files/figure-pdf/cell-10-output-1.png}

\subsection{Calculate total returns for each calendar
year}\label{calculate-total-returns-for-each-calendar-year}

We use the \texttt{.resample()} method to downsample our daily returns
to annual returns. Note that we must \texttt{.add(1)} to our returns
\emph{before} we \texttt{.resample()} because we can only associate one
method with the resampling. We could \texttt{.apply()} a lambda function
that does the compounding one step, but optimized methods like
\texttt{.prod()} are generally faster than \texttt{.apply()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{) }\CommentTok{\# must add 1 before .resample()}
\NormalTok{    .resample(rule}\OperatorTok{=}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{, kind}\OperatorTok{=}\StringTok{\textquotesingle{}period\textquotesingle{}}\NormalTok{) }\CommentTok{\# down sample to annual periods}
\NormalTok{    .prod() }\CommentTok{\# use product to compound (1+r)s each year}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{) }\CommentTok{\# subtract 1 after compounding}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
B/M Portfolio & Lo 10 & Dec 2 & Dec 3 & Dec 4 & Dec 5 & Dec 6 & Dec 7 &
Dec 8 & Dec 9 & Hi 10 \\
Date & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1926 & 0.0819 & 0.0309 & 0.2793 & 0.0899 & 0.0248 & 0.0825 & 0.1265 &
0.1038 & 0.0510 & 0.0958 \\
1927 & 0.5773 & 0.2518 & 0.4298 & 0.2015 & 0.2041 & 0.2611 & 0.2832 &
0.2471 & 0.3844 & 0.4825 \\
1928 & 0.4880 & 0.4965 & 0.3961 & 0.3724 & 0.4677 & 0.2581 & 0.1484 &
0.3331 & 0.3740 & 0.2668 \\
1929 & -0.2691 & -0.0844 & -0.1469 & -0.0664 & -0.0039 & -0.0147 &
-0.0096 & -0.0830 & -0.0830 & -0.2550 \\
1930 & -0.2911 & -0.2067 & -0.2679 & -0.2757 & -0.2531 & -0.3514 &
-0.3858 & -0.4110 & -0.5280 & -0.5669 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2020 & 0.4815 & 0.3129 & 0.2160 & 0.1451 & 0.0720 & 0.0862 & -0.1662 &
-0.0139 & 0.0187 & -0.1113 \\
2021 & 0.2373 & 0.2334 & 0.2867 & 0.1776 & 0.1296 & 0.3196 & 0.2543 &
0.3685 & 0.3981 & 0.4465 \\
2022 & -0.2962 & -0.2218 & -0.1847 & -0.0814 & -0.1003 & -0.1435 &
-0.0183 & 0.0804 & -0.0044 & -0.0418 \\
2023 & 0.4777 & 0.2459 & 0.2325 & 0.0482 & 0.1235 & 0.1728 & 0.1047 &
0.1004 & 0.1900 & 0.0679 \\
2024 & 0.0233 & 0.0128 & -0.0023 & -0.0177 & 0.0251 & 0.0217 & 0.0205 &
-0.0380 & -0.0273 & -0.0006 \\
\end{longtable}

\subsection{Calculate total returns over rolling 252-trading-day
windows}\label{calculate-total-returns-over-rolling-252-trading-day-windows}

We specify the window as an integer (252 observations), so the
\texttt{.rolling()} method defaults the \texttt{min\_periods} argument
to the same integer (252 observations). As a result, the
\texttt{.rolling()} method needs a minimum of 252 periods before it
applies our function, and the first 251 observations are missing below.
Also, pandas does not provide a \texttt{.prod()} method that works with
the \texttt{.rolling()} method, so we must manually perform this
calculation with \texttt{.apply()}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%\%}\NormalTok{time}
\NormalTok{be\_me\_rr\_1 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    be\_me\_vw}
\NormalTok{    .rolling(}\DecValTok{252}\NormalTok{) }\CommentTok{\# 252 observation window, because integer window, min\_periods default to size of the observation window}
\NormalTok{    .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: (}\DecValTok{1} \OperatorTok{+}\NormalTok{ x).prod() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{) }\CommentTok{\# simple returns are multiplicative}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
CPU times: total: 37.2 s
Wall time: 37.4 s
\end{verbatim}

The code above is \emph{slow}, because we did use an rolling-optimized
method. We can do this with log returns and the \texttt{.sum()} method,
which is rolling-optimized!

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%\%}\NormalTok{time}
\NormalTok{be\_me\_rr\_2 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    be\_me\_vw}
\NormalTok{    .pipe(np.log1p) }\CommentTok{\# calculate log returns}
\NormalTok{    .rolling(}\DecValTok{252}\NormalTok{) }\CommentTok{\# 252 observation window, because integer window, min\_periods default to size of the observation window}
\NormalTok{    .}\BuiltInTok{sum}\NormalTok{() }\CommentTok{\# log returns are additive}
\NormalTok{    .pipe(np.expm1)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
CPU times: total: 31.2 ms
Wall time: 16.9 ms
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(be\_me\_rr\_1, be\_me\_rr\_2, equal\_nan}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\subsection{Calculate total returns over rolling 12-months windows after
calculating monthly
returns}\label{calculate-total-returns-over-rolling-12-months-windows-after-calculating-monthly-returns}

Since log returns are much faster with the \texttt{.rolling()} method,
we will:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Calculate log returns first
\item
  Resample daily returns to monthly returns
\item
  Calculate rolling returns over 12-month rolling windows
\item
  Calculate simple returns last
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .pipe(np.log1p) }\CommentTok{\# calculate log returns}
\NormalTok{    .resample(}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{)}
\NormalTok{    .}\BuiltInTok{sum}\NormalTok{() }\CommentTok{\# after this sum, we have monthly log returns}
\NormalTok{    .rolling(}\DecValTok{12}\NormalTok{) }\CommentTok{\# rolling 12{-}month windows}
\NormalTok{    .}\BuiltInTok{sum}\NormalTok{() }\CommentTok{\# after this sum, we have rolling 12{-}month log returns}
\NormalTok{    .pipe(np.expm1) }\CommentTok{\# calculate simple returns}
\NormalTok{    .dropna()}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{) }\CommentTok{\# convert to percent}
\NormalTok{    .plot()}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Rolling 12{-}Month Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Rolling 12{-}Month Returns of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_02_files/figure-pdf/cell-15-output-1.png}

With the 12-month holding periods above, we cannot easily see the spread
between value (Hi 10) and growth (Lo 10) returns. So we can change the
\texttt{.rolling(12)} to a \texttt{.rolling(30\ *\ 12)} to calculate
rolling 30-year returns. We see that sometimes the value-growth spread
is high, but the spread is about zero over the last 30 years.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .pipe(np.log1p) }\CommentTok{\# calculate log returns}
\NormalTok{    .resample(}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{)}
\NormalTok{    .}\BuiltInTok{sum}\NormalTok{() }\CommentTok{\# after this sum, we have monthly log returns}
\NormalTok{    .rolling(}\DecValTok{30} \OperatorTok{*} \DecValTok{12}\NormalTok{) }\CommentTok{\# rolling 30{-}year windows}
\NormalTok{    .}\BuiltInTok{sum}\NormalTok{() }\CommentTok{\# after this sum, we have rolling 12{-}month log returns}
\NormalTok{    .pipe(np.expm1) }\CommentTok{\# calculate simple returns}
\NormalTok{    .dropna()}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{) }\CommentTok{\# convert to percent}
\NormalTok{    .plot()}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Rolling 30{-}Year Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Rolling 30{-}Year Returns of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_02_files/figure-pdf/cell-16-output-1.png}

\subsection{Calculate Sharpe Ratios for each calendar
year}\label{calculate-sharpe-ratios-for-each-calendar-year}

We need the risk-free rate from Ken French's website to calculate Sharpe
ratios! The Sharpe Ratio is
\(S_i = \frac{\overline{r_i - r_f}}{\sigma_i}\), where
\(\overline{r_i-r_f}\) is mean fund return relative to the risk-free
rate over some period and \(\sigma_i\) is the standard deviation of
\(r_i-r_f\) over the same period.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_all }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}

\NormalTok{ff }\OperatorTok{=}\NormalTok{ ff\_all[}\DecValTok{0}\NormalTok{].div(}\DecValTok{100}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24516\2778589428.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_all = pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{) }\CommentTok{\# daily excess returns}
\NormalTok{    .resample(}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{) }\CommentTok{\# downsample to annual}
\NormalTok{    .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: np.sqrt(}\DecValTok{252}\NormalTok{) }\OperatorTok{*}\NormalTok{ x.mean() }\OperatorTok{/}\NormalTok{ x.std()) }\CommentTok{\# calculate Sharpe ratios}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
B/M Portfolio & Lo 10 & Dec 2 & Dec 3 & Dec 4 & Dec 5 & Dec 6 & Dec 7 &
Dec 8 & Dec 9 & Hi 10 \\
Date & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1926-12-31 & 1.0443 & 0.3296 & 2.4042 & 1.9237 & 0.2085 & 1.3751 &
1.4400 & 1.3200 & 0.5276 & 1.0035 \\
1927-12-31 & 3.2226 & 1.8649 & 2.6625 & 1.7466 & 1.6240 & 2.1109 &
1.8806 & 1.6189 & 1.8466 & 1.6684 \\
1928-12-31 & 1.9391 & 2.1740 & 2.2007 & 1.9249 & 2.1844 & 1.5118 &
0.8999 & 1.6722 & 1.3630 & 0.9255 \\
1929-12-31 & -0.6050 & -0.1397 & -0.2468 & -0.1714 & 0.0009 & -0.0349 &
-0.0684 & -0.3532 & -0.2792 & -0.6170 \\
1930-12-31 & -0.9699 & -0.7385 & -1.0907 & -1.3742 & -1.3992 & -1.6457 &
-2.3018 & -2.0655 & -2.3736 & -2.1651 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2020-12-31 & 1.2642 & 0.9832 & 0.7613 & 0.5393 & 0.3628 & 0.3973 &
-0.2304 & 0.1787 & 0.2889 & 0.0857 \\
2021-12-31 & 1.2897 & 1.5796 & 1.9168 & 1.2979 & 0.9096 & 1.7713 &
1.4385 & 1.8281 & 1.5998 & 1.6404 \\
2022-12-31 & -0.9784 & -0.9260 & -0.7957 & -0.3773 & -0.4495 & -0.6664 &
-0.0463 & 0.3953 & 0.0366 & -0.0862 \\
2023-12-31 & 2.1571 & 1.2488 & 1.2150 & 0.0623 & 0.5575 & 0.8493 &
0.4359 & 0.3561 & 0.7679 & 0.1911 \\
2024-12-31 & 1.5795 & 0.9882 & -0.3949 & -2.2775 & 2.1697 & 1.7894 &
1.6911 & -3.1931 & -2.2544 & -0.2785 \\
\end{longtable}

The annual data are noisy, because \(r_i - r_f\) and \(\sigma_i\) in a
given year are poor estimates of the expected excess return and
volatility. A crude solution is to aggregate these data over the full
sample. We see that there is not a clear trend for the Sharpe ratio
acress these portfolios. We will revisit this when we learn the CAPM in
a few weeks!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{) }\CommentTok{\# daily excess returns}
\NormalTok{    .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: np.sqrt(}\DecValTok{252}\NormalTok{) }\OperatorTok{*}\NormalTok{ x.mean() }\OperatorTok{/}\NormalTok{ x.std()) }\CommentTok{\# calculate Sharpe ratios}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Sharpe Ratio\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Sharpe Ratios of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_02_files/figure-pdf/cell-19-output-1.png}

\subsection{Calculate rolling betas}\label{calculate-rolling-betas}

Calculate rolling capital asset pricing model (CAPM) betas for the
\st{MATANA stocks} ten portfolios formed on B/M.

The CAPM says the risk premium on a stock depends on the risk-free rate,
beta, and the risk premium on the market:
\(E(r_i) = r_f + \beta_i \times (E(r_M) - r_f)\). We can calculate CAPM
betas as:
\(\beta_i = \frac{Cov(r_i - r_f, r_M - r_f)}{Var(r_M - r_f)}\). To speed
up our calculations, we can use the rolling-optimized covariance and
variance methods to calculate the numerator and denominator,
respectively, then divide them to calculate beta.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{beta\_top }\OperatorTok{=}\NormalTok{ be\_me\_vw.sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{).rolling(}\DecValTok{252}\OperatorTok{*}\DecValTok{3}\NormalTok{).cov(ff[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{])}
\NormalTok{beta\_bottom }\OperatorTok{=}\NormalTok{ ff[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{].rolling(}\DecValTok{252}\OperatorTok{*}\DecValTok{3}\NormalTok{).var()}
\NormalTok{beta }\OperatorTok{=}\NormalTok{ beta\_top.div(beta\_bottom, axis}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{beta.plot()}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Rolling 3{-}Year Beta\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Rolling 3{-}Year Betas of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_02_files/figure-pdf/cell-20-output-1.png}

\subsection{Calculate rolling Sharpe
Ratios}\label{calculate-rolling-sharpe-ratios}

Calculate rolling Sharpe Ratios for the \st{MATANA stocks} ten
portfolios formed on B/M.

We can copy our Sharpe ratio plot code above, and (1) add a
\texttt{.rolling()} method before we \texttt{.apply()} the Sharpe ratio
formula, and then (2) remove
\texttt{kind=\textquotesingle{}bar\textquotesingle{}} from our
\texttt{.plot()} method.

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%\%}\NormalTok{time}
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{) }\CommentTok{\# daily excess returns}
\NormalTok{    .rolling(}\DecValTok{3}\OperatorTok{*}\DecValTok{252}\NormalTok{)}
\NormalTok{    .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: np.sqrt(}\DecValTok{252}\NormalTok{) }\OperatorTok{*}\NormalTok{ x.mean() }\OperatorTok{/}\NormalTok{ x.std()) }\CommentTok{\# calculate Sharpe ratios}
\NormalTok{    .plot()}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Rolling 3{-}Year Sharpe Ratio\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Rolling 3{-}Year Sharpe Ratios of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_02_files/figure-pdf/cell-21-output-1.png}

\begin{verbatim}
CPU times: total: 44 s
Wall time: 44.1 s
\end{verbatim}

But the code above is slow because the \texttt{.apply()} method is not
rolling-optimized! We can speed up our code by using the
rolling-optimized \texttt{.mean()} and \texttt{.std()} methods.

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%\%}\NormalTok{time}

\NormalTok{sharpe\_top }\OperatorTok{=}\NormalTok{ be\_me\_vw.sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{).rolling(}\DecValTok{3}\OperatorTok{*}\DecValTok{252}\NormalTok{).mean()}
\NormalTok{sharpe\_bottom }\OperatorTok{=}\NormalTok{ be\_me\_vw.sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{).rolling(}\DecValTok{3}\OperatorTok{*}\DecValTok{252}\NormalTok{).std()}
\NormalTok{sharpe }\OperatorTok{=}\NormalTok{ sharpe\_top.div(sharpe\_bottom, axis}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{sharpe.plot()}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Rolling 3{-}Year Sharpe Ratio\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Rolling 3{-}Year Sharpe Ratios of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_02_files/figure-pdf/cell-22-output-1.png}

\begin{verbatim}
CPU times: total: 2.06 s
Wall time: 2.06 s
\end{verbatim}

\chapter{McKinney Chapter 11 - Practice for Section
03}\label{mckinney-chapter-11---practice-for-section-03}

\section{Announcements}\label{announcements-29}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  I finished grading Project 1

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Before peer reviews, the median grade is 84\% (mean is 84.4\%)
  \item
    Assuming perfect peer reviews, the median grade is 87\% (mean is
    87.1\%)
  \item
    Peer review scores on Canvas are the median peer review scores on
    Teammates because medians ignore outliers
  \item
    97.1\% of students received perfect peer review scores
  \item
    Only 1.2\% of students received peer review scores less than 90\%
  \item
    I posted a barebones solution to the Project 1 assignment page on
    Canvas
  \end{enumerate}
\item
  10,000 XP on DataCamp

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Due by Fri5ay, 3/16, at 11:59 PM
  \item
    Upload a screenshot of your DataCamp profile page with XP to Canvas
  \end{enumerate}
\item
  I will post Project 2 by Thursday morning and we will discuss it on
  Thursday and Friday
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-28}

The time-series functionality in pandas is fantastic! Here are the three
main tools we will use:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \texttt{.shift()} method

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    The \texttt{.shift()} method is used to shift the index of a
    DataFrame by a specified number of periods.
  \item
    It is useful for calculating percentage changes, differences between
    time periods, and other time series calculations.
  \item
    The method can be used to shift both forward and backward in time.
  \end{enumerate}
\item
  \texttt{.resample()} method

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    The \texttt{.resample()} method is used to resample time-series
    data.
  \item
    It is used to convert time series data from one frequency to
    another.
  \item
    The method can be used to upsample (increase the frequency of the
    data) or downsample (decrease the frequency of the data).
  \end{enumerate}
\item
  \texttt{.rolling()} method

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    The \texttt{.rolling()} method is used to perform rolling window
    calculations on sequential data.
  \item
    A rolling window is a fixed-size interval or subset of data that
    moves sequentially through a larger dataset.
  \item
    The method is useful for calculating moving averages, standard
    deviations, and other rolling window calculations.
  \end{enumerate}
\end{enumerate}

\section{Practice}\label{practice-29}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{Download daily returns for ten portfolios formed on
book-to-market
ratios}\label{download-daily-returns-for-ten-portfolios-formed-on-book-to-market-ratios-1}

We can use a list comprehension with an \texttt{if} statement to find
the name of the file with portfolios formed on book-to-market ratios.
Book-to-market ratios are also called B/M ratios, and French includes
``Portfolios'' and ``BE-ME'' in the files with these portfolio returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{[x }\ControlFlowTok{for}\NormalTok{ x }\KeywordTok{in}\NormalTok{ pdr.famafrench.get\_available\_datasets() }\ControlFlowTok{if}\NormalTok{ (}\StringTok{\textquotesingle{}Portfolios\textquotesingle{}} \KeywordTok{in}\NormalTok{ x) }\KeywordTok{and}\NormalTok{ (}\StringTok{\textquotesingle{}BE{-}ME\textquotesingle{}} \KeywordTok{in}\NormalTok{ x)][:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['Portfolios_Formed_on_BE-ME',
 'Portfolios_Formed_on_BE-ME_Wout_Div',
 'Portfolios_Formed_on_BE-ME_Daily',
 'Developed_6_Portfolios_ME_BE-ME',
 'Developed_6_Portfolios_ME_BE-ME_daily']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{be\_me\_all }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolios\_Formed\_on\_BE{-}ME\_Daily\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_8852\616375102.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  be_me_all = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_8852\616375102.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  be_me_all = pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(be\_me\_all[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Portfolios Formed on BE-ME Daily
--------------------------------

This file was created by CMPT_BEME_RETS_DAILY using the 202401 CRSP database. It contains value- and equal-weighted returns for portfolios formed on BE/ME. The portfolios are constructed at the end of June. BE/ME is book equity at the last fiscal year end of the prior calendar year divided by ME at the end of December of the prior year. The annual returns are from January to December. Missing data are indicated by -99.99 or -999. The break points use Compustat firms plus the firms hand-collected from the Moodys Industrial, Utilities, Transportation, and Financial Manuals. The break points include utilities. The portfolios use Compustat firms plus the firms hand-collected from the Moodys Industrial, Utilities, Transportation, and Financial Manuals. The portfolios include utilities.

  0 : Value Weighted Returns -- Daily (25670 rows x 19 cols)
  1 : Equal Weighted Returns -- Daily (25670 rows x 19 cols)
\end{verbatim}

The value for the ``DESCR'' key shows how French creates these data
(i.e., he forms portfolios at the end of every June) and what each data
frame contains. The 0 key selects returns on value-weighted portfolios,
and the 1 key selects returns on equal-weighted portfolios.

Each data frame has several groups of portfolios:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The first column provides the returns on a portfolio of negative book
  equity stocks. The next 18 columns split the positive book equity
  stocks into 3, 5, and 10 portfolios based on their B/M ranks.
\item
  The next 3 columns provide 3 portfolios split on the 30th and 70th
  percentiles of B/M.
\item
  The next 5 columns provide 5 portfolios split on the 20th, 40th, 60th,
  and 80th percentiles of B/M (i.e., quintiles).
\item
  The last 10 columns provide 10 portfolios split on the 10th, 20th,
  \ldots, and 90th percentiles of B/M (i.e., deciles).
\end{enumerate}

We can assign the value-weighted B/M-decile portfolio returns to data
frame \texttt{be\_me\_vw}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{be\_me\_vw }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    be\_me\_all }\CommentTok{\# all portfolio returns}
\NormalTok{    [}\DecValTok{0}\NormalTok{] }\CommentTok{\# select the value{-}weighted portfolio returns}
\NormalTok{    .iloc[:, }\OperatorTok{{-}}\DecValTok{10}\NormalTok{:] }\CommentTok{\# slice the rightmost ten columns}
\NormalTok{    .div(}\DecValTok{100}\NormalTok{) }\CommentTok{\# convert from percent to decimal}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{) }\CommentTok{\# label columns for easy plots}
\NormalTok{)}

\NormalTok{be\_me\_vw}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
Portfolio & Lo 10 & Dec 2 & Dec 3 & Dec 4 & Dec 5 & Dec 6 & Dec 7 & Dec
8 & Dec 9 & Hi 10 \\
Date & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1926-07-01 & 0.0014 & 0.0044 & -0.0012 & 0.0009 & 0.0019 & 0.0038 &
-0.0032 & -0.0011 & 0.0028 & -0.0044 \\
1926-07-02 & 0.0044 & 0.0043 & 0.0066 & 0.0044 & 0.0061 & 0.0015 &
0.0061 & 0.0019 & 0.0044 & -0.0011 \\
1926-07-06 & 0.0037 & 0.0000 & 0.0054 & 0.0027 & 0.0007 & 0.0004 &
-0.0002 & -0.0043 & 0.0016 & 0.0012 \\
1926-07-07 & -0.0004 & -0.0003 & 0.0032 & 0.0032 & 0.0001 & 0.0020 &
-0.0023 & 0.0059 & 0.0053 & -0.0030 \\
1926-07-08 & 0.0067 & -0.0003 & 0.0030 & 0.0038 & -0.0009 & 0.0027 &
-0.0003 & 0.0057 & 0.0025 & 0.0073 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2024-01-25 & -0.0023 & 0.0071 & 0.0120 & 0.0082 & 0.0100 & 0.0115 &
0.0117 & 0.0095 & 0.0092 & 0.0146 \\
2024-01-26 & -0.0031 & 0.0044 & 0.0016 & -0.0003 & 0.0026 & 0.0023 &
0.0039 & 0.0073 & -0.0148 & 0.0067 \\
2024-01-29 & 0.0110 & 0.0078 & 0.0094 & 0.0088 & 0.0095 & 0.0048 &
0.0029 & 0.0079 & 0.0076 & 0.0085 \\
2024-01-30 & -0.0025 & -0.0051 & -0.0034 & -0.0014 & 0.0030 & 0.0014 &
0.0070 & 0.0007 & 0.0049 & 0.0105 \\
2024-01-31 & -0.0169 & -0.0134 & -0.0383 & -0.0142 & -0.0158 & -0.0127 &
-0.0121 & -0.0189 & -0.0182 & -0.0197 \\
\end{longtable}

We can easily visualize these portfolio returns with the arithmetic and
geometric means of these portfolio returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .mean() }\CommentTok{\# arithmetic mean}
\NormalTok{    .mul(}\DecValTok{252}\NormalTok{) }\CommentTok{\# annualize}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{) }\CommentTok{\# convert to percent}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Arithmetic Means of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_03_files/figure-pdf/cell-8-output-1.png}

In finance, we often call the annualized geometric mean the ``compounded
annualized growth rate'' or ``CAGR''. The geoemetric mean of daily
returns is
\(1 + r_{geom} = \left[ \prod_{t}^T (1+r_t) \right]^{\frac{1}{T}}\),
where \(r_t\) is the return on day \(t\). The CAGR is the annualized
geometric mean of daily returns, so \(1 + CAGR = (1 + r_{geom})^{252}\)
and \(CAGR = \left[ \prod_{t}^T (1+r_t) \right]^{\frac{252}{T}} - 1\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: (}\DecValTok{1} \OperatorTok{+}\NormalTok{ x).prod()}\OperatorTok{**}\NormalTok{(}\DecValTok{252} \OperatorTok{/}\NormalTok{ x.count()) }\OperatorTok{{-}} \DecValTok{1}\NormalTok{) }\CommentTok{\# annualized geometric mean or CAGR}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{) }\CommentTok{\# convert to percent}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}CAGR of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Geometric Means of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_03_files/figure-pdf/cell-9-output-1.png}

\subsection{Calculate cumulative returns with all available
data}\label{calculate-cumulative-returns-with-all-available-data-1}

We have done calculations and plots of cumulative returns for several
weeks, and these do not use the \texttt{.shift()}, \texttt{.resample()},
or \texttt{.rolling()} methods.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod() }\CommentTok{\# compound cumulative returns}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{) }\CommentTok{\# convert to percent}
\NormalTok{    .plot()}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Cumulative Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Cumulative Returns of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_03_files/figure-pdf/cell-10-output-1.png}

\subsection{Calculate total returns for each calendar
year}\label{calculate-total-returns-for-each-calendar-year-1}

We use the \texttt{.resample()} method to downsample our daily returns
to annual returns. Note that we must \texttt{.add(1)} to our returns
\emph{before} we \texttt{.resample()} because we can only associate one
method with the resampling. We could \texttt{.apply()} a lambda function
that does the compounding one step, but optimized methods like
\texttt{.prod()} are generally faster than \texttt{.apply()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{) }\CommentTok{\# must add 1 before .resample()}
\NormalTok{    .resample(rule}\OperatorTok{=}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{, kind}\OperatorTok{=}\StringTok{\textquotesingle{}period\textquotesingle{}}\NormalTok{) }\CommentTok{\# down sample to annual periods}
\NormalTok{    .prod() }\CommentTok{\# use product to compound (1+r)s each year}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{) }\CommentTok{\# subtract 1 after compounding}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
Portfolio & Lo 10 & Dec 2 & Dec 3 & Dec 4 & Dec 5 & Dec 6 & Dec 7 & Dec
8 & Dec 9 & Hi 10 \\
Date & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1926 & 0.0819 & 0.0309 & 0.2793 & 0.0899 & 0.0248 & 0.0825 & 0.1265 &
0.1038 & 0.0510 & 0.0958 \\
1927 & 0.5773 & 0.2518 & 0.4298 & 0.2015 & 0.2041 & 0.2611 & 0.2832 &
0.2471 & 0.3844 & 0.4825 \\
1928 & 0.4880 & 0.4965 & 0.3961 & 0.3724 & 0.4677 & 0.2581 & 0.1484 &
0.3331 & 0.3740 & 0.2668 \\
1929 & -0.2691 & -0.0844 & -0.1469 & -0.0664 & -0.0039 & -0.0147 &
-0.0096 & -0.0830 & -0.0830 & -0.2550 \\
1930 & -0.2911 & -0.2067 & -0.2679 & -0.2757 & -0.2531 & -0.3514 &
-0.3858 & -0.4110 & -0.5280 & -0.5669 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2020 & 0.4815 & 0.3129 & 0.2160 & 0.1451 & 0.0720 & 0.0862 & -0.1662 &
-0.0139 & 0.0187 & -0.1113 \\
2021 & 0.2373 & 0.2334 & 0.2867 & 0.1776 & 0.1296 & 0.3196 & 0.2543 &
0.3685 & 0.3981 & 0.4465 \\
2022 & -0.2962 & -0.2218 & -0.1847 & -0.0814 & -0.1003 & -0.1435 &
-0.0183 & 0.0804 & -0.0044 & -0.0418 \\
2023 & 0.4777 & 0.2459 & 0.2325 & 0.0482 & 0.1235 & 0.1728 & 0.1047 &
0.1004 & 0.1900 & 0.0679 \\
2024 & 0.0233 & 0.0128 & -0.0023 & -0.0177 & 0.0251 & 0.0217 & 0.0205 &
-0.0380 & -0.0273 & -0.0006 \\
\end{longtable}

\subsection{Calculate total returns over rolling 252-trading-day
windows}\label{calculate-total-returns-over-rolling-252-trading-day-windows-1}

We specify the window as an integer (252 observations), so the
\texttt{.rolling()} method defaults the \texttt{min\_periods} argument
to the same integer (252 observations). As a result, the
\texttt{.rolling()} method needs a minimum of 252 periods before it
applies our function, and the first 251 observations are missing below.
Also, pandas does not provide a \texttt{.prod()} method that works with
the \texttt{.rolling()} method, so we must manually perform this
calculation with \texttt{.apply()}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%\%}\NormalTok{time}
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .rolling(}\DecValTok{252}\NormalTok{) }\CommentTok{\# 252 observation window, because integer window, min\_periods default to size of the observation window}
\NormalTok{    .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: (}\DecValTok{1} \OperatorTok{+}\NormalTok{ x).prod() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
CPU times: total: 35.4 s
Wall time: 35.6 s
\end{verbatim}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
Portfolio & Lo 10 & Dec 2 & Dec 3 & Dec 4 & Dec 5 & Dec 6 & Dec 7 & Dec
8 & Dec 9 & Hi 10 \\
Date & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1926-07-01 & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN &
NaN \\
1926-07-02 & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN &
NaN \\
1926-07-06 & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN &
NaN \\
1926-07-07 & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN &
NaN \\
1926-07-08 & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN &
NaN \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2024-01-25 & 0.4283 & 0.1999 & 0.2334 & 0.0122 & 0.1062 & 0.1216 &
0.0914 & 0.0258 & 0.1398 & 0.0170 \\
2024-01-26 & 0.4259 & 0.2146 & 0.2414 & 0.0057 & 0.1024 & 0.1210 &
0.0881 & 0.0324 & 0.1124 & 0.0172 \\
2024-01-29 & 0.4193 & 0.2097 & 0.2476 & 0.0104 & 0.1059 & 0.1156 &
0.0816 & 0.0186 & 0.1188 & 0.0173 \\
2024-01-30 & 0.4024 & 0.1952 & 0.2390 & 0.0097 & 0.1119 & 0.1184 &
0.0901 & 0.0297 & 0.1249 & 0.0298 \\
2024-01-31 & 0.4051 & 0.1969 & 0.2049 & 0.0057 & 0.1041 & 0.1161 &
0.0857 & 0.0254 & 0.1104 & 0.0161 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%\%}\NormalTok{time}
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .pipe(np.log1p)}
\NormalTok{    .rolling(}\DecValTok{252}\NormalTok{) }\CommentTok{\# 252 observation window, because integer window, min\_periods default to size of the observation window}
\NormalTok{    .}\BuiltInTok{sum}\NormalTok{()}
\NormalTok{    .pipe(np.expm1)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
CPU times: total: 15.6 ms
Wall time: 19.9 ms
\end{verbatim}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
Portfolio & Lo 10 & Dec 2 & Dec 3 & Dec 4 & Dec 5 & Dec 6 & Dec 7 & Dec
8 & Dec 9 & Hi 10 \\
Date & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1926-07-01 & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN &
NaN \\
1926-07-02 & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN &
NaN \\
1926-07-06 & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN &
NaN \\
1926-07-07 & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN &
NaN \\
1926-07-08 & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN &
NaN \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2024-01-25 & 0.4283 & 0.1999 & 0.2334 & 0.0122 & 0.1062 & 0.1216 &
0.0914 & 0.0258 & 0.1398 & 0.0170 \\
2024-01-26 & 0.4259 & 0.2146 & 0.2414 & 0.0057 & 0.1024 & 0.1210 &
0.0881 & 0.0324 & 0.1124 & 0.0172 \\
2024-01-29 & 0.4193 & 0.2097 & 0.2476 & 0.0104 & 0.1059 & 0.1156 &
0.0816 & 0.0186 & 0.1188 & 0.0173 \\
2024-01-30 & 0.4024 & 0.1952 & 0.2390 & 0.0097 & 0.1119 & 0.1184 &
0.0901 & 0.0297 & 0.1249 & 0.0298 \\
2024-01-31 & 0.4051 & 0.1969 & 0.2049 & 0.0057 & 0.1041 & 0.1161 &
0.0857 & 0.0254 & 0.1104 & 0.0161 \\
\end{longtable}

\subsection{Calculate total returns over rolling 12-months windows after
calculating monthly
returns}\label{calculate-total-returns-over-rolling-12-months-windows-after-calculating-monthly-returns-1}

Since log returns are much faster with the \texttt{.rolling()} method,
we will:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Calculate log returns first
\item
  Resample daily returns to monthly returns
\item
  Calculate rolling returns over 12-month rolling windows
\item
  Calculate simple returns last
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .pipe(np.log1p) }\CommentTok{\# calculate log returns}
\NormalTok{    .resample(}\StringTok{\textquotesingle{}m\textquotesingle{}}\NormalTok{) }\CommentTok{\# downsample returns from daily to monthly}
\NormalTok{    .}\BuiltInTok{sum}\NormalTok{() }\CommentTok{\# after this sum, we have monthly log returns}
\NormalTok{    .rolling(}\DecValTok{12}\NormalTok{) }\CommentTok{\# rolling 12{-}month windows}
\NormalTok{    .}\BuiltInTok{sum}\NormalTok{() }\CommentTok{\# after this sum, we have rolling 12{-}month returns}
\NormalTok{    .pipe(np.expm1) }\CommentTok{\# calculate simple returns}
\NormalTok{    .dropna()}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{) }\CommentTok{\# convert to percent}
\NormalTok{    .plot()}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Rolling 12{-}Month Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Rolling 12{-}Month Returns of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_03_files/figure-pdf/cell-14-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .pipe(np.log1p) }\CommentTok{\# calculate log returns}
\NormalTok{    .resample(}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{)}
\NormalTok{    .}\BuiltInTok{sum}\NormalTok{() }\CommentTok{\# after this sum, we have monthly log returns}
\NormalTok{    .rolling(}\DecValTok{30} \OperatorTok{*} \DecValTok{12}\NormalTok{) }\CommentTok{\# rolling 30{-}year windows}
\NormalTok{    .}\BuiltInTok{sum}\NormalTok{() }\CommentTok{\# after this sum, we have rolling 12{-}month log returns}
\NormalTok{    .pipe(np.expm1) }\CommentTok{\# calculate simple returns}
\NormalTok{    .dropna()}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{) }\CommentTok{\# convert to percent}
\NormalTok{    .plot()}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Rolling 30{-}Year Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Rolling 30{-}Year Returns of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_03_files/figure-pdf/cell-15-output-1.png}

\subsection{Calculate Sharpe Ratios for each calendar
year}\label{calculate-sharpe-ratios-for-each-calendar-year-1}

Above we download the risk-free rate from Ken French's website, which we
need to calculate Sharpe ratios! The Sharpe Ratio is
\(S_i = \frac{\overline{r_i - r_f}}{\sigma_i}\), where
\(\overline{r_i-r_f}\) is mean fund return relative to the risk-free
rate over some period and \(\sigma_i\) is the standard deviation of
\(r_i-r_f\) over the same period.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_all }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}

\NormalTok{ff }\OperatorTok{=}\NormalTok{ ff\_all[}\DecValTok{0}\NormalTok{].div(}\DecValTok{100}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_8852\2778589428.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_all = pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{) }\CommentTok{\# daily excess returns}
\NormalTok{    .resample(}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{) }\CommentTok{\# downsample to annual}
\NormalTok{    .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: np.sqrt(}\DecValTok{252}\NormalTok{) }\OperatorTok{*}\NormalTok{ x.mean() }\OperatorTok{/}\NormalTok{ x.std()) }\CommentTok{\# calculate Sharpe ratios}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
Portfolio & Lo 10 & Dec 2 & Dec 3 & Dec 4 & Dec 5 & Dec 6 & Dec 7 & Dec
8 & Dec 9 & Hi 10 \\
Date & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1926-12-31 & 1.0443 & 0.3296 & 2.4042 & 1.9237 & 0.2085 & 1.3751 &
1.4400 & 1.3200 & 0.5276 & 1.0035 \\
1927-12-31 & 3.2226 & 1.8649 & 2.6625 & 1.7466 & 1.6240 & 2.1109 &
1.8806 & 1.6189 & 1.8466 & 1.6684 \\
1928-12-31 & 1.9391 & 2.1740 & 2.2007 & 1.9249 & 2.1844 & 1.5118 &
0.8999 & 1.6722 & 1.3630 & 0.9255 \\
1929-12-31 & -0.6050 & -0.1397 & -0.2468 & -0.1714 & 0.0009 & -0.0349 &
-0.0684 & -0.3532 & -0.2792 & -0.6170 \\
1930-12-31 & -0.9699 & -0.7385 & -1.0907 & -1.3742 & -1.3992 & -1.6457 &
-2.3018 & -2.0655 & -2.3736 & -2.1651 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2020-12-31 & 1.2642 & 0.9832 & 0.7613 & 0.5393 & 0.3628 & 0.3973 &
-0.2304 & 0.1787 & 0.2889 & 0.0857 \\
2021-12-31 & 1.2897 & 1.5796 & 1.9168 & 1.2979 & 0.9096 & 1.7713 &
1.4385 & 1.8281 & 1.5998 & 1.6404 \\
2022-12-31 & -0.9784 & -0.9260 & -0.7957 & -0.3773 & -0.4495 & -0.6664 &
-0.0463 & 0.3953 & 0.0366 & -0.0862 \\
2023-12-31 & 2.1571 & 1.2488 & 1.2150 & 0.0623 & 0.5575 & 0.8493 &
0.4359 & 0.3561 & 0.7679 & 0.1911 \\
2024-12-31 & 1.5795 & 0.9882 & -0.3949 & -2.2775 & 2.1697 & 1.7894 &
1.6911 & -3.1931 & -2.2544 & -0.2785 \\
\end{longtable}

The annual data are noisy, because \(r_i - r_f\) and \(\sigma_i\) in a
given year are poor estimates of the expected excess return and
volatility. A crude solution is to aggregate these data over the full
sample. We see that there is not a clear trend for the Sharpe ratio
acress these portfolios. We will revisit this when we learn the CAPM in
a few weeks!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{) }\CommentTok{\# daily excess returns}
\NormalTok{    .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: np.sqrt(}\DecValTok{252}\NormalTok{) }\OperatorTok{*}\NormalTok{ x.mean() }\OperatorTok{/}\NormalTok{ x.std()) }\CommentTok{\# calculate Sharpe ratios}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Sharpe Ratio\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Sharpe Ratios of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_03_files/figure-pdf/cell-18-output-1.png}

\subsection{Calculate rolling betas}\label{calculate-rolling-betas-1}

Calculate rolling capital asset pricing model (CAPM) betas for the
\st{MATANA stocks} ten portfolios formed on B/M.

The CAPM says the risk premium on a stock depends on the risk-free rate,
beta, and the risk premium on the market:
\(E(r_i) = r_f + \beta_i \times (E(r_M) - r_f)\). We can calculate CAPM
betas as:
\(\beta_i = \frac{Cov(r_i - r_f, r_M - r_f)}{Var(r_M - r_f)}\). To speed
up our calculations, we can use the rolling-optimized covariance and
variance methods to calculate the numerator and denominator,
respectively, then divide them to calculate beta.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{beta\_top }\OperatorTok{=}\NormalTok{ be\_me\_vw.sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{).rolling(}\DecValTok{252}\OperatorTok{*}\DecValTok{3}\NormalTok{).cov(ff[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{])}
\NormalTok{beta\_bottom }\OperatorTok{=}\NormalTok{ ff[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{].rolling(}\DecValTok{252}\OperatorTok{*}\DecValTok{3}\NormalTok{).var()}
\NormalTok{beta }\OperatorTok{=}\NormalTok{ beta\_top.div(beta\_bottom, axis}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{beta.plot()}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Rolling 3{-}Year Beta\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Rolling 3{-}Year Betas of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_03_files/figure-pdf/cell-19-output-1.png}

\subsection{Calculate rolling Sharpe
Ratios}\label{calculate-rolling-sharpe-ratios-1}

Calculate rolling Sharpe Ratios for the \st{MATANA stocks} ten
portfolios formed on B/M.

We can copy our Sharpe ratio plot code above, and (1) add a
\texttt{.rolling()} method before we \texttt{.apply()} the Sharpe ratio
formula, and then (2) remove
\texttt{kind=\textquotesingle{}bar\textquotesingle{}} from our
\texttt{.plot()} method.

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%\%}\NormalTok{time}
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{) }\CommentTok{\# daily excess returns}
\NormalTok{    .rolling(}\DecValTok{3}\OperatorTok{*}\DecValTok{252}\NormalTok{)}
\NormalTok{    .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: np.sqrt(}\DecValTok{252}\NormalTok{) }\OperatorTok{*}\NormalTok{ x.mean() }\OperatorTok{/}\NormalTok{ x.std()) }\CommentTok{\# calculate Sharpe ratios}
\NormalTok{    .plot()}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Rolling 3{-}Year Sharpe Ratio\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Rolling 3{-}Year Sharpe Ratios of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_03_files/figure-pdf/cell-20-output-1.png}

\begin{verbatim}
CPU times: total: 45.6 s
Wall time: 45.7 s
\end{verbatim}

But the code above is slow because the \texttt{.apply()} method is not
rolling-optimized! We can speed up our code by using the
rolling-optimized \texttt{.mean()} and \texttt{.std()} methods.

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%\%}\NormalTok{time}

\NormalTok{sharpe\_top }\OperatorTok{=}\NormalTok{ be\_me\_vw.sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{).rolling(}\DecValTok{3}\OperatorTok{*}\DecValTok{252}\NormalTok{).mean()}
\NormalTok{sharpe\_bottom }\OperatorTok{=}\NormalTok{ be\_me\_vw.sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{).rolling(}\DecValTok{3}\OperatorTok{*}\DecValTok{252}\NormalTok{).std()}
\NormalTok{sharpe }\OperatorTok{=}\NormalTok{ sharpe\_top.div(sharpe\_bottom, axis}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{sharpe.plot()}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Rolling 3{-}Year Sharpe Ratio\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Rolling 3{-}Year Sharpe Ratios of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_03_files/figure-pdf/cell-21-output-1.png}

\begin{verbatim}
CPU times: total: 1.69 s
Wall time: 1.68 s
\end{verbatim}

\chapter{McKinney Chapter 11 - Practice for Section
04}\label{mckinney-chapter-11---practice-for-section-04}

\section{Announcements}\label{announcements-30}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  I finished grading Project 1

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Before peer reviews, the median grade is 84\% (mean is 84.4\%)
  \item
    Assuming perfect peer reviews, the median grade is 87\% (mean is
    87.1\%)
  \item
    Peer review scores on Canvas are the median peer review scores on
    Teammates because medians ignore outliers
  \item
    97.1\% of students received perfect peer review scores
  \item
    Only 1.2\% of students received peer review scores less than 90\%
  \item
    I posted a barebones solution to the Project 1 assignment page on
    Canvas
  \end{enumerate}
\item
  10,000 XP on DataCamp

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Due by Fri5ay, 3/16, at 11:59 PM
  \item
    Upload a screenshot of your DataCamp profile page with XP to Canvas
  \end{enumerate}
\item
  I will post Project 2 by Thursday morning and we will discuss it on
  Thursday and Friday
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-29}

The time-series functionality in pandas is fantastic! Here are the three
main tools we will use:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \texttt{.shift()} method

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    The \texttt{.shift()} method is used to shift the index of a
    DataFrame by a specified number of periods.
  \item
    It is useful for calculating percentage changes, differences between
    time periods, and other time series calculations.
  \item
    The method can be used to shift both forward and backward in time.
  \end{enumerate}
\item
  \texttt{.resample()} method

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    The \texttt{.resample()} method is used to resample time-series
    data.
  \item
    It is used to convert time series data from one frequency to
    another.
  \item
    The method can be used to upsample (increase the frequency of the
    data) or downsample (decrease the frequency of the data).
  \end{enumerate}
\item
  \texttt{.rolling()} method

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    The \texttt{.rolling()} method is used to perform rolling window
    calculations on sequential data.
  \item
    A rolling window is a fixed-size interval or subset of data that
    moves sequentially through a larger dataset.
  \item
    The method is useful for calculating moving averages, standard
    deviations, and other rolling window calculations.
  \end{enumerate}
\end{enumerate}

\section{Practice}\label{practice-30}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{Download daily returns for ten portfolios formed on
book-to-market
ratios}\label{download-daily-returns-for-ten-portfolios-formed-on-book-to-market-ratios-2}

We can use a list comprehension with an \texttt{if} statement to find
the name of the file with portfolios formed on book-to-market ratios.
Book-to-market ratios are also called B/M ratios, and French includes
``Portfolios'' and ``BE-ME'' in the files with these portfolio returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{[x }\ControlFlowTok{for}\NormalTok{ x }\KeywordTok{in}\NormalTok{ pdr.famafrench.get\_available\_datasets() }\ControlFlowTok{if}\NormalTok{ (}\StringTok{\textquotesingle{}Portfolios\textquotesingle{}} \KeywordTok{in}\NormalTok{ x) }\KeywordTok{and}\NormalTok{ (}\StringTok{\textquotesingle{}BE{-}ME\textquotesingle{}} \KeywordTok{in}\NormalTok{ x)][:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['Portfolios_Formed_on_BE-ME',
 'Portfolios_Formed_on_BE-ME_Wout_Div',
 'Portfolios_Formed_on_BE-ME_Daily',
 'Developed_6_Portfolios_ME_BE-ME',
 'Developed_6_Portfolios_ME_BE-ME_daily']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{be\_me\_all }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolios\_Formed\_on\_BE{-}ME\_Daily\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1776\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_11496\704972123.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  be_me_all = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_11496\704972123.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  be_me_all = pdr.DataReader(
\end{verbatim}

The value for the ``DESCR'' key shows how French creates these data
(i.e., he forms portfolios at the end of every June) and what each data
frame contains. The 0 key selects returns on value-weighted portfolios,
and the 1 key selects returns on equal-weighted portfolios.

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(be\_me\_all[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Portfolios Formed on BE-ME Daily
--------------------------------

This file was created by CMPT_BEME_RETS_DAILY using the 202401 CRSP database. It contains value- and equal-weighted returns for portfolios formed on BE/ME. The portfolios are constructed at the end of June. BE/ME is book equity at the last fiscal year end of the prior calendar year divided by ME at the end of December of the prior year. The annual returns are from January to December. Missing data are indicated by -99.99 or -999. The break points use Compustat firms plus the firms hand-collected from the Moodys Industrial, Utilities, Transportation, and Financial Manuals. The break points include utilities. The portfolios use Compustat firms plus the firms hand-collected from the Moodys Industrial, Utilities, Transportation, and Financial Manuals. The portfolios include utilities.

  0 : Value Weighted Returns -- Daily (25670 rows x 19 cols)
  1 : Equal Weighted Returns -- Daily (25670 rows x 19 cols)
\end{verbatim}

Each data frame has several groups of portfolios:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The first column provides the returns on a portfolio of negative book
  equity stocks. The next 18 columns split the positive book equity
  stocks into 3, 5, and 10 portfolios based on their B/M ranks.
\item
  The next 3 columns provide 3 portfolios split on the 30th and 70th
  percentiles of B/M.
\item
  The next 5 columns provide 5 portfolios split on the 20th, 40th, 60th,
  and 80th percentiles of B/M (i.e., quintiles).
\item
  The last 10 columns provide 10 portfolios split on the 10th, 20th,
  \ldots, and 90th percentiles of B/M (i.e., deciles).
\end{enumerate}

We can assign the value-weighted B/M-decile portfolio returns to data
frame \texttt{be\_me\_vw}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{be\_me\_vw }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    be\_me\_all }\CommentTok{\# all portfolio returns}
\NormalTok{    [}\DecValTok{0}\NormalTok{] }\CommentTok{\# select the value{-}weighted portfolio returns}
\NormalTok{    .iloc[:, }\OperatorTok{{-}}\DecValTok{10}\NormalTok{:] }\CommentTok{\# slice the rightmost ten columns}
\NormalTok{    .div(}\DecValTok{100}\NormalTok{) }\CommentTok{\# convert from percent to decimal}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{) }\CommentTok{\# label columns for easy plots}
\NormalTok{)}

\NormalTok{be\_me\_vw}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
Portfolio & Lo 10 & Dec 2 & Dec 3 & Dec 4 & Dec 5 & Dec 6 & Dec 7 & Dec
8 & Dec 9 & Hi 10 \\
Date & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1926-07-01 & 0.0014 & 0.0044 & -0.0012 & 0.0009 & 0.0019 & 0.0038 &
-0.0032 & -0.0011 & 0.0028 & -0.0044 \\
1926-07-02 & 0.0044 & 0.0043 & 0.0066 & 0.0044 & 0.0061 & 0.0015 &
0.0061 & 0.0019 & 0.0044 & -0.0011 \\
1926-07-06 & 0.0037 & 0.0000 & 0.0054 & 0.0027 & 0.0007 & 0.0004 &
-0.0002 & -0.0043 & 0.0016 & 0.0012 \\
1926-07-07 & -0.0004 & -0.0003 & 0.0032 & 0.0032 & 0.0001 & 0.0020 &
-0.0023 & 0.0059 & 0.0053 & -0.0030 \\
1926-07-08 & 0.0067 & -0.0003 & 0.0030 & 0.0038 & -0.0009 & 0.0027 &
-0.0003 & 0.0057 & 0.0025 & 0.0073 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2024-01-25 & -0.0023 & 0.0071 & 0.0120 & 0.0082 & 0.0100 & 0.0115 &
0.0117 & 0.0095 & 0.0092 & 0.0146 \\
2024-01-26 & -0.0031 & 0.0044 & 0.0016 & -0.0003 & 0.0026 & 0.0023 &
0.0039 & 0.0073 & -0.0148 & 0.0067 \\
2024-01-29 & 0.0110 & 0.0078 & 0.0094 & 0.0088 & 0.0095 & 0.0048 &
0.0029 & 0.0079 & 0.0076 & 0.0085 \\
2024-01-30 & -0.0025 & -0.0051 & -0.0034 & -0.0014 & 0.0030 & 0.0014 &
0.0070 & 0.0007 & 0.0049 & 0.0105 \\
2024-01-31 & -0.0169 & -0.0134 & -0.0383 & -0.0142 & -0.0158 & -0.0127 &
-0.0121 & -0.0189 & -0.0182 & -0.0197 \\
\end{longtable}

We can easily visualize these portfolio returns with the arithmetic and
geometric means of these portfolio returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .mean() }\CommentTok{\# arithmetic mean}
\NormalTok{    .mul(}\DecValTok{252}\NormalTok{) }\CommentTok{\# annualize}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{) }\CommentTok{\# convert to percent}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Arithmetic Means of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_04_files/figure-pdf/cell-8-output-1.png}

In finance, we often call the annualized geometric mean the ``compounded
annualized growth rate'' or ``CAGR''. The geoemetric mean of daily
returns is
\(1 + r_{geom} = \left[ \prod_{t}^T (1+r_t) \right]^{\frac{1}{T}}\),
where \(r_t\) is the return on day \(t\). The CAGR is the annualized
geometric mean of daily returns, so \(1 + CAGR = (1 + r_{geom})^{252}\)
and \(CAGR = \left[ \prod_{t}^T (1+r_t) \right]^{\frac{252}{T}} - 1\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: (}\DecValTok{1} \OperatorTok{+}\NormalTok{ x).prod()}\OperatorTok{**}\NormalTok{(}\DecValTok{252} \OperatorTok{/}\NormalTok{ x.count()) }\OperatorTok{{-}} \DecValTok{1}\NormalTok{) }\CommentTok{\# annualized geometric mean or CAGR}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{) }\CommentTok{\# convert to percent}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}CAGR of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Geometric Means of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_04_files/figure-pdf/cell-9-output-1.png}

\subsection{Calculate cumulative returns with all available
data}\label{calculate-cumulative-returns-with-all-available-data-2}

We have done calculations and plots of cumulative returns for several
weeks, and these do not use the \texttt{.shift()}, \texttt{.resample()},
or \texttt{.rolling()} methods.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod() }\CommentTok{\# compound cumulative returns}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{) }\CommentTok{\# convert to percent}
\NormalTok{    .plot()}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Cumulative Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Cumulative Returns of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_04_files/figure-pdf/cell-10-output-1.png}

\subsection{Calculate total returns for each calendar
year}\label{calculate-total-returns-for-each-calendar-year-2}

We use the \texttt{.resample()} method to downsample our daily returns
to annual returns. Note that we must \texttt{.add(1)} to our returns
\emph{before} we \texttt{.resample()} because we can only associate one
method with the resampling. We could \texttt{.apply()} a lambda function
that does the compounding one step, but optimized methods like
\texttt{.prod()} are generally faster than \texttt{.apply()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{) }\CommentTok{\# must add 1 before .resample()}
\NormalTok{    .resample(rule}\OperatorTok{=}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{, kind}\OperatorTok{=}\StringTok{\textquotesingle{}period\textquotesingle{}}\NormalTok{) }\CommentTok{\# down sample to annual periods}
\NormalTok{    .prod() }\CommentTok{\# use product to compound (1+r)s each year}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{) }\CommentTok{\# subtract 1 after compounding}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
Portfolio & Lo 10 & Dec 2 & Dec 3 & Dec 4 & Dec 5 & Dec 6 & Dec 7 & Dec
8 & Dec 9 & Hi 10 \\
Date & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1926 & 0.0819 & 0.0309 & 0.2793 & 0.0899 & 0.0248 & 0.0825 & 0.1265 &
0.1038 & 0.0510 & 0.0958 \\
1927 & 0.5773 & 0.2518 & 0.4298 & 0.2015 & 0.2041 & 0.2611 & 0.2832 &
0.2471 & 0.3844 & 0.4825 \\
1928 & 0.4880 & 0.4965 & 0.3961 & 0.3724 & 0.4677 & 0.2581 & 0.1484 &
0.3331 & 0.3740 & 0.2668 \\
1929 & -0.2691 & -0.0844 & -0.1469 & -0.0664 & -0.0039 & -0.0147 &
-0.0096 & -0.0830 & -0.0830 & -0.2550 \\
1930 & -0.2911 & -0.2067 & -0.2679 & -0.2757 & -0.2531 & -0.3514 &
-0.3858 & -0.4110 & -0.5280 & -0.5669 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2020 & 0.4815 & 0.3129 & 0.2160 & 0.1451 & 0.0720 & 0.0862 & -0.1662 &
-0.0139 & 0.0187 & -0.1113 \\
2021 & 0.2373 & 0.2334 & 0.2867 & 0.1776 & 0.1296 & 0.3196 & 0.2543 &
0.3685 & 0.3981 & 0.4465 \\
2022 & -0.2962 & -0.2218 & -0.1847 & -0.0814 & -0.1003 & -0.1435 &
-0.0183 & 0.0804 & -0.0044 & -0.0418 \\
2023 & 0.4777 & 0.2459 & 0.2325 & 0.0482 & 0.1235 & 0.1728 & 0.1047 &
0.1004 & 0.1900 & 0.0679 \\
2024 & 0.0233 & 0.0128 & -0.0023 & -0.0177 & 0.0251 & 0.0217 & 0.0205 &
-0.0380 & -0.0273 & -0.0006 \\
\end{longtable}

\subsection{Calculate total returns over rolling 252-trading-day
windows}\label{calculate-total-returns-over-rolling-252-trading-day-windows-2}

We specify the window as an integer (252 observations), so the
\texttt{.rolling()} method defaults the \texttt{min\_periods} argument
to the same integer (252 observations). As a result, the
\texttt{.rolling()} method needs a minimum of 252 periods before it
applies our function, and the first 251 observations are missing below.
Also, pandas does not provide a \texttt{.prod()} method that works with
the \texttt{.rolling()} method, so we must manually perform this
calculation with \texttt{.apply()}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%\%}\NormalTok{time}
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .rolling(}\DecValTok{252}\NormalTok{) }\CommentTok{\# 252 observation window, because integer window, min\_periods default to size of the observation window}
\NormalTok{    .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: (}\DecValTok{1} \OperatorTok{+}\NormalTok{ x).prod() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
CPU times: total: 33.2 s
Wall time: 33.3 s
\end{verbatim}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
Portfolio & Lo 10 & Dec 2 & Dec 3 & Dec 4 & Dec 5 & Dec 6 & Dec 7 & Dec
8 & Dec 9 & Hi 10 \\
Date & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1926-07-01 & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN &
NaN \\
1926-07-02 & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN &
NaN \\
1926-07-06 & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN &
NaN \\
1926-07-07 & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN &
NaN \\
1926-07-08 & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN &
NaN \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2024-01-25 & 0.4283 & 0.1999 & 0.2334 & 0.0122 & 0.1062 & 0.1216 &
0.0914 & 0.0258 & 0.1398 & 0.0170 \\
2024-01-26 & 0.4259 & 0.2146 & 0.2414 & 0.0057 & 0.1024 & 0.1210 &
0.0881 & 0.0324 & 0.1124 & 0.0172 \\
2024-01-29 & 0.4193 & 0.2097 & 0.2476 & 0.0104 & 0.1059 & 0.1156 &
0.0816 & 0.0186 & 0.1188 & 0.0173 \\
2024-01-30 & 0.4024 & 0.1952 & 0.2390 & 0.0097 & 0.1119 & 0.1184 &
0.0901 & 0.0297 & 0.1249 & 0.0298 \\
2024-01-31 & 0.4051 & 0.1969 & 0.2049 & 0.0057 & 0.1041 & 0.1161 &
0.0857 & 0.0254 & 0.1104 & 0.0161 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%\%}\NormalTok{time}
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .pipe(np.log1p)}
\NormalTok{    .rolling(}\DecValTok{252}\NormalTok{) }\CommentTok{\# 252 observation window, because integer window, min\_periods default to size of the observation window}
\NormalTok{    .}\BuiltInTok{sum}\NormalTok{()}
\NormalTok{    .pipe(np.expm1)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
CPU times: total: 31.2 ms
Wall time: 14 ms
\end{verbatim}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
Portfolio & Lo 10 & Dec 2 & Dec 3 & Dec 4 & Dec 5 & Dec 6 & Dec 7 & Dec
8 & Dec 9 & Hi 10 \\
Date & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1926-07-01 & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN &
NaN \\
1926-07-02 & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN &
NaN \\
1926-07-06 & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN &
NaN \\
1926-07-07 & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN &
NaN \\
1926-07-08 & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN &
NaN \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2024-01-25 & 0.4283 & 0.1999 & 0.2334 & 0.0122 & 0.1062 & 0.1216 &
0.0914 & 0.0258 & 0.1398 & 0.0170 \\
2024-01-26 & 0.4259 & 0.2146 & 0.2414 & 0.0057 & 0.1024 & 0.1210 &
0.0881 & 0.0324 & 0.1124 & 0.0172 \\
2024-01-29 & 0.4193 & 0.2097 & 0.2476 & 0.0104 & 0.1059 & 0.1156 &
0.0816 & 0.0186 & 0.1188 & 0.0173 \\
2024-01-30 & 0.4024 & 0.1952 & 0.2390 & 0.0097 & 0.1119 & 0.1184 &
0.0901 & 0.0297 & 0.1249 & 0.0298 \\
2024-01-31 & 0.4051 & 0.1969 & 0.2049 & 0.0057 & 0.1041 & 0.1161 &
0.0857 & 0.0254 & 0.1104 & 0.0161 \\
\end{longtable}

\subsection{Calculate total returns over rolling 12-months windows after
calculating monthly
returns}\label{calculate-total-returns-over-rolling-12-months-windows-after-calculating-monthly-returns-2}

Since log returns are much faster with the \texttt{.rolling()} method,
we will:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Calculate log returns first
\item
  Resample daily returns to monthly returns
\item
  Calculate rolling returns over 12-month rolling windows
\item
  Calculate simple returns last
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .pipe(np.log1p) }\CommentTok{\# calculate log returns}
\NormalTok{    .resample(}\StringTok{\textquotesingle{}m\textquotesingle{}}\NormalTok{) }\CommentTok{\# downsample returns from daily to monthly}
\NormalTok{    .}\BuiltInTok{sum}\NormalTok{() }\CommentTok{\# after this sum, we have monthly log returns}
\NormalTok{    .rolling(}\DecValTok{12}\NormalTok{) }\CommentTok{\# rolling 12{-}month windows}
\NormalTok{    .}\BuiltInTok{sum}\NormalTok{() }\CommentTok{\# after this sum, we have rolling 12{-}month returns}
\NormalTok{    .pipe(np.expm1) }\CommentTok{\# calculate simple returns}
\NormalTok{    .dropna()}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{) }\CommentTok{\# convert to percent}
\NormalTok{    .plot()}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Rolling 12{-}Month Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Rolling 12{-}Month Returns of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_04_files/figure-pdf/cell-14-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .pipe(np.log1p) }\CommentTok{\# calculate log returns}
\NormalTok{    .resample(}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{)}
\NormalTok{    .}\BuiltInTok{sum}\NormalTok{() }\CommentTok{\# after this sum, we have monthly log returns}
\NormalTok{    .rolling(}\DecValTok{30} \OperatorTok{*} \DecValTok{12}\NormalTok{) }\CommentTok{\# rolling 30{-}year windows}
\NormalTok{    .}\BuiltInTok{sum}\NormalTok{() }\CommentTok{\# after this sum, we have rolling 12{-}month log returns}
\NormalTok{    .pipe(np.expm1) }\CommentTok{\# calculate simple returns}
\NormalTok{    .dropna()}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{) }\CommentTok{\# convert to percent}
\NormalTok{    .plot()}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Rolling 30{-}Year Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Rolling 30{-}Year Returns of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_04_files/figure-pdf/cell-15-output-1.png}

\subsection{Calculate Sharpe Ratios for each calendar
year}\label{calculate-sharpe-ratios-for-each-calendar-year-2}

Above we download the risk-free rate from Ken French's website, which we
need to calculate Sharpe ratios! The Sharpe Ratio is
\(S_i = \frac{\overline{r_i - r_f}}{\sigma_i}\), where
\(\overline{r_i-r_f}\) is mean fund return relative to the risk-free
rate over some period and \(\sigma_i\) is the standard deviation of
\(r_i-r_f\) over the same period.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_all }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}

\NormalTok{ff }\OperatorTok{=}\NormalTok{ ff\_all[}\DecValTok{0}\NormalTok{].div(}\DecValTok{100}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_11496\2778589428.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_all = pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{) }\CommentTok{\# daily excess returns}
\NormalTok{    .resample(}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{) }\CommentTok{\# downsample to annual}
\NormalTok{    .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: np.sqrt(}\DecValTok{252}\NormalTok{) }\OperatorTok{*}\NormalTok{ x.mean() }\OperatorTok{/}\NormalTok{ x.std()) }\CommentTok{\# calculate Sharpe ratios}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
Portfolio & Lo 10 & Dec 2 & Dec 3 & Dec 4 & Dec 5 & Dec 6 & Dec 7 & Dec
8 & Dec 9 & Hi 10 \\
Date & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1926-12-31 & 1.0443 & 0.3296 & 2.4042 & 1.9237 & 0.2085 & 1.3751 &
1.4400 & 1.3200 & 0.5276 & 1.0035 \\
1927-12-31 & 3.2226 & 1.8649 & 2.6625 & 1.7466 & 1.6240 & 2.1109 &
1.8806 & 1.6189 & 1.8466 & 1.6684 \\
1928-12-31 & 1.9391 & 2.1740 & 2.2007 & 1.9249 & 2.1844 & 1.5118 &
0.8999 & 1.6722 & 1.3630 & 0.9255 \\
1929-12-31 & -0.6050 & -0.1397 & -0.2468 & -0.1714 & 0.0009 & -0.0349 &
-0.0684 & -0.3532 & -0.2792 & -0.6170 \\
1930-12-31 & -0.9699 & -0.7385 & -1.0907 & -1.3742 & -1.3992 & -1.6457 &
-2.3018 & -2.0655 & -2.3736 & -2.1651 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2020-12-31 & 1.2642 & 0.9832 & 0.7613 & 0.5393 & 0.3628 & 0.3973 &
-0.2304 & 0.1787 & 0.2889 & 0.0857 \\
2021-12-31 & 1.2897 & 1.5796 & 1.9168 & 1.2979 & 0.9096 & 1.7713 &
1.4385 & 1.8281 & 1.5998 & 1.6404 \\
2022-12-31 & -0.9784 & -0.9260 & -0.7957 & -0.3773 & -0.4495 & -0.6664 &
-0.0463 & 0.3953 & 0.0366 & -0.0862 \\
2023-12-31 & 2.1571 & 1.2488 & 1.2150 & 0.0623 & 0.5575 & 0.8493 &
0.4359 & 0.3561 & 0.7679 & 0.1911 \\
2024-12-31 & 1.5795 & 0.9882 & -0.3949 & -2.2775 & 2.1697 & 1.7894 &
1.6911 & -3.1931 & -2.2544 & -0.2785 \\
\end{longtable}

The annual data are noisy, because \(r_i - r_f\) and \(\sigma_i\) in a
given year are poor estimates of the expected excess return and
volatility. A crude solution is to aggregate these data over the full
sample. We see that there is not a clear trend for the Sharpe ratio
acress these portfolios. We will revisit this when we learn the CAPM in
a few weeks!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{) }\CommentTok{\# daily excess returns}
\NormalTok{    .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: np.sqrt(}\DecValTok{252}\NormalTok{) }\OperatorTok{*}\NormalTok{ x.mean() }\OperatorTok{/}\NormalTok{ x.std()) }\CommentTok{\# calculate Sharpe ratios}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Sharpe Ratio\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Sharpe Ratios of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_04_files/figure-pdf/cell-18-output-1.png}

\subsection{Calculate rolling betas}\label{calculate-rolling-betas-2}

Calculate rolling capital asset pricing model (CAPM) betas for the
\st{MATANA stocks} ten portfolios formed on B/M.

The CAPM says the risk premium on a stock depends on the risk-free rate,
beta, and the risk premium on the market:
\(E(r_i) = r_f + \beta_i \times (E(r_M) - r_f)\). We can calculate CAPM
betas as:
\(\beta_i = \frac{Cov(r_i - r_f, r_M - r_f)}{Var(r_M - r_f)}\). To speed
up our calculations, we can use the rolling-optimized covariance and
variance methods to calculate the numerator and denominator,
respectively, then divide them to calculate beta.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{beta\_top }\OperatorTok{=}\NormalTok{ be\_me\_vw.sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{).rolling(}\DecValTok{252}\OperatorTok{*}\DecValTok{3}\NormalTok{).cov(ff[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{])}
\NormalTok{beta\_bottom }\OperatorTok{=}\NormalTok{ ff[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{].rolling(}\DecValTok{252}\OperatorTok{*}\DecValTok{3}\NormalTok{).var()}
\NormalTok{beta }\OperatorTok{=}\NormalTok{ beta\_top.div(beta\_bottom, axis}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{beta.plot()}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Rolling 3{-}Year Beta\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Rolling 3{-}Year Betas of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_04_files/figure-pdf/cell-19-output-1.png}

\subsection{Calculate rolling Sharpe
Ratios}\label{calculate-rolling-sharpe-ratios-2}

Calculate rolling Sharpe Ratios for the \st{MATANA stocks} ten
portfolios formed on B/M.

We can copy our Sharpe ratio plot code above, and (1) add a
\texttt{.rolling()} method before we \texttt{.apply()} the Sharpe ratio
formula, and then (2) remove
\texttt{kind=\textquotesingle{}bar\textquotesingle{}} from our
\texttt{.plot()} method.

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%\%}\NormalTok{time}
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{) }\CommentTok{\# daily excess returns}
\NormalTok{    .rolling(}\DecValTok{3}\OperatorTok{*}\DecValTok{252}\NormalTok{)}
\NormalTok{    .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: np.sqrt(}\DecValTok{252}\NormalTok{) }\OperatorTok{*}\NormalTok{ x.mean() }\OperatorTok{/}\NormalTok{ x.std()) }\CommentTok{\# calculate Sharpe ratios}
\NormalTok{    .plot()}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Rolling 3{-}Year Sharpe Ratio\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Rolling 3{-}Year Sharpe Ratios of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_04_files/figure-pdf/cell-20-output-1.png}

\begin{verbatim}
CPU times: total: 45.2 s
Wall time: 45.3 s
\end{verbatim}

But the code above is slow because the \texttt{.apply()} method is not
rolling-optimized! We can speed up our code by using the
rolling-optimized \texttt{.mean()} and \texttt{.std()} methods.

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%\%}\NormalTok{time}

\NormalTok{sharpe\_top }\OperatorTok{=}\NormalTok{ be\_me\_vw.sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{).rolling(}\DecValTok{3}\OperatorTok{*}\DecValTok{252}\NormalTok{).mean()}
\NormalTok{sharpe\_bottom }\OperatorTok{=}\NormalTok{ be\_me\_vw.sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{).rolling(}\DecValTok{3}\OperatorTok{*}\DecValTok{252}\NormalTok{).std()}
\NormalTok{sharpe }\OperatorTok{=}\NormalTok{ sharpe\_top.div(sharpe\_bottom, axis}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{sharpe.plot()}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Rolling 3{-}Year Sharpe Ratio\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Rolling 3{-}Year Sharpe Ratios of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_04_files/figure-pdf/cell-21-output-1.png}

\begin{verbatim}
CPU times: total: 1.94 s
Wall time: 1.94 s
\end{verbatim}

\chapter{McKinney Chapter 11 - Practice for Section
05}\label{mckinney-chapter-11---practice-for-section-05}

\section{Announcements}\label{announcements-31}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  I finished grading Project 1

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Before peer reviews, the median grade is 84\% (mean is 84.4\%)
  \item
    Assuming perfect peer reviews, the median grade is 87\% (mean is
    87.1\%)
  \item
    Peer review scores on Canvas are the median peer review scores on
    Teammates because medians ignore outliers
  \item
    97.1\% of students received perfect peer review scores
  \item
    Only 1.2\% of students received peer review scores less than 90\%
  \item
    I posted a barebones solution to the Project 1 assignment page on
    Canvas
  \end{enumerate}
\item
  10,000 XP on DataCamp

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Due by Fri5ay, 3/16, at 11:59 PM
  \item
    Upload a screenshot of your DataCamp profile page with XP to Canvas
  \end{enumerate}
\item
  I will post Project 2 by Thursday morning and we will discuss it on
  Thursday and Friday
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-30}

The time-series functionality in pandas is fantastic! Here are the three
main tools we will use:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \texttt{.shift()} method

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    The \texttt{.shift()} method is used to shift the index of a
    DataFrame by a specified number of periods.
  \item
    It is useful for calculating percentage changes, differences between
    time periods, and other time series calculations.
  \item
    The method can be used to shift both forward and backward in time.
  \end{enumerate}
\item
  \texttt{.resample()} method

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    The \texttt{.resample()} method is used to resample time-series
    data.
  \item
    It is used to convert time series data from one frequency to
    another.
  \item
    The method can be used to upsample (increase the frequency of the
    data) or downsample (decrease the frequency of the data).
  \end{enumerate}
\item
  \texttt{.rolling()} method

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    The \texttt{.rolling()} method is used to perform rolling window
    calculations on sequential data.
  \item
    A rolling window is a fixed-size interval or subset of data that
    moves sequentially through a larger dataset.
  \item
    The method is useful for calculating moving averages, standard
    deviations, and other rolling window calculations.
  \end{enumerate}
\end{enumerate}

\section{Practice}\label{practice-31}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{Download daily returns for ten portfolios formed on
book-to-market
ratios}\label{download-daily-returns-for-ten-portfolios-formed-on-book-to-market-ratios-3}

We can use a list comprehension with an \texttt{if} statement to find
the name of the file with portfolios formed on book-to-market ratios.
Book-to-market ratios are also called B/M ratios, and French includes
``Portfolios'' and ``BE-ME'' in the files with these portfolio returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{[x }\ControlFlowTok{for}\NormalTok{ x }\KeywordTok{in}\NormalTok{ pdr.famafrench.get\_available\_datasets() }\ControlFlowTok{if}\NormalTok{ (}\StringTok{\textquotesingle{}Portfolios\textquotesingle{}} \KeywordTok{in}\NormalTok{ x) }\KeywordTok{and}\NormalTok{ (}\StringTok{\textquotesingle{}BE{-}ME\textquotesingle{}} \KeywordTok{in}\NormalTok{ x)][:}\DecValTok{5}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
['Portfolios_Formed_on_BE-ME',
 'Portfolios_Formed_on_BE-ME_Wout_Div',
 'Portfolios_Formed_on_BE-ME_Daily',
 'Developed_6_Portfolios_ME_BE-ME',
 'Developed_6_Portfolios_ME_BE-ME_daily']
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{be\_me\_all }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolios\_Formed\_on\_BE{-}ME\_Daily\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_13796\616375102.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  be_me_all = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_13796\616375102.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  be_me_all = pdr.DataReader(
\end{verbatim}

The value for the ``DESCR'' key shows how French creates these data
(i.e., he forms portfolios at the end of every June) and what each data
frame contains. The 0 key selects returns on value-weighted portfolios,
and the 1 key selects returns on equal-weighted portfolios.

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(be\_me\_all[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Portfolios Formed on BE-ME Daily
--------------------------------

This file was created by CMPT_BEME_RETS_DAILY using the 202401 CRSP database. It contains value- and equal-weighted returns for portfolios formed on BE/ME. The portfolios are constructed at the end of June. BE/ME is book equity at the last fiscal year end of the prior calendar year divided by ME at the end of December of the prior year. The annual returns are from January to December. Missing data are indicated by -99.99 or -999. The break points use Compustat firms plus the firms hand-collected from the Moodys Industrial, Utilities, Transportation, and Financial Manuals. The break points include utilities. The portfolios use Compustat firms plus the firms hand-collected from the Moodys Industrial, Utilities, Transportation, and Financial Manuals. The portfolios include utilities.

  0 : Value Weighted Returns -- Daily (25670 rows x 19 cols)
  1 : Equal Weighted Returns -- Daily (25670 rows x 19 cols)
\end{verbatim}

Each data frame has several groups of portfolios:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The first column provides the returns on a portfolio of negative book
  equity stocks. The next 18 columns split the positive book equity
  stocks into 3, 5, and 10 portfolios based on their B/M ranks.
\item
  The next 3 columns provide 3 portfolios split on the 30th and 70th
  percentiles of B/M.
\item
  The next 5 columns provide 5 portfolios split on the 20th, 40th, 60th,
  and 80th percentiles of B/M (i.e., quintiles).
\item
  The last 10 columns provide 10 portfolios split on the 10th, 20th,
  \ldots, and 90th percentiles of B/M (i.e., deciles).
\end{enumerate}

We can assign the value-weighted B/M-decile portfolio returns to data
frame \texttt{be\_me\_vw}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{be\_me\_vw }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    be\_me\_all }\CommentTok{\# all portfolio returns}
\NormalTok{    [}\DecValTok{0}\NormalTok{] }\CommentTok{\# select the value{-}weighted portfolio returns}
\NormalTok{    .iloc[:, }\OperatorTok{{-}}\DecValTok{10}\NormalTok{:] }\CommentTok{\# slice the rightmost ten columns}
\NormalTok{    .div(}\DecValTok{100}\NormalTok{) }\CommentTok{\# convert from percent to decimal}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}B/M Portfolio\textquotesingle{}}\NormalTok{) }\CommentTok{\# label columns for easy plots}
\NormalTok{)}

\NormalTok{be\_me\_vw}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
B/M Portfolio & Lo 10 & Dec 2 & Dec 3 & Dec 4 & Dec 5 & Dec 6 & Dec 7 &
Dec 8 & Dec 9 & Hi 10 \\
Date & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1926-07-01 & 0.0014 & 0.0044 & -0.0012 & 0.0009 & 0.0019 & 0.0038 &
-0.0032 & -0.0011 & 0.0028 & -0.0044 \\
1926-07-02 & 0.0044 & 0.0043 & 0.0066 & 0.0044 & 0.0061 & 0.0015 &
0.0061 & 0.0019 & 0.0044 & -0.0011 \\
1926-07-06 & 0.0037 & 0.0000 & 0.0054 & 0.0027 & 0.0007 & 0.0004 &
-0.0002 & -0.0043 & 0.0016 & 0.0012 \\
1926-07-07 & -0.0004 & -0.0003 & 0.0032 & 0.0032 & 0.0001 & 0.0020 &
-0.0023 & 0.0059 & 0.0053 & -0.0030 \\
1926-07-08 & 0.0067 & -0.0003 & 0.0030 & 0.0038 & -0.0009 & 0.0027 &
-0.0003 & 0.0057 & 0.0025 & 0.0073 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2024-01-25 & -0.0023 & 0.0071 & 0.0120 & 0.0082 & 0.0100 & 0.0115 &
0.0117 & 0.0095 & 0.0092 & 0.0146 \\
2024-01-26 & -0.0031 & 0.0044 & 0.0016 & -0.0003 & 0.0026 & 0.0023 &
0.0039 & 0.0073 & -0.0148 & 0.0067 \\
2024-01-29 & 0.0110 & 0.0078 & 0.0094 & 0.0088 & 0.0095 & 0.0048 &
0.0029 & 0.0079 & 0.0076 & 0.0085 \\
2024-01-30 & -0.0025 & -0.0051 & -0.0034 & -0.0014 & 0.0030 & 0.0014 &
0.0070 & 0.0007 & 0.0049 & 0.0105 \\
2024-01-31 & -0.0169 & -0.0134 & -0.0383 & -0.0142 & -0.0158 & -0.0127 &
-0.0121 & -0.0189 & -0.0182 & -0.0197 \\
\end{longtable}

We can easily visualize these portfolio returns with the arithmetic and
geometric means of these portfolio returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .mean() }\CommentTok{\# arithmetic mean}
\NormalTok{    .mul(}\DecValTok{252}\NormalTok{) }\CommentTok{\# annualize}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{) }\CommentTok{\# convert to percent}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Arithmetic Means of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_05_files/figure-pdf/cell-8-output-1.png}

In finance, we often call the annualized geometric mean the ``compounded
annualized growth rate'' or ``CAGR''. The geoemetric mean of daily
returns is
\(1 + r_{geom} = \left[ \prod_{t}^T (1+r_t) \right]^{\frac{1}{T}}\),
where \(r_t\) is the return on day \(t\). The CAGR is the annualized
geometric mean of daily returns, so \(1 + CAGR = (1 + r_{geom})^{252}\)
and \(CAGR = \left[ \prod_{t}^T (1+r_t) \right]^{\frac{252}{T}} - 1\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: (}\DecValTok{1} \OperatorTok{+}\NormalTok{ x).prod()}\OperatorTok{**}\NormalTok{(}\DecValTok{252} \OperatorTok{/}\NormalTok{ x.count()) }\OperatorTok{{-}} \DecValTok{1}\NormalTok{) }\CommentTok{\# annualized geometric mean or CAGR}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{) }\CommentTok{\# convert to percent}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}CAGR of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Geometric Means of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_05_files/figure-pdf/cell-9-output-1.png}

\subsection{Calculate cumulative returns with all available
data}\label{calculate-cumulative-returns-with-all-available-data-3}

We have done calculations and plots of cumulative returns for several
weeks, and these do not use the \texttt{.shift()}, \texttt{.resample()},
or \texttt{.rolling()} methods.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod() }\CommentTok{\# compound cumulative returns}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{) }\CommentTok{\# convert to percent}
\NormalTok{    .plot()}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Cumulative Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Cumulative Returns of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_05_files/figure-pdf/cell-10-output-1.png}

\subsection{Calculate total returns for each calendar
year}\label{calculate-total-returns-for-each-calendar-year-3}

We use the \texttt{.resample()} method to downsample our daily returns
to annual returns. Note that we must \texttt{.add(1)} to our returns
\emph{before} we \texttt{.resample()} because we can only associate one
method with the resampling. We could \texttt{.apply()} a lambda function
that does the compounding one step, but optimized methods like
\texttt{.prod()} are generally faster than \texttt{.apply()}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{) }\CommentTok{\# must add 1 before .resample()}
\NormalTok{    .resample(rule}\OperatorTok{=}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{, kind}\OperatorTok{=}\StringTok{\textquotesingle{}period\textquotesingle{}}\NormalTok{) }\CommentTok{\# down sample to annual periods}
\NormalTok{    .prod() }\CommentTok{\# use product to compound (1+r)s each year}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{) }\CommentTok{\# subtract 1 after compounding}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
B/M Portfolio & Lo 10 & Dec 2 & Dec 3 & Dec 4 & Dec 5 & Dec 6 & Dec 7 &
Dec 8 & Dec 9 & Hi 10 \\
Date & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1926 & 0.0819 & 0.0309 & 0.2793 & 0.0899 & 0.0248 & 0.0825 & 0.1265 &
0.1038 & 0.0510 & 0.0958 \\
1927 & 0.5773 & 0.2518 & 0.4298 & 0.2015 & 0.2041 & 0.2611 & 0.2832 &
0.2471 & 0.3844 & 0.4825 \\
1928 & 0.4880 & 0.4965 & 0.3961 & 0.3724 & 0.4677 & 0.2581 & 0.1484 &
0.3331 & 0.3740 & 0.2668 \\
1929 & -0.2691 & -0.0844 & -0.1469 & -0.0664 & -0.0039 & -0.0147 &
-0.0096 & -0.0830 & -0.0830 & -0.2550 \\
1930 & -0.2911 & -0.2067 & -0.2679 & -0.2757 & -0.2531 & -0.3514 &
-0.3858 & -0.4110 & -0.5280 & -0.5669 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2020 & 0.4815 & 0.3129 & 0.2160 & 0.1451 & 0.0720 & 0.0862 & -0.1662 &
-0.0139 & 0.0187 & -0.1113 \\
2021 & 0.2373 & 0.2334 & 0.2867 & 0.1776 & 0.1296 & 0.3196 & 0.2543 &
0.3685 & 0.3981 & 0.4465 \\
2022 & -0.2962 & -0.2218 & -0.1847 & -0.0814 & -0.1003 & -0.1435 &
-0.0183 & 0.0804 & -0.0044 & -0.0418 \\
2023 & 0.4777 & 0.2459 & 0.2325 & 0.0482 & 0.1235 & 0.1728 & 0.1047 &
0.1004 & 0.1900 & 0.0679 \\
2024 & 0.0233 & 0.0128 & -0.0023 & -0.0177 & 0.0251 & 0.0217 & 0.0205 &
-0.0380 & -0.0273 & -0.0006 \\
\end{longtable}

\subsection{Calculate total returns over rolling 252-trading-day
windows}\label{calculate-total-returns-over-rolling-252-trading-day-windows-3}

We specify the window as an integer (252 observations), so the
\texttt{.rolling()} method defaults the \texttt{min\_periods} argument
to the same integer (252 observations). As a result, the
\texttt{.rolling()} method needs a minimum of 252 periods before it
applies our function, and the first 251 observations are missing below.
Also, pandas does not provide a \texttt{.prod()} method that works with
the \texttt{.rolling()} method, so we must manually perform this
calculation with \texttt{.apply()}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%\%}\NormalTok{time}
\NormalTok{be\_me\_rr\_1 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    be\_me\_vw}
\NormalTok{    .rolling(}\DecValTok{252}\NormalTok{) }\CommentTok{\# 252 observation window, because integer window, min\_periods default to size of the observation window}
\NormalTok{    .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: (}\DecValTok{1} \OperatorTok{+}\NormalTok{ x).prod() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
CPU times: total: 35.9 s
Wall time: 36.2 s
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%\%}\NormalTok{time}
\NormalTok{be\_me\_rr\_2 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    be\_me\_vw}
\NormalTok{    .pipe(np.log1p) }\CommentTok{\# calculate log returns}
\NormalTok{    .rolling(}\DecValTok{252}\NormalTok{) }\CommentTok{\# 252 observation window, because integer window, min\_periods default to size of the observation window}
\NormalTok{    .}\BuiltInTok{sum}\NormalTok{() }\CommentTok{\# log returns are additive}
\NormalTok{    .pipe(np.expm1) }\CommentTok{\# calculate simple returns}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
CPU times: total: 46.9 ms
Wall time: 33.9 ms
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(be\_me\_rr\_1, be\_me\_rr\_2, equal\_nan}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

I generally only use log returns to speed up multiplicative
calculations, like we do above. The othe common use case for logs is
reduce the impact of outliers, as in the plot of the value of a \$1
investment in the U.S. market in 1926.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_all }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}

\NormalTok{ff }\OperatorTok{=}\NormalTok{ ff\_all[}\DecValTok{0}\NormalTok{].div(}\DecValTok{100}\NormalTok{).assign(Mkt}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ x[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{])}
\NormalTok{ff[}\StringTok{\textquotesingle{}Mkt\textquotesingle{}}\NormalTok{].add(}\DecValTok{1}\NormalTok{).cumprod().plot()}
\NormalTok{plt.yscale(}\StringTok{\textquotesingle{}log\textquotesingle{}}\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Value ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Value of $1 Investment in U.S. Market}\CharTok{\textbackslash{}n}\StringTok{ at The End of June 1926\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_13796\2413493213.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_all = pdr.DataReader(
\end{verbatim}

\includegraphics{mckinney_11_practice_05_files/figure-pdf/cell-15-output-2.png}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\subsection{Calculate total returns over rolling 12-months windows after
calculating monthly
returns}\label{calculate-total-returns-over-rolling-12-months-windows-after-calculating-monthly-returns-3}

Since log returns are much faster with the \texttt{.rolling()} method,
we will:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Calculate log returns first
\item
  Resample daily returns to monthly returns
\item
  Calculate rolling returns over 12-month rolling windows
\item
  Calculate simple returns last
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .pipe(np.log1p) }\CommentTok{\# calculate log returns}
\NormalTok{    .resample(}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{) }\CommentTok{\# downsample returns from daily to monthly}
\NormalTok{    .}\BuiltInTok{sum}\NormalTok{() }\CommentTok{\# after this sum, we have monthly log returns}
\NormalTok{    .rolling(}\DecValTok{12}\NormalTok{) }\CommentTok{\# rolling 12{-}month windows}
\NormalTok{    .}\BuiltInTok{sum}\NormalTok{() }\CommentTok{\# after this sum, we have rolling 12{-}month log returns}
\NormalTok{    .pipe(np.expm1) }\CommentTok{\# calculate simple returns}
\NormalTok{    .dropna()}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{) }\CommentTok{\# convert to percent}
\NormalTok{    .plot()}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Rolling 12{-}Month Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Rolling 12{-}Month Returns of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_05_files/figure-pdf/cell-16-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .pipe(np.log1p) }\CommentTok{\# calculate log returns}
\NormalTok{    .resample(}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{)}
\NormalTok{    .}\BuiltInTok{sum}\NormalTok{() }\CommentTok{\# after this sum, we have monthly log returns}
\NormalTok{    .rolling(}\DecValTok{30} \OperatorTok{*} \DecValTok{12}\NormalTok{) }\CommentTok{\# rolling 30{-}year windows}
\NormalTok{    .}\BuiltInTok{sum}\NormalTok{() }\CommentTok{\# after this sum, we have rolling 12{-}month log returns}
\NormalTok{    .pipe(np.expm1) }\CommentTok{\# calculate simple returns}
\NormalTok{    .dropna()}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{) }\CommentTok{\# convert to percent}
\NormalTok{    .plot()}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Rolling 30{-}Year Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Rolling 30{-}Year Returns of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_05_files/figure-pdf/cell-17-output-1.png}

\subsection{Calculate Sharpe Ratios for each calendar
year}\label{calculate-sharpe-ratios-for-each-calendar-year-3}

Above we download the risk-free rate from Ken French's website, which we
need to calculate Sharpe ratios! The Sharpe Ratio is
\(S_i = \frac{\overline{r_i - r_f}}{\sigma_i}\), where
\(\overline{r_i-r_f}\) is mean fund return relative to the risk-free
rate over some period and \(\sigma_i\) is the standard deviation of
\(r_i-r_f\) over the same period.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{) }\CommentTok{\# daily excess returns}
\NormalTok{    .resample(}\StringTok{\textquotesingle{}A\textquotesingle{}}\NormalTok{) }\CommentTok{\# downsample to annual}
\NormalTok{    .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: np.sqrt(}\DecValTok{252}\NormalTok{) }\OperatorTok{*}\NormalTok{ x.mean() }\OperatorTok{/}\NormalTok{ x.std()) }\CommentTok{\# calculate Sharpe ratios}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
B/M Portfolio & Lo 10 & Dec 2 & Dec 3 & Dec 4 & Dec 5 & Dec 6 & Dec 7 &
Dec 8 & Dec 9 & Hi 10 \\
Date & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1926-12-31 & 1.0443 & 0.3296 & 2.4042 & 1.9237 & 0.2085 & 1.3751 &
1.4400 & 1.3200 & 0.5276 & 1.0035 \\
1927-12-31 & 3.2226 & 1.8649 & 2.6625 & 1.7466 & 1.6240 & 2.1109 &
1.8806 & 1.6189 & 1.8466 & 1.6684 \\
1928-12-31 & 1.9391 & 2.1740 & 2.2007 & 1.9249 & 2.1844 & 1.5118 &
0.8999 & 1.6722 & 1.3630 & 0.9255 \\
1929-12-31 & -0.6050 & -0.1397 & -0.2468 & -0.1714 & 0.0009 & -0.0349 &
-0.0684 & -0.3532 & -0.2792 & -0.6170 \\
1930-12-31 & -0.9699 & -0.7385 & -1.0907 & -1.3742 & -1.3992 & -1.6457 &
-2.3018 & -2.0655 & -2.3736 & -2.1651 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2020-12-31 & 1.2642 & 0.9832 & 0.7613 & 0.5393 & 0.3628 & 0.3973 &
-0.2304 & 0.1787 & 0.2889 & 0.0857 \\
2021-12-31 & 1.2897 & 1.5796 & 1.9168 & 1.2979 & 0.9096 & 1.7713 &
1.4385 & 1.8281 & 1.5998 & 1.6404 \\
2022-12-31 & -0.9784 & -0.9260 & -0.7957 & -0.3773 & -0.4495 & -0.6664 &
-0.0463 & 0.3953 & 0.0366 & -0.0862 \\
2023-12-31 & 2.1571 & 1.2488 & 1.2150 & 0.0623 & 0.5575 & 0.8493 &
0.4359 & 0.3561 & 0.7679 & 0.1911 \\
2024-12-31 & 1.5795 & 0.9882 & -0.3949 & -2.2775 & 2.1697 & 1.7894 &
1.6911 & -3.1931 & -2.2544 & -0.2785 \\
\end{longtable}

The annual data are noisy, because \(r_i - r_f\) and \(\sigma_i\) in a
given year are poor estimates of the expected excess return and
volatility. A crude solution is to aggregate these data over the full
sample. We see that there is not a clear trend for the Sharpe ratio
acress these portfolios. We will revisit this when we learn the CAPM in
a few weeks!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{) }\CommentTok{\# daily excess returns}
\NormalTok{    .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: np.sqrt(}\DecValTok{252}\NormalTok{) }\OperatorTok{*}\NormalTok{ x.mean() }\OperatorTok{/}\NormalTok{ x.std()) }\CommentTok{\# calculate Sharpe ratios}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Sharpe Ratio\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Sharpe Ratios of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_05_files/figure-pdf/cell-19-output-1.png}

\subsection{Calculate rolling betas}\label{calculate-rolling-betas-3}

Calculate rolling capital asset pricing model (CAPM) betas for the
\st{MATANA stocks} ten portfolios formed on B/M.

The CAPM says the risk premium on a stock depends on the risk-free rate,
beta, and the risk premium on the market:
\(E(r_i) = r_f + \beta_i \times (E(r_M) - r_f)\). We can calculate CAPM
betas as:
\(\beta_i = \frac{Cov(r_i - r_f, r_M - r_f)}{Var(r_M - r_f)}\). To speed
up our calculations, we can use the rolling-optimized covariance and
variance methods to calculate the numerator and denominator,
respectively, then divide them to calculate beta.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{beta\_top }\OperatorTok{=}\NormalTok{ be\_me\_vw.sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{).rolling(}\DecValTok{252}\OperatorTok{*}\DecValTok{3}\NormalTok{).cov(ff[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{])}
\NormalTok{beta\_bottom }\OperatorTok{=}\NormalTok{ ff[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{].rolling(}\DecValTok{252}\OperatorTok{*}\DecValTok{3}\NormalTok{).var()}
\NormalTok{beta }\OperatorTok{=}\NormalTok{ beta\_top.div(beta\_bottom, axis}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{beta.plot()}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Rolling 3{-}Year Beta\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Rolling 3{-}Year Betas of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_05_files/figure-pdf/cell-20-output-1.png}

\subsection{Calculate rolling Sharpe
Ratios}\label{calculate-rolling-sharpe-ratios-3}

Calculate rolling Sharpe Ratios for the \st{MATANA stocks} ten
portfolios formed on B/M.

We can copy our Sharpe ratio plot code above, and (1) add a
\texttt{.rolling()} method before we \texttt{.apply()} the Sharpe ratio
formula, and then (2) remove
\texttt{kind=\textquotesingle{}bar\textquotesingle{}} from our
\texttt{.plot()} method.

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%\%}\NormalTok{time}
\NormalTok{(}
\NormalTok{    be\_me\_vw}
\NormalTok{    .sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{) }\CommentTok{\# daily excess returns}
\NormalTok{    .rolling(}\DecValTok{3}\OperatorTok{*}\DecValTok{252}\NormalTok{)}
\NormalTok{    .}\BuiltInTok{apply}\NormalTok{(}\KeywordTok{lambda}\NormalTok{ x: np.sqrt(}\DecValTok{252}\NormalTok{) }\OperatorTok{*}\NormalTok{ x.mean() }\OperatorTok{/}\NormalTok{ x.std()) }\CommentTok{\# calculate Sharpe ratios}
\NormalTok{    .plot()}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Rolling 3{-}Year Sharpe Ratio\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Rolling 3{-}Year Sharpe Ratios of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_05_files/figure-pdf/cell-21-output-1.png}

\begin{verbatim}
CPU times: total: 43.8 s
Wall time: 43.9 s
\end{verbatim}

But the code above is slow because the \texttt{.apply()} method is not
rolling-optimized! We can speed up our code by using the
rolling-optimized \texttt{.mean()} and \texttt{.std()} methods.

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%\%}\NormalTok{time}

\NormalTok{sharpe\_top }\OperatorTok{=}\NormalTok{ be\_me\_vw.sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{).rolling(}\DecValTok{3}\OperatorTok{*}\DecValTok{252}\NormalTok{).mean()}
\NormalTok{sharpe\_bottom }\OperatorTok{=}\NormalTok{ be\_me\_vw.sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], axis}\OperatorTok{=}\DecValTok{0}\NormalTok{).rolling(}\DecValTok{3}\OperatorTok{*}\DecValTok{252}\NormalTok{).std()}
\NormalTok{sharpe }\OperatorTok{=}\NormalTok{ sharpe\_top.div(sharpe\_bottom, axis}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{sharpe.plot()}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Rolling 3{-}Year Sharpe Ratio\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Rolling 3{-}Year Sharpe Ratios of Ten Portfolios Formed on B/M\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{mckinney_11_practice_05_files/figure-pdf/cell-22-output-1.png}

\begin{verbatim}
CPU times: total: 1.95 s
Wall time: 1.94 s
\end{verbatim}

\part{Week 10}

\chapter{Herron Topic 2 - Trading
Strategies}\label{herron-topic-2---trading-strategies}

This notebook covers trading strategies based on technical analysis in
three parts:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  What is technical analysis?
\item
  Why might trading strategies based on technical analysis work (or not
  work)?
\item
  Implement a simple moving average (SMA) trading strategy
\end{enumerate}

I based this lecture notebook on
\href{https://book.ivo-welch.info/read/source5.mba/12-effbehav.pdf}{chapter
12 of Ivo Welch's \emph{Corporate Finance} textbook} and chapter 2 of
\href{https://onesearch.library.northeastern.edu/permalink/01NEU_INST/i2gqis/alma9952082522901401}{Eryk
Lewinson's \emph{Python for Finance Cookbook}}. The practice notebook
will cover several other trading strategies based on technical analysis.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ statsmodels.api }\ImportTok{as}\NormalTok{ sm}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\section{What is technical analysis?}\label{what-is-technical-analysis}

\href{https://en.wikipedia.org/wiki/Technical_analysis}{Technical
analysis} is a methodology that analyzes past market data (e.g., past
prices and volume) in an attempt to forecast future price movements. If
technical analysis can predict future price movements, the market is not
weak-form efficient. Ivo Welch provides the three degrees of market
efficiency in section 12.2 of
\href{https://book.ivo-welch.info/read/source5.mba/12-effbehav.pdf}{chapter
12 of his (free) \emph{Corporate Finance} textbook}:

\begin{quote}
The Traditional Classification The traditional definition of market
efficiency focuses on information. In the traditional classification,
market efficiency comes in one of three primary degrees: weak,
semi-strong, and strong.

\textbf{Weak market efficiency} says that all information in past prices
is reflected in today's stock prices so that technical analysis (trading
based solely on historical price patterns) cannot be used to beat the
market. Put differently, the market is the best technical analyst.

\textbf{Semistrong market efficiency} says that all public information
is reflected in today's stock prices, so that neither fundamental
trading (based on underlying firm fundamentals, such as cash flows or
discount rates) nor technical analysis can be used to beat the market.
Put differently, the market is both the best technical and the best
fundamental analyst.

\textbf{Strong market efficiency} says that all information, both public
and private, is reflected in today's stock prices, so that nothing ---
not even private insider information --- can be used to beat the market.
Put differently, the market is the best analyst and cannot be beat.

In this traditional classification, all finance professors nowadays
believe that most U.S. financial markets are not strong-form efficient:
Insider trading may be illegal, but it works. However, there are still
arguments as to which markets are only semi-strong-form efficient or
even only weak-form efficient.
\end{quote}

Section 12.2 goes on to provide Welch's own taxonomy of true, firm,
mild, and nonbelievers in market efficiency. Chapter 12 summarizes
market efficiency, classical finance, behavioral finance, arbitrage,
limits to arbitrage, and their consequences for managers and investors.
We will focus on technical analysis in this notebook, but chapter 12 is
excellent.

\section{Why might trading strategies based on technical analysis work
or
not?}\label{why-might-trading-strategies-based-on-technical-analysis-work-or-not}

\subsection{\ldots Work?}\label{work}

Technical analysis relies on a few ideas:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Market prices and volume reflect all relevant information, so we can
  focus on past prices and volume instead of fundamentals and news.
\item
  Market prices move in trends and patterns driven by market
  participants.
\item
  These trends and patterns tend to repeat themselves because market
  participants create them.
\end{enumerate}

\subsection{\ldots Or Not?}\label{or-not}

The logic above is reasonable. However, if past market prices reflect
all relevant information, they should also reflect any prices trends
they predict. Therefore, any patterns should be self-defeating, and
market prices should follow
\href{https://en.wikipedia.org/wiki/Random_walk_hypothesis}{a random
walk}. As well, the signal-to-noise ratio in market prices is high!
Still, technical analysis provides an opportunity to learn how to
implement and back-test trading strategies in Python.

\subsubsection{A Random Walk}\label{a-random-walk}

In a random walk, the price tomorrow equals the price today plus a tiny
drift plus noise. In math terms, a random walk is
\[P_{t} = \rho P_{t-1} + m P_{t-1} + \varepsilon_t\] where \(m\) is a
small drift term and \(E[\varepsilon] = 0\). If \(\rho > 1\), prices
would quickly increase, and, if \(\rho < 1\), prices would quickly
decrease. Let us examine the historical record.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pdr.DataReader(}
\NormalTok{        name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{        data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{        start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{    )}
\NormalTok{    [}\DecValTok{0}\NormalTok{]}
\NormalTok{    .assign(Mkt}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ x[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{])}
\NormalTok{    .div(}\DecValTok{100}\NormalTok{)}
\NormalTok{)}

\NormalTok{ff.head()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_22728\2916005334.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{longtable}[]{@{}llllll@{}}
\toprule\noalign{}
& Mkt-RF & SMB & HML & RF & Mkt \\
Date & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1926-07-01 & 0.0010 & -0.0025 & -0.0027 & 0.0001 & 0.0011 \\
1926-07-02 & 0.0045 & -0.0033 & -0.0006 & 0.0001 & 0.0046 \\
1926-07-06 & 0.0017 & 0.0030 & -0.0039 & 0.0001 & 0.0018 \\
1926-07-07 & 0.0009 & -0.0058 & 0.0002 & 0.0001 & 0.0010 \\
1926-07-08 & 0.0021 & -0.0038 & 0.0019 & 0.0001 & 0.0022 \\
\end{longtable}

We can use market returns to impute market prices relative to the last
day of June 1926.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{price }\OperatorTok{=}\NormalTok{ ff[}\StringTok{\textquotesingle{}Mkt\textquotesingle{}}\NormalTok{].add(}\DecValTok{1}\NormalTok{).cumprod()}

\NormalTok{price.tail()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Date
2024-01-25   11969.2170
2024-01-26   11969.4564
2024-01-29   12073.8301
2024-01-30   12060.7903
2024-01-31   11853.5860
Name: Mkt, dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{price.plot()}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Imputed Market Prices}\CharTok{\textbackslash{}n}\StringTok{Assuming $1 on the Last Day of June 1926\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Imputed Market Price ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.semilogy()}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_lecture_files/figure-pdf/cell-6-output-1.png}

We need lagged prices to estimate \(\rho\). We will add 10 lags of \(P\)
to help us understand the relation between past and future prices.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{price\_lags }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat(}
\NormalTok{        objs}\OperatorTok{=}\NormalTok{[price.shift(t) }\ControlFlowTok{for}\NormalTok{ t }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{11}\NormalTok{)],}
\NormalTok{        keys}\OperatorTok{=}\NormalTok{[}\SpecialStringTok{f\textquotesingle{}Lag }\SpecialCharTok{\{}\NormalTok{t}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}} \ControlFlowTok{for}\NormalTok{ t }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(}\DecValTok{11}\NormalTok{)],}
\NormalTok{        names}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Price\textquotesingle{}}\NormalTok{],}
\NormalTok{        axis}\OperatorTok{=}\DecValTok{1}\NormalTok{,}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{price\_lags.head()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllll@{}}
\toprule\noalign{}
Price & Lag 0 & Lag 1 & Lag 2 & Lag 3 & Lag 4 & Lag 5 & Lag 6 & Lag 7 &
Lag 8 & Lag 9 & Lag 10 \\
Date & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1926-07-01 & 1.0011 & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN &
NaN & NaN \\
1926-07-02 & 1.0057 & 1.0011 & NaN & NaN & NaN & NaN & NaN & NaN & NaN &
NaN & NaN \\
1926-07-06 & 1.0075 & 1.0057 & 1.0011 & NaN & NaN & NaN & NaN & NaN &
NaN & NaN & NaN \\
1926-07-07 & 1.0085 & 1.0075 & 1.0057 & 1.0011 & NaN & NaN & NaN & NaN &
NaN & NaN & NaN \\
1926-07-08 & 1.0107 & 1.0085 & 1.0075 & 1.0057 & 1.0011 & NaN & NaN &
NaN & NaN & NaN & NaN \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    price\_lags}
\NormalTok{    .dropna()}
\NormalTok{    .corr()}
\NormalTok{    .loc[}\StringTok{\textquotesingle{}Lag 0\textquotesingle{}}\NormalTok{]}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Correlations with Imputed Market Price\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Correlation\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_lecture_files/figure-pdf/cell-8-output-1.png}

But these are \emph{pairwise} correlations. If we estimate
\emph{conditional} correlations, we see that most of the price
information is in the first lag!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ price\_lags.dropna()}
\NormalTok{y }\OperatorTok{=}\NormalTok{ \_[}\StringTok{\textquotesingle{}Lag 0\textquotesingle{}}\NormalTok{]}
\NormalTok{X }\OperatorTok{=}\NormalTok{ \_.drop(}\StringTok{\textquotesingle{}Lag 0\textquotesingle{}}\NormalTok{, axis}\OperatorTok{=}\DecValTok{1}\NormalTok{).pipe(sm.add\_constant)}
\NormalTok{model }\OperatorTok{=}\NormalTok{ sm.OLS(endog}\OperatorTok{=}\NormalTok{y, exog}\OperatorTok{=}\NormalTok{X)}
\NormalTok{fit }\OperatorTok{=}\NormalTok{ model.fit(cov\_type}\OperatorTok{=}\StringTok{\textquotesingle{}HAC\textquotesingle{}}\NormalTok{, cov\_kwds}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}maxlags\textquotesingle{}}\NormalTok{: }\DecValTok{10}\NormalTok{\})}
\NormalTok{fit.summary()}
\end{Highlighting}
\end{Shaded}

\begin{center}
\begin{tabular}{lclc}
\toprule
\textbf{Dep. Variable:}    &      Lag 0       & \textbf{  R-squared:         } &      1.000   \\
\textbf{Model:}            &       OLS        & \textbf{  Adj. R-squared:    } &      1.000   \\
\textbf{Method:}           &  Least Squares   & \textbf{  F-statistic:       } &  1.848e+06   \\
\textbf{Date:}             & Fri, 15 Mar 2024 & \textbf{  Prob (F-statistic):} &      0.00    \\
\textbf{Time:}             &     11:16:38     & \textbf{  Log-Likelihood:    } & -1.2242e+05  \\
\textbf{No. Observations:} &       25660      & \textbf{  AIC:               } &  2.449e+05   \\
\textbf{Df Residuals:}     &       25649      & \textbf{  BIC:               } &  2.450e+05   \\
\textbf{Df Model:}         &          10      & \textbf{                     } &              \\
\textbf{Covariance Type:}  &       HAC        & \textbf{                     } &              \\
\bottomrule
\end{tabular}
\begin{tabular}{lcccccc}
                & \textbf{coef} & \textbf{std err} & \textbf{z} & \textbf{P$> |$z$|$} & \textbf{[0.025} & \textbf{0.975]}  \\
\midrule
\textbf{const}  &       0.0590  &        0.143     &     0.412  &         0.680        &       -0.222    &        0.340     \\
\textbf{Lag 1}  &       0.9473  &        0.035     &    27.080  &         0.000        &        0.879    &        1.016     \\
\textbf{Lag 2}  &       0.0778  &        0.060     &     1.287  &         0.198        &       -0.041    &        0.196     \\
\textbf{Lag 3}  &      -0.0342  &        0.038     &    -0.897  &         0.369        &       -0.109    &        0.041     \\
\textbf{Lag 4}  &      -0.0275  &        0.043     &    -0.642  &         0.521        &       -0.112    &        0.057     \\
\textbf{Lag 5}  &       0.0442  &        0.040     &     1.108  &         0.268        &       -0.034    &        0.122     \\
\textbf{Lag 6}  &      -0.0657  &        0.043     &    -1.539  &         0.124        &       -0.149    &        0.018     \\
\textbf{Lag 7}  &       0.1271  &        0.050     &     2.541  &         0.011        &        0.029    &        0.225     \\
\textbf{Lag 8}  &      -0.1299  &        0.056     &    -2.315  &         0.021        &       -0.240    &       -0.020     \\
\textbf{Lag 9}  &       0.1485  &        0.048     &     3.095  &         0.002        &        0.054    &        0.242     \\
\textbf{Lag 10} &      -0.0871  &        0.032     &    -2.705  &         0.007        &       -0.150    &       -0.024     \\
\bottomrule
\end{tabular}
\begin{tabular}{lclc}
\textbf{Omnibus:}       & 15996.444 & \textbf{  Durbin-Watson:     } &      1.993   \\
\textbf{Prob(Omnibus):} &    0.000  & \textbf{  Jarque-Bera (JB):  } & 4983693.037  \\
\textbf{Skew:}          &   -1.823  & \textbf{  Prob(JB):          } &       0.00   \\
\textbf{Kurtosis:}      &   71.176  & \textbf{  Cond. No.          } &   8.90e+03   \\
\bottomrule
\end{tabular}
%\caption{OLS Regression Results}
\end{center}

Notes: \newline
 [1] Standard Errors are heteroscedasticity and autocorrelation robust (HAC) using 10 lags and without small sample correction \newline
 [2] The condition number is large, 8.9e+03. This might indicate that there are \newline
 strong multicollinearity or other numerical problems.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.bar(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{price\_lags.columns[}\DecValTok{1}\NormalTok{:],}
\NormalTok{    height}\OperatorTok{=}\NormalTok{fit.params[}\DecValTok{1}\NormalTok{:],}
\NormalTok{    yerr}\OperatorTok{=}\DecValTok{2}\OperatorTok{*}\NormalTok{fit.bse[}\DecValTok{1}\NormalTok{:]}
\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Conditional Correlations with Imputed Market Price}\CharTok{\textbackslash{}n}\StringTok{Bars Indicate Plus{-}or{-}Minus Standard Errors\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Conditional Correlation\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Price\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_lecture_files/figure-pdf/cell-10-output-1.png}

\subsubsection{Signal-to-Noise Ratio}\label{signal-to-noise-ratio}

Recall, we can express a random walk as
\(P_{t} = \rho P_{t-1} + m P_{t-1} + \varepsilon_t\). Since
\(\rho = 1\), we can subtract \(P_{t-1}\) from both sides, then divide
by \(P_{t-1}\) on both sides. This transformation expresses a random
walk in terms of returns: \(r_{t-1,t} = m + e_t\), where \(E[e_t] = 0\)
and \(SD[e_t] = s\), so \(E[r_{t-1, t}] = m\). We can think of the
signal-to-noise ratio as \(\frac{m}{s}\). How high is this ratio?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{m, s }\OperatorTok{=}\NormalTok{ ff[}\StringTok{\textquotesingle{}Mkt\textquotesingle{}}\NormalTok{].mean(), ff[}\StringTok{\textquotesingle{}Mkt\textquotesingle{}}\NormalTok{].std()}
\end{Highlighting}
\end{Shaded}

Here \(m\) is about 4 basis points per day!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{m}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.0004
\end{verbatim}

However, \(s\) is about 108 basis points per day!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{s}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.0108
\end{verbatim}

Therefore, the signal-to-noise ratio is less than 4 percent!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{m}\OperatorTok{/}\NormalTok{s}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.0392
\end{verbatim}

Recall that means grow linearly with time and standard deviations growth
with the square-root of time. So, if we want
\(\sqrt{t} \times \frac{m}{s} \geq 2\), we need
\(t \geq \left(2 \times \frac{s}{m} \right)^2\) days! Even with market
portfolio noise, which is diversified and low, we needat least a decade!
During this decade, the true values of \(m\) and \(s\) can change!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}\DecValTok{2} \OperatorTok{*}\NormalTok{ s }\OperatorTok{/}\NormalTok{ m)}\OperatorTok{**}\DecValTok{2} \OperatorTok{/} \DecValTok{252}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
10.3088
\end{verbatim}

\section{Implement a simple moving average (SMA) trading
strategy}\label{implement-a-simple-moving-average-sma-trading-strategy}

The goal of technical analysis is to ``buy low, and sell high.'' The
\(n\)-day SMA reduces noise in market prices, removing market
fluctuations and providing estimates of ``true'' prices. While the
market price is \emph{above} the SMA, the SMA \emph{rises.} While the
market price is \emph{below} the SMA, the SMA \emph{falls.} So, if we
buy the stock as it cross the SMA from below and sell the stock as it
crosses the SMA from above, we mechanically buy low and sell high! Here,
we will implement a long-only 20-day SMA (SMA(20)) strategy with
Bitcoin:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Buy when the closing price crosses SMA(20) from below
\item
  Sell when the closing price crosses SMA(20) from above
\item
  No short-selling
\end{enumerate}

Because we will not short sell the stock, we can simplify this strategy
to ``long if above SMA(20), otherwise neutral''. First, we will need
Bitcoin returns data.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}BTC{-}USD\textquotesingle{}}\NormalTok{)}
\NormalTok{    .assign(Return }\OperatorTok{=} \KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].pct\_change())}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{btc.head()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  1 of 1 completed
\end{verbatim}

\begin{longtable}[]{@{}llllllll@{}}
\toprule\noalign{}
Variable & Open & High & Low & Close & Adj Close & Volume & Return \\
Date & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2014-09-17 & 465.8640 & 468.1740 & 452.4220 & 457.3340 & 457.3340 &
21056800 & NaN \\
2014-09-18 & 456.8600 & 456.8600 & 413.1040 & 424.4400 & 424.4400 &
34483200 & -0.0719 \\
2014-09-19 & 424.1030 & 427.8350 & 384.5320 & 394.7960 & 394.7960 &
37919700 & -0.0698 \\
2014-09-20 & 394.6730 & 423.2960 & 389.8830 & 408.9040 & 408.9040 &
36863600 & 0.0357 \\
2014-09-21 & 408.0850 & 412.4260 & 393.1810 & 398.8210 & 398.8210 &
26580100 & -0.0247 \\
\end{longtable}

Next we:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Use \texttt{.rolling(20).mean()} to add a \texttt{SMA20} column
  containing SMA(20) to our \texttt{btc} data frame
\item
  Use \texttt{np.select()} to add a \texttt{Position} column containing:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    \texttt{1} (long) when the adjusted close is greater than SMA(20)
  \item
    \texttt{0} (neutral) when the adjusted close is less than (or equal
    to) SMA(20)
  \item
    We could use \texttt{np.where()} instead of \texttt{np.select()},
    but using \texttt{np.select()} provides a more flexible framework
    for more complex examples
  \item
    \textbf{We use \texttt{.shift()} to compare yesterday's closing
    prices, avoiding a look-ahead bias}
  \end{enumerate}
\item
  Add a \texttt{Strategy} column containing:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    \texttt{Return} if \texttt{Position\ ==\ 1}
  \item
    \texttt{0} if \texttt{Position\ ==\ 0}
  \item
    We could earn the risk-free rate instead of 0 percent, but earning 0
    percent simplifies this example
  \end{enumerate}
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    btc}
\NormalTok{    .assign(}
\NormalTok{        SMA20 }\OperatorTok{=} \KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].rolling(}\DecValTok{20}\NormalTok{).mean(),}
\NormalTok{        Position }\OperatorTok{=} \KeywordTok{lambda}\NormalTok{ x: np.select(}
\NormalTok{            condlist}\OperatorTok{=}\NormalTok{[x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift() }\OperatorTok{\textgreater{}}\NormalTok{ x[}\StringTok{\textquotesingle{}SMA20\textquotesingle{}}\NormalTok{].shift(), x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift() }\OperatorTok{\textless{}=}\NormalTok{ x[}\StringTok{\textquotesingle{}SMA20\textquotesingle{}}\NormalTok{].shift()],}
\NormalTok{            choicelist}\OperatorTok{=}\NormalTok{[}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{],}
\NormalTok{            default}\OperatorTok{=}\NormalTok{np.nan}
\NormalTok{        ),}
\NormalTok{        Strategy }\OperatorTok{=} \KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Position\textquotesingle{}}\NormalTok{] }\OperatorTok{*}\NormalTok{ x[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{btc.head(}\DecValTok{30}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
Variable & Open & High & Low & Close & Adj Close & Volume & Return &
SMA20 & Position & Strategy \\
Date & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2014-09-17 & 465.8640 & 468.1740 & 452.4220 & 457.3340 & 457.3340 &
21056800 & NaN & NaN & NaN & NaN \\
2014-09-18 & 456.8600 & 456.8600 & 413.1040 & 424.4400 & 424.4400 &
34483200 & -0.0719 & NaN & NaN & NaN \\
2014-09-19 & 424.1030 & 427.8350 & 384.5320 & 394.7960 & 394.7960 &
37919700 & -0.0698 & NaN & NaN & NaN \\
2014-09-20 & 394.6730 & 423.2960 & 389.8830 & 408.9040 & 408.9040 &
36863600 & 0.0357 & NaN & NaN & NaN \\
2014-09-21 & 408.0850 & 412.4260 & 393.1810 & 398.8210 & 398.8210 &
26580100 & -0.0247 & NaN & NaN & NaN \\
2014-09-22 & 399.1000 & 406.9160 & 397.1300 & 402.1520 & 402.1520 &
24127600 & 0.0084 & NaN & NaN & NaN \\
2014-09-23 & 402.0920 & 441.5570 & 396.1970 & 435.7910 & 435.7910 &
45099500 & 0.0836 & NaN & NaN & NaN \\
2014-09-24 & 435.7510 & 436.1120 & 421.1320 & 423.2050 & 423.2050 &
30627700 & -0.0289 & NaN & NaN & NaN \\
2014-09-25 & 423.1560 & 423.5200 & 409.4680 & 411.5740 & 411.5740 &
26814400 & -0.0275 & NaN & NaN & NaN \\
2014-09-26 & 411.4290 & 414.9380 & 400.0090 & 404.4250 & 404.4250 &
21460800 & -0.0174 & NaN & NaN & NaN \\
2014-09-27 & 403.5560 & 406.6230 & 397.3720 & 399.5200 & 399.5200 &
15029300 & -0.0121 & NaN & NaN & NaN \\
2014-09-28 & 399.4710 & 401.0170 & 374.3320 & 377.1810 & 377.1810 &
23613300 & -0.0559 & NaN & NaN & NaN \\
2014-09-29 & 376.9280 & 385.2110 & 372.2400 & 375.4670 & 375.4670 &
32497700 & -0.0045 & NaN & NaN & NaN \\
2014-09-30 & 376.0880 & 390.9770 & 373.4430 & 386.9440 & 386.9440 &
34707300 & 0.0306 & NaN & NaN & NaN \\
2014-10-01 & 387.4270 & 391.3790 & 380.7800 & 383.6150 & 383.6150 &
26229400 & -0.0086 & NaN & NaN & NaN \\
2014-10-02 & 383.9880 & 385.4970 & 372.9460 & 375.0720 & 375.0720 &
21777700 & -0.0223 & NaN & NaN & NaN \\
2014-10-03 & 375.1810 & 377.6950 & 357.8590 & 359.5120 & 359.5120 &
30901200 & -0.0415 & NaN & NaN & NaN \\
2014-10-04 & 359.8920 & 364.4870 & 325.8860 & 328.8660 & 328.8660 &
47236500 & -0.0852 & NaN & NaN & NaN \\
2014-10-05 & 328.9160 & 341.8010 & 289.2960 & 320.5100 & 320.5100 &
83308096 & -0.0254 & NaN & NaN & NaN \\
2014-10-06 & 320.3890 & 345.1340 & 302.5600 & 330.0790 & 330.0790 &
79011800 & 0.0299 & 389.9104 & NaN & NaN \\
2014-10-07 & 330.5840 & 339.2470 & 320.4820 & 336.1870 & 336.1870 &
49199900 & 0.0185 & 383.8530 & 0.0000 & 0.0000 \\
2014-10-08 & 336.1160 & 354.3640 & 327.1880 & 352.9400 & 352.9400 &
54736300 & 0.0498 & 380.2780 & 0.0000 & 0.0000 \\
2014-10-09 & 352.7480 & 382.7260 & 347.6870 & 365.0260 & 365.0260 &
83641104 & 0.0342 & 378.7895 & 0.0000 & 0.0000 \\
2014-10-10 & 364.6870 & 375.0670 & 352.9630 & 361.5620 & 361.5620 &
43665700 & -0.0095 & 376.4225 & 0.0000 & -0.0000 \\
2014-10-11 & 361.3620 & 367.1910 & 355.9510 & 362.2990 & 362.2990 &
13345200 & 0.0020 & 374.5964 & 0.0000 & 0.0000 \\
2014-10-12 & 362.6060 & 379.4330 & 356.1440 & 378.5490 & 378.5490 &
17552800 & 0.0449 & 373.4162 & 0.0000 & 0.0000 \\
2014-10-13 & 377.9210 & 397.2260 & 368.8970 & 390.4140 & 390.4140 &
35221400 & 0.0313 & 371.1474 & 1.0000 & 0.0313 \\
2014-10-14 & 391.6920 & 411.6980 & 391.3240 & 400.8700 & 400.8700 &
38491500 & 0.0268 & 370.0306 & 1.0000 & 0.0268 \\
2014-10-15 & 400.9550 & 402.2270 & 388.7660 & 394.7730 & 394.7730 &
25267100 & -0.0152 & 369.1906 & 1.0000 & -0.0152 \\
2014-10-16 & 394.5180 & 398.8070 & 373.0700 & 382.5560 & 382.5560 &
26990000 & -0.0309 & 368.0971 & 1.0000 & -0.0309 \\
\end{longtable}

I find it helpful to plot \texttt{Adj\ Close}, \texttt{SMA20}, and
\texttt{Position} for a sort window with one or more crossings.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fig, ax }\OperatorTok{=}\NormalTok{ plt.subplots(}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, sharex}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ btc.loc[}\StringTok{\textquotesingle{}2023{-}02\textquotesingle{}}\NormalTok{].iloc[}\OperatorTok{{-}}\DecValTok{15}\NormalTok{:]}
\NormalTok{\_[[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}SMA20\textquotesingle{}}\NormalTok{]].plot(ax}\OperatorTok{=}\NormalTok{ax[}\DecValTok{0}\NormalTok{], ylabel}\OperatorTok{=}\StringTok{\textquotesingle{}BTC{-}USD ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{\_[[}\StringTok{\textquotesingle{}Position\textquotesingle{}}\NormalTok{]].plot(ax}\OperatorTok{=}\NormalTok{ax[}\DecValTok{1}\NormalTok{], ylabel}\OperatorTok{=}\StringTok{\textquotesingle{}Position\textquotesingle{}}\NormalTok{, legend}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\NormalTok{plt.suptitle(}\StringTok{\textquotesingle{}Bitcoin SMA(20) Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_lecture_files/figure-pdf/cell-18-output-1.png}

We can compare the long-run performance of buy-and-hold and SMA(20).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ btc[[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]].dropna()}

\NormalTok{(}
\NormalTok{    \_}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Buy{-}And{-}Hold\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}SMA(20)\textquotesingle{}}\NormalTok{\})}
\NormalTok{    .plot()}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Value ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Value of $1 Invested at Close on }\SpecialCharTok{\{}\NormalTok{\_}\SpecialCharTok{.}\NormalTok{index[}\DecValTok{0}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ pd}\SpecialCharTok{.}\NormalTok{offsets}\SpecialCharTok{.}\NormalTok{Day(}\DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{d}\SpecialCharTok{,} \OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_lecture_files/figure-pdf/cell-19-output-1.png}

In the practice notebook, we will dig deeper on this strategy and
others.

\chapter{Herron Topic 2 - Practice for Section
02}\label{herron-topic-2---practice-for-section-02}

\section{Announcements}\label{announcements-32}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Project 2 is due Friday, 3/29, at 11:59 PM
\item
  We will dedicate class next week to group work and easy access to me
  (i.e., no pre-class quiz)
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-31}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Technical analysis studies market trends to estimate where prices may
  go. It looks for patterns in past price moves and trade volumes, and
  traders use these signals to inform their trades.
\item
  There is little evidence that technical analysis works, but it
  provides a context for us to introduce quantitative investing
  strategies.
\item
  \emph{We should never base trades on information we do not have at the
  time of the trade!}
\end{enumerate}

\section{Practice}\label{practice-32}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ matplotlib.ticker }\ImportTok{as}\NormalTok{ ticker}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ seaborn }\ImportTok{as}\NormalTok{ sns}
\ImportTok{import}\NormalTok{ statsmodels.api }\ImportTok{as}\NormalTok{ sm}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{Implement the SMA(20) strategy with Bitcoin from the lecture
notebook}\label{implement-the-sma20-strategy-with-bitcoin-from-the-lecture-notebook}

I suggest writing a function \texttt{calc\_sma()} that accepts a data
frame \texttt{df} and moving average window \texttt{n}. First, we need
the data, from ticker \texttt{BTC-USD} from Yahoo! Finance.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(}\StringTok{\textquotesingle{}BTC{-}USD\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{btc.head(}\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  1 of 1 completed
\end{verbatim}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
Variable & Open & High & Low & Close & Adj Close & Volume \\
Date & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2014-09-17 & 465.8640 & 468.1740 & 452.4220 & 457.3340 & 457.3340 &
21056800 \\
2014-09-18 & 456.8600 & 456.8600 & 413.1040 & 424.4400 & 424.4400 &
34483200 \\
2014-09-19 & 424.1030 & 427.8350 & 384.5320 & 394.7960 & 394.7960 &
37919700 \\
2014-09-20 & 394.6730 & 423.2960 & 389.8830 & 408.9040 & 408.9040 &
36863600 \\
2014-09-21 & 408.0850 & 412.4260 & 393.1810 & 398.8210 & 398.8210 &
26580100 \\
2014-09-22 & 399.1000 & 406.9160 & 397.1300 & 402.1520 & 402.1520 &
24127600 \\
2014-09-23 & 402.0920 & 441.5570 & 396.1970 & 435.7910 & 435.7910 &
45099500 \\
2014-09-24 & 435.7510 & 436.1120 & 421.1320 & 423.2050 & 423.2050 &
30627700 \\
2014-09-25 & 423.1560 & 423.5200 & 409.4680 & 411.5740 & 411.5740 &
26814400 \\
2014-09-26 & 411.4290 & 414.9380 & 400.0090 & 404.4250 & 404.4250 &
21460800 \\
\end{longtable}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

As a side note, Bitcoin trading volume has increased 100,000 times over
the past decade and is volatile!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    btc}
\NormalTok{    [[}\StringTok{\textquotesingle{}Volume\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Close\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .prod(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}
\NormalTok{    .rolling(}\DecValTok{20}\NormalTok{)}
\NormalTok{    .mean()}
\NormalTok{    .plot(logy}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}20{-}Day Rolling Mean of Trading Volume ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Bitcoin Trading Volume Over Time\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_02_files/figure-pdf/cell-5-output-1.png}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

Next, we write a function, since we might want to calculate simple
moving averages (SMAs) more than once. The following
\texttt{calc\_sma()} function accepts:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  A data frame \texttt{df} of daily values from
  \texttt{yfinance.download()}
\item
  An integer \texttt{n} that specifies the number of trading days in the
  SMA window
\end{enumerate}

And returns the original data frame \texttt{df} plus the following
columns:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \texttt{Return} for the daily returns
\item
  \texttt{SMA} for the \texttt{n}-trading-day moving average
\item
  \texttt{Signal} for the weight on the security for each day
\item
  \texttt{Strategy} for the return on the SMA strategy
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_sma(df, n):}
    \ControlFlowTok{return}\NormalTok{ (}
\NormalTok{        df}
\NormalTok{        .assign(}
\NormalTok{            Return}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].pct\_change(),}
\NormalTok{            SMA}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].rolling(n).mean(),}
\NormalTok{            Signal}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.select(}
\NormalTok{                condlist}\OperatorTok{=}\NormalTok{[x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)}\OperatorTok{\textgreater{}}\NormalTok{x[}\StringTok{\textquotesingle{}SMA\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{), x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)}\OperatorTok{\textless{}=}\NormalTok{x[}\StringTok{\textquotesingle{}SMA\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)],}
\NormalTok{                choicelist}\OperatorTok{=}\NormalTok{[}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{],}
\NormalTok{                default}\OperatorTok{=}\NormalTok{np.nan}
\NormalTok{            ),}
\NormalTok{            Strategy}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{] }\OperatorTok{*}\NormalTok{ x[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{        )}
\NormalTok{    )}
\end{Highlighting}
\end{Shaded}

Finally, we calculate the SMA(20). We can drop the last row to avoid
partial trading-day returns. Recall the last row from
\texttt{yfinance.download()} may not be at the close.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc\_sma }\OperatorTok{=}\NormalTok{ btc.iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].pipe(calc\_sma, n}\OperatorTok{=}\DecValTok{20}\NormalTok{)}

\NormalTok{btc\_sma.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
Variable & Open & High & Low & Close & Adj Close & Volume & Return & SMA
& Signal & Strategy \\
Date & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-03-17 & 65316.3438 & 68845.7188 & 64545.3164 & 68390.6250 &
68390.6250 & 44716864318 & 0.0471 & 66530.1934 & 0.0000 & 0.0000 \\
2024-03-18 & 68371.3047 & 68897.1328 & 66594.2266 & 67548.5938 &
67548.5938 & 49261579492 & -0.0123 & 67053.3545 & 1.0000 & -0.0123 \\
2024-03-19 & 67556.1328 & 68106.9297 & 61536.1797 & 61912.7734 &
61912.7734 & 74215844794 & -0.0834 & 67023.7537 & 1.0000 & -0.0834 \\
2024-03-20 & 61930.1562 & 68115.2578 & 60807.7852 & 67913.6719 &
67913.6719 & 66792634382 & 0.0969 & 67359.5182 & 0.0000 & 0.0000 \\
2024-03-21 & 67911.5859 & 68199.9922 & 64580.9180 & 65491.3906 &
65491.3906 & 44480350565 & -0.0357 & 67512.0561 & 1.0000 & -0.0357 \\
\end{longtable}

For Bitcoin, the SMA(20) strategy works well over the full sample!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{names\_sma }\OperatorTok{=}\NormalTok{ \{}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Buy{-}And{-}Hold\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}SMA(20)\textquotesingle{}}\NormalTok{\}}

\NormalTok{\_ }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    btc\_sma}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .dropna()}
\NormalTok{)}

\NormalTok{(}
\NormalTok{    \_}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_sma)}
\NormalTok{    .plot(logy}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Value ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Value of $1 Invested in Bitcoin Strategies}\CharTok{\textbackslash{}n}\SpecialStringTok{at Close on }\SpecialCharTok{\{}\NormalTok{\_}\SpecialCharTok{.}\NormalTok{index[}\DecValTok{0}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ pd}\SpecialCharTok{.}\NormalTok{offsets}\SpecialCharTok{.}\NormalTok{Day(}\DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{d}\SpecialCharTok{,} \OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_02_files/figure-pdf/cell-8-output-1.png}

Here are the final values of \$1 investments, which are difficult to
read on the log scale above.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    btc\_sma}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_sma)}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .prod()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Strategy
Buy-And-Hold   143.2025
SMA(20)        217.6557
dtype: float64
\end{verbatim}

\subsection{How does SMA(20) outperform buy-and-hold with this
sample?}\label{how-does-sma20-outperform-buy-and-hold-with-this-sample}

Consider the following:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Does SMA(20) avoid the worst performing days? How many of the worst 20
  days does SMA(20) avoid? Try the \texttt{.sort\_values()} or
  \texttt{.nlargest()} method.
\item
  Does SMA(20) preferentially avoid low-return days? Try to combine the
  \texttt{.groupby()} method and \texttt{pd.qcut()} function.
\item
  Does SMA(20) preferentially avoid high-volatility days? Try to combine
  the \texttt{.groupby()} method and \texttt{pd.qcut()} function.
\end{enumerate}

The SMA(20) does well here because it avoids 17 of the 20 worst days,
without avoiding the best days.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc\_sma.loc[btc\_sma[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{].nsmallest(}\DecValTok{20}\NormalTok{).index, [}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{]].value\_counts()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Signal
0.0000    17
1.0000     3
Name: count, dtype: int64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc\_sma.loc[btc\_sma[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{].nlargest(}\DecValTok{20}\NormalTok{).index, [}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{]].value\_counts()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Signal
0.0000    10
1.0000    10
Name: count, dtype: int64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    btc\_sma}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_sma)}
\NormalTok{    .groupby(}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{)}
\NormalTok{    [[}\StringTok{\textquotesingle{}Buy{-}And{-}Hold\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}SMA(20)\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .describe()}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Statistic\textquotesingle{}}\NormalTok{])}
\NormalTok{    .stack(}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllll@{}}
\toprule\noalign{}
& Statistic & count & mean & std & min & 25\% & 50\% & 75\% & max \\
Signal & Strategy & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{2}{=}{0.0000} & Buy-And-Hold & 1542.0000 & 0.0008 & 0.0401 &
-0.3717 & -0.0138 & 0.0015 & 0.0163 & 0.2394 \\
& SMA(20) & 1542.0000 & 0.0000 & 0.0000 & 0.0000 & 0.0000 & 0.0000 &
0.0000 & 0.0000 \\
\multirow{2}{=}{1.0000} & Buy-And-Hold & 1912.0000 & 0.0034 & 0.0339 &
-0.1409 & -0.0112 & 0.0015 & 0.0175 & 0.2525 \\
& SMA(20) & 1912.0000 & 0.0034 & 0.0339 & -0.1409 & -0.0112 & 0.0015 &
0.0175 & 0.2525 \\
\end{longtable}

We can also use the seaborn package to visualize \texttt{Signal} (i.e.,
the portfolio weight on Bitcoin) during periods of high and low Bitcoin
returns and volatility. The SMA(20) strategy is long Bitcoin about 55\%
of the time, with Bitcoin returns are high (bin 2) or low (bin 1).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    btc\_sma}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .dropna()}
\NormalTok{    .assign(Return\_Bin}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: }\DecValTok{1} \OperatorTok{+}\NormalTok{ pd.qcut(x[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{], q}\OperatorTok{=}\DecValTok{2}\NormalTok{, labels}\OperatorTok{=}\VariableTok{False}\NormalTok{))}
\NormalTok{    .pipe(}
\NormalTok{        sns.barplot,}
\NormalTok{        x}\OperatorTok{=}\StringTok{\textquotesingle{}Return\_Bin\textquotesingle{}}\NormalTok{,}
\NormalTok{        y}\OperatorTok{=}\StringTok{\textquotesingle{}Signal\textquotesingle{}}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{plt.title(}\StringTok{\textquotesingle{}Percentage of Time SMA(20) Strategy is Long Bitcoin}\CharTok{\textbackslash{}n}\StringTok{by Bitcoin Daily Return Bins\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_02_files/figure-pdf/cell-13-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    btc\_sma}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .dropna()}
\NormalTok{    .assign(Volatility\_Bin}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: }\DecValTok{1} \OperatorTok{+}\NormalTok{ pd.qcut(x[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{].rolling(}\DecValTok{20}\NormalTok{).std(), q}\OperatorTok{=}\DecValTok{2}\NormalTok{, labels}\OperatorTok{=}\VariableTok{False}\NormalTok{))}
\NormalTok{    .pipe(}
\NormalTok{        sns.barplot,}
\NormalTok{        x}\OperatorTok{=}\StringTok{\textquotesingle{}Volatility\_Bin\textquotesingle{}}\NormalTok{,}
\NormalTok{        y}\OperatorTok{=}\StringTok{\textquotesingle{}Signal\textquotesingle{}}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{plt.title(}\StringTok{\textquotesingle{}Percentage of Time SMA(20) Strategy is Long Bitcoin}\CharTok{\textbackslash{}n}\StringTok{by Bitcoin 20{-}Day Volatility Bins\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_02_files/figure-pdf/cell-14-output-1.png}

\subsection{Implement the SMA(20) strategy with the market factor from
French}\label{implement-the-sma20-strategy-with-the-market-factor-from-french}

We need to impute a price before we calculate SMA(20), because French
does not provide a price we can use for technical analysis (TA).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pdr.DataReader(}
\NormalTok{        name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{        data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{        start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{    )}
\NormalTok{    [}\DecValTok{0}\NormalTok{]}
\NormalTok{    .div(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .assign(}
\NormalTok{        Mkt}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ x[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{],}
\NormalTok{        Price}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Mkt\textquotesingle{}}\NormalTok{].add(}\DecValTok{1}\NormalTok{).cumprod()}
\NormalTok{    )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_25516\2105953079.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_sma }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}Price\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{\})}
\NormalTok{    .pipe(calc\_sma, n}\OperatorTok{=}\DecValTok{20}\NormalTok{)}
\NormalTok{)}

\NormalTok{ff\_sma.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
& Mkt-RF & SMB & HML & RF & Mkt & Adj Close & Return & SMA & Signal &
Strategy \\
Date & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-01-25 & 0.0046 & 0.0004 & 0.0056 & 0.0002 & 0.0048 & 11969.2170 &
0.0048 & 11716.9236 & 1.0000 & 0.0048 \\
2024-01-26 & -0.0002 & 0.0040 & -0.0027 & 0.0002 & 0.0000 & 11969.4564 &
0.0000 & 11727.1312 & 1.0000 & 0.0000 \\
2024-01-29 & 0.0085 & 0.0107 & -0.0059 & 0.0002 & 0.0087 & 12073.8301 &
0.0087 & 11742.4928 & 1.0000 & 0.0087 \\
2024-01-30 & -0.0013 & -0.0126 & 0.0084 & 0.0002 & -0.0011 & 12060.7903
& -0.0011 & 11759.6086 & 1.0000 & -0.0011 \\
2024-01-31 & -0.0174 & -0.0092 & -0.0030 & 0.0002 & -0.0172 & 11853.5860
& -0.0172 & 11770.3368 & 1.0000 & -0.0172 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ ff\_sma[[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]].dropna()}

\NormalTok{(}
\NormalTok{    \_}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_sma)}
\NormalTok{    .plot(logy}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Value ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Value of $1 Invested in Market}\CharTok{\textbackslash{}n}\SpecialStringTok{at Close on }\SpecialCharTok{\{}\NormalTok{\_}\SpecialCharTok{.}\NormalTok{index[}\DecValTok{0}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ pd}\SpecialCharTok{.}\NormalTok{offsets}\SpecialCharTok{.}\NormalTok{BDay(}\DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{d}\SpecialCharTok{,} \OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_02_files/figure-pdf/cell-17-output-1.png}

\subsection{How often does SMA(20) outperform buy-and-hold with 1-year
rolling windows with
Bitcoin?}\label{how-often-does-sma20-outperform-buy-and-hold-with-1-year-rolling-windows-with-bitcoin}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    btc\_sma}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .pipe(np.log1p)}
\NormalTok{    .rolling(}\DecValTok{365}\NormalTok{)}
\NormalTok{    .}\BuiltInTok{sum}\NormalTok{()}
\NormalTok{    .pipe(np.expm1)}
\NormalTok{)}

\NormalTok{(}
\NormalTok{    \_}
\NormalTok{    .dropna()}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_sma)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .plot()}
\NormalTok{)}

\NormalTok{plt.title(}\StringTok{\textquotesingle{}One{-}Year Rolling Returns for Bitcoin\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Year Rolling Return (\%)\textquotesingle{}}\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}
    \SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{names\_sma[}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]}\SpecialCharTok{\}}\SpecialStringTok{ \textgreater{} }\SpecialCharTok{\{}\NormalTok{names\_sma[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}\SpecialCharTok{\}}\SpecialStringTok{ for One{-}Year Rolling Window:\textquotesingle{}}\NormalTok{,}
\NormalTok{    (\_[}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}}\NormalTok{ \_[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]).value\_counts(),}
\NormalTok{    sep}\OperatorTok{=}\StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
SMA(20) > Buy-And-Hold for One-Year Rolling Window:
False    2111
True     1363
Name: count, dtype: int64
\end{verbatim}

\includegraphics{herron_02_practice_02_files/figure-pdf/cell-18-output-2.png}

\subsection{Implement a long-only BB(20, 2) strategy with
Bitcoin}\label{implement-a-long-only-bb20-2-strategy-with-bitcoin}

More on Bollinger Bands
\href{https://www.bollingerbands.com/bollinger-bands}{here} and
\href{https://www.bollingerbands.com/bollinger-band-rules}{here}. In
short, Bollinger Bands are bands around a trend, typically defined in
terms of simple moving averages and volatilities. Here, long-only BB(20,
2) implies we have upper and lower bands at 2 standard deviations above
and below SMA(20):

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Buy when the closing price crosses LB(20) from below, where LB(20) is
  SMA(20) minus 2 sigma
\item
  Sell when the closing price crosses UB(20) from above, where UB(20) is
  SMA(20) plus 2 sigma
\item
  No short-selling
\end{enumerate}

The long-only BB(20, 2) is more difficult to implement than the
long-only SMA(20) because we need to track buys and sells. For example,
if the closing price is between LB(20) and BB(20), we need to know if
our last trade was a buy or a sell. Further, if the closing price is
below LB(20), we can still be long because we sell when the closing
price crosses UB(20) from above.

Here is a function to calculate Bolling Bands and implement the
strategy.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_bb(df, m, n):}
    \ControlFlowTok{return}\NormalTok{ (}
\NormalTok{        btc}
\NormalTok{        .assign(}
\NormalTok{            Return}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].pct\_change(),}
\NormalTok{            SMA}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].rolling(m).mean(), }\CommentTok{\# m{-}day simple moving averge}
\NormalTok{            SMV}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].rolling(m).std(), }\CommentTok{\# m{-}day simple moving volatility}
\NormalTok{            LB}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}SMA\textquotesingle{}}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ n}\OperatorTok{*}\NormalTok{x[}\StringTok{\textquotesingle{}SMV\textquotesingle{}}\NormalTok{], }\CommentTok{\# lower band is SMA {-} n*SMV}
\NormalTok{            UB}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}SMA\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ n}\OperatorTok{*}\NormalTok{x[}\StringTok{\textquotesingle{}SMV\textquotesingle{}}\NormalTok{], }\CommentTok{\# upper band is SMA + n*SMV}
\NormalTok{            Signal\_with\_nan}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.select(}
\NormalTok{                condlist}\OperatorTok{=}\NormalTok{[}
                    \CommentTok{\# long when price\textgreater{}LB yesterday but price\textless{}=LB two days ago}
\NormalTok{                    (x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)}\OperatorTok{\textgreater{}}\NormalTok{x[}\StringTok{\textquotesingle{}LB\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)) }\OperatorTok{\&}\NormalTok{ (x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{)}\OperatorTok{\textless{}=}\NormalTok{x[}\StringTok{\textquotesingle{}LB\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{)),}
                    \CommentTok{\# neutral when price\textless{}UB yesterday but price\textgreater{}=UB two days ago}
\NormalTok{                    (x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)}\OperatorTok{\textless{}}\NormalTok{x[}\StringTok{\textquotesingle{}UB\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)) }\OperatorTok{\&}\NormalTok{ (x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{)}\OperatorTok{\textgreater{}=}\NormalTok{x[}\StringTok{\textquotesingle{}UB\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{)),}
\NormalTok{                ],}
\NormalTok{                choicelist}\OperatorTok{=}\NormalTok{[}
                    \DecValTok{1}\NormalTok{,}
                    \DecValTok{0}
\NormalTok{                ],}
\NormalTok{                default}\OperatorTok{=}\NormalTok{np.nan}
\NormalTok{            ),}
\NormalTok{            Signal}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Signal\_with\_nan\textquotesingle{}}\NormalTok{].ffill(), }\CommentTok{\# carryforward last trade decisions}
\NormalTok{            Strategy}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{] }\OperatorTok{*}\NormalTok{ x[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{        )}
\NormalTok{    )}
\end{Highlighting}
\end{Shaded}

Again, we drop the last day to omit partial returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc\_bb }\OperatorTok{=}\NormalTok{ btc.iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].pipe(calc\_bb, m}\OperatorTok{=}\DecValTok{20}\NormalTok{, n}\OperatorTok{=}\DecValTok{2}\NormalTok{)}

\NormalTok{btc\_bb.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllllll@{}}
\toprule\noalign{}
Variable & Open & High & Low & Close & Adj Close & Volume & Return & SMA
& SMV & LB & UB & Signal\_with\_nan & Signal & Strategy \\
Date & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-03-18 & 68371.3047 & 68897.1328 & 66594.2266 & 67548.5938 &
67548.5938 & 49261579492 & -0.0123 & 67053.3545 & 3615.2985 & 59822.7575
& 74283.9515 & NaN & 0.0000 & -0.0000 \\
2024-03-19 & 67556.1328 & 68106.9297 & 61536.1797 & 61912.7734 &
61912.7734 & 74215844794 & -0.0834 & 67023.7537 & 3656.6873 & 59710.3790
& 74337.1284 & NaN & 0.0000 & -0.0000 \\
2024-03-20 & 61930.1562 & 68115.2578 & 60807.7852 & 67913.6719 &
67913.6719 & 66792634382 & 0.0969 & 67359.5182 & 3392.3919 & 60574.7343
& 74144.3020 & NaN & 0.0000 & 0.0000 \\
2024-03-21 & 67911.5859 & 68199.9922 & 64580.9180 & 65491.3906 &
65491.3906 & 44480350565 & -0.0357 & 67512.0561 & 3223.9829 & 61064.0903
& 73960.0218 & NaN & 0.0000 & -0.0000 \\
2024-03-22 & 65492.0781 & 66613.6719 & 62865.6641 & 62865.6641 &
62865.6641 & 42267766784 & -0.0401 & 67553.8469 & 3153.8337 & 61246.1795
& 73861.5142 & NaN & 0.0000 & -0.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{names\_bb }\OperatorTok{=}\NormalTok{ \{}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Buy{-}And{-}Hold\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}BB(20, 2)\textquotesingle{}}\NormalTok{\}}

\NormalTok{\_ }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    btc\_bb}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .dropna()}
\NormalTok{)}

\NormalTok{(}
\NormalTok{    \_}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_bb)}
\NormalTok{    .plot(logy}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Value ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Value of $1 Invested in Bitcoin}\CharTok{\textbackslash{}n}\SpecialStringTok{at Close on }\SpecialCharTok{\{}\NormalTok{\_}\SpecialCharTok{.}\NormalTok{index[}\DecValTok{0}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ pd}\SpecialCharTok{.}\NormalTok{offsets}\SpecialCharTok{.}\NormalTok{Day(}\DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{d}\SpecialCharTok{,} \OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_02_files/figure-pdf/cell-21-output-1.png}

Here are the final values of \$1 investments, which are difficult to
read on the log scale above.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    btc\_bb}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_bb)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .prod()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Strategy
Buy-And-Hold   137.4612
BB(20, 2)        1.8011
dtype: float64
\end{verbatim}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

It might be helpful to plot a few months of Bitcoin prices and signals
to better understand the BB(20, 2) strategy

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fig, ax }\OperatorTok{=}\NormalTok{ plt.subplots(nrows}\OperatorTok{=}\DecValTok{2}\NormalTok{, ncols}\OperatorTok{=}\DecValTok{1}\NormalTok{, sharex}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ btc\_bb.loc[}\StringTok{\textquotesingle{}2023{-}02\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023{-}03\textquotesingle{}}\NormalTok{]}

\NormalTok{ax[}\DecValTok{0}\NormalTok{].plot(\_[[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]], label}\OperatorTok{=}\StringTok{\textquotesingle{}Price\textquotesingle{}}\NormalTok{)}
\NormalTok{ax[}\DecValTok{0}\NormalTok{].plot(\_[[}\StringTok{\textquotesingle{}SMA\textquotesingle{}}\NormalTok{]], label}\OperatorTok{=}\StringTok{\textquotesingle{}SMA(20)\textquotesingle{}}\NormalTok{)}
\NormalTok{ax[}\DecValTok{0}\NormalTok{].plot(\_[[}\StringTok{\textquotesingle{}UB\textquotesingle{}}\NormalTok{]], label}\OperatorTok{=}\StringTok{\textquotesingle{}LB and UB\textquotesingle{}}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}green\textquotesingle{}}\NormalTok{, linestyle}\OperatorTok{=}\StringTok{\textquotesingle{}:\textquotesingle{}}\NormalTok{)}
\NormalTok{ax[}\DecValTok{0}\NormalTok{].plot(\_[[}\StringTok{\textquotesingle{}LB\textquotesingle{}}\NormalTok{]], color}\OperatorTok{=}\StringTok{\textquotesingle{}green\textquotesingle{}}\NormalTok{, linestyle}\OperatorTok{=}\StringTok{\textquotesingle{}:\textquotesingle{}}\NormalTok{)}
\NormalTok{ax[}\DecValTok{0}\NormalTok{].legend()}
\NormalTok{ax[}\DecValTok{0}\NormalTok{].set\_ylabel(}\StringTok{\textquotesingle{}Price ($)\textquotesingle{}}\NormalTok{)}

\NormalTok{ax[}\DecValTok{1}\NormalTok{].plot(\_[[}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{]], label}\OperatorTok{=}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{)}
\NormalTok{ax[}\DecValTok{1}\NormalTok{].legend()}
\NormalTok{ax[}\DecValTok{1}\NormalTok{].set\_ylabel(}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{)}

\NormalTok{ax[}\DecValTok{0}\NormalTok{].yaxis.set\_major\_formatter(ticker.StrMethodFormatter(}\StringTok{\textquotesingle{}}\SpecialCharTok{\{x:,.0f\}}\StringTok{\textquotesingle{}}\NormalTok{))}
\NormalTok{fig.autofmt\_xdate()}

\NormalTok{plt.suptitle(}\StringTok{\textquotesingle{}Key Variables in Bitcoin BB(20, 2) Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_02_files/figure-pdf/cell-23-output-1.png}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\subsection{Implement a long-short RSI(14) strategy with
Bitcoin}\label{implement-a-long-short-rsi14-strategy-with-bitcoin}

From
\href{https://www.fidelity.com/learning-center/trading-investing/technical-analysis/technical-indicator-guide/rsi}{Fidelity}:

\begin{quote}
The Relative Strength Index (RSI), developed by J. Welles Wilder, is a
momentum oscillator that measures the speed and change of price
movements. The RSI oscillates between zero and 100. Traditionally the
RSI is considered overbought when above 70 and oversold when below 30.
Signals can be generated by looking for divergences and failure swings.
RSI can also be used to identify the general trend.
\end{quote}

Here is the RSI formula: \(RSI(n) = 100 - \frac{100}{1 + RS(n)}\), where
\(RS(n) = \frac{SMA(U, n)}{SMA(D, n)}\). For ``up days'',
\(U = \Delta Adj\ Close\) and \(D = 0\), and, for ``down days'',
\(U = 0\) and \(D = - \Delta Adj\ Close\). Therefore, \(U\) and \(D\)
are always non-negative. We can learn more about RSI
\href{https://en.wikipedia.org/wiki/Relative_strength_index}{here}.

We will implement a long-short RSI(14) as follows:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Enter a long position when the RSI crosses 30 from below, and exit the
  position when the RSI crosses 50 from below
\item
  Enter a short position when the RSI crosses 70 from above, and exit
  the position when the RSI crosses 50 from above
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_rsi(df, n, lb, mb, ub):}
    \ControlFlowTok{return}\NormalTok{ df.assign(}
\NormalTok{        Return}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].pct\_change(),}
\NormalTok{        Diff}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].diff(),}
\NormalTok{        U}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.select(}
\NormalTok{            condlist}\OperatorTok{=}\NormalTok{[x[}\StringTok{\textquotesingle{}Diff\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}=} \DecValTok{0}\NormalTok{, x[}\StringTok{\textquotesingle{}Diff\textquotesingle{}}\NormalTok{] }\OperatorTok{\textless{}} \DecValTok{0}\NormalTok{],}
\NormalTok{            choicelist}\OperatorTok{=}\NormalTok{[x[}\StringTok{\textquotesingle{}Diff\textquotesingle{}}\NormalTok{], }\DecValTok{0}\NormalTok{],}
\NormalTok{            default}\OperatorTok{=}\NormalTok{np.nan}
\NormalTok{        ),}
\NormalTok{        D}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.select(}
\NormalTok{            condlist}\OperatorTok{=}\NormalTok{[x[}\StringTok{\textquotesingle{}Diff\textquotesingle{}}\NormalTok{] }\OperatorTok{\textless{}=} \DecValTok{0}\NormalTok{, x[}\StringTok{\textquotesingle{}Diff\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{],}
\NormalTok{            choicelist}\OperatorTok{=}\NormalTok{[}\OperatorTok{{-}}\DecValTok{1} \OperatorTok{*}\NormalTok{ x[}\StringTok{\textquotesingle{}Diff\textquotesingle{}}\NormalTok{], }\DecValTok{0}\NormalTok{],}
\NormalTok{            default}\OperatorTok{=}\NormalTok{np.nan}
\NormalTok{        ),}
\NormalTok{        SMAU}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}U\textquotesingle{}}\NormalTok{].rolling(n).mean(),}
\NormalTok{        SMAD}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}D\textquotesingle{}}\NormalTok{].rolling(n).mean(),}
\NormalTok{        RS}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}SMAU\textquotesingle{}}\NormalTok{] }\OperatorTok{/}\NormalTok{ x[}\StringTok{\textquotesingle{}SMAD\textquotesingle{}}\NormalTok{],}
\NormalTok{        RSI}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: }\DecValTok{100} \OperatorTok{{-}} \DecValTok{100} \OperatorTok{/}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ x[}\StringTok{\textquotesingle{}RS\textquotesingle{}}\NormalTok{]),}
\NormalTok{        Signal\_with\_nan }\OperatorTok{=} \KeywordTok{lambda}\NormalTok{ x: np.select(}
\NormalTok{            condlist}\OperatorTok{=}\NormalTok{[}
\NormalTok{                (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{) }\OperatorTok{\textgreater{}=}\NormalTok{ lb) }\OperatorTok{\&}\NormalTok{ (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{) }\OperatorTok{\textless{}}\NormalTok{ lb), }
\NormalTok{                (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{) }\OperatorTok{\textgreater{}=}\NormalTok{ mb) }\OperatorTok{\&}\NormalTok{ (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{) }\OperatorTok{\textless{}}\NormalTok{ mb),}
\NormalTok{                (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{) }\OperatorTok{\textless{}=}\NormalTok{ ub) }\OperatorTok{\&}\NormalTok{ (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{) }\OperatorTok{\textgreater{}}\NormalTok{ ub), }
\NormalTok{                (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{) }\OperatorTok{\textless{}=}\NormalTok{ mb) }\OperatorTok{\&}\NormalTok{ (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{) }\OperatorTok{\textgreater{}}\NormalTok{ mb),}
\NormalTok{            ],}
\NormalTok{            choicelist}\OperatorTok{=}\NormalTok{[}
                \DecValTok{1}\NormalTok{, }
                \DecValTok{0}\NormalTok{,}
                \OperatorTok{{-}}\DecValTok{1}\NormalTok{,}
                \DecValTok{0}
\NormalTok{            ],}
\NormalTok{            default}\OperatorTok{=}\NormalTok{np.nan}
\NormalTok{        ),}
\NormalTok{        Signal}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Signal\_with\_nan\textquotesingle{}}\NormalTok{].ffill(),}
\NormalTok{        Strategy}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{] }\OperatorTok{*}\NormalTok{ x[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{    )}
\end{Highlighting}
\end{Shaded}

Again, we drop the last day to omit partial returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc\_rsi }\OperatorTok{=}\NormalTok{ btc.iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].pipe(calc\_rsi, n}\OperatorTok{=}\DecValTok{14}\NormalTok{, mb}\OperatorTok{=}\DecValTok{2}\NormalTok{, lb}\OperatorTok{=}\DecValTok{30}\NormalTok{, ub}\OperatorTok{=}\DecValTok{70}\NormalTok{)}

\NormalTok{btc\_rsi.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllll@{}}
\toprule\noalign{}
Variable & Open & High & Low & Close & Adj Close & Volume & Return &
Diff & U & D & SMAU & SMAD & RS & RSI & Signal\_with\_nan & Signal &
Strategy \\
Date & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-03-17 & 65316.3438 & 68845.7188 & 64545.3164 & 68390.6250 &
68390.6250 & 44716864318 & 0.0471 & 3075.5078 & 3075.5078 & 0.0000 &
1297.3906 & 924.3011 & 1.4036 & 58.3965 & NaN & -1.0000 & -0.0471 \\
2024-03-18 & 68371.3047 & 68897.1328 & 66594.2266 & 67548.5938 &
67548.5938 & 49261579492 & -0.0123 & -842.0312 & 0.0000 & 842.0312 &
928.6018 & 984.4461 & 0.9433 & 48.5404 & NaN & -1.0000 & 0.0123 \\
2024-03-19 & 67556.1328 & 68106.9297 & 61536.1797 & 61912.7734 &
61912.7734 & 74215844794 & -0.0834 & -5635.8203 & 0.0000 & 5635.8203 &
928.6018 & 1063.4894 & 0.8732 & 46.6144 & NaN & -1.0000 & 0.0834 \\
2024-03-20 & 61930.1562 & 68115.2578 & 60807.7852 & 67913.6719 &
67913.6719 & 66792634382 & 0.0969 & 6000.8984 & 6000.8984 & 0.0000 &
1192.5513 & 1063.4894 & 1.1214 & 52.8604 & NaN & -1.0000 & -0.0969 \\
2024-03-21 & 67911.5859 & 68199.9922 & 64580.9180 & 65491.3906 &
65491.3906 & 44480350565 & -0.0357 & -2422.2812 & 0.0000 & 2422.2812 &
1134.0742 & 1236.5095 & 0.9172 & 47.8395 & NaN & -1.0000 & 0.0357 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{names\_rsi }\OperatorTok{=}\NormalTok{ \{}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Buy{-}And{-}Hold\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}RSI(14)\textquotesingle{}}\NormalTok{\}}

\NormalTok{\_ }\OperatorTok{=}\NormalTok{ btc\_rsi[[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]].dropna()}

\NormalTok{(}
\NormalTok{    \_}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_rsi)}
\NormalTok{    .plot(logy}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Value ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Value of $1 Invested in Bitcoin Strategies}\CharTok{\textbackslash{}n}\SpecialStringTok{at Close on }\SpecialCharTok{\{}\NormalTok{\_}\SpecialCharTok{.}\NormalTok{index[}\DecValTok{0}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ pd}\SpecialCharTok{.}\NormalTok{offsets}\SpecialCharTok{.}\NormalTok{Day(}\DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{d}\SpecialCharTok{,} \OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_02_files/figure-pdf/cell-26-output-1.png}

Here are the final values of \$1 investments, which are difficult to
read on the log scale above.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    btc\_rsi}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_sma)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .prod()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Strategy
Buy-And-Hold   143.2025
SMA(20)          0.0002
dtype: float64
\end{verbatim}

\textbf{\emph{Shorting Bitcoin has been dangerous!}}

We can compare all three TA strategies!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    btc\_sma[[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .join(}
\NormalTok{        btc\_bb[[}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]].add\_suffix(}\StringTok{\textquotesingle{}\_BB\textquotesingle{}}\NormalTok{), }
\NormalTok{    )}
\NormalTok{    .join(}
\NormalTok{        btc\_rsi[[}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]].add\_suffix(}\StringTok{\textquotesingle{}\_RSI\textquotesingle{}}\NormalTok{), }
\NormalTok{    )}
\NormalTok{    .dropna()}
\NormalTok{)}


\NormalTok{(}
\NormalTok{    \_}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}
\NormalTok{            \{}
                \StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Buy{-}And{-}Hold\textquotesingle{}}\NormalTok{, }
                \StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}SMA(20)\textquotesingle{}}\NormalTok{,}
                \StringTok{\textquotesingle{}Strategy\_BB\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}BB(20, 2)\textquotesingle{}}\NormalTok{,}
                \StringTok{\textquotesingle{}Strategy\_RSI\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}RSI(14)\textquotesingle{}}\NormalTok{,}
\NormalTok{            \}}
\NormalTok{           )}
\NormalTok{    .plot(logy}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Value ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Value of $1 Invested in Bitcoin Strategies}\CharTok{\textbackslash{}n}\SpecialStringTok{at Close on }\SpecialCharTok{\{}\NormalTok{\_}\SpecialCharTok{.}\NormalTok{index[}\DecValTok{0}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ pd}\SpecialCharTok{.}\NormalTok{offsets}\SpecialCharTok{.}\NormalTok{Day(}\DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{d}\SpecialCharTok{,} \OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_02_files/figure-pdf/cell-28-output-1.png}

\chapter{Herron Topic 2 - Practice for Section
03}\label{herron-topic-2---practice-for-section-03}

\section{Announcements}\label{announcements-33}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Project 2 is due Friday, 3/29, at 11:59 PM
\item
  We will dedicate class next week to group work and easy access to me
  (i.e., no pre-class quiz)
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-32}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Technical analysis studies market trends to estimate where prices may
  go. It looks for patterns in past price moves and trade volumes, and
  traders use these signals to inform their trades.
\item
  There is little evidence that technical analysis works, but it
  provides a context for us to introduce quantitative investing
  strategies.
\item
  \emph{We should never base trades on information we do not have at the
  time of the trade!}
\end{enumerate}

\section{Practice}\label{practice-33}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ matplotlib.ticker }\ImportTok{as}\NormalTok{ ticker}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ seaborn }\ImportTok{as}\NormalTok{ sns}
\ImportTok{import}\NormalTok{ statsmodels.api }\ImportTok{as}\NormalTok{ sm}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{Implement the SMA(20) strategy with Bitcoin from the lecture
notebook}\label{implement-the-sma20-strategy-with-bitcoin-from-the-lecture-notebook-1}

I suggest writing a function \texttt{calc\_sma()} that accepts a data
frame \texttt{df} and moving average window \texttt{n}. First, we need
the data, from ticker \texttt{BTC-USD} from Yahoo! Finance.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(}\StringTok{\textquotesingle{}BTC{-}USD\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{btc.head(}\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  1 of 1 completed
\end{verbatim}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
Variable & Open & High & Low & Close & Adj Close & Volume \\
Date & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2014-09-17 & 465.8640 & 468.1740 & 452.4220 & 457.3340 & 457.3340 &
21056800 \\
2014-09-18 & 456.8600 & 456.8600 & 413.1040 & 424.4400 & 424.4400 &
34483200 \\
2014-09-19 & 424.1030 & 427.8350 & 384.5320 & 394.7960 & 394.7960 &
37919700 \\
2014-09-20 & 394.6730 & 423.2960 & 389.8830 & 408.9040 & 408.9040 &
36863600 \\
2014-09-21 & 408.0850 & 412.4260 & 393.1810 & 398.8210 & 398.8210 &
26580100 \\
2014-09-22 & 399.1000 & 406.9160 & 397.1300 & 402.1520 & 402.1520 &
24127600 \\
2014-09-23 & 402.0920 & 441.5570 & 396.1970 & 435.7910 & 435.7910 &
45099500 \\
2014-09-24 & 435.7510 & 436.1120 & 421.1320 & 423.2050 & 423.2050 &
30627700 \\
2014-09-25 & 423.1560 & 423.5200 & 409.4680 & 411.5740 & 411.5740 &
26814400 \\
2014-09-26 & 411.4290 & 414.9380 & 400.0090 & 404.4250 & 404.4250 &
21460800 \\
\end{longtable}

Next, we write a function, since we might want to calculate simple
moving averages (SMAs) more than once. The following
\texttt{calc\_sma()} function accepts:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  A data frame \texttt{df} of daily values from
  \texttt{yfinance.download()}
\item
  An integer \texttt{n} that specifies the number of trading days in the
  SMA window
\end{enumerate}

And returns the original data frame \texttt{df} plus the following
columns:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \texttt{Return} for the daily returns
\item
  \texttt{SMA} for the \texttt{n}-trading-day moving average
\item
  \texttt{Signal} for the weight on the security for each day
\item
  \texttt{Strategy} for the return on the SMA strategy
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_sma(df, n):}
    \ControlFlowTok{return}\NormalTok{ (}
\NormalTok{        df}
\NormalTok{        .assign(}
\NormalTok{            Return}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].pct\_change(),}
\NormalTok{            SMA}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].rolling(n).mean(),}
\NormalTok{            Signal}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.select(}
\NormalTok{                condlist}\OperatorTok{=}\NormalTok{[x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)}\OperatorTok{\textgreater{}}\NormalTok{x[}\StringTok{\textquotesingle{}SMA\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{), x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)}\OperatorTok{\textless{}=}\NormalTok{x[}\StringTok{\textquotesingle{}SMA\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)],}
\NormalTok{                choicelist}\OperatorTok{=}\NormalTok{[}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{],}
\NormalTok{                default}\OperatorTok{=}\NormalTok{np.nan}
\NormalTok{            ),}
\NormalTok{            Strategy}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{] }\OperatorTok{*}\NormalTok{ x[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{        )}
\NormalTok{    )}
\end{Highlighting}
\end{Shaded}

Finally, we calculate the SMA(20). We can drop the last row to avoid
partial trading-day returns. Recall the last row from
\texttt{yfinance.download()} may not be at the close.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc\_sma }\OperatorTok{=}\NormalTok{ btc.iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].pipe(calc\_sma, n}\OperatorTok{=}\DecValTok{20}\NormalTok{)}

\NormalTok{btc\_sma.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
Variable & Open & High & Low & Close & Adj Close & Volume & Return & SMA
& Signal & Strategy \\
Date & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-03-17 & 65316.3438 & 68845.7188 & 64545.3164 & 68390.6250 &
68390.6250 & 44716864318 & 0.0471 & 66530.1934 & 0.0000 & 0.0000 \\
2024-03-18 & 68371.3047 & 68897.1328 & 66594.2266 & 67548.5938 &
67548.5938 & 49261579492 & -0.0123 & 67053.3545 & 1.0000 & -0.0123 \\
2024-03-19 & 67556.1328 & 68106.9297 & 61536.1797 & 61912.7734 &
61912.7734 & 74215844794 & -0.0834 & 67023.7537 & 1.0000 & -0.0834 \\
2024-03-20 & 61930.1562 & 68115.2578 & 60807.7852 & 67913.6719 &
67913.6719 & 66792634382 & 0.0969 & 67359.5182 & 0.0000 & 0.0000 \\
2024-03-21 & 67911.5859 & 68199.9922 & 64580.9180 & 65491.3906 &
65491.3906 & 44480350565 & -0.0357 & 67512.0561 & 1.0000 & -0.0357 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{names\_sma }\OperatorTok{=}\NormalTok{ \{}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Buy{-}And{-}Hold\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}SMA(20)\textquotesingle{}}\NormalTok{\}}

\NormalTok{\_ }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    btc\_sma}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .dropna()}
\NormalTok{)}

\NormalTok{(}
\NormalTok{    \_}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_sma)}
\NormalTok{    .plot(logy}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Value ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Value of $1 Invested in Bitcoin Strategies}\CharTok{\textbackslash{}n}\SpecialStringTok{at Close on }\SpecialCharTok{\{}\NormalTok{\_}\SpecialCharTok{.}\NormalTok{index[}\DecValTok{0}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ pd}\SpecialCharTok{.}\NormalTok{offsets}\SpecialCharTok{.}\NormalTok{Day(}\DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{d}\SpecialCharTok{,} \OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_03_files/figure-pdf/cell-7-output-1.png}

\subsection{How does SMA(20) outperform buy-and-hold with this
sample?}\label{how-does-sma20-outperform-buy-and-hold-with-this-sample-1}

Consider the following:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Does SMA(20) avoid the worst performing days? How many of the worst 20
  days does SMA(20) avoid? Try the \texttt{.sort\_values()} or
  \texttt{.nlargest()} method.
\item
  Does SMA(20) preferentially avoid low-return days? Try to combine the
  \texttt{.groupby()} method and \texttt{pd.qcut()} function.
\item
  Does SMA(20) preferentially avoid high-volatility days? Try to combine
  the \texttt{.groupby()} method and \texttt{pd.qcut()} function.
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc\_sma[[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]].add(}\DecValTok{1}\NormalTok{).prod()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Variable
Return     143.2025
Strategy   217.6557
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc\_sma[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{].nsmallest(}\DecValTok{20}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Date
2020-03-12   -0.3717
2015-01-14   -0.2114
2017-09-14   -0.1874
2015-08-18   -0.1818
2018-01-16   -0.1685
2022-06-13   -0.1597
2018-02-05   -0.1597
2015-01-13   -0.1566
2016-01-15   -0.1533
2022-11-09   -0.1435
2017-01-11   -0.1431
2019-06-27   -0.1409
2021-05-19   -0.1377
2018-11-19   -0.1337
2021-05-12   -0.1332
2021-01-21   -0.1328
2019-07-16   -0.1301
2017-12-22   -0.1247
2017-01-05   -0.1224
2017-12-30   -0.1163
Name: Return, dtype: float64
\end{verbatim}

The SMA(20) does well here because it avoids 17 of the 20 worst days,
without avoiding the best days.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc\_sma.loc[btc\_sma[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{].nsmallest(}\DecValTok{20}\NormalTok{).index, }\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{].value\_counts()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Signal
0.0000    17
1.0000     3
Name: count, dtype: int64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc\_sma.loc[btc\_sma[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{].nlargest(}\DecValTok{100}\NormalTok{).index, }\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{].value\_counts()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Signal
0.0000    52
1.0000    47
Name: count, dtype: int64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    btc\_sma}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Buy{-}And{-}Hold\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}SMA(20)\textquotesingle{}}\NormalTok{\})}
\NormalTok{    .groupby(}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{)}
\NormalTok{    [[}\StringTok{\textquotesingle{}Buy{-}And{-}Hold\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}SMA(20)\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .describe()}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Statistic\textquotesingle{}}\NormalTok{])}
\NormalTok{    .stack(}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllll@{}}
\toprule\noalign{}
& Statistic & count & mean & std & min & 25\% & 50\% & 75\% & max \\
Signal & Strategy & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{2}{=}{0.0000} & Buy-And-Hold & 1542.0000 & 0.0008 & 0.0401 &
-0.3717 & -0.0138 & 0.0015 & 0.0163 & 0.2394 \\
& SMA(20) & 1542.0000 & 0.0000 & 0.0000 & 0.0000 & 0.0000 & 0.0000 &
0.0000 & 0.0000 \\
\multirow{2}{=}{1.0000} & Buy-And-Hold & 1912.0000 & 0.0034 & 0.0339 &
-0.1409 & -0.0112 & 0.0015 & 0.0175 & 0.2525 \\
& SMA(20) & 1912.0000 & 0.0034 & 0.0339 & -0.1409 & -0.0112 & 0.0015 &
0.0175 & 0.2525 \\
\end{longtable}

We can also use the seaborn package to visualize \texttt{Signal} (i.e.,
the portfolio weight on Bitcoin) during periods of high and low Bitcoin
returns and volatility. The SMA(20) strategy is long Bitcoin about 55\%
of the time, with Bitcoin returns are high (bin 2) or low (bin 1).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    btc\_sma}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .dropna()}
\NormalTok{    .assign(Return\_Bin}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: }\DecValTok{1} \OperatorTok{+}\NormalTok{ pd.qcut(x[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{], q}\OperatorTok{=}\DecValTok{2}\NormalTok{, labels}\OperatorTok{=}\VariableTok{False}\NormalTok{))}
\NormalTok{    .pipe(}
\NormalTok{        sns.barplot,}
\NormalTok{        x}\OperatorTok{=}\StringTok{\textquotesingle{}Return\_Bin\textquotesingle{}}\NormalTok{,}
\NormalTok{        y}\OperatorTok{=}\StringTok{\textquotesingle{}Signal\textquotesingle{}}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{plt.title(}\StringTok{\textquotesingle{}Percentage of Time SMA(20) Strategy is Long Bitcoin}\CharTok{\textbackslash{}n}\StringTok{by Bitcoin Daily Return Bins\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_03_files/figure-pdf/cell-13-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    btc\_sma}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .dropna()}
\NormalTok{    .assign(Volatility\_Bin}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: }\DecValTok{1} \OperatorTok{+}\NormalTok{ pd.qcut(x[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{].rolling(}\DecValTok{20}\NormalTok{).std(), q}\OperatorTok{=}\DecValTok{2}\NormalTok{, labels}\OperatorTok{=}\VariableTok{False}\NormalTok{))}
\NormalTok{    .pipe(}
\NormalTok{        sns.barplot,}
\NormalTok{        x}\OperatorTok{=}\StringTok{\textquotesingle{}Volatility\_Bin\textquotesingle{}}\NormalTok{,}
\NormalTok{        y}\OperatorTok{=}\StringTok{\textquotesingle{}Signal\textquotesingle{}}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{plt.title(}\StringTok{\textquotesingle{}Percentage of Time SMA(20) Strategy is Long Bitcoin}\CharTok{\textbackslash{}n}\StringTok{by Bitcoin 20{-}Day Volatility Bins\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_03_files/figure-pdf/cell-14-output-1.png}

\subsection{Implement the SMA(20) strategy with the market factor from
French}\label{implement-the-sma20-strategy-with-the-market-factor-from-french-1}

We need to impute a market price before we calculate SMA(20).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pdr.DataReader(}
\NormalTok{        name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{        data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{        start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{    )}
\NormalTok{    [}\DecValTok{0}\NormalTok{]}
\NormalTok{    .div(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .assign(}
\NormalTok{        Mkt}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ x[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{],}
\NormalTok{        Price}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Mkt\textquotesingle{}}\NormalTok{].add(}\DecValTok{1}\NormalTok{).cumprod()}
\NormalTok{    )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_10212\2105953079.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_sma }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}Price\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{\})}
\NormalTok{    .pipe(calc\_sma, n}\OperatorTok{=}\DecValTok{20}\NormalTok{)}
\NormalTok{)}

\NormalTok{ff\_sma.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
& Mkt-RF & SMB & HML & RF & Mkt & Adj Close & Return & SMA & Signal &
Strategy \\
Date & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-01-25 & 0.0046 & 0.0004 & 0.0056 & 0.0002 & 0.0048 & 11969.2170 &
0.0048 & 11716.9236 & 1.0000 & 0.0048 \\
2024-01-26 & -0.0002 & 0.0040 & -0.0027 & 0.0002 & 0.0000 & 11969.4564 &
0.0000 & 11727.1312 & 1.0000 & 0.0000 \\
2024-01-29 & 0.0085 & 0.0107 & -0.0059 & 0.0002 & 0.0087 & 12073.8301 &
0.0087 & 11742.4928 & 1.0000 & 0.0087 \\
2024-01-30 & -0.0013 & -0.0126 & 0.0084 & 0.0002 & -0.0011 & 12060.7903
& -0.0011 & 11759.6086 & 1.0000 & -0.0011 \\
2024-01-31 & -0.0174 & -0.0092 & -0.0030 & 0.0002 & -0.0172 & 11853.5860
& -0.0172 & 11770.3368 & 1.0000 & -0.0172 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ ff\_sma[[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]].dropna()}

\NormalTok{(}
\NormalTok{    \_}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_sma)}
\NormalTok{    .plot(logy}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Value ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Value of $1 Invested in Market}\CharTok{\textbackslash{}n}\SpecialStringTok{at Close on }\SpecialCharTok{\{}\NormalTok{\_}\SpecialCharTok{.}\NormalTok{index[}\DecValTok{0}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ pd}\SpecialCharTok{.}\NormalTok{offsets}\SpecialCharTok{.}\NormalTok{BDay(}\DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{d}\SpecialCharTok{,} \OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_03_files/figure-pdf/cell-17-output-1.png}

\subsection{How often does SMA(20) outperform buy-and-hold with 1-year
rolling windows with
Bitcoin?}\label{how-often-does-sma20-outperform-buy-and-hold-with-1-year-rolling-windows-with-bitcoin-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    btc\_sma}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .pipe(np.log1p)}
\NormalTok{    .rolling(}\DecValTok{365}\NormalTok{)}
\NormalTok{    .}\BuiltInTok{sum}\NormalTok{()}
\NormalTok{    .pipe(np.expm1)}
\NormalTok{)}

\NormalTok{(}
\NormalTok{    \_}
\NormalTok{    .dropna()}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_sma)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .plot()}
\NormalTok{)}

\NormalTok{plt.title(}\StringTok{\textquotesingle{}One{-}Year Rolling Returns for Bitcoin\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Year Rolling Return (\%)\textquotesingle{}}\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}
    \SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{names\_sma[}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]}\SpecialCharTok{\}}\SpecialStringTok{ \textgreater{} }\SpecialCharTok{\{}\NormalTok{names\_sma[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}\SpecialCharTok{\}}\SpecialStringTok{ for One{-}Year Rolling Window:\textquotesingle{}}\NormalTok{,}
\NormalTok{    (\_[}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}}\NormalTok{ \_[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]).value\_counts(),}
\NormalTok{    sep}\OperatorTok{=}\StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
SMA(20) > Buy-And-Hold for One-Year Rolling Window:
False    2111
True     1363
Name: count, dtype: int64
\end{verbatim}

\includegraphics{herron_02_practice_03_files/figure-pdf/cell-18-output-2.png}

\subsection{Implement a long-only BB(20, 2) strategy with
Bitcoin}\label{implement-a-long-only-bb20-2-strategy-with-bitcoin-1}

More on Bollinger Bands
\href{https://www.bollingerbands.com/bollinger-bands}{here} and
\href{https://www.bollingerbands.com/bollinger-band-rules}{here}. In
short, Bollinger Bands are bands around a trend, typically defined in
terms of simple moving averages and volatilities. Here, long-only BB(20,
2) implies we have upper and lower bands at 2 standard deviations above
and below SMA(20):

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Buy when the closing price crosses LB(20) from below, where LB(20) is
  SMA(20) minus 2 sigma
\item
  Sell when the closing price crosses UB(20) from above, where UB(20) is
  SMA(20) plus 2 sigma
\item
  No short-selling
\end{enumerate}

The long-only BB(20, 2) is more difficult to implement than the
long-only SMA(20) because we need to track buys and sells. For example,
if the closing price is between LB(20) and BB(20), we need to know if
our last trade was a buy or a sell. Further, if the closing price is
below LB(20), we can still be long because we sell when the closing
price crosses UB(20) from above.

Here is a function to calculate Bolling Bands and implement the
strategy.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_bb(df, m, n):}
    \ControlFlowTok{return}\NormalTok{ (}
\NormalTok{        df}
\NormalTok{        .assign(}
\NormalTok{            Return}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].pct\_change(),}
\NormalTok{            SMA}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].rolling(m).mean(),}
\NormalTok{            SMV}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].rolling(m).std(),}
\NormalTok{            UB}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}SMA\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ n}\OperatorTok{*}\NormalTok{x[}\StringTok{\textquotesingle{}SMV\textquotesingle{}}\NormalTok{],}
\NormalTok{            LB}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}SMA\textquotesingle{}}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ n}\OperatorTok{*}\NormalTok{x[}\StringTok{\textquotesingle{}SMV\textquotesingle{}}\NormalTok{],}
\NormalTok{            Signal\_with\_nan}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.select(}
\NormalTok{                condlist}\OperatorTok{=}\NormalTok{[}
\NormalTok{                    (x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{) }\OperatorTok{\textgreater{}}\NormalTok{ x[}\StringTok{\textquotesingle{}LB\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)) }\OperatorTok{\&}\NormalTok{ (x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{) }\OperatorTok{\textless{}=}\NormalTok{ x[}\StringTok{\textquotesingle{}LB\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{)),}
\NormalTok{                    (x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{) }\OperatorTok{\textless{}}\NormalTok{ x[}\StringTok{\textquotesingle{}UB\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)) }\OperatorTok{\&}\NormalTok{ (x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{) }\OperatorTok{\textgreater{}=}\NormalTok{ x[}\StringTok{\textquotesingle{}UB\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{))}
\NormalTok{                ],}
\NormalTok{                choicelist}\OperatorTok{=}\NormalTok{[}
                    \DecValTok{1}\NormalTok{,}
                    \DecValTok{0}
\NormalTok{                ],}
\NormalTok{                default}\OperatorTok{=}\NormalTok{np.nan}
\NormalTok{            ),}
\NormalTok{            Signal}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Signal\_with\_nan\textquotesingle{}}\NormalTok{].ffill(),}
\NormalTok{            Strategy}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{] }\OperatorTok{*}\NormalTok{ x[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{        )}
\NormalTok{    )}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc\_bb }\OperatorTok{=}\NormalTok{ btc.iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].pipe(calc\_bb, m}\OperatorTok{=}\DecValTok{20}\NormalTok{, n}\OperatorTok{=}\DecValTok{2}\NormalTok{)}

\NormalTok{btc\_bb.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllllll@{}}
\toprule\noalign{}
Variable & Open & High & Low & Close & Adj Close & Volume & Return & SMA
& SMV & UB & LB & Signal\_with\_nan & Signal & Strategy \\
Date & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-03-17 & 65316.3438 & 68845.7188 & 64545.3164 & 68390.6250 &
68390.6250 & 44716864318 & 0.0471 & 66530.1934 & 4242.5090 & 75015.2113
& 58045.1755 & NaN & 0.0000 & 0.0000 \\
2024-03-18 & 68371.3047 & 68897.1328 & 66594.2266 & 67548.5938 &
67548.5938 & 49261579492 & -0.0123 & 67053.3545 & 3615.2985 & 74283.9515
& 59822.7575 & NaN & 0.0000 & -0.0000 \\
2024-03-19 & 67556.1328 & 68106.9297 & 61536.1797 & 61912.7734 &
61912.7734 & 74215844794 & -0.0834 & 67023.7537 & 3656.6873 & 74337.1284
& 59710.3790 & NaN & 0.0000 & -0.0000 \\
2024-03-20 & 61930.1562 & 68115.2578 & 60807.7852 & 67913.6719 &
67913.6719 & 66792634382 & 0.0969 & 67359.5182 & 3392.3919 & 74144.3020
& 60574.7343 & NaN & 0.0000 & 0.0000 \\
2024-03-21 & 67911.5859 & 68199.9922 & 64580.9180 & 65491.3906 &
65491.3906 & 44480350565 & -0.0357 & 67512.0561 & 3223.9829 & 73960.0218
& 61064.0903 & NaN & 0.0000 & -0.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{names\_bb }\OperatorTok{=}\NormalTok{ \{}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Buy{-}And{-}Hold\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}BB(20, 2)\textquotesingle{}}\NormalTok{\}}

\NormalTok{\_ }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    btc\_bb}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .dropna()}
\NormalTok{)}

\NormalTok{(}
\NormalTok{    \_}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_bb)}
\NormalTok{    .plot(logy}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Value ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Value of $1 Invested in Bitcoin}\CharTok{\textbackslash{}n}\SpecialStringTok{at Close on }\SpecialCharTok{\{}\NormalTok{\_}\SpecialCharTok{.}\NormalTok{index[}\DecValTok{0}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ pd}\SpecialCharTok{.}\NormalTok{offsets}\SpecialCharTok{.}\NormalTok{Day(}\DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{d}\SpecialCharTok{,} \OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_03_files/figure-pdf/cell-21-output-1.png}

Here are the final values of \$1 investments, which are difficult to
read on the log scale above.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    btc\_bb}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_bb)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .prod()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Strategy
Buy-And-Hold   143.2025
BB(20, 2)        1.8011
dtype: float64
\end{verbatim}

This strategy trades about 30 round-trips during this sample.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc\_bb[}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{].diff().value\_counts()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Signal
0.0000     3370
-1.0000      30
1.0000       29
Name: count, dtype: int64
\end{verbatim}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

We can tweak our \texttt{calc\_bb()} function!

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_bb\_2(df, m, n):}
    \ControlFlowTok{return}\NormalTok{ (}
\NormalTok{        df}
\NormalTok{        .assign(}
\NormalTok{            Return}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].pct\_change(),}
\NormalTok{            SMA}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].rolling(m).mean(),}
\NormalTok{            SMV}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].rolling(m).std(),}
\NormalTok{            UB}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}SMA\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ n}\OperatorTok{*}\NormalTok{x[}\StringTok{\textquotesingle{}SMV\textquotesingle{}}\NormalTok{],}
\NormalTok{            LB}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}SMA\textquotesingle{}}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ n}\OperatorTok{*}\NormalTok{x[}\StringTok{\textquotesingle{}SMV\textquotesingle{}}\NormalTok{],}
\NormalTok{            Signal\_with\_nan}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.select(}
\NormalTok{                condlist}\OperatorTok{=}\NormalTok{[}
\NormalTok{                    (x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{) }\OperatorTok{\textgreater{}}\NormalTok{ x[}\StringTok{\textquotesingle{}LB\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)) }\OperatorTok{\&}\NormalTok{ (x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{) }\OperatorTok{\textgreater{}}\NormalTok{ x[}\StringTok{\textquotesingle{}LB\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{)) }\OperatorTok{\&}\NormalTok{ (x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{3}\NormalTok{) }\OperatorTok{\textless{}=}\NormalTok{ x[}\StringTok{\textquotesingle{}LB\textquotesingle{}}\NormalTok{].shift(}\DecValTok{3}\NormalTok{)),}
\NormalTok{                    (x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{) }\OperatorTok{\textless{}}\NormalTok{ x[}\StringTok{\textquotesingle{}UB\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)) }\OperatorTok{\&}\NormalTok{ (x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{) }\OperatorTok{\textless{}}\NormalTok{ x[}\StringTok{\textquotesingle{}UB\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{)) }\OperatorTok{\&}\NormalTok{ (x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{3}\NormalTok{) }\OperatorTok{\textgreater{}=}\NormalTok{ x[}\StringTok{\textquotesingle{}UB\textquotesingle{}}\NormalTok{].shift(}\DecValTok{3}\NormalTok{))}
\NormalTok{                ],}
\NormalTok{                choicelist}\OperatorTok{=}\NormalTok{[}
                    \DecValTok{1}\NormalTok{,}
                    \DecValTok{0}
\NormalTok{                ],}
\NormalTok{                default}\OperatorTok{=}\NormalTok{np.nan}
\NormalTok{            ),}
\NormalTok{            Signal}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Signal\_with\_nan\textquotesingle{}}\NormalTok{].ffill(),}
\NormalTok{            Strategy}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{] }\OperatorTok{*}\NormalTok{ x[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{        )}
\NormalTok{    )}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc\_bb\_2 }\OperatorTok{=}\NormalTok{ btc.iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].pipe(calc\_bb\_2, m}\OperatorTok{=}\DecValTok{20}\NormalTok{, n}\OperatorTok{=}\DecValTok{2}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

But this tweak does not improve performance, at least for this security
and this sample.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc\_bb\_2[[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]].dropna().add(}\DecValTok{1}\NormalTok{).cumprod().plot(logy}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_03_files/figure-pdf/cell-26-output-1.png}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

We need a more complex plot to better understand what is going on!

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.ticker }\ImportTok{as}\NormalTok{ ticker}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fig, ax }\OperatorTok{=}\NormalTok{ plt.subplots(nrows}\OperatorTok{=}\DecValTok{2}\NormalTok{, ncols}\OperatorTok{=}\DecValTok{1}\NormalTok{, sharex}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ btc\_bb.loc[}\StringTok{\textquotesingle{}2023{-}02\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023{-}03\textquotesingle{}}\NormalTok{]}

\NormalTok{ax[}\DecValTok{0}\NormalTok{].plot(\_[[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]], label}\OperatorTok{=}\StringTok{\textquotesingle{}Price\textquotesingle{}}\NormalTok{)}
\NormalTok{ax[}\DecValTok{0}\NormalTok{].plot(\_[[}\StringTok{\textquotesingle{}SMA\textquotesingle{}}\NormalTok{]], label}\OperatorTok{=}\StringTok{\textquotesingle{}SMA(20)\textquotesingle{}}\NormalTok{)}
\NormalTok{ax[}\DecValTok{0}\NormalTok{].plot(\_[[}\StringTok{\textquotesingle{}UB\textquotesingle{}}\NormalTok{]], label}\OperatorTok{=}\StringTok{\textquotesingle{}LB and UB\textquotesingle{}}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}green\textquotesingle{}}\NormalTok{, linestyle}\OperatorTok{=}\StringTok{\textquotesingle{}:\textquotesingle{}}\NormalTok{)}
\NormalTok{ax[}\DecValTok{0}\NormalTok{].plot(\_[[}\StringTok{\textquotesingle{}LB\textquotesingle{}}\NormalTok{]], color}\OperatorTok{=}\StringTok{\textquotesingle{}green\textquotesingle{}}\NormalTok{, linestyle}\OperatorTok{=}\StringTok{\textquotesingle{}:\textquotesingle{}}\NormalTok{)}
\NormalTok{ax[}\DecValTok{0}\NormalTok{].legend()}
\NormalTok{ax[}\DecValTok{0}\NormalTok{].set\_ylabel(}\StringTok{\textquotesingle{}Price ($)\textquotesingle{}}\NormalTok{)}

\NormalTok{ax[}\DecValTok{1}\NormalTok{].plot(\_[[}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{]], label}\OperatorTok{=}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{)}
\NormalTok{ax[}\DecValTok{1}\NormalTok{].legend()}
\NormalTok{ax[}\DecValTok{1}\NormalTok{].set\_ylabel(}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{)}

\NormalTok{ax[}\DecValTok{0}\NormalTok{].yaxis.set\_major\_formatter(ticker.StrMethodFormatter(}\StringTok{\textquotesingle{}}\SpecialCharTok{\{x:,.0f\}}\StringTok{\textquotesingle{}}\NormalTok{))}
\NormalTok{fig.autofmt\_xdate()}

\NormalTok{plt.suptitle(}\StringTok{\textquotesingle{}Key Variables in Bitcoin BB(20, 2) Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_03_files/figure-pdf/cell-28-output-1.png}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\subsection{Implement a long-short RSI(14) strategy with
Bitcoin}\label{implement-a-long-short-rsi14-strategy-with-bitcoin-1}

From
\href{https://www.fidelity.com/learning-center/trading-investing/technical-analysis/technical-indicator-guide/rsi}{Fidelity}:

\begin{quote}
The Relative Strength Index (RSI), developed by J. Welles Wilder, is a
momentum oscillator that measures the speed and change of price
movements. The RSI oscillates between zero and 100. Traditionally the
RSI is considered overbought when above 70 and oversold when below 30.
Signals can be generated by looking for divergences and failure swings.
RSI can also be used to identify the general trend.
\end{quote}

Here is the RSI formula: \(RSI(n) = 100 - \frac{100}{1 + RS(n)}\), where
\(RS(n) = \frac{SMA(U, n)}{SMA(D, n)}\). For ``up days'',
\(U = \Delta Adj\ Close\) and \(D = 0\), and, for ``down days'',
\(U = 0\) and \(D = - \Delta Adj\ Close\). Therefore, \(U\) and \(D\)
are always non-negative. We can learn more about RSI
\href{https://en.wikipedia.org/wiki/Relative_strength_index}{here}.

We will implement a long-short RSI(14) as follows:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Enter a long position when the RSI crosses 30 from below, and exit the
  position when the RSI crosses 50 from below
\item
  Enter a short position when the RSI crosses 70 from above, and exit
  the position when the RSI crosses 50 from above
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_rsi(df, n, lb, mb, ub):}
    \ControlFlowTok{return}\NormalTok{ df.assign(}
\NormalTok{        Return}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].pct\_change(),}
\NormalTok{        Diff}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].diff(),}
\NormalTok{        U}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.select(}
\NormalTok{            condlist}\OperatorTok{=}\NormalTok{[x[}\StringTok{\textquotesingle{}Diff\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}=} \DecValTok{0}\NormalTok{, x[}\StringTok{\textquotesingle{}Diff\textquotesingle{}}\NormalTok{] }\OperatorTok{\textless{}} \DecValTok{0}\NormalTok{],}
\NormalTok{            choicelist}\OperatorTok{=}\NormalTok{[x[}\StringTok{\textquotesingle{}Diff\textquotesingle{}}\NormalTok{], }\DecValTok{0}\NormalTok{],}
\NormalTok{            default}\OperatorTok{=}\NormalTok{np.nan}
\NormalTok{        ),}
\NormalTok{        D}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.select(}
\NormalTok{            condlist}\OperatorTok{=}\NormalTok{[x[}\StringTok{\textquotesingle{}Diff\textquotesingle{}}\NormalTok{] }\OperatorTok{\textless{}=} \DecValTok{0}\NormalTok{, x[}\StringTok{\textquotesingle{}Diff\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{],}
\NormalTok{            choicelist}\OperatorTok{=}\NormalTok{[}\OperatorTok{{-}}\DecValTok{1} \OperatorTok{*}\NormalTok{ x[}\StringTok{\textquotesingle{}Diff\textquotesingle{}}\NormalTok{], }\DecValTok{0}\NormalTok{],}
\NormalTok{            default}\OperatorTok{=}\NormalTok{np.nan}
\NormalTok{        ),}
\NormalTok{        SMAU}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}U\textquotesingle{}}\NormalTok{].rolling(n).mean(),}
\NormalTok{        SMAD}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}D\textquotesingle{}}\NormalTok{].rolling(n).mean(),}
\NormalTok{        RS}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}SMAU\textquotesingle{}}\NormalTok{] }\OperatorTok{/}\NormalTok{ x[}\StringTok{\textquotesingle{}SMAD\textquotesingle{}}\NormalTok{],}
\NormalTok{        RSI}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: }\DecValTok{100} \OperatorTok{{-}} \DecValTok{100} \OperatorTok{/}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ x[}\StringTok{\textquotesingle{}RS\textquotesingle{}}\NormalTok{]),}
\NormalTok{        Signal\_with\_nan }\OperatorTok{=} \KeywordTok{lambda}\NormalTok{ x: np.select(}
\NormalTok{            condlist}\OperatorTok{=}\NormalTok{[}
\NormalTok{                (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{) }\OperatorTok{\textgreater{}=}\NormalTok{ lb) }\OperatorTok{\&}\NormalTok{ (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{) }\OperatorTok{\textless{}}\NormalTok{ lb), }
\NormalTok{                (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{) }\OperatorTok{\textgreater{}=}\NormalTok{ mb) }\OperatorTok{\&}\NormalTok{ (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{) }\OperatorTok{\textless{}}\NormalTok{ mb),}
\NormalTok{                (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{) }\OperatorTok{\textless{}=}\NormalTok{ ub) }\OperatorTok{\&}\NormalTok{ (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{) }\OperatorTok{\textgreater{}}\NormalTok{ ub), }
\NormalTok{                (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{) }\OperatorTok{\textless{}=}\NormalTok{ mb) }\OperatorTok{\&}\NormalTok{ (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{) }\OperatorTok{\textgreater{}}\NormalTok{ mb),}
\NormalTok{            ],}
\NormalTok{            choicelist}\OperatorTok{=}\NormalTok{[}
                \DecValTok{1}\NormalTok{, }
                \DecValTok{0}\NormalTok{,}
                \OperatorTok{{-}}\DecValTok{1}\NormalTok{,}
                \DecValTok{0}
\NormalTok{            ],}
\NormalTok{            default}\OperatorTok{=}\NormalTok{np.nan}
\NormalTok{        ),}
\NormalTok{        Signal}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Signal\_with\_nan\textquotesingle{}}\NormalTok{].ffill(),}
\NormalTok{        Strategy}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{] }\OperatorTok{*}\NormalTok{ x[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{    )}
\end{Highlighting}
\end{Shaded}

Again, we drop the last day to omit partial returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc\_rsi }\OperatorTok{=}\NormalTok{ btc.iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].pipe(calc\_rsi, n}\OperatorTok{=}\DecValTok{14}\NormalTok{, mb}\OperatorTok{=}\DecValTok{2}\NormalTok{, lb}\OperatorTok{=}\DecValTok{30}\NormalTok{, ub}\OperatorTok{=}\DecValTok{70}\NormalTok{)}

\NormalTok{btc\_rsi.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllll@{}}
\toprule\noalign{}
Variable & Open & High & Low & Close & Adj Close & Volume & Return &
Diff & U & D & SMAU & SMAD & RS & RSI & Signal\_with\_nan & Signal &
Strategy \\
Date & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-03-17 & 65316.3438 & 68845.7188 & 64545.3164 & 68390.6250 &
68390.6250 & 44716864318 & 0.0471 & 3075.5078 & 3075.5078 & 0.0000 &
1297.3906 & 924.3011 & 1.4036 & 58.3965 & NaN & -1.0000 & -0.0471 \\
2024-03-18 & 68371.3047 & 68897.1328 & 66594.2266 & 67548.5938 &
67548.5938 & 49261579492 & -0.0123 & -842.0312 & 0.0000 & 842.0312 &
928.6018 & 984.4461 & 0.9433 & 48.5404 & NaN & -1.0000 & 0.0123 \\
2024-03-19 & 67556.1328 & 68106.9297 & 61536.1797 & 61912.7734 &
61912.7734 & 74215844794 & -0.0834 & -5635.8203 & 0.0000 & 5635.8203 &
928.6018 & 1063.4894 & 0.8732 & 46.6144 & NaN & -1.0000 & 0.0834 \\
2024-03-20 & 61930.1562 & 68115.2578 & 60807.7852 & 67913.6719 &
67913.6719 & 66792634382 & 0.0969 & 6000.8984 & 6000.8984 & 0.0000 &
1192.5513 & 1063.4894 & 1.1214 & 52.8604 & NaN & -1.0000 & -0.0969 \\
2024-03-21 & 67911.5859 & 68199.9922 & 64580.9180 & 65491.3906 &
65491.3906 & 44480350565 & -0.0357 & -2422.2812 & 0.0000 & 2422.2812 &
1134.0742 & 1236.5095 & 0.9172 & 47.8395 & NaN & -1.0000 & 0.0357 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{names\_rsi }\OperatorTok{=}\NormalTok{ \{}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Buy{-}And{-}Hold\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}RSI(14)\textquotesingle{}}\NormalTok{\}}

\NormalTok{\_ }\OperatorTok{=}\NormalTok{ btc\_rsi[[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]].dropna()}

\NormalTok{(}
\NormalTok{    \_}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_rsi)}
\NormalTok{    .plot(logy}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Value ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Value of $1 Invested in Bitcoin Strategies}\CharTok{\textbackslash{}n}\SpecialStringTok{at Close on }\SpecialCharTok{\{}\NormalTok{\_}\SpecialCharTok{.}\NormalTok{index[}\DecValTok{0}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ pd}\SpecialCharTok{.}\NormalTok{offsets}\SpecialCharTok{.}\NormalTok{Day(}\DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{d}\SpecialCharTok{,} \OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_03_files/figure-pdf/cell-31-output-1.png}

Here are the final values of \$1 investments, which are difficult to
read on the log scale above.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    btc\_rsi}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_sma)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .prod()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Strategy
Buy-And-Hold   143.2025
SMA(20)          0.0002
dtype: float64
\end{verbatim}

\textbf{\emph{Shorting Bitcoin has been dangerous!}}

We can compare all three TA strategies!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    btc\_sma[[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .join(}
\NormalTok{        btc\_bb[[}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]].add\_suffix(}\StringTok{\textquotesingle{}\_BB\textquotesingle{}}\NormalTok{), }
\NormalTok{    )}
\NormalTok{    .join(}
\NormalTok{        btc\_rsi[[}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]].add\_suffix(}\StringTok{\textquotesingle{}\_RSI\textquotesingle{}}\NormalTok{), }
\NormalTok{    )}
\NormalTok{    .dropna()}
\NormalTok{)}


\NormalTok{(}
\NormalTok{    \_}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}
\NormalTok{            \{}
                \StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Buy{-}And{-}Hold\textquotesingle{}}\NormalTok{, }
                \StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}SMA(20)\textquotesingle{}}\NormalTok{,}
                \StringTok{\textquotesingle{}Strategy\_BB\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}BB(20, 2)\textquotesingle{}}\NormalTok{,}
                \StringTok{\textquotesingle{}Strategy\_RSI\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}RSI(14)\textquotesingle{}}\NormalTok{,}
\NormalTok{            \}}
\NormalTok{           )}
\NormalTok{    .plot(logy}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Value ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Value of $1 Invested in Bitcoin Strategies}\CharTok{\textbackslash{}n}\SpecialStringTok{at Close on }\SpecialCharTok{\{}\NormalTok{\_}\SpecialCharTok{.}\NormalTok{index[}\DecValTok{0}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ pd}\SpecialCharTok{.}\NormalTok{offsets}\SpecialCharTok{.}\NormalTok{Day(}\DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{d}\SpecialCharTok{,} \OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_03_files/figure-pdf/cell-33-output-1.png}

\chapter{Herron Topic 2 - Practice for Section
04}\label{herron-topic-2---practice-for-section-04}

\section{Announcements}\label{announcements-34}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Project 2 is due Friday, 3/29, at 11:59 PM
\item
  We will dedicate class next week to group work and easy access to me
  (i.e., no pre-class quiz)
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-33}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Technical analysis studies market trends to estimate where prices may
  go. It looks for patterns in past price moves and trade volumes, and
  traders use these signals to inform their trades.
\item
  There is little evidence that technical analysis works, but it
  provides a context for us to introduce quantitative investing
  strategies.
\item
  \emph{We should never base trades on information we do not have at the
  time of the trade!}
\end{enumerate}

\section{Practice}\label{practice-34}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ matplotlib.ticker }\ImportTok{as}\NormalTok{ ticker}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ seaborn }\ImportTok{as}\NormalTok{ sns}
\ImportTok{import}\NormalTok{ statsmodels.api }\ImportTok{as}\NormalTok{ sm}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{Implement the SMA(20) strategy with Bitcoin from the lecture
notebook}\label{implement-the-sma20-strategy-with-bitcoin-from-the-lecture-notebook-2}

I suggest writing a function \texttt{calc\_sma()} that accepts a data
frame \texttt{df} and moving average window \texttt{n}. First, we need
the data, from ticker \texttt{BTC-USD} from Yahoo! Finance.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(}\StringTok{\textquotesingle{}BTC{-}USD\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{btc.head(}\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  1 of 1 completed
\end{verbatim}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
Variable & Open & High & Low & Close & Adj Close & Volume \\
Date & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2014-09-17 & 465.8640 & 468.1740 & 452.4220 & 457.3340 & 457.3340 &
21056800 \\
2014-09-18 & 456.8600 & 456.8600 & 413.1040 & 424.4400 & 424.4400 &
34483200 \\
2014-09-19 & 424.1030 & 427.8350 & 384.5320 & 394.7960 & 394.7960 &
37919700 \\
2014-09-20 & 394.6730 & 423.2960 & 389.8830 & 408.9040 & 408.9040 &
36863600 \\
2014-09-21 & 408.0850 & 412.4260 & 393.1810 & 398.8210 & 398.8210 &
26580100 \\
2014-09-22 & 399.1000 & 406.9160 & 397.1300 & 402.1520 & 402.1520 &
24127600 \\
2014-09-23 & 402.0920 & 441.5570 & 396.1970 & 435.7910 & 435.7910 &
45099500 \\
2014-09-24 & 435.7510 & 436.1120 & 421.1320 & 423.2050 & 423.2050 &
30627700 \\
2014-09-25 & 423.1560 & 423.5200 & 409.4680 & 411.5740 & 411.5740 &
26814400 \\
2014-09-26 & 411.4290 & 414.9380 & 400.0090 & 404.4250 & 404.4250 &
21460800 \\
\end{longtable}

Next, we write a function, since we might want to calculate simple
moving averages (SMAs) more than once. The following
\texttt{calc\_sma()} function accepts:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  A data frame \texttt{df} of daily values from
  \texttt{yfinance.download()}
\item
  An integer \texttt{n} that specifies the number of trading days in the
  SMA window
\end{enumerate}

And returns the original data frame \texttt{df} plus the following
columns:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \texttt{Return} for the daily returns
\item
  \texttt{SMA} for the \texttt{n}-trading-day moving average
\item
  \texttt{Signal} for the weight on the security for each day
\item
  \texttt{Strategy} for the return on the SMA strategy
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_sma(df, n):}
    \ControlFlowTok{return}\NormalTok{ (}
\NormalTok{        df}
\NormalTok{        .assign(}
\NormalTok{            Return}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].pct\_change(),}
\NormalTok{            SMA}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].rolling(n).mean(),}
\NormalTok{            Signal}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.select(}
\NormalTok{                condlist}\OperatorTok{=}\NormalTok{[x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)}\OperatorTok{\textgreater{}}\NormalTok{x[}\StringTok{\textquotesingle{}SMA\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{), x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)}\OperatorTok{\textless{}=}\NormalTok{x[}\StringTok{\textquotesingle{}SMA\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)],}
\NormalTok{                choicelist}\OperatorTok{=}\NormalTok{[}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{],}
\NormalTok{                default}\OperatorTok{=}\NormalTok{np.nan}
\NormalTok{            ),}
\NormalTok{            Strategy}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{] }\OperatorTok{*}\NormalTok{ x[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{        )}
\NormalTok{    )}
\end{Highlighting}
\end{Shaded}

Finally, we calculate the SMA(20). We can drop the last row to avoid
partial trading-day returns. Recall the last row from
\texttt{yfinance.download()} may not be at the close.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc\_sma }\OperatorTok{=}\NormalTok{ btc.iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].pipe(calc\_sma, n}\OperatorTok{=}\DecValTok{20}\NormalTok{)}

\NormalTok{btc\_sma.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
Variable & Open & High & Low & Close & Adj Close & Volume & Return & SMA
& Signal & Strategy \\
Date & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-03-17 & 65316.3438 & 68845.7188 & 64545.3164 & 68390.6250 &
68390.6250 & 44716864318 & 0.0471 & 66530.1934 & 0.0000 & 0.0000 \\
2024-03-18 & 68371.3047 & 68897.1328 & 66594.2266 & 67548.5938 &
67548.5938 & 49261579492 & -0.0123 & 67053.3545 & 1.0000 & -0.0123 \\
2024-03-19 & 67556.1328 & 68106.9297 & 61536.1797 & 61912.7734 &
61912.7734 & 74215844794 & -0.0834 & 67023.7537 & 1.0000 & -0.0834 \\
2024-03-20 & 61930.1562 & 68115.2578 & 60807.7852 & 67913.6719 &
67913.6719 & 66792634382 & 0.0969 & 67359.5182 & 0.0000 & 0.0000 \\
2024-03-21 & 67911.5859 & 68199.9922 & 64580.9180 & 65491.3906 &
65491.3906 & 44480350565 & -0.0357 & 67512.0561 & 1.0000 & -0.0357 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{names\_sma }\OperatorTok{=}\NormalTok{ \{}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Buy{-}And{-}Hold\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}SMA(20)\textquotesingle{}}\NormalTok{\}}

\NormalTok{\_ }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    btc\_sma}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .dropna()}
\NormalTok{)}

\NormalTok{(}
\NormalTok{    \_}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_sma)}
\NormalTok{    .plot(logy}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Value ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Value of $1 Invested in Bitcoin Strategies}\CharTok{\textbackslash{}n}\SpecialStringTok{at Close on }\SpecialCharTok{\{}\NormalTok{\_}\SpecialCharTok{.}\NormalTok{index[}\DecValTok{0}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ pd}\SpecialCharTok{.}\NormalTok{offsets}\SpecialCharTok{.}\NormalTok{Day(}\DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{d}\SpecialCharTok{,} \OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_04_files/figure-pdf/cell-7-output-1.png}

\subsection{How does SMA(20) outperform buy-and-hold with this
sample?}\label{how-does-sma20-outperform-buy-and-hold-with-this-sample-2}

Consider the following:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Does SMA(20) avoid the worst performing days? How many of the worst 20
  days does SMA(20) avoid? Try the \texttt{.sort\_values()} or
  \texttt{.nlargest()} method.
\item
  Does SMA(20) preferentially avoid low-return days? Try to combine the
  \texttt{.groupby()} method and \texttt{pd.qcut()} function.
\item
  Does SMA(20) preferentially avoid high-volatility days? Try to combine
  the \texttt{.groupby()} method and \texttt{pd.qcut()} function.
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc\_sma[[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]].add(}\DecValTok{1}\NormalTok{).prod()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Variable
Return     143.2025
Strategy   217.6557
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc\_sma.loc[btc\_sma[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{].nsmallest(}\DecValTok{20}\NormalTok{).index, [}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]]}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lll@{}}
\toprule\noalign{}
Variable & Signal & Return \\
Date & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2020-03-12 & 0.0000 & -0.3717 \\
2015-01-14 & 0.0000 & -0.2114 \\
2017-09-14 & 0.0000 & -0.1874 \\
2015-08-18 & 0.0000 & -0.1818 \\
2018-01-16 & 0.0000 & -0.1685 \\
2022-06-13 & 0.0000 & -0.1597 \\
2018-02-05 & 0.0000 & -0.1597 \\
2015-01-13 & 0.0000 & -0.1566 \\
2016-01-15 & 0.0000 & -0.1533 \\
2022-11-09 & 0.0000 & -0.1435 \\
2017-01-11 & 0.0000 & -0.1431 \\
2019-06-27 & 1.0000 & -0.1409 \\
2021-05-19 & 0.0000 & -0.1377 \\
2018-11-19 & 0.0000 & -0.1337 \\
2021-05-12 & 1.0000 & -0.1332 \\
2021-01-21 & 0.0000 & -0.1328 \\
2019-07-16 & 0.0000 & -0.1301 \\
2017-12-22 & 0.0000 & -0.1247 \\
2017-01-05 & 1.0000 & -0.1224 \\
2017-12-30 & 0.0000 & -0.1163 \\
\end{longtable}

The SMA(20) does well here because it avoids 17 of the 20 worst days,
without avoiding the best days.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc\_sma.loc[btc\_sma[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{].nsmallest(}\DecValTok{20}\NormalTok{).index, [}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{]].value\_counts()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Signal
0.0000    17
1.0000     3
Name: count, dtype: int64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc\_sma.loc[btc\_sma[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{].nlargest(}\DecValTok{20}\NormalTok{).index, [}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{]].value\_counts()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Signal
0.0000    10
1.0000    10
Name: count, dtype: int64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    btc\_sma}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Buy{-}And{-}Hold\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}SMA(20)\textquotesingle{}}\NormalTok{\})}
\NormalTok{    .groupby(}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{)}
\NormalTok{    [[}\StringTok{\textquotesingle{}Buy{-}And{-}Hold\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}SMA(20)\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .describe()}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Statistic\textquotesingle{}}\NormalTok{])}
\NormalTok{    .stack(}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllll@{}}
\toprule\noalign{}
& Statistic & count & mean & std & min & 25\% & 50\% & 75\% & max \\
Signal & Strategy & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{2}{=}{0.0000} & Buy-And-Hold & 1542.0000 & 0.0008 & 0.0401 &
-0.3717 & -0.0138 & 0.0015 & 0.0163 & 0.2394 \\
& SMA(20) & 1542.0000 & 0.0000 & 0.0000 & 0.0000 & 0.0000 & 0.0000 &
0.0000 & 0.0000 \\
\multirow{2}{=}{1.0000} & Buy-And-Hold & 1912.0000 & 0.0034 & 0.0339 &
-0.1409 & -0.0112 & 0.0015 & 0.0175 & 0.2525 \\
& SMA(20) & 1912.0000 & 0.0034 & 0.0339 & -0.1409 & -0.0112 & 0.0015 &
0.0175 & 0.2525 \\
\end{longtable}

We can also use the seaborn package to visualize \texttt{Signal} (i.e.,
the portfolio weight on Bitcoin) during periods of high and low Bitcoin
returns and volatility. The SMA(20) strategy is long Bitcoin about 55\%
of the time, with Bitcoin returns are high (bin 2) or low (bin 1).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    btc\_sma}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .dropna()}
\NormalTok{    .assign(Return\_Bin}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: }\DecValTok{1} \OperatorTok{+}\NormalTok{ pd.qcut(x[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{], q}\OperatorTok{=}\DecValTok{2}\NormalTok{, labels}\OperatorTok{=}\VariableTok{False}\NormalTok{))}
\NormalTok{    .pipe(}
\NormalTok{        sns.barplot,}
\NormalTok{        x}\OperatorTok{=}\StringTok{\textquotesingle{}Return\_Bin\textquotesingle{}}\NormalTok{,}
\NormalTok{        y}\OperatorTok{=}\StringTok{\textquotesingle{}Signal\textquotesingle{}}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{plt.title(}\StringTok{\textquotesingle{}Percentage of Time SMA(20) Strategy is Long Bitcoin}\CharTok{\textbackslash{}n}\StringTok{by Bitcoin Daily Return Bins\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_04_files/figure-pdf/cell-13-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    btc\_sma}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .dropna()}
\NormalTok{    .assign(Volatility\_Bin}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: }\DecValTok{1} \OperatorTok{+}\NormalTok{ pd.qcut(x[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{].rolling(}\DecValTok{20}\NormalTok{).std(), q}\OperatorTok{=}\DecValTok{2}\NormalTok{, labels}\OperatorTok{=}\VariableTok{False}\NormalTok{))}
\NormalTok{    .pipe(}
\NormalTok{        sns.barplot,}
\NormalTok{        x}\OperatorTok{=}\StringTok{\textquotesingle{}Volatility\_Bin\textquotesingle{}}\NormalTok{,}
\NormalTok{        y}\OperatorTok{=}\StringTok{\textquotesingle{}Signal\textquotesingle{}}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{plt.title(}\StringTok{\textquotesingle{}Percentage of Time SMA(20) Strategy is Long Bitcoin}\CharTok{\textbackslash{}n}\StringTok{by Bitcoin 20{-}Day Volatility Bins\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_04_files/figure-pdf/cell-14-output-1.png}

\subsection{Implement the SMA(20) strategy with the market factor from
French}\label{implement-the-sma20-strategy-with-the-market-factor-from-french-2}

We need to impute a market price before we calculate SMA(20).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pdr.DataReader(}
\NormalTok{        name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{        data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{        start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{    )}
\NormalTok{    [}\DecValTok{0}\NormalTok{]}
\NormalTok{    .div(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .assign(}
\NormalTok{        Mkt}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ x[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{],}
\NormalTok{        Price}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Mkt\textquotesingle{}}\NormalTok{].add(}\DecValTok{1}\NormalTok{).cumprod()}
\NormalTok{    )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_1040\2105953079.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_sma }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}Price\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{\})}
\NormalTok{    .pipe(calc\_sma, n}\OperatorTok{=}\DecValTok{20}\NormalTok{)}
\NormalTok{)}

\NormalTok{ff\_sma.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
& Mkt-RF & SMB & HML & RF & Mkt & Adj Close & Return & SMA & Signal &
Strategy \\
Date & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-01-25 & 0.0046 & 0.0004 & 0.0056 & 0.0002 & 0.0048 & 11969.2170 &
0.0048 & 11716.9236 & 1.0000 & 0.0048 \\
2024-01-26 & -0.0002 & 0.0040 & -0.0027 & 0.0002 & 0.0000 & 11969.4564 &
0.0000 & 11727.1312 & 1.0000 & 0.0000 \\
2024-01-29 & 0.0085 & 0.0107 & -0.0059 & 0.0002 & 0.0087 & 12073.8301 &
0.0087 & 11742.4928 & 1.0000 & 0.0087 \\
2024-01-30 & -0.0013 & -0.0126 & 0.0084 & 0.0002 & -0.0011 & 12060.7903
& -0.0011 & 11759.6086 & 1.0000 & -0.0011 \\
2024-01-31 & -0.0174 & -0.0092 & -0.0030 & 0.0002 & -0.0172 & 11853.5860
& -0.0172 & 11770.3368 & 1.0000 & -0.0172 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ ff\_sma[[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]].dropna()}

\NormalTok{(}
\NormalTok{    \_}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_sma)}
\NormalTok{    .plot(logy}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Value ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Value of $1 Invested in Market}\CharTok{\textbackslash{}n}\SpecialStringTok{at Close on }\SpecialCharTok{\{}\NormalTok{\_}\SpecialCharTok{.}\NormalTok{index[}\DecValTok{0}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ pd}\SpecialCharTok{.}\NormalTok{offsets}\SpecialCharTok{.}\NormalTok{BDay(}\DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{d}\SpecialCharTok{,} \OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_04_files/figure-pdf/cell-17-output-1.png}

\subsection{How often does SMA(20) outperform buy-and-hold with 1-year
rolling windows with
Bitcoin?}\label{how-often-does-sma20-outperform-buy-and-hold-with-1-year-rolling-windows-with-bitcoin-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    btc\_sma}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .pipe(np.log1p)}
\NormalTok{    .rolling(}\DecValTok{365}\NormalTok{)}
\NormalTok{    .}\BuiltInTok{sum}\NormalTok{()}
\NormalTok{    .pipe(np.expm1)}
\NormalTok{)}

\NormalTok{(}
\NormalTok{    \_}
\NormalTok{    .dropna()}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_sma)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .plot()}
\NormalTok{)}

\NormalTok{plt.title(}\StringTok{\textquotesingle{}One{-}Year Rolling Returns for Bitcoin\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Year Rolling Return (\%)\textquotesingle{}}\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}
    \SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{names\_sma[}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]}\SpecialCharTok{\}}\SpecialStringTok{ \textgreater{} }\SpecialCharTok{\{}\NormalTok{names\_sma[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}\SpecialCharTok{\}}\SpecialStringTok{ for One{-}Year Rolling Window:\textquotesingle{}}\NormalTok{,}
\NormalTok{    (\_[}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}}\NormalTok{ \_[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]).value\_counts(),}
\NormalTok{    sep}\OperatorTok{=}\StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
SMA(20) > Buy-And-Hold for One-Year Rolling Window:
False    2111
True     1363
Name: count, dtype: int64
\end{verbatim}

\includegraphics{herron_02_practice_04_files/figure-pdf/cell-18-output-2.png}

\subsection{Implement a long-only BB(20, 2) strategy with
Bitcoin}\label{implement-a-long-only-bb20-2-strategy-with-bitcoin-2}

More on Bollinger Bands
\href{https://www.bollingerbands.com/bollinger-bands}{here} and
\href{https://www.bollingerbands.com/bollinger-band-rules}{here}. In
short, Bollinger Bands are bands around a trend, typically defined in
terms of simple moving averages and volatilities. Here, long-only BB(20,
2) implies we have upper and lower bands at 2 standard deviations above
and below SMA(20):

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Buy when the closing price crosses LB(20) from below, where LB(20) is
  SMA(20) minus 2 sigma
\item
  Sell when the closing price crosses UB(20) from above, where UB(20) is
  SMA(20) plus 2 sigma
\item
  No short-selling
\end{enumerate}

The long-only BB(20, 2) is more difficult to implement than the
long-only SMA(20) because we need to track buys and sells. For example,
if the closing price is between LB(20) and BB(20), we need to know if
our last trade was a buy or a sell. Further, if the closing price is
below LB(20), we can still be long because we sell when the closing
price crosses UB(20) from above.

Here is a function to calculate Bolling Bands and implement the
strategy.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_bb(df, m, n):}
    \ControlFlowTok{return}\NormalTok{ (}
\NormalTok{        df}
\NormalTok{        .assign(}
\NormalTok{            Return}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].pct\_change(),}
\NormalTok{            SMA}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].rolling(m).mean(),}
\NormalTok{            SMV}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].rolling(m).std(),}
\NormalTok{            LB}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}SMA\textquotesingle{}}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ n}\OperatorTok{*}\NormalTok{x[}\StringTok{\textquotesingle{}SMV\textquotesingle{}}\NormalTok{],}
\NormalTok{            UB}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}SMA\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ n}\OperatorTok{*}\NormalTok{x[}\StringTok{\textquotesingle{}SMV\textquotesingle{}}\NormalTok{],}
\NormalTok{            Signal\_with\_nan}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.select(}
\NormalTok{                condlist}\OperatorTok{=}\NormalTok{[}
\NormalTok{                    (x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{) }\OperatorTok{\textgreater{}}\NormalTok{ x[}\StringTok{\textquotesingle{}LB\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)) }\OperatorTok{\&}\NormalTok{ (x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{) }\OperatorTok{\textless{}=}\NormalTok{ x[}\StringTok{\textquotesingle{}LB\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{)),}
\NormalTok{                    (x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{) }\OperatorTok{\textless{}}\NormalTok{ x[}\StringTok{\textquotesingle{}UB\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)) }\OperatorTok{\&}\NormalTok{ (x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{) }\OperatorTok{\textgreater{}=}\NormalTok{ x[}\StringTok{\textquotesingle{}UB\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{))}
\NormalTok{                ],}
\NormalTok{                choicelist}\OperatorTok{=}\NormalTok{[}
                    \DecValTok{1}\NormalTok{,}
                    \DecValTok{0}
\NormalTok{                ],}
\NormalTok{                default}\OperatorTok{=}\NormalTok{np.nan}
\NormalTok{            ),}
\NormalTok{            Signal}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Signal\_with\_nan\textquotesingle{}}\NormalTok{].ffill(),}
\NormalTok{            Strategy}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{] }\OperatorTok{*}\NormalTok{ x[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{        )}
\NormalTok{    )}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc\_bb }\OperatorTok{=}\NormalTok{ btc.iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].pipe(calc\_bb, m}\OperatorTok{=}\DecValTok{20}\NormalTok{, n}\OperatorTok{=}\DecValTok{2}\NormalTok{)}

\NormalTok{btc\_bb.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllllll@{}}
\toprule\noalign{}
Variable & Open & High & Low & Close & Adj Close & Volume & Return & SMA
& SMV & LB & UB & Signal\_with\_nan & Signal & Strategy \\
Date & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-03-17 & 65316.3438 & 68845.7188 & 64545.3164 & 68390.6250 &
68390.6250 & 44716864318 & 0.0471 & 66530.1934 & 4242.5090 & 58045.1755
& 75015.2113 & NaN & 0.0000 & 0.0000 \\
2024-03-18 & 68371.3047 & 68897.1328 & 66594.2266 & 67548.5938 &
67548.5938 & 49261579492 & -0.0123 & 67053.3545 & 3615.2985 & 59822.7575
& 74283.9515 & NaN & 0.0000 & -0.0000 \\
2024-03-19 & 67556.1328 & 68106.9297 & 61536.1797 & 61912.7734 &
61912.7734 & 74215844794 & -0.0834 & 67023.7537 & 3656.6873 & 59710.3790
& 74337.1284 & NaN & 0.0000 & -0.0000 \\
2024-03-20 & 61930.1562 & 68115.2578 & 60807.7852 & 67913.6719 &
67913.6719 & 66792634382 & 0.0969 & 67359.5182 & 3392.3919 & 60574.7343
& 74144.3020 & NaN & 0.0000 & 0.0000 \\
2024-03-21 & 67911.5859 & 68199.9922 & 64580.9180 & 65491.3906 &
65491.3906 & 44480350565 & -0.0357 & 67512.0561 & 3223.9829 & 61064.0903
& 73960.0218 & NaN & 0.0000 & -0.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{names\_bb }\OperatorTok{=}\NormalTok{ \{}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Buy{-}And{-}Hold\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}BB(20, 2)\textquotesingle{}}\NormalTok{\}}

\NormalTok{\_ }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    btc\_bb}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .dropna()}
\NormalTok{)}

\NormalTok{(}
\NormalTok{    \_}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_bb)}
\NormalTok{    .plot(logy}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Value ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Value of $1 Invested in Bitcoin}\CharTok{\textbackslash{}n}\SpecialStringTok{at Close on }\SpecialCharTok{\{}\NormalTok{\_}\SpecialCharTok{.}\NormalTok{index[}\DecValTok{0}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ pd}\SpecialCharTok{.}\NormalTok{offsets}\SpecialCharTok{.}\NormalTok{Day(}\DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{d}\SpecialCharTok{,} \OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_04_files/figure-pdf/cell-21-output-1.png}

Here are the final values of \$1 investments, which are difficult to
read on the log scale above.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    btc\_bb}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_bb)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .prod()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Strategy
Buy-And-Hold   143.2025
BB(20, 2)        1.8011
dtype: float64
\end{verbatim}

This strategy trades about 30 round-trips during this sample.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc\_bb[}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{].diff().value\_counts()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Signal
0.0000     3370
-1.0000      30
1.0000       29
Name: count, dtype: int64
\end{verbatim}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

We need a more complex plot to better understand what is going on!

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.ticker }\ImportTok{as}\NormalTok{ ticker}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fig, ax }\OperatorTok{=}\NormalTok{ plt.subplots(nrows}\OperatorTok{=}\DecValTok{2}\NormalTok{, ncols}\OperatorTok{=}\DecValTok{1}\NormalTok{, sharex}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ btc\_bb.loc[}\StringTok{\textquotesingle{}2023{-}02\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023{-}03\textquotesingle{}}\NormalTok{]}

\NormalTok{ax[}\DecValTok{0}\NormalTok{].plot(\_[[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]], label}\OperatorTok{=}\StringTok{\textquotesingle{}Price\textquotesingle{}}\NormalTok{)}
\NormalTok{ax[}\DecValTok{0}\NormalTok{].plot(\_[[}\StringTok{\textquotesingle{}SMA\textquotesingle{}}\NormalTok{]], label}\OperatorTok{=}\StringTok{\textquotesingle{}SMA(20)\textquotesingle{}}\NormalTok{)}
\NormalTok{ax[}\DecValTok{0}\NormalTok{].plot(\_[[}\StringTok{\textquotesingle{}UB\textquotesingle{}}\NormalTok{]], label}\OperatorTok{=}\StringTok{\textquotesingle{}LB and UB\textquotesingle{}}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}green\textquotesingle{}}\NormalTok{, linestyle}\OperatorTok{=}\StringTok{\textquotesingle{}:\textquotesingle{}}\NormalTok{)}
\NormalTok{ax[}\DecValTok{0}\NormalTok{].plot(\_[[}\StringTok{\textquotesingle{}LB\textquotesingle{}}\NormalTok{]], color}\OperatorTok{=}\StringTok{\textquotesingle{}green\textquotesingle{}}\NormalTok{, linestyle}\OperatorTok{=}\StringTok{\textquotesingle{}:\textquotesingle{}}\NormalTok{)}
\NormalTok{ax[}\DecValTok{0}\NormalTok{].legend()}
\NormalTok{ax[}\DecValTok{0}\NormalTok{].set\_ylabel(}\StringTok{\textquotesingle{}Price ($)\textquotesingle{}}\NormalTok{)}

\NormalTok{ax[}\DecValTok{1}\NormalTok{].plot(\_[[}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{]], label}\OperatorTok{=}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{)}
\NormalTok{ax[}\DecValTok{1}\NormalTok{].legend()}
\NormalTok{ax[}\DecValTok{1}\NormalTok{].set\_ylabel(}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{)}

\NormalTok{ax[}\DecValTok{0}\NormalTok{].yaxis.set\_major\_formatter(ticker.StrMethodFormatter(}\StringTok{\textquotesingle{}}\SpecialCharTok{\{x:,.0f\}}\StringTok{\textquotesingle{}}\NormalTok{))}
\NormalTok{fig.autofmt\_xdate()}

\NormalTok{plt.suptitle(}\StringTok{\textquotesingle{}Key Variables in Bitcoin BB(20, 2) Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_04_files/figure-pdf/cell-25-output-1.png}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\subsection{Implement a long-short RSI(14) strategy with
Bitcoin}\label{implement-a-long-short-rsi14-strategy-with-bitcoin-2}

From
\href{https://www.fidelity.com/learning-center/trading-investing/technical-analysis/technical-indicator-guide/rsi}{Fidelity}:

\begin{quote}
The Relative Strength Index (RSI), developed by J. Welles Wilder, is a
momentum oscillator that measures the speed and change of price
movements. The RSI oscillates between zero and 100. Traditionally the
RSI is considered overbought when above 70 and oversold when below 30.
Signals can be generated by looking for divergences and failure swings.
RSI can also be used to identify the general trend.
\end{quote}

Here is the RSI formula: \(RSI(n) = 100 - \frac{100}{1 + RS(n)}\), where
\(RS(n) = \frac{SMA(U, n)}{SMA(D, n)}\). For ``up days'',
\(U = \Delta Adj\ Close\) and \(D = 0\), and, for ``down days'',
\(U = 0\) and \(D = - \Delta Adj\ Close\). Therefore, \(U\) and \(D\)
are always non-negative. We can learn more about RSI
\href{https://en.wikipedia.org/wiki/Relative_strength_index}{here}.

We will implement a long-short RSI(14) as follows:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Enter a long position when the RSI crosses 30 from below, and exit the
  position when the RSI crosses 50 from below
\item
  Enter a short position when the RSI crosses 70 from above, and exit
  the position when the RSI crosses 50 from above
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_rsi(df, n, lb, mb, ub):}
    \ControlFlowTok{return}\NormalTok{ df.assign(}
\NormalTok{        Return}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].pct\_change(),}
\NormalTok{        Diff}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].diff(),}
\NormalTok{        U}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.select(}
\NormalTok{            condlist}\OperatorTok{=}\NormalTok{[x[}\StringTok{\textquotesingle{}Diff\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}=} \DecValTok{0}\NormalTok{, x[}\StringTok{\textquotesingle{}Diff\textquotesingle{}}\NormalTok{] }\OperatorTok{\textless{}} \DecValTok{0}\NormalTok{],}
\NormalTok{            choicelist}\OperatorTok{=}\NormalTok{[x[}\StringTok{\textquotesingle{}Diff\textquotesingle{}}\NormalTok{], }\DecValTok{0}\NormalTok{],}
\NormalTok{            default}\OperatorTok{=}\NormalTok{np.nan}
\NormalTok{        ),}
\NormalTok{        D}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.select(}
\NormalTok{            condlist}\OperatorTok{=}\NormalTok{[x[}\StringTok{\textquotesingle{}Diff\textquotesingle{}}\NormalTok{] }\OperatorTok{\textless{}=} \DecValTok{0}\NormalTok{, x[}\StringTok{\textquotesingle{}Diff\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{],}
\NormalTok{            choicelist}\OperatorTok{=}\NormalTok{[}\OperatorTok{{-}}\DecValTok{1} \OperatorTok{*}\NormalTok{ x[}\StringTok{\textquotesingle{}Diff\textquotesingle{}}\NormalTok{], }\DecValTok{0}\NormalTok{],}
\NormalTok{            default}\OperatorTok{=}\NormalTok{np.nan}
\NormalTok{        ),}
\NormalTok{        SMAU}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}U\textquotesingle{}}\NormalTok{].rolling(n).mean(),}
\NormalTok{        SMAD}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}D\textquotesingle{}}\NormalTok{].rolling(n).mean(),}
\NormalTok{        RS}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}SMAU\textquotesingle{}}\NormalTok{] }\OperatorTok{/}\NormalTok{ x[}\StringTok{\textquotesingle{}SMAD\textquotesingle{}}\NormalTok{],}
\NormalTok{        RSI}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: }\DecValTok{100} \OperatorTok{{-}} \DecValTok{100} \OperatorTok{/}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ x[}\StringTok{\textquotesingle{}RS\textquotesingle{}}\NormalTok{]),}
\NormalTok{        Signal\_with\_nan }\OperatorTok{=} \KeywordTok{lambda}\NormalTok{ x: np.select(}
\NormalTok{            condlist}\OperatorTok{=}\NormalTok{[}
\NormalTok{                (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{) }\OperatorTok{\textgreater{}=}\NormalTok{ lb) }\OperatorTok{\&}\NormalTok{ (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{) }\OperatorTok{\textless{}}\NormalTok{ lb), }
\NormalTok{                (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{) }\OperatorTok{\textgreater{}=}\NormalTok{ mb) }\OperatorTok{\&}\NormalTok{ (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{) }\OperatorTok{\textless{}}\NormalTok{ mb),}
\NormalTok{                (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{) }\OperatorTok{\textless{}=}\NormalTok{ ub) }\OperatorTok{\&}\NormalTok{ (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{) }\OperatorTok{\textgreater{}}\NormalTok{ ub), }
\NormalTok{                (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{) }\OperatorTok{\textless{}=}\NormalTok{ mb) }\OperatorTok{\&}\NormalTok{ (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{) }\OperatorTok{\textgreater{}}\NormalTok{ mb),}
\NormalTok{            ],}
\NormalTok{            choicelist}\OperatorTok{=}\NormalTok{[}
                \DecValTok{1}\NormalTok{, }
                \DecValTok{0}\NormalTok{,}
                \OperatorTok{{-}}\DecValTok{1}\NormalTok{,}
                \DecValTok{0}
\NormalTok{            ],}
\NormalTok{            default}\OperatorTok{=}\NormalTok{np.nan}
\NormalTok{        ),}
\NormalTok{        Signal}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Signal\_with\_nan\textquotesingle{}}\NormalTok{].ffill(),}
\NormalTok{        Strategy}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{] }\OperatorTok{*}\NormalTok{ x[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{    )}
\end{Highlighting}
\end{Shaded}

Again, we drop the last day to omit partial returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc\_rsi }\OperatorTok{=}\NormalTok{ btc.iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].pipe(calc\_rsi, n}\OperatorTok{=}\DecValTok{14}\NormalTok{, mb}\OperatorTok{=}\DecValTok{2}\NormalTok{, lb}\OperatorTok{=}\DecValTok{30}\NormalTok{, ub}\OperatorTok{=}\DecValTok{70}\NormalTok{)}

\NormalTok{btc\_rsi.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllll@{}}
\toprule\noalign{}
Variable & Open & High & Low & Close & Adj Close & Volume & Return &
Diff & U & D & SMAU & SMAD & RS & RSI & Signal\_with\_nan & Signal &
Strategy \\
Date & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-03-17 & 65316.3438 & 68845.7188 & 64545.3164 & 68390.6250 &
68390.6250 & 44716864318 & 0.0471 & 3075.5078 & 3075.5078 & 0.0000 &
1297.3906 & 924.3011 & 1.4036 & 58.3965 & NaN & -1.0000 & -0.0471 \\
2024-03-18 & 68371.3047 & 68897.1328 & 66594.2266 & 67548.5938 &
67548.5938 & 49261579492 & -0.0123 & -842.0312 & 0.0000 & 842.0312 &
928.6018 & 984.4461 & 0.9433 & 48.5404 & NaN & -1.0000 & 0.0123 \\
2024-03-19 & 67556.1328 & 68106.9297 & 61536.1797 & 61912.7734 &
61912.7734 & 74215844794 & -0.0834 & -5635.8203 & 0.0000 & 5635.8203 &
928.6018 & 1063.4894 & 0.8732 & 46.6144 & NaN & -1.0000 & 0.0834 \\
2024-03-20 & 61930.1562 & 68115.2578 & 60807.7852 & 67913.6719 &
67913.6719 & 66792634382 & 0.0969 & 6000.8984 & 6000.8984 & 0.0000 &
1192.5513 & 1063.4894 & 1.1214 & 52.8604 & NaN & -1.0000 & -0.0969 \\
2024-03-21 & 67911.5859 & 68199.9922 & 64580.9180 & 65491.3906 &
65491.3906 & 44480350565 & -0.0357 & -2422.2812 & 0.0000 & 2422.2812 &
1134.0742 & 1236.5095 & 0.9172 & 47.8395 & NaN & -1.0000 & 0.0357 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{names\_rsi }\OperatorTok{=}\NormalTok{ \{}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Buy{-}And{-}Hold\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}RSI(14)\textquotesingle{}}\NormalTok{\}}

\NormalTok{\_ }\OperatorTok{=}\NormalTok{ btc\_rsi[[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]].dropna()}

\NormalTok{(}
\NormalTok{    \_}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_rsi)}
\NormalTok{    .plot(logy}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Value ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Value of $1 Invested in Bitcoin Strategies}\CharTok{\textbackslash{}n}\SpecialStringTok{at Close on }\SpecialCharTok{\{}\NormalTok{\_}\SpecialCharTok{.}\NormalTok{index[}\DecValTok{0}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ pd}\SpecialCharTok{.}\NormalTok{offsets}\SpecialCharTok{.}\NormalTok{Day(}\DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{d}\SpecialCharTok{,} \OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_04_files/figure-pdf/cell-28-output-1.png}

Here are the final values of \$1 investments, which are difficult to
read on the log scale above.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    btc\_rsi}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_sma)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .prod()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Strategy
Buy-And-Hold   143.2025
SMA(20)          0.0002
dtype: float64
\end{verbatim}

\textbf{\emph{Shorting Bitcoin has been dangerous!}}

We can compare all three TA strategies!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    btc\_sma[[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .join(}
\NormalTok{        btc\_bb[[}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]].add\_suffix(}\StringTok{\textquotesingle{}\_BB\textquotesingle{}}\NormalTok{), }
\NormalTok{    )}
\NormalTok{    .join(}
\NormalTok{        btc\_rsi[[}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]].add\_suffix(}\StringTok{\textquotesingle{}\_RSI\textquotesingle{}}\NormalTok{), }
\NormalTok{    )}
\NormalTok{    .dropna()}
\NormalTok{)}


\NormalTok{(}
\NormalTok{    \_}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}
\NormalTok{            \{}
                \StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Buy{-}And{-}Hold\textquotesingle{}}\NormalTok{, }
                \StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}SMA(20)\textquotesingle{}}\NormalTok{,}
                \StringTok{\textquotesingle{}Strategy\_BB\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}BB(20, 2)\textquotesingle{}}\NormalTok{,}
                \StringTok{\textquotesingle{}Strategy\_RSI\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}RSI(14)\textquotesingle{}}\NormalTok{,}
\NormalTok{            \}}
\NormalTok{           )}
\NormalTok{    .plot(logy}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Value ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Value of $1 Invested in Bitcoin Strategies}\CharTok{\textbackslash{}n}\SpecialStringTok{at Close on }\SpecialCharTok{\{}\NormalTok{\_}\SpecialCharTok{.}\NormalTok{index[}\DecValTok{0}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ pd}\SpecialCharTok{.}\NormalTok{offsets}\SpecialCharTok{.}\NormalTok{Day(}\DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{d}\SpecialCharTok{,} \OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_04_files/figure-pdf/cell-30-output-1.png}

\chapter{Herron Topic 2 - Practice for Section
05}\label{herron-topic-2---practice-for-section-05}

\section{Announcements}\label{announcements-35}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Project 2 is due Friday, 3/29, at 11:59 PM
\item
  We will dedicate class next week to group work and easy access to me
  (i.e., no pre-class quiz)
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-34}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Technical analysis studies market trends to estimate where prices may
  go. It looks for patterns in past price moves and trade volumes, and
  traders use these signals to inform their trades.
\item
  There is little evidence that technical analysis works, but it
  provides a context for us to introduce quantitative investing
  strategies.
\item
  \emph{We should never base trades on information we do not have at the
  time of the trade!}
\end{enumerate}

\section{Practice}\label{practice-35}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ matplotlib.ticker }\ImportTok{as}\NormalTok{ ticker}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ seaborn }\ImportTok{as}\NormalTok{ sns}
\ImportTok{import}\NormalTok{ statsmodels.api }\ImportTok{as}\NormalTok{ sm}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{Implement the SMA(20) strategy with Bitcoin from the lecture
notebook}\label{implement-the-sma20-strategy-with-bitcoin-from-the-lecture-notebook-3}

I suggest writing a function \texttt{calc\_sma()} that accepts a data
frame \texttt{df} and moving average window \texttt{n}. First, we need
the data, from ticker \texttt{BTC-USD} from Yahoo! Finance.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(}\StringTok{\textquotesingle{}BTC{-}USD\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{btc.head(}\DecValTok{10}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  1 of 1 completed
\end{verbatim}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
Variable & Open & High & Low & Close & Adj Close & Volume \\
Date & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2014-09-17 & 465.8640 & 468.1740 & 452.4220 & 457.3340 & 457.3340 &
21056800 \\
2014-09-18 & 456.8600 & 456.8600 & 413.1040 & 424.4400 & 424.4400 &
34483200 \\
2014-09-19 & 424.1030 & 427.8350 & 384.5320 & 394.7960 & 394.7960 &
37919700 \\
2014-09-20 & 394.6730 & 423.2960 & 389.8830 & 408.9040 & 408.9040 &
36863600 \\
2014-09-21 & 408.0850 & 412.4260 & 393.1810 & 398.8210 & 398.8210 &
26580100 \\
2014-09-22 & 399.1000 & 406.9160 & 397.1300 & 402.1520 & 402.1520 &
24127600 \\
2014-09-23 & 402.0920 & 441.5570 & 396.1970 & 435.7910 & 435.7910 &
45099500 \\
2014-09-24 & 435.7510 & 436.1120 & 421.1320 & 423.2050 & 423.2050 &
30627700 \\
2014-09-25 & 423.1560 & 423.5200 & 409.4680 & 411.5740 & 411.5740 &
26814400 \\
2014-09-26 & 411.4290 & 414.9380 & 400.0090 & 404.4250 & 404.4250 &
21460800 \\
\end{longtable}

Next, we write a function, since we might want to calculate simple
moving averages (SMAs) more than once. The following
\texttt{calc\_sma()} function accepts:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  A data frame \texttt{df} of daily values from
  \texttt{yfinance.download()}
\item
  An integer \texttt{n} that specifies the number of trading days in the
  SMA window
\end{enumerate}

And returns the original data frame \texttt{df} plus the following
columns:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \texttt{Return} for the daily returns
\item
  \texttt{SMA} for the \texttt{n}-trading-day moving average
\item
  \texttt{Signal} for the weight on the security for each day
\item
  \texttt{Strategy} for the return on the SMA strategy
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_sma(df, n):}
    \ControlFlowTok{return}\NormalTok{ (}
\NormalTok{        df}
\NormalTok{        .assign(}
\NormalTok{            Return}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].pct\_change(),}
\NormalTok{            SMA}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].rolling(n).mean(),}
\NormalTok{            Signal}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.select(}
\NormalTok{                condlist}\OperatorTok{=}\NormalTok{[x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{) }\OperatorTok{\textgreater{}}\NormalTok{ x[}\StringTok{\textquotesingle{}SMA\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{), x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{) }\OperatorTok{\textless{}=}\NormalTok{ x[}\StringTok{\textquotesingle{}SMA\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)],}
\NormalTok{                choicelist}\OperatorTok{=}\NormalTok{[}\DecValTok{1}\NormalTok{, }\DecValTok{0}\NormalTok{],}
\NormalTok{                default}\OperatorTok{=}\NormalTok{np.nan}
\NormalTok{            ),}
\NormalTok{            Strategy}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{] }\OperatorTok{*}\NormalTok{ x[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{        )}
\NormalTok{    )}
\end{Highlighting}
\end{Shaded}

Finally, we calculate the SMA(20). We can drop the last row to avoid
partial trading-day returns. Recall the last row from
\texttt{yfinance.download()} may not be at the close.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc\_sma }\OperatorTok{=}\NormalTok{ btc.iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].pipe(calc\_sma, n}\OperatorTok{=}\DecValTok{20}\NormalTok{)}

\NormalTok{btc\_sma.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
Variable & Open & High & Low & Close & Adj Close & Volume & Return & SMA
& Signal & Strategy \\
Date & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-03-17 & 65316.3438 & 68845.7188 & 64545.3164 & 68390.6250 &
68390.6250 & 44716864318 & 0.0471 & 66530.1934 & 0.0000 & 0.0000 \\
2024-03-18 & 68371.3047 & 68897.1328 & 66594.2266 & 67548.5938 &
67548.5938 & 49261579492 & -0.0123 & 67053.3545 & 1.0000 & -0.0123 \\
2024-03-19 & 67556.1328 & 68106.9297 & 61536.1797 & 61912.7734 &
61912.7734 & 74215844794 & -0.0834 & 67023.7537 & 1.0000 & -0.0834 \\
2024-03-20 & 61930.1562 & 68115.2578 & 60807.7852 & 67913.6719 &
67913.6719 & 66792634382 & 0.0969 & 67359.5182 & 0.0000 & 0.0000 \\
2024-03-21 & 67911.5859 & 68199.9922 & 64580.9180 & 65491.3906 &
65491.3906 & 44480350565 & -0.0357 & 67512.0561 & 1.0000 & -0.0357 \\
\end{longtable}

For Bitcoin, the SMA(20) strategy works well over the full sample!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{names\_sma }\OperatorTok{=}\NormalTok{ \{}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Buy{-}And{-}Hold\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}SMA(20)\textquotesingle{}}\NormalTok{\}}

\NormalTok{\_ }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    btc\_sma}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .dropna()}
\NormalTok{)}

\NormalTok{(}
\NormalTok{    \_}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_sma)}
\NormalTok{    .plot(logy}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Value ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Value of $1 Invested in Bitcoin Strategies}\CharTok{\textbackslash{}n}\SpecialStringTok{at Close on }\SpecialCharTok{\{}\NormalTok{\_}\SpecialCharTok{.}\NormalTok{index[}\DecValTok{0}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ pd}\SpecialCharTok{.}\NormalTok{offsets}\SpecialCharTok{.}\NormalTok{Day(}\DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{d}\SpecialCharTok{,} \OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_05_files/figure-pdf/cell-7-output-1.png}

Here are the final values of \$1 investments, which are difficult to
read on the log scale above.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    btc\_sma}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_sma)}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .prod()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Strategy
Buy-And-Hold   143.2025
SMA(20)        217.6557
dtype: float64
\end{verbatim}

\subsection{How does SMA(20) outperform buy-and-hold with this
sample?}\label{how-does-sma20-outperform-buy-and-hold-with-this-sample-3}

Consider the following:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Does SMA(20) avoid the worst performing days? How many of the worst 20
  days does SMA(20) avoid? Try the \texttt{.sort\_values()} or
  \texttt{.nlargest()} method.
\item
  Does SMA(20) preferentially avoid low-return days? Try to combine the
  \texttt{.groupby()} method and \texttt{pd.qcut()} function.
\item
  Does SMA(20) preferentially avoid high-volatility days? Try to combine
  the \texttt{.groupby()} method and \texttt{pd.qcut()} function.
\end{enumerate}

The SMA(20) does well here because it avoids 17 of the 20 worst days,
without avoiding the best days.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc\_sma.loc[btc\_sma[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{].nsmallest(}\DecValTok{20}\NormalTok{).index, [}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{]].value\_counts()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Signal
0.0000    17
1.0000     3
Name: count, dtype: int64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc\_sma.loc[btc\_sma[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{].nlargest(}\DecValTok{20}\NormalTok{).index, [}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{]].value\_counts()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Signal
0.0000    10
1.0000    10
Name: count, dtype: int64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    btc\_sma}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Buy{-}And{-}Hold\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}SMA(20)\textquotesingle{}}\NormalTok{\})}
\NormalTok{    .groupby(}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{)}
\NormalTok{    [[}\StringTok{\textquotesingle{}Buy{-}And{-}Hold\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}SMA(20)\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .describe()}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Statistic\textquotesingle{}}\NormalTok{])}
\NormalTok{    .stack(}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllll@{}}
\toprule\noalign{}
& Statistic & count & mean & std & min & 25\% & 50\% & 75\% & max \\
Signal & Strategy & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{2}{=}{0.0000} & Buy-And-Hold & 1542.0000 & 0.0008 & 0.0401 &
-0.3717 & -0.0138 & 0.0015 & 0.0163 & 0.2394 \\
& SMA(20) & 1542.0000 & 0.0000 & 0.0000 & 0.0000 & 0.0000 & 0.0000 &
0.0000 & 0.0000 \\
\multirow{2}{=}{1.0000} & Buy-And-Hold & 1912.0000 & 0.0034 & 0.0339 &
-0.1409 & -0.0112 & 0.0015 & 0.0175 & 0.2525 \\
& SMA(20) & 1912.0000 & 0.0034 & 0.0339 & -0.1409 & -0.0112 & 0.0015 &
0.0175 & 0.2525 \\
\end{longtable}

We can also use the seaborn package to visualize \texttt{Signal} (i.e.,
the portfolio weight on Bitcoin) during periods of high and low Bitcoin
returns and volatility. The SMA(20) strategy is long Bitcoin about 55\%
of the time, with Bitcoin returns are high (bin 2) or low (bin 1).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    btc\_sma}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .dropna()}
\NormalTok{    .assign(Return\_Bin}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: }\DecValTok{1} \OperatorTok{+}\NormalTok{ pd.qcut(x[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{], q}\OperatorTok{=}\DecValTok{2}\NormalTok{, labels}\OperatorTok{=}\VariableTok{False}\NormalTok{))}
\NormalTok{    .pipe(}
\NormalTok{        sns.barplot,}
\NormalTok{        x}\OperatorTok{=}\StringTok{\textquotesingle{}Return\_Bin\textquotesingle{}}\NormalTok{,}
\NormalTok{        y}\OperatorTok{=}\StringTok{\textquotesingle{}Signal\textquotesingle{}}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{plt.title(}\StringTok{\textquotesingle{}Percentage of Time SMA(20) Strategy is Long Bitcoin}\CharTok{\textbackslash{}n}\StringTok{by Bitcoin Daily Return Bins\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_05_files/figure-pdf/cell-12-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    btc\_sma}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .dropna()}
\NormalTok{    .assign(Volatility\_Bin}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: }\DecValTok{1} \OperatorTok{+}\NormalTok{ pd.qcut(x[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{].rolling(}\DecValTok{20}\NormalTok{).std(), q}\OperatorTok{=}\DecValTok{2}\NormalTok{, labels}\OperatorTok{=}\VariableTok{False}\NormalTok{))}
\NormalTok{    .pipe(}
\NormalTok{        sns.barplot,}
\NormalTok{        x}\OperatorTok{=}\StringTok{\textquotesingle{}Volatility\_Bin\textquotesingle{}}\NormalTok{,}
\NormalTok{        y}\OperatorTok{=}\StringTok{\textquotesingle{}Signal\textquotesingle{}}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{plt.title(}\StringTok{\textquotesingle{}Percentage of Time SMA(20) Strategy is Long Bitcoin}\CharTok{\textbackslash{}n}\StringTok{by Bitcoin 20{-}Day Volatility Bins\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_05_files/figure-pdf/cell-13-output-1.png}

\subsection{Implement the SMA(20) strategy with the market factor from
French}\label{implement-the-sma20-strategy-with-the-market-factor-from-french-3}

We need to impute a price before we calculate SMA(20), because French
does not provide a price we can use for technical analysis (TA).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pdr.DataReader(}
\NormalTok{        name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{        data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{        start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{    )}
\NormalTok{    [}\DecValTok{0}\NormalTok{]}
\NormalTok{    .div(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .assign(}
\NormalTok{        Mkt}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ x[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{],}
\NormalTok{        Price}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Mkt\textquotesingle{}}\NormalTok{].add(}\DecValTok{1}\NormalTok{).cumprod()}
\NormalTok{    )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_8472\2105953079.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_sma }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}Price\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{\})}
\NormalTok{    .pipe(calc\_sma, n}\OperatorTok{=}\DecValTok{20}\NormalTok{)}
\NormalTok{)}

\NormalTok{ff\_sma.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllll@{}}
\toprule\noalign{}
& Mkt-RF & SMB & HML & RF & Mkt & Adj Close & Return & SMA & Signal &
Strategy \\
Date & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-01-25 & 0.0046 & 0.0004 & 0.0056 & 0.0002 & 0.0048 & 11969.2170 &
0.0048 & 11716.9236 & 1.0000 & 0.0048 \\
2024-01-26 & -0.0002 & 0.0040 & -0.0027 & 0.0002 & 0.0000 & 11969.4564 &
0.0000 & 11727.1312 & 1.0000 & 0.0000 \\
2024-01-29 & 0.0085 & 0.0107 & -0.0059 & 0.0002 & 0.0087 & 12073.8301 &
0.0087 & 11742.4928 & 1.0000 & 0.0087 \\
2024-01-30 & -0.0013 & -0.0126 & 0.0084 & 0.0002 & -0.0011 & 12060.7903
& -0.0011 & 11759.6086 & 1.0000 & -0.0011 \\
2024-01-31 & -0.0174 & -0.0092 & -0.0030 & 0.0002 & -0.0172 & 11853.5860
& -0.0172 & 11770.3368 & 1.0000 & -0.0172 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ ff\_sma[[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]].dropna()}

\NormalTok{(}
\NormalTok{    \_}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_sma)}
\NormalTok{    .plot(logy}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Value ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Value of $1 Invested in Market}\CharTok{\textbackslash{}n}\SpecialStringTok{at Close on }\SpecialCharTok{\{}\NormalTok{\_}\SpecialCharTok{.}\NormalTok{index[}\DecValTok{0}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ pd}\SpecialCharTok{.}\NormalTok{offsets}\SpecialCharTok{.}\NormalTok{BDay(}\DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{d}\SpecialCharTok{,} \OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_05_files/figure-pdf/cell-16-output-1.png}

\subsection{How often does SMA(20) outperform buy-and-hold with 1-year
rolling windows with
Bitcoin?}\label{how-often-does-sma20-outperform-buy-and-hold-with-1-year-rolling-windows-with-bitcoin-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    btc\_sma}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .pipe(np.log1p)}
\NormalTok{    .rolling(}\DecValTok{365}\NormalTok{)}
\NormalTok{    .}\BuiltInTok{sum}\NormalTok{()}
\NormalTok{    .pipe(np.expm1)}
\NormalTok{)}

\NormalTok{(}
\NormalTok{    \_}
\NormalTok{    .dropna()}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_sma)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .plot()}
\NormalTok{)}

\NormalTok{plt.title(}\StringTok{\textquotesingle{}One{-}Year Rolling Returns for Bitcoin\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}One{-}Year Rolling Return (\%)\textquotesingle{}}\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}
    \SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{names\_sma[}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]}\SpecialCharTok{\}}\SpecialStringTok{ \textgreater{} }\SpecialCharTok{\{}\NormalTok{names\_sma[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}\SpecialCharTok{\}}\SpecialStringTok{ for One{-}Year Rolling Window:\textquotesingle{}}\NormalTok{,}
\NormalTok{    (\_[}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}}\NormalTok{ \_[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]).value\_counts(),}
\NormalTok{    sep}\OperatorTok{=}\StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
SMA(20) > Buy-And-Hold for One-Year Rolling Window:
False    2111
True     1363
Name: count, dtype: int64
\end{verbatim}

\includegraphics{herron_02_practice_05_files/figure-pdf/cell-17-output-2.png}

\subsection{Implement a long-only BB(20, 2) strategy with
Bitcoin}\label{implement-a-long-only-bb20-2-strategy-with-bitcoin-3}

More on Bollinger Bands
\href{https://www.bollingerbands.com/bollinger-bands}{here} and
\href{https://www.bollingerbands.com/bollinger-band-rules}{here}. In
short, Bollinger Bands are bands around a trend, typically defined in
terms of simple moving averages and volatilities. Here, long-only BB(20,
2) implies we have upper and lower bands at 2 standard deviations above
and below SMA(20):

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Buy when the closing price crosses LB(20) from below, where LB(20) is
  SMA(20) minus 2 sigma
\item
  Sell when the closing price crosses UB(20) from above, where UB(20) is
  SMA(20) plus 2 sigma
\item
  No short-selling
\end{enumerate}

The long-only BB(20, 2) is more difficult to implement than the
long-only SMA(20) because we need to track buys and sells. For example,
if the closing price is between LB(20) and BB(20), we need to know if
our last trade was a buy or a sell. Further, if the closing price is
below LB(20), we can still be long because we sell when the closing
price crosses UB(20) from above.

Here is a function to calculate Bolling Bands and implement the
strategy.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_bb(df, m, n):}
    \ControlFlowTok{return}\NormalTok{ (}
\NormalTok{        df}
\NormalTok{        .assign(}
\NormalTok{            Return}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].pct\_change(),}
\NormalTok{            SMA}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].rolling(m).mean(),}
\NormalTok{            SMV}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].rolling(m).std(),}
\NormalTok{            LB}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}SMA\textquotesingle{}}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ n}\OperatorTok{*}\NormalTok{x[}\StringTok{\textquotesingle{}SMV\textquotesingle{}}\NormalTok{],}
\NormalTok{            UB}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}SMA\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ n}\OperatorTok{*}\NormalTok{x[}\StringTok{\textquotesingle{}SMV\textquotesingle{}}\NormalTok{],}
\NormalTok{            Signal\_with\_nan}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.select(}
\NormalTok{                condlist}\OperatorTok{=}\NormalTok{[}
\NormalTok{                    (x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{) }\OperatorTok{\textgreater{}}\NormalTok{ x[}\StringTok{\textquotesingle{}LB\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)) }\OperatorTok{\&}\NormalTok{ (x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{) }\OperatorTok{\textless{}=}\NormalTok{ x[}\StringTok{\textquotesingle{}LB\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{)),}
\NormalTok{                    (x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{) }\OperatorTok{\textless{}}\NormalTok{ x[}\StringTok{\textquotesingle{}UB\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{)) }\OperatorTok{\&}\NormalTok{ (x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{) }\OperatorTok{\textgreater{}=}\NormalTok{ x[}\StringTok{\textquotesingle{}UB\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{))}
\NormalTok{                ],}
\NormalTok{                choicelist}\OperatorTok{=}\NormalTok{[}
                    \DecValTok{1}\NormalTok{,}
                    \DecValTok{0}
\NormalTok{                ],}
\NormalTok{                default}\OperatorTok{=}\NormalTok{np.nan}
\NormalTok{            ),}
\NormalTok{            Signal}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Signal\_with\_nan\textquotesingle{}}\NormalTok{].ffill(),}
\NormalTok{            Strategy}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{] }\OperatorTok{*}\NormalTok{ x[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{        )}
\NormalTok{    )}
\end{Highlighting}
\end{Shaded}

Again, we drop the last day to omit partial returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc\_bb }\OperatorTok{=}\NormalTok{ btc.iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].pipe(calc\_bb, m}\OperatorTok{=}\DecValTok{20}\NormalTok{, n}\OperatorTok{=}\DecValTok{2}\NormalTok{)}

\NormalTok{btc\_bb.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllllll@{}}
\toprule\noalign{}
Variable & Open & High & Low & Close & Adj Close & Volume & Return & SMA
& SMV & LB & UB & Signal\_with\_nan & Signal & Strategy \\
Date & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-03-17 & 65316.3438 & 68845.7188 & 64545.3164 & 68390.6250 &
68390.6250 & 44716864318 & 0.0471 & 66530.1934 & 4242.5090 & 58045.1755
& 75015.2113 & NaN & 0.0000 & 0.0000 \\
2024-03-18 & 68371.3047 & 68897.1328 & 66594.2266 & 67548.5938 &
67548.5938 & 49261579492 & -0.0123 & 67053.3545 & 3615.2985 & 59822.7575
& 74283.9515 & NaN & 0.0000 & -0.0000 \\
2024-03-19 & 67556.1328 & 68106.9297 & 61536.1797 & 61912.7734 &
61912.7734 & 74215844794 & -0.0834 & 67023.7537 & 3656.6873 & 59710.3790
& 74337.1284 & NaN & 0.0000 & -0.0000 \\
2024-03-20 & 61930.1562 & 68115.2578 & 60807.7852 & 67913.6719 &
67913.6719 & 66792634382 & 0.0969 & 67359.5182 & 3392.3919 & 60574.7343
& 74144.3020 & NaN & 0.0000 & 0.0000 \\
2024-03-21 & 67911.5859 & 68199.9922 & 64580.9180 & 65491.3906 &
65491.3906 & 44480350565 & -0.0357 & 67512.0561 & 3223.9829 & 61064.0903
& 73960.0218 & NaN & 0.0000 & -0.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{names\_bb }\OperatorTok{=}\NormalTok{ \{}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Buy{-}And{-}Hold\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}BB(20, 2)\textquotesingle{}}\NormalTok{\}}

\NormalTok{\_ }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    btc\_bb}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .dropna()}
\NormalTok{)}

\NormalTok{(}
\NormalTok{    \_}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_bb)}
\NormalTok{    .plot(logy}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Value ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Value of $1 Invested in Bitcoin}\CharTok{\textbackslash{}n}\SpecialStringTok{at Close on }\SpecialCharTok{\{}\NormalTok{\_}\SpecialCharTok{.}\NormalTok{index[}\DecValTok{0}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ pd}\SpecialCharTok{.}\NormalTok{offsets}\SpecialCharTok{.}\NormalTok{Day(}\DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{d}\SpecialCharTok{,} \OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_05_files/figure-pdf/cell-20-output-1.png}

Here are the final values of \$1 investments, which are difficult to
read on the log scale above.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    btc\_bb}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_bb)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .prod()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Strategy
Buy-And-Hold   143.2025
BB(20, 2)        1.8011
dtype: float64
\end{verbatim}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

We need a more complex plot to better understand what is going on!

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.ticker }\ImportTok{as}\NormalTok{ ticker}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fig, ax }\OperatorTok{=}\NormalTok{ plt.subplots(nrows}\OperatorTok{=}\DecValTok{2}\NormalTok{, ncols}\OperatorTok{=}\DecValTok{1}\NormalTok{, sharex}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ btc\_bb.loc[}\StringTok{\textquotesingle{}2023{-}02\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023{-}03\textquotesingle{}}\NormalTok{]}

\NormalTok{ax[}\DecValTok{0}\NormalTok{].plot(\_[[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]], label}\OperatorTok{=}\StringTok{\textquotesingle{}Price\textquotesingle{}}\NormalTok{)}
\NormalTok{ax[}\DecValTok{0}\NormalTok{].plot(\_[[}\StringTok{\textquotesingle{}SMA\textquotesingle{}}\NormalTok{]], label}\OperatorTok{=}\StringTok{\textquotesingle{}SMA(20)\textquotesingle{}}\NormalTok{)}
\NormalTok{ax[}\DecValTok{0}\NormalTok{].plot(\_[[}\StringTok{\textquotesingle{}UB\textquotesingle{}}\NormalTok{]], label}\OperatorTok{=}\StringTok{\textquotesingle{}LB and UB\textquotesingle{}}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}green\textquotesingle{}}\NormalTok{, linestyle}\OperatorTok{=}\StringTok{\textquotesingle{}:\textquotesingle{}}\NormalTok{)}
\NormalTok{ax[}\DecValTok{0}\NormalTok{].plot(\_[[}\StringTok{\textquotesingle{}LB\textquotesingle{}}\NormalTok{]], color}\OperatorTok{=}\StringTok{\textquotesingle{}green\textquotesingle{}}\NormalTok{, linestyle}\OperatorTok{=}\StringTok{\textquotesingle{}:\textquotesingle{}}\NormalTok{)}
\NormalTok{ax[}\DecValTok{0}\NormalTok{].legend()}
\NormalTok{ax[}\DecValTok{0}\NormalTok{].set\_ylabel(}\StringTok{\textquotesingle{}Price ($)\textquotesingle{}}\NormalTok{)}

\NormalTok{ax[}\DecValTok{1}\NormalTok{].plot(\_[[}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{]], label}\OperatorTok{=}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{)}
\NormalTok{ax[}\DecValTok{1}\NormalTok{].legend()}
\NormalTok{ax[}\DecValTok{1}\NormalTok{].set\_ylabel(}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{)}

\NormalTok{ax[}\DecValTok{0}\NormalTok{].yaxis.set\_major\_formatter(ticker.StrMethodFormatter(}\StringTok{\textquotesingle{}}\SpecialCharTok{\{x:,.0f\}}\StringTok{\textquotesingle{}}\NormalTok{))}
\NormalTok{fig.autofmt\_xdate()}

\NormalTok{plt.suptitle(}\StringTok{\textquotesingle{}Key Variables in Bitcoin BB(20, 2) Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_05_files/figure-pdf/cell-23-output-1.png}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\subsection{Implement a long-short RSI(14) strategy with
Bitcoin}\label{implement-a-long-short-rsi14-strategy-with-bitcoin-3}

From
\href{https://www.fidelity.com/learning-center/trading-investing/technical-analysis/technical-indicator-guide/rsi}{Fidelity}:

\begin{quote}
The Relative Strength Index (RSI), developed by J. Welles Wilder, is a
momentum oscillator that measures the speed and change of price
movements. The RSI oscillates between zero and 100. Traditionally the
RSI is considered overbought when above 70 and oversold when below 30.
Signals can be generated by looking for divergences and failure swings.
RSI can also be used to identify the general trend.
\end{quote}

Here is the RSI formula: \(RSI(n) = 100 - \frac{100}{1 + RS(n)}\), where
\(RS(n) = \frac{SMA(U, n)}{SMA(D, n)}\). For ``up days'',
\(U = \Delta Adj\ Close\) and \(D = 0\), and, for ``down days'',
\(U = 0\) and \(D = - \Delta Adj\ Close\). Therefore, \(U\) and \(D\)
are always non-negative. We can learn more about RSI
\href{https://en.wikipedia.org/wiki/Relative_strength_index}{here}.

We will implement a long-short RSI(14) as follows:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Enter a long position when the RSI crosses 30 from below, and exit the
  position when the RSI crosses 50 from below
\item
  Enter a short position when the RSI crosses 70 from above, and exit
  the position when the RSI crosses 50 from above
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_rsi(df, n, lb, mb, ub):}
    \ControlFlowTok{return}\NormalTok{ df.assign(}
\NormalTok{        Return}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].pct\_change(),}
\NormalTok{        Diff}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].diff(),}
\NormalTok{        U}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.select(}
\NormalTok{            condlist}\OperatorTok{=}\NormalTok{[x[}\StringTok{\textquotesingle{}Diff\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}=} \DecValTok{0}\NormalTok{, x[}\StringTok{\textquotesingle{}Diff\textquotesingle{}}\NormalTok{] }\OperatorTok{\textless{}} \DecValTok{0}\NormalTok{],}
\NormalTok{            choicelist}\OperatorTok{=}\NormalTok{[x[}\StringTok{\textquotesingle{}Diff\textquotesingle{}}\NormalTok{], }\DecValTok{0}\NormalTok{],}
\NormalTok{            default}\OperatorTok{=}\NormalTok{np.nan}
\NormalTok{        ),}
\NormalTok{        D}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.select(}
\NormalTok{            condlist}\OperatorTok{=}\NormalTok{[x[}\StringTok{\textquotesingle{}Diff\textquotesingle{}}\NormalTok{] }\OperatorTok{\textless{}=} \DecValTok{0}\NormalTok{, x[}\StringTok{\textquotesingle{}Diff\textquotesingle{}}\NormalTok{] }\OperatorTok{\textgreater{}} \DecValTok{0}\NormalTok{],}
\NormalTok{            choicelist}\OperatorTok{=}\NormalTok{[}\OperatorTok{{-}}\DecValTok{1} \OperatorTok{*}\NormalTok{ x[}\StringTok{\textquotesingle{}Diff\textquotesingle{}}\NormalTok{], }\DecValTok{0}\NormalTok{],}
\NormalTok{            default}\OperatorTok{=}\NormalTok{np.nan}
\NormalTok{        ),}
\NormalTok{        SMAU}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}U\textquotesingle{}}\NormalTok{].rolling(n).mean(),}
\NormalTok{        SMAD}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}D\textquotesingle{}}\NormalTok{].rolling(n).mean(),}
\NormalTok{        RS}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}SMAU\textquotesingle{}}\NormalTok{] }\OperatorTok{/}\NormalTok{ x[}\StringTok{\textquotesingle{}SMAD\textquotesingle{}}\NormalTok{],}
\NormalTok{        RSI}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: }\DecValTok{100} \OperatorTok{{-}} \DecValTok{100} \OperatorTok{/}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ x[}\StringTok{\textquotesingle{}RS\textquotesingle{}}\NormalTok{]),}
\NormalTok{        Signal\_with\_nan }\OperatorTok{=} \KeywordTok{lambda}\NormalTok{ x: np.select(}
\NormalTok{            condlist}\OperatorTok{=}\NormalTok{[}
\NormalTok{                (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{) }\OperatorTok{\textgreater{}=}\NormalTok{ lb) }\OperatorTok{\&}\NormalTok{ (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{) }\OperatorTok{\textless{}}\NormalTok{ lb), }
\NormalTok{                (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{) }\OperatorTok{\textgreater{}=}\NormalTok{ mb) }\OperatorTok{\&}\NormalTok{ (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{) }\OperatorTok{\textless{}}\NormalTok{ mb),}
\NormalTok{                (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{) }\OperatorTok{\textless{}=}\NormalTok{ ub) }\OperatorTok{\&}\NormalTok{ (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{) }\OperatorTok{\textgreater{}}\NormalTok{ ub), }
\NormalTok{                (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{1}\NormalTok{) }\OperatorTok{\textless{}=}\NormalTok{ mb) }\OperatorTok{\&}\NormalTok{ (x[}\StringTok{\textquotesingle{}RSI\textquotesingle{}}\NormalTok{].shift(}\DecValTok{2}\NormalTok{) }\OperatorTok{\textgreater{}}\NormalTok{ mb),}
\NormalTok{            ],}
\NormalTok{            choicelist}\OperatorTok{=}\NormalTok{[}
                \DecValTok{1}\NormalTok{, }
                \DecValTok{0}\NormalTok{,}
                \OperatorTok{{-}}\DecValTok{1}\NormalTok{,}
                \DecValTok{0}
\NormalTok{            ],}
\NormalTok{            default}\OperatorTok{=}\NormalTok{np.nan}
\NormalTok{        ),}
\NormalTok{        Signal}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Signal\_with\_nan\textquotesingle{}}\NormalTok{].ffill(),}
\NormalTok{        Strategy}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Signal\textquotesingle{}}\NormalTok{] }\OperatorTok{*}\NormalTok{ x[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{]}
\NormalTok{    )}
\end{Highlighting}
\end{Shaded}

Again, we drop the last day to omit partial returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{btc\_rsi }\OperatorTok{=}\NormalTok{ btc.iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].pipe(calc\_rsi, n}\OperatorTok{=}\DecValTok{14}\NormalTok{, mb}\OperatorTok{=}\DecValTok{2}\NormalTok{, lb}\OperatorTok{=}\DecValTok{30}\NormalTok{, ub}\OperatorTok{=}\DecValTok{70}\NormalTok{)}

\NormalTok{btc\_rsi.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllll@{}}
\toprule\noalign{}
Variable & Open & High & Low & Close & Adj Close & Volume & Return &
Diff & U & D & SMAU & SMAD & RS & RSI & Signal\_with\_nan & Signal &
Strategy \\
Date & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-03-17 & 65316.3438 & 68845.7188 & 64545.3164 & 68390.6250 &
68390.6250 & 44716864318 & 0.0471 & 3075.5078 & 3075.5078 & 0.0000 &
1297.3906 & 924.3011 & 1.4036 & 58.3965 & NaN & -1.0000 & -0.0471 \\
2024-03-18 & 68371.3047 & 68897.1328 & 66594.2266 & 67548.5938 &
67548.5938 & 49261579492 & -0.0123 & -842.0312 & 0.0000 & 842.0312 &
928.6018 & 984.4461 & 0.9433 & 48.5404 & NaN & -1.0000 & 0.0123 \\
2024-03-19 & 67556.1328 & 68106.9297 & 61536.1797 & 61912.7734 &
61912.7734 & 74215844794 & -0.0834 & -5635.8203 & 0.0000 & 5635.8203 &
928.6018 & 1063.4894 & 0.8732 & 46.6144 & NaN & -1.0000 & 0.0834 \\
2024-03-20 & 61930.1562 & 68115.2578 & 60807.7852 & 67913.6719 &
67913.6719 & 66792634382 & 0.0969 & 6000.8984 & 6000.8984 & 0.0000 &
1192.5513 & 1063.4894 & 1.1214 & 52.8604 & NaN & -1.0000 & -0.0969 \\
2024-03-21 & 67911.5859 & 68199.9922 & 64580.9180 & 65491.3906 &
65491.3906 & 44480350565 & -0.0357 & -2422.2812 & 0.0000 & 2422.2812 &
1134.0742 & 1236.5095 & 0.9172 & 47.8395 & NaN & -1.0000 & 0.0357 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{names\_rsi }\OperatorTok{=}\NormalTok{ \{}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Buy{-}And{-}Hold\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}RSI(14)\textquotesingle{}}\NormalTok{\}}

\NormalTok{\_ }\OperatorTok{=}\NormalTok{ btc\_rsi[[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]].dropna()}

\NormalTok{(}
\NormalTok{    \_}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_rsi)}
\NormalTok{    .plot(logy}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Value ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Value of $1 Invested in Bitcoin Strategies}\CharTok{\textbackslash{}n}\SpecialStringTok{at Close on }\SpecialCharTok{\{}\NormalTok{\_}\SpecialCharTok{.}\NormalTok{index[}\DecValTok{0}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ pd}\SpecialCharTok{.}\NormalTok{offsets}\SpecialCharTok{.}\NormalTok{Day(}\DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{d}\SpecialCharTok{,} \OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_05_files/figure-pdf/cell-26-output-1.png}

Here are the final values of \$1 investments, which are difficult to
read on the log scale above.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    btc\_rsi}
\NormalTok{    [[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{names\_sma)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .prod()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Strategy
Buy-And-Hold   143.2025
SMA(20)          0.0002
dtype: float64
\end{verbatim}

\textbf{\emph{Shorting Bitcoin has been dangerous!}}

We can compare all three TA strategies!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    btc\_sma[[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .join(}
\NormalTok{        btc\_bb[[}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]].add\_suffix(}\StringTok{\textquotesingle{}\_BB\textquotesingle{}}\NormalTok{), }
\NormalTok{    )}
\NormalTok{    .join(}
\NormalTok{        btc\_rsi[[}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{]].add\_suffix(}\StringTok{\textquotesingle{}\_RSI\textquotesingle{}}\NormalTok{), }
\NormalTok{    )}
\NormalTok{    .dropna()}
\NormalTok{)}


\NormalTok{(}
\NormalTok{    \_}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .cumprod()}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}
\NormalTok{            \{}
                \StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Buy{-}And{-}Hold\textquotesingle{}}\NormalTok{, }
                \StringTok{\textquotesingle{}Strategy\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}SMA(20)\textquotesingle{}}\NormalTok{,}
                \StringTok{\textquotesingle{}Strategy\_BB\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}BB(20, 2)\textquotesingle{}}\NormalTok{,}
                \StringTok{\textquotesingle{}Strategy\_RSI\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}RSI(14)\textquotesingle{}}\NormalTok{,}
\NormalTok{            \}}
\NormalTok{           )}
\NormalTok{    .plot(logy}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Value ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\SpecialStringTok{f\textquotesingle{}Value of $1 Invested in Bitcoin Strategies}\CharTok{\textbackslash{}n}\SpecialStringTok{at Close on }\SpecialCharTok{\{}\NormalTok{\_}\SpecialCharTok{.}\NormalTok{index[}\DecValTok{0}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ pd}\SpecialCharTok{.}\NormalTok{offsets}\SpecialCharTok{.}\NormalTok{Day(}\DecValTok{1}\NormalTok{)}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{d}\SpecialCharTok{,} \OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_02_practice_05_files/figure-pdf/cell-28-output-1.png}

\part{Week 11}

\chapter{Project 2}\label{project-2}

FINA 6333 -- Spring 2023

\hfill\break

To be determined

\part{Week 12}

\chapter{Herron Topic 3 - Multifactor
Models}\label{herron-topic-3---multifactor-models}

This notebook covers multifactor models, emphasizing the capital asset
pricing model (CAPM) and the Fama-French three-factor model (FF3). Ivo
Welch provides a high-level review of the CAPM and multifactor models in
\href{https://book.ivo-welch.info/read/source5.mba/10-capm.pdf}{Chapter
10 of his free \emph{Corporate Finance} textbook}. The
\href{https://en.wikipedia.org/wiki/Capital_asset_pricing_model}{Wikipedia
page for the CAPM} is surprisingly good and includes its assumptions and
shortcomings.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ seaborn }\ImportTok{as}\NormalTok{ sns}
\ImportTok{import}\NormalTok{ statsmodels.formula.api }\ImportTok{as}\NormalTok{ smf}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\section{The Capital Asset Pricing Model
(CAPM)}\label{the-capital-asset-pricing-model-capm}

The CAPM explains the relation between non-diversifiable risk and
expected return and has applications throughout finance. We use the CAPM
to estimate expected rates of return in investment analysis, estimate
costs of capital in corporate finance, and assemble portfolios with a
given risk-return tradeoff in portfolio management. The formula for the
CAPM is \(E(r_i) = r_f + \beta_i [E(r_M) - r_f]\), where:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \(r_f\) is the risk-free rate of return,
\item
  \(\beta_i\) is the measure of non-diversifiable risk for asset \(i\),
  and
\item
  \(E(r_M)\) is the expected rate of return on the market.
\end{enumerate}

The value-weighted mean of all \(\beta_i\)s is 1 by construction, but a
range of \(\beta_i\)s is possible:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \(\beta_i < -1\): Asset \(i\) moves in the opposite direction as the
  market, in larger magnitudes
\item
  \(-1 \leq \beta_i < 0\): Asset \(i\) moves in the opposite direction
  as the market
\item
  \(\beta_i = 0\): Asset \(i\) has no correlation between with the
  market
\item
  \(0 < \beta_i \leq 1\): Asset \(i\) moves in the same direction as the
  market, in smaller magnitudes
\item
  \(\beta_i = 1\): Asset \(i\) moves in the same direction with the same
  magnitude as the market
\item
  \(\beta_i > 1\): Asset \(i\) moves in the same direction as the
  market, in larger magnitudes
\end{enumerate}

We will follow Bodie, Kane, and Marcus's notation:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Lowercase \(r_i\) is the \emph{raw} return on asset \(i\)
\item
  Uppercase \(R_i\) is the \emph{excess} return on asset \(i\)
\item
  So, \(R_i = r_i - r_f\) and \(R_M = r_M - r_f\)
\end{enumerate}

\subsection{\texorpdfstring{\(\beta\)
Estimation}{\textbackslash beta Estimation}}\label{beta-estimation}

We can use three approaches to estimate CAPM \(\beta_i\)s:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Use the covariance and variance of excess returns:
  \(\beta_i = \frac{Cov(r_i - r_f, r_M - r_f)}{Var(r_M - r_f)}\)
\item
  Use the correlation and standard deviations of excess returns:
  \(\beta_i = \rho_{i, M} \frac{\sigma_i}{\sigma_M}\)
\item
  Use a linear regression of asset excess returns \(r_i-r_f\) on market
  excess returns \(r_M-r_f\)
\end{enumerate}

The first two approaches are computationally faster. However, the third
approach also estimates the intercept \(\alpha_i\) and several
goodness-of-fit statistics. We can use Apple (AAPL) to convince
ourselves these three approaches are equivalent.

\textbf{\emph{Note, we will leave returns in percent to make it easier
to interpret our regression output!}} Leaving returns in percent does
not affect \(\beta\) estimates (slopes) but makes \(\alpha\) estimates
(intercepts) easier to interpret because they are in percents instead of
decimals.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{aapl }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}AAPL\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{aapl.tail()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  1 of 1 completed
\end{verbatim}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
Variable & Open & High & Low & Close & Adj Close & Volume \\
Date & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-03-22 & 171.7600 & 173.0500 & 170.0600 & 172.2800 & 172.2800 &
71106600 \\
2024-03-25 & 170.5700 & 171.9400 & 169.4500 & 170.8500 & 170.8500 &
54288300 \\
2024-03-26 & 170.0000 & 171.4200 & 169.5800 & 169.7100 & 169.7100 &
57388400 \\
2024-03-27 & 170.4100 & 173.6000 & 170.1100 & 173.3100 & 173.3100 &
60273300 \\
2024-03-28 & 171.7500 & 172.2300 & 170.5100 & 171.4800 & 171.4800 &
65623100 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pdr.DataReader(}
\NormalTok{        name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{        data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{        start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}\NormalTok{,}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{ff[}\DecValTok{0}\NormalTok{].tail()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_25232\3958803354.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& Mkt-RF & SMB & HML & RF \\
Date & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-01-25 & 0.4600 & 0.0400 & 0.5600 & 0.0220 \\
2024-01-26 & -0.0200 & 0.4000 & -0.2700 & 0.0220 \\
2024-01-29 & 0.8500 & 1.0700 & -0.5900 & 0.0220 \\
2024-01-30 & -0.1300 & -1.2600 & 0.8400 & 0.0220 \\
2024-01-31 & -1.7400 & -0.9200 & -0.3000 & 0.0220 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{aapl }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    aapl}
\NormalTok{    .join(ff[}\DecValTok{0}\NormalTok{])}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}RM\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}rf\textquotesingle{}}\NormalTok{\})}
\NormalTok{    .assign(}
\NormalTok{        ri}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].pct\_change().mul(}\DecValTok{100}\NormalTok{),}
\NormalTok{        Ri }\OperatorTok{=} \KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}ri\textquotesingle{}}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ x[}\StringTok{\textquotesingle{}rf\textquotesingle{}}\NormalTok{],}
\NormalTok{        rM}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}RM\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ x[}\StringTok{\textquotesingle{}rf\textquotesingle{}}\NormalTok{]}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{aapl.head()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllll@{}}
\toprule\noalign{}
& Open & High & Low & Close & Adj Close & Volume & RM & SMB & HML & rf &
ri & Ri & rM \\
Date & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1980-12-12 & 0.1283 & 0.1289 & 0.1283 & 0.1283 & 0.0992 & 469033600 &
1.3800 & -0.0100 & -1.0500 & 0.0590 & NaN & NaN & 1.4390 \\
1980-12-15 & 0.1222 & 0.1222 & 0.1217 & 0.1217 & 0.0940 & 175884800 &
0.1100 & 0.2500 & -0.4600 & 0.0590 & -5.2170 & -5.2760 & 0.1690 \\
1980-12-16 & 0.1133 & 0.1133 & 0.1127 & 0.1127 & 0.0871 & 105728000 &
0.7100 & -0.7500 & -0.4700 & 0.0590 & -7.3398 & -7.3988 & 0.7690 \\
1980-12-17 & 0.1155 & 0.1161 & 0.1155 & 0.1155 & 0.0893 & 86441600 &
1.5200 & -0.8600 & -0.3400 & 0.0590 & 2.4751 & 2.4161 & 1.5790 \\
1980-12-18 & 0.1189 & 0.1194 & 0.1189 & 0.1189 & 0.0919 & 73449600 &
0.4100 & 0.2200 & 1.2600 & 0.0590 & 2.8992 & 2.8402 & 0.4690 \\
\end{longtable}

\subsubsection{\texorpdfstring{Covariance and Variance Approach to
Estimate
\(\beta\)}{Covariance and Variance Approach to Estimate \textbackslash beta}}\label{covariance-and-variance-approach-to-estimate-beta}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{vcv }\OperatorTok{=}\NormalTok{ aapl[[}\StringTok{\textquotesingle{}Ri\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}RM\textquotesingle{}}\NormalTok{]].dropna().cov()}

\NormalTok{vcv}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lll@{}}
\toprule\noalign{}
& Ri & RM \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
Ri & 7.8421 & 1.5508 \\
RM & 1.5508 & 1.2312 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Apple beta from cov/var: }\SpecialCharTok{\{}\NormalTok{vcv}\SpecialCharTok{.}\NormalTok{loc[}\StringTok{\textquotesingle{}Ri\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}RM\textquotesingle{}}\NormalTok{] }\OperatorTok{/}\NormalTok{ vcv}\SpecialCharTok{.}\NormalTok{loc[}\StringTok{\textquotesingle{}RM\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}RM\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:0.4f\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Apple beta from cov/var: 1.2596
\end{verbatim}

\subsubsection{\texorpdfstring{Correlation and Standard Deviation
Approach to Estimate
\(\beta\)}{Correlation and Standard Deviation Approach to Estimate \textbackslash beta}}\label{correlation-and-standard-deviation-approach-to-estimate-beta}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ aapl[[}\StringTok{\textquotesingle{}Ri\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}RM\textquotesingle{}}\NormalTok{]].dropna()}
\NormalTok{rho }\OperatorTok{=}\NormalTok{ \_.corr()}
\NormalTok{sigma }\OperatorTok{=}\NormalTok{ \_.std()}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}rho:}\CharTok{\textbackslash{}n}\SpecialCharTok{\{}\NormalTok{rho}\SpecialCharTok{\}}\CharTok{\textbackslash{}n\textbackslash{}n}\SpecialStringTok{sigma:}\CharTok{\textbackslash{}n}\SpecialCharTok{\{}\NormalTok{sigma}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
rho:
       Ri     RM
Ri 1.0000 0.4991
RM 0.4991 1.0000

sigma:
Ri   2.8004
RM   1.1096
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Apple beta from rho and sigmas: }\SpecialCharTok{\{}\NormalTok{rho}\SpecialCharTok{.}\NormalTok{loc[}\StringTok{\textquotesingle{}Ri\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}RM\textquotesingle{}}\NormalTok{] }\OperatorTok{*}\NormalTok{ sigma}\SpecialCharTok{.}\NormalTok{loc[}\StringTok{\textquotesingle{}Ri\textquotesingle{}}\NormalTok{] }\OperatorTok{/}\NormalTok{ sigma}\SpecialCharTok{.}\NormalTok{loc[}\StringTok{\textquotesingle{}RM\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:0.4f\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Apple beta from rho and sigmas: 1.2596
\end{verbatim}

\subsubsection{\texorpdfstring{Linear Regression Approach to Estimate
\(\beta\)}{Linear Regression Approach to Estimate \textbackslash beta}}\label{linear-regression-approach-to-estimate-beta}

We will use the statsmodels package to estimate linear regressions. I
typically use the formula application programming interface (API).

With statsmodels (and most Python model estimation packages), we have
three steps:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Specify the model with the \texttt{smf.ols()} function
\item
  Fit the model with the \texttt{.fit()} method
\item
  Summarize the model with the \texttt{.summary()} method
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{model }\OperatorTok{=}\NormalTok{ smf.ols(formula}\OperatorTok{=}\StringTok{\textquotesingle{}Ri \textasciitilde{} RM\textquotesingle{}}\NormalTok{, data}\OperatorTok{=}\NormalTok{aapl)}
\NormalTok{fit }\OperatorTok{=}\NormalTok{ model.fit()}
\NormalTok{summary }\OperatorTok{=}\NormalTok{ fit.summary()}

\NormalTok{summary}
\end{Highlighting}
\end{Shaded}

\begin{center}
\begin{tabular}{lclc}
\toprule
\textbf{Dep. Variable:}    &        Ri        & \textbf{  R-squared:         } &     0.249   \\
\textbf{Model:}            &       OLS        & \textbf{  Adj. R-squared:    } &     0.249   \\
\textbf{Method:}           &  Least Squares   & \textbf{  F-statistic:       } &     3606.   \\
\textbf{Date:}             & Fri, 29 Mar 2024 & \textbf{  Prob (F-statistic):} &     0.00    \\
\textbf{Time:}             &     08:15:40     & \textbf{  Log-Likelihood:    } &   -25067.   \\
\textbf{No. Observations:} &       10873      & \textbf{  AIC:               } & 5.014e+04   \\
\textbf{Df Residuals:}     &       10871      & \textbf{  BIC:               } & 5.015e+04   \\
\textbf{Df Model:}         &           1      & \textbf{                     } &             \\
\textbf{Covariance Type:}  &    nonrobust     & \textbf{                     } &             \\
\bottomrule
\end{tabular}
\begin{tabular}{lcccccc}
                   & \textbf{coef} & \textbf{std err} & \textbf{t} & \textbf{P$> |$t$|$} & \textbf{[0.025} & \textbf{0.975]}  \\
\midrule
\textbf{Intercept} &       0.0514  &        0.023     &     2.207  &         0.027        &        0.006    &        0.097     \\
\textbf{RM}        &       1.2596  &        0.021     &    60.049  &         0.000        &        1.218    &        1.301     \\
\bottomrule
\end{tabular}
\begin{tabular}{lclc}
\textbf{Omnibus:}       & 3230.837 & \textbf{  Durbin-Watson:     } &     1.916   \\
\textbf{Prob(Omnibus):} &   0.000  & \textbf{  Jarque-Bera (JB):  } & 334498.501  \\
\textbf{Skew:}          &  -0.379  & \textbf{  Prob(JB):          } &      0.00   \\
\textbf{Kurtosis:}      &  30.162  & \textbf{  Cond. No.          } &      1.11   \\
\bottomrule
\end{tabular}
%\caption{OLS Regression Results}
\end{center}

Notes: \newline
 [1] Standard Errors assume that the covariance matrix of the errors is correctly specified.

We can recover the coefficient estimates from the \texttt{fit} object's
\texttt{params} attribute.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fit.params}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Intercept   0.0514
RM          1.2596
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Apple beta from linear regression: }\SpecialCharTok{\{}\NormalTok{fit}\SpecialCharTok{.}\NormalTok{params[}\StringTok{\textquotesingle{}RM\textquotesingle{}}\NormalTok{]}\SpecialCharTok{:0.4f\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Apple beta from linear regression: 1.2596
\end{verbatim}

We can chain these operations, but it often makes sense to save the
intermediate results to model and fit objects.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{smf.ols(}\StringTok{\textquotesingle{}Ri \textasciitilde{} RM\textquotesingle{}}\NormalTok{, aapl).fit().summary()}
\end{Highlighting}
\end{Shaded}

\begin{center}
\begin{tabular}{lclc}
\toprule
\textbf{Dep. Variable:}    &        Ri        & \textbf{  R-squared:         } &     0.249   \\
\textbf{Model:}            &       OLS        & \textbf{  Adj. R-squared:    } &     0.249   \\
\textbf{Method:}           &  Least Squares   & \textbf{  F-statistic:       } &     3606.   \\
\textbf{Date:}             & Fri, 29 Mar 2024 & \textbf{  Prob (F-statistic):} &     0.00    \\
\textbf{Time:}             &     08:16:28     & \textbf{  Log-Likelihood:    } &   -25067.   \\
\textbf{No. Observations:} &       10873      & \textbf{  AIC:               } & 5.014e+04   \\
\textbf{Df Residuals:}     &       10871      & \textbf{  BIC:               } & 5.015e+04   \\
\textbf{Df Model:}         &           1      & \textbf{                     } &             \\
\textbf{Covariance Type:}  &    nonrobust     & \textbf{                     } &             \\
\bottomrule
\end{tabular}
\begin{tabular}{lcccccc}
                   & \textbf{coef} & \textbf{std err} & \textbf{t} & \textbf{P$> |$t$|$} & \textbf{[0.025} & \textbf{0.975]}  \\
\midrule
\textbf{Intercept} &       0.0514  &        0.023     &     2.207  &         0.027        &        0.006    &        0.097     \\
\textbf{RM}        &       1.2596  &        0.021     &    60.049  &         0.000        &        1.218    &        1.301     \\
\bottomrule
\end{tabular}
\begin{tabular}{lclc}
\textbf{Omnibus:}       & 3230.837 & \textbf{  Durbin-Watson:     } &     1.916   \\
\textbf{Prob(Omnibus):} &   0.000  & \textbf{  Jarque-Bera (JB):  } & 334498.501  \\
\textbf{Skew:}          &  -0.379  & \textbf{  Prob(JB):          } &      0.00   \\
\textbf{Kurtosis:}      &  30.162  & \textbf{  Cond. No.          } &      1.11   \\
\bottomrule
\end{tabular}
%\caption{OLS Regression Results}
\end{center}

Notes: \newline
 [1] Standard Errors assume that the covariance matrix of the errors is correctly specified.

\subsection{\texorpdfstring{How to Visualize
\(\beta\)}{How to Visualize \textbackslash beta}}\label{how-to-visualize-beta}

We can visualize \(\beta\) as a scatterplot of \texttt{Ri} versus
\texttt{RM}, where \(\beta\) is the slope of the best-fit line. We can
use the seaborn package's \texttt{regplot()} to add this best-fit line.
We can write three functions to more easily make pretty plots.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ get\_beta(x):}
\NormalTok{    vcv }\OperatorTok{=}\NormalTok{ x.dropna().cov()}
\NormalTok{    beta }\OperatorTok{=}\NormalTok{ vcv.loc[}\StringTok{\textquotesingle{}Ri\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}RM\textquotesingle{}}\NormalTok{] }\OperatorTok{/}\NormalTok{ vcv.loc[}\StringTok{\textquotesingle{}RM\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}RM\textquotesingle{}}\NormalTok{]}
    \ControlFlowTok{return} \VerbatimStringTok{r\textquotesingle{}$\textbackslash{}beta=$\textquotesingle{}} \OperatorTok{+} \SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{beta}\SpecialCharTok{: 0.4f\}}\SpecialStringTok{\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ get\_dates(x):}
\NormalTok{    y }\OperatorTok{=}\NormalTok{ x.dropna()}
    \ControlFlowTok{return} \SpecialStringTok{f\textquotesingle{}from }\SpecialCharTok{\{}\NormalTok{y}\SpecialCharTok{.}\NormalTok{index[}\DecValTok{0}\NormalTok{]}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{d}\SpecialCharTok{,} \OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{y}\SpecialCharTok{.}\NormalTok{index[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{d}\SpecialCharTok{,} \OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ plot\_beta(x, freq, name):}
\NormalTok{    sns.regplot(}
\NormalTok{        data}\OperatorTok{=}\NormalTok{x,}
\NormalTok{        x}\OperatorTok{=}\StringTok{\textquotesingle{}RM\textquotesingle{}}\NormalTok{,}
\NormalTok{        y}\OperatorTok{=}\StringTok{\textquotesingle{}Ri\textquotesingle{}}\NormalTok{,}
\NormalTok{        scatter\_kws}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}alpha\textquotesingle{}}\NormalTok{: }\FloatTok{0.1}\NormalTok{\},}
\NormalTok{        line\_kws}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}label\textquotesingle{}}\NormalTok{: x.pipe(get\_beta)\}}
\NormalTok{    )}
\NormalTok{    plt.legend()}
\NormalTok{    plt.xlabel(}\SpecialStringTok{f\textquotesingle{}Market }\SpecialCharTok{\{}\NormalTok{freq}\SpecialCharTok{\}}\SpecialStringTok{ Excess Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{    plt.ylabel(}\SpecialStringTok{f\textquotesingle{}Stock }\SpecialCharTok{\{}\NormalTok{freq}\SpecialCharTok{\}}\SpecialStringTok{ Excess Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{    plt.title(}
        \VerbatimStringTok{r\textquotesingle{}$\textbackslash{}beta$ Plot with \textquotesingle{}} \OperatorTok{+} 
        \SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{freq}\SpecialCharTok{\}}\SpecialStringTok{ Excess Returns for }\SpecialCharTok{\{}\NormalTok{name}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}} \OperatorTok{+} 
        \StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}} \OperatorTok{+} 
\NormalTok{        x.pipe(get\_dates)}
\NormalTok{    )}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    aapl}
\NormalTok{    [[}\StringTok{\textquotesingle{}Ri\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}RM\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .dropna()}
\NormalTok{    .pipe(plot\_beta, freq}\OperatorTok{=}\StringTok{\textquotesingle{}Daily\textquotesingle{}}\NormalTok{, name}\OperatorTok{=}\StringTok{\textquotesingle{}Apple\textquotesingle{}}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_lecture_files/figure-pdf/cell-18-output-1.png}

We see a strong relation between Apple and market excess returns, but
there is a lot of unexplained variation in Apple excess returns because
Apple has changed a lot over the past 45 years! The best practice is to
estimate \(\beta\) with one to three years of daily data.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    aapl}
\NormalTok{    [[}\StringTok{\textquotesingle{}Ri\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}RM\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .dropna()}
\NormalTok{    .iloc[}\OperatorTok{{-}}\DecValTok{504}\NormalTok{:]}
\NormalTok{    .pipe(plot\_beta, freq}\OperatorTok{=}\StringTok{\textquotesingle{}Daily\textquotesingle{}}\NormalTok{, name}\OperatorTok{=}\StringTok{\textquotesingle{}Apple\textquotesingle{}}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_lecture_files/figure-pdf/cell-19-output-1.png}

\subsection{The Security Market Line
(SML)}\label{the-security-market-line-sml}

The SML visualizes the CAPM. We can visualize
\(E(r_i) = r_f + \beta_i [E(r_M) - r_f]\) as \(y = b + xm\), where:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The equity premium \(E(r_M) - r_f\) is the slope \(m\) of the SML
\item
  The risk-free rate of return \(r_f\) is its intercept \(b\) of the SML
\end{enumerate}

We will explore the SML more in the practice notebook.

\subsection{How well does the CAPM
work?}\label{how-well-does-the-capm-work}

The CAPM \emph{appears} to work well as a single-period model. We can
see this with portfolios formed on \(\beta\) from Ken French.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_beta }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolios\_Formed\_on\_BETA\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_25232\1792222927.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_beta = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_25232\1792222927.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_beta = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_25232\1792222927.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_beta = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_25232\1792222927.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_beta = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_25232\1792222927.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_beta = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_25232\1792222927.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_beta = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_25232\1792222927.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_beta = pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(ff\_beta[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Portfolios Formed on BETA
-------------------------

This file was created by CMPT_BETA_RETS using the 202401 CRSP database. It contains value- and equal-weighted returns for portfolios formed on BETA. The portfolios are constructed at the end of June. Beta is estimated using monthly returns for the past 60 months (requiring at least 24 months with non-missing returns). Beta is estimated using the Scholes-Williams method. Annual returns are from January to December. Missing data are indicated by -99.99 or -999. The break points include utilities and include financials. The portfolios include utilities and include financials. Copyright 2024 Kenneth R. French

  0 : Value Weighted Returns -- Monthly (727 rows x 15 cols)
  1 : Equal Weighted Returns -- Monthly (727 rows x 15 cols)
  2 : Value Weighted Returns -- Annual from January to December (60 rows x 15 cols)
  3 : Equal Weighted Returns -- Annual from January to December (60 rows x 15 cols)
  4 : Number of Firms in Portfolios (727 rows x 15 cols)
  5 : Average Firm Size (727 rows x 15 cols)
  6 : Value-Weighted Average of Prior Beta (61 rows x 15 cols)
\end{verbatim}

This file contains seven data frames. We want the data frame at
\texttt{{[}2{]}}, which contains the annual returns on two sets of
portfolios formed on the previous year's \(\beta\)s.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_beta[}\DecValTok{2}\NormalTok{].head()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllll@{}}
\toprule\noalign{}
& Lo 20 & Qnt 2 & Qnt 3 & Qnt 4 & Hi 20 & Lo 10 & Dec 2 & Dec 3 & Dec 4
& Dec 5 & Dec 6 & Dec 7 & Dec 8 & Dec 9 & Hi 10 \\
Date & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1964 & 16.8700 & 19.7500 & 17.6600 & 8.7300 & 12.5500 & 24.7000 &
13.5900 & 20.2700 & 19.0100 & 19.7900 & 15.6800 & 9.7900 & 8.2300 &
13.6000 & 11.6600 \\
1965 & 8.7200 & 6.9800 & 15.4000 & 24.8800 & 49.6700 & 12.4400 & 6.7600
& 10.0200 & 5.2500 & 13.7100 & 17.1100 & 20.7000 & 28.2800 & 42.0700 &
57.7300 \\
1966 & -9.2500 & -12.1700 & -9.1000 & -2.7300 & -2.2000 & -9.4300 &
-9.4400 & -12.5700 & -12.1600 & -7.5000 & -10.5600 & -6.2200 & 0.1800 &
-3.3100 & -0.9400 \\
1967 & 13.4300 & 22.0600 & 31.9500 & 42.7900 & 51.1500 & 8.9200 &
18.6400 & 22.7900 & 21.6500 & 31.1100 & 34.1600 & 40.5700 & 44.4000 &
41.6100 & 59.7800 \\
1968 & 15.8100 & 9.1200 & 13.6400 & 14.4300 & 24.2400 & 18.4800 &
12.8400 & 14.5100 & 5.8400 & 12.6600 & 14.7500 & 19.0800 & 10.5400 &
23.2500 & 25.2900 \\
\end{longtable}

We can plot the mean annual return on each of the five portfolios in the
first set of portflios. We do not need to annualize these numbers
because they are the means of annual returns. The vertical black bars
indicate the 95\% confidence intervals for our mean annual return
estimates.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_beta}
\NormalTok{    [}\DecValTok{2}\NormalTok{]}
\NormalTok{    .iloc[:, :}\DecValTok{5}\NormalTok{]}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{sns.barplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{\_.stack().to\_frame(}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{).reset\_index(),}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.xlabel(}\VerbatimStringTok{r\textquotesingle{}Portfolio Formed on $\textbackslash{}beta$\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Mean Annual Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}
    \VerbatimStringTok{r\textquotesingle{}Mean Annual Returns on Portfolios Formed on $\textbackslash{}beta$\textquotesingle{}} \OperatorTok{+} 
    \StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}} \OperatorTok{+} 
    \SpecialStringTok{f\textquotesingle{}from }\SpecialCharTok{\{}\NormalTok{\_}\SpecialCharTok{.}\NormalTok{index[}\DecValTok{0}\NormalTok{]}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{\_}\SpecialCharTok{.}\NormalTok{index[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_lecture_files/figure-pdf/cell-23-output-1.png}

We can think of the plot above as a binned plot of the SML. The x-axis
above is an ordinal measure of \(\beta\), and the y-axis above is the
mean return. Recall the slope of the SML is the market risk premium. If
the market risk premium is too low, then high \(\beta\) stocks do not
have high enough returns. We can see this failure of the CAPM by
plotting long-term or cumulative returns on these five portfolios.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_beta}
\NormalTok{    [}\DecValTok{2}\NormalTok{]}
\NormalTok{    .iloc[:, :}\DecValTok{5}\NormalTok{]}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{\_.div(}\DecValTok{100}\NormalTok{).add(}\DecValTok{1}\NormalTok{).cumprod().plot()}
\NormalTok{plt.semilogy()}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Value ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}
    \VerbatimStringTok{r\textquotesingle{}Value of \textbackslash{}$1 Investments in Portfolios Formed on $\textbackslash{}beta$\textquotesingle{}} \OperatorTok{+} 
    \StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}} \OperatorTok{+} 
    \SpecialStringTok{f\textquotesingle{}from }\SpecialCharTok{\{}\NormalTok{\_}\SpecialCharTok{.}\NormalTok{index[}\DecValTok{0}\NormalTok{]}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{\_}\SpecialCharTok{.}\NormalTok{index[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_lecture_files/figure-pdf/cell-24-output-1.png}

In the plot above, the highest-\(\beta\) portfolio has the lowest
cumulative returns! The log scale masks a lot of variation, too!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_beta}
\NormalTok{    [}\DecValTok{2}\NormalTok{]}
\NormalTok{    .iloc[:, :}\DecValTok{5}\NormalTok{]}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{\_.div(}\DecValTok{100}\NormalTok{).add(}\DecValTok{1}\NormalTok{).prod().plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Value ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}
    \VerbatimStringTok{r\textquotesingle{}Value of \textbackslash{}$1 Investments in Portfolios Formed on $\textbackslash{}beta$\textquotesingle{}} \OperatorTok{+} 
    \StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}} \OperatorTok{+} 
    \SpecialStringTok{f\textquotesingle{}from }\SpecialCharTok{\{}\NormalTok{\_}\SpecialCharTok{.}\NormalTok{index[}\DecValTok{0}\NormalTok{]}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{\_}\SpecialCharTok{.}\NormalTok{index[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_lecture_files/figure-pdf/cell-25-output-1.png}

If the CAPM does not work well, especially over the horizons we use it
for (e.g., capital budgeting), why do we continue to learn it?

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The CAPM works well \emph{across} asset classes. We will explore this
  more in the practice notebook.
\item
  The CAPM intuition that diversification matters is correct and
  important
\item
  The CAPM assigns high costs of capital to high-\(\beta\) projects
  (i.e., high-risk projects), which is a hidden benefit
\item
  In practice, everyone uses the CAPM
\end{enumerate}

Ivo Welch provides a more complete discussion in section 10.5 of
\href{https://book.ivo-welch.info/read/source5.mba/10-capm.pdf}{chapter
10 of this his free \emph{Corporate Finance} textbook}.

\section{Multifactor Models}\label{multifactor-models}

Another shortcoming of the CAPM is that it fails to explain the returns
on portfolios formed on size (market capitalization) and value
(book-to-market equity ratio), which we will explore in the practice
notebook. These shortcomings have led to an explosion in multifactor
models, which we will explore here.

\subsection{The Fama-French Three-Factor
Model}\label{the-fama-french-three-factor-model}

Fama and French (1993) expand the CAPM by adding two new factors to
explain the excess returns on size and value. The size factor, SMB or
small-minus-big, is a diversified portfolio that measures the excess
returns of small market capitalization stocks over large market
capitalization stocks. The value factor, HML of high-minus-low, is a
diversified portfolio that measures the excess returns of high
book-to-market stocks over low book-to-market stocks. We typically call
this model the ``Fama-French three-factor model'' and express it as:
\[E(r_i) - r_f = \alpha_i + \beta_{M} [E(r_M) - r_f)] + \beta_{SMB} SMB + \beta_{HML} HML\]
There are two common uses for the three-factor model:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Use the coefficient estimate on the intercept as a risk-adjusted
  performance measure. If \(\alpha_i\) is positive and statistically
  significant, we may attribute fund performance to manager skill.
\item
  Use the remaining coefficient estimates to evaluate how the fund
  manager generates returns. Also, if the regression \(R^2\) is high, we
  may replace the fund manager with the factors themselves.
\end{enumerate}

We can use the Fama-French three-factor model to evaluate Warren Buffett
at Berkshire Hathaway (BRK-A). We will focus on the first three-years of
easily available returns because Buffett had a larger edge when BRK was
much smaller.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{brk }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}BRK{-}A\textquotesingle{}}\NormalTok{)}
\NormalTok{    .join(ff[}\DecValTok{0}\NormalTok{])}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}RM\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}rf\textquotesingle{}}\NormalTok{\})}
\NormalTok{    .assign(}
\NormalTok{        ri}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].pct\_change().mul(}\DecValTok{100}\NormalTok{),}
\NormalTok{        Ri}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}ri\textquotesingle{}}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ x[}\StringTok{\textquotesingle{}rf\textquotesingle{}}\NormalTok{],}
\NormalTok{        rm}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}RM\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ x[}\StringTok{\textquotesingle{}rf\textquotesingle{}}\NormalTok{]}
\NormalTok{    )}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{)}
\NormalTok{)}

\NormalTok{brk.tail()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  1 of 1 completed
\end{verbatim}

\begin{longtable}[]{@{}llllllllllllll@{}}
\toprule\noalign{}
Variable & Open & High & Low & Close & Adj Close & Volume & RM & SMB &
HML & rf & ri & Ri & rm \\
Date & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-03-22 & 623558.0000 & 626334.0000 & 621121.0000 & 623040.0000 &
623040.0000 & 12800 & NaN & NaN & NaN & NaN & -0.3288 & NaN & NaN \\
2024-03-25 & 622726.0000 & 625000.0000 & 617521.0000 & 619500.0000 &
619500.0000 & 16500 & NaN & NaN & NaN & NaN & -0.5682 & NaN & NaN \\
2024-03-26 & 619805.0000 & 623790.0000 & 616716.0000 & 622380.0000 &
622380.0000 & 12700 & NaN & NaN & NaN & NaN & 0.4649 & NaN & NaN \\
2024-03-27 & 625082.0000 & 630000.0000 & 621646.0000 & 629610.0000 &
629610.0000 & 12900 & NaN & NaN & NaN & NaN & 1.1617 & NaN & NaN \\
2024-03-28 & 630365.0000 & 634800.0000 & 628150.0000 & 634440.0000 &
634440.0000 & 13100 & NaN & NaN & NaN & NaN & 0.7671 & NaN & NaN \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{model }\OperatorTok{=}\NormalTok{ smf.ols(formula}\OperatorTok{=}\StringTok{\textquotesingle{}Ri \textasciitilde{} RM + SMB + HML\textquotesingle{}}\NormalTok{, data}\OperatorTok{=}\NormalTok{brk.iloc[:}\DecValTok{756}\NormalTok{])}
\NormalTok{fit }\OperatorTok{=}\NormalTok{ model.fit()}
\NormalTok{summary }\OperatorTok{=}\NormalTok{ fit.summary()}
\NormalTok{summary}
\end{Highlighting}
\end{Shaded}

\begin{center}
\begin{tabular}{lclc}
\toprule
\textbf{Dep. Variable:}    &        Ri        & \textbf{  R-squared:         } &     0.053   \\
\textbf{Model:}            &       OLS        & \textbf{  Adj. R-squared:    } &     0.049   \\
\textbf{Method:}           &  Least Squares   & \textbf{  F-statistic:       } &     13.91   \\
\textbf{Date:}             & Fri, 29 Mar 2024 & \textbf{  Prob (F-statistic):} &  7.81e-09   \\
\textbf{Time:}             &     11:34:52     & \textbf{  Log-Likelihood:    } &   -1208.9   \\
\textbf{No. Observations:} &         755      & \textbf{  AIC:               } &     2426.   \\
\textbf{Df Residuals:}     &         751      & \textbf{  BIC:               } &     2444.   \\
\textbf{Df Model:}         &           3      & \textbf{                     } &             \\
\textbf{Covariance Type:}  &    nonrobust     & \textbf{                     } &             \\
\bottomrule
\end{tabular}
\begin{tabular}{lcccccc}
                   & \textbf{coef} & \textbf{std err} & \textbf{t} & \textbf{P$> |$t$|$} & \textbf{[0.025} & \textbf{0.975]}  \\
\midrule
\textbf{Intercept} &       0.0801  &        0.044     &     1.809  &         0.071        &       -0.007    &        0.167     \\
\textbf{RM}        &       0.3484  &        0.075     &     4.643  &         0.000        &        0.201    &        0.496     \\
\textbf{SMB}       &       0.4021  &        0.093     &     4.302  &         0.000        &        0.219    &        0.586     \\
\textbf{HML}       &       0.0907  &        0.125     &     0.724  &         0.469        &       -0.155    &        0.336     \\
\bottomrule
\end{tabular}
\begin{tabular}{lclc}
\textbf{Omnibus:}       & 118.864 & \textbf{  Durbin-Watson:     } &     1.797  \\
\textbf{Prob(Omnibus):} &   0.000 & \textbf{  Jarque-Bera (JB):  } &  1308.034  \\
\textbf{Skew:}          &   0.284 & \textbf{  Prob(JB):          } & 9.20e-285  \\
\textbf{Kurtosis:}      &   9.423 & \textbf{  Cond. No.          } &      3.51  \\
\bottomrule
\end{tabular}
%\caption{OLS Regression Results}
\end{center}

Notes: \newline
 [1] Standard Errors assume that the covariance matrix of the errors is correctly specified.

The \(\alpha\) above seems small, but it is a \emph{daily} value. We
multiply \(\alpha\) by 252 to annualize it.

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f"Buffet\textquotesingle{}s annualized alpha in the early 1980s: }\SpecialCharTok{\{}\NormalTok{fit}\SpecialCharTok{.}\NormalTok{params[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{] }\OperatorTok{*} \DecValTok{252}\SpecialCharTok{:0.4f\}}\SpecialStringTok{"}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Buffet's annualized alpha in the early 1980s: 20.1836
\end{verbatim}

We will explore rolling \(\alpha\)s and \(\beta\)s in the practice
notebook using \texttt{RollingOLS()} from
\texttt{statsmodels.regression.rolling}.

\subsection{The Four-Factor and Five-Factor
Models}\label{the-four-factor-and-five-factor-models}

There are literally hundreds of published factors! However, many of them
have little explanatory power, in-sample or out-of-sample. Two more
factor models with explanatory power, economic intuition, and widespread
adoption are the four-factor model and the five-factor model.

The four-factor model adds a momentum factor to the Fama-French
three-factor model. The momentum factor is a diversified portfolio that
measures the excess returns of winner stocks over the loser stocks over
the past 12 months. The momentum factor is often called UMD for
up-minus-down or WML for winners-minus-losers. French stores the
momentum factor in a different file because Fama and French are
skeptical of momentum as a fundamental risk factor.

The five-factor model adds profitability and investment policy factors.
The profitability factor, RMW or robust-minus-weak, measures the excess
returns of stocks with high profits over those with low profits. The
investment policy factor, CMA or conservative-minus-aggressive, measures
the excess returns of stocks with low corporate investment
(conservative) over those with high corporate investment (aggressive).

We will explore the four-factor and five-factor models in the practice
notebook.

\chapter{Herron Topic 3 - Practice for Section
02}\label{herron-topic-3---practice-for-section-02}

\section{Announcements}\label{announcements-36}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  We will make a few changes to give us more time to work on Project 3:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    We will drop Herron Topic 5 on simulations during Week 14 and use
    this time for group work
  \item
    I will finalize Project 3 by Thursday, 4/4, so we have about 3 week
    to work on it before the Tuesday, 4/23, due date
  \end{enumerate}
\item
  \textbf{\emph{Next Thursday and Friday, 4/11 and 4/12, we will take
  the MSFQ assessment exam in class. I do not control this exam, and
  there are a few conditions:}}

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    \textbf{\emph{Open book}}
  \item
    \textbf{\emph{On Canvas}}
  \item
    \textbf{\emph{In the classroom}}
  \end{enumerate}
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-35}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The Capital Asset Pricing Model (CAPM) estimates asset \(i\)'s
  expected return as \(E(r_i) = r_f + \beta_i [E(r_M) - r_f]\), where:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    \(r_f\) is the risk-free rate
  \item
    \(\beta_i\) is asset \(i\)'s systematic risk
  \item
    \(E(r_M) - r_f\) is the market risk premium
  \end{enumerate}
\item
  The Security Market Line (SML) visualizes the CAPM

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Plots \(E(r_i)\) on the y axis against \(\beta_i\) on the x axis
  \item
    The slope of the SML is the market risk premium \(E(r_M) - r_f\)
  \item
    The intercept of the SML is the risk-free rate \(r_f\)
  \end{enumerate}
\item
  We can estimate asset \(i\)'s systematic risk a few ways:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    \(\beta_i = \frac{Cov(r_i-r_f, r_M-r_f)}{Var(r_M-r_f)}\)
  \item
    \(\beta_i = Corr(r_i-r_f, r_M-r_f) \frac{Std(r_i-r_f)}{Std(r_M-r_f)}\)
  \item
    Estimate the linear regression
    \(r_i - r_f = \alpha_i + \beta_i [r_M - r_f] + \varepsilon_i\) with
    the \texttt{smf.ols()} function after we
    \texttt{import\ statsmodels.formula.api\ as\ smf}
  \item
    We will follow Bodie, Kane, and Marcus's syntax where a \(r\) is a
    raw return and a \(R\) is an excess return, so \(R_i = r_i - r_f\)
  \end{enumerate}
\item
  The CAPM is the foundation of modern finance and does well for single
  periods but has a few shortcomings:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Does poorly over multiple periods
  \item
    The SML is ``too flat'' empirically, and high \(\beta\) assets tend
    to have lower returns than expected
  \item
    Does explain the returns on several factors, like size, value, and
    momentum
  \end{enumerate}
\item
  The Fama-French 3-factor model---and many others---attempts to solves
  these shortcomings and is useful for evaluating fund manager
  performance
\end{enumerate}

\section{Practice}\label{practice-36}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ seaborn }\ImportTok{as}\NormalTok{ sns}
\ImportTok{import}\NormalTok{ statsmodels.formula.api }\ImportTok{as}\NormalTok{ smf}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{Plot the security market line (SML) for a variety of asset
classes}\label{plot-the-security-market-line-sml-for-a-variety-of-asset-classes}

Use the past three years of daily data for the following exhange traded
funds (ETFs):

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  SPY (SPDR---Standard and Poor's Depository Receipts---ETF for the S\&P
  500 index)
\item
  BIL (SPDR ETF for 1-3 month Treasury bills)
\item
  GLD (SPDR ETF for gold)
\item
  JNK (SPDR ETF for high-yield debt)
\item
  MDY (SPDR ETF for S\&P 400 mid-cap index)
\item
  SLY (SPDR ETF for S\&P 600 small-cap index)
\item
  SPBO (SPDR ETF for corporate bonds)
\item
  SPMB (SPDR ETF for mortgage-backed securities)
\item
  SPTL (SPDR ETF for long-term Treasury bonds)
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tickers }\OperatorTok{=} \StringTok{\textquotesingle{}SPY BIL GLD JNK MDY SLY SPBO SPMB SPTL\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

For multifactor models, we generally leave returns in percents. Slope
coefficient estimates (i.e., \(\beta\)s) are the same for decimal and
percent returns. Intercept coefficient estimates (i.e., \(\alpha\)s) are
easier to interpret in percents than in decimals because small percent
returns have two fewer zeros than small decimal returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{etf }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\NormalTok{tickers)}
\NormalTok{    [}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    .pct\_change()}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{)}

\NormalTok{etf.tail()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  9 of 9 completed
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\1015031953.py:5: FutureWarning: The default fill_method='pad' in DataFrame.pct_change is deprecated and will be removed in a future version. Either fill in any non-leading NA values prior to calling pct_change or specify 'fill_method=None' to not fill NA values.
  .pct_change()
\end{verbatim}

\begin{longtable}[]{@{}llllllllll@{}}
\toprule\noalign{}
& BIL & GLD & JNK & MDY & SLY & SPBO & SPMB & SPTL & SPY \\
Date & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-03-28 & 0.0000 & 1.2900 & -0.1573 & 0.3589 & 0.0000 & -0.0687 &
-0.2297 & 0.0000 & -0.0191 \\
2024-04-01 & 0.0273 & 1.0208 & -0.4974 & -0.7225 & 0.0000 & -0.7728 &
-0.7249 & -1.8024 & -0.1740 \\
2024-04-02 & 0.0219 & 1.4772 & -0.1910 & -1.2799 & 0.0000 & -0.1391 &
-0.0930 & -0.4022 & -0.6358 \\
2024-04-03 & 0.0000 & 0.8772 & 0.0532 & 0.3998 & 0.0000 & 0.0696 &
0.0466 & -0.1101 & 0.1099 \\
2024-04-04 & 0.0437 & -0.5735 & -0.1382 & -1.0594 & 0.0000 & 0.1392 &
0.3257 & 0.6983 & -1.2206 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pdr.DataReader(}
\NormalTok{        name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{        data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{        start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{    )}
\NormalTok{    [}\DecValTok{0}\NormalTok{]}
\NormalTok{)}

\NormalTok{ff.tail()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\3487692931.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& Mkt-RF & SMB & HML & RF \\
Date & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-02-23 & 0.0200 & 0.2800 & -0.0300 & 0.0210 \\
2024-02-26 & -0.2600 & 1.0000 & -0.1100 & 0.0210 \\
2024-02-27 & 0.2700 & 1.1900 & -0.4500 & 0.0210 \\
2024-02-28 & -0.2600 & -0.8500 & 0.0000 & 0.0210 \\
2024-02-29 & 0.5400 & -0.3400 & 0.9800 & 0.0210 \\
\end{longtable}

We will write two helper functions to make it easier to calculate
annualized mean returns and CAPM betas. We will pass these function
names to the pandas \texttt{.agg()} method, which applies these
functions to every column and combines the results.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_ann\_mean(ri, ann\_fac}\OperatorTok{=}\DecValTok{252}\NormalTok{):}
    \ControlFlowTok{return}\NormalTok{ ri.mean() }\OperatorTok{*}\NormalTok{ ann\_fac}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_beta(ri, rf}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], RM}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{]):}
\NormalTok{    Ri }\OperatorTok{=}\NormalTok{ ri.sub(rf).dropna()}
    \ControlFlowTok{return}\NormalTok{ Ri.cov(RM) }\OperatorTok{/}\NormalTok{ RM.loc[Ri.index].var()}
\end{Highlighting}
\end{Shaded}

We should estimate CAPM betas from one-year to three-years of daily
returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{etf\_sml }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    etf}
\NormalTok{    .loc[}\StringTok{\textquotesingle{}2021{-}02\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2024{-}01\textquotesingle{}}\NormalTok{]}
\NormalTok{    .agg([calc\_ann\_mean, calc\_beta])}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The \texttt{regplot()} function in the seaborn package plots a
scatterplot and adds a best-fit line with 95\% confidence interval.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.regplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{etf\_sml,}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}calc\_beta\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}calc\_ann\_mean\textquotesingle{}}
\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ t, (x, y) }\KeywordTok{in}\NormalTok{ etf\_sml[[}\StringTok{\textquotesingle{}calc\_beta\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}calc\_ann\_mean\textquotesingle{}}\NormalTok{]].iterrows():}
\NormalTok{    plt.annotate(text}\OperatorTok{=}\NormalTok{t, xy}\OperatorTok{=}\NormalTok{(x, y))}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\VerbatimStringTok{r\textquotesingle{}Capital Asset Pricing Model (CAPM) $\textbackslash{}beta$\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}
    \StringTok{\textquotesingle{}Security Market Line (SML) from Exchange Traded Funds (ETFs)}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}} \OperatorTok{+}
    \StringTok{\textquotesingle{}Daily Returns from 2021{-}02 to 2024{-}01\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_02_files/figure-pdf/cell-10-output-1.png}

\textbf{\emph{We see the CAPM and SML work well for asset classes!}} The
slope is positive, the intercept is a reasonable risk-free rate, and
assets plot along the SML, most within the 95\% confidence interval.
Note that a few fixed-income ETFs have negative mean returns, but the
SML still has the shape and fit we expect by theory.

The fit above is not perfect, but the \(R^2\) is fairly high at around
50\%. For a single-factor regression, we can quickly calculate \(R^2\)
as \(\rho^2\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{etf\_sml.corr().loc[}\StringTok{\textquotesingle{}calc\_ann\_mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}calc\_beta\textquotesingle{}}\NormalTok{]}\OperatorTok{**}\DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.5086
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{smf.ols(formula}\OperatorTok{=}\StringTok{\textquotesingle{}calc\_ann\_mean \textasciitilde{} calc\_beta\textquotesingle{}}\NormalTok{, data}\OperatorTok{=}\NormalTok{etf\_sml).fit().rsquared}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.5086
\end{verbatim}

\subsection{Plot the SML for the Dow Jones Industrial Average (DJIA)
stocks}\label{plot-the-sml-for-the-dow-jones-industrial-average-djia-stocks}

Use the past three years of daily returns data for the stocks listed on
the
\href{https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average}{DJIA
Wikipedia page}. Compare the DJIA SML to the asset class SML above.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tickers }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.read\_html(}\StringTok{\textquotesingle{}https://en.wikipedia.org/wiki/Dow\_Jones\_Industrial\_Average\textquotesingle{}}\NormalTok{)}
\NormalTok{    [}\DecValTok{1}\NormalTok{]}
\NormalTok{    [}\StringTok{\textquotesingle{}Symbol\textquotesingle{}}\NormalTok{]}
\NormalTok{    .to\_list()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{djia }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\NormalTok{tickers)}
\NormalTok{    [}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    .pct\_change()}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{)}

\NormalTok{djia.tail()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  30 of 30 completed
\end{verbatim}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
& AAPL & AMGN & AMZN & AXP & BA & CAT & CRM & CSCO & CVX & DIS & ... &
MMM & MRK & MSFT & NKE & PG & TRV & UNH & V & VZ & WMT \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-03-28 & -1.0559 & -0.6916 & 0.3058 & -0.0263 & 0.5418 & 0.4881 &
-0.0664 & 0.2813 & 0.8890 & 1.1407 & ... & 1.4150 & 0.1518 & -0.1685 &
-0.1593 & -0.2214 & 0.5725 & 0.3245 & 0.0215 & 1.0111 & -0.9058 \\
2024-04-01 & -0.8456 & -0.4502 & 0.3271 & -0.0351 & -1.8084 & -0.7341 &
0.3586 & 0.2605 & 0.8495 & -0.6783 & ... & 6.0129 & -0.7275 & 0.9151 &
-1.5110 & -1.0293 & -0.8603 & -1.0107 & -0.2867 & 0.7626 & -0.2825 \\
2024-04-02 & -0.6999 & -2.4131 & -0.1547 & -0.9138 & -0.7705 & 0.2997 &
0.5757 & -1.3589 & 0.4400 & 1.0615 & ... & -1.2551 & -0.4886 & -0.7372 &
-1.7394 & -0.0062 & -0.1359 & -6.4448 & 0.0575 & 0.6150 & -1.4000 \\
2024-04-03 & 0.4797 & -0.6480 & 0.9519 & 0.4877 & -1.6592 & 3.0041 &
0.2434 & -0.4493 & 0.4131 & -3.1265 & ... & 0.3770 & -0.3452 & -0.2349 &
-0.6817 & -2.7527 & 0.5310 & 0.3492 & -0.5315 & 0.7052 & 0.4564 \\
2024-04-04 & -0.4892 & -2.3067 & -1.3212 & -2.8062 & -0.8815 & -1.5966 &
-3.4784 & -1.2926 & 0.1558 & -1.5885 & ... & -2.8437 & -1.7244 & -0.6113
& -1.3949 & -0.4483 & -0.2445 & -0.9484 & -1.0687 & -0.9104 & 0.1178 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{djia\_sml }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    djia}
\NormalTok{    .loc[}\StringTok{\textquotesingle{}2021{-}02\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2024{-}01\textquotesingle{}}\NormalTok{]}
\NormalTok{    .agg([calc\_ann\_mean, calc\_beta])}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.regplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{djia\_sml,}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}calc\_beta\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}calc\_ann\_mean\textquotesingle{}}
\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ t, (x, y) }\KeywordTok{in}\NormalTok{ djia\_sml[[}\StringTok{\textquotesingle{}calc\_beta\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}calc\_ann\_mean\textquotesingle{}}\NormalTok{]].iterrows():}
\NormalTok{    plt.annotate(text}\OperatorTok{=}\NormalTok{t, xy}\OperatorTok{=}\NormalTok{(x, y))}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\VerbatimStringTok{r\textquotesingle{}Capital Asset Pricing Model (CAPM) $\textbackslash{}beta$\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}
    \StringTok{\textquotesingle{}Security Market Line (SML) from Dow{-}Jones Stocks}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}} \OperatorTok{+}
    \StringTok{\textquotesingle{}Daily Returns from 2021{-}02 to 2024{-}01\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_02_files/figure-pdf/cell-16-output-1.png}

For single stocks the SML falls apart!

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The slope is negative and we would fail to reject it is flat
\item
  The intercept is above the risk-free rate
\item
  Many stocks plot outside the 95\% confidence interval
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{djia\_sml.corr().loc[}\StringTok{\textquotesingle{}calc\_ann\_mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}calc\_beta\textquotesingle{}}\NormalTok{]}\OperatorTok{**}\DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.0178
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{smf.ols(formula}\OperatorTok{=}\StringTok{\textquotesingle{}calc\_ann\_mean \textasciitilde{} calc\_beta\textquotesingle{}}\NormalTok{, data}\OperatorTok{=}\NormalTok{djia\_sml).fit().rsquared}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.0178
\end{verbatim}

\subsection{Plot the SML for the five portfolios formed on
beta}\label{plot-the-sml-for-the-five-portfolios-formed-on-beta}

Download data for portfolios formed on \(\beta\)
(\texttt{Portfolios\_Formed\_on\_BETA}) from Ken French. For the
value-weighted portfolios, plot realized returns versus \(\beta\). These
data should elements \texttt{{[}2{]}} and \texttt{{[}6{]}},
respectively.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_beta }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolios\_Formed\_on\_BETA\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(ff\_beta[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Portfolios Formed on BETA
-------------------------

This file was created by CMPT_BETA_RETS using the 202402 CRSP database. It contains value- and equal-weighted returns for portfolios formed on BETA. The portfolios are constructed at the end of June. Beta is estimated using monthly returns for the past 60 months (requiring at least 24 months with non-missing returns). Beta is estimated using the Scholes-Williams method. Annual returns are from January to December. Missing data are indicated by -99.99 or -999. The break points include utilities and include financials. The portfolios include utilities and include financials. Copyright 2024 Kenneth R. French

  0 : Value Weighted Returns -- Monthly (728 rows x 15 cols)
  1 : Equal Weighted Returns -- Monthly (728 rows x 15 cols)
  2 : Value Weighted Returns -- Annual from January to December (60 rows x 15 cols)
  3 : Equal Weighted Returns -- Annual from January to December (60 rows x 15 cols)
  4 : Number of Firms in Portfolios (728 rows x 15 cols)
  5 : Average Firm Size (728 rows x 15 cols)
  6 : Value-Weighted Average of Prior Beta (61 rows x 15 cols)
\end{verbatim}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\2406176535.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_beta = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\2406176535.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_beta = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\2406176535.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_beta = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\2406176535.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_beta = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\2406176535.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_beta = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\2406176535.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_beta = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\2406176535.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_beta = pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_beta[}\DecValTok{2}\NormalTok{].tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllll@{}}
\toprule\noalign{}
& Lo 20 & Qnt 2 & Qnt 3 & Qnt 4 & Hi 20 & Lo 10 & Dec 2 & Dec 3 & Dec 4
& Dec 5 & Dec 6 & Dec 7 & Dec 8 & Dec 9 & Hi 10 \\
Date & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2019 & 27.1700 & 29.7200 & 30.1300 & 37.7300 & 31.6700 & 27.8100 &
26.5400 & 28.8400 & 30.7600 & 30.0200 & 30.2900 & 33.0000 & 41.3000 &
28.7000 & 41.1800 \\
2020 & 5.2800 & 12.3500 & 45.0300 & 41.5800 & 45.3000 & 2.9800 & 7.1300
& 12.4400 & 12.6900 & 38.0200 & 45.4700 & 13.9200 & 61.3100 & 23.5400 &
87.7700 \\
2021 & 18.5600 & 28.8500 & 13.8500 & 48.5000 & 26.7600 & 18.1400 &
19.3500 & 26.8400 & 31.5400 & 20.1300 & 9.4100 & 54.1100 & 29.8300 &
40.4500 & -2.0900 \\
2022 & -7.2500 & -20.8600 & -14.8000 & -24.5900 & -39.7300 & -0.6100 &
-10.9100 & -9.2800 & -29.0900 & -8.6400 & -21.0600 & -24.3400 & -20.7500
& -29.0300 & -50.7600 \\
2023 & 2.3000 & 27.9500 & 26.2600 & 44.3900 & 74.7900 & 3.8800 & 0.9900
& 14.1500 & 36.4700 & 28.8700 & 24.4100 & 41.0000 & 46.7500 & 85.9800 &
59.7000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_beta[}\DecValTok{6}\NormalTok{].tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllll@{}}
\toprule\noalign{}
& Lo 20 & Qnt 2 & Qnt 3 & Qnt 4 & Hi 20 & Lo 10 & Dec 2 & Dec 3 & Dec 4
& Dec 5 & Dec 6 & Dec 7 & Dec 8 & Dec 9 & Hi 10 \\
Date & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2019 & 0.2410 & 0.7710 & 1.1210 & 1.5020 & 2.2040 & -0.0220 & 0.4350 &
0.6920 & 0.8520 & 1.0570 & 1.1920 & 1.3870 & 1.5870 & 1.8800 & 2.8550 \\
2020 & 0.4320 & 0.9340 & 1.3400 & 1.6880 & 2.4090 & 0.2190 & 0.6040 &
0.8550 & 1.0360 & 1.2250 & 1.4090 & 1.5950 & 1.7960 & 2.1030 & 2.8770 \\
2021 & 0.4600 & 0.8940 & 1.2690 & 1.6290 & 2.4640 & 0.1880 & 0.6030 &
0.8120 & 0.9850 & 1.1850 & 1.3520 & 1.5750 & 1.7970 & 2.2080 & 3.0420 \\
2022 & 0.3740 & 0.8670 & 1.1530 & 1.5230 & 2.2120 & 0.2240 & 0.5020 &
0.7560 & 0.9260 & 1.0650 & 1.2230 & 1.3900 & 1.6010 & 1.9220 & 2.5190 \\
2023 & 0.3950 & 0.8710 & 1.1630 & 1.5190 & 2.1440 & 0.2260 & 0.5320 &
0.7710 & 0.9380 & 1.1010 & 1.2400 & 1.4040 & 1.5700 & 1.9460 & 2.4110 \\
\end{longtable}

We will combine the annual value-weighted returns data in
\texttt{ff\_beta{[}2{]}} with the value-weighted beta data in
\texttt{ff\_beta{[}6{]}} into one data frame \texttt{ff\_beta\_sml}. We
can easily use the \texttt{.join()} method if we first use the
\texttt{stack()} method to convert the returns and beta data frames into
long data frames.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_beta\_sml }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_beta[}\DecValTok{2}\NormalTok{].iloc[:, :}\DecValTok{5}\NormalTok{] }\CommentTok{\# annual value{-}weighted returns on quintile portfolios}
\NormalTok{    .stack() }\CommentTok{\# convert to long data frame with one column of returns}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{)}
\NormalTok{    .join(}
\NormalTok{        ff\_beta[}\DecValTok{6}\NormalTok{].iloc[:, :}\DecValTok{5}\NormalTok{] }\CommentTok{\# value{-}weighted betas from previous year on quintile portfolios}
\NormalTok{        .stack() }\CommentTok{\# convert to long data frame with one column of betas}
\NormalTok{        .to\_frame(}\StringTok{\textquotesingle{}Beta\textquotesingle{}}\NormalTok{)}
\NormalTok{    )}
\NormalTok{    .rename\_axis(}
\NormalTok{        index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Data\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{],}
\NormalTok{        columns}\OperatorTok{=}\StringTok{\textquotesingle{}Variable\textquotesingle{}}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{ff\_beta\_sml.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& Variable & Return & Beta \\
Data & Portfolio & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{5}{=}{2023} & Lo 20 & 2.3000 & 0.3950 \\
& Qnt 2 & 27.9500 & 0.8710 \\
& Qnt 3 & 26.2600 & 1.1630 \\
& Qnt 4 & 44.3900 & 1.5190 \\
& Hi 20 & 74.7900 & 2.1440 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start }\OperatorTok{=}\NormalTok{ ff\_beta\_sml.index.get\_level\_values(}\DecValTok{0}\NormalTok{).year[}\DecValTok{0}\NormalTok{]}
\NormalTok{stop }\OperatorTok{=}\NormalTok{ ff\_beta\_sml.index.get\_level\_values(}\DecValTok{0}\NormalTok{).year[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}

\NormalTok{sns.regplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{ff\_beta\_sml,}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Beta\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annual Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\VerbatimStringTok{r\textquotesingle{}Capital Asset Pricing Model (CAPM) $\textbackslash{}beta$\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}
    \VerbatimStringTok{r\textquotesingle{}Security Market Line (SML) for $\textbackslash{}beta$ Quintile Portfolios\textquotesingle{}} \OperatorTok{+}
    \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}n}\SpecialStringTok{for Annual Returns from }\SpecialCharTok{\{}\NormalTok{start}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{stop}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_02_files/figure-pdf/cell-23-output-1.png}

\subsection{\texorpdfstring{Estimate the CAPM \(\beta\)s on several
levered and inverse exchange traded funds
(ETFs)}{Estimate the CAPM \textbackslash betas on several levered and inverse exchange traded funds (ETFs)}}\label{estimate-the-capm-betas-on-several-levered-and-inverse-exchange-traded-funds-etfs}

Try the following ETFs:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  SPY
\item
  UPRO
\item
  SPXU
\end{enumerate}

Can you determine what these products do from the data alone? Estimate
\(\beta\)s and plot cumulative returns. You may want to pick short
periods of time with large market swings.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{etf\_2 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}SPY UPRO SPXU\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
\NormalTok{    [}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    .pct\_change()}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .dropna()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  3 of 3 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{etf\_2.}\BuiltInTok{apply}\NormalTok{(calc\_beta).rename(}\VerbatimStringTok{r\textquotesingle{}$\textbackslash{}beta$\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Ticker
SPXU   -2.8635
SPY     0.9582
UPRO    2.8790
Name: $\beta$, dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start }\OperatorTok{=}\NormalTok{ etf\_2.index[}\DecValTok{0}\NormalTok{]}
\NormalTok{stop }\OperatorTok{=}\NormalTok{ etf\_2.index[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}

\NormalTok{etf\_2.}\BuiltInTok{apply}\NormalTok{(calc\_beta).plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xticks(rotation}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{plt.ylabel(}\VerbatimStringTok{r\textquotesingle{}Capital Asset Pricing Model (CAPM) $\textbackslash{}beta$\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}
    \VerbatimStringTok{r\textquotesingle{}Capital Asset Pricing Model (CAPM) $\textbackslash{}beta$s\textquotesingle{}} \OperatorTok{+} 
    \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}n}\SpecialStringTok{from Daily Returns from }\SpecialCharTok{\{}\NormalTok{start}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{d }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{stop}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{d }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_02_files/figure-pdf/cell-26-output-1.png}

\subsection{Explore the size factor}\label{explore-the-size-factor}

First, we need data for portfolio and factor returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_me }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolios\_Formed\_on\_ME\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(ff\_me[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\948145699.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\948145699.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\948145699.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\948145699.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\948145699.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\948145699.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_me = pdr.DataReader(
\end{verbatim}

\begin{verbatim}
Portfolios Formed on ME
-----------------------

This file was created by CMPT_ME_RETS using the 202402 CRSP database. It contains value- and equal-weighted returns for size portfolios. Each record contains returns for: Negative (not used) 30% 40% 30%   5 Quintiles  10 Deciles The portfolios are constructed at the end of Jun. The annual returns are from January to December. Missing data are indicated by -99.99 or -999. Copyright 2024 Kenneth R. French

  0 : Value Weight Returns -- Monthly (1172 rows x 19 cols)
  1 : Equal Weight Returns -- Monthly (1172 rows x 19 cols)
  2 : Value Weight Returns -- Annual from January to December (97 rows x 19 cols)
  3 : Equal Weight Returns -- Annual from January to December (97 rows x 19 cols)
  4 : Number of Firms in Portfolios (1172 rows x 19 cols)
  5 : Average Firm Size (1172 rows x 19 cols)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_m }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(ff\_m[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\1667574714.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_m = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\1667574714.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_m = pdr.DataReader(
\end{verbatim}

\begin{verbatim}
F-F Research Data Factors
-------------------------

This file was created by CMPT_ME_BEME_RETS using the 202402 CRSP database. The 1-month TBill return is from Ibbotson and Associates, Inc. Copyright 2024 Kenneth R. French

  0 : (1172 rows x 4 cols)
  1 : Annual Factors: January-December (97 rows x 4 cols)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_me }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_me[}\DecValTok{1}\NormalTok{]}
\NormalTok{    .iloc[:, }\OperatorTok{{-}}\DecValTok{10}\NormalTok{:]}
\NormalTok{    .join(ff\_m[}\DecValTok{0}\NormalTok{])}
\NormalTok{)}

\NormalTok{df\_me.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllllll@{}}
\toprule\noalign{}
& Lo 10 & Dec 2 & Dec 3 & Dec 4 & Dec 5 & Dec 6 & Dec 7 & Dec 8 & Dec 9
& Hi 10 & Mkt-RF & SMB & HML & RF \\
Date & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2023-10 & -9.3900 & -8.4100 & -7.9700 & -7.5300 & -6.4900 & -5.5100 &
-6.4000 & -6.3600 & -4.6000 & -2.2600 & -3.1900 & -3.8700 & 0.1900 &
0.4700 \\
2023-11 & 6.3000 & 9.0500 & 9.5800 & 9.6400 & 11.8700 & 9.6700 & 9.8400
& 9.6400 & 9.9900 & 9.2700 & 8.8400 & -0.0200 & 1.6400 & 0.4400 \\
2023-12 & 10.8700 & 17.2700 & 14.4800 & 14.2400 & 13.1200 & 12.0000 &
9.1600 & 9.6500 & 7.0000 & 5.5400 & 4.8700 & 6.3400 & 4.9300 & 0.4300 \\
2024-01 & -2.8200 & -5.4600 & -5.8600 & -4.9400 & -5.0700 & -3.1900 &
-2.3800 & -1.2600 & -1.7100 & 1.5900 & 0.7100 & -5.0900 & -2.3800 &
0.4700 \\
2024-02 & 5.5400 & 6.7100 & 4.8000 & 8.1900 & 3.4200 & 4.4400 & 6.3100 &
4.5400 & 5.7900 & 3.7100 & 5.0600 & -0.2400 & -3.4800 & 0.4200 \\
\end{longtable}

\subsubsection{\texorpdfstring{Estimate \(\alpha\)s for the ten
portfolios formed on
size}{Estimate \textbackslash alphas for the ten portfolios formed on size}}\label{estimate-alphas-for-the-ten-portfolios-formed-on-size}

Academics started researching size-based portfolios in the early 1980s,
so you may want to focus on the pre-1980 sample.

Let us estimate \(\alpha\) for the ``Lo 20'' (smallest 20\% of stocks by
market capitalization) first, step-by-step.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\OperatorTok{=}\NormalTok{ smf.ols(}
\NormalTok{    formula}\OperatorTok{=}\StringTok{\textquotesingle{}I(Q("Lo 10") {-} RF) \textasciitilde{} Q("Mkt{-}RF")\textquotesingle{}}\NormalTok{,}
\NormalTok{    data}\OperatorTok{=}\NormalTok{df\_me.loc[:}\StringTok{\textquotesingle{}1980\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\NormalTok{fit }\OperatorTok{=}\NormalTok{ mod.fit()}
\NormalTok{fit.summary()}
\end{Highlighting}
\end{Shaded}

\begin{center}
\begin{tabular}{lclc}
\toprule
\textbf{Dep. Variable:}    & I(Q("Lo 10") - RF) & \textbf{  R-squared:         } &     0.541   \\
\textbf{Model:}            &        OLS         & \textbf{  Adj. R-squared:    } &     0.540   \\
\textbf{Method:}           &   Least Squares    & \textbf{  F-statistic:       } &     767.6   \\
\textbf{Date:}             &  Fri, 05 Apr 2024  & \textbf{  Prob (F-statistic):} & 2.92e-112   \\
\textbf{Time:}             &      17:46:20      & \textbf{  Log-Likelihood:    } &   -2343.5   \\
\textbf{No. Observations:} &          654       & \textbf{  AIC:               } &     4691.   \\
\textbf{Df Residuals:}     &          652       & \textbf{  BIC:               } &     4700.   \\
\textbf{Df Model:}         &            1       & \textbf{                     } &             \\
\textbf{Covariance Type:}  &     nonrobust      & \textbf{                     } &             \\
\bottomrule
\end{tabular}
\begin{tabular}{lcccccc}
                     & \textbf{coef} & \textbf{std err} & \textbf{t} & \textbf{P$> |$t$|$} & \textbf{[0.025} & \textbf{0.975]}  \\
\midrule
\textbf{Intercept}   &       0.9161  &        0.343     &     2.669  &         0.008        &        0.242    &        1.590     \\
\textbf{Q("Mkt-RF")} &       1.5976  &        0.058     &    27.706  &         0.000        &        1.484    &        1.711     \\
\bottomrule
\end{tabular}
\begin{tabular}{lclc}
\textbf{Omnibus:}       & 626.765 & \textbf{  Durbin-Watson:     } &     1.970  \\
\textbf{Prob(Omnibus):} &   0.000 & \textbf{  Jarque-Bera (JB):  } & 28924.644  \\
\textbf{Skew:}          &   4.226 & \textbf{  Prob(JB):          } &      0.00  \\
\textbf{Kurtosis:}      &  34.464 & \textbf{  Cond. No.          } &      5.99  \\
\bottomrule
\end{tabular}
%\caption{OLS Regression Results}
\end{center}

Notes: \newline
 [1] Standard Errors assume that the covariance matrix of the errors is correctly specified.

Now, we can use list comprehensions to quickly estimate all ten
\(\alpha\)s.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ports }\OperatorTok{=}\NormalTok{ df\_me.columns.to\_list()[:}\DecValTok{10}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mods }\OperatorTok{=}\NormalTok{ [}
\NormalTok{    smf.ols(formula}\OperatorTok{=}\SpecialStringTok{f\textquotesingle{}I(Q("}\SpecialCharTok{\{}\NormalTok{p}\SpecialCharTok{\}}\SpecialStringTok{") {-} RF) \textasciitilde{} Q("Mkt{-}RF")\textquotesingle{}}\NormalTok{, data}\OperatorTok{=}\NormalTok{df\_me.loc[:}\StringTok{\textquotesingle{}1980\textquotesingle{}}\NormalTok{])}
    \ControlFlowTok{for}
\NormalTok{    p }\KeywordTok{in}\NormalTok{ ports}
\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fits }\OperatorTok{=}\NormalTok{ [m.fit() }\ControlFlowTok{for}\NormalTok{ m }\KeywordTok{in}\NormalTok{ mods]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{params }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat([f.params }\ControlFlowTok{for}\NormalTok{ f }\KeywordTok{in}\NormalTok{ fits], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{ports, names}\OperatorTok{=}\StringTok{\textquotesingle{}Portolio\textquotesingle{}}\NormalTok{)}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{bses }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat([f.bse }\ControlFlowTok{for}\NormalTok{ f }\KeywordTok{in}\NormalTok{ fits], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{ports, names}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{)}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start }\OperatorTok{=}\NormalTok{ df\_me.loc[:}\StringTok{\textquotesingle{}1980\textquotesingle{}}\NormalTok{].index[}\DecValTok{0}\NormalTok{].to\_timestamp()}
\NormalTok{stop }\OperatorTok{=}\NormalTok{ df\_me.loc[:}\StringTok{\textquotesingle{}1980\textquotesingle{}}\NormalTok{].index[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].to\_timestamp()}

\NormalTok{params[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{].plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{, yerr}\OperatorTok{=}\NormalTok{bses[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{])}

\NormalTok{plt.ylabel(}\VerbatimStringTok{r\textquotesingle{}Monthly CAPM $\textbackslash{}alpha$ (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xticks(rotation}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{plt.title(}
    \VerbatimStringTok{r\textquotesingle{}Size Portfolio Monthly CAPM $\textbackslash{}alpha$s\textquotesingle{}} \OperatorTok{+}
    \StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}} \OperatorTok{+}
    \SpecialStringTok{f\textquotesingle{}from }\SpecialCharTok{\{}\NormalTok{start}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ through }\SpecialCharTok{\{}\NormalTok{stop}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_02_files/figure-pdf/cell-36-output-1.png}

\subsubsection{Are the returns on these ten portfolios formed on size
concentrated in a specific
month?}\label{are-the-returns-on-these-ten-portfolios-formed-on-size-concentrated-in-a-specific-month}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_me\_2 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_me[}\DecValTok{0}\NormalTok{]}
\NormalTok{    .iloc[:, }\OperatorTok{{-}}\DecValTok{10}\NormalTok{:]}
\NormalTok{    .stack()}
\NormalTok{    .rename\_axis(index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{])}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{)}
\NormalTok{    .reset\_index()}
\NormalTok{    .assign(Month}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.where(x[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{].dt.month}\OperatorTok{==}\DecValTok{1}\NormalTok{, }\StringTok{\textquotesingle{}January\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Not January\textquotesingle{}}\NormalTok{))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.barplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{df\_me\_2,}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Month\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{,}
\NormalTok{    hue}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Mean Monthly Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}When Do We Earn Size{-}Effect Returns?\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_02_files/figure-pdf/cell-38-output-1.png}

\subsubsection{Compare the size factor to the market
factor}\label{compare-the-size-factor-to-the-market-factor}

You may want to consider mean excess returns by decade. The market and
size excess returns are factors \texttt{Mkt-RF} and \texttt{SMB} in the
Fama-French factors data.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_me\_3 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_m[}\DecValTok{0}\NormalTok{]}
\NormalTok{    [[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}SMB\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .stack()}
\NormalTok{    .rename\_axis(index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Factor\textquotesingle{}}\NormalTok{])}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{)}
\NormalTok{    .reset\_index()}
\NormalTok{    .assign(Decade}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: (x[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{].dt.year }\OperatorTok{//} \DecValTok{10}\NormalTok{ ) }\OperatorTok{*} \DecValTok{10}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.barplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{df\_me\_3,}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Decade\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{,}
\NormalTok{    hue}\OperatorTok{=}\StringTok{\textquotesingle{}Factor\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Monthly Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Comparison on Market and Small Stock Risk Premia\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_02_files/figure-pdf/cell-40-output-1.png}

SMB rarely generates outsize returns later in the sample.

\subsection{Repeat the exercises above with the value
factor}\label{repeat-the-exercises-above-with-the-value-factor}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_be\_me }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolios\_Formed\_on\_BE{-}ME\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(ff\_me[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Portfolios Formed on ME
-----------------------

This file was created by CMPT_ME_RETS using the 202402 CRSP database. It contains value- and equal-weighted returns for size portfolios. Each record contains returns for: Negative (not used) 30% 40% 30%   5 Quintiles  10 Deciles The portfolios are constructed at the end of Jun. The annual returns are from January to December. Missing data are indicated by -99.99 or -999. Copyright 2024 Kenneth R. French

  0 : Value Weight Returns -- Monthly (1172 rows x 19 cols)
  1 : Equal Weight Returns -- Monthly (1172 rows x 19 cols)
  2 : Value Weight Returns -- Annual from January to December (97 rows x 19 cols)
  3 : Equal Weight Returns -- Annual from January to December (97 rows x 19 cols)
  4 : Number of Firms in Portfolios (1172 rows x 19 cols)
  5 : Average Firm Size (1172 rows x 19 cols)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_be\_me }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_be\_me[}\DecValTok{1}\NormalTok{]}
\NormalTok{    .iloc[:, }\OperatorTok{{-}}\DecValTok{10}\NormalTok{:]}
\NormalTok{    .join(ff\_m[}\DecValTok{0}\NormalTok{])}
\NormalTok{)}

\NormalTok{df\_be\_me.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllllll@{}}
\toprule\noalign{}
& Lo 10 & Dec 2 & Dec 3 & Dec 4 & Dec 5 & Dec 6 & Dec 7 & Dec 8 & Dec 9
& Hi 10 & Mkt-RF & SMB & HML & RF \\
Date & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2023-10 & -7.6200 & -6.5300 & -8.4300 & -7.7500 & -7.0200 & -7.0800 &
-6.1800 & -7.0600 & -7.6800 & -8.4300 & -3.1900 & -3.8700 & 0.1900 &
0.4700 \\
2023-11 & 9.8800 & 9.8900 & 8.5700 & 7.1800 & 11.5300 & 13.6400 & 8.7100
& 10.5800 & 6.4300 & 6.6500 & 8.8400 & -0.0200 & 1.6400 & 0.4400 \\
2023-12 & 9.8700 & 9.2100 & 15.0800 & 11.0000 & 9.7200 & 11.9100 &
14.2700 & 14.1400 & 13.9600 & 13.2000 & 4.8700 & 6.3400 & 4.9300 &
0.4300 \\
2024-01 & -4.0000 & -1.3500 & -3.4800 & -3.2100 & -4.5000 & -3.5100 &
-3.3800 & -4.4200 & -3.6400 & -0.4200 & 0.7100 & -5.0900 & -2.3800 &
0.4700 \\
2024-02 & 6.1900 & 7.6000 & 7.2500 & 5.2900 & 7.5200 & 7.6200 & 3.3800 &
3.3400 & 1.7400 & 7.2900 & 5.0600 & -0.2400 & -3.4800 & 0.4200 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ports }\OperatorTok{=}\NormalTok{ df\_be\_me.columns.to\_list()[:}\DecValTok{10}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mods }\OperatorTok{=}\NormalTok{ [}
\NormalTok{    smf.ols(formula}\OperatorTok{=}\SpecialStringTok{f\textquotesingle{}I(Q("}\SpecialCharTok{\{}\NormalTok{p}\SpecialCharTok{\}}\SpecialStringTok{") {-} RF) \textasciitilde{} Q("Mkt{-}RF")\textquotesingle{}}\NormalTok{, data}\OperatorTok{=}\NormalTok{df\_be\_me)}
    \ControlFlowTok{for}
\NormalTok{    p }\KeywordTok{in}\NormalTok{ ports}
\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fits }\OperatorTok{=}\NormalTok{ [m.fit() }\ControlFlowTok{for}\NormalTok{ m }\KeywordTok{in}\NormalTok{ mods]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{params }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat([f.params }\ControlFlowTok{for}\NormalTok{ f }\KeywordTok{in}\NormalTok{ fits], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{ports, names}\OperatorTok{=}\StringTok{\textquotesingle{}Portolio\textquotesingle{}}\NormalTok{)}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{bses }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat([f.bse }\ControlFlowTok{for}\NormalTok{ f }\KeywordTok{in}\NormalTok{ fits], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{ports, names}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{)}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start }\OperatorTok{=}\NormalTok{ df\_be\_me.index[}\DecValTok{0}\NormalTok{].to\_timestamp()}
\NormalTok{stop }\OperatorTok{=}\NormalTok{ df\_be\_me.index[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].to\_timestamp()}

\NormalTok{params[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{].plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{, yerr}\OperatorTok{=}\NormalTok{bses[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{])}

\NormalTok{plt.ylabel(}\VerbatimStringTok{r\textquotesingle{}Monthly CAPM $\textbackslash{}alpha$ (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xticks(rotation}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{plt.title(}
    \VerbatimStringTok{r\textquotesingle{}BE/ME Portfolio Monthly CAPM $\textbackslash{}alpha$s\textquotesingle{}} \OperatorTok{+}
    \StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}} \OperatorTok{+}
    \SpecialStringTok{f\textquotesingle{}from }\SpecialCharTok{\{}\NormalTok{start}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ through }\SpecialCharTok{\{}\NormalTok{stop}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_02_files/figure-pdf/cell-49-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_be\_me\_3 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_m[}\DecValTok{0}\NormalTok{]}
\NormalTok{    [[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}HML\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .stack()}
\NormalTok{    .rename\_axis(index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Factor\textquotesingle{}}\NormalTok{])}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{)}
\NormalTok{    .reset\_index()}
\NormalTok{    .assign(Decade}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: (x[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{].dt.year }\OperatorTok{//} \DecValTok{10}\NormalTok{ ) }\OperatorTok{*} \DecValTok{10}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.barplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{df\_be\_me\_3,}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Decade\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{,}
\NormalTok{    hue}\OperatorTok{=}\StringTok{\textquotesingle{}Factor\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Monthly Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Comparison on Market and Value Stock Risk Premia\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_02_files/figure-pdf/cell-51-output-1.png}

\subsection{Repeat the exercises above with the momentum
factor}\label{repeat-the-exercises-above-with-the-momentum-factor}

You may find it helpful to consider the worst months and years for the
momentum factor.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_mom }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}10\_Portfolios\_Prior\_12\_2\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\2097656781.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\2097656781.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\2097656781.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\2097656781.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\2097656781.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\2097656781.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\2097656781.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(ff\_mom[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
10 Portfolios Prior 12 2
------------------------

This file was created by CMPT_PRIOR_RETS using the 202402 CRSP database. It contains value- and equal-weighted returns for 10 prior-return portfolios. The portfolios are constructed monthly. PRIOR_RET is from -12 to - 2. The annual returns are from January to December. Missing data are indicated by -99.99 or -999.

  0 : Average Value Weighted Returns -- Monthly (1166 rows x 10 cols)
  1 : Average Equal Weighted Returns -- Monthly (1166 rows x 10 cols)
  2 : Average Value Weighted Returns -- Annual (97 rows x 10 cols)
  3 : Average Equal Weighted Returns -- Annual (97 rows x 10 cols)
  4 : Number of Firms in Portfolios (1166 rows x 10 cols)
  5 : Average Firm Size (1166 rows x 10 cols)
  6 : Value-Weighted Average of Prior Returns (97 rows x 10 cols)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_mom }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_mom[}\DecValTok{1}\NormalTok{]}
\NormalTok{    .iloc[:, }\OperatorTok{{-}}\DecValTok{10}\NormalTok{:]}
\NormalTok{    .join(ff\_m[}\DecValTok{0}\NormalTok{])}
\NormalTok{)}

\NormalTok{df\_mom.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllllll@{}}
\toprule\noalign{}
& Lo PRIOR & PRIOR 2 & PRIOR 3 & PRIOR 4 & PRIOR 5 & PRIOR 6 & PRIOR 7 &
PRIOR 8 & PRIOR 9 & Hi PRIOR & Mkt-RF & SMB & HML & RF \\
Date & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2023-10 & -11.8200 & -8.0400 & -5.4700 & -4.4900 & -5.6900 & -4.9900 &
-4.7800 & -6.1700 & -6.4800 & -8.7700 & -3.1900 & -3.8700 & 0.1900 &
0.4700 \\
2023-11 & 7.8000 & 8.7100 & 7.1900 & 8.1500 & 7.7400 & 5.3800 & 8.0100 &
9.9700 & 10.4500 & 12.3300 & 8.8400 & -0.0200 & 1.6400 & 0.4400 \\
2023-12 & 14.9500 & 13.2800 & 14.0100 & 11.9000 & 10.5300 & 9.3300 &
6.5900 & 6.7600 & 8.4100 & 13.2100 & 4.8700 & 6.3400 & 4.9300 &
0.4300 \\
2024-01 & -6.8900 & -5.0200 & -3.9900 & -2.2500 & -2.3300 & -2.4100 &
-0.9400 & 0.0400 & -0.3900 & -0.6600 & 0.7100 & -5.0900 & -2.3800 &
0.4700 \\
2024-02 & 8.2200 & 3.9100 & 2.6200 & 2.4500 & 2.0900 & 3.8600 & 4.3500 &
5.4000 & 6.0200 & 10.5000 & 5.0600 & -0.2400 & -3.4800 & 0.4200 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ports }\OperatorTok{=}\NormalTok{ df\_mom.columns.to\_list()[:}\DecValTok{10}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mods }\OperatorTok{=}\NormalTok{ [}
\NormalTok{    smf.ols(formula}\OperatorTok{=}\SpecialStringTok{f\textquotesingle{}I(Q("}\SpecialCharTok{\{}\NormalTok{p}\SpecialCharTok{\}}\SpecialStringTok{") {-} RF) \textasciitilde{} Q("Mkt{-}RF")\textquotesingle{}}\NormalTok{, data}\OperatorTok{=}\NormalTok{df\_mom.loc[:}\StringTok{\textquotesingle{}1980\textquotesingle{}}\NormalTok{])}
    \ControlFlowTok{for}
\NormalTok{    p }\KeywordTok{in}\NormalTok{ ports}
\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fits }\OperatorTok{=}\NormalTok{ [m.fit() }\ControlFlowTok{for}\NormalTok{ m }\KeywordTok{in}\NormalTok{ mods]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{params }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat([f.params }\ControlFlowTok{for}\NormalTok{ f }\KeywordTok{in}\NormalTok{ fits], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{ports, names}\OperatorTok{=}\StringTok{\textquotesingle{}Portolio\textquotesingle{}}\NormalTok{)}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{bses }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat([f.bse }\ControlFlowTok{for}\NormalTok{ f }\KeywordTok{in}\NormalTok{ fits], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{ports, names}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{)}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start }\OperatorTok{=}\NormalTok{ df\_mom.loc[:}\StringTok{\textquotesingle{}1980\textquotesingle{}}\NormalTok{].index[}\DecValTok{0}\NormalTok{].to\_timestamp()}
\NormalTok{stop }\OperatorTok{=}\NormalTok{ df\_mom.loc[:}\StringTok{\textquotesingle{}1980\textquotesingle{}}\NormalTok{].index[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].to\_timestamp()}

\NormalTok{params[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{].plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{, yerr}\OperatorTok{=}\NormalTok{bses[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{])}

\NormalTok{plt.ylabel(}\VerbatimStringTok{r\textquotesingle{}Monthly CAPM $\textbackslash{}alpha$ (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}
    \VerbatimStringTok{r\textquotesingle{}Momentum Portfolio Monthly CAPM $\textbackslash{}alpha$s\textquotesingle{}} \OperatorTok{+}
    \StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}} \OperatorTok{+}
    \SpecialStringTok{f\textquotesingle{}from }\SpecialCharTok{\{}\NormalTok{start}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ through }\SpecialCharTok{\{}\NormalTok{stop}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_02_files/figure-pdf/cell-60-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_mom }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Momentum\_Factor\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}

\NormalTok{ff\_mom[}\DecValTok{0}\NormalTok{].columns }\OperatorTok{=}\NormalTok{ [c.strip() }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ ff\_mom[}\DecValTok{0}\NormalTok{].columns]}
\NormalTok{ff\_mom[}\DecValTok{0}\NormalTok{].tail()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\1313848978.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\1313848978.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
\end{verbatim}

\begin{longtable}[]{@{}ll@{}}
\toprule\noalign{}
& Mom \\
Date & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2023-10 & 1.7300 \\
2023-11 & 2.7500 \\
2023-12 & -5.5100 \\
2024-01 & 5.1800 \\
2024-02 & 4.9200 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_mom\_3 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_m[}\DecValTok{0}\NormalTok{].join(ff\_mom[}\DecValTok{0}\NormalTok{])}
\NormalTok{    [[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Mom\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .stack()}
\NormalTok{    .rename\_axis(index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Factor\textquotesingle{}}\NormalTok{])}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{)}
\NormalTok{    .reset\_index()}
\NormalTok{    .assign(Decade}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: (x[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{].dt.year }\OperatorTok{//} \DecValTok{10}\NormalTok{ ) }\OperatorTok{*} \DecValTok{10}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.barplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{df\_mom\_3,}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Decade\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{,}
\NormalTok{    hue}\OperatorTok{=}\StringTok{\textquotesingle{}Factor\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Monthly Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Comparison on Market and Value Stock Risk Premia\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_02_files/figure-pdf/cell-63-output-1.png}

\subsection{Plot the coefficient estimates from a rolling Fama-French
three-factor model for Berkshire
Hathaway}\label{plot-the-coefficient-estimates-from-a-rolling-fama-french-three-factor-model-for-berkshire-hathaway}

Use a three-year window with daily returns. How has Buffett's \(\alpha\)
and \(\beta\)s changed over the past four decades?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{brk }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}BRK{-}A\textquotesingle{}}\NormalTok{)}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{])}
\NormalTok{    .assign(r}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].pct\_change().mul(}\DecValTok{100}\NormalTok{))}
\NormalTok{    .dropna()}
\NormalTok{    .join(}
\NormalTok{        pdr.DataReader(}
\NormalTok{            name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{            data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{            start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{        )[}\DecValTok{0}\NormalTok{],}
\NormalTok{        how}\OperatorTok{=}\StringTok{\textquotesingle{}inner\textquotesingle{}}
\NormalTok{    )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  1 of 1 completed
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24696\2930704642.py:8: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{from}\NormalTok{ statsmodels.regression.rolling }\ImportTok{import}\NormalTok{ RollingOLS}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{coefs }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    RollingOLS.from\_formula(}
\NormalTok{        formula}\OperatorTok{=}\StringTok{\textquotesingle{}I(r{-}RF) \textasciitilde{} Q("Mkt{-}RF") + SMB + HML\textquotesingle{}}\NormalTok{,}
\NormalTok{        data}\OperatorTok{=}\NormalTok{brk,}
\NormalTok{        window}\OperatorTok{=}\DecValTok{3}\OperatorTok{*}\DecValTok{252}
\NormalTok{    )}
\NormalTok{    .fit()}
\NormalTok{    .params}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Coefficient\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}Q("Mkt{-}RF")\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{\})}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fig, ax }\OperatorTok{=}\NormalTok{ plt.subplots(}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, sharex}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{coefs[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{].plot(ax}\OperatorTok{=}\NormalTok{ax[}\DecValTok{0}\NormalTok{], legend}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{coefs.drop(}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{, axis}\OperatorTok{=}\DecValTok{1}\NormalTok{).plot(ax}\OperatorTok{=}\NormalTok{ax[}\DecValTok{1}\NormalTok{])}
\NormalTok{plt.suptitle(}
    \StringTok{\textquotesingle{}Rolling Three{-}Factor Regressions\textquotesingle{}} \OperatorTok{+}
    \StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n}\StringTok{Three{-}Year Windows with Daily Returns in Percent\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_02_files/figure-pdf/cell-67-output-1.png}

Buffett's \(\alpha\) was large, but has declined to zero. Also, his
loading on SMB (size factor) has gone from positive to negative,
indicating that he has moved from small stocks to large stocks as
Berkshire Hathaway has grown.

\chapter{Herron Topic 3 - Practice for Section
03}\label{herron-topic-3---practice-for-section-03}

\section{Announcements}\label{announcements-37}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  We will make a few changes to give us more time to work on Project 3:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    We will drop Herron Topic 5 on simulations during Week 14 and use
    this time for group work
  \item
    I will finalize Project 3 by Thursday, 4/4, so we have about 3 week
    to work on it before the Tuesday, 4/23, due date
  \end{enumerate}
\item
  \textbf{\emph{Next Thursday and Friday, 4/11 and 4/12, we will take
  the MSFQ assessment exam in class. I do not control this exam, and
  there are a few conditions:}}

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    \textbf{\emph{Open book}}
  \item
    \textbf{\emph{On Canvas}}
  \item
    \textbf{\emph{In the classroom}}
  \end{enumerate}
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-36}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The Capital Asset Pricing Model (CAPM) estimates asset \(i\)'s
  expected return as \(E(r_i) = r_f + \beta_i [E(r_M) - r_f]\), where:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    \(r_f\) is the risk-free rate
  \item
    \(\beta_i\) is asset \(i\)'s systematic risk
  \item
    \(E(r_M) - r_f\) is the market risk premium
  \end{enumerate}
\item
  The Security Market Line (SML) visualizes the CAPM

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Plots \(E(r_i)\) on the y axis against \(\beta_i\) on the x axis
  \item
    The slope of the SML is the market risk premium \(E(r_M) - r_f\)
  \item
    The intercept of the SML is the risk-free rate \(r_f\)
  \end{enumerate}
\item
  We can estimate asset \(i\)'s systematic risk a few ways:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    \(\beta_i = \frac{Cov(r_i-r_f, r_M-r_f)}{Var(r_M-r_f)}\)
  \item
    \(\beta_i = Corr(r_i-r_f, r_M-r_f) \frac{Std(r_i-r_f)}{Std(r_M-r_f)}\)
  \item
    Estimate the linear regression
    \(r_i - r_f = \alpha_i + \beta_i [r_M - r_f] + \varepsilon_i\) with
    the \texttt{smf.ols()} function after we
    \texttt{import\ statsmodels.formula.api\ as\ smf}
  \item
    We will follow Bodie, Kane, and Marcus's syntax where a \(r\) is a
    raw return and a \(R\) is an excess return, so \(R_i = r_i - r_f\)
  \end{enumerate}
\item
  The CAPM is the foundation of modern finance and does well for single
  periods but has a few shortcomings:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Does poorly over multiple periods
  \item
    The SML is ``too flat'' empirically, and high \(\beta\) assets tend
    to have lower returns than expected
  \item
    Does explain the returns on several factors, like size, value, and
    momentum
  \end{enumerate}
\item
  The Fama-French 3-factor model---and many others---attempts to solves
  these shortcomings and is useful for evaluating fund manager
  performance
\end{enumerate}

\section{Practice}\label{practice-37}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ seaborn }\ImportTok{as}\NormalTok{ sns}
\ImportTok{import}\NormalTok{ statsmodels.formula.api }\ImportTok{as}\NormalTok{ smf}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{Plot the security market line (SML) for a variety of asset
classes}\label{plot-the-security-market-line-sml-for-a-variety-of-asset-classes-1}

Use the past three years of daily data for the following exhange traded
funds (ETFs):

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  SPY (SPDR---Standard and Poor's Depository Receipts---ETF for the S\&P
  500 index)
\item
  BIL (SPDR ETF for 1-3 month Treasury bills)
\item
  GLD (SPDR ETF for gold)
\item
  JNK (SPDR ETF for high-yield debt)
\item
  MDY (SPDR ETF for S\&P 400 mid-cap index)
\item
  SLY (SPDR ETF for S\&P 600 small-cap index)
\item
  SPBO (SPDR ETF for corporate bonds)
\item
  SPMB (SPDR ETF for mortgage-backed securities)
\item
  SPTL (SPDR ETF for long-term Treasury bonds)
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tickers }\OperatorTok{=} \StringTok{\textquotesingle{}SPY BIL GLD JNK MDY SLY SPBO SPMB SPTL\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

For multifactor models, we generally leave returns in percents. Slope
coefficient estimates (i.e., \(\beta\)s) are the same for decimal and
percent returns. Intercept coefficient estimates (i.e., \(\alpha\)s) are
easier to interpret in percents than in decimals because small percent
returns have two fewer zeros than small decimal returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{etf }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\NormalTok{tickers)}
\NormalTok{    [}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    .pct\_change()}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{)}

\NormalTok{etf.head()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  9 of 9 completed
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\2517263847.py:5: FutureWarning: The default fill_method='pad' in DataFrame.pct_change is deprecated and will be removed in a future version. Either fill in any non-leading NA values prior to calling pct_change or specify 'fill_method=None' to not fill NA values.
  .pct_change()
\end{verbatim}

\begin{longtable}[]{@{}llllllllll@{}}
\toprule\noalign{}
& BIL & GLD & JNK & MDY & SLY & SPBO & SPMB & SPTL & SPY \\
Date & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1993-01-29 & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN \\
1993-02-01 & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & 0.7112 \\
1993-02-02 & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & 0.2119 \\
1993-02-03 & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & 1.0571 \\
1993-02-04 & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & 0.4184 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pdr.DataReader(}
\NormalTok{        name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{        data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{        start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{    )}
\NormalTok{    [}\DecValTok{0}\NormalTok{]}
\NormalTok{)}

\NormalTok{ff.tail()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\3487692931.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& Mkt-RF & SMB & HML & RF \\
Date & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-02-23 & 0.0200 & 0.2800 & -0.0300 & 0.0210 \\
2024-02-26 & -0.2600 & 1.0000 & -0.1100 & 0.0210 \\
2024-02-27 & 0.2700 & 1.1900 & -0.4500 & 0.0210 \\
2024-02-28 & -0.2600 & -0.8500 & 0.0000 & 0.0210 \\
2024-02-29 & 0.5400 & -0.3400 & 0.9800 & 0.0210 \\
\end{longtable}

We will write two helper functions to make it easier to calculate
annualized mean returns and CAPM betas. We will pass these function
names to the pandas \texttt{.agg()} method, which applies these
functions to every column and combines the results.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_ann\_mean(ri, ann\_fac}\OperatorTok{=}\DecValTok{252}\NormalTok{):}
    \ControlFlowTok{return}\NormalTok{ ri.mean() }\OperatorTok{*}\NormalTok{ ann\_fac}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{etf.}\BuiltInTok{apply}\NormalTok{(calc\_ann\_mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
BIL     0.9715
GLD     9.6202
JNK     5.2090
MDY    12.9373
SLY     9.4062
SPBO    3.3207
SPMB    2.1316
SPTL    4.4217
SPY    11.4856
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_beta(ri, rf}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], RM}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{]):}
    \CommentTok{\# betai = Cov(Ri, RM) / Var(RM)}
\NormalTok{    Ri }\OperatorTok{=}\NormalTok{ ri.sub(rf).dropna() }\CommentTok{\# Ri is excess returns for asset i}
    \ControlFlowTok{return}\NormalTok{ Ri.cov(RM) }\OperatorTok{/}\NormalTok{ RM.loc[Ri.index].var() }\CommentTok{\# we use .loc[] to slice RM to the same dates as Ri}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{etf.}\BuiltInTok{apply}\NormalTok{(calc\_beta)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
BIL    -0.0030
GLD     0.0475
JNK     0.3547
MDY     1.0540
SLY     1.0626
SPBO    0.0468
SPMB    0.0522
SPTL   -0.2212
SPY     0.9819
dtype: float64
\end{verbatim}

We should estimate CAPM betas from one-year to three-years of daily
returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{etf\_sml }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    etf}
\NormalTok{    .loc[}\StringTok{\textquotesingle{}2021{-}02\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2024{-}01\textquotesingle{}}\NormalTok{]}
\NormalTok{    .agg([calc\_ann\_mean, calc\_beta])}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The \texttt{regplot()} function in the seaborn package plots a
scatterplot and adds a best-fit line with 95\% confidence interval.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.regplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{etf\_sml,}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}calc\_beta\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}calc\_ann\_mean\textquotesingle{}}
\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ t, (x, y) }\KeywordTok{in}\NormalTok{ etf\_sml[[}\StringTok{\textquotesingle{}calc\_beta\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}calc\_ann\_mean\textquotesingle{}}\NormalTok{]].iterrows():}
\NormalTok{    plt.annotate(text}\OperatorTok{=}\NormalTok{t, xy}\OperatorTok{=}\NormalTok{(x, y))}


\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\VerbatimStringTok{r\textquotesingle{}Capital Asset Pricing Model (CAPM) $\textbackslash{}beta$\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}
    \StringTok{\textquotesingle{}Security Market Line (SML) from Exchange Traded Funds (ETFs)}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}} \OperatorTok{+}
    \StringTok{\textquotesingle{}Daily Returns from 2021{-}02 to 2024{-}01\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_03_files/figure-pdf/cell-12-output-1.png}

\textbf{\emph{We see the CAPM and SML work well for asset classes!}} The
slope is positive, the intercept is a reasonable risk-free rate, and
assets plot along the SML, most within the 95\% confidence interval.
Note that a few fixed-income ETFs have negative mean returns, but the
SML still has the shape and fit we expect by theory.

The fit above is not perfect, but the \(R^2\) is fairly high at around
50\%. For a single-factor regression, we can quickly calculate \(R^2\)
as \(\rho^2\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{etf\_sml.corr().loc[}\StringTok{\textquotesingle{}calc\_ann\_mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}calc\_beta\textquotesingle{}}\NormalTok{]}\OperatorTok{**}\DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.5086
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{smf.ols(formula}\OperatorTok{=}\StringTok{\textquotesingle{}calc\_ann\_mean \textasciitilde{} calc\_beta\textquotesingle{}}\NormalTok{, data}\OperatorTok{=}\NormalTok{etf\_sml).fit().rsquared}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.5086
\end{verbatim}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

The \texttt{.iterrows()} method helps us loop over the rows in a data
frame without creating a loop counter. Here is an example, similar to
our use above.

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ t, (x, y) }\KeywordTok{in}\NormalTok{ etf\_sml[[}\StringTok{\textquotesingle{}calc\_beta\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}calc\_ann\_mean\textquotesingle{}}\NormalTok{]].iterrows():}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}Ticker is }\SpecialCharTok{\{}\NormalTok{t}\SpecialCharTok{\}}\SpecialStringTok{, x value is }\SpecialCharTok{\{}\NormalTok{x}\SpecialCharTok{:0.4f\}}\SpecialStringTok{, and y value is }\SpecialCharTok{\{}\NormalTok{y}\SpecialCharTok{:0.4f\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Ticker is BIL, x value is -0.0001, and y value is 2.1863
Ticker is GLD, x value is 0.1067, and y value is 3.8930
Ticker is JNK, x value is 0.3695, and y value is 1.4790
Ticker is MDY, x value is 1.0264, and y value is 8.5285
Ticker is SLY, x value is 0.9169, and y value is 2.4724
Ticker is SPBO, x value is 0.1631, and y value is -2.5430
Ticker is SPMB, x value is 0.0955, and y value is -2.9811
Ticker is SPTL, x value is 0.0566, and y value is -10.3214
Ticker is SPY, x value is 0.9427, and y value is 11.8932
\end{verbatim}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\subsection{Plot the SML for the Dow Jones Industrial Average (DJIA)
stocks}\label{plot-the-sml-for-the-dow-jones-industrial-average-djia-stocks-1}

Use the past three years of daily returns data for the stocks listed on
the
\href{https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average}{DJIA
Wikipedia page}. Compare the DJIA SML to the asset class SML above.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tickers }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.read\_html(}\StringTok{\textquotesingle{}https://en.wikipedia.org/wiki/Dow\_Jones\_Industrial\_Average\textquotesingle{}}\NormalTok{)}
\NormalTok{    [}\DecValTok{1}\NormalTok{]}
\NormalTok{    [}\StringTok{\textquotesingle{}Symbol\textquotesingle{}}\NormalTok{]}
\NormalTok{    .to\_list()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{djia }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\NormalTok{tickers)}
\NormalTok{    [}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    .pct\_change()}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{)}

\NormalTok{djia.head()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  30 of 30 completed
\end{verbatim}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
& AAPL & AMGN & AMZN & AXP & BA & CAT & CRM & CSCO & CVX & DIS & ... &
MMM & MRK & MSFT & NKE & PG & TRV & UNH & V & VZ & WMT \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
1962-01-02 & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN &
... & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN & NaN \\
1962-01-03 & NaN & NaN & NaN & NaN & 2.0000 & 0.9740 & NaN & NaN &
-0.2257 & 1.3421 & ... & 0.7518 & -4.1899 & NaN & NaN & -1.0929 & NaN &
NaN & NaN & NaN & NaN \\
1962-01-04 & NaN & NaN & NaN & NaN & -0.9804 & 2.5723 & NaN & NaN &
-0.9049 & 0.0000 & ... & 0.0000 & -1.0204 & NaN & NaN & -1.6576 & NaN &
NaN & NaN & NaN & NaN \\
1962-01-05 & NaN & NaN & NaN & NaN & -1.9802 & 0.9404 & NaN & NaN &
-2.5115 & 0.3314 & ... & -2.6118 & -3.3874 & NaN & NaN & -0.7022 & NaN &
NaN & NaN & NaN & NaN \\
1962-01-08 & NaN & NaN & NaN & NaN & 0.2525 & 0.6211 & NaN & NaN &
-0.4684 & -0.3303 & ... & -0.5748 & 0.3047 & NaN & NaN & -2.6875 & NaN &
NaN & NaN & NaN & NaN \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{djia\_sml }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    djia}
\NormalTok{    .loc[}\StringTok{\textquotesingle{}2021{-}02\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2024{-}01\textquotesingle{}}\NormalTok{]}
\NormalTok{    .agg([calc\_ann\_mean, calc\_beta])}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.regplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{djia\_sml,}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}calc\_beta\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}calc\_ann\_mean\textquotesingle{}}
\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ t, (x, y) }\KeywordTok{in}\NormalTok{ djia\_sml[[}\StringTok{\textquotesingle{}calc\_beta\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}calc\_ann\_mean\textquotesingle{}}\NormalTok{]].iterrows():}
\NormalTok{    plt.annotate(text}\OperatorTok{=}\NormalTok{t, xy}\OperatorTok{=}\NormalTok{(x, y))}
    
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\VerbatimStringTok{r\textquotesingle{}Capital Asset Pricing Model (CAPM) $\textbackslash{}beta$\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}
    \StringTok{\textquotesingle{}Security Market Line (SML) from Dow{-}Jones Stocks}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}} \OperatorTok{+}
    \StringTok{\textquotesingle{}Daily Returns from 2021{-}02 to 2024{-}01\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_03_files/figure-pdf/cell-19-output-1.png}

For single stocks the SML falls apart!

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The slope is negative and we would fail to reject it is flat
\item
  The intercept is above the risk-free rate
\item
  Many stocks plot outside the 95\% confidence interval
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{djia\_sml.corr().loc[}\StringTok{\textquotesingle{}calc\_ann\_mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}calc\_beta\textquotesingle{}}\NormalTok{]}\OperatorTok{**}\DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.0178
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{smf.ols(formula}\OperatorTok{=}\StringTok{\textquotesingle{}calc\_ann\_mean \textasciitilde{} calc\_beta\textquotesingle{}}\NormalTok{, data}\OperatorTok{=}\NormalTok{djia\_sml).fit().rsquared}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.0178
\end{verbatim}

\subsection{Plot the SML for the five portfolios formed on
beta}\label{plot-the-sml-for-the-five-portfolios-formed-on-beta-1}

Download data for portfolios formed on \(\beta\)
(\texttt{Portfolios\_Formed\_on\_BETA}) from Ken French. For the
value-weighted portfolios, plot realized returns versus \(\beta\). These
data should elements \texttt{{[}2{]}} and \texttt{{[}6{]}},
respectively.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_beta }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolios\_Formed\_on\_BETA\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(ff\_beta[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Portfolios Formed on BETA
-------------------------

This file was created by CMPT_BETA_RETS using the 202402 CRSP database. It contains value- and equal-weighted returns for portfolios formed on BETA. The portfolios are constructed at the end of June. Beta is estimated using monthly returns for the past 60 months (requiring at least 24 months with non-missing returns). Beta is estimated using the Scholes-Williams method. Annual returns are from January to December. Missing data are indicated by -99.99 or -999. The break points include utilities and include financials. The portfolios include utilities and include financials. Copyright 2024 Kenneth R. French

  0 : Value Weighted Returns -- Monthly (728 rows x 15 cols)
  1 : Equal Weighted Returns -- Monthly (728 rows x 15 cols)
  2 : Value Weighted Returns -- Annual from January to December (60 rows x 15 cols)
  3 : Equal Weighted Returns -- Annual from January to December (60 rows x 15 cols)
  4 : Number of Firms in Portfolios (728 rows x 15 cols)
  5 : Average Firm Size (728 rows x 15 cols)
  6 : Value-Weighted Average of Prior Beta (61 rows x 15 cols)
\end{verbatim}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\2406176535.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_beta = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\2406176535.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_beta = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\2406176535.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_beta = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\2406176535.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_beta = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\2406176535.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_beta = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\2406176535.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_beta = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\2406176535.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_beta = pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_beta[}\DecValTok{2}\NormalTok{].tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllll@{}}
\toprule\noalign{}
& Lo 20 & Qnt 2 & Qnt 3 & Qnt 4 & Hi 20 & Lo 10 & Dec 2 & Dec 3 & Dec 4
& Dec 5 & Dec 6 & Dec 7 & Dec 8 & Dec 9 & Hi 10 \\
Date & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2019 & 27.1700 & 29.7200 & 30.1300 & 37.7300 & 31.6700 & 27.8100 &
26.5400 & 28.8400 & 30.7600 & 30.0200 & 30.2900 & 33.0000 & 41.3000 &
28.7000 & 41.1800 \\
2020 & 5.2800 & 12.3500 & 45.0300 & 41.5800 & 45.3000 & 2.9800 & 7.1300
& 12.4400 & 12.6900 & 38.0200 & 45.4700 & 13.9200 & 61.3100 & 23.5400 &
87.7700 \\
2021 & 18.5600 & 28.8500 & 13.8500 & 48.5000 & 26.7600 & 18.1400 &
19.3500 & 26.8400 & 31.5400 & 20.1300 & 9.4100 & 54.1100 & 29.8300 &
40.4500 & -2.0900 \\
2022 & -7.2500 & -20.8600 & -14.8000 & -24.5900 & -39.7300 & -0.6100 &
-10.9100 & -9.2800 & -29.0900 & -8.6400 & -21.0600 & -24.3400 & -20.7500
& -29.0300 & -50.7600 \\
2023 & 2.3000 & 27.9500 & 26.2600 & 44.3900 & 74.7900 & 3.8800 & 0.9900
& 14.1500 & 36.4700 & 28.8700 & 24.4100 & 41.0000 & 46.7500 & 85.9800 &
59.7000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_beta[}\DecValTok{6}\NormalTok{].tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllll@{}}
\toprule\noalign{}
& Lo 20 & Qnt 2 & Qnt 3 & Qnt 4 & Hi 20 & Lo 10 & Dec 2 & Dec 3 & Dec 4
& Dec 5 & Dec 6 & Dec 7 & Dec 8 & Dec 9 & Hi 10 \\
Date & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2019 & 0.2410 & 0.7710 & 1.1210 & 1.5020 & 2.2040 & -0.0220 & 0.4350 &
0.6920 & 0.8520 & 1.0570 & 1.1920 & 1.3870 & 1.5870 & 1.8800 & 2.8550 \\
2020 & 0.4320 & 0.9340 & 1.3400 & 1.6880 & 2.4090 & 0.2190 & 0.6040 &
0.8550 & 1.0360 & 1.2250 & 1.4090 & 1.5950 & 1.7960 & 2.1030 & 2.8770 \\
2021 & 0.4600 & 0.8940 & 1.2690 & 1.6290 & 2.4640 & 0.1880 & 0.6030 &
0.8120 & 0.9850 & 1.1850 & 1.3520 & 1.5750 & 1.7970 & 2.2080 & 3.0420 \\
2022 & 0.3740 & 0.8670 & 1.1530 & 1.5230 & 2.2120 & 0.2240 & 0.5020 &
0.7560 & 0.9260 & 1.0650 & 1.2230 & 1.3900 & 1.6010 & 1.9220 & 2.5190 \\
2023 & 0.3950 & 0.8710 & 1.1630 & 1.5190 & 2.1440 & 0.2260 & 0.5320 &
0.7710 & 0.9380 & 1.1010 & 1.2400 & 1.4040 & 1.5700 & 1.9460 & 2.4110 \\
\end{longtable}

We will combine the annual value-weighted returns data in
\texttt{ff\_beta{[}2{]}} with the value-weighted beta data in
\texttt{ff\_beta{[}6{]}} into one data frame \texttt{ff\_beta\_sml}. We
can easily use the \texttt{.join()} method if we first use the
\texttt{stack()} method to convert the returns and beta data frames into
long data frames.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_beta\_sml }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_beta[}\DecValTok{2}\NormalTok{].iloc[:, :}\DecValTok{5}\NormalTok{] }\CommentTok{\# annual value{-}weighted returns on quintile portfolios}
\NormalTok{    .stack() }\CommentTok{\# convert to long data frame with one column of returns}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{)}
\NormalTok{    .join(}
\NormalTok{        ff\_beta[}\DecValTok{6}\NormalTok{].iloc[:, :}\DecValTok{5}\NormalTok{] }\CommentTok{\# value{-}weighted betas from previous year on quintile portfolios}
\NormalTok{        .stack() }\CommentTok{\# convert to long data frame with one column of betas}
\NormalTok{        .to\_frame(}\StringTok{\textquotesingle{}Beta\textquotesingle{}}\NormalTok{)}
\NormalTok{    )}
\NormalTok{    .rename\_axis(}
\NormalTok{        index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Data\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{],}
\NormalTok{        columns}\OperatorTok{=}\StringTok{\textquotesingle{}Variable\textquotesingle{}}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{ff\_beta\_sml.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& Variable & Return & Beta \\
Data & Portfolio & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{5}{=}{2023} & Lo 20 & 2.3000 & 0.3950 \\
& Qnt 2 & 27.9500 & 0.8710 \\
& Qnt 3 & 26.2600 & 1.1630 \\
& Qnt 4 & 44.3900 & 1.5190 \\
& Hi 20 & 74.7900 & 2.1440 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start }\OperatorTok{=}\NormalTok{ ff\_beta\_sml.index.get\_level\_values(}\DecValTok{0}\NormalTok{).year[}\DecValTok{0}\NormalTok{]}
\NormalTok{stop }\OperatorTok{=}\NormalTok{ ff\_beta\_sml.index.get\_level\_values(}\DecValTok{0}\NormalTok{).year[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}

\NormalTok{sns.regplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{ff\_beta\_sml,}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Beta\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annual Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\VerbatimStringTok{r\textquotesingle{}Capital Asset Pricing Model (CAPM) $\textbackslash{}beta$\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}
    \VerbatimStringTok{r\textquotesingle{}Security Market Line (SML) for $\textbackslash{}beta$ Quintile Portfolios\textquotesingle{}} \OperatorTok{+}
    \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}n}\SpecialStringTok{for Annual Returns from }\SpecialCharTok{\{}\NormalTok{start}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{stop}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_03_files/figure-pdf/cell-26-output-1.png}

\subsection{\texorpdfstring{Estimate the CAPM \(\beta\)s on several
levered and inverse exchange traded funds
(ETFs)}{Estimate the CAPM \textbackslash betas on several levered and inverse exchange traded funds (ETFs)}}\label{estimate-the-capm-betas-on-several-levered-and-inverse-exchange-traded-funds-etfs-1}

Try the following ETFs:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  SPY
\item
  UPRO
\item
  SPXU
\end{enumerate}

Can you determine what these products do from the data alone? Estimate
\(\beta\)s and plot cumulative returns. You may want to pick short
periods of time with large market swings.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{etf\_2 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}SPY UPRO SPXU\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
\NormalTok{    [}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    .pct\_change()}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .dropna()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  3 of 3 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{etf\_2.}\BuiltInTok{apply}\NormalTok{(calc\_beta).rename(}\VerbatimStringTok{r\textquotesingle{}$\textbackslash{}beta$\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Ticker
SPXU   -2.8635
SPY     0.9582
UPRO    2.8790
Name: $\beta$, dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start }\OperatorTok{=}\NormalTok{ etf\_2.index[}\DecValTok{0}\NormalTok{]}
\NormalTok{stop }\OperatorTok{=}\NormalTok{ etf\_2.index[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}

\NormalTok{etf\_2.}\BuiltInTok{apply}\NormalTok{(calc\_beta).plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xticks(rotation}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{plt.ylabel(}\VerbatimStringTok{r\textquotesingle{}Capital Asset Pricing Model (CAPM) $\textbackslash{}beta$\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}
    \VerbatimStringTok{r\textquotesingle{}Capital Asset Pricing Model (CAPM) $\textbackslash{}beta$s\textquotesingle{}} \OperatorTok{+} 
    \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}n}\SpecialStringTok{from Daily Returns from }\SpecialCharTok{\{}\NormalTok{start}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{d }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{stop}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{d }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_03_files/figure-pdf/cell-29-output-1.png}

\subsection{Explore the size factor}\label{explore-the-size-factor-1}

First, we need data for portfolio and factor returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_me }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolios\_Formed\_on\_ME\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(ff\_me[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\948145699.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\948145699.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\948145699.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\948145699.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\948145699.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\948145699.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_me = pdr.DataReader(
\end{verbatim}

\begin{verbatim}
Portfolios Formed on ME
-----------------------

This file was created by CMPT_ME_RETS using the 202402 CRSP database. It contains value- and equal-weighted returns for size portfolios. Each record contains returns for: Negative (not used) 30% 40% 30%   5 Quintiles  10 Deciles The portfolios are constructed at the end of Jun. The annual returns are from January to December. Missing data are indicated by -99.99 or -999. Copyright 2024 Kenneth R. French

  0 : Value Weight Returns -- Monthly (1172 rows x 19 cols)
  1 : Equal Weight Returns -- Monthly (1172 rows x 19 cols)
  2 : Value Weight Returns -- Annual from January to December (97 rows x 19 cols)
  3 : Equal Weight Returns -- Annual from January to December (97 rows x 19 cols)
  4 : Number of Firms in Portfolios (1172 rows x 19 cols)
  5 : Average Firm Size (1172 rows x 19 cols)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_m }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(ff\_m[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
F-F Research Data Factors
-------------------------

This file was created by CMPT_ME_BEME_RETS using the 202402 CRSP database. The 1-month TBill return is from Ibbotson and Associates, Inc. Copyright 2024 Kenneth R. French

  0 : (1172 rows x 4 cols)
  1 : Annual Factors: January-December (97 rows x 4 cols)
\end{verbatim}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\1667574714.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_m = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\1667574714.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_m = pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_me }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_me[}\DecValTok{1}\NormalTok{]}
\NormalTok{    .iloc[:, }\OperatorTok{{-}}\DecValTok{10}\NormalTok{:]}
\NormalTok{    .join(ff\_m[}\DecValTok{0}\NormalTok{])}
\NormalTok{)}

\NormalTok{df\_me.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllllll@{}}
\toprule\noalign{}
& Lo 10 & Dec 2 & Dec 3 & Dec 4 & Dec 5 & Dec 6 & Dec 7 & Dec 8 & Dec 9
& Hi 10 & Mkt-RF & SMB & HML & RF \\
Date & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2023-10 & -9.3900 & -8.4100 & -7.9700 & -7.5300 & -6.4900 & -5.5100 &
-6.4000 & -6.3600 & -4.6000 & -2.2600 & -3.1900 & -3.8700 & 0.1900 &
0.4700 \\
2023-11 & 6.3000 & 9.0500 & 9.5800 & 9.6400 & 11.8700 & 9.6700 & 9.8400
& 9.6400 & 9.9900 & 9.2700 & 8.8400 & -0.0200 & 1.6400 & 0.4400 \\
2023-12 & 10.8700 & 17.2700 & 14.4800 & 14.2400 & 13.1200 & 12.0000 &
9.1600 & 9.6500 & 7.0000 & 5.5400 & 4.8700 & 6.3400 & 4.9300 & 0.4300 \\
2024-01 & -2.8200 & -5.4600 & -5.8600 & -4.9400 & -5.0700 & -3.1900 &
-2.3800 & -1.2600 & -1.7100 & 1.5900 & 0.7100 & -5.0900 & -2.3800 &
0.4700 \\
2024-02 & 5.5400 & 6.7100 & 4.8000 & 8.1900 & 3.4200 & 4.4400 & 6.3100 &
4.5400 & 5.7900 & 3.7100 & 5.0600 & -0.2400 & -3.4800 & 0.4200 \\
\end{longtable}

\subsubsection{\texorpdfstring{Estimate \(\alpha\)s for the ten
portfolios formed on
size}{Estimate \textbackslash alphas for the ten portfolios formed on size}}\label{estimate-alphas-for-the-ten-portfolios-formed-on-size-1}

Academics started researching size-based portfolios in the early 1980s,
so you may want to focus on the pre-1980 sample.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\OperatorTok{=}\NormalTok{ smf.ols(}
\NormalTok{    formula}\OperatorTok{=}\StringTok{\textquotesingle{}I(Q("Lo 10") {-} RF) \textasciitilde{} Q("Mkt{-}RF")\textquotesingle{}}\NormalTok{,}
\NormalTok{    data}\OperatorTok{=}\NormalTok{df\_me.loc[:}\StringTok{\textquotesingle{}1980\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\NormalTok{fit }\OperatorTok{=}\NormalTok{ mod.fit()}
\NormalTok{fit.summary()}
\end{Highlighting}
\end{Shaded}

\begin{center}
\begin{tabular}{lclc}
\toprule
\textbf{Dep. Variable:}    & I(Q("Lo 10") - RF) & \textbf{  R-squared:         } &     0.541   \\
\textbf{Model:}            &        OLS         & \textbf{  Adj. R-squared:    } &     0.540   \\
\textbf{Method:}           &   Least Squares    & \textbf{  F-statistic:       } &     767.6   \\
\textbf{Date:}             &  Fri, 05 Apr 2024  & \textbf{  Prob (F-statistic):} & 2.92e-112   \\
\textbf{Time:}             &      17:46:25      & \textbf{  Log-Likelihood:    } &   -2343.5   \\
\textbf{No. Observations:} &          654       & \textbf{  AIC:               } &     4691.   \\
\textbf{Df Residuals:}     &          652       & \textbf{  BIC:               } &     4700.   \\
\textbf{Df Model:}         &            1       & \textbf{                     } &             \\
\textbf{Covariance Type:}  &     nonrobust      & \textbf{                     } &             \\
\bottomrule
\end{tabular}
\begin{tabular}{lcccccc}
                     & \textbf{coef} & \textbf{std err} & \textbf{t} & \textbf{P$> |$t$|$} & \textbf{[0.025} & \textbf{0.975]}  \\
\midrule
\textbf{Intercept}   &       0.9161  &        0.343     &     2.669  &         0.008        &        0.242    &        1.590     \\
\textbf{Q("Mkt-RF")} &       1.5976  &        0.058     &    27.706  &         0.000        &        1.484    &        1.711     \\
\bottomrule
\end{tabular}
\begin{tabular}{lclc}
\textbf{Omnibus:}       & 626.765 & \textbf{  Durbin-Watson:     } &     1.970  \\
\textbf{Prob(Omnibus):} &   0.000 & \textbf{  Jarque-Bera (JB):  } & 28924.644  \\
\textbf{Skew:}          &   4.226 & \textbf{  Prob(JB):          } &      0.00  \\
\textbf{Kurtosis:}      &  34.464 & \textbf{  Cond. No.          } &      5.99  \\
\bottomrule
\end{tabular}
%\caption{OLS Regression Results}
\end{center}

Notes: \newline
 [1] Standard Errors assume that the covariance matrix of the errors is correctly specified.

Now, we can use list comprehensions to quickly estimate all ten
\(\alpha\)s.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ports }\OperatorTok{=}\NormalTok{ df\_me.columns.to\_list()[:}\DecValTok{10}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mods }\OperatorTok{=}\NormalTok{ [}
\NormalTok{    smf.ols(formula}\OperatorTok{=}\SpecialStringTok{f\textquotesingle{}I(Q("}\SpecialCharTok{\{}\NormalTok{p}\SpecialCharTok{\}}\SpecialStringTok{"){-}RF) \textasciitilde{} Q("Mkt{-}RF")\textquotesingle{}}\NormalTok{, data}\OperatorTok{=}\NormalTok{df\_me.loc[}\StringTok{\textquotesingle{}1994\textquotesingle{}}\NormalTok{:])}
    \ControlFlowTok{for}
\NormalTok{    p }\KeywordTok{in}\NormalTok{ ports}
\NormalTok{]}
\NormalTok{fits }\OperatorTok{=}\NormalTok{ [m.fit() }\ControlFlowTok{for}\NormalTok{ m }\KeywordTok{in}\NormalTok{ mods]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{params }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat([f.params }\ControlFlowTok{for}\NormalTok{ f }\KeywordTok{in}\NormalTok{ fits], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{ports, names}\OperatorTok{=}\StringTok{\textquotesingle{}Portolio\textquotesingle{}}\NormalTok{)}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{bses }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat([f.bse }\ControlFlowTok{for}\NormalTok{ f }\KeywordTok{in}\NormalTok{ fits], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{ports, names}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{)}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start }\OperatorTok{=}\NormalTok{ df\_me.loc[:}\StringTok{\textquotesingle{}1980\textquotesingle{}}\NormalTok{].index[}\DecValTok{0}\NormalTok{].to\_timestamp()}
\NormalTok{stop }\OperatorTok{=}\NormalTok{ df\_me.loc[:}\StringTok{\textquotesingle{}1980\textquotesingle{}}\NormalTok{].index[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].to\_timestamp()}

\NormalTok{params[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{].plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{, yerr}\OperatorTok{=}\NormalTok{bses[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{])}

\NormalTok{plt.ylabel(}\VerbatimStringTok{r\textquotesingle{}Monthly CAPM $\textbackslash{}alpha$ (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xticks(rotation}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{plt.title(}
    \VerbatimStringTok{r\textquotesingle{}Size Portfolio Monthly CAPM $\textbackslash{}alpha$s\textquotesingle{}} \OperatorTok{+}
    \StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}} \OperatorTok{+}
    \SpecialStringTok{f\textquotesingle{}from }\SpecialCharTok{\{}\NormalTok{start}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ through }\SpecialCharTok{\{}\NormalTok{stop}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_03_files/figure-pdf/cell-38-output-1.png}

\subsubsection{Are the returns on these ten portfolios formed on size
concentrated in a specific
month?}\label{are-the-returns-on-these-ten-portfolios-formed-on-size-concentrated-in-a-specific-month-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_me\_2 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_me[}\DecValTok{0}\NormalTok{]}
\NormalTok{    .iloc[:, }\OperatorTok{{-}}\DecValTok{10}\NormalTok{:]}
\NormalTok{    .stack()}
\NormalTok{    .rename\_axis(index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{])}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{)}
\NormalTok{    .reset\_index()}
\NormalTok{    .assign(Month}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.where(x[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{].dt.month}\OperatorTok{==}\DecValTok{1}\NormalTok{, }\StringTok{\textquotesingle{}January\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Not January\textquotesingle{}}\NormalTok{))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.barplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{df\_me\_2,}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Month\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{,}
\NormalTok{    hue}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Mean Monthly Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}When Do We Earn Size{-}Effect Returns?\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_03_files/figure-pdf/cell-40-output-1.png}

\subsubsection{Compare the size factor to the market
factor}\label{compare-the-size-factor-to-the-market-factor-1}

You may want to consider mean excess returns by decade. The market and
size excess returns are factors \texttt{Mkt-RF} and \texttt{SMB} in the
Fama-French factors data.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_me\_3 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_m[}\DecValTok{0}\NormalTok{]}
\NormalTok{    [[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}SMB\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .stack()}
\NormalTok{    .rename\_axis(index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Factor\textquotesingle{}}\NormalTok{])}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{)}
\NormalTok{    .reset\_index()}
\NormalTok{    .assign(Decade}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: (x[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{].dt.year }\OperatorTok{//} \DecValTok{10}\NormalTok{ ) }\OperatorTok{*} \DecValTok{10}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.barplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{df\_me\_3,}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Decade\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{,}
\NormalTok{    hue}\OperatorTok{=}\StringTok{\textquotesingle{}Factor\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Monthly Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Comparison on Market and Small Stock Risk Premia\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_03_files/figure-pdf/cell-42-output-1.png}

SMB rarely generates outsize returns later in the sample.

\subsection{Repeat the exercises above with the value
factor}\label{repeat-the-exercises-above-with-the-value-factor-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_be\_me }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolios\_Formed\_on\_BE{-}ME\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(ff\_me[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Portfolios Formed on ME
-----------------------

This file was created by CMPT_ME_RETS using the 202402 CRSP database. It contains value- and equal-weighted returns for size portfolios. Each record contains returns for: Negative (not used) 30% 40% 30%   5 Quintiles  10 Deciles The portfolios are constructed at the end of Jun. The annual returns are from January to December. Missing data are indicated by -99.99 or -999. Copyright 2024 Kenneth R. French

  0 : Value Weight Returns -- Monthly (1172 rows x 19 cols)
  1 : Equal Weight Returns -- Monthly (1172 rows x 19 cols)
  2 : Value Weight Returns -- Annual from January to December (97 rows x 19 cols)
  3 : Equal Weight Returns -- Annual from January to December (97 rows x 19 cols)
  4 : Number of Firms in Portfolios (1172 rows x 19 cols)
  5 : Average Firm Size (1172 rows x 19 cols)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_be\_me }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_be\_me[}\DecValTok{1}\NormalTok{]}
\NormalTok{    .iloc[:, }\OperatorTok{{-}}\DecValTok{10}\NormalTok{:]}
\NormalTok{    .join(ff\_m[}\DecValTok{0}\NormalTok{])}
\NormalTok{)}

\NormalTok{df\_be\_me.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllllll@{}}
\toprule\noalign{}
& Lo 10 & Dec 2 & Dec 3 & Dec 4 & Dec 5 & Dec 6 & Dec 7 & Dec 8 & Dec 9
& Hi 10 & Mkt-RF & SMB & HML & RF \\
Date & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2023-10 & -7.6200 & -6.5300 & -8.4300 & -7.7500 & -7.0200 & -7.0800 &
-6.1800 & -7.0600 & -7.6800 & -8.4300 & -3.1900 & -3.8700 & 0.1900 &
0.4700 \\
2023-11 & 9.8800 & 9.8900 & 8.5700 & 7.1800 & 11.5300 & 13.6400 & 8.7100
& 10.5800 & 6.4300 & 6.6500 & 8.8400 & -0.0200 & 1.6400 & 0.4400 \\
2023-12 & 9.8700 & 9.2100 & 15.0800 & 11.0000 & 9.7200 & 11.9100 &
14.2700 & 14.1400 & 13.9600 & 13.2000 & 4.8700 & 6.3400 & 4.9300 &
0.4300 \\
2024-01 & -4.0000 & -1.3500 & -3.4800 & -3.2100 & -4.5000 & -3.5100 &
-3.3800 & -4.4200 & -3.6400 & -0.4200 & 0.7100 & -5.0900 & -2.3800 &
0.4700 \\
2024-02 & 6.1900 & 7.6000 & 7.2500 & 5.2900 & 7.5200 & 7.6200 & 3.3800 &
3.3400 & 1.7400 & 7.2900 & 5.0600 & -0.2400 & -3.4800 & 0.4200 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ports }\OperatorTok{=}\NormalTok{ df\_be\_me.columns.to\_list()[:}\DecValTok{10}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mods }\OperatorTok{=}\NormalTok{ [}
\NormalTok{    smf.ols(formula}\OperatorTok{=}\SpecialStringTok{f\textquotesingle{}I(Q("}\SpecialCharTok{\{}\NormalTok{p}\SpecialCharTok{\}}\SpecialStringTok{") {-} RF) \textasciitilde{} Q("Mkt{-}RF")\textquotesingle{}}\NormalTok{, data}\OperatorTok{=}\NormalTok{df\_be\_me)}
    \ControlFlowTok{for}
\NormalTok{    p }\KeywordTok{in}\NormalTok{ ports}
\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fits }\OperatorTok{=}\NormalTok{ [m.fit() }\ControlFlowTok{for}\NormalTok{ m }\KeywordTok{in}\NormalTok{ mods]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{params }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat([f.params }\ControlFlowTok{for}\NormalTok{ f }\KeywordTok{in}\NormalTok{ fits], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{ports, names}\OperatorTok{=}\StringTok{\textquotesingle{}Portolio\textquotesingle{}}\NormalTok{)}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{bses }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat([f.bse }\ControlFlowTok{for}\NormalTok{ f }\KeywordTok{in}\NormalTok{ fits], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{ports, names}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{)}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start }\OperatorTok{=}\NormalTok{ df\_be\_me.index[}\DecValTok{0}\NormalTok{].to\_timestamp()}
\NormalTok{stop }\OperatorTok{=}\NormalTok{ df\_be\_me.index[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].to\_timestamp()}

\NormalTok{params[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{].plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{, yerr}\OperatorTok{=}\NormalTok{bses[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{])}

\NormalTok{plt.ylabel(}\VerbatimStringTok{r\textquotesingle{}Monthly CAPM $\textbackslash{}alpha$ (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xticks(rotation}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{plt.title(}
    \VerbatimStringTok{r\textquotesingle{}BE/ME Portfolio Monthly CAPM $\textbackslash{}alpha$s\textquotesingle{}} \OperatorTok{+}
    \StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}} \OperatorTok{+}
    \SpecialStringTok{f\textquotesingle{}from }\SpecialCharTok{\{}\NormalTok{start}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ through }\SpecialCharTok{\{}\NormalTok{stop}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_03_files/figure-pdf/cell-51-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_be\_me\_3 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_m[}\DecValTok{0}\NormalTok{]}
\NormalTok{    [[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}HML\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .stack()}
\NormalTok{    .rename\_axis(index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Factor\textquotesingle{}}\NormalTok{])}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{)}
\NormalTok{    .reset\_index()}
\NormalTok{    .assign(Decade}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: (x[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{].dt.year }\OperatorTok{//} \DecValTok{10}\NormalTok{ ) }\OperatorTok{*} \DecValTok{10}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.barplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{df\_be\_me\_3,}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Decade\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{,}
\NormalTok{    hue}\OperatorTok{=}\StringTok{\textquotesingle{}Factor\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Monthly Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Comparison on Market and Value Stock Risk Premia\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_03_files/figure-pdf/cell-53-output-1.png}

\subsection{Repeat the exercises above with the momentum
factor}\label{repeat-the-exercises-above-with-the-momentum-factor-1}

You may find it helpful to consider the worst months and years for the
momentum factor.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_mom }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}10\_Portfolios\_Prior\_12\_2\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\2097656781.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\2097656781.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\2097656781.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\2097656781.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\2097656781.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\2097656781.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\2097656781.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(ff\_mom[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
10 Portfolios Prior 12 2
------------------------

This file was created by CMPT_PRIOR_RETS using the 202402 CRSP database. It contains value- and equal-weighted returns for 10 prior-return portfolios. The portfolios are constructed monthly. PRIOR_RET is from -12 to - 2. The annual returns are from January to December. Missing data are indicated by -99.99 or -999.

  0 : Average Value Weighted Returns -- Monthly (1166 rows x 10 cols)
  1 : Average Equal Weighted Returns -- Monthly (1166 rows x 10 cols)
  2 : Average Value Weighted Returns -- Annual (97 rows x 10 cols)
  3 : Average Equal Weighted Returns -- Annual (97 rows x 10 cols)
  4 : Number of Firms in Portfolios (1166 rows x 10 cols)
  5 : Average Firm Size (1166 rows x 10 cols)
  6 : Value-Weighted Average of Prior Returns (97 rows x 10 cols)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_mom }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_mom[}\DecValTok{1}\NormalTok{]}
\NormalTok{    .iloc[:, }\OperatorTok{{-}}\DecValTok{10}\NormalTok{:]}
\NormalTok{    .join(ff\_m[}\DecValTok{0}\NormalTok{])}
\NormalTok{)}

\NormalTok{df\_mom.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllllll@{}}
\toprule\noalign{}
& Lo PRIOR & PRIOR 2 & PRIOR 3 & PRIOR 4 & PRIOR 5 & PRIOR 6 & PRIOR 7 &
PRIOR 8 & PRIOR 9 & Hi PRIOR & Mkt-RF & SMB & HML & RF \\
Date & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2023-10 & -11.8200 & -8.0400 & -5.4700 & -4.4900 & -5.6900 & -4.9900 &
-4.7800 & -6.1700 & -6.4800 & -8.7700 & -3.1900 & -3.8700 & 0.1900 &
0.4700 \\
2023-11 & 7.8000 & 8.7100 & 7.1900 & 8.1500 & 7.7400 & 5.3800 & 8.0100 &
9.9700 & 10.4500 & 12.3300 & 8.8400 & -0.0200 & 1.6400 & 0.4400 \\
2023-12 & 14.9500 & 13.2800 & 14.0100 & 11.9000 & 10.5300 & 9.3300 &
6.5900 & 6.7600 & 8.4100 & 13.2100 & 4.8700 & 6.3400 & 4.9300 &
0.4300 \\
2024-01 & -6.8900 & -5.0200 & -3.9900 & -2.2500 & -2.3300 & -2.4100 &
-0.9400 & 0.0400 & -0.3900 & -0.6600 & 0.7100 & -5.0900 & -2.3800 &
0.4700 \\
2024-02 & 8.2200 & 3.9100 & 2.6200 & 2.4500 & 2.0900 & 3.8600 & 4.3500 &
5.4000 & 6.0200 & 10.5000 & 5.0600 & -0.2400 & -3.4800 & 0.4200 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ports }\OperatorTok{=}\NormalTok{ df\_mom.columns.to\_list()[:}\DecValTok{10}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mods }\OperatorTok{=}\NormalTok{ [}
\NormalTok{    smf.ols(formula}\OperatorTok{=}\SpecialStringTok{f\textquotesingle{}I(Q("}\SpecialCharTok{\{}\NormalTok{p}\SpecialCharTok{\}}\SpecialStringTok{") {-} RF) \textasciitilde{} Q("Mkt{-}RF")\textquotesingle{}}\NormalTok{, data}\OperatorTok{=}\NormalTok{df\_mom.loc[:}\StringTok{\textquotesingle{}1980\textquotesingle{}}\NormalTok{])}
    \ControlFlowTok{for}
\NormalTok{    p }\KeywordTok{in}\NormalTok{ ports}
\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fits }\OperatorTok{=}\NormalTok{ [m.fit() }\ControlFlowTok{for}\NormalTok{ m }\KeywordTok{in}\NormalTok{ mods]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{params }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat([f.params }\ControlFlowTok{for}\NormalTok{ f }\KeywordTok{in}\NormalTok{ fits], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{ports, names}\OperatorTok{=}\StringTok{\textquotesingle{}Portolio\textquotesingle{}}\NormalTok{)}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{bses }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat([f.bse }\ControlFlowTok{for}\NormalTok{ f }\KeywordTok{in}\NormalTok{ fits], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{ports, names}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{)}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start }\OperatorTok{=}\NormalTok{ df\_mom.loc[:}\StringTok{\textquotesingle{}1980\textquotesingle{}}\NormalTok{].index[}\DecValTok{0}\NormalTok{].to\_timestamp()}
\NormalTok{stop }\OperatorTok{=}\NormalTok{ df\_mom.loc[:}\StringTok{\textquotesingle{}1980\textquotesingle{}}\NormalTok{].index[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].to\_timestamp()}

\NormalTok{params[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{].plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{, yerr}\OperatorTok{=}\NormalTok{bses[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{])}

\NormalTok{plt.ylabel(}\VerbatimStringTok{r\textquotesingle{}Monthly CAPM $\textbackslash{}alpha$ (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}
    \VerbatimStringTok{r\textquotesingle{}Momentum Portfolio Monthly CAPM $\textbackslash{}alpha$s\textquotesingle{}} \OperatorTok{+}
    \StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}} \OperatorTok{+}
    \SpecialStringTok{f\textquotesingle{}from }\SpecialCharTok{\{}\NormalTok{start}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ through }\SpecialCharTok{\{}\NormalTok{stop}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_03_files/figure-pdf/cell-62-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_mom }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Momentum\_Factor\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}

\NormalTok{ff\_mom[}\DecValTok{0}\NormalTok{].columns }\OperatorTok{=}\NormalTok{ [c.strip() }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ ff\_mom[}\DecValTok{0}\NormalTok{].columns]}
\NormalTok{ff\_mom[}\DecValTok{0}\NormalTok{].tail()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\1313848978.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\1313848978.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
\end{verbatim}

\begin{longtable}[]{@{}ll@{}}
\toprule\noalign{}
& Mom \\
Date & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2023-10 & 1.7300 \\
2023-11 & 2.7500 \\
2023-12 & -5.5100 \\
2024-01 & 5.1800 \\
2024-02 & 4.9200 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_mom\_3 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_m[}\DecValTok{0}\NormalTok{].join(ff\_mom[}\DecValTok{0}\NormalTok{])}
\NormalTok{    [[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Mom\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .stack()}
\NormalTok{    .rename\_axis(index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Factor\textquotesingle{}}\NormalTok{])}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{)}
\NormalTok{    .reset\_index()}
\NormalTok{    .assign(Decade}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: (x[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{].dt.year }\OperatorTok{//} \DecValTok{10}\NormalTok{ ) }\OperatorTok{*} \DecValTok{10}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.barplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{df\_mom\_3,}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Decade\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{,}
\NormalTok{    hue}\OperatorTok{=}\StringTok{\textquotesingle{}Factor\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Monthly Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Comparison on Market and Value Stock Risk Premia\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_03_files/figure-pdf/cell-65-output-1.png}

\subsection{Plot the coefficient estimates from a rolling Fama-French
three-factor model for Berkshire
Hathaway}\label{plot-the-coefficient-estimates-from-a-rolling-fama-french-three-factor-model-for-berkshire-hathaway-1}

Use a three-year window with daily returns. How has Buffett's \(\alpha\)
and \(\beta\)s changed over the past four decades?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{brk }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}BRK{-}A\textquotesingle{}}\NormalTok{)}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{])}
\NormalTok{    .assign(r}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].pct\_change().mul(}\DecValTok{100}\NormalTok{))}
\NormalTok{    .dropna()}
\NormalTok{    .join(}
\NormalTok{        pdr.DataReader(}
\NormalTok{            name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{            data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{            start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{        )[}\DecValTok{0}\NormalTok{],}
\NormalTok{        how}\OperatorTok{=}\StringTok{\textquotesingle{}inner\textquotesingle{}}
\NormalTok{    )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  1 of 1 completed
C:\Users\r.herron\AppData\Local\Temp\ipykernel_20072\2930704642.py:8: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{from}\NormalTok{ statsmodels.regression.rolling }\ImportTok{import}\NormalTok{ RollingOLS}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{coefs }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    RollingOLS.from\_formula(}
\NormalTok{        formula}\OperatorTok{=}\StringTok{\textquotesingle{}I(r{-}RF) \textasciitilde{} Q("Mkt{-}RF") + SMB + HML\textquotesingle{}}\NormalTok{,}
\NormalTok{        data}\OperatorTok{=}\NormalTok{brk,}
\NormalTok{        window}\OperatorTok{=}\DecValTok{3}\OperatorTok{*}\DecValTok{252}
\NormalTok{    )}
\NormalTok{    .fit()}
\NormalTok{    .params}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Coefficient\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}Q("Mkt{-}RF")\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{\})}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fig, ax }\OperatorTok{=}\NormalTok{ plt.subplots(}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, sharex}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{coefs[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{].plot(ax}\OperatorTok{=}\NormalTok{ax[}\DecValTok{0}\NormalTok{], legend}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{coefs.drop(}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{, axis}\OperatorTok{=}\DecValTok{1}\NormalTok{).plot(ax}\OperatorTok{=}\NormalTok{ax[}\DecValTok{1}\NormalTok{])}
\NormalTok{plt.suptitle(}
    \StringTok{\textquotesingle{}Rolling Three{-}Factor Regressions\textquotesingle{}} \OperatorTok{+}
    \StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n}\StringTok{Three{-}Year Windows with Daily Returns in Percent\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_03_files/figure-pdf/cell-69-output-1.png}

Buffett's \(\alpha\) was large, but has declined to zero. Also, his
loading on SMB (size factor) has gone from positive to negative,
indicating that he has moved from small stocks to large stocks as
Berkshire Hathaway has grown.

\chapter{Herron Topic 3 - Practice for Section
04}\label{herron-topic-3---practice-for-section-04}

\section{Announcements}\label{announcements-38}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  We will make a few changes to give us more time to work on Project 3:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    We will drop Herron Topic 5 on simulations during Week 14 and use
    this time for group work
  \item
    I will finalize Project 3 by Thursday, 4/4, so we have about 3 week
    to work on it before the Tuesday, 4/23, due date
  \end{enumerate}
\item
  \textbf{\emph{Next Thursday and Friday, 4/11 and 4/12, we will take
  the MSFQ assessment exam in class. I do not control this exam, and
  there are a few conditions:}}

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    \textbf{\emph{Open book}}
  \item
    \textbf{\emph{On Canvas}}
  \item
    \textbf{\emph{In the classroom}}
  \end{enumerate}
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-37}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The Capital Asset Pricing Model (CAPM) estimates asset \(i\)'s
  expected return as \(E(r_i) = r_f + \beta_i [E(r_M) - r_f]\), where:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    \(r_f\) is the risk-free rate
  \item
    \(\beta_i\) is asset \(i\)'s systematic risk
  \item
    \(E(r_M) - r_f\) is the market risk premium
  \end{enumerate}
\item
  The Security Market Line (SML) visualizes the CAPM

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Plots \(E(r_i)\) on the y axis against \(\beta_i\) on the x axis
  \item
    The slope of the SML is the market risk premium \(E(r_M) - r_f\)
  \item
    The intercept of the SML is the risk-free rate \(r_f\)
  \end{enumerate}
\item
  We can estimate asset \(i\)'s systematic risk a few ways:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    \(\beta_i = \frac{Cov(r_i-r_f, r_M-r_f)}{Var(r_M-r_f)}\)
  \item
    \(\beta_i = Corr(r_i-r_f, r_M-r_f) \frac{Std(r_i-r_f)}{Std(r_M-r_f)}\)
  \item
    Estimate the linear regression
    \(r_i - r_f = \alpha_i + \beta_i [r_M - r_f] + \varepsilon_i\) with
    the \texttt{smf.ols()} function after we
    \texttt{import\ statsmodels.formula.api\ as\ smf}
  \item
    We will follow Bodie, Kane, and Marcus's syntax where a \(r\) is a
    raw return and a \(R\) is an excess return, so \(R_i = r_i - r_f\)
  \end{enumerate}
\item
  The CAPM is the foundation of modern finance and does well for single
  periods but has a few shortcomings:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Does poorly over multiple periods
  \item
    The SML is ``too flat'' empirically, and high \(\beta\) assets tend
    to have lower returns than expected
  \item
    Does explain the returns on several factors, like size, value, and
    momentum
  \end{enumerate}
\item
  The Fama-French 3-factor model---and many others---attempts to solves
  these shortcomings and is useful for evaluating fund manager
  performance
\end{enumerate}

\section{Practice}\label{practice-38}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ seaborn }\ImportTok{as}\NormalTok{ sns}
\ImportTok{import}\NormalTok{ statsmodels.formula.api }\ImportTok{as}\NormalTok{ smf}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{Plot the security market line (SML) for a variety of asset
classes}\label{plot-the-security-market-line-sml-for-a-variety-of-asset-classes-2}

Use the past three years of daily data for the following exhange traded
funds (ETFs):

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  SPY (SPDR---Standard and Poor's Depository Receipts---ETF for the S\&P
  500 index)
\item
  BIL (SPDR ETF for 1-3 month Treasury bills)
\item
  GLD (SPDR ETF for gold)
\item
  JNK (SPDR ETF for high-yield debt)
\item
  MDY (SPDR ETF for S\&P 400 mid-cap index)
\item
  SLY (SPDR ETF for S\&P 600 small-cap index)
\item
  SPBO (SPDR ETF for corporate bonds)
\item
  SPMB (SPDR ETF for mortgage-backed securities)
\item
  SPTL (SPDR ETF for long-term Treasury bonds)
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tickers }\OperatorTok{=} \StringTok{\textquotesingle{}SPY BIL GLD JNK MDY SLY SPBO SPMB SPTL\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

For multifactor models, we generally leave returns in percents. Slope
coefficient estimates (i.e., \(\beta\)s) are the same for decimal and
percent returns. Intercept coefficient estimates (i.e., \(\alpha\)s) are
easier to interpret in percents than in decimals because small percent
returns have two fewer zeros than small decimal returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{etf }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\NormalTok{tickers)}
\NormalTok{    [}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    .pct\_change()}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{)}

\NormalTok{etf.tail()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  9 of 9 completed
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\1015031953.py:5: FutureWarning: The default fill_method='pad' in DataFrame.pct_change is deprecated and will be removed in a future version. Either fill in any non-leading NA values prior to calling pct_change or specify 'fill_method=None' to not fill NA values.
  .pct_change()
\end{verbatim}

\begin{longtable}[]{@{}llllllllll@{}}
\toprule\noalign{}
& BIL & GLD & JNK & MDY & SLY & SPBO & SPMB & SPTL & SPY \\
Date & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-03-28 & 0.0000 & 1.2900 & -0.1573 & 0.3589 & 0.0000 & -0.0687 &
-0.2297 & 0.0000 & -0.0191 \\
2024-04-01 & 0.0273 & 1.0208 & -0.4974 & -0.7225 & 0.0000 & -0.7728 &
-0.7249 & -1.8024 & -0.1740 \\
2024-04-02 & 0.0219 & 1.4772 & -0.1910 & -1.2799 & 0.0000 & -0.1391 &
-0.0930 & -0.4022 & -0.6358 \\
2024-04-03 & 0.0000 & 0.8772 & 0.0532 & 0.3998 & 0.0000 & 0.0696 &
0.0466 & -0.1101 & 0.1099 \\
2024-04-04 & 0.0437 & -0.5735 & -0.1382 & -1.0594 & 0.0000 & 0.1392 &
0.3257 & 0.6983 & -1.2206 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pdr.DataReader(}
\NormalTok{        name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{        data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{        start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{    )}
\NormalTok{    [}\DecValTok{0}\NormalTok{]}
\NormalTok{)}

\NormalTok{ff.tail()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\3487692931.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& Mkt-RF & SMB & HML & RF \\
Date & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-02-23 & 0.0200 & 0.2800 & -0.0300 & 0.0210 \\
2024-02-26 & -0.2600 & 1.0000 & -0.1100 & 0.0210 \\
2024-02-27 & 0.2700 & 1.1900 & -0.4500 & 0.0210 \\
2024-02-28 & -0.2600 & -0.8500 & 0.0000 & 0.0210 \\
2024-02-29 & 0.5400 & -0.3400 & 0.9800 & 0.0210 \\
\end{longtable}

We will write two helper functions to make it easier to calculate
annualized mean returns and CAPM betas. We will pass these function
names to the pandas \texttt{.agg()} method, which applies these
functions to every column and combines the results.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_ann\_mean(ri, ann\_fac}\OperatorTok{=}\DecValTok{252}\NormalTok{):}
    \ControlFlowTok{return}\NormalTok{ ri.mean() }\OperatorTok{*}\NormalTok{ ann\_fac}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{etf.}\BuiltInTok{apply}\NormalTok{(calc\_ann\_mean)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
BIL     0.9715
GLD     9.6202
JNK     5.2090
MDY    12.9373
SLY     9.4062
SPBO    3.3207
SPMB    2.1316
SPTL    4.4217
SPY    11.4856
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_beta(ri, rf}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], RM}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{]):}
    \CommentTok{\# betai = Cov(Ri, RM) / Var(RM)}
\NormalTok{    Ri }\OperatorTok{=}\NormalTok{ ri.sub(rf).dropna()}
    \ControlFlowTok{return}\NormalTok{ Ri.cov(RM) }\OperatorTok{/}\NormalTok{ RM.loc[Ri.index].var()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{etf.}\BuiltInTok{apply}\NormalTok{(calc\_beta)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
BIL    -0.0030
GLD     0.0475
JNK     0.3547
MDY     1.0540
SLY     1.0626
SPBO    0.0468
SPMB    0.0522
SPTL   -0.2212
SPY     0.9819
dtype: float64
\end{verbatim}

We should estimate CAPM betas from one-year to three-years of daily
returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{etf\_sml }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    etf}
\NormalTok{    .loc[}\StringTok{\textquotesingle{}2021{-}02\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2024{-}01\textquotesingle{}}\NormalTok{]}
\NormalTok{    .agg([calc\_ann\_mean, calc\_beta])}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{etf\_sml }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    etf}
\NormalTok{    .loc[}\StringTok{\textquotesingle{}2021{-}02\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2024{-}01\textquotesingle{}}\NormalTok{]}
\NormalTok{    .agg([calc\_ann\_mean, calc\_beta])}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The \texttt{regplot()} function in the seaborn package plots a
scatterplot and adds a best-fit line with 95\% confidence interval.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.regplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{etf\_sml,}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}calc\_beta\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}calc\_ann\_mean\textquotesingle{}} 
\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ t, (x, y) }\KeywordTok{in}\NormalTok{ etf\_sml[[}\StringTok{\textquotesingle{}calc\_beta\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}calc\_ann\_mean\textquotesingle{}}\NormalTok{]].iterrows():}
\NormalTok{    plt.annotate(text}\OperatorTok{=}\NormalTok{t, xy}\OperatorTok{=}\NormalTok{(x, y))}


\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\VerbatimStringTok{r\textquotesingle{}Capital Asset Pricing Model (CAPM) $\textbackslash{}beta$\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}
    \StringTok{\textquotesingle{}Security Market Line (SML) from Exchange Traded Funds (ETFs)}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}} \OperatorTok{+}
    \StringTok{\textquotesingle{}Daily Returns from 2021{-}02 to 2024{-}01\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_04_files/figure-pdf/cell-13-output-1.png}

\textbf{\emph{We see the CAPM and SML work well for asset classes!}} The
slope is positive, the intercept is a reasonable risk-free rate, and
assets plot along the SML, most within the 95\% confidence interval.
Note that a few fixed-income ETFs have negative mean returns, but the
SML still has the shape and fit we expect by theory.

The fit above is not perfect, but the \(R^2\) is fairly high at around
50\%. For a single-factor regression, we can quickly calculate \(R^2\)
as \(\rho^2\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{etf\_sml.corr().loc[}\StringTok{\textquotesingle{}calc\_ann\_mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}calc\_beta\textquotesingle{}}\NormalTok{]}\OperatorTok{**}\DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.5086
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{smf.ols(formula}\OperatorTok{=}\StringTok{\textquotesingle{}calc\_ann\_mean \textasciitilde{} calc\_beta\textquotesingle{}}\NormalTok{, data}\OperatorTok{=}\NormalTok{etf\_sml).fit().rsquared}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.5086
\end{verbatim}

\subsection{Plot the SML for the Dow Jones Industrial Average (DJIA)
stocks}\label{plot-the-sml-for-the-dow-jones-industrial-average-djia-stocks-2}

Use the past three years of daily returns data for the stocks listed on
the
\href{https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average}{DJIA
Wikipedia page}. Compare the DJIA SML to the asset class SML above.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tickers }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.read\_html(}\StringTok{\textquotesingle{}https://en.wikipedia.org/wiki/Dow\_Jones\_Industrial\_Average\textquotesingle{}}\NormalTok{)}
\NormalTok{    [}\DecValTok{1}\NormalTok{]}
\NormalTok{    [}\StringTok{\textquotesingle{}Symbol\textquotesingle{}}\NormalTok{]}
\NormalTok{    .to\_list()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{djia }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\NormalTok{tickers)}
\NormalTok{    [}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    .pct\_change()}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{)}

\NormalTok{djia.tail()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  30 of 30 completed
\end{verbatim}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
& AAPL & AMGN & AMZN & AXP & BA & CAT & CRM & CSCO & CVX & DIS & ... &
MMM & MRK & MSFT & NKE & PG & TRV & UNH & V & VZ & WMT \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-03-28 & -1.0559 & -0.6916 & 0.3058 & -0.0263 & 0.5418 & 0.4881 &
-0.0664 & 0.2813 & 0.8890 & 1.1407 & ... & 1.4150 & 0.1518 & -0.1685 &
-0.1593 & -0.2214 & 0.5725 & 0.3245 & 0.0215 & 1.0111 & -0.9058 \\
2024-04-01 & -0.8456 & -0.4502 & 0.3271 & -0.0351 & -1.8084 & -0.7341 &
0.3586 & 0.2605 & 0.8495 & -0.6783 & ... & 6.0129 & -0.7275 & 0.9151 &
-1.5110 & -1.0293 & -0.8603 & -1.0107 & -0.2867 & 0.7626 & -0.2825 \\
2024-04-02 & -0.6999 & -2.4131 & -0.1547 & -0.9138 & -0.7705 & 0.2997 &
0.5757 & -1.3589 & 0.4400 & 1.0615 & ... & -1.2551 & -0.4886 & -0.7372 &
-1.7394 & -0.0062 & -0.1359 & -6.4448 & 0.0575 & 0.6150 & -1.4000 \\
2024-04-03 & 0.4797 & -0.6480 & 0.9519 & 0.4877 & -1.6592 & 3.0041 &
0.2434 & -0.4493 & 0.4131 & -3.1265 & ... & 0.3770 & -0.3452 & -0.2349 &
-0.6817 & -2.7527 & 0.5310 & 0.3492 & -0.5315 & 0.7052 & 0.4564 \\
2024-04-04 & -0.4892 & -2.3067 & -1.3212 & -2.8062 & -0.8815 & -1.5966 &
-3.4784 & -1.2926 & 0.1558 & -1.5885 & ... & -2.8437 & -1.7244 & -0.6113
& -1.3949 & -0.4483 & -0.2445 & -0.9484 & -1.0687 & -0.9104 & 0.1178 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{djia\_sml }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    djia}
\NormalTok{    .loc[}\StringTok{\textquotesingle{}2021{-}02\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2024{-}01\textquotesingle{}}\NormalTok{]}
\NormalTok{    .agg([calc\_ann\_mean, calc\_beta])}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.regplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{djia\_sml,}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}calc\_beta\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}calc\_ann\_mean\textquotesingle{}} 
\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ t, (x, y) }\KeywordTok{in}\NormalTok{ djia\_sml[[}\StringTok{\textquotesingle{}calc\_beta\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}calc\_ann\_mean\textquotesingle{}}\NormalTok{]].iterrows():}
\NormalTok{    plt.annotate(text}\OperatorTok{=}\NormalTok{t, xy}\OperatorTok{=}\NormalTok{(x, y))}
    
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\VerbatimStringTok{r\textquotesingle{}Capital Asset Pricing Model (CAPM) $\textbackslash{}beta$\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}
    \StringTok{\textquotesingle{}Security Market Line (SML) from Dow{-}Jones Stocks}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}} \OperatorTok{+}
    \StringTok{\textquotesingle{}Daily Returns from 2021{-}02 to 2024{-}01\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_04_files/figure-pdf/cell-19-output-1.png}

For single stocks the SML falls apart!

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The slope is negative and we would fail to reject it is flat
\item
  The intercept is above the risk-free rate
\item
  Many stocks plot outside the 95\% confidence interval
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{djia\_sml.corr().loc[}\StringTok{\textquotesingle{}calc\_ann\_mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}calc\_beta\textquotesingle{}}\NormalTok{]}\OperatorTok{**}\DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.0178
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{smf.ols(formula}\OperatorTok{=}\StringTok{\textquotesingle{}calc\_ann\_mean \textasciitilde{} calc\_beta\textquotesingle{}}\NormalTok{, data}\OperatorTok{=}\NormalTok{djia\_sml).fit().rsquared}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.0178
\end{verbatim}

\subsection{Plot the SML for the five portfolios formed on
beta}\label{plot-the-sml-for-the-five-portfolios-formed-on-beta-2}

Download data for portfolios formed on \(\beta\)
(\texttt{Portfolios\_Formed\_on\_BETA}) from Ken French. For the
value-weighted portfolios, plot realized returns versus \(\beta\). These
data should elements \texttt{{[}2{]}} and \texttt{{[}6{]}},
respectively.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_beta }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pdr.DataReader(}
\NormalTok{        name}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolios\_Formed\_on\_BETA\textquotesingle{}}\NormalTok{,}
\NormalTok{        data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{        start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{    )}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(ff\_beta[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Portfolios Formed on BETA
-------------------------

This file was created by CMPT_BETA_RETS using the 202402 CRSP database. It contains value- and equal-weighted returns for portfolios formed on BETA. The portfolios are constructed at the end of June. Beta is estimated using monthly returns for the past 60 months (requiring at least 24 months with non-missing returns). Beta is estimated using the Scholes-Williams method. Annual returns are from January to December. Missing data are indicated by -99.99 or -999. The break points include utilities and include financials. The portfolios include utilities and include financials. Copyright 2024 Kenneth R. French

  0 : Value Weighted Returns -- Monthly (728 rows x 15 cols)
  1 : Equal Weighted Returns -- Monthly (728 rows x 15 cols)
  2 : Value Weighted Returns -- Annual from January to December (60 rows x 15 cols)
  3 : Equal Weighted Returns -- Annual from January to December (60 rows x 15 cols)
  4 : Number of Firms in Portfolios (728 rows x 15 cols)
  5 : Average Firm Size (728 rows x 15 cols)
  6 : Value-Weighted Average of Prior Beta (61 rows x 15 cols)
\end{verbatim}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\530606425.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\530606425.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\530606425.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\530606425.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\530606425.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\530606425.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\530606425.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_beta\_sml }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_beta[}\DecValTok{2}\NormalTok{].iloc[:, :}\DecValTok{5}\NormalTok{] }\CommentTok{\# annual value{-}weighted returns on quintile portfolios}
\NormalTok{    .stack() }\CommentTok{\# convert to long data frame with one column of returns}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{)}
\NormalTok{    .join(}
\NormalTok{        ff\_beta[}\DecValTok{6}\NormalTok{].iloc[:, :}\DecValTok{5}\NormalTok{] }\CommentTok{\# value{-}weighted betas from previous year on quintile portfolios}
\NormalTok{        .stack() }\CommentTok{\# convert to long data frame with one column of betas}
\NormalTok{        .to\_frame(}\StringTok{\textquotesingle{}Beta\textquotesingle{}}\NormalTok{)}
\NormalTok{    )}
\NormalTok{    .rename\_axis(}
\NormalTok{        index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Data\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{],}
\NormalTok{        columns}\OperatorTok{=}\StringTok{\textquotesingle{}Variable\textquotesingle{}}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{ff\_beta\_sml.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& Variable & Return & Beta \\
Data & Portfolio & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{5}{=}{2023} & Lo 20 & 2.3000 & 0.3950 \\
& Qnt 2 & 27.9500 & 0.8710 \\
& Qnt 3 & 26.2600 & 1.1630 \\
& Qnt 4 & 44.3900 & 1.5190 \\
& Hi 20 & 74.7900 & 2.1440 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start }\OperatorTok{=}\NormalTok{ ff\_beta\_sml.index.get\_level\_values(}\DecValTok{0}\NormalTok{).year[}\DecValTok{0}\NormalTok{]}
\NormalTok{stop }\OperatorTok{=}\NormalTok{ ff\_beta\_sml.index.get\_level\_values(}\DecValTok{0}\NormalTok{).year[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}

\NormalTok{sns.regplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{ff\_beta\_sml,}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Beta\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annual Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\VerbatimStringTok{r\textquotesingle{}Capital Asset Pricing Model (CAPM) $\textbackslash{}beta$\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}
    \VerbatimStringTok{r\textquotesingle{}Security Market Line (SML) for $\textbackslash{}beta$ Quintile Portfolios\textquotesingle{}} \OperatorTok{+}
    \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}n}\SpecialStringTok{for Annual Returns from }\SpecialCharTok{\{}\NormalTok{start}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{stop}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_04_files/figure-pdf/cell-24-output-1.png}

\subsection{\texorpdfstring{Estimate the CAPM \(\beta\)s on several
levered and inverse exchange traded funds
(ETFs)}{Estimate the CAPM \textbackslash betas on several levered and inverse exchange traded funds (ETFs)}}\label{estimate-the-capm-betas-on-several-levered-and-inverse-exchange-traded-funds-etfs-2}

Try the following ETFs:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  SPY
\item
  UPRO
\item
  SPXU
\end{enumerate}

Can you determine what these products do from the data alone? Estimate
\(\beta\)s and plot cumulative returns. You may want to pick short
periods of time with large market swings.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{etf\_2 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}SPY UPRO SPXU\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
\NormalTok{    [}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    .pct\_change()}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .dropna()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  3 of 3 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{etf\_2.}\BuiltInTok{apply}\NormalTok{(calc\_beta).rename(}\VerbatimStringTok{r\textquotesingle{}$\textbackslash{}beta$\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Ticker
SPXU   -2.8635
SPY     0.9582
UPRO    2.8790
Name: $\beta$, dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start }\OperatorTok{=}\NormalTok{ etf\_2.index[}\DecValTok{0}\NormalTok{]}
\NormalTok{stop }\OperatorTok{=}\NormalTok{ etf\_2.index[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}

\NormalTok{etf\_2.}\BuiltInTok{apply}\NormalTok{(calc\_beta).plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xticks(rotation}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{plt.ylabel(}\VerbatimStringTok{r\textquotesingle{}Capital Asset Pricing Model (CAPM) $\textbackslash{}beta$\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}
    \VerbatimStringTok{r\textquotesingle{}Capital Asset Pricing Model (CAPM) $\textbackslash{}beta$s\textquotesingle{}} \OperatorTok{+} 
    \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}n}\SpecialStringTok{from Daily Returns from }\SpecialCharTok{\{}\NormalTok{start}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{d }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{stop}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{d }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_04_files/figure-pdf/cell-27-output-1.png}

\subsection{Explore the size factor}\label{explore-the-size-factor-2}

First, we need data for portfolio and factor returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_me }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pdr.DataReader(}
\NormalTok{        name}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolios\_Formed\_on\_ME\textquotesingle{}}\NormalTok{,}
\NormalTok{        data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{        start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{    )}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(ff\_me[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Portfolios Formed on ME
-----------------------

This file was created by CMPT_ME_RETS using the 202402 CRSP database. It contains value- and equal-weighted returns for size portfolios. Each record contains returns for: Negative (not used) 30% 40% 30%   5 Quintiles  10 Deciles The portfolios are constructed at the end of Jun. The annual returns are from January to December. Missing data are indicated by -99.99 or -999. Copyright 2024 Kenneth R. French

  0 : Value Weight Returns -- Monthly (1172 rows x 19 cols)
  1 : Equal Weight Returns -- Monthly (1172 rows x 19 cols)
  2 : Value Weight Returns -- Annual from January to December (97 rows x 19 cols)
  3 : Equal Weight Returns -- Annual from January to December (97 rows x 19 cols)
  4 : Number of Firms in Portfolios (1172 rows x 19 cols)
  5 : Average Firm Size (1172 rows x 19 cols)
\end{verbatim}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\4020728382.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\4020728382.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\4020728382.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\4020728382.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\4020728382.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\4020728382.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_m }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pdr.DataReader(}
\NormalTok{        name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\textquotesingle{}}\NormalTok{,}
\NormalTok{        data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{        start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{    )}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(ff\_m[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
F-F Research Data Factors
-------------------------

This file was created by CMPT_ME_BEME_RETS using the 202402 CRSP database. The 1-month TBill return is from Ibbotson and Associates, Inc. Copyright 2024 Kenneth R. French

  0 : (1172 rows x 4 cols)
  1 : Annual Factors: January-December (97 rows x 4 cols)
\end{verbatim}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\772652417.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\772652417.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_me }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_me[}\DecValTok{1}\NormalTok{]}
\NormalTok{    .iloc[:, }\OperatorTok{{-}}\DecValTok{10}\NormalTok{:]}
\NormalTok{    .join(ff\_m[}\DecValTok{0}\NormalTok{])}
\NormalTok{)}

\NormalTok{df\_me.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllllll@{}}
\toprule\noalign{}
& Lo 10 & Dec 2 & Dec 3 & Dec 4 & Dec 5 & Dec 6 & Dec 7 & Dec 8 & Dec 9
& Hi 10 & Mkt-RF & SMB & HML & RF \\
Date & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2023-10 & -9.3900 & -8.4100 & -7.9700 & -7.5300 & -6.4900 & -5.5100 &
-6.4000 & -6.3600 & -4.6000 & -2.2600 & -3.1900 & -3.8700 & 0.1900 &
0.4700 \\
2023-11 & 6.3000 & 9.0500 & 9.5800 & 9.6400 & 11.8700 & 9.6700 & 9.8400
& 9.6400 & 9.9900 & 9.2700 & 8.8400 & -0.0200 & 1.6400 & 0.4400 \\
2023-12 & 10.8700 & 17.2700 & 14.4800 & 14.2400 & 13.1200 & 12.0000 &
9.1600 & 9.6500 & 7.0000 & 5.5400 & 4.8700 & 6.3400 & 4.9300 & 0.4300 \\
2024-01 & -2.8200 & -5.4600 & -5.8600 & -4.9400 & -5.0700 & -3.1900 &
-2.3800 & -1.2600 & -1.7100 & 1.5900 & 0.7100 & -5.0900 & -2.3800 &
0.4700 \\
2024-02 & 5.5400 & 6.7100 & 4.8000 & 8.1900 & 3.4200 & 4.4400 & 6.3100 &
4.5400 & 5.7900 & 3.7100 & 5.0600 & -0.2400 & -3.4800 & 0.4200 \\
\end{longtable}

\subsubsection{\texorpdfstring{Estimate \(\alpha\)s for the ten
portfolios formed on
size}{Estimate \textbackslash alphas for the ten portfolios formed on size}}\label{estimate-alphas-for-the-ten-portfolios-formed-on-size-2}

Academics started researching size-based portfolios in the early 1980s,
so you may want to focus on the pre-1980 sample.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\OperatorTok{=}\NormalTok{ smf.ols(}
\NormalTok{    formula}\OperatorTok{=}\StringTok{\textquotesingle{}I(Q("Lo 10") {-} RF) \textasciitilde{} Q("Mkt{-}RF")\textquotesingle{}}\NormalTok{,}
\NormalTok{    data}\OperatorTok{=}\NormalTok{df\_me.loc[:}\StringTok{\textquotesingle{}1980\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\NormalTok{fit }\OperatorTok{=}\NormalTok{ mod.fit()}
\NormalTok{fit.summary()}
\end{Highlighting}
\end{Shaded}

\begin{center}
\begin{tabular}{lclc}
\toprule
\textbf{Dep. Variable:}    & I(Q("Lo 10") - RF) & \textbf{  R-squared:         } &     0.541   \\
\textbf{Model:}            &        OLS         & \textbf{  Adj. R-squared:    } &     0.540   \\
\textbf{Method:}           &   Least Squares    & \textbf{  F-statistic:       } &     767.6   \\
\textbf{Date:}             &  Fri, 05 Apr 2024  & \textbf{  Prob (F-statistic):} & 2.92e-112   \\
\textbf{Time:}             &      17:46:28      & \textbf{  Log-Likelihood:    } &   -2343.5   \\
\textbf{No. Observations:} &          654       & \textbf{  AIC:               } &     4691.   \\
\textbf{Df Residuals:}     &          652       & \textbf{  BIC:               } &     4700.   \\
\textbf{Df Model:}         &            1       & \textbf{                     } &             \\
\textbf{Covariance Type:}  &     nonrobust      & \textbf{                     } &             \\
\bottomrule
\end{tabular}
\begin{tabular}{lcccccc}
                     & \textbf{coef} & \textbf{std err} & \textbf{t} & \textbf{P$> |$t$|$} & \textbf{[0.025} & \textbf{0.975]}  \\
\midrule
\textbf{Intercept}   &       0.9161  &        0.343     &     2.669  &         0.008        &        0.242    &        1.590     \\
\textbf{Q("Mkt-RF")} &       1.5976  &        0.058     &    27.706  &         0.000        &        1.484    &        1.711     \\
\bottomrule
\end{tabular}
\begin{tabular}{lclc}
\textbf{Omnibus:}       & 626.765 & \textbf{  Durbin-Watson:     } &     1.970  \\
\textbf{Prob(Omnibus):} &   0.000 & \textbf{  Jarque-Bera (JB):  } & 28924.644  \\
\textbf{Skew:}          &   4.226 & \textbf{  Prob(JB):          } &      0.00  \\
\textbf{Kurtosis:}      &  34.464 & \textbf{  Cond. No.          } &      5.99  \\
\bottomrule
\end{tabular}
%\caption{OLS Regression Results}
\end{center}

Notes: \newline
 [1] Standard Errors assume that the covariance matrix of the errors is correctly specified.

Now, we can use list comprehensions to quickly estimate all ten
\(\alpha\)s.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ports }\OperatorTok{=}\NormalTok{ df\_me.columns.to\_list()[:}\DecValTok{10}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mods }\OperatorTok{=}\NormalTok{ [}
\NormalTok{    smf.ols(formula}\OperatorTok{=}\SpecialStringTok{f\textquotesingle{}I(Q("}\SpecialCharTok{\{}\NormalTok{p}\SpecialCharTok{\}}\SpecialStringTok{") {-} RF) \textasciitilde{} Q("Mkt{-}RF")\textquotesingle{}}\NormalTok{, data}\OperatorTok{=}\NormalTok{df\_me.loc[}\StringTok{\textquotesingle{}1994\textquotesingle{}}\NormalTok{:])}
    \ControlFlowTok{for}\NormalTok{ p}
    \KeywordTok{in}\NormalTok{ ports}
\NormalTok{]}
\NormalTok{fits }\OperatorTok{=}\NormalTok{ [m.fit() }\ControlFlowTok{for}\NormalTok{ m }\KeywordTok{in}\NormalTok{ mods]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{params }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat([f.params }\ControlFlowTok{for}\NormalTok{ f }\KeywordTok{in}\NormalTok{ fits], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{ports, names}\OperatorTok{=}\StringTok{\textquotesingle{}Portolio\textquotesingle{}}\NormalTok{)}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{bses }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat([f.bse }\ControlFlowTok{for}\NormalTok{ f }\KeywordTok{in}\NormalTok{ fits], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{ports, names}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{)}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start }\OperatorTok{=}\NormalTok{ df\_me.loc[:}\StringTok{\textquotesingle{}1980\textquotesingle{}}\NormalTok{].index[}\DecValTok{0}\NormalTok{].to\_timestamp()}
\NormalTok{stop }\OperatorTok{=}\NormalTok{ df\_me.loc[:}\StringTok{\textquotesingle{}1980\textquotesingle{}}\NormalTok{].index[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].to\_timestamp()}

\NormalTok{params[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{].plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{, yerr}\OperatorTok{=}\NormalTok{bses[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{])}

\NormalTok{plt.ylabel(}\VerbatimStringTok{r\textquotesingle{}Monthly CAPM $\textbackslash{}alpha$ (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xticks(rotation}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{plt.title(}
    \VerbatimStringTok{r\textquotesingle{}Size Portfolio Monthly CAPM $\textbackslash{}alpha$s\textquotesingle{}} \OperatorTok{+}
    \StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}} \OperatorTok{+}
    \SpecialStringTok{f\textquotesingle{}from }\SpecialCharTok{\{}\NormalTok{start}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ through }\SpecialCharTok{\{}\NormalTok{stop}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_04_files/figure-pdf/cell-36-output-1.png}

\subsubsection{Are the returns on these ten portfolios formed on size
concentrated in a specific
month?}\label{are-the-returns-on-these-ten-portfolios-formed-on-size-concentrated-in-a-specific-month-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_me\_2 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_me[}\DecValTok{0}\NormalTok{]}
\NormalTok{    .iloc[:, }\OperatorTok{{-}}\DecValTok{10}\NormalTok{:]}
\NormalTok{    .stack()}
\NormalTok{    .rename\_axis(index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{])}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{)}
\NormalTok{    .reset\_index()}
\NormalTok{    .assign(Month}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.where(x[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{].dt.month}\OperatorTok{==}\DecValTok{1}\NormalTok{, }\StringTok{\textquotesingle{}January\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Not January\textquotesingle{}}\NormalTok{))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.barplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{df\_me\_2,}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Month\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{,}
\NormalTok{    hue}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Mean Monthly Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}When Do We Earn Size{-}Effect Returns?\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_04_files/figure-pdf/cell-38-output-1.png}

\subsubsection{Compare the size factor to the market
factor}\label{compare-the-size-factor-to-the-market-factor-2}

You may want to consider mean excess returns by decade. The market and
size excess returns are factors \texttt{Mkt-RF} and \texttt{SMB} in the
Fama-French factors data.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_me\_3 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_m[}\DecValTok{0}\NormalTok{]}
\NormalTok{    [[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}SMB\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .stack()}
\NormalTok{    .rename\_axis(index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Factor\textquotesingle{}}\NormalTok{])}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{)}
\NormalTok{    .reset\_index()}
\NormalTok{    .assign(Decade}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: (x[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{].dt.year }\OperatorTok{//} \DecValTok{10}\NormalTok{ ) }\OperatorTok{*} \DecValTok{10}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.barplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{df\_me\_3,}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Decade\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{,}
\NormalTok{    hue}\OperatorTok{=}\StringTok{\textquotesingle{}Factor\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Monthly Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Comparison on Market and Small Stock Risk Premia\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_04_files/figure-pdf/cell-40-output-1.png}

SMB rarely generates outsize returns later in the sample.

\subsection{Repeat the exercises above with the value
factor}\label{repeat-the-exercises-above-with-the-value-factor-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_be\_me }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolios\_Formed\_on\_BE{-}ME\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(ff\_me[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Portfolios Formed on ME
-----------------------

This file was created by CMPT_ME_RETS using the 202402 CRSP database. It contains value- and equal-weighted returns for size portfolios. Each record contains returns for: Negative (not used) 30% 40% 30%   5 Quintiles  10 Deciles The portfolios are constructed at the end of Jun. The annual returns are from January to December. Missing data are indicated by -99.99 or -999. Copyright 2024 Kenneth R. French

  0 : Value Weight Returns -- Monthly (1172 rows x 19 cols)
  1 : Equal Weight Returns -- Monthly (1172 rows x 19 cols)
  2 : Value Weight Returns -- Annual from January to December (97 rows x 19 cols)
  3 : Equal Weight Returns -- Annual from January to December (97 rows x 19 cols)
  4 : Number of Firms in Portfolios (1172 rows x 19 cols)
  5 : Average Firm Size (1172 rows x 19 cols)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_be\_me }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_be\_me[}\DecValTok{1}\NormalTok{]}
\NormalTok{    .iloc[:, }\OperatorTok{{-}}\DecValTok{10}\NormalTok{:]}
\NormalTok{    .join(ff\_m[}\DecValTok{0}\NormalTok{])}
\NormalTok{)}

\NormalTok{df\_be\_me.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllllll@{}}
\toprule\noalign{}
& Lo 10 & Dec 2 & Dec 3 & Dec 4 & Dec 5 & Dec 6 & Dec 7 & Dec 8 & Dec 9
& Hi 10 & Mkt-RF & SMB & HML & RF \\
Date & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2023-10 & -7.6200 & -6.5300 & -8.4300 & -7.7500 & -7.0200 & -7.0800 &
-6.1800 & -7.0600 & -7.6800 & -8.4300 & -3.1900 & -3.8700 & 0.1900 &
0.4700 \\
2023-11 & 9.8800 & 9.8900 & 8.5700 & 7.1800 & 11.5300 & 13.6400 & 8.7100
& 10.5800 & 6.4300 & 6.6500 & 8.8400 & -0.0200 & 1.6400 & 0.4400 \\
2023-12 & 9.8700 & 9.2100 & 15.0800 & 11.0000 & 9.7200 & 11.9100 &
14.2700 & 14.1400 & 13.9600 & 13.2000 & 4.8700 & 6.3400 & 4.9300 &
0.4300 \\
2024-01 & -4.0000 & -1.3500 & -3.4800 & -3.2100 & -4.5000 & -3.5100 &
-3.3800 & -4.4200 & -3.6400 & -0.4200 & 0.7100 & -5.0900 & -2.3800 &
0.4700 \\
2024-02 & 6.1900 & 7.6000 & 7.2500 & 5.2900 & 7.5200 & 7.6200 & 3.3800 &
3.3400 & 1.7400 & 7.2900 & 5.0600 & -0.2400 & -3.4800 & 0.4200 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ports }\OperatorTok{=}\NormalTok{ df\_be\_me.columns.to\_list()[:}\DecValTok{10}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mods }\OperatorTok{=}\NormalTok{ [}
\NormalTok{    smf.ols(formula}\OperatorTok{=}\SpecialStringTok{f\textquotesingle{}I(Q("}\SpecialCharTok{\{}\NormalTok{p}\SpecialCharTok{\}}\SpecialStringTok{") {-} RF) \textasciitilde{} Q("Mkt{-}RF")\textquotesingle{}}\NormalTok{, data}\OperatorTok{=}\NormalTok{df\_be\_me)}
    \ControlFlowTok{for}
\NormalTok{    p }\KeywordTok{in}\NormalTok{ ports}
\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fits }\OperatorTok{=}\NormalTok{ [m.fit() }\ControlFlowTok{for}\NormalTok{ m }\KeywordTok{in}\NormalTok{ mods]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{params }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat([f.params }\ControlFlowTok{for}\NormalTok{ f }\KeywordTok{in}\NormalTok{ fits], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{ports, names}\OperatorTok{=}\StringTok{\textquotesingle{}Portolio\textquotesingle{}}\NormalTok{)}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{bses }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat([f.bse }\ControlFlowTok{for}\NormalTok{ f }\KeywordTok{in}\NormalTok{ fits], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{ports, names}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{)}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start }\OperatorTok{=}\NormalTok{ df\_be\_me.index[}\DecValTok{0}\NormalTok{].to\_timestamp()}
\NormalTok{stop }\OperatorTok{=}\NormalTok{ df\_be\_me.index[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].to\_timestamp()}

\NormalTok{params[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{].plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{, yerr}\OperatorTok{=}\NormalTok{bses[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{])}

\NormalTok{plt.ylabel(}\VerbatimStringTok{r\textquotesingle{}Monthly CAPM $\textbackslash{}alpha$ (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xticks(rotation}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{plt.title(}
    \VerbatimStringTok{r\textquotesingle{}BE/ME Portfolio Monthly CAPM $\textbackslash{}alpha$s\textquotesingle{}} \OperatorTok{+}
    \StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}} \OperatorTok{+}
    \SpecialStringTok{f\textquotesingle{}from }\SpecialCharTok{\{}\NormalTok{start}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ through }\SpecialCharTok{\{}\NormalTok{stop}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_04_files/figure-pdf/cell-49-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_be\_me\_3 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_m[}\DecValTok{0}\NormalTok{]}
\NormalTok{    [[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}HML\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .stack()}
\NormalTok{    .rename\_axis(index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Factor\textquotesingle{}}\NormalTok{])}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{)}
\NormalTok{    .reset\_index()}
\NormalTok{    .assign(Decade}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: (x[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{].dt.year }\OperatorTok{//} \DecValTok{10}\NormalTok{ ) }\OperatorTok{*} \DecValTok{10}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.barplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{df\_be\_me\_3,}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Decade\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{,}
\NormalTok{    hue}\OperatorTok{=}\StringTok{\textquotesingle{}Factor\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Monthly Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Comparison on Market and Value Stock Risk Premia\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_04_files/figure-pdf/cell-51-output-1.png}

\subsection{Repeat the exercises above with the momentum
factor}\label{repeat-the-exercises-above-with-the-momentum-factor-2}

You may find it helpful to consider the worst months and years for the
momentum factor.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_mom }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}10\_Portfolios\_Prior\_12\_2\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\2097656781.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\2097656781.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\2097656781.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\2097656781.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\2097656781.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\2097656781.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\2097656781.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(ff\_mom[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
10 Portfolios Prior 12 2
------------------------

This file was created by CMPT_PRIOR_RETS using the 202402 CRSP database. It contains value- and equal-weighted returns for 10 prior-return portfolios. The portfolios are constructed monthly. PRIOR_RET is from -12 to - 2. The annual returns are from January to December. Missing data are indicated by -99.99 or -999.

  0 : Average Value Weighted Returns -- Monthly (1166 rows x 10 cols)
  1 : Average Equal Weighted Returns -- Monthly (1166 rows x 10 cols)
  2 : Average Value Weighted Returns -- Annual (97 rows x 10 cols)
  3 : Average Equal Weighted Returns -- Annual (97 rows x 10 cols)
  4 : Number of Firms in Portfolios (1166 rows x 10 cols)
  5 : Average Firm Size (1166 rows x 10 cols)
  6 : Value-Weighted Average of Prior Returns (97 rows x 10 cols)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_mom }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_mom[}\DecValTok{1}\NormalTok{]}
\NormalTok{    .iloc[:, }\OperatorTok{{-}}\DecValTok{10}\NormalTok{:]}
\NormalTok{    .join(ff\_m[}\DecValTok{0}\NormalTok{])}
\NormalTok{)}

\NormalTok{df\_mom.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllllll@{}}
\toprule\noalign{}
& Lo PRIOR & PRIOR 2 & PRIOR 3 & PRIOR 4 & PRIOR 5 & PRIOR 6 & PRIOR 7 &
PRIOR 8 & PRIOR 9 & Hi PRIOR & Mkt-RF & SMB & HML & RF \\
Date & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2023-10 & -11.8200 & -8.0400 & -5.4700 & -4.4900 & -5.6900 & -4.9900 &
-4.7800 & -6.1700 & -6.4800 & -8.7700 & -3.1900 & -3.8700 & 0.1900 &
0.4700 \\
2023-11 & 7.8000 & 8.7100 & 7.1900 & 8.1500 & 7.7400 & 5.3800 & 8.0100 &
9.9700 & 10.4500 & 12.3300 & 8.8400 & -0.0200 & 1.6400 & 0.4400 \\
2023-12 & 14.9500 & 13.2800 & 14.0100 & 11.9000 & 10.5300 & 9.3300 &
6.5900 & 6.7600 & 8.4100 & 13.2100 & 4.8700 & 6.3400 & 4.9300 &
0.4300 \\
2024-01 & -6.8900 & -5.0200 & -3.9900 & -2.2500 & -2.3300 & -2.4100 &
-0.9400 & 0.0400 & -0.3900 & -0.6600 & 0.7100 & -5.0900 & -2.3800 &
0.4700 \\
2024-02 & 8.2200 & 3.9100 & 2.6200 & 2.4500 & 2.0900 & 3.8600 & 4.3500 &
5.4000 & 6.0200 & 10.5000 & 5.0600 & -0.2400 & -3.4800 & 0.4200 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ports }\OperatorTok{=}\NormalTok{ df\_mom.columns.to\_list()[:}\DecValTok{10}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mods }\OperatorTok{=}\NormalTok{ [}
\NormalTok{    smf.ols(formula}\OperatorTok{=}\SpecialStringTok{f\textquotesingle{}I(Q("}\SpecialCharTok{\{}\NormalTok{p}\SpecialCharTok{\}}\SpecialStringTok{") {-} RF) \textasciitilde{} Q("Mkt{-}RF")\textquotesingle{}}\NormalTok{, data}\OperatorTok{=}\NormalTok{df\_mom.loc[:}\StringTok{\textquotesingle{}1980\textquotesingle{}}\NormalTok{])}
    \ControlFlowTok{for}
\NormalTok{    p }\KeywordTok{in}\NormalTok{ ports}
\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fits }\OperatorTok{=}\NormalTok{ [m.fit() }\ControlFlowTok{for}\NormalTok{ m }\KeywordTok{in}\NormalTok{ mods]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{params }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat([f.params }\ControlFlowTok{for}\NormalTok{ f }\KeywordTok{in}\NormalTok{ fits], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{ports, names}\OperatorTok{=}\StringTok{\textquotesingle{}Portolio\textquotesingle{}}\NormalTok{)}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{bses }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat([f.bse }\ControlFlowTok{for}\NormalTok{ f }\KeywordTok{in}\NormalTok{ fits], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{ports, names}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{)}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start }\OperatorTok{=}\NormalTok{ df\_mom.loc[:}\StringTok{\textquotesingle{}1980\textquotesingle{}}\NormalTok{].index[}\DecValTok{0}\NormalTok{].to\_timestamp()}
\NormalTok{stop }\OperatorTok{=}\NormalTok{ df\_mom.loc[:}\StringTok{\textquotesingle{}1980\textquotesingle{}}\NormalTok{].index[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].to\_timestamp()}

\NormalTok{params[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{].plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{, yerr}\OperatorTok{=}\NormalTok{bses[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{])}

\NormalTok{plt.ylabel(}\VerbatimStringTok{r\textquotesingle{}Monthly CAPM $\textbackslash{}alpha$ (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}
    \VerbatimStringTok{r\textquotesingle{}Momentum Portfolio Monthly CAPM $\textbackslash{}alpha$s\textquotesingle{}} \OperatorTok{+}
    \StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}} \OperatorTok{+}
    \SpecialStringTok{f\textquotesingle{}from }\SpecialCharTok{\{}\NormalTok{start}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ through }\SpecialCharTok{\{}\NormalTok{stop}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_04_files/figure-pdf/cell-60-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_mom }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Momentum\_Factor\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}

\NormalTok{ff\_mom[}\DecValTok{0}\NormalTok{].columns }\OperatorTok{=}\NormalTok{ [c.strip() }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ ff\_mom[}\DecValTok{0}\NormalTok{].columns]}
\NormalTok{ff\_mom[}\DecValTok{0}\NormalTok{].tail()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\1313848978.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\1313848978.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
\end{verbatim}

\begin{longtable}[]{@{}ll@{}}
\toprule\noalign{}
& Mom \\
Date & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2023-10 & 1.7300 \\
2023-11 & 2.7500 \\
2023-12 & -5.5100 \\
2024-01 & 5.1800 \\
2024-02 & 4.9200 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_mom\_3 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_m[}\DecValTok{0}\NormalTok{].join(ff\_mom[}\DecValTok{0}\NormalTok{])}
\NormalTok{    [[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Mom\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .stack()}
\NormalTok{    .rename\_axis(index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Factor\textquotesingle{}}\NormalTok{])}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{)}
\NormalTok{    .reset\_index()}
\NormalTok{    .assign(Decade}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: (x[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{].dt.year }\OperatorTok{//} \DecValTok{10}\NormalTok{ ) }\OperatorTok{*} \DecValTok{10}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.barplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{df\_mom\_3,}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Decade\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{,}
\NormalTok{    hue}\OperatorTok{=}\StringTok{\textquotesingle{}Factor\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Monthly Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Comparison on Market and Value Stock Risk Premia\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_04_files/figure-pdf/cell-63-output-1.png}

\subsection{Plot the coefficient estimates from a rolling Fama-French
three-factor model for Berkshire
Hathaway}\label{plot-the-coefficient-estimates-from-a-rolling-fama-french-three-factor-model-for-berkshire-hathaway-2}

Use a three-year window with daily returns. How has Buffett's \(\alpha\)
and \(\beta\)s changed over the past four decades?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{brk }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}BRK{-}A\textquotesingle{}}\NormalTok{)}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{])}
\NormalTok{    .assign(r}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].pct\_change().mul(}\DecValTok{100}\NormalTok{))}
\NormalTok{    .dropna()}
\NormalTok{    .join(}
\NormalTok{        pdr.DataReader(}
\NormalTok{            name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{            data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{            start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{        )[}\DecValTok{0}\NormalTok{],}
\NormalTok{        how}\OperatorTok{=}\StringTok{\textquotesingle{}inner\textquotesingle{}}
\NormalTok{    )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  1 of 1 completed
C:\Users\r.herron\AppData\Local\Temp\ipykernel_27860\2930704642.py:8: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{from}\NormalTok{ statsmodels.regression.rolling }\ImportTok{import}\NormalTok{ RollingOLS}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{coefs }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    RollingOLS.from\_formula(}
\NormalTok{        formula}\OperatorTok{=}\StringTok{\textquotesingle{}I(r{-}RF) \textasciitilde{} Q("Mkt{-}RF") + SMB + HML\textquotesingle{}}\NormalTok{,}
\NormalTok{        data}\OperatorTok{=}\NormalTok{brk,}
\NormalTok{        window}\OperatorTok{=}\DecValTok{3}\OperatorTok{*}\DecValTok{252}
\NormalTok{    )}
\NormalTok{    .fit()}
\NormalTok{    .params}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Coefficient\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}Q("Mkt{-}RF")\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{\})}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fig, ax }\OperatorTok{=}\NormalTok{ plt.subplots(}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, sharex}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{coefs[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{].plot(ax}\OperatorTok{=}\NormalTok{ax[}\DecValTok{0}\NormalTok{], legend}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{coefs.drop(}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{, axis}\OperatorTok{=}\DecValTok{1}\NormalTok{).plot(ax}\OperatorTok{=}\NormalTok{ax[}\DecValTok{1}\NormalTok{])}
\NormalTok{plt.suptitle(}
    \StringTok{\textquotesingle{}Rolling Three{-}Factor Regressions\textquotesingle{}} \OperatorTok{+}
    \StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n}\StringTok{Three{-}Year Windows with Daily Returns in Percent\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_04_files/figure-pdf/cell-67-output-1.png}

Buffett's \(\alpha\) was large, but has declined to zero. Also, his
loading on SMB (size factor) has gone from positive to negative,
indicating that he has moved from small stocks to large stocks as
Berkshire Hathaway has grown.

\chapter{Herron Topic 3 - Practice for Section
05}\label{herron-topic-3---practice-for-section-05}

\section{Announcements}\label{announcements-39}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  We will make a few changes to give us more time to work on Project 3:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    We will drop Herron Topic 5 on simulations during Week 14 and use
    this time for group work
  \item
    I will finalize Project 3 by Thursday, 4/4, so we have about 3 week
    to work on it before the Tuesday, 4/23, due date
  \end{enumerate}
\item
  \textbf{\emph{Next Thursday and Friday, 4/11 and 4/12, we will take
  the MSFQ assessment exam in class. I do not control this exam, and
  there are a few conditions:}}

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    \textbf{\emph{Open book}}
  \item
    \textbf{\emph{On Canvas}}
  \item
    \textbf{\emph{In the classroom}}
  \end{enumerate}
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-38}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The Capital Asset Pricing Model (CAPM) estimates asset \(i\)'s
  expected return as \(E(r_i) = r_f + \beta_i [E(r_M) - r_f]\), where:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    \(r_f\) is the risk-free rate
  \item
    \(\beta_i\) is asset \(i\)'s systematic risk
  \item
    \(E(r_M) - r_f\) is the market risk premium
  \end{enumerate}
\item
  The Security Market Line (SML) visualizes the CAPM

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Plots \(E(r_i)\) on the y axis against \(\beta_i\) on the x axis
  \item
    The slope of the SML is the market risk premium \(E(r_M) - r_f\)
  \item
    The intercept of the SML is the risk-free rate \(r_f\)
  \end{enumerate}
\item
  We can estimate asset \(i\)'s systematic risk a few ways:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    \(\beta_i = \frac{Cov(r_i-r_f, r_M-r_f)}{Var(r_M-r_f)}\)
  \item
    \(\beta_i = Corr(r_i-r_f, r_M-r_f) \frac{Std(r_i-r_f)}{Std(r_M-r_f)}\)
  \item
    Estimate the linear regression
    \(r_i - r_f = \alpha_i + \beta_i [r_M - r_f] + \varepsilon_i\) with
    the \texttt{smf.ols()} function after we
    \texttt{import\ statsmodels.formula.api\ as\ smf}
  \item
    We will follow Bodie, Kane, and Marcus's syntax where a \(r\) is a
    raw return and a \(R\) is an excess return, so \(R_i = r_i - r_f\)
  \end{enumerate}
\item
  The CAPM is the foundation of modern finance and does well for single
  periods but has a few shortcomings:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Does poorly over multiple periods
  \item
    The SML is ``too flat'' empirically, and high \(\beta\) assets tend
    to have lower returns than expected
  \item
    Does explain the returns on several factors, like size, value, and
    momentum
  \end{enumerate}
\item
  The Fama-French 3-factor model---and many others---attempts to solves
  these shortcomings and is useful for evaluating fund manager
  performance
\end{enumerate}

\section{Practice}\label{practice-39}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ seaborn }\ImportTok{as}\NormalTok{ sns}
\ImportTok{import}\NormalTok{ statsmodels.formula.api }\ImportTok{as}\NormalTok{ smf}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{Plot the security market line (SML) for a variety of asset
classes}\label{plot-the-security-market-line-sml-for-a-variety-of-asset-classes-3}

Use the past three years of daily data for the following exhange traded
funds (ETFs):

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  SPY (SPDR---Standard and Poor's Depository Receipts---ETF for the S\&P
  500 index)
\item
  BIL (SPDR ETF for 1-3 month Treasury bills)
\item
  GLD (SPDR ETF for gold)
\item
  JNK (SPDR ETF for high-yield debt)
\item
  MDY (SPDR ETF for S\&P 400 mid-cap index)
\item
  SLY (SPDR ETF for S\&P 600 small-cap index)
\item
  SPBO (SPDR ETF for corporate bonds)
\item
  SPMB (SPDR ETF for mortgage-backed securities)
\item
  SPTL (SPDR ETF for long-term Treasury bonds)
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tickers }\OperatorTok{=} \StringTok{\textquotesingle{}SPY BIL GLD JNK MDY SLY SPBO SPMB SPTL\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

For multifactor models, we generally leave returns in percents. Slope
coefficient estimates (i.e., \(\beta\)s) are the same for decimal and
percent returns. Intercept coefficient estimates (i.e., \(\alpha\)s) are
easier to interpret in percents than in decimals because small percent
returns have two fewer zeros than small decimal returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{etf }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\NormalTok{tickers)}
\NormalTok{    [}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    .pct\_change()}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{)}

\NormalTok{etf.tail()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  9 of 9 completed
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\1015031953.py:5: FutureWarning: The default fill_method='pad' in DataFrame.pct_change is deprecated and will be removed in a future version. Either fill in any non-leading NA values prior to calling pct_change or specify 'fill_method=None' to not fill NA values.
  .pct_change()
\end{verbatim}

\begin{longtable}[]{@{}llllllllll@{}}
\toprule\noalign{}
& BIL & GLD & JNK & MDY & SLY & SPBO & SPMB & SPTL & SPY \\
Date & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-03-28 & 0.0000 & 1.2900 & -0.1573 & 0.3589 & 0.0000 & -0.0687 &
-0.2297 & 0.0000 & -0.0191 \\
2024-04-01 & 0.0273 & 1.0208 & -0.4974 & -0.7225 & 0.0000 & -0.7728 &
-0.7249 & -1.8024 & -0.1740 \\
2024-04-02 & 0.0219 & 1.4772 & -0.1910 & -1.2799 & 0.0000 & -0.1391 &
-0.0930 & -0.4022 & -0.6358 \\
2024-04-03 & 0.0000 & 0.8772 & 0.0532 & 0.3998 & 0.0000 & 0.0696 &
0.0466 & -0.1101 & 0.1099 \\
2024-04-04 & 0.0437 & -0.5735 & -0.1382 & -1.0594 & 0.0000 & 0.1392 &
0.3257 & 0.6983 & -1.2206 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pdr.DataReader(}
\NormalTok{        name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{        data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{        start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{    )}
\NormalTok{    [}\DecValTok{0}\NormalTok{]}
\NormalTok{)}

\NormalTok{ff.tail()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\3487692931.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{longtable}[]{@{}lllll@{}}
\toprule\noalign{}
& Mkt-RF & SMB & HML & RF \\
Date & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-02-23 & 0.0200 & 0.2800 & -0.0300 & 0.0210 \\
2024-02-26 & -0.2600 & 1.0000 & -0.1100 & 0.0210 \\
2024-02-27 & 0.2700 & 1.1900 & -0.4500 & 0.0210 \\
2024-02-28 & -0.2600 & -0.8500 & 0.0000 & 0.0210 \\
2024-02-29 & 0.5400 & -0.3400 & 0.9800 & 0.0210 \\
\end{longtable}

We will write two helper functions to make it easier to calculate
annualized mean returns and CAPM betas. We will pass these function
names to the pandas \texttt{.agg()} method, which applies these
functions to every column and combines the results.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_ann\_mean(ri, ann\_fac}\OperatorTok{=}\DecValTok{252}\NormalTok{):}
    \ControlFlowTok{return}\NormalTok{ ri.mean() }\OperatorTok{*}\NormalTok{ ann\_fac}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_beta(ri, rf}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], RM}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{]):}
\NormalTok{    Ri }\OperatorTok{=}\NormalTok{ ri.sub(rf).dropna()}
    \ControlFlowTok{return}\NormalTok{ Ri.cov(RM) }\OperatorTok{/}\NormalTok{ RM.loc[Ri.index].var()}
\end{Highlighting}
\end{Shaded}

We should estimate CAPM betas from one-year to three-years of daily
returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{etf\_sml }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    etf}
\NormalTok{    .loc[}\StringTok{\textquotesingle{}2021{-}02\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2024{-}01\textquotesingle{}}\NormalTok{]}
\NormalTok{    .agg([calc\_ann\_mean, calc\_beta])}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The \texttt{regplot()} function in the seaborn package plots a
scatterplot and adds a best-fit line with 95\% confidence interval.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.regplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{etf\_sml,}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}calc\_beta\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}calc\_ann\_mean\textquotesingle{}}
\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ t, (x, y) }\KeywordTok{in}\NormalTok{ etf\_sml[[}\StringTok{\textquotesingle{}calc\_beta\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}calc\_ann\_mean\textquotesingle{}}\NormalTok{]].iterrows():}
\NormalTok{    plt.annotate(text}\OperatorTok{=}\NormalTok{t, xy}\OperatorTok{=}\NormalTok{(x, y))}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\VerbatimStringTok{r\textquotesingle{}Capital Asset Pricing Model (CAPM) $\textbackslash{}beta$\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}
    \StringTok{\textquotesingle{}Security Market Line (SML) from Exchange Traded Funds (ETFs)}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}} \OperatorTok{+}
    \StringTok{\textquotesingle{}Daily Returns from 2021{-}02 to 2024{-}01\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_05_files/figure-pdf/cell-10-output-1.png}

\textbf{\emph{We see the CAPM and SML work well for asset classes!}} The
slope is positive, the intercept is a reasonable risk-free rate, and
assets plot along the SML, most within the 95\% confidence interval.
Note that a few fixed-income ETFs have negative mean returns, but the
SML still has the shape and fit we expect by theory.

The fit above is not perfect, but the \(R^2\) is fairly high at around
50\%. For a single-factor regression, we can quickly calculate \(R^2\)
as \(\rho^2\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{etf\_sml.corr().loc[}\StringTok{\textquotesingle{}calc\_ann\_mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}calc\_beta\textquotesingle{}}\NormalTok{]}\OperatorTok{**}\DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.5086
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{smf.ols(formula}\OperatorTok{=}\StringTok{\textquotesingle{}calc\_ann\_mean \textasciitilde{} calc\_beta\textquotesingle{}}\NormalTok{, data}\OperatorTok{=}\NormalTok{etf\_sml).fit().rsquared}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.5086
\end{verbatim}

\subsection{Plot the SML for the Dow Jones Industrial Average (DJIA)
stocks}\label{plot-the-sml-for-the-dow-jones-industrial-average-djia-stocks-3}

Use the past three years of daily returns data for the stocks listed on
the
\href{https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average}{DJIA
Wikipedia page}. Compare the DJIA SML to the asset class SML above.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tickers }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.read\_html(}\StringTok{\textquotesingle{}https://en.wikipedia.org/wiki/Dow\_Jones\_Industrial\_Average\textquotesingle{}}\NormalTok{)}
\NormalTok{    [}\DecValTok{1}\NormalTok{]}
\NormalTok{    [}\StringTok{\textquotesingle{}Symbol\textquotesingle{}}\NormalTok{]}
\NormalTok{    .to\_list()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{djia }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\NormalTok{tickers)}
\NormalTok{    [}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    .pct\_change()}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{)}

\NormalTok{djia.tail()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  30 of 30 completed
\end{verbatim}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
& AAPL & AMGN & AMZN & AXP & BA & CAT & CRM & CSCO & CVX & DIS & ... &
MMM & MRK & MSFT & NKE & PG & TRV & UNH & V & VZ & WMT \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-03-28 & -1.0559 & -0.6916 & 0.3058 & -0.0263 & 0.5418 & 0.4881 &
-0.0664 & 0.2813 & 0.8890 & 1.1407 & ... & 1.4150 & 0.1518 & -0.1685 &
-0.1593 & -0.2214 & 0.5725 & 0.3245 & 0.0215 & 1.0111 & -0.9058 \\
2024-04-01 & -0.8456 & -0.4502 & 0.3271 & -0.0351 & -1.8084 & -0.7341 &
0.3586 & 0.2605 & 0.8495 & -0.6783 & ... & 6.0129 & -0.7275 & 0.9151 &
-1.5110 & -1.0293 & -0.8603 & -1.0107 & -0.2867 & 0.7626 & -0.2825 \\
2024-04-02 & -0.6999 & -2.4131 & -0.1547 & -0.9138 & -0.7705 & 0.2997 &
0.5757 & -1.3589 & 0.4400 & 1.0615 & ... & -1.2551 & -0.4886 & -0.7372 &
-1.7394 & -0.0062 & -0.1359 & -6.4448 & 0.0575 & 0.6150 & -1.4000 \\
2024-04-03 & 0.4797 & -0.6480 & 0.9519 & 0.4877 & -1.6592 & 3.0041 &
0.2434 & -0.4493 & 0.4131 & -3.1265 & ... & 0.3770 & -0.3452 & -0.2349 &
-0.6817 & -2.7527 & 0.5310 & 0.3492 & -0.5315 & 0.7052 & 0.4564 \\
2024-04-04 & -0.4892 & -2.3067 & -1.3212 & -2.8062 & -0.8815 & -1.5966 &
-3.4784 & -1.2926 & 0.1558 & -1.5885 & ... & -2.8437 & -1.7244 & -0.6113
& -1.3949 & -0.4483 & -0.2445 & -0.9484 & -1.0687 & -0.9104 & 0.1178 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{djia\_sml }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    djia}
\NormalTok{    .loc[}\StringTok{\textquotesingle{}2021{-}02\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2024{-}01\textquotesingle{}}\NormalTok{]}
\NormalTok{    .agg([calc\_ann\_mean, calc\_beta])}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.regplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{djia\_sml,}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}calc\_beta\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}calc\_ann\_mean\textquotesingle{}}
\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ t, (x, y) }\KeywordTok{in}\NormalTok{ djia\_sml[[}\StringTok{\textquotesingle{}calc\_beta\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}calc\_ann\_mean\textquotesingle{}}\NormalTok{]].iterrows():}
\NormalTok{    plt.annotate(text}\OperatorTok{=}\NormalTok{t, xy}\OperatorTok{=}\NormalTok{(x, y))}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Daily Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\VerbatimStringTok{r\textquotesingle{}Capital Asset Pricing Model (CAPM) $\textbackslash{}beta$\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}
    \StringTok{\textquotesingle{}Security Market Line (SML) from Dow{-}Jones Stocks}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}} \OperatorTok{+}
    \StringTok{\textquotesingle{}Daily Returns from 2021{-}02 to 2024{-}01\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_05_files/figure-pdf/cell-16-output-1.png}

For single stocks the SML falls apart!

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The slope is negative and we would fail to reject it is flat
\item
  The intercept is above the risk-free rate
\item
  Many stocks plot outside the 95\% confidence interval
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{djia\_sml.corr().loc[}\StringTok{\textquotesingle{}calc\_ann\_mean\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}calc\_beta\textquotesingle{}}\NormalTok{]}\OperatorTok{**}\DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.0178
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{smf.ols(formula}\OperatorTok{=}\StringTok{\textquotesingle{}calc\_ann\_mean \textasciitilde{} calc\_beta\textquotesingle{}}\NormalTok{, data}\OperatorTok{=}\NormalTok{djia\_sml).fit().rsquared}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.0178
\end{verbatim}

\subsection{Plot the SML for the five portfolios formed on
beta}\label{plot-the-sml-for-the-five-portfolios-formed-on-beta-3}

Download data for portfolios formed on \(\beta\)
(\texttt{Portfolios\_Formed\_on\_BETA}) from Ken French. For the
value-weighted portfolios, plot realized returns versus \(\beta\). These
data should elements \texttt{{[}2{]}} and \texttt{{[}6{]}},
respectively.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_beta }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pdr.DataReader(}
\NormalTok{        name}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolios\_Formed\_on\_BETA\textquotesingle{}}\NormalTok{,}
\NormalTok{        data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{        start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{    )}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(ff\_beta[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\530606425.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\530606425.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\530606425.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\530606425.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\530606425.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\530606425.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\530606425.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{verbatim}
Portfolios Formed on BETA
-------------------------

This file was created by CMPT_BETA_RETS using the 202402 CRSP database. It contains value- and equal-weighted returns for portfolios formed on BETA. The portfolios are constructed at the end of June. Beta is estimated using monthly returns for the past 60 months (requiring at least 24 months with non-missing returns). Beta is estimated using the Scholes-Williams method. Annual returns are from January to December. Missing data are indicated by -99.99 or -999. The break points include utilities and include financials. The portfolios include utilities and include financials. Copyright 2024 Kenneth R. French

  0 : Value Weighted Returns -- Monthly (728 rows x 15 cols)
  1 : Equal Weighted Returns -- Monthly (728 rows x 15 cols)
  2 : Value Weighted Returns -- Annual from January to December (60 rows x 15 cols)
  3 : Equal Weighted Returns -- Annual from January to December (60 rows x 15 cols)
  4 : Number of Firms in Portfolios (728 rows x 15 cols)
  5 : Average Firm Size (728 rows x 15 cols)
  6 : Value-Weighted Average of Prior Beta (61 rows x 15 cols)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_beta[}\DecValTok{2}\NormalTok{].tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllll@{}}
\toprule\noalign{}
& Lo 20 & Qnt 2 & Qnt 3 & Qnt 4 & Hi 20 & Lo 10 & Dec 2 & Dec 3 & Dec 4
& Dec 5 & Dec 6 & Dec 7 & Dec 8 & Dec 9 & Hi 10 \\
Date & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2019 & 27.1700 & 29.7200 & 30.1300 & 37.7300 & 31.6700 & 27.8100 &
26.5400 & 28.8400 & 30.7600 & 30.0200 & 30.2900 & 33.0000 & 41.3000 &
28.7000 & 41.1800 \\
2020 & 5.2800 & 12.3500 & 45.0300 & 41.5800 & 45.3000 & 2.9800 & 7.1300
& 12.4400 & 12.6900 & 38.0200 & 45.4700 & 13.9200 & 61.3100 & 23.5400 &
87.7700 \\
2021 & 18.5600 & 28.8500 & 13.8500 & 48.5000 & 26.7600 & 18.1400 &
19.3500 & 26.8400 & 31.5400 & 20.1300 & 9.4100 & 54.1100 & 29.8300 &
40.4500 & -2.0900 \\
2022 & -7.2500 & -20.8600 & -14.8000 & -24.5900 & -39.7300 & -0.6100 &
-10.9100 & -9.2800 & -29.0900 & -8.6400 & -21.0600 & -24.3400 & -20.7500
& -29.0300 & -50.7600 \\
2023 & 2.3000 & 27.9500 & 26.2600 & 44.3900 & 74.7900 & 3.8800 & 0.9900
& 14.1500 & 36.4700 & 28.8700 & 24.4100 & 41.0000 & 46.7500 & 85.9800 &
59.7000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_beta[}\DecValTok{6}\NormalTok{].tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllll@{}}
\toprule\noalign{}
& Lo 20 & Qnt 2 & Qnt 3 & Qnt 4 & Hi 20 & Lo 10 & Dec 2 & Dec 3 & Dec 4
& Dec 5 & Dec 6 & Dec 7 & Dec 8 & Dec 9 & Hi 10 \\
Date & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2019 & 0.2410 & 0.7710 & 1.1210 & 1.5020 & 2.2040 & -0.0220 & 0.4350 &
0.6920 & 0.8520 & 1.0570 & 1.1920 & 1.3870 & 1.5870 & 1.8800 & 2.8550 \\
2020 & 0.4320 & 0.9340 & 1.3400 & 1.6880 & 2.4090 & 0.2190 & 0.6040 &
0.8550 & 1.0360 & 1.2250 & 1.4090 & 1.5950 & 1.7960 & 2.1030 & 2.8770 \\
2021 & 0.4600 & 0.8940 & 1.2690 & 1.6290 & 2.4640 & 0.1880 & 0.6030 &
0.8120 & 0.9850 & 1.1850 & 1.3520 & 1.5750 & 1.7970 & 2.2080 & 3.0420 \\
2022 & 0.3740 & 0.8670 & 1.1530 & 1.5230 & 2.2120 & 0.2240 & 0.5020 &
0.7560 & 0.9260 & 1.0650 & 1.2230 & 1.3900 & 1.6010 & 1.9220 & 2.5190 \\
2023 & 0.3950 & 0.8710 & 1.1630 & 1.5190 & 2.1440 & 0.2260 & 0.5320 &
0.7710 & 0.9380 & 1.1010 & 1.2400 & 1.4040 & 1.5700 & 1.9460 & 2.4110 \\
\end{longtable}

We will combine the annual value-weighted returns data in
\texttt{ff\_beta{[}2{]}} with the value-weighted beta data in
\texttt{ff\_beta{[}6{]}} into one data frame \texttt{ff\_beta\_sml}. We
can easily use the \texttt{.join()} method if we first use the
\texttt{stack()} method to convert the returns and beta data frames into
long data frames.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_beta\_sml }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_beta[}\DecValTok{2}\NormalTok{].iloc[:, :}\DecValTok{5}\NormalTok{] }\CommentTok{\# annual value{-}weighted returns on quintile portfolios}
\NormalTok{    .stack() }\CommentTok{\# convert to long data frame with one column of returns}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{)}
\NormalTok{    .join(}
\NormalTok{        ff\_beta[}\DecValTok{6}\NormalTok{].iloc[:, :}\DecValTok{5}\NormalTok{] }\CommentTok{\# value{-}weighted betas from previous year on quintile portfolios}
\NormalTok{        .stack() }\CommentTok{\# convert to long data frame with one column of betas}
\NormalTok{        .to\_frame(}\StringTok{\textquotesingle{}Beta\textquotesingle{}}\NormalTok{)}
\NormalTok{    )}
\NormalTok{    .rename\_axis(}
\NormalTok{        index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{],}
\NormalTok{        columns}\OperatorTok{=}\StringTok{\textquotesingle{}Variable\textquotesingle{}}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{ff\_beta\_sml.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
& Variable & Return & Beta \\
Date & Portfolio & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
\multirow{5}{=}{2023} & Lo 20 & 2.3000 & 0.3950 \\
& Qnt 2 & 27.9500 & 0.8710 \\
& Qnt 3 & 26.2600 & 1.1630 \\
& Qnt 4 & 44.3900 & 1.5190 \\
& Hi 20 & 74.7900 & 2.1440 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start }\OperatorTok{=}\NormalTok{ ff\_beta\_sml.index.get\_level\_values(}\DecValTok{0}\NormalTok{).year[}\DecValTok{0}\NormalTok{]}
\NormalTok{stop }\OperatorTok{=}\NormalTok{ ff\_beta\_sml.index.get\_level\_values(}\DecValTok{0}\NormalTok{).year[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}

\NormalTok{sns.regplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{ff\_beta\_sml,}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Beta\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annual Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\VerbatimStringTok{r\textquotesingle{}Capital Asset Pricing Model (CAPM) $\textbackslash{}beta$\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}
    \VerbatimStringTok{r\textquotesingle{}Security Market Line (SML) for $\textbackslash{}beta$ Quintile Portfolios\textquotesingle{}} \OperatorTok{+}
    \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}n}\SpecialStringTok{for Annual Returns from }\SpecialCharTok{\{}\NormalTok{start}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{stop}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_05_files/figure-pdf/cell-23-output-1.png}

\subsection{\texorpdfstring{Estimate the CAPM \(\beta\)s on several
levered and inverse exchange traded funds
(ETFs)}{Estimate the CAPM \textbackslash betas on several levered and inverse exchange traded funds (ETFs)}}\label{estimate-the-capm-betas-on-several-levered-and-inverse-exchange-traded-funds-etfs-3}

Try the following ETFs:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  SPY
\item
  UPRO
\item
  SPXU
\end{enumerate}

Can you determine what these products do from the data alone? Estimate
\(\beta\)s and plot cumulative returns. You may want to pick short
periods of time with large market swings.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{etf\_2 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}SPY UPRO SPXU\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
\NormalTok{    [}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    .pct\_change()}
\NormalTok{    .mul(}\DecValTok{100}\NormalTok{)}
\NormalTok{    .dropna()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  3 of 3 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{etf\_2.}\BuiltInTok{apply}\NormalTok{(calc\_beta).rename(}\VerbatimStringTok{r\textquotesingle{}$\textbackslash{}beta$\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Ticker
SPXU   -2.8635
SPY     0.9582
UPRO    2.8790
Name: $\beta$, dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start }\OperatorTok{=}\NormalTok{ etf\_2.index[}\DecValTok{0}\NormalTok{]}
\NormalTok{stop }\OperatorTok{=}\NormalTok{ etf\_2.index[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}

\NormalTok{etf\_2.}\BuiltInTok{apply}\NormalTok{(calc\_beta).plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xticks(rotation}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{plt.ylabel(}\VerbatimStringTok{r\textquotesingle{}Capital Asset Pricing Model (CAPM) $\textbackslash{}beta$\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}
    \VerbatimStringTok{r\textquotesingle{}Capital Asset Pricing Model (CAPM) $\textbackslash{}beta$s\textquotesingle{}} \OperatorTok{+} 
    \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}n}\SpecialStringTok{from Daily Returns from }\SpecialCharTok{\{}\NormalTok{start}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{d }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{stop}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{d }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_05_files/figure-pdf/cell-26-output-1.png}

\subsection{Explore the size factor}\label{explore-the-size-factor-3}

First, we need data for portfolio and factor returns.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_me }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pdr.DataReader(}
\NormalTok{        name}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolios\_Formed\_on\_ME\textquotesingle{}}\NormalTok{,}
\NormalTok{        data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{        start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{    )}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(ff\_me[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Portfolios Formed on ME
-----------------------

This file was created by CMPT_ME_RETS using the 202402 CRSP database. It contains value- and equal-weighted returns for size portfolios. Each record contains returns for: Negative (not used) 30% 40% 30%   5 Quintiles  10 Deciles The portfolios are constructed at the end of Jun. The annual returns are from January to December. Missing data are indicated by -99.99 or -999. Copyright 2024 Kenneth R. French

  0 : Value Weight Returns -- Monthly (1172 rows x 19 cols)
  1 : Equal Weight Returns -- Monthly (1172 rows x 19 cols)
  2 : Value Weight Returns -- Annual from January to December (97 rows x 19 cols)
  3 : Equal Weight Returns -- Annual from January to December (97 rows x 19 cols)
  4 : Number of Firms in Portfolios (1172 rows x 19 cols)
  5 : Average Firm Size (1172 rows x 19 cols)
\end{verbatim}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\4020728382.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\4020728382.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\4020728382.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\4020728382.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\4020728382.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\4020728382.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_m }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pdr.DataReader(}
\NormalTok{        name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\textquotesingle{}}\NormalTok{,}
\NormalTok{        data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{        start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{    )}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(ff\_m[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
F-F Research Data Factors
-------------------------

This file was created by CMPT_ME_BEME_RETS using the 202402 CRSP database. The 1-month TBill return is from Ibbotson and Associates, Inc. Copyright 2024 Kenneth R. French

  0 : (1172 rows x 4 cols)
  1 : Annual Factors: January-December (97 rows x 4 cols)
\end{verbatim}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\772652417.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\772652417.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_me }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_me[}\DecValTok{1}\NormalTok{]}
\NormalTok{    .iloc[:, }\OperatorTok{{-}}\DecValTok{10}\NormalTok{:]}
\NormalTok{    .join(ff\_m[}\DecValTok{0}\NormalTok{])}
\NormalTok{)}

\NormalTok{df\_me.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllllll@{}}
\toprule\noalign{}
& Lo 10 & Dec 2 & Dec 3 & Dec 4 & Dec 5 & Dec 6 & Dec 7 & Dec 8 & Dec 9
& Hi 10 & Mkt-RF & SMB & HML & RF \\
Date & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2023-10 & -9.3900 & -8.4100 & -7.9700 & -7.5300 & -6.4900 & -5.5100 &
-6.4000 & -6.3600 & -4.6000 & -2.2600 & -3.1900 & -3.8700 & 0.1900 &
0.4700 \\
2023-11 & 6.3000 & 9.0500 & 9.5800 & 9.6400 & 11.8700 & 9.6700 & 9.8400
& 9.6400 & 9.9900 & 9.2700 & 8.8400 & -0.0200 & 1.6400 & 0.4400 \\
2023-12 & 10.8700 & 17.2700 & 14.4800 & 14.2400 & 13.1200 & 12.0000 &
9.1600 & 9.6500 & 7.0000 & 5.5400 & 4.8700 & 6.3400 & 4.9300 & 0.4300 \\
2024-01 & -2.8200 & -5.4600 & -5.8600 & -4.9400 & -5.0700 & -3.1900 &
-2.3800 & -1.2600 & -1.7100 & 1.5900 & 0.7100 & -5.0900 & -2.3800 &
0.4700 \\
2024-02 & 5.5400 & 6.7100 & 4.8000 & 8.1900 & 3.4200 & 4.4400 & 6.3100 &
4.5400 & 5.7900 & 3.7100 & 5.0600 & -0.2400 & -3.4800 & 0.4200 \\
\end{longtable}

\subsubsection{\texorpdfstring{Estimate \(\alpha\)s for the ten
portfolios formed on
size}{Estimate \textbackslash alphas for the ten portfolios formed on size}}\label{estimate-alphas-for-the-ten-portfolios-formed-on-size-3}

Academics started researching size-based portfolios in the early 1980s,
so you may want to focus on the pre-1980 sample.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mod }\OperatorTok{=}\NormalTok{ smf.ols(}
\NormalTok{    formula}\OperatorTok{=}\StringTok{\textquotesingle{}I(Q("Lo 10") {-} RF) \textasciitilde{} Q("Mkt{-}RF")\textquotesingle{}}\NormalTok{,}
\NormalTok{    data}\OperatorTok{=}\NormalTok{df\_me.loc[:}\StringTok{\textquotesingle{}1980\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\NormalTok{fit }\OperatorTok{=}\NormalTok{ mod.fit()}
\NormalTok{fit.summary()}
\end{Highlighting}
\end{Shaded}

\begin{center}
\begin{tabular}{lclc}
\toprule
\textbf{Dep. Variable:}    & I(Q("Lo 10") - RF) & \textbf{  R-squared:         } &     0.541   \\
\textbf{Model:}            &        OLS         & \textbf{  Adj. R-squared:    } &     0.540   \\
\textbf{Method:}           &   Least Squares    & \textbf{  F-statistic:       } &     767.6   \\
\textbf{Date:}             &  Fri, 05 Apr 2024  & \textbf{  Prob (F-statistic):} & 2.92e-112   \\
\textbf{Time:}             &      17:46:27      & \textbf{  Log-Likelihood:    } &   -2343.5   \\
\textbf{No. Observations:} &          654       & \textbf{  AIC:               } &     4691.   \\
\textbf{Df Residuals:}     &          652       & \textbf{  BIC:               } &     4700.   \\
\textbf{Df Model:}         &            1       & \textbf{                     } &             \\
\textbf{Covariance Type:}  &     nonrobust      & \textbf{                     } &             \\
\bottomrule
\end{tabular}
\begin{tabular}{lcccccc}
                     & \textbf{coef} & \textbf{std err} & \textbf{t} & \textbf{P$> |$t$|$} & \textbf{[0.025} & \textbf{0.975]}  \\
\midrule
\textbf{Intercept}   &       0.9161  &        0.343     &     2.669  &         0.008        &        0.242    &        1.590     \\
\textbf{Q("Mkt-RF")} &       1.5976  &        0.058     &    27.706  &         0.000        &        1.484    &        1.711     \\
\bottomrule
\end{tabular}
\begin{tabular}{lclc}
\textbf{Omnibus:}       & 626.765 & \textbf{  Durbin-Watson:     } &     1.970  \\
\textbf{Prob(Omnibus):} &   0.000 & \textbf{  Jarque-Bera (JB):  } & 28924.644  \\
\textbf{Skew:}          &   4.226 & \textbf{  Prob(JB):          } &      0.00  \\
\textbf{Kurtosis:}      &  34.464 & \textbf{  Cond. No.          } &      5.99  \\
\bottomrule
\end{tabular}
%\caption{OLS Regression Results}
\end{center}

Notes: \newline
 [1] Standard Errors assume that the covariance matrix of the errors is correctly specified.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ports }\OperatorTok{=}\NormalTok{ df\_me.columns.to\_list()[:}\DecValTok{10}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mods }\OperatorTok{=}\NormalTok{ [}
\NormalTok{    smf.ols(formula}\OperatorTok{=}\SpecialStringTok{f\textquotesingle{}I(Q("}\SpecialCharTok{\{}\NormalTok{p}\SpecialCharTok{\}}\SpecialStringTok{"){-}RF) \textasciitilde{} Q("Mkt{-}RF")\textquotesingle{}}\NormalTok{, data}\OperatorTok{=}\NormalTok{df\_me.loc[}\StringTok{\textquotesingle{}1993\textquotesingle{}}\NormalTok{:])}
    \ControlFlowTok{for}
\NormalTok{    p }\KeywordTok{in}\NormalTok{ ports}
\NormalTok{]}
\NormalTok{fits }\OperatorTok{=}\NormalTok{ [m.fit() }\ControlFlowTok{for}\NormalTok{ m }\KeywordTok{in}\NormalTok{ mods]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{params\_me }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat(}
\NormalTok{        objs}\OperatorTok{=}\NormalTok{[f.params }\ControlFlowTok{for}\NormalTok{ f }\KeywordTok{in}\NormalTok{ fits],}
\NormalTok{        axis}\OperatorTok{=}\DecValTok{1}\NormalTok{,}
\NormalTok{        keys}\OperatorTok{=}\NormalTok{ports,}
\NormalTok{        names}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}
\NormalTok{    )}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

Now, we can use list comprehensions to quickly estimate all ten
\(\alpha\)s.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{params }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat([f.params }\ControlFlowTok{for}\NormalTok{ f }\KeywordTok{in}\NormalTok{ fits], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{ports, names}\OperatorTok{=}\StringTok{\textquotesingle{}Portolio\textquotesingle{}}\NormalTok{)}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{bses }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat([f.bse }\ControlFlowTok{for}\NormalTok{ f }\KeywordTok{in}\NormalTok{ fits], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{ports, names}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{)}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start }\OperatorTok{=}\NormalTok{ df\_me.loc[:}\StringTok{\textquotesingle{}1980\textquotesingle{}}\NormalTok{].index[}\DecValTok{0}\NormalTok{].to\_timestamp()}
\NormalTok{stop }\OperatorTok{=}\NormalTok{ df\_me.loc[:}\StringTok{\textquotesingle{}1980\textquotesingle{}}\NormalTok{].index[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].to\_timestamp()}

\NormalTok{params[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{].plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{, yerr}\OperatorTok{=}\NormalTok{bses[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{])}

\NormalTok{plt.ylabel(}\VerbatimStringTok{r\textquotesingle{}Monthly CAPM $\textbackslash{}alpha$ (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xticks(rotation}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{plt.title(}
    \VerbatimStringTok{r\textquotesingle{}Size Portfolio Monthly CAPM $\textbackslash{}alpha$s\textquotesingle{}} \OperatorTok{+}
    \StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}} \OperatorTok{+}
    \SpecialStringTok{f\textquotesingle{}from }\SpecialCharTok{\{}\NormalTok{start}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ through }\SpecialCharTok{\{}\NormalTok{stop}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_05_files/figure-pdf/cell-36-output-1.png}

\subsubsection{Are the returns on these ten portfolios formed on size
concentrated in a specific
month?}\label{are-the-returns-on-these-ten-portfolios-formed-on-size-concentrated-in-a-specific-month-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_me\_2 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_me[}\DecValTok{0}\NormalTok{]}
\NormalTok{    .iloc[:, }\OperatorTok{{-}}\DecValTok{10}\NormalTok{:]}
\NormalTok{    .stack()}
\NormalTok{    .rename\_axis(index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{])}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{)}
\NormalTok{    .reset\_index()}
\NormalTok{    .assign(Month}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.where(x[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{].dt.month}\OperatorTok{==}\DecValTok{1}\NormalTok{, }\StringTok{\textquotesingle{}January\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Not January\textquotesingle{}}\NormalTok{))}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.barplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{df\_me\_2,}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Month\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{,}
\NormalTok{    hue}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Mean Monthly Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}When Do We Earn Size{-}Effect Returns?\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_05_files/figure-pdf/cell-38-output-1.png}

\subsubsection{Compare the size factor to the market
factor}\label{compare-the-size-factor-to-the-market-factor-3}

You may want to consider mean excess returns by decade. The market and
size excess returns are factors \texttt{Mkt-RF} and \texttt{SMB} in the
Fama-French factors data.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_me\_3 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_m[}\DecValTok{0}\NormalTok{]}
\NormalTok{    [[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}SMB\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .stack()}
\NormalTok{    .rename\_axis(index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Factor\textquotesingle{}}\NormalTok{])}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{)}
\NormalTok{    .reset\_index()}
\NormalTok{    .assign(Decade}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: (x[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{].dt.year }\OperatorTok{//} \DecValTok{10}\NormalTok{ ) }\OperatorTok{*} \DecValTok{10}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.barplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{df\_me\_3,}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Decade\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{,}
\NormalTok{    hue}\OperatorTok{=}\StringTok{\textquotesingle{}Factor\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Monthly Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Comparison on Market and Small Stock Risk Premia\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_05_files/figure-pdf/cell-40-output-1.png}

SMB rarely generates outsize returns later in the sample.

\subsection{Repeat the exercises above with the value
factor}\label{repeat-the-exercises-above-with-the-value-factor-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_be\_me }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolios\_Formed\_on\_BE{-}ME\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\1841624243.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_be_me = pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(ff\_me[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Portfolios Formed on ME
-----------------------

This file was created by CMPT_ME_RETS using the 202402 CRSP database. It contains value- and equal-weighted returns for size portfolios. Each record contains returns for: Negative (not used) 30% 40% 30%   5 Quintiles  10 Deciles The portfolios are constructed at the end of Jun. The annual returns are from January to December. Missing data are indicated by -99.99 or -999. Copyright 2024 Kenneth R. French

  0 : Value Weight Returns -- Monthly (1172 rows x 19 cols)
  1 : Equal Weight Returns -- Monthly (1172 rows x 19 cols)
  2 : Value Weight Returns -- Annual from January to December (97 rows x 19 cols)
  3 : Equal Weight Returns -- Annual from January to December (97 rows x 19 cols)
  4 : Number of Firms in Portfolios (1172 rows x 19 cols)
  5 : Average Firm Size (1172 rows x 19 cols)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_be\_me }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_be\_me[}\DecValTok{1}\NormalTok{]}
\NormalTok{    .iloc[:, }\OperatorTok{{-}}\DecValTok{10}\NormalTok{:]}
\NormalTok{    .join(ff\_m[}\DecValTok{0}\NormalTok{])}
\NormalTok{)}

\NormalTok{df\_be\_me.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllllll@{}}
\toprule\noalign{}
& Lo 10 & Dec 2 & Dec 3 & Dec 4 & Dec 5 & Dec 6 & Dec 7 & Dec 8 & Dec 9
& Hi 10 & Mkt-RF & SMB & HML & RF \\
Date & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2023-10 & -7.6200 & -6.5300 & -8.4300 & -7.7500 & -7.0200 & -7.0800 &
-6.1800 & -7.0600 & -7.6800 & -8.4300 & -3.1900 & -3.8700 & 0.1900 &
0.4700 \\
2023-11 & 9.8800 & 9.8900 & 8.5700 & 7.1800 & 11.5300 & 13.6400 & 8.7100
& 10.5800 & 6.4300 & 6.6500 & 8.8400 & -0.0200 & 1.6400 & 0.4400 \\
2023-12 & 9.8700 & 9.2100 & 15.0800 & 11.0000 & 9.7200 & 11.9100 &
14.2700 & 14.1400 & 13.9600 & 13.2000 & 4.8700 & 6.3400 & 4.9300 &
0.4300 \\
2024-01 & -4.0000 & -1.3500 & -3.4800 & -3.2100 & -4.5000 & -3.5100 &
-3.3800 & -4.4200 & -3.6400 & -0.4200 & 0.7100 & -5.0900 & -2.3800 &
0.4700 \\
2024-02 & 6.1900 & 7.6000 & 7.2500 & 5.2900 & 7.5200 & 7.6200 & 3.3800 &
3.3400 & 1.7400 & 7.2900 & 5.0600 & -0.2400 & -3.4800 & 0.4200 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ports }\OperatorTok{=}\NormalTok{ df\_be\_me.columns.to\_list()[:}\DecValTok{10}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mods }\OperatorTok{=}\NormalTok{ [}
\NormalTok{    smf.ols(formula}\OperatorTok{=}\SpecialStringTok{f\textquotesingle{}I(Q("}\SpecialCharTok{\{}\NormalTok{p}\SpecialCharTok{\}}\SpecialStringTok{") {-} RF) \textasciitilde{} Q("Mkt{-}RF")\textquotesingle{}}\NormalTok{, data}\OperatorTok{=}\NormalTok{df\_be\_me)}
    \ControlFlowTok{for}
\NormalTok{    p }\KeywordTok{in}\NormalTok{ ports}
\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fits }\OperatorTok{=}\NormalTok{ [m.fit() }\ControlFlowTok{for}\NormalTok{ m }\KeywordTok{in}\NormalTok{ mods]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{params }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat([f.params }\ControlFlowTok{for}\NormalTok{ f }\KeywordTok{in}\NormalTok{ fits], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{ports, names}\OperatorTok{=}\StringTok{\textquotesingle{}Portolio\textquotesingle{}}\NormalTok{)}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{bses }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat([f.bse }\ControlFlowTok{for}\NormalTok{ f }\KeywordTok{in}\NormalTok{ fits], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{ports, names}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{)}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start }\OperatorTok{=}\NormalTok{ df\_be\_me.index[}\DecValTok{0}\NormalTok{].to\_timestamp()}
\NormalTok{stop }\OperatorTok{=}\NormalTok{ df\_be\_me.index[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].to\_timestamp()}

\NormalTok{params[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{].plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{, yerr}\OperatorTok{=}\NormalTok{bses[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{])}

\NormalTok{plt.ylabel(}\VerbatimStringTok{r\textquotesingle{}Monthly CAPM $\textbackslash{}alpha$ (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xticks(rotation}\OperatorTok{=}\DecValTok{0}\NormalTok{)}
\NormalTok{plt.title(}
    \VerbatimStringTok{r\textquotesingle{}BE/ME Portfolio Monthly CAPM $\textbackslash{}alpha$s\textquotesingle{}} \OperatorTok{+}
    \StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}} \OperatorTok{+}
    \SpecialStringTok{f\textquotesingle{}from }\SpecialCharTok{\{}\NormalTok{start}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ through }\SpecialCharTok{\{}\NormalTok{stop}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_05_files/figure-pdf/cell-49-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_be\_me\_3 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_m[}\DecValTok{0}\NormalTok{]}
\NormalTok{    [[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}HML\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .stack()}
\NormalTok{    .rename\_axis(index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Factor\textquotesingle{}}\NormalTok{])}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{)}
\NormalTok{    .reset\_index()}
\NormalTok{    .assign(Decade}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: (x[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{].dt.year }\OperatorTok{//} \DecValTok{10}\NormalTok{ ) }\OperatorTok{*} \DecValTok{10}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.barplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{df\_be\_me\_3,}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Decade\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{,}
\NormalTok{    hue}\OperatorTok{=}\StringTok{\textquotesingle{}Factor\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Monthly Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Comparison on Market and Value Stock Risk Premia\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_05_files/figure-pdf/cell-51-output-1.png}

\subsection{Repeat the exercises above with the momentum
factor}\label{repeat-the-exercises-above-with-the-momentum-factor-3}

You may find it helpful to consider the worst months and years for the
momentum factor.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_mom }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}10\_Portfolios\_Prior\_12\_2\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\2097656781.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\2097656781.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\2097656781.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\2097656781.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\2097656781.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\2097656781.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\2097656781.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(ff\_mom[}\StringTok{\textquotesingle{}DESCR\textquotesingle{}}\NormalTok{])}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
10 Portfolios Prior 12 2
------------------------

This file was created by CMPT_PRIOR_RETS using the 202402 CRSP database. It contains value- and equal-weighted returns for 10 prior-return portfolios. The portfolios are constructed monthly. PRIOR_RET is from -12 to - 2. The annual returns are from January to December. Missing data are indicated by -99.99 or -999.

  0 : Average Value Weighted Returns -- Monthly (1166 rows x 10 cols)
  1 : Average Equal Weighted Returns -- Monthly (1166 rows x 10 cols)
  2 : Average Value Weighted Returns -- Annual (97 rows x 10 cols)
  3 : Average Equal Weighted Returns -- Annual (97 rows x 10 cols)
  4 : Number of Firms in Portfolios (1166 rows x 10 cols)
  5 : Average Firm Size (1166 rows x 10 cols)
  6 : Value-Weighted Average of Prior Returns (97 rows x 10 cols)
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_mom }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_mom[}\DecValTok{1}\NormalTok{]}
\NormalTok{    .iloc[:, }\OperatorTok{{-}}\DecValTok{10}\NormalTok{:]}
\NormalTok{    .join(ff\_m[}\DecValTok{0}\NormalTok{])}
\NormalTok{)}

\NormalTok{df\_mom.tail()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllllllllllll@{}}
\toprule\noalign{}
& Lo PRIOR & PRIOR 2 & PRIOR 3 & PRIOR 4 & PRIOR 5 & PRIOR 6 & PRIOR 7 &
PRIOR 8 & PRIOR 9 & Hi PRIOR & Mkt-RF & SMB & HML & RF \\
Date & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2023-10 & -11.8200 & -8.0400 & -5.4700 & -4.4900 & -5.6900 & -4.9900 &
-4.7800 & -6.1700 & -6.4800 & -8.7700 & -3.1900 & -3.8700 & 0.1900 &
0.4700 \\
2023-11 & 7.8000 & 8.7100 & 7.1900 & 8.1500 & 7.7400 & 5.3800 & 8.0100 &
9.9700 & 10.4500 & 12.3300 & 8.8400 & -0.0200 & 1.6400 & 0.4400 \\
2023-12 & 14.9500 & 13.2800 & 14.0100 & 11.9000 & 10.5300 & 9.3300 &
6.5900 & 6.7600 & 8.4100 & 13.2100 & 4.8700 & 6.3400 & 4.9300 &
0.4300 \\
2024-01 & -6.8900 & -5.0200 & -3.9900 & -2.2500 & -2.3300 & -2.4100 &
-0.9400 & 0.0400 & -0.3900 & -0.6600 & 0.7100 & -5.0900 & -2.3800 &
0.4700 \\
2024-02 & 8.2200 & 3.9100 & 2.6200 & 2.4500 & 2.0900 & 3.8600 & 4.3500 &
5.4000 & 6.0200 & 10.5000 & 5.0600 & -0.2400 & -3.4800 & 0.4200 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ports }\OperatorTok{=}\NormalTok{ df\_mom.columns.to\_list()[:}\DecValTok{10}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mods }\OperatorTok{=}\NormalTok{ [}
\NormalTok{    smf.ols(formula}\OperatorTok{=}\SpecialStringTok{f\textquotesingle{}I(Q("}\SpecialCharTok{\{}\NormalTok{p}\SpecialCharTok{\}}\SpecialStringTok{") {-} RF) \textasciitilde{} Q("Mkt{-}RF")\textquotesingle{}}\NormalTok{, data}\OperatorTok{=}\NormalTok{df\_mom.loc[:}\StringTok{\textquotesingle{}1980\textquotesingle{}}\NormalTok{])}
    \ControlFlowTok{for}
\NormalTok{    p }\KeywordTok{in}\NormalTok{ ports}
\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fits }\OperatorTok{=}\NormalTok{ [m.fit() }\ControlFlowTok{for}\NormalTok{ m }\KeywordTok{in}\NormalTok{ mods]}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{params }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat([f.params }\ControlFlowTok{for}\NormalTok{ f }\KeywordTok{in}\NormalTok{ fits], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{ports, names}\OperatorTok{=}\StringTok{\textquotesingle{}Portolio\textquotesingle{}}\NormalTok{)}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{bses }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pd.concat([f.bse }\ControlFlowTok{for}\NormalTok{ f }\KeywordTok{in}\NormalTok{ fits], axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{ports, names}\OperatorTok{=}\StringTok{\textquotesingle{}Portfolio\textquotesingle{}}\NormalTok{)}
\NormalTok{    .transpose()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{start }\OperatorTok{=}\NormalTok{ df\_mom.loc[:}\StringTok{\textquotesingle{}1980\textquotesingle{}}\NormalTok{].index[}\DecValTok{0}\NormalTok{].to\_timestamp()}
\NormalTok{stop }\OperatorTok{=}\NormalTok{ df\_mom.loc[:}\StringTok{\textquotesingle{}1980\textquotesingle{}}\NormalTok{].index[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].to\_timestamp()}

\NormalTok{params[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{].plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}bar\textquotesingle{}}\NormalTok{, yerr}\OperatorTok{=}\NormalTok{bses[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{])}

\NormalTok{plt.ylabel(}\VerbatimStringTok{r\textquotesingle{}Monthly CAPM $\textbackslash{}alpha$ (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}
    \VerbatimStringTok{r\textquotesingle{}Momentum Portfolio Monthly CAPM $\textbackslash{}alpha$s\textquotesingle{}} \OperatorTok{+}
    \StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}} \OperatorTok{+}
    \SpecialStringTok{f\textquotesingle{}from }\SpecialCharTok{\{}\NormalTok{start}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ through }\SpecialCharTok{\{}\NormalTok{stop}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{b }\OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_05_files/figure-pdf/cell-60-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff\_mom }\OperatorTok{=}\NormalTok{ pdr.DataReader(}
\NormalTok{    name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Momentum\_Factor\textquotesingle{}}\NormalTok{,}
\NormalTok{    data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{    start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{)}

\NormalTok{ff\_mom[}\DecValTok{0}\NormalTok{].columns }\OperatorTok{=}\NormalTok{ [c.strip() }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ ff\_mom[}\DecValTok{0}\NormalTok{].columns]}
\NormalTok{ff\_mom[}\DecValTok{0}\NormalTok{].tail()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\1313848978.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\1313848978.py:1: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  ff_mom = pdr.DataReader(
\end{verbatim}

\begin{longtable}[]{@{}ll@{}}
\toprule\noalign{}
& Mom \\
Date & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2023-10 & 1.7300 \\
2023-11 & 2.7500 \\
2023-12 & -5.5100 \\
2024-01 & 5.1800 \\
2024-02 & 4.9200 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df\_mom\_3 }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    ff\_m[}\DecValTok{0}\NormalTok{].join(ff\_mom[}\DecValTok{0}\NormalTok{])}
\NormalTok{    [[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Mom\textquotesingle{}}\NormalTok{]]}
\NormalTok{    .stack()}
\NormalTok{    .rename\_axis(index}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Factor\textquotesingle{}}\NormalTok{])}
\NormalTok{    .to\_frame(}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{)}
\NormalTok{    .reset\_index()}
\NormalTok{    .assign(Decade}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: (x[}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{].dt.year }\OperatorTok{//} \DecValTok{10}\NormalTok{ ) }\OperatorTok{*} \DecValTok{10}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sns.barplot(}
\NormalTok{    data}\OperatorTok{=}\NormalTok{df\_mom\_3,}
\NormalTok{    x}\OperatorTok{=}\StringTok{\textquotesingle{}Decade\textquotesingle{}}\NormalTok{,}
\NormalTok{    y}\OperatorTok{=}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{,}
\NormalTok{    hue}\OperatorTok{=}\StringTok{\textquotesingle{}Factor\textquotesingle{}}
\NormalTok{)}

\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean of Monthly Returns (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Comparison on Market and Value Stock Risk Premia\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_05_files/figure-pdf/cell-63-output-1.png}

\subsection{Plot the coefficient estimates from a rolling Fama-French
three-factor model for Berkshire
Hathaway}\label{plot-the-coefficient-estimates-from-a-rolling-fama-french-three-factor-model-for-berkshire-hathaway-3}

Use a three-year window with daily returns. How has Buffett's \(\alpha\)
and \(\beta\)s changed over the past four decades?

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{brk }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}BRK{-}A\textquotesingle{}}\NormalTok{)}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{])}
\NormalTok{    .assign(r}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].pct\_change().mul(}\DecValTok{100}\NormalTok{))}
\NormalTok{    .dropna()}
\NormalTok{    .join(}
\NormalTok{        pdr.DataReader(}
\NormalTok{            name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{            data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{            start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{        )[}\DecValTok{0}\NormalTok{],}
\NormalTok{        how}\OperatorTok{=}\StringTok{\textquotesingle{}inner\textquotesingle{}}
\NormalTok{    )}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  1 of 1 completed
C:\Users\r.herron\AppData\Local\Temp\ipykernel_3400\2930704642.py:8: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{from}\NormalTok{ statsmodels.regression.rolling }\ImportTok{import}\NormalTok{ RollingOLS}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{coefs }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    RollingOLS.from\_formula(}
\NormalTok{        formula}\OperatorTok{=}\StringTok{\textquotesingle{}I(r{-}RF) \textasciitilde{} Q("Mkt{-}RF") + SMB + HML\textquotesingle{}}\NormalTok{,}
\NormalTok{        data}\OperatorTok{=}\NormalTok{brk,}
\NormalTok{        window}\OperatorTok{=}\DecValTok{3}\OperatorTok{*}\DecValTok{252}
\NormalTok{    )}
\NormalTok{    .fit()}
\NormalTok{    .params}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\StringTok{\textquotesingle{}Coefficient\textquotesingle{}}\NormalTok{)}
\NormalTok{    .rename(columns}\OperatorTok{=}\NormalTok{\{}\StringTok{\textquotesingle{}Q("Mkt{-}RF")\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{\})}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fig, ax }\OperatorTok{=}\NormalTok{ plt.subplots(}\DecValTok{2}\NormalTok{, }\DecValTok{1}\NormalTok{, sharex}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{coefs[}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{].plot(ax}\OperatorTok{=}\NormalTok{ax[}\DecValTok{0}\NormalTok{], legend}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{coefs.drop(}\StringTok{\textquotesingle{}Intercept\textquotesingle{}}\NormalTok{, axis}\OperatorTok{=}\DecValTok{1}\NormalTok{).plot(ax}\OperatorTok{=}\NormalTok{ax[}\DecValTok{1}\NormalTok{])}
\NormalTok{plt.suptitle(}
    \StringTok{\textquotesingle{}Rolling Three{-}Factor Regressions\textquotesingle{}} \OperatorTok{+}
    \StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n}\StringTok{Three{-}Year Windows with Daily Returns in Percent\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_03_practice_05_files/figure-pdf/cell-67-output-1.png}

Buffett's \(\alpha\) was large, but has declined to zero. Also, his
loading on SMB (size factor) has gone from positive to negative,
indicating that he has moved from small stocks to large stocks as
Berkshire Hathaway has grown.

\part{Week 13}

\chapter{Herron Topic 4 - Portfolio
Optimization}\label{herron-topic-4---portfolio-optimization}

This notebook covers portfolio optimization. I have not found a perfect
reference that combines portfolio optimization and Python, but here are
two references that I find useful:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Ivo Welch discusses the mathematics and finance of portfolio
  optimization in
  \href{https://book.ivo-welch.info/bookg.pdf\#chapter.12}{Chapter 12 of
  his draft textbook on investments}.
\item
  Eryk Lewinson provides Python code for portfolio optimization in
  chapter 7 of his
  \href{https://onesearch.library.northeastern.edu/permalink/01NEU_INST/i2gqis/alma9952082522901401}{\emph{Python
  for Finance Cookbook}}, but he uses several packages that are either
  non-free or abandoned.
\end{enumerate}

In this notebook, we will:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Review the \(\frac{1}{n}\) portfolio (or equal-weighted portfolio)
  from \href{herron_01_lecture.ipynb}{Herron Topic 1}
\item
  Use SciPy's \texttt{minimize()} function to:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Find the minimum variance portfolio
  \item
    Find the (mean-variance) efficient frontier
  \end{enumerate}
\end{enumerate}

In the practice notebook, we will use SciPy's \texttt{minimize()}
function to achieve any objective.

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\section{\texorpdfstring{The \(\frac{1}{n}\)
Portfolio}{The \textbackslash frac\{1\}\{n\} Portfolio}}\label{the-frac1n-portfolio}

We first saw the \(\frac{1}{n}\) portfolio (or equal-weighted portfolio)
in \href{herron_01_lecture.ipynb}{Herron Topic 1}. In the
\(\frac{1}{n}\) portfolio, each of \(n\) assets receives an equal
portfolio weight \(w_i = \frac{1}{n}\). While the \(\frac{1}{n}\)
strategy seems too simple to be useful, DeMiguel, Garlappi, and Uppal
(2007) show that it is difficult to beat \(\frac{1}{n}\) strategy, even
with more advanced strategies.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tickers }\OperatorTok{=} \StringTok{\textquotesingle{}MSFT AAPL TSLA AMZN NVDA GOOG\textquotesingle{}}

\NormalTok{matana }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\NormalTok{tickers)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
\NormalTok{)}

\NormalTok{matana.tail()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  6 of 6 completed
\end{verbatim}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
Variable & \multicolumn{6}{l}{%
Adj Close} & \multicolumn{4}{l}{%
Close} & ... & \multicolumn{4}{l}{%
Open} & \multicolumn{6}{l@{}}{%
Volume} \\
Ticker & AAPL & AMZN & GOOG & MSFT & NVDA & TSLA & AAPL & AMZN & GOOG &
MSFT & ... & GOOG & MSFT & NVDA & TSLA & AAPL & AMZN & GOOG & MSFT &
NVDA & TSLA \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-03-28 & 171.4800 & 180.3800 & 152.2600 & 420.7200 & 903.5600 &
175.7900 & 171.4800 & 180.3800 & 152.2600 & 420.7200 & ... & 152.0000 &
420.9600 & 900.0000 & 177.4500 & 65672700 & 38051600.0000 &
21105600.0000 & 21871200.0000 & 43521200.0000 & 77654800.0000 \\
2024-04-01 & 170.0300 & 180.9700 & 156.5000 & 424.5700 & 903.6300 &
175.2200 & 170.0300 & 180.9700 & 156.5000 & 424.5700 & ... & 151.8300 &
423.9500 & 902.9900 & 176.1700 & 46240500 & 29174500.0000 &
24469800.0000 & 16316000.0000 & 45244100.0000 & 81562100.0000 \\
2024-04-02 & 168.8400 & 180.6900 & 155.8700 & 421.4400 & 894.5200 &
166.6300 & 168.8400 & 180.6900 & 155.8700 & 421.4400 & ... & 154.7500 &
420.1100 & 884.4800 & 164.7500 & 49329500 & 32611500.0000 &
17598100.0000 & 17912000.0000 & 43306400.0000 & 116650600.0000 \\
2024-04-03 & 169.6500 & 182.4100 & 156.3700 & 420.4500 & 889.6400 &
168.3800 & 169.6500 & 182.4100 & 156.3700 & 420.4500 & ... & 154.9200 &
419.7300 & 884.8400 & 164.0200 & 47602100 & 30959800.0000 &
17218400.0000 & 16475600.0000 & 36845000.0000 & 82578000.0000 \\
2024-04-04 & 168.8200 & 180.0000 & 151.9400 & 417.8800 & 859.0500 &
171.1100 & 168.8200 & 180.0000 & 151.9400 & 417.8800 & ... & 155.0800 &
424.9900 & 904.0600 & 170.0700 & 53582300 & 41543000.0000 &
24114800.0000 & 19330000.0000 & 43300900.0000 & 122832800.0000 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    matana[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    .pct\_change()}
\NormalTok{    .iloc[(}\OperatorTok{{-}}\DecValTok{3} \OperatorTok{*} \DecValTok{252}\NormalTok{):]}
\NormalTok{)}

\NormalTok{returns.describe()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lllllll@{}}
\toprule\noalign{}
Ticker & AAPL & AMZN & GOOG & MSFT & NVDA & TSLA \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
count & 756.0000 & 756.0000 & 756.0000 & 756.0000 & 756.0000 &
756.0000 \\
mean & 0.0006 & 0.0005 & 0.0007 & 0.0009 & 0.0031 & 0.0003 \\
std & 0.0169 & 0.0235 & 0.0198 & 0.0173 & 0.0335 & 0.0356 \\
min & -0.0587 & -0.1405 & -0.0963 & -0.0772 & -0.0947 & -0.1224 \\
25\% & -0.0085 & -0.0123 & -0.0097 & -0.0081 & -0.0161 & -0.0194 \\
50\% & 0.0006 & 0.0003 & 0.0010 & 0.0003 & 0.0030 & 0.0014 \\
75\% & 0.0102 & 0.0129 & 0.0110 & 0.0110 & 0.0211 & 0.0190 \\
max & 0.0890 & 0.1354 & 0.0775 & 0.0823 & 0.2437 & 0.1353 \\
\end{longtable}

Before we revisit the advanced techniques from
\href{herron_01_lecture}{Herron Topic 1}, we can calculate
\(\frac{1}{n}\) portfolio returns manually, where
\(r_P = \frac{\sum_{i}^{n} r_i}{n}\) Since our weights are constant
(i.e., do not change over time), we rebalance our portfolio every return
period. If we have daily data, rebalance daily. If we have monthly data,
we rebalance monthly, and so on.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{n }\OperatorTok{=}\NormalTok{ returns.shape[}\DecValTok{1}\NormalTok{]}
\NormalTok{p1 }\OperatorTok{=}\NormalTok{ returns.}\BuiltInTok{sum}\NormalTok{(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{).div(n)}

\NormalTok{p1.describe()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
count   756.0000
mean      0.0010
std       0.0195
min      -0.0632
25%      -0.0101
50%       0.0014
75%       0.0121
max       0.0980
dtype: float64
\end{verbatim}

Recall from \href{herron_01_lecture}{Herron Topic 1} we have two better
options:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The \texttt{.mean(axis=1)} method for the \(\frac{1}{n}\) portfolio
\item
  The \texttt{.dot(weights)} method where \texttt{weights} is a pandas
  series or NumPy array of portfolio weights, allowing different weights
  for each asset
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p2 }\OperatorTok{=}\NormalTok{ returns.mean(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{)}

\NormalTok{p2.describe()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
count   756.0000
mean      0.0010
std       0.0195
min      -0.0632
25%      -0.0101
50%       0.0014
75%       0.0121
max       0.0980
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{weights }\OperatorTok{=}\NormalTok{ np.ones(n) }\OperatorTok{/}\NormalTok{ n}

\NormalTok{weights}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0.1667, 0.1667, 0.1667, 0.1667, 0.1667, 0.1667])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{p3 }\OperatorTok{=}\NormalTok{ returns.dot(weights)}

\NormalTok{p3.describe()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
count   756.0000
mean      0.0010
std       0.0195
min      -0.0632
25%      -0.0101
50%       0.0014
75%       0.0121
max       0.0980
dtype: float64
\end{verbatim}

The \texttt{.describe()} method provides summary statistics for data,
letting us make quick comparisons. However, we should use
\texttt{np.allclose()} if we want to be sure that \texttt{p1},
\texttt{p2}, and \texttt{p3} are similar.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(p1, p2)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(p1, p3)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

Here is a simple example to help understand the \texttt{.dot()} method.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{silly\_n }\OperatorTok{=} \DecValTok{3}
\NormalTok{silly\_r }\OperatorTok{=}\NormalTok{ pd.DataFrame(np.arange(}\DecValTok{2}\OperatorTok{*}\NormalTok{silly\_n).reshape(}\DecValTok{2}\NormalTok{, silly\_n))}
\NormalTok{silly\_w }\OperatorTok{=}\NormalTok{ np.ones(}\DecValTok{3}\NormalTok{) }\OperatorTok{/} \DecValTok{3}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\BuiltInTok{print}\NormalTok{(}
    \SpecialStringTok{f\textquotesingle{}silly\_n:}\CharTok{\textbackslash{}n}\SpecialCharTok{\{}\NormalTok{silly\_n}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{,}
    \SpecialStringTok{f\textquotesingle{}silly\_r:}\CharTok{\textbackslash{}n}\SpecialCharTok{\{}\NormalTok{silly\_r}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{,}
    \SpecialStringTok{f\textquotesingle{}silly\_w:}\CharTok{\textbackslash{}n}\SpecialCharTok{\{}\NormalTok{silly\_w}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{,}
\NormalTok{    sep}\OperatorTok{=}\StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n\textbackslash{}n}\StringTok{\textquotesingle{}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
silly_n:
3

silly_r:
   0  1  2
0  0  1  2
1  3  4  5

silly_w:
[0.3333 0.3333 0.3333]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{silly\_r.dot(silly\_w)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0   1.0000
1   4.0000
dtype: float64
\end{verbatim}

Under the hood, Python and the \texttt{.dot()} method (effectively) do
the following calculation:

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ i, row }\KeywordTok{in}\NormalTok{ silly\_r.iterrows():}
    \BuiltInTok{print}\NormalTok{(}
        \SpecialStringTok{f\textquotesingle{}Row }\SpecialCharTok{\{}\NormalTok{i}\SpecialCharTok{\}}\SpecialStringTok{: \textquotesingle{}}\NormalTok{,}
        \StringTok{\textquotesingle{} + \textquotesingle{}}\NormalTok{.join([}\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{w}\SpecialCharTok{:0.2f\}}\SpecialStringTok{ * }\SpecialCharTok{\{}\NormalTok{y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}} \ControlFlowTok{for}\NormalTok{ w, y }\KeywordTok{in} \BuiltInTok{zip}\NormalTok{(silly\_w, row)]),}
        \StringTok{\textquotesingle{} = \textquotesingle{}}\NormalTok{,}
        \SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{silly\_r}\SpecialCharTok{.}\NormalTok{dot(silly\_w)}\SpecialCharTok{.}\NormalTok{iloc[i]}\SpecialCharTok{:0.2f\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{    )}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Row 0:  0.33 * 0 + 0.33 * 1 + 0.33 * 2  =  1.00
Row 1:  0.33 * 3 + 0.33 * 4 + 0.33 * 5  =  4.00
\end{verbatim}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\section{\texorpdfstring{SciPy's \texttt{minimize()}
Function}{SciPy's minimize() Function}}\label{scipys-minimize-function}

\subsection{\texorpdfstring{A Crash Course in SciPy's
\texttt{minimize()}
Function}{A Crash Course in SciPy's minimize() Function}}\label{a-crash-course-in-scipys-minimize-function}

The \texttt{minimize()} function from SciPy's \texttt{optimize} module
finds the input array \texttt{x} that minimizes the output of the
function \texttt{fun}. The \texttt{minimize()} function uses
optimization techniques that are outside this course, but you can
consider these optimization techniques to be sophisticated trial and
error.

Here are the most common arguments we will pass to the
\texttt{minimize()} function:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  We pass our first guess for input array \texttt{x} to argument
  \texttt{x0=}.
\item
  We pass additional arguments for function \texttt{fun} as a tuple to
  argument \texttt{args=}.
\item
  We pass lower and upper bounds on \texttt{x} as a tuple of tuples to
  argument \texttt{bounds=}.
\item
  We constrain our results with a tuple of dictionaries of functions to
  argument \texttt{contraints=}.
\end{enumerate}

Here is a simple example that minimizes the function
\texttt{quadratic()} that accepts arguments \texttt{x} and \texttt{a}
and returns \(y = (x - a)^2\).

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ scipy.optimize }\ImportTok{as}\NormalTok{ sco}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ quadratic(x, a}\OperatorTok{=}\DecValTok{5}\NormalTok{):}
    \ControlFlowTok{return}\NormalTok{ (x }\OperatorTok{{-}}\NormalTok{ a) }\OperatorTok{**} \DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{quadratic(x}\OperatorTok{=}\DecValTok{5}\NormalTok{, a}\OperatorTok{=}\DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{quadratic(x}\OperatorTok{=}\DecValTok{10}\NormalTok{, a}\OperatorTok{=}\DecValTok{5}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
25
\end{verbatim}

It is helpful to plot \(y = (x - a)\) first.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OperatorTok{=}\NormalTok{ np.linspace(}\OperatorTok{{-}}\DecValTok{5}\NormalTok{, }\DecValTok{15}\NormalTok{, }\DecValTok{101}\NormalTok{)}
\NormalTok{y }\OperatorTok{=}\NormalTok{ quadratic(x}\OperatorTok{=}\NormalTok{x)}
\NormalTok{plt.plot(x, y)}
\NormalTok{plt.xlabel(}\VerbatimStringTok{r\textquotesingle{}$x$\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.ylabel(}\VerbatimStringTok{r\textquotesingle{}$y$\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\VerbatimStringTok{r\textquotesingle{}$y = (x {-} 5)\^{}2$\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_lecture_files/figure-pdf/cell-20-output-1.png}

The minimum output of \texttt{quadratic()} occurs at \(x=5\) if we do
not use bounds or constraints, even if we start far away from \(x=5\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{quadratic,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{np.array([}\DecValTok{2001}\NormalTok{])}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  message: Optimization terminated successfully.
  success: True
   status: 0
      fun: 2.0392713450495178e-16
        x: [ 5.000e+00]
      nit: 4
      jac: [-1.366e-08]
 hess_inv: [[ 5.000e-01]]
     nfev: 18
     njev: 9
\end{verbatim}

The minimum output of \texttt{quadratic()} occurs at \(x=6\) if we bound
\texttt{x} between 6 and 10 (i.e., \(6 \leq x \leq 10\)).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{quadratic,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{np.array([}\DecValTok{2001}\NormalTok{]),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{((}\DecValTok{6}\NormalTok{, }\DecValTok{10}\NormalTok{),)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  message: CONVERGENCE: NORM_OF_PROJECTED_GRADIENT_<=_PGTOL
  success: True
   status: 0
      fun: 1.0
        x: [ 6.000e+00]
      nit: 1
      jac: [ 2.000e+00]
     nfev: 4
     njev: 2
 hess_inv: <1x1 LbfgsInvHessProduct with dtype=float64>
\end{verbatim}

The minimum output of \texttt{quadratic()} occurs at \(x=6\), again, if
we constrain \texttt{x\ -\ 6} to be non-negative. We use bounds to limit
the search space directly, and we use constraints to limit the search
space indirectly based on a formula.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{quadratic,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{np.array([}\DecValTok{2001}\NormalTok{]),}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(\{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}ineq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x }\OperatorTok{{-}} \DecValTok{6}\NormalTok{\})}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: 1.0000000000000018
       x: [ 6.000e+00]
     nit: 3
     jac: [ 2.000e+00]
    nfev: 6
    njev: 3
\end{verbatim}

We can use the \texttt{args=} argument to pass additional arguments to
\texttt{fun}. For example, we change the \texttt{a=} argument in
\texttt{quadratic()} from the default of \texttt{a=5} to \texttt{a=20}
with \texttt{args=(20,)}. Note that \texttt{args=} expects a tuple, so
we need a trailing comma \texttt{,} if we have one argument.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{quadratic,}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(}\DecValTok{20}\NormalTok{,),}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{np.array([}\DecValTok{2001}\NormalTok{]),}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
  message: Optimization terminated successfully.
  success: True
   status: 0
      fun: 7.090392030754976e-17
        x: [ 2.000e+01]
      nit: 4
      jac: [-1.940e-09]
 hess_inv: [[ 5.000e-01]]
     nfev: 18
     njev: 9
\end{verbatim}

\subsection{The Minimum Variance
Portfolio}\label{the-minimum-variance-portfolio}

We can find the minimum variance portfolio with \texttt{minimize()}
function from SciPy's \texttt{optimize} module. The \texttt{minimize()}
function with vary an input array \texttt{x} (starting from argument
\texttt{x0=}) to minimize the objective function \texttt{fun=} subject
to the bounds and constraints in \texttt{bounds=} and
\texttt{constraints=}. We will define a function \texttt{port\_vol()} to
calculate portfolio volatility. The first argument to
\texttt{port\_vol()} must be the input array \texttt{x} that the
\texttt{minimize()} function searches over. For clarity, we will call
this first argument \texttt{x}, but the argument's name is not
important.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ port\_vol(x, r, ppy):}
    \ControlFlowTok{return}\NormalTok{ np.sqrt(ppy) }\OperatorTok{*}\NormalTok{ r.dot(x).std()}
\end{Highlighting}
\end{Shaded}

We will eventually need a mean portfolio return function, too.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ port\_mean(x, r, ppy):}
    \ControlFlowTok{return}\NormalTok{ ppy }\OperatorTok{*}\NormalTok{ r.dot(x).mean()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{[(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ \_ }\KeywordTok{in}\NormalTok{ returns]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[(0, 1), (0, 1), (0, 1), (0, 1), (0, 1), (0, 1)]
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_mv }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{port\_vol, }\CommentTok{\# objective function that we minimize}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{np.ones(returns.shape[}\DecValTok{1}\NormalTok{]) }\OperatorTok{/}\NormalTok{ returns.shape[}\DecValTok{1}\NormalTok{], }\CommentTok{\# initial portfolio weights are 1/n}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(returns, }\DecValTok{252}\NormalTok{), }\CommentTok{\# additional arguments to our objective function}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{[(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ \_ }\KeywordTok{in}\NormalTok{ returns], }\CommentTok{\# bounds limit the search space for each portfolio weights}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\} }\CommentTok{\# minimize drives "eq" constraints to zero}
\NormalTok{    )}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(res\_mv)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: 0.2501306149875224
       x: [ 5.064e-01  2.776e-17  9.326e-02  4.004e-01  2.082e-17
            6.939e-18]
     nit: 7
     jac: [ 2.506e-01  2.591e-01  2.502e-01  2.496e-01  3.628e-01
            2.920e-01]
    nfev: 49
    njev: 7
\end{verbatim}

What are the attributes of this minimum variance portfolio?

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ print\_port\_res(w, r, title, ppy}\OperatorTok{=}\DecValTok{252}\NormalTok{, tgt}\OperatorTok{=}\VariableTok{None}\NormalTok{):}
\NormalTok{    width }\OperatorTok{=} \BuiltInTok{len}\NormalTok{(title)}
\NormalTok{    rp }\OperatorTok{=}\NormalTok{ r.dot(w)}
\NormalTok{    mu }\OperatorTok{=}\NormalTok{ ppy }\OperatorTok{*}\NormalTok{ rp.mean()}
\NormalTok{    sigma }\OperatorTok{=}\NormalTok{ np.sqrt(ppy) }\OperatorTok{*}\NormalTok{ rp.std()}
    \ControlFlowTok{if}\NormalTok{ tgt }\KeywordTok{is} \KeywordTok{not} \VariableTok{None}\NormalTok{:}
\NormalTok{        er }\OperatorTok{=}\NormalTok{ rp.sub(tgt)}
\NormalTok{        sr }\OperatorTok{=}\NormalTok{ np.sqrt(ppy) }\OperatorTok{*}\NormalTok{ er.mean() }\OperatorTok{/}\NormalTok{ er.std()}
    \ControlFlowTok{else}\NormalTok{:}
\NormalTok{        sr }\OperatorTok{=} \VariableTok{None}
    
    \ControlFlowTok{return} \BuiltInTok{print}\NormalTok{(}
\NormalTok{        title,}
        \StringTok{\textquotesingle{}=\textquotesingle{}} \OperatorTok{*}\NormalTok{ width,}
        \StringTok{\textquotesingle{}\textquotesingle{}}\NormalTok{,}
        \StringTok{\textquotesingle{}Performance\textquotesingle{}}\NormalTok{,}
        \StringTok{\textquotesingle{}{-}\textquotesingle{}} \OperatorTok{*}\NormalTok{ width,}
        \StringTok{\textquotesingle{}Return:\textquotesingle{}}\NormalTok{.ljust(width }\OperatorTok{{-}} \DecValTok{6}\NormalTok{) }\OperatorTok{+} \SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{mu}\SpecialCharTok{:0.4f\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{,}
        \StringTok{\textquotesingle{}Volatility:\textquotesingle{}}\NormalTok{.ljust(width }\OperatorTok{{-}} \DecValTok{6}\NormalTok{) }\OperatorTok{+} \SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{sigma}\SpecialCharTok{:0.4f\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{,}
        \StringTok{\textquotesingle{}Sharpe Ratio:\textquotesingle{}}\NormalTok{.ljust(width }\OperatorTok{{-}} \DecValTok{6}\NormalTok{) }\OperatorTok{+} \SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{sr}\SpecialCharTok{:0.4f\}}\CharTok{\textbackslash{}n}\SpecialStringTok{\textquotesingle{}} \ControlFlowTok{if}\NormalTok{ sr }\KeywordTok{is} \KeywordTok{not} \VariableTok{None} \ControlFlowTok{else} \StringTok{\textquotesingle{}\textquotesingle{}}\NormalTok{,}
        \StringTok{\textquotesingle{}Weights\textquotesingle{}}\NormalTok{, }
        \StringTok{\textquotesingle{}{-}\textquotesingle{}} \OperatorTok{*}\NormalTok{ width, }
        \StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}}\NormalTok{.join([}\SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{\_r}\SpecialCharTok{\}}\SpecialStringTok{:\textquotesingle{}}\NormalTok{.ljust(width }\OperatorTok{{-}} \DecValTok{6}\NormalTok{) }\OperatorTok{+} \SpecialStringTok{f\textquotesingle{}}\SpecialCharTok{\{}\NormalTok{\_w}\SpecialCharTok{:0.4f\}}\SpecialStringTok{\textquotesingle{}} \ControlFlowTok{for}\NormalTok{ \_r, \_w }\KeywordTok{in} \BuiltInTok{zip}\NormalTok{(r.columns, w)]),}
\NormalTok{        sep}\OperatorTok{=}\StringTok{\textquotesingle{}}\CharTok{\textbackslash{}n}\StringTok{\textquotesingle{}}\NormalTok{,}
\NormalTok{    )}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{print\_port\_res(w}\OperatorTok{=}\NormalTok{res\_mv[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{], r}\OperatorTok{=}\NormalTok{returns, title}\OperatorTok{=}\StringTok{\textquotesingle{}Minimum Variance Portfolio\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Minimum Variance Portfolio
==========================

Performance
--------------------------
Return:             0.1897
Volatility:         0.2501

Weights
--------------------------
AAPL:               0.5064
AMZN:               0.0000
GOOG:               0.0933
MSFT:               0.4004
NVDA:               0.0000
TSLA:               0.0000
\end{verbatim}

\subsection{The Mean-Variance Efficient
Frontier}\label{the-mean-variance-efficient-frontier}

We will use the \texttt{minimize()} function to map the efficient
frontier. Here is a basic outline:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Create a NumPy array \texttt{tret} of target returns
\item
  Create an empty list \texttt{res\_ef} of \texttt{minimize()} results
\item
  Loop over \texttt{tret}, passing each as a constraint to the
  \texttt{minimize()} function
\item
  Append each \texttt{minimize()} result to \texttt{res\_ef}
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.mean()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Ticker
AAPL   0.0006
AMZN   0.0005
GOOG   0.0007
MSFT   0.0009
NVDA   0.0031
TSLA   0.0003
dtype: float64
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tret }\OperatorTok{=} \DecValTok{252} \OperatorTok{*}\NormalTok{ np.linspace(returns.mean().}\BuiltInTok{min}\NormalTok{(), returns.mean().}\BuiltInTok{max}\NormalTok{(), }\DecValTok{25}\NormalTok{)}

\NormalTok{tret}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0.0675, 0.0968, 0.1262, 0.1555, 0.1849, 0.2143, 0.2436, 0.273 ,
       0.3023, 0.3317, 0.3611, 0.3904, 0.4198, 0.4492, 0.4785, 0.5079,
       0.5372, 0.5666, 0.596 , 0.6253, 0.6547, 0.684 , 0.7134, 0.7428,
       0.7721])
\end{verbatim}

We will loop over these target returns, finding the minimum variance
portfolio for each target return.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_ef }\OperatorTok{=}\NormalTok{ []}

\ControlFlowTok{for}\NormalTok{ t }\KeywordTok{in}\NormalTok{ tret:}
\NormalTok{    \_ }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{        fun}\OperatorTok{=}\NormalTok{port\_vol, }\CommentTok{\# minimize portfolio volatility}
\NormalTok{        x0}\OperatorTok{=}\NormalTok{np.ones(returns.shape[}\DecValTok{1}\NormalTok{]) }\OperatorTok{/}\NormalTok{ returns.shape[}\DecValTok{1}\NormalTok{], }\CommentTok{\# initial portfolio weights of 1/n}
\NormalTok{        args}\OperatorTok{=}\NormalTok{(returns, }\DecValTok{252}\NormalTok{), }\CommentTok{\# additional arguments to fun, in order}
\NormalTok{        bounds}\OperatorTok{=}\NormalTok{[(}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ returns.columns], }\CommentTok{\# bounds limit the search space for each portfolio weight}
\NormalTok{        constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{            \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}, }\CommentTok{\# constrain sum of weights to one}
\NormalTok{            \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: port\_mean(x}\OperatorTok{=}\NormalTok{x, r}\OperatorTok{=}\NormalTok{returns, ppy}\OperatorTok{=}\DecValTok{252}\NormalTok{) }\OperatorTok{{-}}\NormalTok{ t\} }\CommentTok{\# constrains portfolio mean return to the target return}
\NormalTok{        )}
\NormalTok{    )}
\NormalTok{    res\_ef.append(\_)}
\end{Highlighting}
\end{Shaded}

List \texttt{res\_ef} contains the results of all 25 minimum-variance
portfolios. For example, \texttt{res\_ef{[}0{]}} is the minimum variance
portfolio for the lowest target return.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.columns}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Index(['AAPL', 'AMZN', 'GOOG', 'MSFT', 'NVDA', 'TSLA'], dtype='object', name='Ticker')
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_ef[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: 0.5658612930635905
       x: [ 0.000e+00  1.206e-10  0.000e+00  1.775e-16  0.000e+00
            1.000e+00]
     nit: 3
     jac: [ 1.383e-01  1.648e-01  1.271e-01  1.179e-01  2.690e-01
            5.659e-01]
    nfev: 21
    njev: 3
\end{verbatim}

I typically check that all portfolio volatility minimization succeeds.
If a portfolio volatility minimization fails, we should check our
function, bounds, and constraints.

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ r }\KeywordTok{in}\NormalTok{ res\_ef:}
    \ControlFlowTok{assert}\NormalTok{ r[}\StringTok{\textquotesingle{}success\textquotesingle{}}\NormalTok{] }
\end{Highlighting}
\end{Shaded}

We can combine the target returns and volatilities into a data frame
\texttt{ef}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ef }\OperatorTok{=}\NormalTok{ pd.DataFrame(}
\NormalTok{    \{}
        \StringTok{\textquotesingle{}tret\textquotesingle{}}\NormalTok{: tret,}
        \StringTok{\textquotesingle{}tvol\textquotesingle{}}\NormalTok{: np.array([r[}\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{] }\ControlFlowTok{if}\NormalTok{ r[}\StringTok{\textquotesingle{}success\textquotesingle{}}\NormalTok{] }\ControlFlowTok{else}\NormalTok{ np.nan }\ControlFlowTok{for}\NormalTok{ r }\KeywordTok{in}\NormalTok{ res\_ef])}
\NormalTok{    \}}
\NormalTok{)}

\NormalTok{ef.head()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lll@{}}
\toprule\noalign{}
& tret & tvol \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & 0.0675 & 0.5659 \\
1 & 0.0968 & 0.3984 \\
2 & 0.1262 & 0.2974 \\
3 & 0.1555 & 0.2597 \\
4 & 0.1849 & 0.2504 \\
\end{longtable}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ef.mul(}\DecValTok{100}\NormalTok{).plot(x}\OperatorTok{=}\StringTok{\textquotesingle{}tvol\textquotesingle{}}\NormalTok{, y}\OperatorTok{=}\StringTok{\textquotesingle{}tret\textquotesingle{}}\NormalTok{, legend}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Annualized Volatility (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}
    \SpecialStringTok{f\textquotesingle{}Efficient Frontier\textquotesingle{}} \OperatorTok{+}
    \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}n}\SpecialStringTok{for }\SpecialCharTok{\{}\StringTok{", "}\SpecialCharTok{.}\NormalTok{join(returns.columns)}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}} \OperatorTok{+}
    \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}n}\SpecialStringTok{from }\SpecialCharTok{\{}\NormalTok{returns}\SpecialCharTok{.}\NormalTok{index[}\DecValTok{0}\NormalTok{]}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{d}\SpecialCharTok{,} \OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{returns}\SpecialCharTok{.}\NormalTok{index[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{B }\OperatorTok{\%}\NormalTok{d}\SpecialCharTok{,} \OperatorTok{\%}\NormalTok{Y}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ t, x, y }\KeywordTok{in} \BuiltInTok{zip}\NormalTok{(}
\NormalTok{    returns.columns, }
\NormalTok{    returns.std().mul(}\DecValTok{100}\OperatorTok{*}\NormalTok{np.sqrt(}\DecValTok{252}\NormalTok{)),}
\NormalTok{    returns.mean().mul(}\DecValTok{100}\OperatorTok{*}\DecValTok{252}\NormalTok{)}
\NormalTok{):}
\NormalTok{    plt.annotate(text}\OperatorTok{=}\NormalTok{t, xy}\OperatorTok{=}\NormalTok{(x, y))}
    
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_lecture_files/figure-pdf/cell-38-output-1.png}

\chapter{Herron Topic 4 - Practice for Section
02}\label{herron-topic-4---practice-for-section-02}

\section{Announcements}\label{announcements-40}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  This week

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Tuesday: Herron Topic 4 on portfolio optimization
  \item
    Thursday and Friday: MSFQ assessment exam in your scheduled
    classroom and time
  \end{enumerate}
\item
  Next week

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Group work on Project 3 all week 3.Last week
  \item
    Tuesday: Project 3 due at 11:59 PM on Tuesday, 4/23
  \item
    Thursday and Friday: Office hours during class time
  \end{enumerate}
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-39}

Pease review the lecture notebook, which provides a streamlined
introduction to optimization in Python!

\section{Practice}\label{practice-40}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ scipy.optimize }\ImportTok{as}\NormalTok{ sco}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{Find the maximum Sharpe Ratio portfolio of MATANA stocks
over the last three
years}\label{find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years}

Note that \texttt{sco.minimize()} finds \emph{minimums}, so you need to
minimize the \emph{negative} Sharpe Ratio.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{matana }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}META AAPL TSLA AMZN NVDA GOOG\textquotesingle{}}\NormalTok{)}
\NormalTok{    [}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    .pct\_change()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  6 of 6 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pdr.DataReader(}
\NormalTok{        name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{        data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{        start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{    )}
\NormalTok{    [}\DecValTok{0}\NormalTok{]}
\NormalTok{    .div(}\DecValTok{100}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24060\2049483829.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_sharpe(x, r, tgt, ppy):}
\NormalTok{    rp }\OperatorTok{=}\NormalTok{ r.dot(x)}
\NormalTok{    rp\_tgt }\OperatorTok{=}\NormalTok{ rp.sub(tgt)}
    \ControlFlowTok{return}\NormalTok{ np.sqrt(ppy) }\OperatorTok{*}\NormalTok{ rp\_tgt.mean() }\OperatorTok{/}\NormalTok{ rp\_tgt.std()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_neg\_sharpe(x, r, tgt, ppy):}
    \ControlFlowTok{return} \OperatorTok{{-}}\DecValTok{1} \OperatorTok{*}\NormalTok{ calc\_sharpe(x}\OperatorTok{=}\NormalTok{x, r}\OperatorTok{=}\NormalTok{r, tgt}\OperatorTok{=}\NormalTok{tgt, ppy}\OperatorTok{=}\NormalTok{ppy)}
\end{Highlighting}
\end{Shaded}

After class, I decided to write a \texttt{get\_equal\_weights()}
function to easily calculate \(\frac{1}{n}\) portfolio weights.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ get\_equal\_weights(r):}
\NormalTok{    n }\OperatorTok{=}\NormalTok{ r.shape[}\DecValTok{1}\NormalTok{]}
    \ControlFlowTok{return}\NormalTok{ np.ones(n) }\OperatorTok{/}\NormalTok{ n}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x0 }\OperatorTok{=}\NormalTok{ get\_equal\_weights(r}\OperatorTok{=}\NormalTok{matana)}
\NormalTok{x0}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0.1667, 0.1667, 0.1667, 0.1667, 0.1667, 0.1667])
\end{verbatim}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

We can test our function!

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{x0,}
\NormalTok{    r}\OperatorTok{=}\NormalTok{matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{],}
\NormalTok{    tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{],}
\NormalTok{    ppy}\OperatorTok{=}\DecValTok{252}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.6336
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rp\_tgt }\OperatorTok{=}\NormalTok{ matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{].dot(x0).sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{])}
\NormalTok{np.sqrt(}\DecValTok{252}\NormalTok{) }\OperatorTok{*}\NormalTok{ rp\_tgt.mean() }\OperatorTok{/}\NormalTok{ rp\_tgt.std()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.6336
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_neg\_sharpe(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{x0, }
\NormalTok{    r}\OperatorTok{=}\NormalTok{matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], }
\NormalTok{    tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], }
\NormalTok{    ppy}\OperatorTok{=}\DecValTok{252}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-0.6336
\end{verbatim}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_sr }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_neg\_sharpe,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{matana.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], }\DecValTok{252}\NormalTok{),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{((}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ matana.columns),}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\} }\CommentTok{\# eq constraint met when equal to zero}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_sr}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -1.0660861330017297
       x: [ 0.000e+00  3.151e-17  5.204e-17  5.865e-17  1.000e+00
            3.647e-17]
     nit: 5
     jac: [ 3.206e-02  3.530e-01 -1.079e-02  1.151e-01 -3.910e-02
            2.773e-01]
    nfev: 35
    njev: 5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.barh(}
\NormalTok{    y}\OperatorTok{=}\NormalTok{matana.columns,}
\NormalTok{    width}\OperatorTok{=}\NormalTok{res\_sr[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Maximum Sharpe Ratio Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for MATANA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_02_files/figure-pdf/cell-14-output-1.png}

\subsection{Find the maximum Sharpe Ratio portfolio of MATANA stocks
over the last three years, but allow short weights up to 10\% on each
stock}\label{find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-allow-short-weights-up-to-10-on-each-stock}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_sr\_2 }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_neg\_sharpe,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{matana.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], }\DecValTok{252}\NormalTok{),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{((}\OperatorTok{{-}}\FloatTok{0.1}\NormalTok{, }\FloatTok{1.5}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ matana.columns),}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\} }\CommentTok{\# eq constraint met when equal to zero}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_sr\_2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -1.135301018089874
       x: [-1.000e-01 -1.000e-01  2.348e-01 -1.000e-01  1.165e+00
           -1.000e-01]
     nit: 6
     jac: [ 2.074e-02  3.100e-01  1.634e-02  7.954e-02  1.697e-02
            1.877e-01]
    nfev: 42
    njev: 6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    pd.DataFrame(}
\NormalTok{        data}\OperatorTok{=}\NormalTok{\{}
            \StringTok{\textquotesingle{}Long Only\textquotesingle{}}\NormalTok{: res\_sr[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
            \StringTok{\textquotesingle{}Short up to 10\% per Stock\textquotesingle{}}\NormalTok{: res\_sr\_2[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{        \},}
\NormalTok{        index}\OperatorTok{=}\NormalTok{matana.columns}
\NormalTok{    )}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}barh\textquotesingle{}}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Maximum Sharpe Ratio Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for MATANA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_02_files/figure-pdf/cell-16-output-1.png}

By relaxing the long-only constrain (via changes to \texttt{bounds=}),
the weights on AAPL, AMZN, META, and TSLA go from zero to -10\%. Also,
the Sharpe Ratio increases because we relax a binding constraint.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{res\_sr[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
\NormalTok{    r}\OperatorTok{=}\NormalTok{matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{],}
\NormalTok{    tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{],}
\NormalTok{    ppy}\OperatorTok{=}\DecValTok{252}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.0661
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{res\_sr\_2[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
\NormalTok{    r}\OperatorTok{=}\NormalTok{matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{],}
\NormalTok{    tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{],}
\NormalTok{    ppy}\OperatorTok{=}\DecValTok{252}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.1353
\end{verbatim}

\subsection{Find the maximum Sharpe Ratio portfolio of MATANA stocks
over the last three years, but allow total short weights of up to
30\%}\label{find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-allow-total-short-weights-of-up-to-30}

\textbf{\emph{Now we need an inequality constraint!}} We will use an
inequality constraint to make sure the sum of the negative portfolio
weights is greater than \(-0.3\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OperatorTok{=}\NormalTok{ np.arange(}\DecValTok{6}\NormalTok{) }\OperatorTok{{-}} \DecValTok{3}
\NormalTok{x}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([-3, -2, -1,  0,  1,  2])
\end{verbatim}

We do this by:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Slicing the negative weights in \texttt{x} with
  \texttt{x{[}x\ \textless{}\ 0{]}}
\item
  Constraining the sum of these negative weights to be \(\geq -0.3\),
  which is met when \texttt{x{[}x\ \textless{}\ 0{]}.sum()\ +\ 0.3} is
  non-negative.
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_sr\_3 }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_neg\_sharpe,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{matana.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], }\DecValTok{252}\NormalTok{),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{((}\OperatorTok{{-}}\FloatTok{0.3}\NormalTok{, }\FloatTok{1.3}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ matana.columns),}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}, }\CommentTok{\# eq constraint met when = 0}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}ineq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x[x }\OperatorTok{\textless{}} \DecValTok{0}\NormalTok{].}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{+} \FloatTok{0.3}\NormalTok{\} }\CommentTok{\# ineq constraint met when \textgreater{}= 0}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_sr\_3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -1.161652495526852
       x: [-1.078e-07 -2.999e-01  2.718e-01  1.015e-06  1.028e+00
           -5.136e-05]
     nit: 48
     jac: [ 5.524e-02  3.113e-01  4.331e-02  1.434e-01  4.188e-02
            3.028e-01]
    nfev: 530
    njev: 48
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    pd.DataFrame(}
\NormalTok{        data}\OperatorTok{=}\NormalTok{\{}
            \StringTok{\textquotesingle{}Long Only\textquotesingle{}}\NormalTok{: res\_sr[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
            \StringTok{\textquotesingle{}Short up to 10\% per Stock\textquotesingle{}}\NormalTok{: res\_sr\_2[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
            \StringTok{\textquotesingle{}Short up to 30\% Total\textquotesingle{}}\NormalTok{: res\_sr\_3[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{        \},}
\NormalTok{        index}\OperatorTok{=}\NormalTok{matana.columns}
\NormalTok{    )}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}barh\textquotesingle{}}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Maximum Sharpe Ratio Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for MATANA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_02_files/figure-pdf/cell-21-output-1.png}

The Sharpe Ratio is higher here than in the previous exercise, but this
will not always be the case because we relax slightly different
constraints. That is, here we allow up to 30\% short in one stock, but
only allow up to 30\% short across all stocks. In the previous example,
we only allow up to 10\% short in each stock, but allow up to 50\% short
across all stocks.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{res\_sr\_2[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
\NormalTok{    r}\OperatorTok{=}\NormalTok{matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{],}
\NormalTok{    tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{],}
\NormalTok{    ppy}\OperatorTok{=}\DecValTok{252}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.1353
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{res\_sr\_3[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
\NormalTok{    r}\OperatorTok{=}\NormalTok{matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{],}
\NormalTok{    tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{],}
\NormalTok{    ppy}\OperatorTok{=}\DecValTok{252}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.1617
\end{verbatim}

\subsection{Find the maximum Sharpe Ratio portfolio of MATANA stocks
over the last three years, but do not allow any weight to exceed 30\% in
magnitude}\label{find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-do-not-allow-any-weight-to-exceed-30-in-magnitude}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_sr\_4 }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_neg\_sharpe,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{matana.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], }\DecValTok{252}\NormalTok{),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{((}\DecValTok{0}\NormalTok{, }\FloatTok{0.3}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ matana.columns),}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}, }\CommentTok{\# eq constraint met when = 0}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_sr\_4}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -0.8830356219723998
       x: [ 3.000e-01  0.000e+00  3.000e-01  1.000e-01  3.000e-01
            2.862e-17]
     nit: 3
     jac: [ 1.089e-01  5.852e-01  8.385e-02  3.099e-01 -5.076e-01
            3.305e-01]
    nfev: 21
    njev: 3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    pd.DataFrame(}
\NormalTok{        data}\OperatorTok{=}\NormalTok{\{}
            \StringTok{\textquotesingle{}Long Only\textquotesingle{}}\NormalTok{: res\_sr[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
            \StringTok{\textquotesingle{}Short up to 10\% per Stock\textquotesingle{}}\NormalTok{: res\_sr\_2[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
            \StringTok{\textquotesingle{}Short up to 30\% Total\textquotesingle{}}\NormalTok{: res\_sr\_3[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
            \StringTok{\textquotesingle{}Long Only up to 30\% per Stock\textquotesingle{}}\NormalTok{: res\_sr\_4[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{        \},}
\NormalTok{        index}\OperatorTok{=}\NormalTok{matana.columns}
\NormalTok{    )}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}barh\textquotesingle{}}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Maximum Sharpe Ratio Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for MATANA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_02_files/figure-pdf/cell-25-output-1.png}

\subsection{Find the minimum 95\% Value at Risk (Var) portfolio of
MATANA stocks over the last three
years}\label{find-the-minimum-95-value-at-risk-var-portfolio-of-matana-stocks-over-the-last-three-years}

More on VaR \href{https://en.wikipedia.org/wiki/Value_at_risk}{here}.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_var(x, r, q):}
    \ControlFlowTok{return}\NormalTok{ r.dot(x).quantile(q)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_neg\_var(x, r, q):}
    \ControlFlowTok{return} \OperatorTok{{-}}\DecValTok{1} \OperatorTok{*}\NormalTok{ calc\_var(x}\OperatorTok{=}\NormalTok{x, r}\OperatorTok{=}\NormalTok{r, q}\OperatorTok{=}\NormalTok{q)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_var }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_neg\_var,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{matana.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], }\FloatTok{0.05}\NormalTok{),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{[(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ matana],}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}, }\CommentTok{\# minimize drives "eq" constraints to zero}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_var}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: 0.032516580628882644
       x: [ 2.102e-01  1.989e-01  2.292e-01  1.593e-01  0.000e+00
            2.024e-01]
     nit: 7
     jac: [ 3.662e-02  2.644e-02  2.760e-02  2.072e-02  3.928e-02
            4.908e-02]
    nfev: 61
    njev: 7
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_var(x}\OperatorTok{=}\NormalTok{res\_var[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{], r}\OperatorTok{=}\NormalTok{matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], q}\OperatorTok{=}\FloatTok{0.05}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-0.0325
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.barh(}
\NormalTok{    y}\OperatorTok{=}\NormalTok{matana.columns,}
\NormalTok{    width}\OperatorTok{=}\NormalTok{res\_var[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Minimum 5\% Value at Risk Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for MATANA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_02_files/figure-pdf/cell-30-output-1.png}

\subsection{Find the minimum maximum draw down portfolio of MATANA
stocks over the last three
years}\label{find-the-minimum-maximum-draw-down-portfolio-of-matana-stocks-over-the-last-three-years}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_max\_dd(x, r):}
\NormalTok{    rp }\OperatorTok{=}\NormalTok{ r.dot(x)}
\NormalTok{    pp }\OperatorTok{=}\NormalTok{ rp.add(}\DecValTok{1}\NormalTok{).cumprod()}
\NormalTok{    cummax }\OperatorTok{=}\NormalTok{ pp.cummax()}
\NormalTok{    dd }\OperatorTok{=}\NormalTok{ (cummax }\OperatorTok{{-}}\NormalTok{ pp) }\OperatorTok{/}\NormalTok{ cummax}
    \ControlFlowTok{return}\NormalTok{ dd.}\BuiltInTok{max}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_dd }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_max\_dd,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{matana.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{],),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{[(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ matana.columns],}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}, }\CommentTok{\# minimize drives "eq" constraints to zero}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_dd}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: 0.3091279768621034
       x: [ 1.000e+00  0.000e+00  0.000e+00  0.000e+00  0.000e+00
            0.000e+00]
     nit: 6
     jac: [ 2.995e-01  4.945e-01  3.778e-01  6.189e-01  4.966e-01
            8.402e-01]
    nfev: 42
    njev: 6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.barh(}
\NormalTok{    y}\OperatorTok{=}\NormalTok{matana.columns,}
\NormalTok{    width}\OperatorTok{=}\NormalTok{res\_dd[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Minimum Maximum Draw Down Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for MATANA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_02_files/figure-pdf/cell-33-output-1.png}

\subsection{Find the minimum maximum draw down portfolio with all
available data for the current Dow-Jones Industrial Average (DJIA)
stocks}\label{find-the-minimum-maximum-draw-down-portfolio-with-all-available-data-for-the-current-dow-jones-industrial-average-djia-stocks}

You can find the
\href{https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average}{DJIA
tickers on Wikipedia}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tickers }\OperatorTok{=}\NormalTok{ pd.read\_html(}\StringTok{\textquotesingle{}https://en.wikipedia.org/wiki/Dow\_Jones\_Industrial\_Average\textquotesingle{}}\NormalTok{)[}\DecValTok{1}\NormalTok{][}\StringTok{\textquotesingle{}Symbol\textquotesingle{}}\NormalTok{].to\_list()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{djia }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\NormalTok{tickers)}
\NormalTok{    [}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    .pct\_change()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  30 of 30 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_dd\_2 }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_max\_dd,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{djia.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{],),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{[(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ djia.columns],}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}, }\CommentTok{\# minimize drives "eq" constraints to zero}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_dd\_2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: 0.07659156578152274
       x: [ 4.176e-02  1.931e-02 ...  1.780e-02  4.305e-02]
     nit: 35
     jac: [-2.237e-02  1.809e-01 ...  4.256e-02  9.220e-02]
    nfev: 1140
    njev: 35
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.barh(}
\NormalTok{    y}\OperatorTok{=}\NormalTok{djia.columns,}
\NormalTok{    width}\OperatorTok{=}\NormalTok{res\_dd\_2[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Minimum Maximum Draw Down Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for DJIA Stocks from 2021 through 2023\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_02_files/figure-pdf/cell-37-output-1.png}

\subsection{Plot the (mean-variance) efficient frontier with all
available data for the current the DJIA
stocks}\label{plot-the-mean-variance-efficient-frontier-with-all-available-data-for-the-current-the-djia-stocks}

The range of target returns in \texttt{tret} span from the minimum to
the maximum mean single-stock returns. We will loop over these target
returns, finding the minimum variance portfolio for each target return.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{].mean().mul(}\DecValTok{252}\NormalTok{)}
\NormalTok{tret }\OperatorTok{=}\NormalTok{ np.linspace(\_.}\BuiltInTok{min}\NormalTok{(), \_.}\BuiltInTok{max}\NormalTok{(), }\DecValTok{25}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_vol(x, r, ppy):}
    \ControlFlowTok{return}\NormalTok{ np.sqrt(ppy) }\OperatorTok{*}\NormalTok{ r.dot(x).std()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_mean(x, r, ppy):}
    \ControlFlowTok{return}\NormalTok{ ppy }\OperatorTok{*}\NormalTok{ r.dot(x).mean()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_ef }\OperatorTok{=}\NormalTok{ []}

\ControlFlowTok{for}\NormalTok{ t }\KeywordTok{in}\NormalTok{ tret:}
\NormalTok{    \_ }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{        fun}\OperatorTok{=}\NormalTok{calc\_vol, }\CommentTok{\# minimize portfolio volatility}
\NormalTok{        x0}\OperatorTok{=}\NormalTok{djia.pipe(get\_equal\_weights), }\CommentTok{\# initial portfolio weights}
\NormalTok{        args}\OperatorTok{=}\NormalTok{(djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], }\DecValTok{252}\NormalTok{), }\CommentTok{\# additional arguments to fun, in order}
\NormalTok{        bounds}\OperatorTok{=}\NormalTok{((}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ djia.columns), }\CommentTok{\# bounds limit the search space for each portfolio weight}
\NormalTok{        constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{            \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}, }\CommentTok{\# constrain sum of weights to one}
\NormalTok{            \{}
                \StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }
                \StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: calc\_mean(x}\OperatorTok{=}\NormalTok{x, r}\OperatorTok{=}\NormalTok{djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], ppy}\OperatorTok{=}\DecValTok{252}\NormalTok{) }\OperatorTok{{-}}\NormalTok{ t}
\NormalTok{            \} }\CommentTok{\# constrains portfolio mean return to the target return}

\NormalTok{        )}
\NormalTok{    )}
\NormalTok{    res\_ef.append(\_)}
\end{Highlighting}
\end{Shaded}

List \texttt{res\_ef} contains the results of all 25 minimum-variance
portfolios. For example, \texttt{res\_ef{[}0{]}} is the minimum variance
portfolio for the lowest target return.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_ef[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: 0.2995484054001537
       x: [ 2.359e-16  1.249e-16 ...  7.006e-09  2.359e-16]
     nit: 2
     jac: [ 1.253e-01  3.352e-02 ...  4.880e-02  4.303e-02]
    nfev: 62
    njev: 2
\end{verbatim}

I typically check that all portfolio volatility minimization succeeds.
If a portfolio volatility minimization fails, we should check our
function, bounds, and constraints.

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ r }\KeywordTok{in}\NormalTok{ res\_ef:}
    \ControlFlowTok{assert}\NormalTok{ r[}\StringTok{\textquotesingle{}success\textquotesingle{}}\NormalTok{] }
\end{Highlighting}
\end{Shaded}

We can combine the target returns and volatilities into a data frame
\texttt{ef}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ef }\OperatorTok{=}\NormalTok{ pd.DataFrame(}
\NormalTok{    \{}
        \StringTok{\textquotesingle{}tret\textquotesingle{}}\NormalTok{: tret,}
        \StringTok{\textquotesingle{}tvol\textquotesingle{}}\NormalTok{: [r[}\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{] }\ControlFlowTok{if}\NormalTok{ r[}\StringTok{\textquotesingle{}success\textquotesingle{}}\NormalTok{] }\ControlFlowTok{else}\NormalTok{ np.nan }\ControlFlowTok{for}\NormalTok{ r }\KeywordTok{in}\NormalTok{ res\_ef]}
\NormalTok{    \}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ef.mul(}\DecValTok{100}\NormalTok{).plot(x}\OperatorTok{=}\StringTok{\textquotesingle{}tvol\textquotesingle{}}\NormalTok{, y}\OperatorTok{=}\StringTok{\textquotesingle{}tret\textquotesingle{}}\NormalTok{, legend}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Annualized Volatility (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Mean{-}Variance Efficient Frontier}\CharTok{\textbackslash{}n}\StringTok{ for DJIA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ t, x, y }\KeywordTok{in} \BuiltInTok{zip}\NormalTok{(}
\NormalTok{    djia.columns, }
\NormalTok{    djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{].std().mul(}\DecValTok{100}\OperatorTok{*}\NormalTok{np.sqrt(}\DecValTok{252}\NormalTok{)),}
\NormalTok{    djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{].mean().mul(}\DecValTok{100}\OperatorTok{*}\DecValTok{252}\NormalTok{)}
\NormalTok{):}
\NormalTok{    plt.annotate(text}\OperatorTok{=}\NormalTok{t, xy}\OperatorTok{=}\NormalTok{(x, y))}
    
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_02_files/figure-pdf/cell-45-output-1.png}

\subsection{Find the maximum Sharpe Ratio portfolio with all available
data for the current the DJIA
stocks}\label{find-the-maximum-sharpe-ratio-portfolio-with-all-available-data-for-the-current-the-djia-stocks}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_sr\_5 }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_neg\_sharpe,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{djia.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], }\DecValTok{252}\NormalTok{),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{((}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ djia.columns),}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_sr\_5}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -1.2674934504347588
       x: [ 8.712e-16  1.240e-02 ...  0.000e+00  6.530e-16]
     nit: 9
     jac: [ 1.679e-01 -1.458e-01 ...  1.165e+00  1.698e-01]
    nfev: 282
    njev: 9
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.barh(}
\NormalTok{    y}\OperatorTok{=}\NormalTok{djia.columns,}
\NormalTok{    width}\OperatorTok{=}\NormalTok{res\_sr\_5[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Maximum Sharpe Ratio Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for DJIA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_02_files/figure-pdf/cell-47-output-1.png}

\subsection{\texorpdfstring{Compare the \(\frac{1}{n}\) and maximum
Sharpe Ratio portfolios with all available data for the current DJIA
stocks}{Compare the \textbackslash frac\{1\}\{n\} and maximum Sharpe Ratio portfolios with all available data for the current DJIA stocks}}\label{compare-the-frac1n-and-maximum-sharpe-ratio-portfolios-with-all-available-data-for-the-current-djia-stocks}

Use all but the last 252 trading days to estimate the maximum Sharpe
Ratio portfolio weights. Then use the last 252 trading days of data to
compare the \(\frac{1}{n}\) maximum Sharpe Ratio portfolios.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_sr\_6 }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_neg\_sharpe,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{djia.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2022\textquotesingle{}}\NormalTok{], ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], }\DecValTok{252}\NormalTok{),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{((}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ djia.columns),}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_sr\_6}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -1.8291515081469893
       x: [ 1.662e-15  0.000e+00 ...  2.792e-16  0.000e+00]
     nit: 7
     jac: [ 8.874e-01  5.597e-02 ...  1.586e+00  5.228e-01]
    nfev: 220
    njev: 7
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.barh(}
\NormalTok{    y}\OperatorTok{=}\NormalTok{djia.columns,}
\NormalTok{    width}\OperatorTok{=}\NormalTok{res\_sr\_6[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
\NormalTok{    label}\OperatorTok{=}\StringTok{\textquotesingle{}Maximum Sharpe Ratio Weights\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.axvline(}\DecValTok{1}\OperatorTok{/}\DecValTok{30}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}red\textquotesingle{}}\NormalTok{, label}\OperatorTok{=}\StringTok{\textquotesingle{}Equal Weights\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.legend()}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Maximum Sharpe Ratio Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for DJIA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_02_files/figure-pdf/cell-49-output-1.png}

Here is the how max Sharpe portfolio does in 2023:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(x}\OperatorTok{=}\NormalTok{res\_sr\_6[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{], r}\OperatorTok{=}\NormalTok{djia.loc[}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], ppy}\OperatorTok{=}\DecValTok{252}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-0.5146
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(x}\OperatorTok{=}\NormalTok{np.ones(djia.shape[}\DecValTok{1}\NormalTok{]) }\OperatorTok{/}\NormalTok{ djia.shape[}\DecValTok{1}\NormalTok{], r}\OperatorTok{=}\NormalTok{djia.loc[}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], ppy}\OperatorTok{=}\DecValTok{252}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.2388
\end{verbatim}

It is hard to beat the \(\frac{1}{n}\) portfolio because mean returns
are hard to predict!

\chapter{Herron Topic 4 - Practice for Section
03}\label{herron-topic-4---practice-for-section-03}

\section{Announcements}\label{announcements-41}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  This week:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Tuesday: Herron Topic 4 on portfolio optimization
  \item
    Thursday and Friday: MSFQ assessment exam in your scheduled
    classroom and time
  \end{enumerate}
\item
  Next week: Group work on Project 3 all week
\item
  Last week:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Tuesday: Project 3 due at 11:59 PM on Tuesday, 4/23
  \item
    Thursday and Friday: Office hours during class time
  \end{enumerate}
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-40}

Pease review the lecture notebook, which provides a streamlined
introduction to optimization in Python!

\section{Practice}\label{practice-41}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ scipy.optimize }\ImportTok{as}\NormalTok{ sco}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{Find the maximum Sharpe Ratio portfolio of MATANA stocks
over the last three
years}\label{find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-1}

Note that \texttt{sco.minimize()} finds \emph{minimums}, so you need to
minimize the \emph{negative} Sharpe Ratio.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{matana }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}META AAPL TSLA AMZN NVDA GOOG\textquotesingle{}}\NormalTok{)}
\NormalTok{    [}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    .pct\_change()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  6 of 6 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pdr.DataReader(}
\NormalTok{        name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{        data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{        start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{    )}
\NormalTok{    [}\DecValTok{0}\NormalTok{]}
\NormalTok{    .div(}\DecValTok{100}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_9456\2049483829.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_sharpe(x, r, tgt, ppy):}
\NormalTok{    rp }\OperatorTok{=}\NormalTok{ r.dot(x)}
\NormalTok{    rp\_tgt }\OperatorTok{=}\NormalTok{ rp.sub(tgt)}
    \ControlFlowTok{return}\NormalTok{ np.sqrt(ppy) }\OperatorTok{*}\NormalTok{ rp\_tgt.mean() }\OperatorTok{/}\NormalTok{ rp\_tgt.std()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_neg\_sharpe(x, r, tgt, ppy):}
    \ControlFlowTok{return} \OperatorTok{{-}}\DecValTok{1} \OperatorTok{*}\NormalTok{ calc\_sharpe(x}\OperatorTok{=}\NormalTok{x, r}\OperatorTok{=}\NormalTok{r, tgt}\OperatorTok{=}\NormalTok{tgt, ppy}\OperatorTok{=}\NormalTok{ppy)}
\end{Highlighting}
\end{Shaded}

After class, I decided to write a \texttt{get\_equal\_weights()}
function to easily calculate \(\frac{1}{n}\) portfolio weights.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ get\_equal\_weights(r):}
\NormalTok{    n }\OperatorTok{=}\NormalTok{ r.shape[}\DecValTok{1}\NormalTok{]}
    \ControlFlowTok{return}\NormalTok{ np.ones(n) }\OperatorTok{/}\NormalTok{ n}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x0 }\OperatorTok{=}\NormalTok{ get\_equal\_weights(r}\OperatorTok{=}\NormalTok{matana)}
\NormalTok{x0}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0.1667, 0.1667, 0.1667, 0.1667, 0.1667, 0.1667])
\end{verbatim}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

We can test our function!

\begin{Shaded}
\begin{Highlighting}[]

\NormalTok{calc\_sharpe(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{x0,}
\NormalTok{    r}\OperatorTok{=}\NormalTok{matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{],}
\NormalTok{    tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{],}
\NormalTok{    ppy}\OperatorTok{=}\DecValTok{252}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.6336
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rp\_tgt }\OperatorTok{=}\NormalTok{ matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{].dot(x0).sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{])}
\NormalTok{np.sqrt(}\DecValTok{252}\NormalTok{) }\OperatorTok{*}\NormalTok{ rp\_tgt.mean() }\OperatorTok{/}\NormalTok{ rp\_tgt.std()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.6336
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_neg\_sharpe(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{x0, }
\NormalTok{    r}\OperatorTok{=}\NormalTok{matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], }
\NormalTok{    tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], }
\NormalTok{    ppy}\OperatorTok{=}\DecValTok{252}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-0.6336
\end{verbatim}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_sr }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_neg\_sharpe,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{matana.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], }\DecValTok{252}\NormalTok{),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{((}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ matana.columns),}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\} }\CommentTok{\# eq constraint met when equal to zero}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_sr}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -1.0660861120691252
       x: [ 4.957e-17  0.000e+00  0.000e+00  3.409e-17  1.000e+00
            7.178e-17]
     nit: 5
     jac: [ 3.206e-02  3.530e-01 -1.079e-02  1.151e-01 -3.910e-02
            2.773e-01]
    nfev: 35
    njev: 5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.barh(}
\NormalTok{    y}\OperatorTok{=}\NormalTok{matana.columns,}
\NormalTok{    width}\OperatorTok{=}\NormalTok{res\_sr[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Maximum Sharpe Ratio Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for MATANA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_03_files/figure-pdf/cell-14-output-1.png}

\subsection{Find the maximum Sharpe Ratio portfolio of MATANA stocks
over the last three years, but allow short weights up to 10\% on each
stock}\label{find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-allow-short-weights-up-to-10-on-each-stock-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_sr\_2 }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_neg\_sharpe,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{matana.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], }\DecValTok{252}\NormalTok{),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{((}\OperatorTok{{-}}\FloatTok{0.1}\NormalTok{, }\FloatTok{1.5}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ matana.columns),}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\} }\CommentTok{\# eq constraint met when equal to zero}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_sr\_2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -1.13530096310489
       x: [-1.000e-01 -1.000e-01  2.348e-01 -1.000e-01  1.165e+00
           -1.000e-01]
     nit: 6
     jac: [ 2.074e-02  3.100e-01  1.634e-02  7.954e-02  1.697e-02
            1.877e-01]
    nfev: 42
    njev: 6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    pd.DataFrame(}
\NormalTok{        data}\OperatorTok{=}\NormalTok{\{}
            \StringTok{\textquotesingle{}Long Only\textquotesingle{}}\NormalTok{: res\_sr[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
            \StringTok{\textquotesingle{}Short up to 10\% per Stock\textquotesingle{}}\NormalTok{: res\_sr\_2[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{        \},}
\NormalTok{        index}\OperatorTok{=}\NormalTok{matana.columns}
\NormalTok{    )}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}barh\textquotesingle{}}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Maximum Sharpe Ratio Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for MATANA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_03_files/figure-pdf/cell-16-output-1.png}

By relaxing the long-only constrain (via changes to \texttt{bounds=}),
the weights on AAPL, AMZN, META, and TSLA go from zero to -10\%. Also,
the Sharpe Ratio increases because we relax a binding constraint.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{res\_sr[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
\NormalTok{    r}\OperatorTok{=}\NormalTok{matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{],}
\NormalTok{    tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{],}
\NormalTok{    ppy}\OperatorTok{=}\DecValTok{252}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.0661
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{res\_sr\_2[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
\NormalTok{    r}\OperatorTok{=}\NormalTok{matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{],}
\NormalTok{    tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{],}
\NormalTok{    ppy}\OperatorTok{=}\DecValTok{252}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.1353
\end{verbatim}

\subsection{Find the maximum Sharpe Ratio portfolio of MATANA stocks
over the last three years, but allow total short weights of up to
30\%}\label{find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-allow-total-short-weights-of-up-to-30-1}

\textbf{\emph{Now we need an inequality constraint!}} We will use an
inequality constraint to make sure the sum of the negative portfolio
weights is greater than \(-0.3\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OperatorTok{=}\NormalTok{ np.arange(}\DecValTok{6}\NormalTok{) }\OperatorTok{{-}} \DecValTok{3}
\NormalTok{x}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([-3, -2, -1,  0,  1,  2])
\end{verbatim}

We do this by:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Slicing the negative weights in \texttt{x} with
  \texttt{x{[}x\ \textless{}\ 0{]}}
\item
  Constraining the sum of these negative weights to be \(\geq -0.3\),
  which is met when \texttt{x{[}x\ \textless{}\ 0{]}.sum()\ +\ 0.3} is
  non-negative.
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_sr\_3 }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_neg\_sharpe,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{matana.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], }\DecValTok{252}\NormalTok{),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{((}\OperatorTok{{-}}\FloatTok{0.3}\NormalTok{, }\FloatTok{1.3}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ matana.columns),}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}, }\CommentTok{\# eq constraint met when = 0}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}ineq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x[x }\OperatorTok{\textless{}} \DecValTok{0}\NormalTok{].}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{+} \FloatTok{0.3}\NormalTok{\} }\CommentTok{\# ineq constraint met when \textgreater{}= 0}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_sr\_3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\miniconda3\envs\fina6333\Lib\site-packages\scipy\optimize\_optimize.py:404: RuntimeWarning: Values in x were outside bounds during a minimize step, clipping to bounds
  warnings.warn("Values in x were outside bounds during a "
\end{verbatim}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -1.1616529795363868
       x: [ 5.476e-07 -3.000e-01  2.717e-01 -2.773e-08  1.028e+00
           -2.239e-05]
     nit: 43
     jac: [ 5.523e-02  3.113e-01  4.328e-02  1.434e-01  4.188e-02
            3.028e-01]
    nfev: 471
    njev: 43
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    pd.DataFrame(}
\NormalTok{        data}\OperatorTok{=}\NormalTok{\{}
            \StringTok{\textquotesingle{}Long Only\textquotesingle{}}\NormalTok{: res\_sr[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
            \StringTok{\textquotesingle{}Short up to 10\% per Stock\textquotesingle{}}\NormalTok{: res\_sr\_2[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
            \StringTok{\textquotesingle{}Short up to 30\% Total\textquotesingle{}}\NormalTok{: res\_sr\_3[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{        \},}
\NormalTok{        index}\OperatorTok{=}\NormalTok{matana.columns}
\NormalTok{    )}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}barh\textquotesingle{}}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Maximum Sharpe Ratio Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for MATANA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_03_files/figure-pdf/cell-21-output-1.png}

The Sharpe Ratio is higher here than in the previous exercise, but this
will not always be the case because we relax slightly different
constraints. That is, here we allow up to 30\% short in one stock, but
only allow up to 30\% short across all stocks. In the previous example,
we only allow up to 10\% short in each stock, but allow up to 50\% short
across all stocks.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{res\_sr\_2[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
\NormalTok{    r}\OperatorTok{=}\NormalTok{matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{],}
\NormalTok{    tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{],}
\NormalTok{    ppy}\OperatorTok{=}\DecValTok{252}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.1353
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{res\_sr\_3[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
\NormalTok{    r}\OperatorTok{=}\NormalTok{matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{],}
\NormalTok{    tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{],}
\NormalTok{    ppy}\OperatorTok{=}\DecValTok{252}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.1617
\end{verbatim}

\subsection{Find the maximum Sharpe Ratio portfolio of MATANA stocks
over the last three years, but do not allow any weight to exceed 30\% in
magnitude}\label{find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-do-not-allow-any-weight-to-exceed-30-in-magnitude-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_sr\_4 }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_neg\_sharpe,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{matana.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], }\DecValTok{252}\NormalTok{),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{((}\DecValTok{0}\NormalTok{, }\FloatTok{0.3}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ matana.columns),}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}, }\CommentTok{\# eq constraint met when = 0}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_sr\_4}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -0.8830355215983107
       x: [ 3.000e-01  0.000e+00  3.000e-01  1.000e-01  3.000e-01
            9.194e-17]
     nit: 3
     jac: [ 1.089e-01  5.852e-01  8.385e-02  3.099e-01 -5.076e-01
            3.305e-01]
    nfev: 21
    njev: 3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    pd.DataFrame(}
\NormalTok{        data}\OperatorTok{=}\NormalTok{\{}
            \StringTok{\textquotesingle{}Long Only\textquotesingle{}}\NormalTok{: res\_sr[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
            \StringTok{\textquotesingle{}Short up to 10\% per Stock\textquotesingle{}}\NormalTok{: res\_sr\_2[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
            \StringTok{\textquotesingle{}Short up to 30\% Total\textquotesingle{}}\NormalTok{: res\_sr\_3[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
            \StringTok{\textquotesingle{}Long Only up to 30\% per Stock\textquotesingle{}}\NormalTok{: res\_sr\_4[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{        \},}
\NormalTok{        index}\OperatorTok{=}\NormalTok{matana.columns}
\NormalTok{    )}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}barh\textquotesingle{}}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Maximum Sharpe Ratio Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for MATANA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_03_files/figure-pdf/cell-25-output-1.png}

\subsection{Find the minimum 95\% Value at Risk (Var) portfolio of
MATANA stocks over the last three
years}\label{find-the-minimum-95-value-at-risk-var-portfolio-of-matana-stocks-over-the-last-three-years-1}

More on VaR \href{https://en.wikipedia.org/wiki/Value_at_risk}{here}.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_var(x, r, q):}
    \ControlFlowTok{return}\NormalTok{ r.dot(x).quantile(q)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_neg\_var(x, r, q):}
    \ControlFlowTok{return} \OperatorTok{{-}}\DecValTok{1} \OperatorTok{*}\NormalTok{ calc\_var(x}\OperatorTok{=}\NormalTok{x, r}\OperatorTok{=}\NormalTok{r, q}\OperatorTok{=}\NormalTok{q)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_var }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_neg\_var,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{matana.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], }\FloatTok{0.05}\NormalTok{),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{[(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ matana],}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}, }\CommentTok{\# minimize drives "eq" constraints to zero}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_var}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: 0.032516573438853356
       x: [ 2.102e-01  1.989e-01  2.292e-01  1.593e-01  2.788e-17
            2.024e-01]
     nit: 7
     jac: [ 3.662e-02  2.644e-02  2.760e-02  2.072e-02  3.928e-02
            4.908e-02]
    nfev: 61
    njev: 7
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_var(x}\OperatorTok{=}\NormalTok{res\_var[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{], r}\OperatorTok{=}\NormalTok{matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], q}\OperatorTok{=}\FloatTok{0.05}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-0.0325
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.barh(}
\NormalTok{    y}\OperatorTok{=}\NormalTok{matana.columns,}
\NormalTok{    width}\OperatorTok{=}\NormalTok{res\_var[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Minimum 5\% Value at Risk Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for MATANA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_03_files/figure-pdf/cell-30-output-1.png}

\subsection{Find the minimum maximum draw down portfolio of MATANA
stocks over the last three
years}\label{find-the-minimum-maximum-draw-down-portfolio-of-matana-stocks-over-the-last-three-years-1}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_max\_dd(x, r):}
\NormalTok{    rp }\OperatorTok{=}\NormalTok{ r.dot(x)}
\NormalTok{    pp }\OperatorTok{=}\NormalTok{ rp.add(}\DecValTok{1}\NormalTok{).cumprod()}
\NormalTok{    cummax }\OperatorTok{=}\NormalTok{ pp.cummax()}
\NormalTok{    dd }\OperatorTok{=}\NormalTok{ (cummax }\OperatorTok{{-}}\NormalTok{ pp) }\OperatorTok{/}\NormalTok{ cummax}
    \ControlFlowTok{return}\NormalTok{ dd.}\BuiltInTok{max}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_dd }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_max\_dd,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{matana.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{],),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{[(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ matana.columns],}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}, }\CommentTok{\# minimize drives "eq" constraints to zero}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_dd}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: 0.3091281528292103
       x: [ 1.000e+00  0.000e+00  0.000e+00  0.000e+00  0.000e+00
            0.000e+00]
     nit: 6
     jac: [ 2.995e-01  4.945e-01  3.778e-01  6.189e-01  4.966e-01
            8.402e-01]
    nfev: 42
    njev: 6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.barh(}
\NormalTok{    y}\OperatorTok{=}\NormalTok{matana.columns,}
\NormalTok{    width}\OperatorTok{=}\NormalTok{res\_dd[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Minimum Maximum Draw Down Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for MATANA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_03_files/figure-pdf/cell-33-output-1.png}

\subsection{Find the minimum maximum draw down portfolio with all
available data for the current Dow-Jones Industrial Average (DJIA)
stocks}\label{find-the-minimum-maximum-draw-down-portfolio-with-all-available-data-for-the-current-dow-jones-industrial-average-djia-stocks-1}

You can find the
\href{https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average}{DJIA
tickers on Wikipedia}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tickers }\OperatorTok{=}\NormalTok{ pd.read\_html(}\StringTok{\textquotesingle{}https://en.wikipedia.org/wiki/Dow\_Jones\_Industrial\_Average\textquotesingle{}}\NormalTok{)[}\DecValTok{1}\NormalTok{][}\StringTok{\textquotesingle{}Symbol\textquotesingle{}}\NormalTok{].to\_list()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{djia }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\NormalTok{tickers)}
\NormalTok{    [}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    .pct\_change()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  30 of 30 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_dd\_2 }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_max\_dd,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{djia.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{],),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{[(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ djia.columns],}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}, }\CommentTok{\# minimize drives "eq" constraints to zero}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_dd\_2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: 0.07659155782931011
       x: [ 4.176e-02  1.931e-02 ...  1.780e-02  4.305e-02]
     nit: 35
     jac: [-2.237e-02  1.809e-01 ...  4.256e-02  9.220e-02]
    nfev: 1140
    njev: 35
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.barh(}
\NormalTok{    y}\OperatorTok{=}\NormalTok{djia.columns,}
\NormalTok{    width}\OperatorTok{=}\NormalTok{res\_dd\_2[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Minimum Maximum Draw Down Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for DJIA Stocks from 2021 through 2023\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_03_files/figure-pdf/cell-37-output-1.png}

\subsection{Plot the (mean-variance) efficient frontier with all
available data for the current the DJIA
stocks}\label{plot-the-mean-variance-efficient-frontier-with-all-available-data-for-the-current-the-djia-stocks-1}

The range of target returns in \texttt{tret} span from the minimum to
the maximum mean single-stock returns. We will loop over these target
returns, finding the minimum variance portfolio for each target return.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{].mean().mul(}\DecValTok{252}\NormalTok{)}
\NormalTok{tret }\OperatorTok{=}\NormalTok{ np.linspace(\_.}\BuiltInTok{min}\NormalTok{(), \_.}\BuiltInTok{max}\NormalTok{(), }\DecValTok{25}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_vol(x, r, ppy):}
    \ControlFlowTok{return}\NormalTok{ np.sqrt(ppy) }\OperatorTok{*}\NormalTok{ r.dot(x).std()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_mean(x, r, ppy):}
    \ControlFlowTok{return}\NormalTok{ ppy }\OperatorTok{*}\NormalTok{ r.dot(x).mean()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_ef }\OperatorTok{=}\NormalTok{ []}

\ControlFlowTok{for}\NormalTok{ t }\KeywordTok{in}\NormalTok{ tret:}
\NormalTok{    \_ }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{        fun}\OperatorTok{=}\NormalTok{calc\_vol, }\CommentTok{\# minimize portfolio volatility}
\NormalTok{        x0}\OperatorTok{=}\NormalTok{djia.pipe(get\_equal\_weights), }\CommentTok{\# initial portfolio weights}
\NormalTok{        args}\OperatorTok{=}\NormalTok{(djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], }\DecValTok{252}\NormalTok{), }\CommentTok{\# additional arguments to fun, in order}
\NormalTok{        bounds}\OperatorTok{=}\NormalTok{((}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ djia.columns), }\CommentTok{\# bounds limit the search space for each portfolio weight}
\NormalTok{        constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{            \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}, }\CommentTok{\# constrain sum of weights to one}
\NormalTok{            \{}
                \StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }
                \StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: calc\_mean(x}\OperatorTok{=}\NormalTok{x, r}\OperatorTok{=}\NormalTok{djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], ppy}\OperatorTok{=}\DecValTok{252}\NormalTok{) }\OperatorTok{{-}}\NormalTok{ t}
\NormalTok{            \} }\CommentTok{\# constrains portfolio mean return to the target return}

\NormalTok{        )}
\NormalTok{    )}
\NormalTok{    res\_ef.append(\_)}
\end{Highlighting}
\end{Shaded}

List \texttt{res\_ef} contains the results of all 25 minimum-variance
portfolios. For example, \texttt{res\_ef{[}0{]}} is the minimum variance
portfolio for the lowest target return.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_ef[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: 0.29954840655072656
       x: [ 2.359e-16  0.000e+00 ...  2.418e-09  0.000e+00]
     nit: 2
     jac: [ 1.253e-01  3.352e-02 ...  4.880e-02  4.303e-02]
    nfev: 62
    njev: 2
\end{verbatim}

I typically check that all portfolio volatility minimization succeeds.
If a portfolio volatility minimization fails, we should check our
function, bounds, and constraints.

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ r }\KeywordTok{in}\NormalTok{ res\_ef:}
    \ControlFlowTok{assert}\NormalTok{ r[}\StringTok{\textquotesingle{}success\textquotesingle{}}\NormalTok{] }
\end{Highlighting}
\end{Shaded}

We can combine the target returns and volatilities into a data frame
\texttt{ef}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ef }\OperatorTok{=}\NormalTok{ pd.DataFrame(}
\NormalTok{    \{}
        \StringTok{\textquotesingle{}tret\textquotesingle{}}\NormalTok{: tret,}
        \StringTok{\textquotesingle{}tvol\textquotesingle{}}\NormalTok{: [r[}\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{] }\ControlFlowTok{if}\NormalTok{ r[}\StringTok{\textquotesingle{}success\textquotesingle{}}\NormalTok{] }\ControlFlowTok{else}\NormalTok{ np.nan }\ControlFlowTok{for}\NormalTok{ r }\KeywordTok{in}\NormalTok{ res\_ef]}
\NormalTok{    \}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ef.mul(}\DecValTok{100}\NormalTok{).plot(x}\OperatorTok{=}\StringTok{\textquotesingle{}tvol\textquotesingle{}}\NormalTok{, y}\OperatorTok{=}\StringTok{\textquotesingle{}tret\textquotesingle{}}\NormalTok{, legend}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Annualized Volatility (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Mean{-}Variance Efficient Frontier}\CharTok{\textbackslash{}n}\StringTok{for DJIA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ t, x, y }\KeywordTok{in} \BuiltInTok{zip}\NormalTok{(}
\NormalTok{    djia.columns, }
\NormalTok{    djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{].std().mul(}\DecValTok{100}\OperatorTok{*}\NormalTok{np.sqrt(}\DecValTok{252}\NormalTok{)),}
\NormalTok{    djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{].mean().mul(}\DecValTok{100}\OperatorTok{*}\DecValTok{252}\NormalTok{)}
\NormalTok{):}
\NormalTok{    plt.annotate(text}\OperatorTok{=}\NormalTok{t, xy}\OperatorTok{=}\NormalTok{(x, y))}
    
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_03_files/figure-pdf/cell-45-output-1.png}

\subsection{Find the maximum Sharpe Ratio portfolio with all available
data for the current the DJIA
stocks}\label{find-the-maximum-sharpe-ratio-portfolio-with-all-available-data-for-the-current-the-djia-stocks-1}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_sr\_5 }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_neg\_sharpe,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{djia.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], }\DecValTok{252}\NormalTok{),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{((}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ djia.columns),}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_sr\_5}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -1.2674934306134356
       x: [ 0.000e+00  1.240e-02 ...  1.018e-15  0.000e+00]
     nit: 9
     jac: [ 1.679e-01 -1.458e-01 ...  1.165e+00  1.698e-01]
    nfev: 282
    njev: 9
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.barh(}
\NormalTok{    y}\OperatorTok{=}\NormalTok{djia.columns,}
\NormalTok{    width}\OperatorTok{=}\NormalTok{res\_sr\_5[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Maximum Sharpe Ratio Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for DJIA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_03_files/figure-pdf/cell-47-output-1.png}

\subsection{\texorpdfstring{Compare the \(\frac{1}{n}\) and maximum
Sharpe Ratio portfolios with all available data for the current DJIA
stocks}{Compare the \textbackslash frac\{1\}\{n\} and maximum Sharpe Ratio portfolios with all available data for the current DJIA stocks}}\label{compare-the-frac1n-and-maximum-sharpe-ratio-portfolios-with-all-available-data-for-the-current-djia-stocks-1}

Use all but the last 252 trading days to estimate the maximum Sharpe
Ratio portfolio weights. Then use the last 252 trading days of data to
compare the \(\frac{1}{n}\) maximum Sharpe Ratio portfolios.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_sr\_6 }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_neg\_sharpe,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{djia.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2022\textquotesingle{}}\NormalTok{], ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], }\DecValTok{252}\NormalTok{),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{((}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ djia.columns),}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_sr\_6}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -1.8291517812610791
       x: [ 2.365e-16  3.515e-16 ...  0.000e+00  9.216e-19]
     nit: 7
     jac: [ 8.874e-01  5.597e-02 ...  1.586e+00  5.228e-01]
    nfev: 220
    njev: 7
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.barh(}
\NormalTok{    y}\OperatorTok{=}\NormalTok{djia.columns,}
\NormalTok{    width}\OperatorTok{=}\NormalTok{res\_sr\_6[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
\NormalTok{    label}\OperatorTok{=}\StringTok{\textquotesingle{}Maximum Sharpe Ratio Weights\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.axvline(}\DecValTok{1}\OperatorTok{/}\DecValTok{30}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}red\textquotesingle{}}\NormalTok{, label}\OperatorTok{=}\StringTok{\textquotesingle{}Equal Weights\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.legend()}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Maximum Sharpe Ratio Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for DJIA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_03_files/figure-pdf/cell-49-output-1.png}

Here is the how max Sharpe portfolio does in 2023:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(x}\OperatorTok{=}\NormalTok{res\_sr\_6[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{], r}\OperatorTok{=}\NormalTok{djia.loc[}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], ppy}\OperatorTok{=}\DecValTok{252}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-0.5146
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(x}\OperatorTok{=}\NormalTok{np.ones(djia.shape[}\DecValTok{1}\NormalTok{]) }\OperatorTok{/}\NormalTok{ djia.shape[}\DecValTok{1}\NormalTok{], r}\OperatorTok{=}\NormalTok{djia.loc[}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], ppy}\OperatorTok{=}\DecValTok{252}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.2388
\end{verbatim}

It is hard to beat the \(\frac{1}{n}\) portfolio because mean returns
are hard to predict!

\chapter{Herron Topic 4 - Practice for Section
04}\label{herron-topic-4---practice-for-section-04}

\section{Announcements}\label{announcements-42}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  This week:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Tuesday: Herron Topic 4 on portfolio optimization
  \item
    Thursday and Friday: MSFQ assessment exam in your scheduled
    classroom and time
  \end{enumerate}
\item
  Next week: Group work on Project 3 all week
\item
  Last week:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Tuesday: Project 3 due at 11:59 PM on Tuesday, 4/23
  \item
    Thursday and Friday: Office hours during class time
  \end{enumerate}
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-41}

Pease review the lecture notebook, which provides a streamlined
introduction to optimization in Python!

\section{Practice}\label{practice-42}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ scipy.optimize }\ImportTok{as}\NormalTok{ sco}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{Find the maximum Sharpe Ratio portfolio of MATANA stocks
over the last three
years}\label{find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-2}

Note that \texttt{sco.minimize()} finds \emph{minimums}, so you need to
minimize the \emph{negative} Sharpe Ratio.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{matana }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}META AAPL TSLA AMZN NVDA GOOG\textquotesingle{}}\NormalTok{)}
\NormalTok{    [}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    .pct\_change()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  6 of 6 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pdr.DataReader(}
\NormalTok{        name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{        data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{        start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{    )}
\NormalTok{    [}\DecValTok{0}\NormalTok{]}
\NormalTok{    .div(}\DecValTok{100}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_24600\2049483829.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_sharpe(x, r, tgt, ppy):}
\NormalTok{    rp }\OperatorTok{=}\NormalTok{ r.dot(x)}
\NormalTok{    rp\_tgt }\OperatorTok{=}\NormalTok{ rp.sub(tgt)}
    \ControlFlowTok{return}\NormalTok{ np.sqrt(ppy) }\OperatorTok{*}\NormalTok{ rp\_tgt.mean() }\OperatorTok{/}\NormalTok{ rp\_tgt.std()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_neg\_sharpe(x, r, tgt, ppy):}
    \ControlFlowTok{return} \OperatorTok{{-}}\DecValTok{1} \OperatorTok{*}\NormalTok{ calc\_sharpe(x}\OperatorTok{=}\NormalTok{x, r}\OperatorTok{=}\NormalTok{r, tgt}\OperatorTok{=}\NormalTok{tgt, ppy}\OperatorTok{=}\NormalTok{ppy)}
\end{Highlighting}
\end{Shaded}

After class, I decided to write a \texttt{get\_equal\_weights()}
function to easily calculate \(\frac{1}{n}\) portfolio weights.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ get\_equal\_weights(r):}
\NormalTok{    n }\OperatorTok{=}\NormalTok{ r.shape[}\DecValTok{1}\NormalTok{]}
    \ControlFlowTok{return}\NormalTok{ np.ones(n) }\OperatorTok{/}\NormalTok{ n}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x0 }\OperatorTok{=}\NormalTok{ get\_equal\_weights(r}\OperatorTok{=}\NormalTok{matana)}
\NormalTok{x0}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0.1667, 0.1667, 0.1667, 0.1667, 0.1667, 0.1667])
\end{verbatim}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

We can test our function!

\begin{Shaded}
\begin{Highlighting}[]

\NormalTok{calc\_sharpe(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{x0,}
\NormalTok{    r}\OperatorTok{=}\NormalTok{matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{],}
\NormalTok{    tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{],}
\NormalTok{    ppy}\OperatorTok{=}\DecValTok{252}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.6336
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rp\_tgt }\OperatorTok{=}\NormalTok{ matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{].dot(x0).sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{])}
\NormalTok{np.sqrt(}\DecValTok{252}\NormalTok{) }\OperatorTok{*}\NormalTok{ rp\_tgt.mean() }\OperatorTok{/}\NormalTok{ rp\_tgt.std()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.6336
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_neg\_sharpe(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{x0, }
\NormalTok{    r}\OperatorTok{=}\NormalTok{matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], }
\NormalTok{    tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], }
\NormalTok{    ppy}\OperatorTok{=}\DecValTok{252}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-0.6336
\end{verbatim}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_sr }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_neg\_sharpe,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{matana.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], }\DecValTok{252}\NormalTok{),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{((}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ matana.columns),}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\} }\CommentTok{\# eq constraint met when equal to zero}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_sr}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -1.066086202262125
       x: [ 0.000e+00  1.574e-16  0.000e+00  0.000e+00  1.000e+00
            6.637e-17]
     nit: 5
     jac: [ 3.206e-02  3.530e-01 -1.079e-02  1.151e-01 -3.910e-02
            2.773e-01]
    nfev: 35
    njev: 5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.barh(}
\NormalTok{    y}\OperatorTok{=}\NormalTok{matana.columns,}
\NormalTok{    width}\OperatorTok{=}\NormalTok{res\_sr[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Maximum Sharpe Ratio Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for MATANA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_04_files/figure-pdf/cell-14-output-1.png}

\subsection{Find the maximum Sharpe Ratio portfolio of MATANA stocks
over the last three years, but allow short weights up to 10\% on each
stock}\label{find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-allow-short-weights-up-to-10-on-each-stock-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_sr\_2 }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_neg\_sharpe,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{matana.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], }\DecValTok{252}\NormalTok{),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{((}\OperatorTok{{-}}\FloatTok{0.1}\NormalTok{, }\FloatTok{1.5}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ matana.columns),}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\} }\CommentTok{\# eq constraint met when equal to zero}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_sr\_2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -1.135301088517565
       x: [-1.000e-01 -1.000e-01  2.348e-01 -1.000e-01  1.165e+00
           -1.000e-01]
     nit: 6
     jac: [ 2.074e-02  3.100e-01  1.634e-02  7.954e-02  1.697e-02
            1.877e-01]
    nfev: 42
    njev: 6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    pd.DataFrame(}
\NormalTok{        data}\OperatorTok{=}\NormalTok{\{}
            \StringTok{\textquotesingle{}Long Only\textquotesingle{}}\NormalTok{: res\_sr[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
            \StringTok{\textquotesingle{}Short up to 10\% per Stock\textquotesingle{}}\NormalTok{: res\_sr\_2[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{        \},}
\NormalTok{        index}\OperatorTok{=}\NormalTok{matana.columns}
\NormalTok{    )}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}barh\textquotesingle{}}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Maximum Sharpe Ratio Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for MATANA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_04_files/figure-pdf/cell-16-output-1.png}

By relaxing the long-only constrain (via changes to \texttt{bounds=}),
the weights on AAPL, AMZN, META, and TSLA go from zero to -10\%. Also,
the Sharpe Ratio increases because we relax a binding constraint.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{res\_sr[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
\NormalTok{    r}\OperatorTok{=}\NormalTok{matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{],}
\NormalTok{    tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{],}
\NormalTok{    ppy}\OperatorTok{=}\DecValTok{252}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.0661
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{res\_sr\_2[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
\NormalTok{    r}\OperatorTok{=}\NormalTok{matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{],}
\NormalTok{    tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{],}
\NormalTok{    ppy}\OperatorTok{=}\DecValTok{252}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.1353
\end{verbatim}

\subsection{Find the maximum Sharpe Ratio portfolio of MATANA stocks
over the last three years, but allow total short weights of up to
30\%}\label{find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-allow-total-short-weights-of-up-to-30-2}

\textbf{\emph{Now we need an inequality constraint!}} We will use an
inequality constraint to make sure the sum of the negative portfolio
weights is greater than \(-0.3\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OperatorTok{=}\NormalTok{ np.arange(}\DecValTok{6}\NormalTok{) }\OperatorTok{{-}} \DecValTok{3}
\NormalTok{x}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([-3, -2, -1,  0,  1,  2])
\end{verbatim}

We do this by:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Slicing the negative weights in \texttt{x} with
  \texttt{x{[}x\ \textless{}\ 0{]}}
\item
  Constraining the sum of these negative weights to be \(\geq -0.3\),
  which is met when \texttt{x{[}x\ \textless{}\ 0{]}.sum()\ +\ 0.3} is
  non-negative.
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_sr\_3 }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_neg\_sharpe,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{matana.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], }\DecValTok{252}\NormalTok{),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{((}\OperatorTok{{-}}\FloatTok{0.3}\NormalTok{, }\FloatTok{1.3}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ matana.columns),}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}, }\CommentTok{\# eq constraint met when = 0}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}ineq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x[x }\OperatorTok{\textless{}} \DecValTok{0}\NormalTok{].}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{+} \FloatTok{0.3}\NormalTok{\} }\CommentTok{\# ineq constraint met when \textgreater{}= 0}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_sr\_3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\miniconda3\envs\fina6333\Lib\site-packages\scipy\optimize\_optimize.py:404: RuntimeWarning: Values in x were outside bounds during a minimize step, clipping to bounds
  warnings.warn("Values in x were outside bounds during a "
\end{verbatim}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -1.1616556092414068
       x: [-3.101e-08 -3.000e-01  2.693e-01 -7.063e-07  1.031e+00
            7.063e-07]
     nit: 33
     jac: [ 5.505e-02  3.108e-01  4.284e-02  1.430e-01  4.190e-02
            3.025e-01]
    nfev: 329
    njev: 33
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    pd.DataFrame(}
\NormalTok{        data}\OperatorTok{=}\NormalTok{\{}
            \StringTok{\textquotesingle{}Long Only\textquotesingle{}}\NormalTok{: res\_sr[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
            \StringTok{\textquotesingle{}Short up to 10\% per Stock\textquotesingle{}}\NormalTok{: res\_sr\_2[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
            \StringTok{\textquotesingle{}Short up to 30\% Total\textquotesingle{}}\NormalTok{: res\_sr\_3[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{        \},}
\NormalTok{        index}\OperatorTok{=}\NormalTok{matana.columns}
\NormalTok{    )}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}barh\textquotesingle{}}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Maximum Sharpe Ratio Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for MATANA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_04_files/figure-pdf/cell-21-output-1.png}

The Sharpe Ratio is higher here than in the previous exercise, but this
will not always be the case because we relax slightly different
constraints. That is, here we allow up to 30\% short in one stock, but
only allow up to 30\% short across all stocks. In the previous example,
we only allow up to 10\% short in each stock, but allow up to 50\% short
across all stocks.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{res\_sr\_2[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
\NormalTok{    r}\OperatorTok{=}\NormalTok{matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{],}
\NormalTok{    tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{],}
\NormalTok{    ppy}\OperatorTok{=}\DecValTok{252}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.1353
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{res\_sr\_3[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
\NormalTok{    r}\OperatorTok{=}\NormalTok{matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{],}
\NormalTok{    tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{],}
\NormalTok{    ppy}\OperatorTok{=}\DecValTok{252}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.1617
\end{verbatim}

\subsection{Find the maximum Sharpe Ratio portfolio of MATANA stocks
over the last three years, but do not allow any weight to exceed 30\% in
magnitude}\label{find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-do-not-allow-any-weight-to-exceed-30-in-magnitude-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_sr\_4 }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_neg\_sharpe,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{matana.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], }\DecValTok{252}\NormalTok{),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{((}\DecValTok{0}\NormalTok{, }\FloatTok{0.3}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ matana.columns),}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}, }\CommentTok{\# eq constraint met when = 0}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_sr\_4}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -0.8830355324149765
       x: [ 3.000e-01  0.000e+00  3.000e-01  1.000e-01  3.000e-01
            0.000e+00]
     nit: 3
     jac: [ 1.089e-01  5.852e-01  8.385e-02  3.099e-01 -5.076e-01
            3.305e-01]
    nfev: 21
    njev: 3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    pd.DataFrame(}
\NormalTok{        data}\OperatorTok{=}\NormalTok{\{}
            \StringTok{\textquotesingle{}Long Only\textquotesingle{}}\NormalTok{: res\_sr[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
            \StringTok{\textquotesingle{}Short up to 10\% per Stock\textquotesingle{}}\NormalTok{: res\_sr\_2[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
            \StringTok{\textquotesingle{}Short up to 30\% Total\textquotesingle{}}\NormalTok{: res\_sr\_3[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
            \StringTok{\textquotesingle{}Long Only up to 30\% per Stock\textquotesingle{}}\NormalTok{: res\_sr\_4[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{        \},}
\NormalTok{        index}\OperatorTok{=}\NormalTok{matana.columns}
\NormalTok{    )}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}barh\textquotesingle{}}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Maximum Sharpe Ratio Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for MATANA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_04_files/figure-pdf/cell-25-output-1.png}

\subsection{Find the minimum 95\% Value at Risk (Var) portfolio of
MATANA stocks over the last three
years}\label{find-the-minimum-95-value-at-risk-var-portfolio-of-matana-stocks-over-the-last-three-years-2}

More on VaR \href{https://en.wikipedia.org/wiki/Value_at_risk}{here}.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_var(x, r, q):}
    \ControlFlowTok{return}\NormalTok{ r.dot(x).quantile(q)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_neg\_var(x, r, q):}
    \ControlFlowTok{return} \OperatorTok{{-}}\DecValTok{1} \OperatorTok{*}\NormalTok{ calc\_var(x}\OperatorTok{=}\NormalTok{x, r}\OperatorTok{=}\NormalTok{r, q}\OperatorTok{=}\NormalTok{q)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_var }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_neg\_var,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{matana.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], }\FloatTok{0.05}\NormalTok{),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{[(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ matana],}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}, }\CommentTok{\# minimize drives "eq" constraints to zero}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_var}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: 0.03251659857712153
       x: [ 2.102e-01  1.989e-01  2.292e-01  1.593e-01  2.172e-19
            2.024e-01]
     nit: 7
     jac: [ 3.662e-02  2.644e-02  2.760e-02  2.072e-02  3.928e-02
            4.908e-02]
    nfev: 61
    njev: 7
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_var(x}\OperatorTok{=}\NormalTok{res\_var[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{], r}\OperatorTok{=}\NormalTok{matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], q}\OperatorTok{=}\FloatTok{0.05}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-0.0325
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.barh(}
\NormalTok{    y}\OperatorTok{=}\NormalTok{matana.columns,}
\NormalTok{    width}\OperatorTok{=}\NormalTok{res\_var[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Minimum 5\% Value at Risk Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for MATANA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_04_files/figure-pdf/cell-30-output-1.png}

\subsection{Find the minimum maximum draw down portfolio of MATANA
stocks over the last three
years}\label{find-the-minimum-maximum-draw-down-portfolio-of-matana-stocks-over-the-last-three-years-2}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_max\_dd(x, r):}
\NormalTok{    rp }\OperatorTok{=}\NormalTok{ r.dot(x)}
\NormalTok{    pp }\OperatorTok{=}\NormalTok{ rp.add(}\DecValTok{1}\NormalTok{).cumprod()}
\NormalTok{    cummax }\OperatorTok{=}\NormalTok{ pp.cummax()}
\NormalTok{    dd }\OperatorTok{=}\NormalTok{ (cummax }\OperatorTok{{-}}\NormalTok{ pp) }\OperatorTok{/}\NormalTok{ cummax}
    \ControlFlowTok{return}\NormalTok{ dd.}\BuiltInTok{max}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_dd }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_max\_dd,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{matana.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{],),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{[(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ matana.columns],}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}, }\CommentTok{\# minimize drives "eq" constraints to zero}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_dd}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: 0.30912809417351766
       x: [ 1.000e+00  0.000e+00  0.000e+00  0.000e+00  0.000e+00
            0.000e+00]
     nit: 6
     jac: [ 2.995e-01  4.945e-01  3.778e-01  6.189e-01  4.966e-01
            8.402e-01]
    nfev: 42
    njev: 6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.barh(}
\NormalTok{    y}\OperatorTok{=}\NormalTok{matana.columns,}
\NormalTok{    width}\OperatorTok{=}\NormalTok{res\_dd[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Minimum Maximum Draw Down Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for MATANA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_04_files/figure-pdf/cell-33-output-1.png}

\subsection{Find the minimum maximum draw down portfolio with all
available data for the current Dow-Jones Industrial Average (DJIA)
stocks}\label{find-the-minimum-maximum-draw-down-portfolio-with-all-available-data-for-the-current-dow-jones-industrial-average-djia-stocks-2}

You can find the
\href{https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average}{DJIA
tickers on Wikipedia}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tickers }\OperatorTok{=}\NormalTok{ pd.read\_html(}\StringTok{\textquotesingle{}https://en.wikipedia.org/wiki/Dow\_Jones\_Industrial\_Average\textquotesingle{}}\NormalTok{)[}\DecValTok{1}\NormalTok{][}\StringTok{\textquotesingle{}Symbol\textquotesingle{}}\NormalTok{].to\_list()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{djia }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\NormalTok{tickers)}
\NormalTok{    [}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    .pct\_change()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  30 of 30 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_dd\_2 }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_max\_dd,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{djia.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{],),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{[(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ djia.columns],}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}, }\CommentTok{\# minimize drives "eq" constraints to zero}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_dd\_2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: 0.07659160573340107
       x: [ 4.176e-02  1.931e-02 ...  1.780e-02  4.305e-02]
     nit: 35
     jac: [-2.237e-02  1.809e-01 ...  4.256e-02  9.220e-02]
    nfev: 1140
    njev: 35
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.barh(}
\NormalTok{    y}\OperatorTok{=}\NormalTok{djia.columns,}
\NormalTok{    width}\OperatorTok{=}\NormalTok{res\_dd\_2[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Minimum Maximum Draw Down Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for DJIA Stocks from 2021 through 2023\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_04_files/figure-pdf/cell-37-output-1.png}

\subsection{Plot the (mean-variance) efficient frontier with all
available data for the current the DJIA
stocks}\label{plot-the-mean-variance-efficient-frontier-with-all-available-data-for-the-current-the-djia-stocks-2}

The range of target returns in \texttt{tret} span from the minimum to
the maximum mean single-stock returns. We will loop over these target
returns, finding the minimum variance portfolio for each target return.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{].mean().mul(}\DecValTok{252}\NormalTok{)}
\NormalTok{tret }\OperatorTok{=}\NormalTok{ np.linspace(\_.}\BuiltInTok{min}\NormalTok{(), \_.}\BuiltInTok{max}\NormalTok{(), }\DecValTok{25}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_vol(x, r, ppy):}
    \ControlFlowTok{return}\NormalTok{ np.sqrt(ppy) }\OperatorTok{*}\NormalTok{ r.dot(x).std()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_mean(x, r, ppy):}
    \ControlFlowTok{return}\NormalTok{ ppy }\OperatorTok{*}\NormalTok{ r.dot(x).mean()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_ef }\OperatorTok{=}\NormalTok{ []}

\ControlFlowTok{for}\NormalTok{ t }\KeywordTok{in}\NormalTok{ tret:}
\NormalTok{    \_ }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{        fun}\OperatorTok{=}\NormalTok{calc\_vol, }\CommentTok{\# minimize portfolio volatility}
\NormalTok{        x0}\OperatorTok{=}\NormalTok{djia.pipe(get\_equal\_weights), }\CommentTok{\# initial portfolio weights}
\NormalTok{        args}\OperatorTok{=}\NormalTok{(djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], }\DecValTok{252}\NormalTok{), }\CommentTok{\# additional arguments to fun, in order}
\NormalTok{        bounds}\OperatorTok{=}\NormalTok{((}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ djia.columns), }\CommentTok{\# bounds limit the search space for each portfolio weight}
\NormalTok{        constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{            \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}, }\CommentTok{\# constrain sum of weights to one}
\NormalTok{            \{}
                \StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }
                \StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: calc\_mean(x}\OperatorTok{=}\NormalTok{x, r}\OperatorTok{=}\NormalTok{djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], ppy}\OperatorTok{=}\DecValTok{252}\NormalTok{) }\OperatorTok{{-}}\NormalTok{ t}
\NormalTok{            \} }\CommentTok{\# constrains portfolio mean return to the target return}

\NormalTok{        )}
\NormalTok{    )}
\NormalTok{    res\_ef.append(\_)}
\end{Highlighting}
\end{Shaded}

List \texttt{res\_ef} contains the results of all 25 minimum-variance
portfolios. For example, \texttt{res\_ef{[}0{]}} is the minimum variance
portfolio for the lowest target return.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_ef[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: 0.2995484064867656
       x: [ 3.678e-16  0.000e+00 ...  2.673e-09  0.000e+00]
     nit: 2
     jac: [ 1.253e-01  3.352e-02 ...  4.880e-02  4.303e-02]
    nfev: 62
    njev: 2
\end{verbatim}

I typically check that all portfolio volatility minimization succeeds.
If a portfolio volatility minimization fails, we should check our
function, bounds, and constraints.

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ r }\KeywordTok{in}\NormalTok{ res\_ef:}
    \ControlFlowTok{assert}\NormalTok{ r[}\StringTok{\textquotesingle{}success\textquotesingle{}}\NormalTok{] }
\end{Highlighting}
\end{Shaded}

We can combine the target returns and volatilities into a data frame
\texttt{ef}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ef }\OperatorTok{=}\NormalTok{ pd.DataFrame(}
\NormalTok{    \{}
        \StringTok{\textquotesingle{}tret\textquotesingle{}}\NormalTok{: tret,}
        \StringTok{\textquotesingle{}tvol\textquotesingle{}}\NormalTok{: [r[}\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{] }\ControlFlowTok{if}\NormalTok{ r[}\StringTok{\textquotesingle{}success\textquotesingle{}}\NormalTok{] }\ControlFlowTok{else}\NormalTok{ np.nan }\ControlFlowTok{for}\NormalTok{ r }\KeywordTok{in}\NormalTok{ res\_ef]}
\NormalTok{    \}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ef.mul(}\DecValTok{100}\NormalTok{).plot(x}\OperatorTok{=}\StringTok{\textquotesingle{}tvol\textquotesingle{}}\NormalTok{, y}\OperatorTok{=}\StringTok{\textquotesingle{}tret\textquotesingle{}}\NormalTok{, legend}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Annualized Volatility (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Mean{-}Variance Efficient Frontier}\CharTok{\textbackslash{}n}\StringTok{for DJIA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ t, x, y }\KeywordTok{in} \BuiltInTok{zip}\NormalTok{(}
\NormalTok{    djia.columns, }
\NormalTok{    djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{].std().mul(}\DecValTok{100}\OperatorTok{*}\NormalTok{np.sqrt(}\DecValTok{252}\NormalTok{)),}
\NormalTok{    djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{].mean().mul(}\DecValTok{100}\OperatorTok{*}\DecValTok{252}\NormalTok{)}
\NormalTok{):}
\NormalTok{    plt.annotate(text}\OperatorTok{=}\NormalTok{t, xy}\OperatorTok{=}\NormalTok{(x, y))}
    
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_04_files/figure-pdf/cell-45-output-1.png}

\subsection{Find the maximum Sharpe Ratio portfolio with all available
data for the current the DJIA
stocks}\label{find-the-maximum-sharpe-ratio-portfolio-with-all-available-data-for-the-current-the-djia-stocks-2}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_sr\_5 }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_neg\_sharpe,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{djia.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], }\DecValTok{252}\NormalTok{),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{((}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ djia.columns),}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_sr\_5}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -1.2674931546250938
       x: [ 3.365e-16  1.240e-02 ...  0.000e+00  3.643e-16]
     nit: 9
     jac: [ 1.679e-01 -1.458e-01 ...  1.165e+00  1.698e-01]
    nfev: 282
    njev: 9
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.barh(}
\NormalTok{    y}\OperatorTok{=}\NormalTok{djia.columns,}
\NormalTok{    width}\OperatorTok{=}\NormalTok{res\_sr\_5[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Maximum Sharpe Ratio Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for DJIA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_04_files/figure-pdf/cell-47-output-1.png}

\subsection{\texorpdfstring{Compare the \(\frac{1}{n}\) and maximum
Sharpe Ratio portfolios with all available data for the current DJIA
stocks}{Compare the \textbackslash frac\{1\}\{n\} and maximum Sharpe Ratio portfolios with all available data for the current DJIA stocks}}\label{compare-the-frac1n-and-maximum-sharpe-ratio-portfolios-with-all-available-data-for-the-current-djia-stocks-2}

Use all but the last 252 trading days to estimate the maximum Sharpe
Ratio portfolio weights. Then use the last 252 trading days of data to
compare the \(\frac{1}{n}\) maximum Sharpe Ratio portfolios.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_sr\_6 }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_neg\_sharpe,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{djia.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2022\textquotesingle{}}\NormalTok{], ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], }\DecValTok{252}\NormalTok{),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{((}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ djia.columns),}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_sr\_6}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -1.8291514999393166
       x: [ 0.000e+00  0.000e+00 ...  2.996e-15  0.000e+00]
     nit: 7
     jac: [ 8.874e-01  5.597e-02 ...  1.586e+00  5.228e-01]
    nfev: 220
    njev: 7
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.barh(}
\NormalTok{    y}\OperatorTok{=}\NormalTok{djia.columns,}
\NormalTok{    width}\OperatorTok{=}\NormalTok{res\_sr\_6[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
\NormalTok{    label}\OperatorTok{=}\StringTok{\textquotesingle{}Maximum Sharpe Ratio Weights\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.axvline(}\DecValTok{1}\OperatorTok{/}\DecValTok{30}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}red\textquotesingle{}}\NormalTok{, label}\OperatorTok{=}\StringTok{\textquotesingle{}Equal Weights\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.legend()}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Maximum Sharpe Ratio Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for DJIA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_04_files/figure-pdf/cell-49-output-1.png}

Here is the how max Sharpe portfolio does in 2023:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(x}\OperatorTok{=}\NormalTok{res\_sr\_6[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{], r}\OperatorTok{=}\NormalTok{djia.loc[}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], ppy}\OperatorTok{=}\DecValTok{252}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-0.5146
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(x}\OperatorTok{=}\NormalTok{np.ones(djia.shape[}\DecValTok{1}\NormalTok{]) }\OperatorTok{/}\NormalTok{ djia.shape[}\DecValTok{1}\NormalTok{], r}\OperatorTok{=}\NormalTok{djia.loc[}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], ppy}\OperatorTok{=}\DecValTok{252}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.2388
\end{verbatim}

It is hard to beat the \(\frac{1}{n}\) portfolio because mean returns
are hard to predict!

\chapter{Herron Topic 4 - Practice for Section
05}\label{herron-topic-4---practice-for-section-05}

\section{Announcements}\label{announcements-43}

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  This week:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Tuesday: Herron Topic 4 on portfolio optimization
  \item
    Thursday and Friday: MSFQ assessment exam in your scheduled
    classroom and time
  \end{enumerate}
\item
  Next week: Group work on Project 3 all week
\item
  Last week:

  \begin{enumerate}
  \def\labelenumii{\arabic{enumii}.}
  \tightlist
  \item
    Tuesday: Project 3 due at 11:59 PM on Tuesday, 4/23
  \item
    ThursdayFriday: Office hours during class time
  \end{enumerate}
\end{enumerate}

\section{10-Minute Recap}\label{minute-recap-42}

Pease review the lecture notebook, which provides a streamlined
introduction to optimization in Python!

\section{Practice}\label{practice-43}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ scipy.optimize }\ImportTok{as}\NormalTok{ sco}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{4}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.4f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{Find the maximum Sharpe Ratio portfolio of MATANA stocks
over the last three
years}\label{find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-3}

Note that \texttt{sco.minimize()} finds \emph{minimums}, so you need to
minimize the \emph{negative} Sharpe Ratio.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{matana }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}META AAPL TSLA AMZN NVDA GOOG\textquotesingle{}}\NormalTok{)}
\NormalTok{    [}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    .pct\_change()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  6 of 6 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ff }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pdr.DataReader(}
\NormalTok{        name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{        data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{        start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{    )}
\NormalTok{    [}\DecValTok{0}\NormalTok{]}
\NormalTok{    .div(}\DecValTok{100}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_17984\2049483829.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_sharpe(x, r, tgt, ppy):}
\NormalTok{    rp }\OperatorTok{=}\NormalTok{ r.dot(x)}
\NormalTok{    rp\_tgt }\OperatorTok{=}\NormalTok{ rp.sub(tgt)}
    \ControlFlowTok{return}\NormalTok{ np.sqrt(ppy) }\OperatorTok{*}\NormalTok{ rp\_tgt.mean() }\OperatorTok{/}\NormalTok{ rp\_tgt.std()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_neg\_sharpe(x, r, tgt, ppy):}
    \ControlFlowTok{return} \OperatorTok{{-}}\DecValTok{1} \OperatorTok{*}\NormalTok{ calc\_sharpe(x}\OperatorTok{=}\NormalTok{x, r}\OperatorTok{=}\NormalTok{r, tgt}\OperatorTok{=}\NormalTok{tgt, ppy}\OperatorTok{=}\NormalTok{ppy)}
\end{Highlighting}
\end{Shaded}

After class, I decided to write a \texttt{get\_equal\_weights()}
function to easily calculate \(\frac{1}{n}\) portfolio weights.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ get\_equal\_weights(r):}
\NormalTok{    n }\OperatorTok{=}\NormalTok{ r.shape[}\DecValTok{1}\NormalTok{]}
    \ControlFlowTok{return}\NormalTok{ np.ones(n) }\OperatorTok{/}\NormalTok{ n}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x0 }\OperatorTok{=}\NormalTok{ get\_equal\_weights(r}\OperatorTok{=}\NormalTok{matana)}
\NormalTok{x0}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0.1667, 0.1667, 0.1667, 0.1667, 0.1667, 0.1667])
\end{verbatim}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

We can test our function!

\begin{Shaded}
\begin{Highlighting}[]

\NormalTok{calc\_sharpe(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{x0,}
\NormalTok{    r}\OperatorTok{=}\NormalTok{matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{],}
\NormalTok{    tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{],}
\NormalTok{    ppy}\OperatorTok{=}\DecValTok{252}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.6336
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rp\_tgt }\OperatorTok{=}\NormalTok{ matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{].dot(x0).sub(ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{])}
\NormalTok{np.sqrt(}\DecValTok{252}\NormalTok{) }\OperatorTok{*}\NormalTok{ rp\_tgt.mean() }\OperatorTok{/}\NormalTok{ rp\_tgt.std()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
0.6336
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_neg\_sharpe(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{x0, }
\NormalTok{    r}\OperatorTok{=}\NormalTok{matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], }
\NormalTok{    tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], }
\NormalTok{    ppy}\OperatorTok{=}\DecValTok{252}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-0.6336
\end{verbatim}

\begin{center}\rule{0.5\linewidth}{0.5pt}\end{center}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_sr }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_neg\_sharpe,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{matana.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], }\DecValTok{252}\NormalTok{),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{((}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ matana.columns),}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\} }\CommentTok{\# eq constraint met when equal to zero}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_sr}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -1.0660863115414434
       x: [ 8.921e-17  9.213e-18  0.000e+00  0.000e+00  1.000e+00
            0.000e+00]
     nit: 5
     jac: [ 3.206e-02  3.530e-01 -1.079e-02  1.151e-01 -3.910e-02
            2.773e-01]
    nfev: 35
    njev: 5
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.barh(}
\NormalTok{    y}\OperatorTok{=}\NormalTok{matana.columns,}
\NormalTok{    width}\OperatorTok{=}\NormalTok{res\_sr[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Maximum Sharpe Ratio Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for MATANA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_05_files/figure-pdf/cell-14-output-1.png}

\subsection{Find the maximum Sharpe Ratio portfolio of MATANA stocks
over the last three years, but allow short weights up to 10\% on each
stock}\label{find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-allow-short-weights-up-to-10-on-each-stock-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_sr\_2 }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_neg\_sharpe,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{matana.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], }\DecValTok{252}\NormalTok{),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{((}\OperatorTok{{-}}\FloatTok{0.1}\NormalTok{, }\FloatTok{1.5}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ matana.columns),}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\} }\CommentTok{\# eq constraint met when equal to zero}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_sr\_2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -1.1353011989460526
       x: [-1.000e-01 -1.000e-01  2.348e-01 -1.000e-01  1.165e+00
           -1.000e-01]
     nit: 6
     jac: [ 2.074e-02  3.100e-01  1.634e-02  7.954e-02  1.697e-02
            1.877e-01]
    nfev: 42
    njev: 6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    pd.DataFrame(}
\NormalTok{        data}\OperatorTok{=}\NormalTok{\{}
            \StringTok{\textquotesingle{}Long Only\textquotesingle{}}\NormalTok{: res\_sr[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
            \StringTok{\textquotesingle{}Short up to 10\% per Stock\textquotesingle{}}\NormalTok{: res\_sr\_2[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{        \},}
\NormalTok{        index}\OperatorTok{=}\NormalTok{matana.columns}
\NormalTok{    )}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}barh\textquotesingle{}}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Maximum Sharpe Ratio Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for MATANA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_05_files/figure-pdf/cell-16-output-1.png}

By relaxing the long-only constrain (via changes to \texttt{bounds=}),
the weights on AAPL, AMZN, META, and TSLA go from zero to -10\%. Also,
the Sharpe Ratio increases because we relax a binding constraint.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{res\_sr[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
\NormalTok{    r}\OperatorTok{=}\NormalTok{matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{],}
\NormalTok{    tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{],}
\NormalTok{    ppy}\OperatorTok{=}\DecValTok{252}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.0661
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{res\_sr\_2[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
\NormalTok{    r}\OperatorTok{=}\NormalTok{matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{],}
\NormalTok{    tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{],}
\NormalTok{    ppy}\OperatorTok{=}\DecValTok{252}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.1353
\end{verbatim}

\subsection{Find the maximum Sharpe Ratio portfolio of MATANA stocks
over the last three years, but allow total short weights of up to
30\%}\label{find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-allow-total-short-weights-of-up-to-30-3}

\textbf{\emph{Now we need an inequality constraint!}} We will use an
inequality constraint to make sure the sum of the negative portfolio
weights is greater than \(-0.3\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{x }\OperatorTok{=}\NormalTok{ np.arange(}\DecValTok{6}\NormalTok{) }\OperatorTok{{-}} \DecValTok{3}
\NormalTok{x}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([-3, -2, -1,  0,  1,  2])
\end{verbatim}

We do this by:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Slicing the negative weights in \texttt{x} with
  \texttt{x{[}x\ \textless{}\ 0{]}}
\item
  Constraining the sum of these negative weights to be \(\geq -0.3\),
  which is met when \texttt{x{[}x\ \textless{}\ 0{]}.sum()\ +\ 0.3} is
  non-negative.
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_sr\_3 }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_neg\_sharpe,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{matana.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], }\DecValTok{252}\NormalTok{),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{((}\OperatorTok{{-}}\FloatTok{0.3}\NormalTok{, }\FloatTok{1.3}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ matana.columns),}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}, }\CommentTok{\# eq constraint met when = 0}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}ineq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x[x }\OperatorTok{\textless{}} \DecValTok{0}\NormalTok{].}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{+} \FloatTok{0.3}\NormalTok{\} }\CommentTok{\# ineq constraint met when \textgreater{}= 0}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_sr\_3}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\miniconda3\envs\fina6333\Lib\site-packages\scipy\optimize\_optimize.py:404: RuntimeWarning: Values in x were outside bounds during a minimize step, clipping to bounds
  warnings.warn("Values in x were outside bounds during a "
\end{verbatim}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -1.1616508281422926
       x: [ 8.532e-09 -2.997e-01  2.717e-01 -3.268e-07  1.028e+00
           -3.074e-04]
     nit: 44
     jac: [ 5.523e-02  3.114e-01  4.330e-02  1.434e-01  4.189e-02
            3.026e-01]
    nfev: 491
    njev: 44
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    pd.DataFrame(}
\NormalTok{        data}\OperatorTok{=}\NormalTok{\{}
            \StringTok{\textquotesingle{}Long Only\textquotesingle{}}\NormalTok{: res\_sr[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
            \StringTok{\textquotesingle{}Short up to 10\% per Stock\textquotesingle{}}\NormalTok{: res\_sr\_2[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
            \StringTok{\textquotesingle{}Short up to 30\% Total\textquotesingle{}}\NormalTok{: res\_sr\_3[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{        \},}
\NormalTok{        index}\OperatorTok{=}\NormalTok{matana.columns}
\NormalTok{    )}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}barh\textquotesingle{}}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Maximum Sharpe Ratio Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for MATANA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_05_files/figure-pdf/cell-21-output-1.png}

The Sharpe Ratio is higher here than in the previous exercise, but this
will not always be the case because we relax slightly different
constraints. That is, here we allow up to 30\% short in one stock, but
only allow up to 30\% short across all stocks. In the previous example,
we only allow up to 10\% short in each stock, but allow up to 50\% short
across all stocks.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{res\_sr\_2[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
\NormalTok{    r}\OperatorTok{=}\NormalTok{matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{],}
\NormalTok{    tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{],}
\NormalTok{    ppy}\OperatorTok{=}\DecValTok{252}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.1353
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(}
\NormalTok{    x}\OperatorTok{=}\NormalTok{res\_sr\_3[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
\NormalTok{    r}\OperatorTok{=}\NormalTok{matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{],}
\NormalTok{    tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{],}
\NormalTok{    ppy}\OperatorTok{=}\DecValTok{252}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.1617
\end{verbatim}

\subsection{Find the maximum Sharpe Ratio portfolio of MATANA stocks
over the last three years, but do not allow any weight to exceed 30\% in
magnitude}\label{find-the-maximum-sharpe-ratio-portfolio-of-matana-stocks-over-the-last-three-years-but-do-not-allow-any-weight-to-exceed-30-in-magnitude-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_sr\_4 }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_neg\_sharpe,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{matana.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], }\DecValTok{252}\NormalTok{),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{((}\DecValTok{0}\NormalTok{, }\FloatTok{0.3}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ matana.columns),}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}, }\CommentTok{\# eq constraint met when = 0}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_sr\_4}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -0.8830356530532761
       x: [ 3.000e-01  0.000e+00  3.000e-01  1.000e-01  3.000e-01
            6.072e-18]
     nit: 3
     jac: [ 1.089e-01  5.852e-01  8.385e-02  3.099e-01 -5.076e-01
            3.305e-01]
    nfev: 21
    njev: 3
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    pd.DataFrame(}
\NormalTok{        data}\OperatorTok{=}\NormalTok{\{}
            \StringTok{\textquotesingle{}Long Only\textquotesingle{}}\NormalTok{: res\_sr[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
            \StringTok{\textquotesingle{}Short up to 10\% per Stock\textquotesingle{}}\NormalTok{: res\_sr\_2[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
            \StringTok{\textquotesingle{}Short up to 30\% Total\textquotesingle{}}\NormalTok{: res\_sr\_3[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
            \StringTok{\textquotesingle{}Long Only up to 30\% per Stock\textquotesingle{}}\NormalTok{: res\_sr\_4[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{        \},}
\NormalTok{        index}\OperatorTok{=}\NormalTok{matana.columns}
\NormalTok{    )}
\NormalTok{    .plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}barh\textquotesingle{}}\NormalTok{)}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Maximum Sharpe Ratio Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for MATANA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_05_files/figure-pdf/cell-25-output-1.png}

\subsection{Find the minimum 95\% Value at Risk (Var) portfolio of
MATANA stocks over the last three
years}\label{find-the-minimum-95-value-at-risk-var-portfolio-of-matana-stocks-over-the-last-three-years-3}

More on VaR \href{https://en.wikipedia.org/wiki/Value_at_risk}{here}.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_var(x, r, q):}
    \ControlFlowTok{return}\NormalTok{ r.dot(x).quantile(q)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_neg\_var(x, r, q):}
    \ControlFlowTok{return} \OperatorTok{{-}}\DecValTok{1} \OperatorTok{*}\NormalTok{ calc\_var(x}\OperatorTok{=}\NormalTok{x, r}\OperatorTok{=}\NormalTok{r, q}\OperatorTok{=}\NormalTok{q)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_var }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_neg\_var,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{matana.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], }\FloatTok{0.05}\NormalTok{),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{[(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ matana],}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}, }\CommentTok{\# minimize drives "eq" constraints to zero}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_var}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: 0.032516587529765696
       x: [ 2.102e-01  1.989e-01  2.292e-01  1.593e-01  3.434e-21
            2.024e-01]
     nit: 7
     jac: [ 3.662e-02  2.644e-02  2.760e-02  2.072e-02  3.928e-02
            4.908e-02]
    nfev: 61
    njev: 7
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_var(x}\OperatorTok{=}\NormalTok{res\_var[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{], r}\OperatorTok{=}\NormalTok{matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], q}\OperatorTok{=}\FloatTok{0.05}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-0.0325
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.barh(}
\NormalTok{    y}\OperatorTok{=}\NormalTok{matana.columns,}
\NormalTok{    width}\OperatorTok{=}\NormalTok{res\_var[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Minimum 5\% Value at Risk Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for MATANA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_05_files/figure-pdf/cell-30-output-1.png}

\subsection{Find the minimum maximum draw down portfolio of MATANA
stocks over the last three
years}\label{find-the-minimum-maximum-draw-down-portfolio-of-matana-stocks-over-the-last-three-years-3}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_max\_dd(x, r):}
\NormalTok{    rp }\OperatorTok{=}\NormalTok{ r.dot(x)}
\NormalTok{    pp }\OperatorTok{=}\NormalTok{ rp.add(}\DecValTok{1}\NormalTok{).cumprod()}
\NormalTok{    cummax }\OperatorTok{=}\NormalTok{ pp.cummax()}
\NormalTok{    dd }\OperatorTok{=}\NormalTok{ (cummax }\OperatorTok{{-}}\NormalTok{ pp) }\OperatorTok{/}\NormalTok{ cummax}
    \ControlFlowTok{return}\NormalTok{ dd.}\BuiltInTok{max}\NormalTok{()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_dd }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_max\_dd,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{matana.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(matana.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{],),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{[(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ matana.columns],}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}, }\CommentTok{\# minimize drives "eq" constraints to zero}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_dd}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: 0.30912803551781853
       x: [ 1.000e+00  5.551e-16  2.026e-15  6.870e-16  9.645e-16
            9.021e-16]
     nit: 6
     jac: [ 2.995e-01  4.945e-01  3.778e-01  6.189e-01  4.966e-01
            8.402e-01]
    nfev: 42
    njev: 6
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.barh(}
\NormalTok{    y}\OperatorTok{=}\NormalTok{matana.columns,}
\NormalTok{    width}\OperatorTok{=}\NormalTok{res\_dd[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Minimum Maximum Draw Down Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for MATANA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_05_files/figure-pdf/cell-33-output-1.png}

\subsection{Find the minimum maximum draw down portfolio with all
available data for the current Dow-Jones Industrial Average (DJIA)
stocks}\label{find-the-minimum-maximum-draw-down-portfolio-with-all-available-data-for-the-current-dow-jones-industrial-average-djia-stocks-3}

You can find the
\href{https://en.wikipedia.org/wiki/Dow_Jones_Industrial_Average}{DJIA
tickers on Wikipedia}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tickers }\OperatorTok{=}\NormalTok{ pd.read\_html(}\StringTok{\textquotesingle{}https://en.wikipedia.org/wiki/Dow\_Jones\_Industrial\_Average\textquotesingle{}}\NormalTok{)[}\DecValTok{1}\NormalTok{][}\StringTok{\textquotesingle{}Symbol\textquotesingle{}}\NormalTok{].to\_list()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{djia }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\NormalTok{tickers)}
\NormalTok{    [}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]}
\NormalTok{    .iloc[:}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{    .pct\_change()}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  30 of 30 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_dd\_2 }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_max\_dd,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{djia.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{],),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{[(}\DecValTok{0}\NormalTok{,}\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ djia.columns],}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}, }\CommentTok{\# minimize drives "eq" constraints to zero}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_dd\_2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: 0.07677715628739014
       x: [ 3.926e-02  2.069e-02 ...  1.693e-02  4.226e-02]
     nit: 29
     jac: [-2.236e-02  1.808e-01 ...  4.257e-02  9.219e-02]
    nfev: 947
    njev: 29
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.barh(}
\NormalTok{    y}\OperatorTok{=}\NormalTok{djia.columns,}
\NormalTok{    width}\OperatorTok{=}\NormalTok{res\_dd\_2[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Minimum Maximum Draw Down Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for DJIA Stocks from 2021 through 2023\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_05_files/figure-pdf/cell-37-output-1.png}

\subsection{Plot the (mean-variance) efficient frontier with all
available data for the current the DJIA
stocks}\label{plot-the-mean-variance-efficient-frontier-with-all-available-data-for-the-current-the-djia-stocks-3}

The range of target returns in \texttt{tret} span from the minimum to
the maximum mean single-stock returns. We will loop over these target
returns, finding the minimum variance portfolio for each target return.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{].mean().mul(}\DecValTok{252}\NormalTok{)}
\NormalTok{tret }\OperatorTok{=}\NormalTok{ np.linspace(\_.}\BuiltInTok{min}\NormalTok{(), \_.}\BuiltInTok{max}\NormalTok{(), }\DecValTok{25}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_vol(x, r, ppy):}
    \ControlFlowTok{return}\NormalTok{ np.sqrt(ppy) }\OperatorTok{*}\NormalTok{ r.dot(x).std()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ calc\_mean(x, r, ppy):}
    \ControlFlowTok{return}\NormalTok{ ppy }\OperatorTok{*}\NormalTok{ r.dot(x).mean()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_ef }\OperatorTok{=}\NormalTok{ []}

\ControlFlowTok{for}\NormalTok{ t }\KeywordTok{in}\NormalTok{ tret:}
\NormalTok{    \_ }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{        fun}\OperatorTok{=}\NormalTok{calc\_vol, }\CommentTok{\# minimize portfolio volatility}
\NormalTok{        x0}\OperatorTok{=}\NormalTok{djia.pipe(get\_equal\_weights), }\CommentTok{\# initial portfolio weights}
\NormalTok{        args}\OperatorTok{=}\NormalTok{(djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], }\DecValTok{252}\NormalTok{), }\CommentTok{\# additional arguments to fun, in order}
\NormalTok{        bounds}\OperatorTok{=}\NormalTok{((}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ djia.columns), }\CommentTok{\# bounds limit the search space for each portfolio weight}
\NormalTok{        constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{            \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}, }\CommentTok{\# constrain sum of weights to one}
\NormalTok{            \{}
                \StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{: }\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }
                \StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: calc\_mean(x}\OperatorTok{=}\NormalTok{x, r}\OperatorTok{=}\NormalTok{djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], ppy}\OperatorTok{=}\DecValTok{252}\NormalTok{) }\OperatorTok{{-}}\NormalTok{ t}
\NormalTok{            \} }\CommentTok{\# constrains portfolio mean return to the target return}

\NormalTok{        )}
\NormalTok{    )}
\NormalTok{    res\_ef.append(\_)}
\end{Highlighting}
\end{Shaded}

List \texttt{res\_ef} contains the results of all 25 minimum-variance
portfolios. For example, \texttt{res\_ef{[}0{]}} is the minimum variance
portfolio for the lowest target return.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_ef[}\DecValTok{0}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: 0.2995484071443105
       x: [ 1.312e-16  0.000e+00 ...  5.056e-11  5.282e-17]
     nit: 3
     jac: [ 1.253e-01  3.352e-02 ...  4.880e-02  4.303e-02]
    nfev: 93
    njev: 3
\end{verbatim}

I typically check that all portfolio volatility minimization succeeds.
If a portfolio volatility minimization fails, we should check our
function, bounds, and constraints.

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ r }\KeywordTok{in}\NormalTok{ res\_ef:}
    \ControlFlowTok{assert}\NormalTok{ r[}\StringTok{\textquotesingle{}success\textquotesingle{}}\NormalTok{] }
\end{Highlighting}
\end{Shaded}

We can combine the target returns and volatilities into a data frame
\texttt{ef}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ef }\OperatorTok{=}\NormalTok{ pd.DataFrame(}
\NormalTok{    \{}
        \StringTok{\textquotesingle{}tret\textquotesingle{}}\NormalTok{: tret,}
        \StringTok{\textquotesingle{}tvol\textquotesingle{}}\NormalTok{: [r[}\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{] }\ControlFlowTok{if}\NormalTok{ r[}\StringTok{\textquotesingle{}success\textquotesingle{}}\NormalTok{] }\ControlFlowTok{else}\NormalTok{ np.nan }\ControlFlowTok{for}\NormalTok{ r }\KeywordTok{in}\NormalTok{ res\_ef]}
\NormalTok{    \}}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{ef.mul(}\DecValTok{100}\NormalTok{).plot(x}\OperatorTok{=}\StringTok{\textquotesingle{}tvol\textquotesingle{}}\NormalTok{, y}\OperatorTok{=}\StringTok{\textquotesingle{}tret\textquotesingle{}}\NormalTok{, legend}\OperatorTok{=}\VariableTok{False}\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Annualized Mean Return (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Annualized Volatility (\%)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Mean{-}Variance Efficient Frontier}\CharTok{\textbackslash{}n}\StringTok{for DJIA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}

\ControlFlowTok{for}\NormalTok{ t, x, y }\KeywordTok{in} \BuiltInTok{zip}\NormalTok{(}
\NormalTok{    djia.columns, }
\NormalTok{    djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{].std().mul(}\DecValTok{100}\OperatorTok{*}\NormalTok{np.sqrt(}\DecValTok{252}\NormalTok{)),}
\NormalTok{    djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{].mean().mul(}\DecValTok{100}\OperatorTok{*}\DecValTok{252}\NormalTok{)}
\NormalTok{):}
\NormalTok{    plt.annotate(text}\OperatorTok{=}\NormalTok{t, xy}\OperatorTok{=}\NormalTok{(x, y))}
    
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_05_files/figure-pdf/cell-45-output-1.png}

\subsection{Find the maximum Sharpe Ratio portfolio with all available
data for the current the DJIA
stocks}\label{find-the-maximum-sharpe-ratio-portfolio-with-all-available-data-for-the-current-the-djia-stocks-3}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_sr\_5 }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_neg\_sharpe,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{djia.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], }\DecValTok{252}\NormalTok{),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{((}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ djia.columns),}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_sr\_5}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -1.2674936065439388
       x: [ 3.138e-16  1.240e-02 ...  1.447e-15  0.000e+00]
     nit: 9
     jac: [ 1.679e-01 -1.458e-01 ...  1.165e+00  1.698e-01]
    nfev: 282
    njev: 9
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.barh(}
\NormalTok{    y}\OperatorTok{=}\NormalTok{djia.columns,}
\NormalTok{    width}\OperatorTok{=}\NormalTok{res\_sr\_5[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Maximum Sharpe Ratio Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for DJIA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_05_files/figure-pdf/cell-47-output-1.png}

\subsection{\texorpdfstring{Compare the \(\frac{1}{n}\) and maximum
Sharpe Ratio portfolios with all available data for the current DJIA
stocks}{Compare the \textbackslash frac\{1\}\{n\} and maximum Sharpe Ratio portfolios with all available data for the current DJIA stocks}}\label{compare-the-frac1n-and-maximum-sharpe-ratio-portfolios-with-all-available-data-for-the-current-djia-stocks-3}

Use all but the last 252 trading days to estimate the maximum Sharpe
Ratio portfolio weights. Then use the last 252 trading days of data to
compare the \(\frac{1}{n}\) maximum Sharpe Ratio portfolios.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{res\_sr\_6 }\OperatorTok{=}\NormalTok{ sco.minimize(}
\NormalTok{    fun}\OperatorTok{=}\NormalTok{calc\_neg\_sharpe,}
\NormalTok{    x0}\OperatorTok{=}\NormalTok{djia.pipe(get\_equal\_weights),}
\NormalTok{    args}\OperatorTok{=}\NormalTok{(djia.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}2022\textquotesingle{}}\NormalTok{], ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], }\DecValTok{252}\NormalTok{),}
\NormalTok{    bounds}\OperatorTok{=}\NormalTok{((}\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{) }\ControlFlowTok{for}\NormalTok{ c }\KeywordTok{in}\NormalTok{ djia.columns),}
\NormalTok{    constraints}\OperatorTok{=}\NormalTok{(}
\NormalTok{        \{}\StringTok{\textquotesingle{}type\textquotesingle{}}\NormalTok{:}\StringTok{\textquotesingle{}eq\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}fun\textquotesingle{}}\NormalTok{: }\KeywordTok{lambda}\NormalTok{ x: x.}\BuiltInTok{sum}\NormalTok{() }\OperatorTok{{-}} \DecValTok{1}\NormalTok{\}}
\NormalTok{    )}
\NormalTok{)}

\NormalTok{res\_sr\_6}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
 message: Optimization terminated successfully
 success: True
  status: 0
     fun: -1.8291519010866852
       x: [ 0.000e+00  0.000e+00 ...  2.240e-15  0.000e+00]
     nit: 7
     jac: [ 8.874e-01  5.597e-02 ...  1.586e+00  5.228e-01]
    nfev: 220
    njev: 7
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{plt.barh(}
\NormalTok{    y}\OperatorTok{=}\NormalTok{djia.columns,}
\NormalTok{    width}\OperatorTok{=}\NormalTok{res\_sr\_6[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{],}
\NormalTok{    label}\OperatorTok{=}\StringTok{\textquotesingle{}Maximum Sharpe Ratio Weights\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.axvline(}\DecValTok{1}\OperatorTok{/}\DecValTok{30}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}red\textquotesingle{}}\NormalTok{, label}\OperatorTok{=}\StringTok{\textquotesingle{}Equal Weights\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.legend()}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.xlabel(}\StringTok{\textquotesingle{}Portfolio Weight\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Maximum Sharpe Ratio Portfolio Weights}\CharTok{\textbackslash{}n}\StringTok{ for DJIA Stocks from 2021 through 2023\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_04_practice_05_files/figure-pdf/cell-49-output-1.png}

Here is the how max Sharpe portfolio does in 2023:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(x}\OperatorTok{=}\NormalTok{res\_sr\_6[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{], r}\OperatorTok{=}\NormalTok{djia.loc[}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], ppy}\OperatorTok{=}\DecValTok{252}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-0.5146
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{calc\_sharpe(x}\OperatorTok{=}\NormalTok{np.ones(djia.shape[}\DecValTok{1}\NormalTok{]) }\OperatorTok{/}\NormalTok{ djia.shape[}\DecValTok{1}\NormalTok{], r}\OperatorTok{=}\NormalTok{djia.loc[}\StringTok{\textquotesingle{}2023\textquotesingle{}}\NormalTok{], tgt}\OperatorTok{=}\NormalTok{ff[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{], ppy}\OperatorTok{=}\DecValTok{252}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1.2388
\end{verbatim}

It is hard to beat the \(\frac{1}{n}\) portfolio because mean returns
are hard to predict!

\part{Week 14}

\chapter{Herron Topic 5 -
Simulations}\label{herron-topic-5---simulations}

In finance, we typically perform simulations with
\href{https://en.wikipedia.org/wiki/Monte_Carlo_method}{Monte Carlo
methods}. Monte Carlo methods are used throughout science, engineering,
and mathematics, and they are especially useful in finance due to the
randomness of asset prices. This lecture notebook provides an
introduction to
\href{https://en.wikipedia.org/wiki/Monte_Carlo_methods_in_finance}{Monte
Carlo methods in finance}.

The basic idea behind Monte Carlo methods in finance is to create many
possible paths of financial variables (e.g., stock prices, interest
rates, exchange rates) based on their historical behavior, statistical
properties, and any other relevant factors. We use these paths to
simulate the performance of financial instruments or portfolios, and
then we aggregate these results to estimate metrics of interest. This
approach helps us model and analyze complex financial problems that may
be difficult or impossible to solve analytically.

We could spend a semester (or more) on simulations and Monte Carlo
methods. In this lecture notebook, we will limit our focus to:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Option pricing: Monte Carlo methods can be used to estimate the fair
  value of financial derivatives, such as options and warrants. By
  simulating the potential future paths of the underlying asset and
  calculating the payoffs of the derivative at each path, the expected
  payoff can be computed and discounted to present value to determine
  the option's price.
\item
  Value at Risk (VaR): Monte Carlo simulations can be used to compute
  VaR, a widely used risk management metric that estimates the potential
  loss in the value of a portfolio over a specific time horizon, given a
  certain level of confidence (e.g., 95\% or 99\%). By simulating
  numerous scenarios and observing the distribution of potential losses,
  the VaR can be calculated as the threshold below which a certain
  percentage of losses fall.
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{from}\NormalTok{ scipy.stats }\ImportTok{import}\NormalTok{ norm}
\ImportTok{import}\NormalTok{ warnings}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{2}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.2f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\section{Option Pricing}\label{option-pricing}

We can use Monte Carlo methods to value stock options. First, we
simulate several hundred or thousand possible (but random) price paths
for the underlying stock. Then, we calculate the payoff for each path.
On some paths, the option will expire ``in the money'' with \(S_T > K\)
and pay \(S_T - K\). On other paths, the option will expire ``out of the
money'' with \(S_T < K\) and pay 0. We average these payoffs and
discount them to today. The present value of these payoffs is the option
price. This is an illustrative example, and there is a lot of depth to
\href{https://en.wikipedia.org/wiki/Monte_Carlo_methods_for_option_pricing}{Monte
Carlo methods for option pricing}.

\subsection{Simulating Stock Prices}\label{simulating-stock-prices}

We can simulate stock prices with the following stochastic differential
equation (SDE) for Geometric Brownian Motion (GBM):
\(dS = \mu S dt + \sigma S dW_t\). GBM does not account for
mean-reversion and time-dependent volatility. So GBM is often used for
stocks and not for bond prices, which tend to display long-term
reversion to the face value. In the GBM SDE:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  \(S\) is the stock price
\item
  \(\mu\) is the drift coefficient (i.e., instantaneous expected return)
\item
  \(\sigma\) is the diffusion coefficient (i.e., volatility of the
  drift)
\item
  \(W_t\) is the Wiener Process or Brownian Motion
\end{enumerate}

The GBM SDE has a closed-form solution:
\(S(t) = S_0 \exp\left(\left(\mu - \frac{1}{2}\sigma^2\right)t + \sigma W_t\right)\).
We can apply this closed form solution recursively:
\(S(t_{i+1}) = S(t_i) \exp\left(\left(\mu - \frac{1}{2}\sigma^2\right)(t_{i+1} - t_i) + \sigma \sqrt{t_{i+1} - t_i} Z_{i+1}\right)\).
Here, \(Z_i\) is a Standard Normal random variable (\(dW_t\) are
independent and normally distributed) and \(i = 0, \ldots, T-1\) is the
time index.

We can use this closed form solution to simulate stock prices for AAPL.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{aapl }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\StringTok{\textquotesingle{}AAPL\textquotesingle{}}\NormalTok{)}
\NormalTok{    .assign(Return}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].pct\_change())}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{])}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  1 of 1 completed
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{aapl.describe()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllll@{}}
\toprule\noalign{}
Variable & Open & High & Low & Close & Adj Close & Volume & Return \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
count & 10926.00 & 10926.00 & 10926.00 & 10926.00 & 10926.00 & 10926.00
& 10925.00 \\
mean & 21.13 & 21.35 & 20.91 & 21.14 & 20.37 & 319740189.00 & 0.00 \\
std & 43.79 & 44.26 & 43.35 & 43.82 & 43.42 & 335918295.20 & 0.03 \\
min & 0.05 & 0.05 & 0.05 & 0.05 & 0.04 & 0.00 & -0.52 \\
25\% & 0.30 & 0.30 & 0.29 & 0.30 & 0.24 & 114434300.00 & -0.01 \\
50\% & 0.52 & 0.53 & 0.51 & 0.52 & 0.42 & 207588200.00 & 0.00 \\
75\% & 19.45 & 19.60 & 19.23 & 19.40 & 16.89 & 399854000.00 & 0.01 \\
max & 198.02 & 199.62 & 197.00 & 198.11 & 197.86 & 7421640800.00 &
0.33 \\
\end{longtable}

We will use returns from 2021 to predict prices in 2022 (i.e., train in
2021, and test in 2022).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{train }\OperatorTok{=}\NormalTok{ aapl.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{]}
\NormalTok{test }\OperatorTok{=}\NormalTok{ aapl.loc[}\StringTok{\textquotesingle{}2022\textquotesingle{}}\NormalTok{]}
\end{Highlighting}
\end{Shaded}

We will use the following function to simulate price paths. Throughout
this lecture notebook, we will use one-trading-day steps (i.e.,
\texttt{dt=1}).

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ simulate\_gbm(S\_0, mu, sigma, n\_steps, dt}\OperatorTok{=}\DecValTok{1}\NormalTok{, seed}\OperatorTok{=}\DecValTok{42}\NormalTok{):}
    \CommentTok{\textquotesingle{}\textquotesingle{}\textquotesingle{}}
\CommentTok{    Function to simulate stock prices following Geometric Brownian Motion (GBM).}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    S\_0 : float}
\CommentTok{        Initial stock price}
\CommentTok{    mu : float}
\CommentTok{        Drift coefficient}
\CommentTok{    sigma : float}
\CommentTok{        Diffusion coefficient}
\CommentTok{    n\_steps : int}
\CommentTok{        Length of the forecast horizon in time increments, so T = n\_steps * dt}
\CommentTok{    dt : int}
\CommentTok{        Time increment, typically one day}
\CommentTok{    seed : int}
\CommentTok{        Random seed for reproducibility}

\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    S\_t : np.ndarray}
\CommentTok{        Array (length: n\_steps + 1) of simulated prices}
\CommentTok{    \textquotesingle{}\textquotesingle{}\textquotesingle{}}

\NormalTok{    np.random.seed(seed)}
\NormalTok{    dW }\OperatorTok{=}\NormalTok{ np.random.normal(scale}\OperatorTok{=}\NormalTok{np.sqrt(dt), size}\OperatorTok{=}\NormalTok{n\_steps)}
\NormalTok{    W }\OperatorTok{=}\NormalTok{ dW.cumsum()}
    
\NormalTok{    t }\OperatorTok{=}\NormalTok{ np.linspace(dt, n\_steps }\OperatorTok{*}\NormalTok{ dt, n\_steps)}
    
\NormalTok{    S\_t }\OperatorTok{=}\NormalTok{ S\_0 }\OperatorTok{*}\NormalTok{ np.exp((mu }\OperatorTok{{-}} \FloatTok{0.5} \OperatorTok{*}\NormalTok{ sigma}\OperatorTok{**}\DecValTok{2}\NormalTok{) }\OperatorTok{*}\NormalTok{ t }\OperatorTok{+}\NormalTok{ sigma }\OperatorTok{*}\NormalTok{ W)}
\NormalTok{    S\_t }\OperatorTok{=}\NormalTok{ np.insert(S\_t, }\DecValTok{0}\NormalTok{, S\_0)}
    
    \ControlFlowTok{return}\NormalTok{ S\_t}
\end{Highlighting}
\end{Shaded}

Now we will simulate price paths. Here is one simulated price path:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{simulate\_gbm(}
\NormalTok{    S\_0}\OperatorTok{=}\NormalTok{train[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{],}
\NormalTok{    mu}\OperatorTok{=}\NormalTok{train[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{].pipe(np.log1p).mean(),}
\NormalTok{    sigma}\OperatorTok{=}\NormalTok{train[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{].pipe(np.log1p).std(),}
\NormalTok{    n\_steps}\OperatorTok{=}\NormalTok{test.shape[}\DecValTok{0}\NormalTok{]}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([175.34, 176.91, 176.71, 178.72, 183.26, 182.78, 182.3 , 187.1 ,
       189.59, 188.38, 190.21, 189.02, 187.83, 188.75, 183.32, 178.58,
       177.18, 174.55, 175.61, 173.29, 169.64, 173.8 , 173.36, 173.73,
       170.04, 168.76, 169.24, 166.36, 167.53, 166.12, 165.53, 164.14,
       169.2 , 169.34, 166.71, 169.07, 166.01, 166.74, 161.82, 158.63,
       159.29, 161.33, 161.94, 161.81, 161.21, 157.66, 156.04, 155.07,
       157.85, 158.88, 154.67, 155.63, 154.85, 153.36, 155.02, 157.73,
       160.24, 158.29, 157.69, 158.68, 161.32, 160.27, 159.97, 157.36,
       154.58, 156.74, 160.31, 160.3 , 163.03, 164.14, 162.64, 163.75,
       167.96, 168.04, 172.43, 165.61, 167.95, 168.36, 167.74, 168.16,
       163.14, 162.74, 163.84, 167.89, 166.69, 164.75, 163.62, 166.18,
       167.22, 166.  , 167.53, 167.97, 170.74, 169.03, 168.34, 167.47,
       163.82, 164.76, 165.61, 165.8 , 165.36, 161.88, 160.97, 160.27,
       158.42, 158.18, 159.37, 164.36, 164.99, 165.84, 165.82, 161.03,
       161.14, 161.46, 168.05, 167.71, 168.69, 168.78, 165.87, 169.07,
       171.27, 173.61, 171.31, 175.34, 171.67, 173.46, 179.76, 177.15,
       175.76, 176.22, 175.01, 170.95, 171.32, 168.64, 170.09, 167.81,
       172.16, 170.22, 169.53, 171.91, 168.78, 169.56, 173.28, 169.12,
       169.79, 170.67, 172.97, 169.8 , 166.47, 168.03, 169.  , 169.85,
       170.96, 169.31, 170.11, 171.08, 169.34, 174.59, 176.09, 172.99,
       174.98, 172.48, 174.83, 178.25, 176.14, 179.03, 180.39, 182.94,
       188.71, 188.18, 186.15, 183.74, 181.58, 181.55, 182.72, 183.72,
       186.33, 186.57, 191.1 , 190.51, 199.09, 201.28, 198.78, 195.65,
       197.36, 196.87, 199.31, 201.02, 201.  , 198.54, 194.05, 192.88,
       195.72, 196.59, 192.96, 193.69, 195.08, 192.58, 193.25, 193.63,
       190.37, 191.65, 193.56, 197.11, 200.63, 196.52, 193.83, 195.62,
       197.43, 199.25, 211.99, 214.13, 218.24, 221.79, 224.32, 223.44,
       226.38, 223.87, 223.27, 221.79, 222.32, 230.84, 224.37, 227.05,
       221.57, 220.16, 224.22, 224.68, 221.12, 218.86, 221.46, 219.15,
       220.13, 220.53, 218.5 , 226.27, 228.79, 221.81, 222.7 , 220.62,
       223.85, 221.29, 221.13, 223.13, 226.45, 222.43, 221.49, 220.06,
       218.03, 224.44, 226.12, 221.89])
\end{verbatim}

We will combine \texttt{simulate\_gbm()} with a list comprehension and
\texttt{pd.concat()} to simulate and collect many price paths. To
simplify this combination, we will write a helper function
\texttt{simulate\_gbm\_series()} that:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  Returns a series
\item
  Helps us vary the \texttt{seed} argument (otherwise \texttt{seed} will
  remain the default value of 42, and every returned price path will be
  the same)
\end{enumerate}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ simulate\_gbm\_series(seed, train}\OperatorTok{=}\NormalTok{train, test}\OperatorTok{=}\NormalTok{test):}
\NormalTok{    S\_t }\OperatorTok{=}\NormalTok{ simulate\_gbm(}
\NormalTok{        S\_0}\OperatorTok{=}\NormalTok{train[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{],}
\NormalTok{        mu}\OperatorTok{=}\NormalTok{train[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{].pipe(np.log1p).mean(),}
\NormalTok{        sigma}\OperatorTok{=}\NormalTok{train[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{].pipe(np.log1p).std(),}
\NormalTok{        n\_steps}\OperatorTok{=}\NormalTok{test.shape[}\DecValTok{0}\NormalTok{],}
\NormalTok{        seed}\OperatorTok{=}\NormalTok{seed}
\NormalTok{    )}
    \ControlFlowTok{return}\NormalTok{ pd.Series(data}\OperatorTok{=}\NormalTok{S\_t, index}\OperatorTok{=}\NormalTok{test.index.insert(}\DecValTok{0}\NormalTok{, train.index[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{n }\OperatorTok{=} \DecValTok{100}
\NormalTok{S\_t }\OperatorTok{=}\NormalTok{ pd.concat(}
\NormalTok{    objs}\OperatorTok{=}\NormalTok{[simulate\_gbm\_series(seed}\OperatorTok{=}\NormalTok{seed) }\ControlFlowTok{for}\NormalTok{ seed }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(n)],}
\NormalTok{    axis}\OperatorTok{=}\DecValTok{1}\NormalTok{,}
\NormalTok{    keys}\OperatorTok{=}\BuiltInTok{range}\NormalTok{(n),}
\NormalTok{    names}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Simulation\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\NormalTok{S\_t}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
Simulation & 0 & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & ... & 90 & 91 & 92
& 93 & 94 & 95 & 96 & 97 & 98 & 99 \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2021-12-31 & 175.34 & 175.34 & 175.34 & 175.34 & 175.34 & 175.34 &
175.34 & 175.34 & 175.34 & 175.34 & ... & 175.34 & 175.34 & 175.34 &
175.34 & 175.34 & 175.34 & 175.34 & 175.34 & 175.34 & 175.34 \\
2022-01-03 & 180.49 & 180.09 & 174.37 & 180.56 & 175.67 & 176.75 &
174.66 & 180.28 & 175.78 & 175.53 & ... & 174.90 & 173.85 & 176.17 &
180.11 & 177.60 & 173.69 & 175.72 & 170.73 & 176.84 & 175.13 \\
2022-01-04 & 181.83 & 178.55 & 174.40 & 182.00 & 177.25 & 176.02 &
176.87 & 179.15 & 179.03 & 174.91 & ... & 174.46 & 171.14 & 177.21 &
183.46 & 182.11 & 172.28 & 175.77 & 169.76 & 181.67 & 181.11 \\
2022-01-05 & 184.86 & 177.25 & 168.79 & 182.47 & 174.66 & 183.11 &
177.67 & 179.43 & 173.78 & 172.03 & ... & 173.02 & 169.84 & 175.35 &
189.74 & 180.28 & 173.39 & 174.13 & 167.94 & 184.76 & 182.12 \\
2022-01-06 & 191.72 & 174.45 & 173.41 & 177.36 & 176.77 & 182.57 &
175.35 & 180.78 & 170.20 & 172.18 & ... & 171.03 & 169.28 & 168.40 &
191.34 & 185.54 & 175.23 & 175.30 & 170.82 & 182.90 & 186.18 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2022-12-23 & 262.97 & 307.38 & 208.18 & 242.58 & 279.49 & 226.84 &
237.21 & 207.60 & 215.97 & 252.47 & ... & 238.62 & 348.72 & 236.58 &
238.55 & 210.66 & 239.32 & 221.16 & 182.12 & 212.46 & 250.85 \\
2022-12-27 & 267.77 & 305.56 & 209.65 & 250.91 & 278.46 & 226.17 &
234.01 & 205.90 & 212.35 & 258.89 & ... & 232.39 & 348.33 & 238.03 &
240.24 & 211.97 & 239.87 & 225.12 & 183.42 & 212.66 & 250.37 \\
2022-12-28 & 264.63 & 314.76 & 211.58 & 255.46 & 275.50 & 223.94 &
238.34 & 205.77 & 211.07 & 255.26 & ... & 236.72 & 346.96 & 241.94 &
237.04 & 211.12 & 232.35 & 234.97 & 185.88 & 210.80 & 248.57 \\
2022-12-29 & 258.84 & 308.66 & 210.69 & 256.40 & 274.30 & 225.66 &
237.77 & 201.47 & 210.91 & 258.48 & ... & 241.33 & 361.64 & 238.74 &
238.67 & 210.80 & 227.92 & 237.16 & 180.01 & 207.84 & 250.33 \\
2022-12-30 & 261.26 & 307.30 & 209.97 & 263.75 & 275.18 & 225.39 &
242.19 & 201.15 & 212.93 & 261.03 & ... & 236.42 & 370.19 & 241.31 &
238.46 & 204.33 & 228.72 & 236.61 & 182.26 & 212.64 & 248.27 \\
\end{longtable}

Below, we prefix the simulated price path column names with \texttt{\_}
to hide them from the legend. However, this feature triggers a warning
\emph{100 times}! We will suppress these 100 warnings with the warnings
package. Generally, we should avoid suppressing warnings, however it is
the easiest option here.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fig, ax }\OperatorTok{=}\NormalTok{ plt.subplots(}\DecValTok{1}\NormalTok{,}\DecValTok{1}\NormalTok{)}
\ControlFlowTok{with}\NormalTok{ warnings.catch\_warnings():}
\NormalTok{    warnings.simplefilter(}\StringTok{"ignore"}\NormalTok{)}
\NormalTok{    S\_t.add\_prefix(}\StringTok{\textquotesingle{}\_\textquotesingle{}}\NormalTok{).plot(alpha}\OperatorTok{=}\FloatTok{0.1}\NormalTok{, ax}\OperatorTok{=}\NormalTok{ax)}
\NormalTok{S\_t.mean(axis}\OperatorTok{=}\DecValTok{1}\NormalTok{).plot(label}\OperatorTok{=}\StringTok{\textquotesingle{}Mean\textquotesingle{}}\NormalTok{, ax}\OperatorTok{=}\NormalTok{ax)}
\NormalTok{aapl.loc[S\_t.index, [}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{]].plot(label}\OperatorTok{=}\StringTok{\textquotesingle{}Observed\textquotesingle{}}\NormalTok{, ax}\OperatorTok{=}\NormalTok{ax)}
\NormalTok{plt.legend()}
\NormalTok{plt.ylabel(}\StringTok{\textquotesingle{}Price ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}
    \StringTok{\textquotesingle{}Apple Simulated and Observed Prices\textquotesingle{}} \OperatorTok{+} 
    \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}n}\SpecialStringTok{Trained from }\SpecialCharTok{\{}\NormalTok{train}\SpecialCharTok{.}\NormalTok{index[}\DecValTok{0}\NormalTok{]}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{Y}\OperatorTok{{-}\%}\NormalTok{m}\OperatorTok{{-}\%}\NormalTok{d}\SpecialCharTok{\}}\SpecialStringTok{ to }\SpecialCharTok{\{}\NormalTok{train}\SpecialCharTok{.}\NormalTok{index[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}\SpecialCharTok{:}\OperatorTok{\%}\NormalTok{Y}\OperatorTok{{-}\%}\NormalTok{m}\OperatorTok{{-}\%}\NormalTok{d}\SpecialCharTok{\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_05_lecture_files/figure-pdf/cell-11-output-1.png}

\subsection{Pricing Stock Options}\label{pricing-stock-options}

We can use simulated price paths to price options! We will use the Black
and Scholes (1973) formula as a benchmark. Black and Scholes (1973)
provide a closed form (i.e., analytic) solution to price European
options.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ price\_bs(S\_0, K, T, r, sigma, }\BuiltInTok{type}\OperatorTok{=}\StringTok{\textquotesingle{}call\textquotesingle{}}\NormalTok{):}
    \CommentTok{\textquotesingle{}\textquotesingle{}\textquotesingle{}}
\CommentTok{    Function used for calculating the price of European options using the analytical form of the Black{-}Scholes model.}
\CommentTok{    }
\CommentTok{    Parameters}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    S\_0 : float}
\CommentTok{        Initial stock price}
\CommentTok{    K : float}
\CommentTok{        Strike price}
\CommentTok{    T : float}
\CommentTok{        Time to expiration in days}
\CommentTok{    r : float}
\CommentTok{        Daily risk{-}free rate}
\CommentTok{    sigma : float}
\CommentTok{        Standard deviation of daily stock returns}
\CommentTok{    type : str}
\CommentTok{        Type of the option. Allowable: [\textquotesingle{}call\textquotesingle{}, \textquotesingle{}put\textquotesingle{}]}
\CommentTok{    }
\CommentTok{    Returns}
\CommentTok{    {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{    option\_premium : float}
\CommentTok{        The premium on the option calculated using the Black{-}Scholes model}
\CommentTok{    \textquotesingle{}\textquotesingle{}\textquotesingle{}}
    
\NormalTok{    d1 }\OperatorTok{=}\NormalTok{ (np.log(S\_0 }\OperatorTok{/}\NormalTok{ K) }\OperatorTok{+}\NormalTok{ (r }\OperatorTok{+} \FloatTok{0.5} \OperatorTok{*}\NormalTok{ sigma }\OperatorTok{**} \DecValTok{2}\NormalTok{) }\OperatorTok{*}\NormalTok{ T) }\OperatorTok{/}\NormalTok{ (sigma }\OperatorTok{*}\NormalTok{ np.sqrt(T))}
\NormalTok{    d2 }\OperatorTok{=}\NormalTok{ d1 }\OperatorTok{{-}}\NormalTok{ sigma }\OperatorTok{*}\NormalTok{ np.sqrt(T)}
    
    \ControlFlowTok{if} \BuiltInTok{type} \OperatorTok{==} \StringTok{\textquotesingle{}call\textquotesingle{}}\NormalTok{:}
\NormalTok{        val }\OperatorTok{=}\NormalTok{ (norm.cdf(d1, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{) }\OperatorTok{*}\NormalTok{ S\_0) }\OperatorTok{{-}}\NormalTok{ (norm.cdf(d2, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{) }\OperatorTok{*}\NormalTok{ K }\OperatorTok{*}\NormalTok{ np.exp(}\OperatorTok{{-}}\NormalTok{r }\OperatorTok{*}\NormalTok{ T))}
    \ControlFlowTok{elif} \BuiltInTok{type} \OperatorTok{==} \StringTok{\textquotesingle{}put\textquotesingle{}}\NormalTok{:}
\NormalTok{        val }\OperatorTok{=}\NormalTok{ (norm.cdf(}\OperatorTok{{-}}\NormalTok{d2, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{) }\OperatorTok{*}\NormalTok{ K }\OperatorTok{*}\NormalTok{ np.exp(}\OperatorTok{{-}}\NormalTok{r }\OperatorTok{*}\NormalTok{ T)) }\OperatorTok{{-}}\NormalTok{ (norm.cdf(}\OperatorTok{{-}}\NormalTok{d1, }\DecValTok{0}\NormalTok{, }\DecValTok{1}\NormalTok{) }\OperatorTok{*}\NormalTok{ S\_0)}
    \ControlFlowTok{else}\NormalTok{:}
        \ControlFlowTok{raise} \PreprocessorTok{ValueError}\NormalTok{(}\StringTok{\textquotesingle{}Wrong input for type!\textquotesingle{}}\NormalTok{)}
        
    \ControlFlowTok{return}\NormalTok{ val}
\end{Highlighting}
\end{Shaded}

We can use the AAPL parameters above to price a European call option on
AAPL stock. We will calculate its price at the end of 2021 with an
expiration at the end of 2022, assuming a 5\% risk-free rate.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{S\_0 }\OperatorTok{=}\NormalTok{ train[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]}
\NormalTok{K }\OperatorTok{=} \DecValTok{100}
\NormalTok{T }\OperatorTok{=}\NormalTok{ test.shape[}\DecValTok{0}\NormalTok{]}
\NormalTok{r }\OperatorTok{=} \FloatTok{0.05}\OperatorTok{/}\DecValTok{252}
\NormalTok{sigma }\OperatorTok{=}\NormalTok{ train[}\StringTok{\textquotesingle{}Return\textquotesingle{}}\NormalTok{].pipe(np.log1p).std()}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{S\_0}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
175.34
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{\_ }\OperatorTok{=}\NormalTok{ price\_bs(}
\NormalTok{    S\_0}\OperatorTok{=}\NormalTok{S\_0,}
\NormalTok{    K}\OperatorTok{=}\NormalTok{K,}
\NormalTok{    T}\OperatorTok{=}\NormalTok{T,}
\NormalTok{    r}\OperatorTok{=}\NormalTok{r,}
\NormalTok{    sigma}\OperatorTok{=}\NormalTok{sigma}
\NormalTok{)}

\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}Black and Scholes (1973) option price: }\SpecialCharTok{\{}\NormalTok{\_}\SpecialCharTok{:0.2f\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Black and Scholes (1973) option price: 80.28
\end{verbatim}

To simulate the Black and Scholes (1973) option price, we must simulate
AAPL prices with the same 5\% risk-free rate as the drift. We will write
a new helper function to use the same inputs as above.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ simulate\_gbm\_series(seed, S\_0}\OperatorTok{=}\NormalTok{S\_0, T}\OperatorTok{=}\NormalTok{T, r}\OperatorTok{=}\NormalTok{r, sigma}\OperatorTok{=}\NormalTok{sigma, train}\OperatorTok{=}\NormalTok{train, test}\OperatorTok{=}\NormalTok{test):}
\NormalTok{    S\_t }\OperatorTok{=}\NormalTok{ simulate\_gbm(}
\NormalTok{        S\_0}\OperatorTok{=}\NormalTok{S\_0,}
\NormalTok{        mu}\OperatorTok{=}\NormalTok{r,}
\NormalTok{        sigma}\OperatorTok{=}\NormalTok{sigma,}
\NormalTok{        n\_steps}\OperatorTok{=}\NormalTok{T,}
\NormalTok{        seed}\OperatorTok{=}\NormalTok{seed}
\NormalTok{    )}
    \ControlFlowTok{return}\NormalTok{ pd.Series(data}\OperatorTok{=}\NormalTok{S\_t, index}\OperatorTok{=}\NormalTok{test.index.insert(}\DecValTok{0}\NormalTok{, train.index[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{]))}
\end{Highlighting}
\end{Shaded}

We will simulate more price paths to increase the precision of out
option price.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{n }\OperatorTok{=} \DecValTok{10\_000}
\NormalTok{S\_t }\OperatorTok{=}\NormalTok{ pd.concat(}
\NormalTok{    objs}\OperatorTok{=}\NormalTok{[simulate\_gbm\_series(seed}\OperatorTok{=}\NormalTok{seed) }\ControlFlowTok{for}\NormalTok{ seed }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(n)],}
\NormalTok{    axis}\OperatorTok{=}\DecValTok{1}\NormalTok{,}
\NormalTok{    keys}\OperatorTok{=}\BuiltInTok{range}\NormalTok{(n),}
\NormalTok{    names}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Simulation\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\NormalTok{S\_t}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
Simulation & 0 & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & ... & 9990 & 9991 &
9992 & 9993 & 9994 & 9995 & 9996 & 9997 & 9998 & 9999 \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2021-12-31 & 175.34 & 175.34 & 175.34 & 175.34 & 175.34 & 175.34 &
175.34 & 175.34 & 175.34 & 175.34 & ... & 175.34 & 175.34 & 175.34 &
175.34 & 175.34 & 175.34 & 175.34 & 175.34 & 175.34 & 175.34 \\
2022-01-03 & 180.31 & 179.91 & 174.20 & 180.38 & 175.49 & 176.58 &
174.49 & 180.10 & 175.61 & 175.36 & ... & 177.19 & 175.01 & 173.26 &
173.03 & 172.07 & 171.35 & 172.64 & 175.64 & 176.66 & 173.93 \\
2022-01-04 & 181.47 & 178.20 & 174.06 & 181.64 & 176.90 & 175.67 &
176.53 & 178.79 & 178.67 & 174.57 & ... & 176.51 & 175.87 & 174.64 &
175.25 & 170.52 & 170.45 & 177.24 & 174.25 & 175.47 & 175.58 \\
2022-01-05 & 184.31 & 176.73 & 168.29 & 181.93 & 174.15 & 182.57 &
177.15 & 178.90 & 173.27 & 171.53 & ... & 179.24 & 174.44 & 175.30 &
173.07 & 166.81 & 168.76 & 179.92 & 174.76 & 175.79 & 175.73 \\
2022-01-06 & 190.97 & 173.77 & 172.73 & 176.67 & 176.08 & 181.85 &
174.66 & 180.07 & 169.53 & 171.51 & ... & 182.15 & 175.25 & 174.19 &
175.99 & 167.06 & 171.90 & 181.76 & 175.84 & 171.63 & 174.39 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2022-12-23 & 206.32 & 241.17 & 163.34 & 190.32 & 219.29 & 177.98 &
186.11 & 162.88 & 169.45 & 198.09 & ... & 155.35 & 165.02 & 136.69 &
250.88 & 143.47 & 128.72 & 241.58 & 203.06 & 193.55 & 185.52 \\
2022-12-27 & 209.89 & 239.51 & 164.33 & 196.67 & 218.27 & 177.28 &
183.42 & 161.39 & 166.44 & 202.92 & ... & 159.47 & 163.95 & 137.86 &
254.08 & 144.77 & 133.00 & 239.79 & 203.96 & 186.88 & 191.02 \\
2022-12-28 & 207.22 & 246.48 & 165.68 & 200.04 & 215.73 & 175.36 &
186.64 & 161.13 & 165.28 & 199.88 & ... & 157.21 & 163.16 & 139.14 &
258.26 & 145.83 & 130.34 & 239.68 & 212.17 & 190.77 & 191.76 \\
2022-12-29 & 202.49 & 241.46 & 164.82 & 200.58 & 214.58 & 176.54 &
186.01 & 157.61 & 164.99 & 202.20 & ... & 155.79 & 164.04 & 138.34 &
260.85 & 143.42 & 128.22 & 241.18 & 216.13 & 186.57 & 188.86 \\
2022-12-30 & 204.18 & 240.17 & 164.10 & 206.12 & 215.06 & 176.14 &
189.28 & 157.20 & 166.41 & 204.00 & ... & 155.60 & 163.55 & 134.08 &
267.53 & 140.05 & 130.25 & 243.21 & 222.57 & 186.76 & 191.31 \\
\end{longtable}

We can compare this price to a simulated price. The payoff on the call
option is \(S_T - K\) or \(0\), whichever is higher. The price of the
option is the present value of the mean payoff, discounted at the
risk-free rate.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{payoff }\OperatorTok{=}\NormalTok{ np.maximum(S\_t.iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{{-}}\NormalTok{ K, }\DecValTok{0}\NormalTok{)}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}Simulated option price: }\SpecialCharTok{\{}\NormalTok{payoff}\SpecialCharTok{.}\NormalTok{mean() }\OperatorTok{*}\NormalTok{ np}\SpecialCharTok{.}\NormalTok{exp(}\OperatorTok{{-}}\NormalTok{r }\OperatorTok{*}\NormalTok{ T)}\SpecialCharTok{:0.2f\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Simulated option price: 80.98
\end{verbatim}

The option prices do not match exactly. However, we can simulate more
price paths to bring our simulated option price closer to the analytic
solution.

\section{Estimating Value-at-Risk using Monte
Carlo}\label{estimating-value-at-risk-using-monte-carlo}

Value-at-Risk (VaR) measures the risk associated with a portfolio VaR
reports the worst expected loss, at a given level of confidence, over a
certain horizon under normal market conditions. For example, say the
1-day 95\% VaR of our portfolio is 100 dollars. This implies that that
95\% of the time (under normal market conditions), we should not lose
more than 100 dollars over one day. We typically present VaR as a
positive value, so a VaR of 100 dollars implies a loss of \emph{less
than 100 dollars}.

We can calculate VaR several ways, including:

\begin{itemize}
\tightlist
\item
  Parametric Approach (Variance-Covariance)
\item
  Historical Simulation Approach
\item
  Monte Carlo simulations
\end{itemize}

We only consider the last method to calculate the 1-day VaR of an
portfolio of 20 shares each of META and GOOG.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{tickers }\OperatorTok{=}\NormalTok{ [}\StringTok{\textquotesingle{}GOOG\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}META\textquotesingle{}}\NormalTok{]}
\NormalTok{shares }\OperatorTok{=}\NormalTok{ np.array([}\DecValTok{20}\NormalTok{, }\DecValTok{20}\NormalTok{])}
\NormalTok{T }\OperatorTok{=} \DecValTok{1}
\NormalTok{n\_sims }\OperatorTok{=} \DecValTok{10\_000}
\end{Highlighting}
\end{Shaded}

However, we will download all data from Yahoo! Finance and subset our
data later.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{df }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    yf.download(tickers}\OperatorTok{=}\NormalTok{tickers)}
\NormalTok{    .rename\_axis(columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Ticker\textquotesingle{}}\NormalTok{])}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
[*********************100%%**********************]  2 of 2 completed
\end{verbatim}

Next, we calculate daily returns during 2022. Choosing the window to
define ``normal market conditions'' is part art, part science, and beyod
the scope of this lecture notebook.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns }\OperatorTok{=}\NormalTok{ df[}\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].pct\_change().loc[}\StringTok{\textquotesingle{}2022\textquotesingle{}}\NormalTok{]}
\NormalTok{returns}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lll@{}}
\toprule\noalign{}
Ticker & GOOG & META \\
Date & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2022-01-03 & 0.00 & 0.01 \\
2022-01-04 & -0.00 & -0.01 \\
2022-01-05 & -0.05 & -0.04 \\
2022-01-06 & -0.00 & 0.03 \\
2022-01-07 & -0.00 & -0.00 \\
... & ... & ... \\
2022-12-23 & 0.02 & 0.01 \\
2022-12-27 & -0.02 & -0.01 \\
2022-12-28 & -0.02 & -0.01 \\
2022-12-29 & 0.03 & 0.04 \\
2022-12-30 & -0.00 & 0.00 \\
\end{longtable}

We will need the variance-covariance matrix.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{cov\_mat }\OperatorTok{=}\NormalTok{ returns.cov()}
\NormalTok{cov\_mat }\OperatorTok{*} \DecValTok{100}\OperatorTok{**}\DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}lll@{}}
\toprule\noalign{}
Ticker & GOOG & META \\
Ticker & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
GOOG & 5.96 & 6.74 \\
META & 6.74 & 16.38 \\
\end{longtable}

We will use the variance-covariance matrix to calculate the Cholesky
decomposition.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{chol\_mat }\OperatorTok{=}\NormalTok{ np.linalg.cholesky(cov\_mat)}
\NormalTok{chol\_mat}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[0.02, 0.  ],
       [0.03, 0.03]])
\end{verbatim}

The Cholesky decomposition helps us generate random variables with the
same variance and covariance as the observed data.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{rv }\OperatorTok{=}\NormalTok{ np.random.normal(size}\OperatorTok{=}\NormalTok{(n\_sims, }\BuiltInTok{len}\NormalTok{(tickers)))}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{correlated\_rv }\OperatorTok{=}\NormalTok{ (chol\_mat }\OperatorTok{@}\NormalTok{ rv.T).T}
\NormalTok{correlated\_rv}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 0.04,  0.05],
       [ 0.02,  0.02],
       [-0.02, -0.04],
       ...,
       [-0.04,  0.01],
       [-0.  , -0.09],
       [-0.02,  0.  ]])
\end{verbatim}

These random variables have a variance-covariance matrix similar to the
real data.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.cov(correlated\_rv.T)  }\OperatorTok{*} \DecValTok{100}\OperatorTok{**}\DecValTok{2}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[ 5.97,  6.85],
       [ 6.85, 16.47]])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.allclose(cov\_mat, np.cov(correlated\_rv.T), rtol}\OperatorTok{=}\FloatTok{0.05}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
True
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{np.mean(correlated\_rv, axis}\OperatorTok{=}\DecValTok{0}\NormalTok{) }\OperatorTok{*} \DecValTok{100}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([0.02, 0.02])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{returns.mean().values }\OperatorTok{*} \DecValTok{100}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([-0.16, -0.32])
\end{verbatim}

Here are the parameters for the simulated price paths:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mu }\OperatorTok{=}\NormalTok{ returns.mean().values}
\NormalTok{sigma }\OperatorTok{=}\NormalTok{ returns.std().values}
\NormalTok{S\_0 }\OperatorTok{=}\NormalTok{ df.loc[}\StringTok{\textquotesingle{}2021\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Adj Close\textquotesingle{}}\NormalTok{].iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].values}
\NormalTok{P\_0 }\OperatorTok{=}\NormalTok{ S\_0.dot(shares)}
\end{Highlighting}
\end{Shaded}

Calculate terminal prices using the GBM formula above:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{S\_T }\OperatorTok{=}\NormalTok{ S\_0 }\OperatorTok{*}\NormalTok{ np.exp((r }\OperatorTok{{-}} \FloatTok{0.5} \OperatorTok{*}\NormalTok{ sigma }\OperatorTok{**} \DecValTok{2}\NormalTok{) }\OperatorTok{*}\NormalTok{ T }\OperatorTok{+}\NormalTok{ sigma }\OperatorTok{*}\NormalTok{ np.sqrt(T) }\OperatorTok{*}\NormalTok{ correlated\_rv)}

\NormalTok{S\_T}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([[144.79, 336.46],
       [144.74, 336.03],
       [144.61, 335.27],
       ...,
       [144.53, 335.94],
       [144.65, 334.6 ],
       [144.6 , 335.84]])
\end{verbatim}

Calculate terminal portfolio values and returns. Note that these are
dollar values, since VaR is typically expressed in dollar values.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{P\_T }\OperatorTok{=}\NormalTok{ S\_T.dot(shares)}
\NormalTok{P\_T}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([9625.09, 9615.38, 9597.54, ..., 9609.35, 9584.95, 9608.85])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{P\_diff }\OperatorTok{=}\NormalTok{ P\_T }\OperatorTok{{-}}\NormalTok{ P\_0}
\NormalTok{P\_diff}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
array([ 11.63,   1.92, -15.92, ...,  -4.11, -28.51,  -4.61])
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{P\_diff.mean()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
-4.37
\end{verbatim}

Next, we calculate VaR.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{percentiles }\OperatorTok{=}\NormalTok{ [}\FloatTok{0.01}\NormalTok{, }\FloatTok{0.05}\NormalTok{, }\FloatTok{0.1}\NormalTok{]}
\NormalTok{var }\OperatorTok{=}\NormalTok{ np.percentile(P\_diff, percentiles)}

\ControlFlowTok{for}\NormalTok{ x, y }\KeywordTok{in} \BuiltInTok{zip}\NormalTok{(percentiles, var):}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}1{-}day VaR with }\SpecialCharTok{\{}\DecValTok{100}\OperatorTok{{-}}\NormalTok{x}\SpecialCharTok{\}}\SpecialStringTok{\% confidence: $}\SpecialCharTok{\{}\OperatorTok{{-}}\NormalTok{y}\SpecialCharTok{:.2f\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
1-day VaR with 99.99% confidence: $47.97
1-day VaR with 99.95% confidence: $44.61
1-day VaR with 99.9% confidence: $42.59
\end{verbatim}

Finally, we will plot VaR:

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{fig, ax }\OperatorTok{=}\NormalTok{ plt.subplots()}
\NormalTok{ax.hist(P\_diff, bins}\OperatorTok{=}\DecValTok{100}\NormalTok{, density}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{ax.set\_title(}\SpecialStringTok{f\textquotesingle{}Distribution of 1{-}Day Changes in Portfolio Value}\CharTok{\textbackslash{}n}\SpecialStringTok{ from }\SpecialCharTok{\{}\NormalTok{n\_sims}\SpecialCharTok{\}}\SpecialStringTok{ Simulations\textquotesingle{}}\NormalTok{)}
\NormalTok{ax.axvline(x}\OperatorTok{=}\NormalTok{var[}\DecValTok{2}\NormalTok{], color}\OperatorTok{=}\StringTok{\textquotesingle{}red\textquotesingle{}}\NormalTok{, ls}\OperatorTok{=}\StringTok{\textquotesingle{}{-}{-}\textquotesingle{}}\NormalTok{)}
\NormalTok{ax.text(x}\OperatorTok{=}\NormalTok{var[}\DecValTok{2}\NormalTok{], y}\OperatorTok{=}\DecValTok{1}\NormalTok{, s}\OperatorTok{=}\StringTok{\textquotesingle{}99\% 1{-}Day VaR\textquotesingle{}}\NormalTok{, color}\OperatorTok{=}\StringTok{\textquotesingle{}red\textquotesingle{}}\NormalTok{, ha}\OperatorTok{=}\StringTok{\textquotesingle{}right\textquotesingle{}}\NormalTok{, va}\OperatorTok{=}\StringTok{\textquotesingle{}top\textquotesingle{}}\NormalTok{, rotation}\OperatorTok{=}\DecValTok{90}\NormalTok{, transform}\OperatorTok{=}\NormalTok{ax.get\_xaxis\_transform())}
\NormalTok{ax.set\_ylabel(}\StringTok{\textquotesingle{}Density\textquotesingle{}}\NormalTok{)}
\NormalTok{ax.set\_xlabel(}\StringTok{\textquotesingle{}1{-}Day Change in Portfolio Value ($)\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_05_lecture_files/figure-pdf/cell-36-output-1.png}

\chapter{Herron Topic 5 - Practice for Section
02}\label{herron-topic-5---practice-for-section-02}

\section{Practice}\label{practice-44}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ seaborn }\ImportTok{as}\NormalTok{ sns}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{2}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.2f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{\texorpdfstring{Estimate \(\pi\) by simulating darts thrown
at a dart
board}{Estimate \textbackslash pi by simulating darts thrown at a dart board}}\label{estimate-pi-by-simulating-darts-thrown-at-a-dart-board}

\emph{Hints:} Select random \(x\)s and \(y\)s such that
\(-r \leq x \leq +r\) and \(-r \leq x \leq +r\). Darts are on the board
if \(x^2 + y^2 \leq r^2\). The area of the circlular board is
\(\pi r^2\), and the area of square around the board is
\((2r)^2 = 4r^2\). The fraction \(f\) of darts on the board is the same
as the ratio of circle area to square area, so
\(f = \frac{\pi r^2}{4 r^2}\).

First we throw darts at the board. Darts with \(x^2 + y^2 \leq r^2\) are
on the board.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ throw\_darts(n}\OperatorTok{=}\DecValTok{10\_000}\NormalTok{, r}\OperatorTok{=}\DecValTok{1}\NormalTok{, seed}\OperatorTok{=}\DecValTok{42}\NormalTok{):}
\NormalTok{    np.random.seed(seed)}
    \ControlFlowTok{return}\NormalTok{ (}
\NormalTok{        pd.DataFrame(}
\NormalTok{            data}\OperatorTok{=}\NormalTok{np.random.uniform(low}\OperatorTok{={-}}\NormalTok{r, high}\OperatorTok{=}\NormalTok{r, size}\OperatorTok{=}\DecValTok{2}\OperatorTok{*}\NormalTok{n).reshape(n, }\DecValTok{2}\NormalTok{), }
\NormalTok{            columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}y\textquotesingle{}}\NormalTok{]}
\NormalTok{        )}
\NormalTok{        .assign(board}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}\OperatorTok{**}\DecValTok{2} \OperatorTok{+}\NormalTok{ x[}\StringTok{\textquotesingle{}y\textquotesingle{}}\NormalTok{]}\OperatorTok{**}\DecValTok{2} \OperatorTok{\textless{}=}\NormalTok{ r}\OperatorTok{**}\DecValTok{2}\NormalTok{)}
\NormalTok{        .rename\_axis(index}\OperatorTok{=}\StringTok{\textquotesingle{}n\textquotesingle{}}\NormalTok{, columns}\OperatorTok{=}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{)}
\NormalTok{    )}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{throw\_darts()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
Variable & x & y & board \\
n & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & -0.25 & 0.90 & True \\
1 & 0.46 & 0.20 & True \\
2 & -0.69 & -0.69 & True \\
3 & -0.88 & 0.73 & False \\
4 & 0.20 & 0.42 & True \\
... & ... & ... & ... \\
9995 & 0.15 & 0.52 & True \\
9996 & -0.82 & -0.01 & True \\
9997 & 0.80 & 0.75 & False \\
9998 & -0.91 & -0.39 & True \\
9999 & -0.11 & -0.66 & True \\
\end{longtable}

Next, we visualize these darts with a scatter plot. Seaborn's
\texttt{scatterplot()} helps color darts by location (i.e., on or off
board). The \texttt{.pipe()} method lets us send the output of the
\texttt{.assign()} method to \texttt{sns.scatterplot()} without
assigning a temporary data frame.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    throw\_darts()}
\NormalTok{    .assign(Location}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.where(x[}\StringTok{\textquotesingle{}board\textquotesingle{}}\NormalTok{], }\StringTok{\textquotesingle{}On Board\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Off Board\textquotesingle{}}\NormalTok{))}
\NormalTok{    .pipe(}\KeywordTok{lambda}\NormalTok{ x: sns.scatterplot(data}\OperatorTok{=}\NormalTok{x, x}\OperatorTok{=}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{, y}\OperatorTok{=}\StringTok{\textquotesingle{}y\textquotesingle{}}\NormalTok{, hue}\OperatorTok{=}\StringTok{\textquotesingle{}Location\textquotesingle{}}\NormalTok{))}
\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Simulated Dart Throws\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_05_practice_02_files/figure-pdf/cell-6-output-1.png}

Finally, we use the hint above to estimate \(\pi\). The hint above says
\(f = \frac{\pi r^2}{4 r^2}\), where \(f\) is the fraction of darts on
the board. Therefore, \(\pi = \frac{4fr^2}{r^2} = 4f\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{n }\OperatorTok{=} \DecValTok{10\_000}
\NormalTok{pi }\OperatorTok{=} \DecValTok{4} \OperatorTok{*}\NormalTok{ throw\_darts(n}\OperatorTok{=}\NormalTok{n)[}\StringTok{"board"}\NormalTok{].mean()}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}Estimate of pi based on }\SpecialCharTok{\{}\NormalTok{n}\SpecialCharTok{:,.0f\}}\SpecialStringTok{ darts: }\SpecialCharTok{\{}\NormalTok{pi}\SpecialCharTok{:0.4f\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Estimate of pi based on 10,000 darts: 3.1544
\end{verbatim}

We increase the precision of our \(\pi\) estimate by increasing the
number of simulated darts \(n\).

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ n }\KeywordTok{in} \DecValTok{10}\OperatorTok{**}\NormalTok{np.arange(}\DecValTok{7}\NormalTok{):}
\NormalTok{    pi }\OperatorTok{=} \DecValTok{4} \OperatorTok{*}\NormalTok{ throw\_darts(n}\OperatorTok{=}\NormalTok{n)[}\StringTok{"board"}\NormalTok{].mean()}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}Estimate of pi based on }\SpecialCharTok{\{}\NormalTok{n}\SpecialCharTok{:\textless{}9,.0f\}}\SpecialStringTok{ darts: }\SpecialCharTok{\{}\NormalTok{pi}\SpecialCharTok{:0.4f\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Estimate of pi based on 1         darts: 4.0000
Estimate of pi based on 10        darts: 3.2000
Estimate of pi based on 100       darts: 3.0400
Estimate of pi based on 1,000     darts: 3.1040
Estimate of pi based on 10,000    darts: 3.1544
Estimate of pi based on 100,000   darts: 3.1468
Estimate of pi based on 1,000,000 darts: 3.1420
\end{verbatim}

\subsection{\texorpdfstring{Simulate your wealth \(W_T\) by randomly
sampling market
returns}{Simulate your wealth W\_T by randomly sampling market returns}}\label{simulate-your-wealth-w_t-by-randomly-sampling-market-returns}

Use monthly market returns from the French Data Library. Only invest one
cash flow \(W_0\), and plot the distribution of \(W_T\).

First, we download data from the French Data Library. We convert these
returns from percent to decimal to simplify compounding.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mkt }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pdr.DataReader(}
\NormalTok{        name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{        data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{        start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{    )[}\DecValTok{0}\NormalTok{]}
\NormalTok{    .assign(mkt}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: (x[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ x[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{]) }\OperatorTok{/} \DecValTok{100}\NormalTok{)}
\NormalTok{    [}\StringTok{\textquotesingle{}mkt\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_172\526361920.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

Next, we write a couple of helper functions. The \texttt{get\_sample()}
function draws one random sample of \texttt{n} observations from returns
series \texttt{x}. This sample provides one simulated return history.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pd.date\_range}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
<function pandas.core.indexes.datetimes.date_range(start=None, end=None, periods=None, freq=None, tz=None, normalize: 'bool' = False, name: 'Hashable | None' = None, inclusive: 'IntervalClosedType' = 'both', *, unit: 'str | None' = None, **kwargs) -> 'DatetimeIndex'>
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ get\_sample(x, n}\OperatorTok{=}\DecValTok{10\_000}\NormalTok{, seed}\OperatorTok{=}\DecValTok{42}\NormalTok{, start}\OperatorTok{=}\VariableTok{None}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ start }\KeywordTok{is} \VariableTok{None}\NormalTok{:}
\NormalTok{        start }\OperatorTok{=}\NormalTok{ x.index[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{+}\NormalTok{ pd.offsets.BDay()}
    \ControlFlowTok{return}\NormalTok{ (}
\NormalTok{        x}
\NormalTok{        .sample(n}\OperatorTok{=}\NormalTok{n, replace}\OperatorTok{=}\VariableTok{True}\NormalTok{, random\_state}\OperatorTok{=}\NormalTok{seed, ignore\_index}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{        .set\_axis(pd.date\_range(start}\OperatorTok{=}\NormalTok{start, periods}\OperatorTok{=}\NormalTok{n, freq}\OperatorTok{=}\StringTok{\textquotesingle{}B\textquotesingle{}}\NormalTok{))}
\NormalTok{        .rename\_axis(index}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{)}
\NormalTok{    )    }
\end{Highlighting}
\end{Shaded}

The \texttt{get\_samples()} function calls the \texttt{get\_sample()}
function \texttt{m} times to simulate \texttt{m} return histories. The
\texttt{get\_samples()} function combines these \texttt{m} return
histories into one data frame.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ get\_samples(x, m}\OperatorTok{=}\DecValTok{100}\NormalTok{, n}\OperatorTok{=}\DecValTok{10\_000}\NormalTok{, seed}\OperatorTok{=}\DecValTok{42}\NormalTok{, start}\OperatorTok{=}\VariableTok{None}\NormalTok{):}
    \ControlFlowTok{return}\NormalTok{ (}
\NormalTok{        pd.concat(}
\NormalTok{            objs}\OperatorTok{=}\NormalTok{[get\_sample(x}\OperatorTok{=}\NormalTok{x, n}\OperatorTok{=}\NormalTok{n, seed}\OperatorTok{=}\NormalTok{seed}\OperatorTok{+}\NormalTok{i, start}\OperatorTok{=}\NormalTok{start) }\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(m)],}
\NormalTok{            axis}\OperatorTok{=}\DecValTok{1}\NormalTok{,}
\NormalTok{            keys}\OperatorTok{=}\BuiltInTok{range}\NormalTok{(m),}
\NormalTok{            names}\OperatorTok{=}\StringTok{\textquotesingle{}Sample\textquotesingle{}}
\NormalTok{        )}
\NormalTok{    )}
\end{Highlighting}
\end{Shaded}

Next, we use these helper functions to simulate 100 return histories of
10,000 trading days each.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mkts }\OperatorTok{=}\NormalTok{ get\_samples(x}\OperatorTok{=}\NormalTok{mkt, m}\OperatorTok{=}\DecValTok{100}\NormalTok{, n}\OperatorTok{=}\DecValTok{10\_000}\NormalTok{)}
\NormalTok{mkts}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
Sample & 0 & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & ... & 90 & 91 & 92 & 93
& 94 & 95 & 96 & 97 & 98 & 99 \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-03-01 & 0.00 & 0.01 & 0.00 & 0.00 & 0.00 & 0.00 & -0.00 & 0.00 &
-0.01 & 0.00 & ... & 0.01 & 0.01 & 0.00 & 0.01 & 0.00 & 0.00 & -0.00 &
-0.01 & -0.01 & 0.00 \\
2024-03-04 & 0.01 & -0.00 & 0.00 & 0.01 & 0.00 & -0.01 & -0.01 & 0.01 &
0.00 & -0.01 & ... & -0.00 & 0.00 & 0.01 & -0.02 & 0.00 & 0.01 & 0.01 &
0.01 & -0.01 & -0.01 \\
2024-03-05 & -0.03 & -0.00 & -0.01 & -0.03 & -0.00 & 0.02 & -0.00 & 0.00
& -0.01 & -0.01 & ... & 0.00 & -0.00 & 0.01 & -0.02 & -0.01 & 0.01 &
-0.00 & 0.00 & -0.00 & 0.01 \\
2024-03-06 & -0.00 & -0.00 & -0.01 & -0.00 & 0.01 & 0.01 & 0.00 & -0.02
& 0.00 & -0.01 & ... & 0.01 & -0.01 & 0.00 & 0.00 & 0.00 & -0.02 & -0.02
& 0.00 & -0.00 & 0.01 \\
2024-03-07 & -0.00 & -0.00 & -0.00 & -0.00 & -0.01 & -0.00 & 0.01 & 0.01
& -0.00 & 0.01 & ... & 0.00 & -0.00 & 0.01 & -0.01 & -0.01 & -0.03 &
-0.00 & -0.01 & -0.03 & -0.00 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2062-06-23 & -0.01 & 0.00 & 0.00 & 0.00 & 0.00 & 0.03 & -0.01 & 0.00 &
-0.00 & 0.01 & ... & -0.01 & -0.01 & 0.00 & 0.00 & -0.00 & -0.07 & 0.01
& 0.02 & -0.00 & -0.00 \\
2062-06-26 & -0.00 & 0.01 & -0.00 & 0.01 & 0.00 & -0.01 & 0.01 & 0.00 &
-0.00 & -0.00 & ... & 0.00 & -0.00 & -0.01 & -0.00 & -0.01 & 0.00 & 0.01
& 0.01 & 0.03 & -0.01 \\
2062-06-27 & -0.01 & -0.01 & 0.02 & -0.04 & 0.00 & 0.01 & 0.00 & 0.00 &
0.00 & 0.01 & ... & 0.00 & -0.00 & -0.01 & 0.01 & 0.00 & 0.01 & 0.01 &
0.01 & 0.00 & 0.01 \\
2062-06-28 & -0.01 & -0.01 & 0.00 & -0.00 & -0.01 & -0.00 & 0.04 & 0.00
& -0.00 & -0.00 & ... & 0.02 & -0.00 & -0.01 & -0.01 & -0.00 & 0.01 &
0.00 & 0.01 & -0.00 & -0.01 \\
2062-06-29 & -0.00 & 0.00 & -0.01 & 0.01 & -0.01 & 0.00 & -0.01 & -0.01
& -0.01 & 0.00 & ... & -0.00 & 0.01 & 0.01 & 0.01 & -0.00 & 0.00 & -0.01
& -0.02 & 0.01 & -0.01 \\
\end{longtable}

We compound daily returns \(R_t\) to find future wealth \(W_T\), so
\(W_T = W_0 \times (1 + R_1) \times (1 + R_2) \times \cdots \times (1 + R_T)\).
We use the \texttt{.cumprod()} method to compound the daily returns in
data frame \texttt{mkts}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{W\_0 }\OperatorTok{=} \DecValTok{1\_000\_000}
\NormalTok{W\_t }\OperatorTok{=}\NormalTok{ W\_0 }\OperatorTok{*}\NormalTok{ mkts.add(}\DecValTok{1}\NormalTok{).cumprod()}
\end{Highlighting}
\end{Shaded}

We visualize terminal wealth \(W_T\) with a cumulative distribution
plot.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{W\_t.iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}hist\textquotesingle{}}\NormalTok{, density}\OperatorTok{=}\VariableTok{True}\NormalTok{, cumulative}\OperatorTok{=}\VariableTok{True}\NormalTok{, bins}\OperatorTok{=}\DecValTok{100}\NormalTok{)}
\NormalTok{plt.semilogx()}
\NormalTok{plt.xlabel(}\VerbatimStringTok{r\textquotesingle{}$W\_T$ where $W\_0 = $\textquotesingle{}} \OperatorTok{+} \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}\textbackslash{}}\SpecialStringTok{$}\SpecialCharTok{\{}\NormalTok{W\_0}\SpecialCharTok{:,.0f\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\VerbatimStringTok{r\textquotesingle{}Cumulative Distribution of $W\_T$\textquotesingle{}} \OperatorTok{+} \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}n}\SpecialStringTok{after }\SpecialCharTok{\{}\NormalTok{W\_t}\SpecialCharTok{.}\NormalTok{shape[}\DecValTok{0}\NormalTok{]}\SpecialCharTok{:,.0f\}}\SpecialStringTok{ Trading Days\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_05_practice_02_files/figure-pdf/cell-15-output-1.png}

The plot above shows the cumulative distribution of \(W_T\), suggesting
we expect \(W_T\) greater than about 20 million dollars for about 75\%
of samples. The plot above may be difficult to read and interpret
because \(W_T\) has large outliers. The \texttt{.describe()} method
provides few salient values of \(W_T\). We convert \(W_T\) from dollars
to millions of dollars with \texttt{.div(1\_000\_000)}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{W\_t.iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].div(}\DecValTok{1\_000\_000}\NormalTok{).describe()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
count   100.00
mean     61.07
std      90.71
min       1.50
25%      18.12
50%      41.47
75%      66.93
max     669.23
Name: 2062-06-29 00:00:00, dtype: float64
\end{verbatim}

\subsection{\texorpdfstring{Repeat the exercise above but add
end-of-month investments
\(C_t\)}{Repeat the exercise above but add end-of-month investments C\_t}}\label{repeat-the-exercise-above-but-add-end-of-month-investments-c_t}

We can use the same data frame \texttt{mkts} of simulated market
returns. However, need to consider end-of-month investments of \(C_t\).
The easiest approach is to aggregate the daily market returns in
\texttt{mkts} to monthly market returns in data frame \texttt{mkts\_m}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mkts\_m }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    mkts}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .resample(rule}\OperatorTok{=}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{, kind}\OperatorTok{=}\StringTok{\textquotesingle{}period\textquotesingle{}}\NormalTok{)}
\NormalTok{    .prod()}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The wealth at time \(t\) is \(W_t\) and depends on:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The wealth at the end of the previous month \(W_{t-1}\)
\item
  The return over the previous month \(R_t\) (recall we label returns by
  their right edge)
\item
  The end-of-month investment \(C_t\)
\end{enumerate}

Putting it all togther: \(W_t = W_{t-1} \times (1 + R_t) + C_t\)

We have to loop over the monthly returns in \texttt{mkts\_m} because we
have to combine compounded returns and cash flows. The
\texttt{iterrows()} methods provides an easy way to iterate (loop) over
the rows in \texttt{mkts\_m}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{C\_t }\OperatorTok{=} \DecValTok{1\_000}
\NormalTok{W\_0 }\OperatorTok{=} \DecValTok{1\_000\_000}
\NormalTok{W\_last }\OperatorTok{=}\NormalTok{ W\_0}
\NormalTok{W\_t }\OperatorTok{=}\NormalTok{ []}

\ControlFlowTok{for}\NormalTok{ d, m }\KeywordTok{in}\NormalTok{ mkts\_m.iterrows():}
\NormalTok{    W\_last }\OperatorTok{=}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ m) }\OperatorTok{*}\NormalTok{ W\_last }\OperatorTok{+}\NormalTok{ C\_t}
\NormalTok{    W\_t.append(W\_last)}

\NormalTok{W\_t }\OperatorTok{=}\NormalTok{ pd.concat(objs}\OperatorTok{=}\NormalTok{W\_t, axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{mkts\_m.index).transpose()}
\end{Highlighting}
\end{Shaded}

We repeat the cumulative distribution of wealth plot and descriptive
statistics from above.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{W\_t.iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}hist\textquotesingle{}}\NormalTok{, density}\OperatorTok{=}\VariableTok{True}\NormalTok{, cumulative}\OperatorTok{=}\VariableTok{True}\NormalTok{, bins}\OperatorTok{=}\DecValTok{100}\NormalTok{)}
\NormalTok{plt.semilogx()}
\NormalTok{plt.xlabel(}
    \VerbatimStringTok{r\textquotesingle{}$W\_T$ where $W\_0 = $\textquotesingle{}} \OperatorTok{+} \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}\textbackslash{}}\SpecialStringTok{$}\SpecialCharTok{\{}\NormalTok{W\_0}\SpecialCharTok{:,.0f\}}\SpecialStringTok{\textquotesingle{}} \OperatorTok{+} 
    \VerbatimStringTok{r\textquotesingle{} and  $C\_t = $\textquotesingle{}} \OperatorTok{+} \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}\textbackslash{}}\SpecialStringTok{$}\SpecialCharTok{\{}\NormalTok{C\_t}\SpecialCharTok{:,.0f\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.title(}\VerbatimStringTok{r\textquotesingle{}Cumulative Distribution of $W\_T$\textquotesingle{}} \OperatorTok{+} \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}n}\SpecialStringTok{after }\SpecialCharTok{\{}\NormalTok{W\_t}\SpecialCharTok{.}\NormalTok{shape[}\DecValTok{0}\NormalTok{]}\SpecialCharTok{:,.0f\}}\SpecialStringTok{ Trading Months\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_05_practice_02_files/figure-pdf/cell-19-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{W\_t.iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].div(}\DecValTok{1\_000\_000}\NormalTok{).describe()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
count   100.00
mean     67.84
std      97.55
min       1.99
25%      21.21
50%      46.54
75%      75.92
max     713.85
Name: 2062-06, dtype: float64
\end{verbatim}

The plot above shows the cumulative distribution of \(W_T\), suggesting
we expect \(W_T\) greater than about 20 million dollars for about 75\%
of samples. Note, even though we deposit \$1,000 per month for almost 40
years, we do not gain much wealth over the previous example with only a
lump sum! Start saving early!

\chapter{Herron Topic 5 - Practice for Section
03}\label{herron-topic-5---practice-for-section-03}

\section{Practice}\label{practice-45}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ seaborn }\ImportTok{as}\NormalTok{ sns}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{2}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.2f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{\texorpdfstring{Estimate \(\pi\) by simulating darts thrown
at a dart
board}{Estimate \textbackslash pi by simulating darts thrown at a dart board}}\label{estimate-pi-by-simulating-darts-thrown-at-a-dart-board-1}

\emph{Hints:} Select random \(x\)s and \(y\)s such that
\(-r \leq x \leq +r\) and \(-r \leq x \leq +r\). Darts are on the board
if \(x^2 + y^2 \leq r^2\). The area of the circlular board is
\(\pi r^2\), and the area of square around the board is
\((2r)^2 = 4r^2\). The fraction \(f\) of darts on the board is the same
as the ratio of circle area to square area, so
\(f = \frac{\pi r^2}{4 r^2}\).

First we throw darts at the board. Darts with \(x^2 + y^2 \leq r^2\) are
on the board.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ throw\_darts(n}\OperatorTok{=}\DecValTok{10\_000}\NormalTok{, r}\OperatorTok{=}\DecValTok{1}\NormalTok{, seed}\OperatorTok{=}\DecValTok{42}\NormalTok{):}
\NormalTok{    np.random.seed(seed)}
    \ControlFlowTok{return}\NormalTok{ (}
\NormalTok{        pd.DataFrame(}
\NormalTok{            data}\OperatorTok{=}\NormalTok{np.random.uniform(low}\OperatorTok{={-}}\NormalTok{r, high}\OperatorTok{=}\NormalTok{r, size}\OperatorTok{=}\DecValTok{2}\OperatorTok{*}\NormalTok{n).reshape(n, }\DecValTok{2}\NormalTok{), }
\NormalTok{            columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}y\textquotesingle{}}\NormalTok{]}
\NormalTok{        )}
\NormalTok{        .assign(board}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}\OperatorTok{**}\DecValTok{2} \OperatorTok{+}\NormalTok{ x[}\StringTok{\textquotesingle{}y\textquotesingle{}}\NormalTok{]}\OperatorTok{**}\DecValTok{2} \OperatorTok{\textless{}=}\NormalTok{ r}\OperatorTok{**}\DecValTok{2}\NormalTok{)}
\NormalTok{        .rename\_axis(index}\OperatorTok{=}\StringTok{\textquotesingle{}n\textquotesingle{}}\NormalTok{, columns}\OperatorTok{=}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{)}
\NormalTok{    )}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{throw\_darts()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
Variable & x & y & board \\
n & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & -0.25 & 0.90 & True \\
1 & 0.46 & 0.20 & True \\
2 & -0.69 & -0.69 & True \\
3 & -0.88 & 0.73 & False \\
4 & 0.20 & 0.42 & True \\
... & ... & ... & ... \\
9995 & 0.15 & 0.52 & True \\
9996 & -0.82 & -0.01 & True \\
9997 & 0.80 & 0.75 & False \\
9998 & -0.91 & -0.39 & True \\
9999 & -0.11 & -0.66 & True \\
\end{longtable}

Next, we visualize these darts with a scatter plot. Seaborn's
\texttt{scatterplot()} helps color darts by location (i.e., on or off
board). The \texttt{.pipe()} method lets us send the output of the
\texttt{.assign()} method to \texttt{sns.scatterplot()} without
assigning a temporary data frame.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    throw\_darts()}
\NormalTok{    .assign(Location}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.where(x[}\StringTok{\textquotesingle{}board\textquotesingle{}}\NormalTok{], }\StringTok{\textquotesingle{}On Board\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Off Board\textquotesingle{}}\NormalTok{))}
\NormalTok{    .pipe(}\KeywordTok{lambda}\NormalTok{ x: sns.scatterplot(data}\OperatorTok{=}\NormalTok{x, x}\OperatorTok{=}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{, y}\OperatorTok{=}\StringTok{\textquotesingle{}y\textquotesingle{}}\NormalTok{, hue}\OperatorTok{=}\StringTok{\textquotesingle{}Location\textquotesingle{}}\NormalTok{))}
\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Simulated Dart Throws\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_05_practice_03_files/figure-pdf/cell-6-output-1.png}

Finally, we use the hint above to estimate \(\pi\). The hint above says
\(f = \frac{\pi r^2}{4 r^2}\), where \(f\) is the fraction of darts on
the board. Therefore, \(\pi = \frac{4fr^2}{r^2} = 4f\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{n }\OperatorTok{=} \DecValTok{10\_000}
\NormalTok{pi }\OperatorTok{=} \DecValTok{4} \OperatorTok{*}\NormalTok{ throw\_darts(n}\OperatorTok{=}\NormalTok{n)[}\StringTok{"board"}\NormalTok{].mean()}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}Estimate of pi based on }\SpecialCharTok{\{}\NormalTok{n}\SpecialCharTok{:,.0f\}}\SpecialStringTok{ darts: }\SpecialCharTok{\{}\NormalTok{pi}\SpecialCharTok{:0.4f\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Estimate of pi based on 10,000 darts: 3.1544
\end{verbatim}

We increase the precision of our \(\pi\) estimate by increasing the
number of simulated darts \(n\).

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ n }\KeywordTok{in} \DecValTok{10}\OperatorTok{**}\NormalTok{np.arange(}\DecValTok{7}\NormalTok{):}
\NormalTok{    pi }\OperatorTok{=} \DecValTok{4} \OperatorTok{*}\NormalTok{ throw\_darts(n}\OperatorTok{=}\NormalTok{n)[}\StringTok{"board"}\NormalTok{].mean()}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}Estimate of pi based on }\SpecialCharTok{\{}\NormalTok{n}\SpecialCharTok{:\textless{}9,.0f\}}\SpecialStringTok{ darts: }\SpecialCharTok{\{}\NormalTok{pi}\SpecialCharTok{:0.4f\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Estimate of pi based on 1         darts: 4.0000
Estimate of pi based on 10        darts: 3.2000
Estimate of pi based on 100       darts: 3.0400
Estimate of pi based on 1,000     darts: 3.1040
Estimate of pi based on 10,000    darts: 3.1544
Estimate of pi based on 100,000   darts: 3.1468
Estimate of pi based on 1,000,000 darts: 3.1420
\end{verbatim}

\subsection{\texorpdfstring{Simulate your wealth \(W_T\) by randomly
sampling market
returns}{Simulate your wealth W\_T by randomly sampling market returns}}\label{simulate-your-wealth-w_t-by-randomly-sampling-market-returns-1}

Use monthly market returns from the French Data Library. Only invest one
cash flow \(W_0\), and plot the distribution of \(W_T\).

First, we download data from the French Data Library. We convert these
returns from percent to decimal to simplify compounding.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mkt }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pdr.DataReader(}
\NormalTok{        name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{        data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{        start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{    )[}\DecValTok{0}\NormalTok{]}
\NormalTok{    .assign(mkt}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: (x[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ x[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{]) }\OperatorTok{/} \DecValTok{100}\NormalTok{)}
\NormalTok{    [}\StringTok{\textquotesingle{}mkt\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_1340\526361920.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

Next, we write a couple of helper functions. The \texttt{get\_sample()}
function draws one random sample of \texttt{n} observations from returns
series \texttt{x}. This sample provides one simulated return history.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pd.date\_range}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
<function pandas.core.indexes.datetimes.date_range(start=None, end=None, periods=None, freq=None, tz=None, normalize: 'bool' = False, name: 'Hashable | None' = None, inclusive: 'IntervalClosedType' = 'both', *, unit: 'str | None' = None, **kwargs) -> 'DatetimeIndex'>
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ get\_sample(x, n}\OperatorTok{=}\DecValTok{10\_000}\NormalTok{, seed}\OperatorTok{=}\DecValTok{42}\NormalTok{, start}\OperatorTok{=}\VariableTok{None}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ start }\KeywordTok{is} \VariableTok{None}\NormalTok{:}
\NormalTok{        start }\OperatorTok{=}\NormalTok{ x.index[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{+}\NormalTok{ pd.offsets.BDay()}
    \ControlFlowTok{return}\NormalTok{ (}
\NormalTok{        x}
\NormalTok{        .sample(n}\OperatorTok{=}\NormalTok{n, replace}\OperatorTok{=}\VariableTok{True}\NormalTok{, random\_state}\OperatorTok{=}\NormalTok{seed, ignore\_index}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{        .set\_axis(pd.date\_range(start}\OperatorTok{=}\NormalTok{start, periods}\OperatorTok{=}\NormalTok{n, freq}\OperatorTok{=}\StringTok{\textquotesingle{}B\textquotesingle{}}\NormalTok{))}
\NormalTok{        .rename\_axis(index}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{)}
\NormalTok{    )    }
\end{Highlighting}
\end{Shaded}

The \texttt{get\_samples()} function calls the \texttt{get\_sample()}
function \texttt{m} times to simulate \texttt{m} return histories. The
\texttt{get\_samples()} function combines these \texttt{m} return
histories into one data frame.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ get\_samples(x, m}\OperatorTok{=}\DecValTok{100}\NormalTok{, n}\OperatorTok{=}\DecValTok{10\_000}\NormalTok{, seed}\OperatorTok{=}\DecValTok{42}\NormalTok{, start}\OperatorTok{=}\VariableTok{None}\NormalTok{):}
    \ControlFlowTok{return}\NormalTok{ (}
\NormalTok{        pd.concat(}
\NormalTok{            objs}\OperatorTok{=}\NormalTok{[get\_sample(x}\OperatorTok{=}\NormalTok{x, n}\OperatorTok{=}\NormalTok{n, seed}\OperatorTok{=}\NormalTok{seed}\OperatorTok{+}\NormalTok{i, start}\OperatorTok{=}\NormalTok{start) }\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(m)],}
\NormalTok{            axis}\OperatorTok{=}\DecValTok{1}\NormalTok{,}
\NormalTok{            keys}\OperatorTok{=}\BuiltInTok{range}\NormalTok{(m),}
\NormalTok{            names}\OperatorTok{=}\StringTok{\textquotesingle{}Sample\textquotesingle{}}
\NormalTok{        )}
\NormalTok{    )}
\end{Highlighting}
\end{Shaded}

Next, we use these helper functions to simulate 100 return histories of
10,000 trading days each.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mkts }\OperatorTok{=}\NormalTok{ get\_samples(x}\OperatorTok{=}\NormalTok{mkt, m}\OperatorTok{=}\DecValTok{100}\NormalTok{, n}\OperatorTok{=}\DecValTok{10\_000}\NormalTok{)}
\NormalTok{mkts}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
Sample & 0 & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & ... & 90 & 91 & 92 & 93
& 94 & 95 & 96 & 97 & 98 & 99 \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-03-01 & 0.00 & 0.01 & 0.00 & 0.00 & 0.00 & 0.00 & -0.00 & 0.00 &
-0.01 & 0.00 & ... & 0.01 & 0.01 & 0.00 & 0.01 & 0.00 & 0.00 & -0.00 &
-0.01 & -0.01 & 0.00 \\
2024-03-04 & 0.01 & -0.00 & 0.00 & 0.01 & 0.00 & -0.01 & -0.01 & 0.01 &
0.00 & -0.01 & ... & -0.00 & 0.00 & 0.01 & -0.02 & 0.00 & 0.01 & 0.01 &
0.01 & -0.01 & -0.01 \\
2024-03-05 & -0.03 & -0.00 & -0.01 & -0.03 & -0.00 & 0.02 & -0.00 & 0.00
& -0.01 & -0.01 & ... & 0.00 & -0.00 & 0.01 & -0.02 & -0.01 & 0.01 &
-0.00 & 0.00 & -0.00 & 0.01 \\
2024-03-06 & -0.00 & -0.00 & -0.01 & -0.00 & 0.01 & 0.01 & 0.00 & -0.02
& 0.00 & -0.01 & ... & 0.01 & -0.01 & 0.00 & 0.00 & 0.00 & -0.02 & -0.02
& 0.00 & -0.00 & 0.01 \\
2024-03-07 & -0.00 & -0.00 & -0.00 & -0.00 & -0.01 & -0.00 & 0.01 & 0.01
& -0.00 & 0.01 & ... & 0.00 & -0.00 & 0.01 & -0.01 & -0.01 & -0.03 &
-0.00 & -0.01 & -0.03 & -0.00 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2062-06-23 & -0.01 & 0.00 & 0.00 & 0.00 & 0.00 & 0.03 & -0.01 & 0.00 &
-0.00 & 0.01 & ... & -0.01 & -0.01 & 0.00 & 0.00 & -0.00 & -0.07 & 0.01
& 0.02 & -0.00 & -0.00 \\
2062-06-26 & -0.00 & 0.01 & -0.00 & 0.01 & 0.00 & -0.01 & 0.01 & 0.00 &
-0.00 & -0.00 & ... & 0.00 & -0.00 & -0.01 & -0.00 & -0.01 & 0.00 & 0.01
& 0.01 & 0.03 & -0.01 \\
2062-06-27 & -0.01 & -0.01 & 0.02 & -0.04 & 0.00 & 0.01 & 0.00 & 0.00 &
0.00 & 0.01 & ... & 0.00 & -0.00 & -0.01 & 0.01 & 0.00 & 0.01 & 0.01 &
0.01 & 0.00 & 0.01 \\
2062-06-28 & -0.01 & -0.01 & 0.00 & -0.00 & -0.01 & -0.00 & 0.04 & 0.00
& -0.00 & -0.00 & ... & 0.02 & -0.00 & -0.01 & -0.01 & -0.00 & 0.01 &
0.00 & 0.01 & -0.00 & -0.01 \\
2062-06-29 & -0.00 & 0.00 & -0.01 & 0.01 & -0.01 & 0.00 & -0.01 & -0.01
& -0.01 & 0.00 & ... & -0.00 & 0.01 & 0.01 & 0.01 & -0.00 & 0.00 & -0.01
& -0.02 & 0.01 & -0.01 \\
\end{longtable}

We compound daily returns \(R_t\) to find future wealth \(W_T\), so
\(W_T = W_0 \times (1 + R_1) \times (1 + R_2) \times \cdots \times (1 + R_T)\).
We use the \texttt{.cumprod()} method to compound the daily returns in
data frame \texttt{mkts}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{W\_0 }\OperatorTok{=} \DecValTok{1\_000\_000}
\NormalTok{W\_t }\OperatorTok{=}\NormalTok{ W\_0 }\OperatorTok{*}\NormalTok{ mkts.add(}\DecValTok{1}\NormalTok{).cumprod()}
\end{Highlighting}
\end{Shaded}

We visualize terminal wealth \(W_T\) with a cumulative distribution
plot.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{W\_t.iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}hist\textquotesingle{}}\NormalTok{, density}\OperatorTok{=}\VariableTok{True}\NormalTok{, cumulative}\OperatorTok{=}\VariableTok{True}\NormalTok{, bins}\OperatorTok{=}\DecValTok{100}\NormalTok{)}
\NormalTok{plt.semilogx()}
\NormalTok{plt.xlabel(}\VerbatimStringTok{r\textquotesingle{}$W\_T$ where $W\_0 = $\textquotesingle{}} \OperatorTok{+} \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}\textbackslash{}}\SpecialStringTok{$}\SpecialCharTok{\{}\NormalTok{W\_0}\SpecialCharTok{:,.0f\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\VerbatimStringTok{r\textquotesingle{}Cumulative Distribution of $W\_T$\textquotesingle{}} \OperatorTok{+} \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}n}\SpecialStringTok{after }\SpecialCharTok{\{}\NormalTok{W\_t}\SpecialCharTok{.}\NormalTok{shape[}\DecValTok{0}\NormalTok{]}\SpecialCharTok{:,.0f\}}\SpecialStringTok{ Trading Days\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_05_practice_03_files/figure-pdf/cell-15-output-1.png}

The plot above shows the cumulative distribution of \(W_T\), suggesting
we expect \(W_T\) greater than about 20 million dollars for about 75\%
of samples. The plot above may be difficult to read and interpret
because \(W_T\) has large outliers. The \texttt{.describe()} method
provides few salient values of \(W_T\). We convert \(W_T\) from dollars
to millions of dollars with \texttt{.div(1\_000\_000)}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{W\_t.iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].div(}\DecValTok{1\_000\_000}\NormalTok{).describe()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
count   100.00
mean     61.07
std      90.71
min       1.50
25%      18.12
50%      41.47
75%      66.93
max     669.23
Name: 2062-06-29 00:00:00, dtype: float64
\end{verbatim}

\subsection{\texorpdfstring{Repeat the exercise above but add
end-of-month investments
\(C_t\)}{Repeat the exercise above but add end-of-month investments C\_t}}\label{repeat-the-exercise-above-but-add-end-of-month-investments-c_t-1}

We can use the same data frame \texttt{mkts} of simulated market
returns. However, need to consider end-of-month investments of \(C_t\).
The easiest approach is to aggregate the daily market returns in
\texttt{mkts} to monthly market returns in data frame \texttt{mkts\_m}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mkts\_m }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    mkts}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .resample(rule}\OperatorTok{=}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{, kind}\OperatorTok{=}\StringTok{\textquotesingle{}period\textquotesingle{}}\NormalTok{)}
\NormalTok{    .prod()}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The wealth at time \(t\) is \(W_t\) and depends on:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The wealth at the end of the previous month \(W_{t-1}\)
\item
  The return over the previous month \(R_t\) (recall we label returns by
  their right edge)
\item
  The end-of-month investment \(C_t\)
\end{enumerate}

Putting it all togther: \(W_t = W_{t-1} \times (1 + R_t) + C_t\)

We have to loop over the monthly returns in \texttt{mkts\_m} because we
have to combine compounded returns and cash flows. The
\texttt{iterrows()} methods provides an easy way to iterate (loop) over
the rows in \texttt{mkts\_m}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{C\_t }\OperatorTok{=} \DecValTok{1\_000}
\NormalTok{W\_0 }\OperatorTok{=} \DecValTok{1\_000\_000}
\NormalTok{W\_last }\OperatorTok{=}\NormalTok{ W\_0}
\NormalTok{W\_t }\OperatorTok{=}\NormalTok{ []}

\ControlFlowTok{for}\NormalTok{ d, m }\KeywordTok{in}\NormalTok{ mkts\_m.iterrows():}
\NormalTok{    W\_last }\OperatorTok{=}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ m) }\OperatorTok{*}\NormalTok{ W\_last }\OperatorTok{+}\NormalTok{ C\_t}
\NormalTok{    W\_t.append(W\_last)}

\NormalTok{W\_t }\OperatorTok{=}\NormalTok{ pd.concat(objs}\OperatorTok{=}\NormalTok{W\_t, axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{mkts\_m.index).transpose()}
\end{Highlighting}
\end{Shaded}

We repeat the cumulative distribution of wealth plot and descriptive
statistics from above.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{W\_t.iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}hist\textquotesingle{}}\NormalTok{, density}\OperatorTok{=}\VariableTok{True}\NormalTok{, cumulative}\OperatorTok{=}\VariableTok{True}\NormalTok{, bins}\OperatorTok{=}\DecValTok{100}\NormalTok{)}
\NormalTok{plt.semilogx()}
\NormalTok{plt.xlabel(}
    \VerbatimStringTok{r\textquotesingle{}$W\_T$ where $W\_0 = $\textquotesingle{}} \OperatorTok{+} \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}\textbackslash{}}\SpecialStringTok{$}\SpecialCharTok{\{}\NormalTok{W\_0}\SpecialCharTok{:,.0f\}}\SpecialStringTok{\textquotesingle{}} \OperatorTok{+} 
    \VerbatimStringTok{r\textquotesingle{} and  $C\_t = $\textquotesingle{}} \OperatorTok{+} \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}\textbackslash{}}\SpecialStringTok{$}\SpecialCharTok{\{}\NormalTok{C\_t}\SpecialCharTok{:,.0f\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.title(}\VerbatimStringTok{r\textquotesingle{}Cumulative Distribution of $W\_T$\textquotesingle{}} \OperatorTok{+} \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}n}\SpecialStringTok{after }\SpecialCharTok{\{}\NormalTok{W\_t}\SpecialCharTok{.}\NormalTok{shape[}\DecValTok{0}\NormalTok{]}\SpecialCharTok{:,.0f\}}\SpecialStringTok{ Trading Months\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_05_practice_03_files/figure-pdf/cell-19-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{W\_t.iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].div(}\DecValTok{1\_000\_000}\NormalTok{).describe()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
count   100.00
mean     67.84
std      97.55
min       1.99
25%      21.21
50%      46.54
75%      75.92
max     713.85
Name: 2062-06, dtype: float64
\end{verbatim}

The plot above shows the cumulative distribution of \(W_T\), suggesting
we expect \(W_T\) greater than about 20 million dollars for about 75\%
of samples. Note, even though we deposit \$1,000 per month for almost 40
years, we do not gain much wealth over the previous example with only a
lump sum! Start saving early!

\chapter{Herron Topic 5 - Practice for Section
04}\label{herron-topic-5---practice-for-section-04}

\section{Practice}\label{practice-46}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ seaborn }\ImportTok{as}\NormalTok{ sns}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{2}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.2f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{\texorpdfstring{Estimate \(\pi\) by simulating darts thrown
at a dart
board}{Estimate \textbackslash pi by simulating darts thrown at a dart board}}\label{estimate-pi-by-simulating-darts-thrown-at-a-dart-board-2}

\emph{Hints:} Select random \(x\)s and \(y\)s such that
\(-r \leq x \leq +r\) and \(-r \leq x \leq +r\). Darts are on the board
if \(x^2 + y^2 \leq r^2\). The area of the circlular board is
\(\pi r^2\), and the area of square around the board is
\((2r)^2 = 4r^2\). The fraction \(f\) of darts on the board is the same
as the ratio of circle area to square area, so
\(f = \frac{\pi r^2}{4 r^2}\).

First we throw darts at the board. Darts with \(x^2 + y^2 \leq r^2\) are
on the board.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ throw\_darts(n}\OperatorTok{=}\DecValTok{10\_000}\NormalTok{, r}\OperatorTok{=}\DecValTok{1}\NormalTok{, seed}\OperatorTok{=}\DecValTok{42}\NormalTok{):}
\NormalTok{    np.random.seed(seed)}
    \ControlFlowTok{return}\NormalTok{ (}
\NormalTok{        pd.DataFrame(}
\NormalTok{            data}\OperatorTok{=}\NormalTok{np.random.uniform(low}\OperatorTok{={-}}\NormalTok{r, high}\OperatorTok{=}\NormalTok{r, size}\OperatorTok{=}\DecValTok{2}\OperatorTok{*}\NormalTok{n).reshape(n, }\DecValTok{2}\NormalTok{), }
\NormalTok{            columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}y\textquotesingle{}}\NormalTok{]}
\NormalTok{        )}
\NormalTok{        .assign(board}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}\OperatorTok{**}\DecValTok{2} \OperatorTok{+}\NormalTok{ x[}\StringTok{\textquotesingle{}y\textquotesingle{}}\NormalTok{]}\OperatorTok{**}\DecValTok{2} \OperatorTok{\textless{}=}\NormalTok{ r}\OperatorTok{**}\DecValTok{2}\NormalTok{)}
\NormalTok{        .rename\_axis(index}\OperatorTok{=}\StringTok{\textquotesingle{}n\textquotesingle{}}\NormalTok{, columns}\OperatorTok{=}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{)}
\NormalTok{    )}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{throw\_darts()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
Variable & x & y & board \\
n & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & -0.25 & 0.90 & True \\
1 & 0.46 & 0.20 & True \\
2 & -0.69 & -0.69 & True \\
3 & -0.88 & 0.73 & False \\
4 & 0.20 & 0.42 & True \\
... & ... & ... & ... \\
9995 & 0.15 & 0.52 & True \\
9996 & -0.82 & -0.01 & True \\
9997 & 0.80 & 0.75 & False \\
9998 & -0.91 & -0.39 & True \\
9999 & -0.11 & -0.66 & True \\
\end{longtable}

Next, we visualize these darts with a scatter plot. Seaborn's
\texttt{scatterplot()} helps color darts by location (i.e., on or off
board). The \texttt{.pipe()} method lets us send the output of the
\texttt{.assign()} method to \texttt{sns.scatterplot()} without
assigning a temporary data frame.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    throw\_darts()}
\NormalTok{    .assign(Location}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.where(x[}\StringTok{\textquotesingle{}board\textquotesingle{}}\NormalTok{], }\StringTok{\textquotesingle{}On Board\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Off Board\textquotesingle{}}\NormalTok{))}
\NormalTok{    .pipe(}\KeywordTok{lambda}\NormalTok{ x: sns.scatterplot(data}\OperatorTok{=}\NormalTok{x, x}\OperatorTok{=}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{, y}\OperatorTok{=}\StringTok{\textquotesingle{}y\textquotesingle{}}\NormalTok{, hue}\OperatorTok{=}\StringTok{\textquotesingle{}Location\textquotesingle{}}\NormalTok{))}
\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Simulated Dart Throws\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_05_practice_04_files/figure-pdf/cell-6-output-1.png}

Finally, we use the hint above to estimate \(\pi\). The hint above says
\(f = \frac{\pi r^2}{4 r^2}\), where \(f\) is the fraction of darts on
the board. Therefore, \(\pi = \frac{4fr^2}{r^2} = 4f\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{n }\OperatorTok{=} \DecValTok{10\_000}
\NormalTok{pi }\OperatorTok{=} \DecValTok{4} \OperatorTok{*}\NormalTok{ throw\_darts(n}\OperatorTok{=}\NormalTok{n)[}\StringTok{"board"}\NormalTok{].mean()}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}Estimate of pi based on }\SpecialCharTok{\{}\NormalTok{n}\SpecialCharTok{:,.0f\}}\SpecialStringTok{ darts: }\SpecialCharTok{\{}\NormalTok{pi}\SpecialCharTok{:0.4f\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Estimate of pi based on 10,000 darts: 3.1544
\end{verbatim}

We increase the precision of our \(\pi\) estimate by increasing the
number of simulated darts \(n\).

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ n }\KeywordTok{in} \DecValTok{10}\OperatorTok{**}\NormalTok{np.arange(}\DecValTok{7}\NormalTok{):}
\NormalTok{    pi }\OperatorTok{=} \DecValTok{4} \OperatorTok{*}\NormalTok{ throw\_darts(n}\OperatorTok{=}\NormalTok{n)[}\StringTok{"board"}\NormalTok{].mean()}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}Estimate of pi based on }\SpecialCharTok{\{}\NormalTok{n}\SpecialCharTok{:\textless{}9,.0f\}}\SpecialStringTok{ darts: }\SpecialCharTok{\{}\NormalTok{pi}\SpecialCharTok{:0.4f\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Estimate of pi based on 1         darts: 4.0000
Estimate of pi based on 10        darts: 3.2000
Estimate of pi based on 100       darts: 3.0400
Estimate of pi based on 1,000     darts: 3.1040
Estimate of pi based on 10,000    darts: 3.1544
Estimate of pi based on 100,000   darts: 3.1468
Estimate of pi based on 1,000,000 darts: 3.1420
\end{verbatim}

\subsection{\texorpdfstring{Simulate your wealth \(W_T\) by randomly
sampling market
returns}{Simulate your wealth W\_T by randomly sampling market returns}}\label{simulate-your-wealth-w_t-by-randomly-sampling-market-returns-2}

Use monthly market returns from the French Data Library. Only invest one
cash flow \(W_0\), and plot the distribution of \(W_T\).

First, we download data from the French Data Library. We convert these
returns from percent to decimal to simplify compounding.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mkt }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pdr.DataReader(}
\NormalTok{        name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{        data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{        start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{    )[}\DecValTok{0}\NormalTok{]}
\NormalTok{    .assign(mkt}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: (x[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ x[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{]) }\OperatorTok{/} \DecValTok{100}\NormalTok{)}
\NormalTok{    [}\StringTok{\textquotesingle{}mkt\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_13960\526361920.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

Next, we write a couple of helper functions. The \texttt{get\_sample()}
function draws one random sample of \texttt{n} observations from returns
series \texttt{x}. This sample provides one simulated return history.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pd.date\_range}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
<function pandas.core.indexes.datetimes.date_range(start=None, end=None, periods=None, freq=None, tz=None, normalize: 'bool' = False, name: 'Hashable | None' = None, inclusive: 'IntervalClosedType' = 'both', *, unit: 'str | None' = None, **kwargs) -> 'DatetimeIndex'>
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ get\_sample(x, n}\OperatorTok{=}\DecValTok{10\_000}\NormalTok{, seed}\OperatorTok{=}\DecValTok{42}\NormalTok{, start}\OperatorTok{=}\VariableTok{None}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ start }\KeywordTok{is} \VariableTok{None}\NormalTok{:}
\NormalTok{        start }\OperatorTok{=}\NormalTok{ x.index[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{+}\NormalTok{ pd.offsets.BDay()}
    \ControlFlowTok{return}\NormalTok{ (}
\NormalTok{        x}
\NormalTok{        .sample(n}\OperatorTok{=}\NormalTok{n, replace}\OperatorTok{=}\VariableTok{True}\NormalTok{, random\_state}\OperatorTok{=}\NormalTok{seed, ignore\_index}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{        .set\_axis(pd.date\_range(start}\OperatorTok{=}\NormalTok{start, periods}\OperatorTok{=}\NormalTok{n, freq}\OperatorTok{=}\StringTok{\textquotesingle{}B\textquotesingle{}}\NormalTok{))}
\NormalTok{        .rename\_axis(index}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{)}
\NormalTok{    )    }
\end{Highlighting}
\end{Shaded}

The \texttt{get\_samples()} function calls the \texttt{get\_sample()}
function \texttt{m} times to simulate \texttt{m} return histories. The
\texttt{get\_samples()} function combines these \texttt{m} return
histories into one data frame.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ get\_samples(x, m}\OperatorTok{=}\DecValTok{100}\NormalTok{, n}\OperatorTok{=}\DecValTok{10\_000}\NormalTok{, seed}\OperatorTok{=}\DecValTok{42}\NormalTok{, start}\OperatorTok{=}\VariableTok{None}\NormalTok{):}
    \ControlFlowTok{return}\NormalTok{ (}
\NormalTok{        pd.concat(}
\NormalTok{            objs}\OperatorTok{=}\NormalTok{[get\_sample(x}\OperatorTok{=}\NormalTok{x, n}\OperatorTok{=}\NormalTok{n, seed}\OperatorTok{=}\NormalTok{seed}\OperatorTok{+}\NormalTok{i, start}\OperatorTok{=}\NormalTok{start) }\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(m)],}
\NormalTok{            axis}\OperatorTok{=}\DecValTok{1}\NormalTok{,}
\NormalTok{            keys}\OperatorTok{=}\BuiltInTok{range}\NormalTok{(m),}
\NormalTok{            names}\OperatorTok{=}\StringTok{\textquotesingle{}Sample\textquotesingle{}}
\NormalTok{        )}
\NormalTok{    )}
\end{Highlighting}
\end{Shaded}

Next, we use these helper functions to simulate 100 return histories of
10,000 trading days each.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mkts }\OperatorTok{=}\NormalTok{ get\_samples(x}\OperatorTok{=}\NormalTok{mkt, m}\OperatorTok{=}\DecValTok{100}\NormalTok{, n}\OperatorTok{=}\DecValTok{10\_000}\NormalTok{)}
\NormalTok{mkts}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
Sample & 0 & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & ... & 90 & 91 & 92 & 93
& 94 & 95 & 96 & 97 & 98 & 99 \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-03-01 & 0.00 & 0.01 & 0.00 & 0.00 & 0.00 & 0.00 & -0.00 & 0.00 &
-0.01 & 0.00 & ... & 0.01 & 0.01 & 0.00 & 0.01 & 0.00 & 0.00 & -0.00 &
-0.01 & -0.01 & 0.00 \\
2024-03-04 & 0.01 & -0.00 & 0.00 & 0.01 & 0.00 & -0.01 & -0.01 & 0.01 &
0.00 & -0.01 & ... & -0.00 & 0.00 & 0.01 & -0.02 & 0.00 & 0.01 & 0.01 &
0.01 & -0.01 & -0.01 \\
2024-03-05 & -0.03 & -0.00 & -0.01 & -0.03 & -0.00 & 0.02 & -0.00 & 0.00
& -0.01 & -0.01 & ... & 0.00 & -0.00 & 0.01 & -0.02 & -0.01 & 0.01 &
-0.00 & 0.00 & -0.00 & 0.01 \\
2024-03-06 & -0.00 & -0.00 & -0.01 & -0.00 & 0.01 & 0.01 & 0.00 & -0.02
& 0.00 & -0.01 & ... & 0.01 & -0.01 & 0.00 & 0.00 & 0.00 & -0.02 & -0.02
& 0.00 & -0.00 & 0.01 \\
2024-03-07 & -0.00 & -0.00 & -0.00 & -0.00 & -0.01 & -0.00 & 0.01 & 0.01
& -0.00 & 0.01 & ... & 0.00 & -0.00 & 0.01 & -0.01 & -0.01 & -0.03 &
-0.00 & -0.01 & -0.03 & -0.00 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2062-06-23 & -0.01 & 0.00 & 0.00 & 0.00 & 0.00 & 0.03 & -0.01 & 0.00 &
-0.00 & 0.01 & ... & -0.01 & -0.01 & 0.00 & 0.00 & -0.00 & -0.07 & 0.01
& 0.02 & -0.00 & -0.00 \\
2062-06-26 & -0.00 & 0.01 & -0.00 & 0.01 & 0.00 & -0.01 & 0.01 & 0.00 &
-0.00 & -0.00 & ... & 0.00 & -0.00 & -0.01 & -0.00 & -0.01 & 0.00 & 0.01
& 0.01 & 0.03 & -0.01 \\
2062-06-27 & -0.01 & -0.01 & 0.02 & -0.04 & 0.00 & 0.01 & 0.00 & 0.00 &
0.00 & 0.01 & ... & 0.00 & -0.00 & -0.01 & 0.01 & 0.00 & 0.01 & 0.01 &
0.01 & 0.00 & 0.01 \\
2062-06-28 & -0.01 & -0.01 & 0.00 & -0.00 & -0.01 & -0.00 & 0.04 & 0.00
& -0.00 & -0.00 & ... & 0.02 & -0.00 & -0.01 & -0.01 & -0.00 & 0.01 &
0.00 & 0.01 & -0.00 & -0.01 \\
2062-06-29 & -0.00 & 0.00 & -0.01 & 0.01 & -0.01 & 0.00 & -0.01 & -0.01
& -0.01 & 0.00 & ... & -0.00 & 0.01 & 0.01 & 0.01 & -0.00 & 0.00 & -0.01
& -0.02 & 0.01 & -0.01 \\
\end{longtable}

We compound daily returns \(R_t\) to find future wealth \(W_T\), so
\(W_T = W_0 \times (1 + R_1) \times (1 + R_2) \times \cdots \times (1 + R_T)\).
We use the \texttt{.cumprod()} method to compound the daily returns in
data frame \texttt{mkts}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{W\_0 }\OperatorTok{=} \DecValTok{1\_000\_000}
\NormalTok{W\_t }\OperatorTok{=}\NormalTok{ W\_0 }\OperatorTok{*}\NormalTok{ mkts.add(}\DecValTok{1}\NormalTok{).cumprod()}
\end{Highlighting}
\end{Shaded}

We visualize terminal wealth \(W_T\) with a cumulative distribution
plot.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{W\_t.iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}hist\textquotesingle{}}\NormalTok{, density}\OperatorTok{=}\VariableTok{True}\NormalTok{, cumulative}\OperatorTok{=}\VariableTok{True}\NormalTok{, bins}\OperatorTok{=}\DecValTok{100}\NormalTok{)}
\NormalTok{plt.semilogx()}
\NormalTok{plt.xlabel(}\VerbatimStringTok{r\textquotesingle{}$W\_T$ where $W\_0 = $\textquotesingle{}} \OperatorTok{+} \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}\textbackslash{}}\SpecialStringTok{$}\SpecialCharTok{\{}\NormalTok{W\_0}\SpecialCharTok{:,.0f\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\VerbatimStringTok{r\textquotesingle{}Cumulative Distribution of $W\_T$\textquotesingle{}} \OperatorTok{+} \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}n}\SpecialStringTok{after }\SpecialCharTok{\{}\NormalTok{W\_t}\SpecialCharTok{.}\NormalTok{shape[}\DecValTok{0}\NormalTok{]}\SpecialCharTok{:,.0f\}}\SpecialStringTok{ Trading Days\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_05_practice_04_files/figure-pdf/cell-15-output-1.png}

The plot above shows the cumulative distribution of \(W_T\), suggesting
we expect \(W_T\) greater than about 20 million dollars for about 75\%
of samples. The plot above may be difficult to read and interpret
because \(W_T\) has large outliers. The \texttt{.describe()} method
provides few salient values of \(W_T\). We convert \(W_T\) from dollars
to millions of dollars with \texttt{.div(1\_000\_000)}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{W\_t.iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].div(}\DecValTok{1\_000\_000}\NormalTok{).describe()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
count   100.00
mean     61.07
std      90.71
min       1.50
25%      18.12
50%      41.47
75%      66.93
max     669.23
Name: 2062-06-29 00:00:00, dtype: float64
\end{verbatim}

\subsection{\texorpdfstring{Repeat the exercise above but add
end-of-month investments
\(C_t\)}{Repeat the exercise above but add end-of-month investments C\_t}}\label{repeat-the-exercise-above-but-add-end-of-month-investments-c_t-2}

We can use the same data frame \texttt{mkts} of simulated market
returns. However, need to consider end-of-month investments of \(C_t\).
The easiest approach is to aggregate the daily market returns in
\texttt{mkts} to monthly market returns in data frame \texttt{mkts\_m}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mkts\_m }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    mkts}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .resample(rule}\OperatorTok{=}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{, kind}\OperatorTok{=}\StringTok{\textquotesingle{}period\textquotesingle{}}\NormalTok{)}
\NormalTok{    .prod()}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The wealth at time \(t\) is \(W_t\) and depends on:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The wealth at the end of the previous month \(W_{t-1}\)
\item
  The return over the previous month \(R_t\) (recall we label returns by
  their right edge)
\item
  The end-of-month investment \(C_t\)
\end{enumerate}

Putting it all togther: \(W_t = W_{t-1} \times (1 + R_t) + C_t\)

We have to loop over the monthly returns in \texttt{mkts\_m} because we
have to combine compounded returns and cash flows. The
\texttt{iterrows()} methods provides an easy way to iterate (loop) over
the rows in \texttt{mkts\_m}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{C\_t }\OperatorTok{=} \DecValTok{1\_000}
\NormalTok{W\_0 }\OperatorTok{=} \DecValTok{1\_000\_000}
\NormalTok{W\_last }\OperatorTok{=}\NormalTok{ W\_0}
\NormalTok{W\_t }\OperatorTok{=}\NormalTok{ []}

\ControlFlowTok{for}\NormalTok{ d, m }\KeywordTok{in}\NormalTok{ mkts\_m.iterrows():}
\NormalTok{    W\_last }\OperatorTok{=}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ m) }\OperatorTok{*}\NormalTok{ W\_last }\OperatorTok{+}\NormalTok{ C\_t}
\NormalTok{    W\_t.append(W\_last)}

\NormalTok{W\_t }\OperatorTok{=}\NormalTok{ pd.concat(objs}\OperatorTok{=}\NormalTok{W\_t, axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{mkts\_m.index).transpose()}
\end{Highlighting}
\end{Shaded}

We repeat the cumulative distribution of wealth plot and descriptive
statistics from above.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{W\_t.iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}hist\textquotesingle{}}\NormalTok{, density}\OperatorTok{=}\VariableTok{True}\NormalTok{, cumulative}\OperatorTok{=}\VariableTok{True}\NormalTok{, bins}\OperatorTok{=}\DecValTok{100}\NormalTok{)}
\NormalTok{plt.semilogx()}
\NormalTok{plt.xlabel(}
    \VerbatimStringTok{r\textquotesingle{}$W\_T$ where $W\_0 = $\textquotesingle{}} \OperatorTok{+} \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}\textbackslash{}}\SpecialStringTok{$}\SpecialCharTok{\{}\NormalTok{W\_0}\SpecialCharTok{:,.0f\}}\SpecialStringTok{\textquotesingle{}} \OperatorTok{+} 
    \VerbatimStringTok{r\textquotesingle{} and  $C\_t = $\textquotesingle{}} \OperatorTok{+} \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}\textbackslash{}}\SpecialStringTok{$}\SpecialCharTok{\{}\NormalTok{C\_t}\SpecialCharTok{:,.0f\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.title(}\VerbatimStringTok{r\textquotesingle{}Cumulative Distribution of $W\_T$\textquotesingle{}} \OperatorTok{+} \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}n}\SpecialStringTok{after }\SpecialCharTok{\{}\NormalTok{W\_t}\SpecialCharTok{.}\NormalTok{shape[}\DecValTok{0}\NormalTok{]}\SpecialCharTok{:,.0f\}}\SpecialStringTok{ Trading Months\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_05_practice_04_files/figure-pdf/cell-19-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{W\_t.iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].div(}\DecValTok{1\_000\_000}\NormalTok{).describe()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
count   100.00
mean     67.84
std      97.55
min       1.99
25%      21.21
50%      46.54
75%      75.92
max     713.85
Name: 2062-06, dtype: float64
\end{verbatim}

The plot above shows the cumulative distribution of \(W_T\), suggesting
we expect \(W_T\) greater than about 20 million dollars for about 75\%
of samples. Note, even though we deposit \$1,000 per month for almost 40
years, we do not gain much wealth over the previous example with only a
lump sum! Start saving early!

\chapter{Herron Topic 5 - Practice for Section
05}\label{herron-topic-5---practice-for-section-05}

\section{Practice}\label{practice-47}

\begin{Shaded}
\begin{Highlighting}[]
\ImportTok{import}\NormalTok{ matplotlib.pyplot }\ImportTok{as}\NormalTok{ plt}
\ImportTok{import}\NormalTok{ numpy }\ImportTok{as}\NormalTok{ np}
\ImportTok{import}\NormalTok{ pandas }\ImportTok{as}\NormalTok{ pd}
\ImportTok{import}\NormalTok{ pandas\_datareader }\ImportTok{as}\NormalTok{ pdr}
\ImportTok{import}\NormalTok{ seaborn }\ImportTok{as}\NormalTok{ sns}
\ImportTok{import}\NormalTok{ yfinance }\ImportTok{as}\NormalTok{ yf}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\OperatorTok{\%}\NormalTok{precision }\DecValTok{2}
\NormalTok{pd.options.display.float\_format }\OperatorTok{=} \StringTok{\textquotesingle{}}\SpecialCharTok{\{:.2f\}}\StringTok{\textquotesingle{}}\NormalTok{.}\BuiltInTok{format}
\OperatorTok{\%}\NormalTok{config InlineBackend.figure\_format }\OperatorTok{=} \StringTok{\textquotesingle{}retina\textquotesingle{}}
\end{Highlighting}
\end{Shaded}

\subsection{\texorpdfstring{Estimate \(\pi\) by simulating darts thrown
at a dart
board}{Estimate \textbackslash pi by simulating darts thrown at a dart board}}\label{estimate-pi-by-simulating-darts-thrown-at-a-dart-board-3}

\emph{Hints:} Select random \(x\)s and \(y\)s such that
\(-r \leq x \leq +r\) and \(-r \leq x \leq +r\). Darts are on the board
if \(x^2 + y^2 \leq r^2\). The area of the circlular board is
\(\pi r^2\), and the area of square around the board is
\((2r)^2 = 4r^2\). The fraction \(f\) of darts on the board is the same
as the ratio of circle area to square area, so
\(f = \frac{\pi r^2}{4 r^2}\).

First we throw darts at the board. Darts with \(x^2 + y^2 \leq r^2\) are
on the board.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ throw\_darts(n}\OperatorTok{=}\DecValTok{10\_000}\NormalTok{, r}\OperatorTok{=}\DecValTok{1}\NormalTok{, seed}\OperatorTok{=}\DecValTok{42}\NormalTok{):}
\NormalTok{    np.random.seed(seed)}
    \ControlFlowTok{return}\NormalTok{ (}
\NormalTok{        pd.DataFrame(}
\NormalTok{            data}\OperatorTok{=}\NormalTok{np.random.uniform(low}\OperatorTok{={-}}\NormalTok{r, high}\OperatorTok{=}\NormalTok{r, size}\OperatorTok{=}\DecValTok{2}\OperatorTok{*}\NormalTok{n).reshape(n, }\DecValTok{2}\NormalTok{), }
\NormalTok{            columns}\OperatorTok{=}\NormalTok{[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}y\textquotesingle{}}\NormalTok{]}
\NormalTok{        )}
\NormalTok{        .assign(board}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: x[}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{]}\OperatorTok{**}\DecValTok{2} \OperatorTok{+}\NormalTok{ x[}\StringTok{\textquotesingle{}y\textquotesingle{}}\NormalTok{]}\OperatorTok{**}\DecValTok{2} \OperatorTok{\textless{}=}\NormalTok{ r}\OperatorTok{**}\DecValTok{2}\NormalTok{)}
\NormalTok{        .rename\_axis(index}\OperatorTok{=}\StringTok{\textquotesingle{}n\textquotesingle{}}\NormalTok{, columns}\OperatorTok{=}\StringTok{\textquotesingle{}Variable\textquotesingle{}}\NormalTok{)}
\NormalTok{    )}
\end{Highlighting}
\end{Shaded}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{throw\_darts()}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llll@{}}
\toprule\noalign{}
Variable & x & y & board \\
n & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
0 & -0.25 & 0.90 & True \\
1 & 0.46 & 0.20 & True \\
2 & -0.69 & -0.69 & True \\
3 & -0.88 & 0.73 & False \\
4 & 0.20 & 0.42 & True \\
... & ... & ... & ... \\
9995 & 0.15 & 0.52 & True \\
9996 & -0.82 & -0.01 & True \\
9997 & 0.80 & 0.75 & False \\
9998 & -0.91 & -0.39 & True \\
9999 & -0.11 & -0.66 & True \\
\end{longtable}

Next, we visualize these darts with a scatter plot. Seaborn's
\texttt{scatterplot()} helps color darts by location (i.e., on or off
board). The \texttt{.pipe()} method lets us send the output of the
\texttt{.assign()} method to \texttt{sns.scatterplot()} without
assigning a temporary data frame.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{(}
\NormalTok{    throw\_darts()}
\NormalTok{    .assign(Location}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: np.where(x[}\StringTok{\textquotesingle{}board\textquotesingle{}}\NormalTok{], }\StringTok{\textquotesingle{}On Board\textquotesingle{}}\NormalTok{, }\StringTok{\textquotesingle{}Off Board\textquotesingle{}}\NormalTok{))}
\NormalTok{    .pipe(}\KeywordTok{lambda}\NormalTok{ x: sns.scatterplot(data}\OperatorTok{=}\NormalTok{x, x}\OperatorTok{=}\StringTok{\textquotesingle{}x\textquotesingle{}}\NormalTok{, y}\OperatorTok{=}\StringTok{\textquotesingle{}y\textquotesingle{}}\NormalTok{, hue}\OperatorTok{=}\StringTok{\textquotesingle{}Location\textquotesingle{}}\NormalTok{))}
\NormalTok{)}
\NormalTok{plt.title(}\StringTok{\textquotesingle{}Simulated Dart Throws\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_05_practice_05_files/figure-pdf/cell-6-output-1.png}

Finally, we use the hint above to estimate \(\pi\). The hint above says
\(f = \frac{\pi r^2}{4 r^2}\), where \(f\) is the fraction of darts on
the board. Therefore, \(\pi = \frac{4fr^2}{r^2} = 4f\).

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{n }\OperatorTok{=} \DecValTok{10\_000}
\NormalTok{pi }\OperatorTok{=} \DecValTok{4} \OperatorTok{*}\NormalTok{ throw\_darts(n}\OperatorTok{=}\NormalTok{n)[}\StringTok{"board"}\NormalTok{].mean()}
\BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}Estimate of pi based on }\SpecialCharTok{\{}\NormalTok{n}\SpecialCharTok{:,.0f\}}\SpecialStringTok{ darts: }\SpecialCharTok{\{}\NormalTok{pi}\SpecialCharTok{:0.4f\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Estimate of pi based on 10,000 darts: 3.1544
\end{verbatim}

We increase the precision of our \(\pi\) estimate by increasing the
number of simulated darts \(n\).

\begin{Shaded}
\begin{Highlighting}[]
\ControlFlowTok{for}\NormalTok{ n }\KeywordTok{in} \DecValTok{10}\OperatorTok{**}\NormalTok{np.arange(}\DecValTok{7}\NormalTok{):}
\NormalTok{    pi }\OperatorTok{=} \DecValTok{4} \OperatorTok{*}\NormalTok{ throw\_darts(n}\OperatorTok{=}\NormalTok{n)[}\StringTok{"board"}\NormalTok{].mean()}
    \BuiltInTok{print}\NormalTok{(}\SpecialStringTok{f\textquotesingle{}Estimate of pi based on }\SpecialCharTok{\{}\NormalTok{n}\SpecialCharTok{:\textless{}9,.0f\}}\SpecialStringTok{ darts: }\SpecialCharTok{\{}\NormalTok{pi}\SpecialCharTok{:0.4f\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
Estimate of pi based on 1         darts: 4.0000
Estimate of pi based on 10        darts: 3.2000
Estimate of pi based on 100       darts: 3.0400
Estimate of pi based on 1,000     darts: 3.1040
Estimate of pi based on 10,000    darts: 3.1544
Estimate of pi based on 100,000   darts: 3.1468
Estimate of pi based on 1,000,000 darts: 3.1420
\end{verbatim}

\subsection{\texorpdfstring{Simulate your wealth \(W_T\) by randomly
sampling market
returns}{Simulate your wealth W\_T by randomly sampling market returns}}\label{simulate-your-wealth-w_t-by-randomly-sampling-market-returns-3}

Use monthly market returns from the French Data Library. Only invest one
cash flow \(W_0\), and plot the distribution of \(W_T\).

First, we download data from the French Data Library. We convert these
returns from percent to decimal to simplify compounding.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mkt }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    pdr.DataReader(}
\NormalTok{        name}\OperatorTok{=}\StringTok{\textquotesingle{}F{-}F\_Research\_Data\_Factors\_daily\textquotesingle{}}\NormalTok{,}
\NormalTok{        data\_source}\OperatorTok{=}\StringTok{\textquotesingle{}famafrench\textquotesingle{}}\NormalTok{,}
\NormalTok{        start}\OperatorTok{=}\StringTok{\textquotesingle{}1900\textquotesingle{}}
\NormalTok{    )[}\DecValTok{0}\NormalTok{]}
\NormalTok{    .assign(mkt}\OperatorTok{=}\KeywordTok{lambda}\NormalTok{ x: (x[}\StringTok{\textquotesingle{}Mkt{-}RF\textquotesingle{}}\NormalTok{] }\OperatorTok{+}\NormalTok{ x[}\StringTok{\textquotesingle{}RF\textquotesingle{}}\NormalTok{]) }\OperatorTok{/} \DecValTok{100}\NormalTok{)}
\NormalTok{    [}\StringTok{\textquotesingle{}mkt\textquotesingle{}}\NormalTok{]}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
C:\Users\r.herron\AppData\Local\Temp\ipykernel_2100\526361920.py:2: FutureWarning: The argument 'date_parser' is deprecated and will be removed in a future version. Please use 'date_format' instead, or read your data in as 'object' dtype and then call 'to_datetime'.
  pdr.DataReader(
\end{verbatim}

Next, we write a couple of helper functions. The \texttt{get\_sample()}
function draws one random sample of \texttt{n} observations from returns
series \texttt{x}. This sample provides one simulated return history.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{pd.date\_range}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
<function pandas.core.indexes.datetimes.date_range(start=None, end=None, periods=None, freq=None, tz=None, normalize: 'bool' = False, name: 'Hashable | None' = None, inclusive: 'IntervalClosedType' = 'both', *, unit: 'str | None' = None, **kwargs) -> 'DatetimeIndex'>
\end{verbatim}

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ get\_sample(x, n}\OperatorTok{=}\DecValTok{10\_000}\NormalTok{, seed}\OperatorTok{=}\DecValTok{42}\NormalTok{, start}\OperatorTok{=}\VariableTok{None}\NormalTok{):}
    \ControlFlowTok{if}\NormalTok{ start }\KeywordTok{is} \VariableTok{None}\NormalTok{:}
\NormalTok{        start }\OperatorTok{=}\NormalTok{ x.index[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{] }\OperatorTok{+}\NormalTok{ pd.offsets.BDay()}
    \ControlFlowTok{return}\NormalTok{ (}
\NormalTok{        x}
\NormalTok{        .sample(n}\OperatorTok{=}\NormalTok{n, replace}\OperatorTok{=}\VariableTok{True}\NormalTok{, random\_state}\OperatorTok{=}\NormalTok{seed, ignore\_index}\OperatorTok{=}\VariableTok{True}\NormalTok{)}
\NormalTok{        .set\_axis(pd.date\_range(start}\OperatorTok{=}\NormalTok{start, periods}\OperatorTok{=}\NormalTok{n, freq}\OperatorTok{=}\StringTok{\textquotesingle{}B\textquotesingle{}}\NormalTok{))}
\NormalTok{        .rename\_axis(index}\OperatorTok{=}\StringTok{\textquotesingle{}Date\textquotesingle{}}\NormalTok{)}
\NormalTok{    )    }
\end{Highlighting}
\end{Shaded}

The \texttt{get\_samples()} function calls the \texttt{get\_sample()}
function \texttt{m} times to simulate \texttt{m} return histories. The
\texttt{get\_samples()} function combines these \texttt{m} return
histories into one data frame.

\begin{Shaded}
\begin{Highlighting}[]
\KeywordTok{def}\NormalTok{ get\_samples(x, m}\OperatorTok{=}\DecValTok{100}\NormalTok{, n}\OperatorTok{=}\DecValTok{10\_000}\NormalTok{, seed}\OperatorTok{=}\DecValTok{42}\NormalTok{, start}\OperatorTok{=}\VariableTok{None}\NormalTok{):}
    \ControlFlowTok{return}\NormalTok{ (}
\NormalTok{        pd.concat(}
\NormalTok{            objs}\OperatorTok{=}\NormalTok{[get\_sample(x}\OperatorTok{=}\NormalTok{x, n}\OperatorTok{=}\NormalTok{n, seed}\OperatorTok{=}\NormalTok{seed}\OperatorTok{+}\NormalTok{i, start}\OperatorTok{=}\NormalTok{start) }\ControlFlowTok{for}\NormalTok{ i }\KeywordTok{in} \BuiltInTok{range}\NormalTok{(m)],}
\NormalTok{            axis}\OperatorTok{=}\DecValTok{1}\NormalTok{,}
\NormalTok{            keys}\OperatorTok{=}\BuiltInTok{range}\NormalTok{(m),}
\NormalTok{            names}\OperatorTok{=}\StringTok{\textquotesingle{}Sample\textquotesingle{}}
\NormalTok{        )}
\NormalTok{    )}
\end{Highlighting}
\end{Shaded}

Next, we use these helper functions to simulate 100 return histories of
10,000 trading days each.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mkts }\OperatorTok{=}\NormalTok{ get\_samples(x}\OperatorTok{=}\NormalTok{mkt, m}\OperatorTok{=}\DecValTok{100}\NormalTok{, n}\OperatorTok{=}\DecValTok{10\_000}\NormalTok{)}
\NormalTok{mkts}
\end{Highlighting}
\end{Shaded}

\begin{longtable}[]{@{}llllllllllllllllllllll@{}}
\toprule\noalign{}
Sample & 0 & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 & 9 & ... & 90 & 91 & 92 & 93
& 94 & 95 & 96 & 97 & 98 & 99 \\
Date & & & & & & & & & & & & & & & & & & & & & \\
\midrule\noalign{}
\endhead
\bottomrule\noalign{}
\endlastfoot
2024-03-01 & 0.00 & 0.01 & 0.00 & 0.00 & 0.00 & 0.00 & -0.00 & 0.00 &
-0.01 & 0.00 & ... & 0.01 & 0.01 & 0.00 & 0.01 & 0.00 & 0.00 & -0.00 &
-0.01 & -0.01 & 0.00 \\
2024-03-04 & 0.01 & -0.00 & 0.00 & 0.01 & 0.00 & -0.01 & -0.01 & 0.01 &
0.00 & -0.01 & ... & -0.00 & 0.00 & 0.01 & -0.02 & 0.00 & 0.01 & 0.01 &
0.01 & -0.01 & -0.01 \\
2024-03-05 & -0.03 & -0.00 & -0.01 & -0.03 & -0.00 & 0.02 & -0.00 & 0.00
& -0.01 & -0.01 & ... & 0.00 & -0.00 & 0.01 & -0.02 & -0.01 & 0.01 &
-0.00 & 0.00 & -0.00 & 0.01 \\
2024-03-06 & -0.00 & -0.00 & -0.01 & -0.00 & 0.01 & 0.01 & 0.00 & -0.02
& 0.00 & -0.01 & ... & 0.01 & -0.01 & 0.00 & 0.00 & 0.00 & -0.02 & -0.02
& 0.00 & -0.00 & 0.01 \\
2024-03-07 & -0.00 & -0.00 & -0.00 & -0.00 & -0.01 & -0.00 & 0.01 & 0.01
& -0.00 & 0.01 & ... & 0.00 & -0.00 & 0.01 & -0.01 & -0.01 & -0.03 &
-0.00 & -0.01 & -0.03 & -0.00 \\
... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... & ... &
... & ... & ... & ... & ... & ... & ... & ... & ... & ... \\
2062-06-23 & -0.01 & 0.00 & 0.00 & 0.00 & 0.00 & 0.03 & -0.01 & 0.00 &
-0.00 & 0.01 & ... & -0.01 & -0.01 & 0.00 & 0.00 & -0.00 & -0.07 & 0.01
& 0.02 & -0.00 & -0.00 \\
2062-06-26 & -0.00 & 0.01 & -0.00 & 0.01 & 0.00 & -0.01 & 0.01 & 0.00 &
-0.00 & -0.00 & ... & 0.00 & -0.00 & -0.01 & -0.00 & -0.01 & 0.00 & 0.01
& 0.01 & 0.03 & -0.01 \\
2062-06-27 & -0.01 & -0.01 & 0.02 & -0.04 & 0.00 & 0.01 & 0.00 & 0.00 &
0.00 & 0.01 & ... & 0.00 & -0.00 & -0.01 & 0.01 & 0.00 & 0.01 & 0.01 &
0.01 & 0.00 & 0.01 \\
2062-06-28 & -0.01 & -0.01 & 0.00 & -0.00 & -0.01 & -0.00 & 0.04 & 0.00
& -0.00 & -0.00 & ... & 0.02 & -0.00 & -0.01 & -0.01 & -0.00 & 0.01 &
0.00 & 0.01 & -0.00 & -0.01 \\
2062-06-29 & -0.00 & 0.00 & -0.01 & 0.01 & -0.01 & 0.00 & -0.01 & -0.01
& -0.01 & 0.00 & ... & -0.00 & 0.01 & 0.01 & 0.01 & -0.00 & 0.00 & -0.01
& -0.02 & 0.01 & -0.01 \\
\end{longtable}

We compound daily returns \(R_t\) to find future wealth \(W_T\), so
\(W_T = W_0 \times (1 + R_1) \times (1 + R_2) \times \cdots \times (1 + R_T)\).
We use the \texttt{.cumprod()} method to compound the daily returns in
data frame \texttt{mkts}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{W\_0 }\OperatorTok{=} \DecValTok{1\_000\_000}
\NormalTok{W\_t }\OperatorTok{=}\NormalTok{ W\_0 }\OperatorTok{*}\NormalTok{ mkts.add(}\DecValTok{1}\NormalTok{).cumprod()}
\end{Highlighting}
\end{Shaded}

We visualize terminal wealth \(W_T\) with a cumulative distribution
plot.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{W\_t.iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}hist\textquotesingle{}}\NormalTok{, density}\OperatorTok{=}\VariableTok{True}\NormalTok{, cumulative}\OperatorTok{=}\VariableTok{True}\NormalTok{, bins}\OperatorTok{=}\DecValTok{100}\NormalTok{)}
\NormalTok{plt.semilogx()}
\NormalTok{plt.xlabel(}\VerbatimStringTok{r\textquotesingle{}$W\_T$ where $W\_0 = $\textquotesingle{}} \OperatorTok{+} \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}\textbackslash{}}\SpecialStringTok{$}\SpecialCharTok{\{}\NormalTok{W\_0}\SpecialCharTok{:,.0f\}}\SpecialStringTok{\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.title(}\VerbatimStringTok{r\textquotesingle{}Cumulative Distribution of $W\_T$\textquotesingle{}} \OperatorTok{+} \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}n}\SpecialStringTok{after }\SpecialCharTok{\{}\NormalTok{W\_t}\SpecialCharTok{.}\NormalTok{shape[}\DecValTok{0}\NormalTok{]}\SpecialCharTok{:,.0f\}}\SpecialStringTok{ Trading Days\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_05_practice_05_files/figure-pdf/cell-15-output-1.png}

The plot above shows the cumulative distribution of \(W_T\), suggesting
we expect \(W_T\) greater than about 20 million dollars for about 75\%
of samples. The plot above may be difficult to read and interpret
because \(W_T\) has large outliers. The \texttt{.describe()} method
provides few salient values of \(W_T\). We convert \(W_T\) from dollars
to millions of dollars with \texttt{.div(1\_000\_000)}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{W\_t.iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].div(}\DecValTok{1\_000\_000}\NormalTok{).describe()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
count   100.00
mean     61.07
std      90.71
min       1.50
25%      18.12
50%      41.47
75%      66.93
max     669.23
Name: 2062-06-29 00:00:00, dtype: float64
\end{verbatim}

\subsection{\texorpdfstring{Repeat the exercise above but add
end-of-month investments
\(C_t\)}{Repeat the exercise above but add end-of-month investments C\_t}}\label{repeat-the-exercise-above-but-add-end-of-month-investments-c_t-3}

We can use the same data frame \texttt{mkts} of simulated market
returns. However, need to consider end-of-month investments of \(C_t\).
The easiest approach is to aggregate the daily market returns in
\texttt{mkts} to monthly market returns in data frame \texttt{mkts\_m}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{mkts\_m }\OperatorTok{=}\NormalTok{ (}
\NormalTok{    mkts}
\NormalTok{    .add(}\DecValTok{1}\NormalTok{)}
\NormalTok{    .resample(rule}\OperatorTok{=}\StringTok{\textquotesingle{}M\textquotesingle{}}\NormalTok{, kind}\OperatorTok{=}\StringTok{\textquotesingle{}period\textquotesingle{}}\NormalTok{)}
\NormalTok{    .prod()}
\NormalTok{    .sub(}\DecValTok{1}\NormalTok{)}
\NormalTok{)}
\end{Highlighting}
\end{Shaded}

The wealth at time \(t\) is \(W_t\) and depends on:

\begin{enumerate}
\def\labelenumi{\arabic{enumi}.}
\tightlist
\item
  The wealth at the end of the previous month \(W_{t-1}\)
\item
  The return over the previous month \(R_t\) (recall we label returns by
  their right edge)
\item
  The end-of-month investment \(C_t\)
\end{enumerate}

Putting it all togther: \(W_t = W_{t-1} \times (1 + R_t) + C_t\)

We have to loop over the monthly returns in \texttt{mkts\_m} because we
have to combine compounded returns and cash flows. The
\texttt{iterrows()} methods provides an easy way to iterate (loop) over
the rows in \texttt{mkts\_m}.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{C\_t }\OperatorTok{=} \DecValTok{1\_000}
\NormalTok{W\_0 }\OperatorTok{=} \DecValTok{1\_000\_000}
\NormalTok{W\_last }\OperatorTok{=}\NormalTok{ W\_0}
\NormalTok{W\_t }\OperatorTok{=}\NormalTok{ []}

\ControlFlowTok{for}\NormalTok{ d, m }\KeywordTok{in}\NormalTok{ mkts\_m.iterrows():}
\NormalTok{    W\_last }\OperatorTok{=}\NormalTok{ (}\DecValTok{1} \OperatorTok{+}\NormalTok{ m) }\OperatorTok{*}\NormalTok{ W\_last }\OperatorTok{+}\NormalTok{ C\_t}
\NormalTok{    W\_t.append(W\_last)}

\NormalTok{W\_t }\OperatorTok{=}\NormalTok{ pd.concat(objs}\OperatorTok{=}\NormalTok{W\_t, axis}\OperatorTok{=}\DecValTok{1}\NormalTok{, keys}\OperatorTok{=}\NormalTok{mkts\_m.index).transpose()}
\end{Highlighting}
\end{Shaded}

We repeat the cumulative distribution of wealth plot and descriptive
statistics from above.

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{W\_t.iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].plot(kind}\OperatorTok{=}\StringTok{\textquotesingle{}hist\textquotesingle{}}\NormalTok{, density}\OperatorTok{=}\VariableTok{True}\NormalTok{, cumulative}\OperatorTok{=}\VariableTok{True}\NormalTok{, bins}\OperatorTok{=}\DecValTok{100}\NormalTok{)}
\NormalTok{plt.semilogx()}
\NormalTok{plt.xlabel(}
    \VerbatimStringTok{r\textquotesingle{}$W\_T$ where $W\_0 = $\textquotesingle{}} \OperatorTok{+} \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}\textbackslash{}}\SpecialStringTok{$}\SpecialCharTok{\{}\NormalTok{W\_0}\SpecialCharTok{:,.0f\}}\SpecialStringTok{\textquotesingle{}} \OperatorTok{+} 
    \VerbatimStringTok{r\textquotesingle{} and  $C\_t = $\textquotesingle{}} \OperatorTok{+} \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}\textbackslash{}}\SpecialStringTok{$}\SpecialCharTok{\{}\NormalTok{C\_t}\SpecialCharTok{:,.0f\}}\SpecialStringTok{\textquotesingle{}}
\NormalTok{)}
\NormalTok{plt.title(}\VerbatimStringTok{r\textquotesingle{}Cumulative Distribution of $W\_T$\textquotesingle{}} \OperatorTok{+} \SpecialStringTok{f\textquotesingle{}}\CharTok{\textbackslash{}n}\SpecialStringTok{after }\SpecialCharTok{\{}\NormalTok{W\_t}\SpecialCharTok{.}\NormalTok{shape[}\DecValTok{0}\NormalTok{]}\SpecialCharTok{:,.0f\}}\SpecialStringTok{ Trading Months\textquotesingle{}}\NormalTok{)}
\NormalTok{plt.show()}
\end{Highlighting}
\end{Shaded}

\includegraphics{herron_05_practice_05_files/figure-pdf/cell-19-output-1.png}

\begin{Shaded}
\begin{Highlighting}[]
\NormalTok{W\_t.iloc[}\OperatorTok{{-}}\DecValTok{1}\NormalTok{].div(}\DecValTok{1\_000\_000}\NormalTok{).describe()}
\end{Highlighting}
\end{Shaded}

\begin{verbatim}
count   100.00
mean     67.84
std      97.55
min       1.99
25%      21.21
50%      46.54
75%      75.92
max     713.85
Name: 2062-06, dtype: float64
\end{verbatim}

The plot above shows the cumulative distribution of \(W_T\), suggesting
we expect \(W_T\) greater than about 20 million dollars for about 75\%
of samples. Note, even though we deposit \$1,000 per month for almost 40
years, we do not gain much wealth over the previous example with only a
lump sum! Start saving early!

\part{Week 15}

\chapter{Project 3}\label{project-3}

FINA 6333 -- Spring 2023

\hfill\break

To be determined



\end{document}
